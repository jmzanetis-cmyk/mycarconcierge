-- Create dream_car_searches table
CREATE TABLE IF NOT EXISTS dream_car_searches (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
    search_name VARCHAR(200),
    min_year INTEGER,
    max_year INTEGER,
    preferred_makes JSONB DEFAULT '[]'::jsonb,
    preferred_models JSONB DEFAULT '[]'::jsonb,
    preferred_trims JSONB DEFAULT '[]'::jsonb,
    body_styles JSONB DEFAULT '[]'::jsonb,
    max_mileage INTEGER,
    min_price DECIMAL(12, 2),
    max_price DECIMAL(12, 2),
    max_distance_miles INTEGER,
    zip_code VARCHAR(10),
    fuel_types JSONB DEFAULT '[]'::jsonb,
    transmission_preference VARCHAR(50),
    exterior_colors JSONB DEFAULT '[]'::jsonb,
    must_have_features JSONB DEFAULT '[]'::jsonb,
    is_active BOOLEAN DEFAULT true,
    search_frequency VARCHAR(50) DEFAULT 'daily',
    notify_sms BOOLEAN DEFAULT false,
    notify_email BOOLEAN DEFAULT true,
    last_searched_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Create dream_car_matches table
CREATE TABLE IF NOT EXISTS dream_car_matches (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    search_id UUID NOT NULL REFERENCES dream_car_searches(id) ON DELETE CASCADE,
    user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
    source VARCHAR(100),
    listing_url TEXT,
    listing_id VARCHAR(200),
    year VARCHAR(10),
    make VARCHAR(100),
    model VARCHAR(100),
    trim VARCHAR(100),
    price DECIMAL(12, 2),
    mileage INTEGER,
    exterior_color VARCHAR(100),
    location VARCHAR(300),
    seller_type VARCHAR(50),
    match_score INTEGER,
    match_reasons JSONB DEFAULT '[]'::jsonb,
    listing_data JSONB DEFAULT '{}'::jsonb,
    photos JSONB DEFAULT '[]'::jsonb,
    is_seen BOOLEAN DEFAULT false,
    is_saved BOOLEAN DEFAULT false,
    is_dismissed BOOLEAN DEFAULT false,
    notified_at TIMESTAMPTZ,
    found_at TIMESTAMPTZ DEFAULT NOW(),
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Enable Row Level Security
ALTER TABLE dream_car_searches ENABLE ROW LEVEL SECURITY;
ALTER TABLE dream_car_matches ENABLE ROW LEVEL SECURITY;

-- Create RLS policies
CREATE POLICY "Users can manage own searches" ON dream_car_searches
    FOR ALL USING (auth.uid() = user_id);
    
CREATE POLICY "Users can manage own matches" ON dream_car_matches
    FOR ALL USING (auth.uid() = user_id);
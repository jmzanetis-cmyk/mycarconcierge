<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>My Garage ‚Äì My Car Concierge</title>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0a0a0f" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="My Car Concierge" />
  <link rel="manifest" href="/manifest.json" />
  <link rel="apple-touch-icon" href="/icons/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="192x192" href="/icons/icon-192.png" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Playfair+Display:wght@500;600&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    :root {
      --bg-deep: #0a0a0f;
      --bg-card: rgba(18, 18, 28, 0.85);
      --bg-elevated: rgba(28, 28, 42, 0.95);
      --bg-input: rgba(22, 22, 34, 0.9);
      --text-primary: #f4f4f6;
      --text-secondary: #9898a8;
      --text-muted: #6b6b7a;
      --accent-gold: #d4a855;
      --accent-gold-soft: rgba(212, 168, 85, 0.15);
      --accent-blue: #4a7cff;
      --accent-blue-soft: rgba(74, 124, 255, 0.12);
      --accent-green: #4ac88c;
      --accent-green-soft: rgba(74, 200, 140, 0.12);
      --accent-red: #ef5f5f;
      --accent-orange: #f59e0b;
      --accent-orange-soft: rgba(245, 158, 11, 0.15);
      --border-subtle: rgba(148, 148, 168, 0.12);
      --border-medium: rgba(148, 148, 168, 0.2);
      --border-focus: rgba(74, 124, 255, 0.5);
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-xl: 24px;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; scrollbar-width: thin; scrollbar-color: var(--border-medium) var(--bg-deep); }
    body { height: 100vh; font-family: 'Outfit', -apple-system, sans-serif; background: var(--bg-deep); color: var(--text-primary); display: flex; overflow: hidden;
      padding-top: env(safe-area-inset-top);
    }

    /* Custom Scrollbar */
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: var(--bg-deep); }
    ::-webkit-scrollbar-thumb { background: var(--border-medium); border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

    /* Sidebar */
    .sidebar { width: 260px; background: linear-gradient(180deg, rgba(18, 18, 28, 0.98) 0%, rgba(12, 12, 20, 0.99) 100%); border-right: 1px solid var(--border-subtle); padding: calc(20px + env(safe-area-inset-top)) 12px 20px 12px; display: flex; flex-direction: column; position: fixed; height: 100vh; z-index: 50; overflow-y: auto; backdrop-filter: blur(20px); scrollbar-width: none; -ms-overflow-style: none; 
    }
    .sidebar::-webkit-scrollbar { display: none; }
    .sidebar-brand { display: flex; align-items: center; justify-content: center; padding: 8px 12px 20px; border-bottom: 1px solid rgba(148, 148, 168, 0.08); margin-bottom: 20px; text-decoration: none; }
    .sidebar-brand-icon { height: 72px; width: auto; border-radius: var(--radius-md); image-rendering: -webkit-optimize-contrast; image-rendering: crisp-edges; filter: drop-shadow(0 2px 12px rgba(74, 124, 255, 0.2)); }
    .sidebar-brand-text { font-family: 'Playfair Display', serif; font-weight: 500; color: var(--text-primary); font-size: 1.05rem; }
    .nav-label { font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.14em; color: var(--text-muted); padding: 16px 14px 8px; margin-bottom: 4px; font-weight: 600; opacity: 0.7; }
    .nav-label:first-of-type { margin-top: 0; padding-top: 0; }
    .nav-item { display: flex; align-items: center; gap: 10px; padding: 11px 14px; border-radius: 10px; cursor: pointer; font-size: 0.88rem; color: var(--text-secondary); transition: all 0.2s ease; margin-bottom: 2px; border: 1px solid transparent; font-weight: 450; }
    .nav-item:hover { background: rgba(74, 124, 255, 0.08); color: var(--text-primary); border-color: rgba(74, 124, 255, 0.12); }
    .nav-item.active { background: linear-gradient(135deg, rgba(74, 124, 255, 0.15), rgba(74, 124, 255, 0.08)); color: var(--accent-blue); border-color: rgba(74, 124, 255, 0.25); font-weight: 500; }
    .nav-badge { margin-left: auto; background: var(--accent-gold); color: #0a0a0f; font-size: 0.7rem; font-weight: 600; padding: 3px 8px; border-radius: 100px; min-width: 22px; text-align: center; }
    .sidebar-footer { margin-top: auto; padding: 16px; border-top: 1px solid rgba(148, 148, 168, 0.08); background: linear-gradient(180deg, transparent, rgba(18, 18, 28, 0.5)); }
    .user-info { display: flex; align-items: center; gap: 12px; padding: 12px 14px; border-radius: 12px; background: linear-gradient(135deg, rgba(28, 28, 42, 0.6), rgba(18, 18, 28, 0.8)); margin-bottom: 12px; border: 1px solid rgba(148, 148, 168, 0.08); }
    .user-avatar { width: 38px; height: 38px; background: linear-gradient(135deg, var(--accent-blue), #6b9fff); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 600; box-shadow: 0 2px 8px rgba(74, 124, 255, 0.25); }
    .user-name { font-size: 0.88rem; font-weight: 500; }
    .user-email { font-size: 0.75rem; color: var(--text-muted); }

    /* Main */
    .main { flex: 1; margin-left: 260px; padding: 32px 40px 100px; min-height: 0; max-height: 100vh; overflow-y: auto; -webkit-overflow-scrolling: touch; }
    .page-header { margin-bottom: 32px;
      padding-top: env(safe-area-inset-top);
    }
    .page-title { font-family: 'Playfair Display', serif; font-size: 1.8rem; font-weight: 500; margin-bottom: 8px; }
    .page-subtitle { color: var(--text-secondary); font-size: 0.95rem; }

    /* Stats */
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 16px; margin-bottom: 32px; }
    /* Premium Stat Cards - Turo Style */
    .stat-card { background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: 16px; padding: 24px; transition: all 0.3s ease; position: relative; overflow: hidden; }
    .stat-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; background: linear-gradient(90deg, var(--accent-gold), var(--accent-blue)); opacity: 0; transition: opacity 0.3s ease; }
    .stat-card:hover { border-color: var(--accent-gold); transform: translateY(-4px); box-shadow: 0 12px 40px rgba(0,0,0,0.3); }
    .stat-card:hover::before { opacity: 1; }
    .stat-icon { width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 22px; margin-bottom: 16px; }
    .stat-icon.blue { background: linear-gradient(135deg, rgba(100,181,246,0.2), rgba(100,181,246,0.1)); }
    .stat-icon.gold { background: linear-gradient(135deg, rgba(212,168,85,0.2), rgba(212,168,85,0.1)); }
    .stat-icon.green { background: linear-gradient(135deg, rgba(129,199,132,0.2), rgba(129,199,132,0.1)); }
    .stat-icon.orange { background: linear-gradient(135deg, rgba(255,183,77,0.2), rgba(255,183,77,0.1)); }
    .stat-value { font-size: 2rem; font-weight: 700; margin-bottom: 4px; letter-spacing: -0.5px; }
    .stat-label { font-size: 0.85rem; color: var(--text-muted); font-weight: 500; }

    /* Cards */
    .card { background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: var(--radius-lg); padding: 24px; margin-bottom: 20px; }
    .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;
      padding-top: env(safe-area-inset-top);
    }
    .card-title { font-size: 1.1rem; font-weight: 600; }

    /* Buttons */
    .btn { display: inline-flex; align-items: center; gap: 8px; padding: 10px 20px; font-family: inherit; font-size: 0.88rem; font-weight: 500; border: none; border-radius: var(--radius-md); cursor: pointer; transition: all 0.2s ease; text-decoration: none; }
    .btn-primary { background: linear-gradient(135deg, var(--accent-gold), #c49a45); color: #0a0a0f; }
    .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 16px rgba(212, 168, 85, 0.3); }
    .btn-secondary { background: var(--bg-elevated); color: var(--text-primary); border: 1px solid var(--border-subtle); }
    .btn-secondary:hover { border-color: var(--border-medium); }
    .btn-ghost { background: transparent; color: var(--text-secondary); padding: 8px 12px; }
    .btn-sm { padding: 6px 12px; font-size: 0.82rem; }
    .btn-success { background: var(--accent-green); color: #022c22; }
    .btn-danger { background: rgba(239, 95, 95, 0.15); color: var(--accent-red); border: 1px solid rgba(239, 95, 95, 0.3); }

    /* Vehicle Cards */
    /* Premium Vehicle Cards - Turo Style */
    .vehicles-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 24px; }
    .vehicle-card { background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: 20px; overflow: hidden; transition: all 0.3s ease; }
    .vehicle-card:hover { border-color: var(--accent-gold); transform: translateY(-6px); box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
    .vehicle-card-photo { position: relative; height: 200px; background: linear-gradient(135deg, var(--bg-elevated), var(--bg-input)); display: flex; align-items: center; justify-content: center; overflow: hidden; }
    .vehicle-card-photo img { width: 100%; height: 100%; object-fit: cover; }
    .vehicle-card-photo .vehicle-emoji { font-size: 80px; opacity: 0.9; }
    .vehicle-card-badge { position: absolute; top: 12px; right: 12px; padding: 6px 14px; border-radius: 100px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
    .vehicle-card-badge.excellent { background: linear-gradient(135deg, #4CAF50, #45a049); color: white; }
    .vehicle-card-badge.good { background: linear-gradient(135deg, var(--accent-gold), #c9a227); color: #1a1a2e; }
    .vehicle-card-badge.fair { background: linear-gradient(135deg, #ff9800, #f57c00); color: white; }
    .vehicle-card-body { padding: 20px 24px 24px; }
    .vehicle-card-title { font-size: 1.25rem; font-weight: 700; margin-bottom: 4px; letter-spacing: -0.3px; }
    .vehicle-card-subtitle { font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 12px; }
    .vehicle-card-meta { display: flex; align-items: center; gap: 16px; margin-bottom: 16px; font-size: 0.85rem; color: var(--text-muted); }
    .vehicle-card-meta span { display: flex; align-items: center; gap: 6px; }
    .vehicle-card-actions { display: flex; gap: 10px; padding-top: 16px; border-top: 1px solid var(--border-subtle); }
    .vehicle-image { height: 160px; background: linear-gradient(135deg, rgba(74, 124, 255, 0.1), rgba(212, 168, 85, 0.1)); display: flex; align-items: center; justify-content: center; font-size: 56px; border-bottom: 1px solid var(--border-subtle); position: relative; }
    .vehicle-image img { width: 100%; height: 100%; object-fit: cover; }
    .health-badge { position: absolute; top: 12px; right: 12px; padding: 4px 10px; border-radius: 100px; font-size: 0.75rem; font-weight: 600; }
    .health-badge.excellent { background: var(--accent-green-soft); color: var(--accent-green); }
    .health-badge.good { background: var(--accent-blue-soft); color: var(--accent-blue); }
    .health-badge.fair { background: var(--accent-orange-soft); color: var(--accent-orange); }
    .health-badge.poor { background: rgba(239, 95, 95, 0.15); color: var(--accent-red); }
    .vehicle-content { padding: 20px; }
    .vehicle-name { font-size: 1.15rem; font-weight: 600; margin-bottom: 4px; }
    .vehicle-details { font-size: 0.88rem; color: var(--text-secondary); margin-bottom: 12px; }
    .vehicle-meta { display: flex; gap: 16px; flex-wrap: wrap; padding-top: 12px; border-top: 1px solid var(--border-subtle); font-size: 0.82rem; color: var(--text-muted); margin-bottom: 16px; }
    .vehicle-actions { display: flex; gap: 8px; flex-wrap: wrap; }

    /* Package Cards */
    .packages-list { display: flex; flex-direction: column; gap: 16px; }
    .package-card { background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: var(--radius-lg); padding: 24px; }
    .package-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px;
      padding-top: env(safe-area-inset-top);
    }
    .package-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 4px; }
    .package-vehicle { font-size: 0.88rem; color: var(--text-secondary); }
    .package-status { padding: 4px 12px; border-radius: 100px; font-size: 0.78rem; font-weight: 500; }
    .package-status.open { background: var(--accent-green-soft); color: var(--accent-green); }
    .package-status.pending { background: var(--accent-orange-soft); color: var(--accent-orange); }
    .package-status.accepted { background: var(--accent-blue-soft); color: var(--accent-blue); }
    .package-status.completed { background: var(--bg-elevated); color: var(--text-muted); }
    .package-status.expired { background: rgba(239, 95, 95, 0.15); color: var(--accent-red); }
    .package-meta { display: flex; gap: 20px; flex-wrap: wrap; margin-bottom: 16px; font-size: 0.85rem; color: var(--text-muted); }
    .package-meta span { display: flex; align-items: center; gap: 6px; }
    .package-description { color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 16px; line-height: 1.6; }
    .package-footer { display: flex; justify-content: space-between; align-items: center; padding-top: 16px; border-top: 1px solid var(--border-subtle); }
    .bid-count { font-size: 0.88rem; color: var(--accent-gold); font-weight: 500; }

    /* Bids List */
    .bids-list { display: flex; flex-direction: column; gap: 12px; margin-top: 16px; }
    .bid-card { background: var(--bg-elevated); border: 1px solid var(--border-subtle); border-radius: var(--radius-md); padding: 16px 20px; }
    .bid-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;
      padding-top: env(safe-area-inset-top);
    }
    .bid-provider { display: flex; align-items: center; gap: 12px; }
    .bid-avatar { width: 40px; height: 40px; background: var(--accent-gold-soft); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 16px; }
    .bid-provider-info h4 { font-size: 0.95rem; font-weight: 600; margin-bottom: 2px; }
    .bid-rating { font-size: 0.82rem; color: var(--accent-gold); }
    .bid-price { font-size: 1.3rem; font-weight: 600; color: var(--accent-gold); }
    .bid-details { font-size: 0.88rem; color: var(--text-secondary); margin-bottom: 12px; }
    .bid-actions { display: flex; gap: 8px; }

    /* Messages */
    .messages-container { max-height: 300px; overflow-y: auto; margin-bottom: 16px; padding: 16px; background: var(--bg-input); border-radius: var(--radius-md); }
    .message { margin-bottom: 12px; }
    .message.sent { text-align: right; }
    .message-bubble { display: inline-block; max-width: 80%; padding: 10px 14px; border-radius: var(--radius-md); font-size: 0.9rem; }
    .message.received .message-bubble { background: var(--bg-elevated); color: var(--text-primary); }
    .message.sent .message-bubble { background: var(--accent-blue); color: white; }
    .message-time { font-size: 0.72rem; color: var(--text-muted); margin-top: 4px; }
    .message-input-row { display: flex; gap: 12px; }
    .message-input-row input { flex: 1; }

    /* Modals */
    .modal-backdrop { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(4px); display: none; align-items: center; justify-content: center; z-index: 100; padding: 24px; overflow-y: auto; }
    .modal-backdrop.active { display: flex; }
    .modal { background: var(--bg-elevated); border: 1px solid var(--border-medium); border-radius: var(--radius-xl); width: 100%; max-width: 600px; max-height: 90vh; overflow-y: auto; animation: modalIn 0.2s ease; }
    .modal.wide { max-width: 800px; }
    @keyframes modalIn { from { opacity: 0; transform: scale(0.95) translateY(10px); } to { opacity: 1; transform: scale(1) translateY(0); } }
    .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 24px 28px; border-bottom: 1px solid var(--border-subtle); position: sticky; top: 0; background: var(--bg-elevated); z-index: 10;
      padding-top: env(safe-area-inset-top);
    }
    .modal-title { font-size: 1.15rem; font-weight: 600; }
    .modal-close { width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; background: transparent; border: none; color: var(--text-muted); cursor: pointer; border-radius: var(--radius-sm); font-size: 20px; }
    .modal-close:hover { background: var(--bg-input); color: var(--text-primary); }
    .modal-body { padding: 24px 28px; }
    .modal-footer { display: flex; justify-content: flex-end; gap: 12px; padding: 20px 28px; border-top: 1px solid var(--border-subtle); }

    /* Forms */
    .form-group { margin-bottom: 20px; }
    .form-label { display: block; font-size: 0.85rem; font-weight: 500; margin-bottom: 8px; color: var(--text-secondary); }
    .form-input, .form-select, .form-textarea { width: 100%; padding: 12px 16px; background: var(--bg-input); border: 1px solid var(--border-subtle); border-radius: var(--radius-md); color: var(--text-primary); font-family: inherit; font-size: 0.92rem; transition: all 0.15s ease; }
    .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--border-focus); box-shadow: 0 0 0 3px rgba(74, 124, 255, 0.1); }
    .form-input::placeholder, .form-textarea::placeholder { color: var(--text-muted); }
    .form-textarea { min-height: 100px; resize: vertical; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .form-row.three { grid-template-columns: 1fr 1fr 1fr; }
    .form-hint { font-size: 0.78rem; color: var(--text-muted); margin-top: 6px; }
    .form-section { margin-bottom: 28px; padding-bottom: 20px; border-bottom: 1px solid var(--border-subtle); }
    .form-section:last-child { border-bottom: none; margin-bottom: 0; }
    .form-section-title { font-size: 0.95rem; font-weight: 600; margin-bottom: 16px; color: var(--text-primary); }

    /* Parts Tier Selection */
    .parts-tiers { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
    .parts-tier { background: var(--bg-input); border: 2px solid var(--border-subtle); border-radius: var(--radius-md); padding: 16px; cursor: pointer; text-align: center; transition: all 0.15s; }
    .parts-tier:hover { border-color: var(--border-medium); }
    .parts-tier.selected { border-color: var(--accent-gold); background: var(--accent-gold-soft); }
    .parts-tier-name { font-weight: 600; margin-bottom: 4px; }
    .parts-tier-desc { font-size: 0.78rem; color: var(--text-muted); }

    /* Transfer Type Options */
    .transfer-type-option:hover { border-color: var(--border-medium); }
    .transfer-type-option.selected { border-color: var(--accent-gold) !important; background: var(--accent-gold-soft) !important; }

    /* Pulse Animation for Timeline */
    @keyframes pulse {
      0%, 100% { box-shadow: 0 0 0 0 rgba(74, 124, 255, 0.4); }
      50% { box-shadow: 0 0 0 8px rgba(74, 124, 255, 0); }
    }

    /* Bidding Window Options */
    .bidding-window-options { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; }
    .bid-window-option { background: var(--bg-input); border: 2px solid var(--border-subtle); border-radius: var(--radius-md); padding: 14px 10px; cursor: pointer; text-align: center; transition: all 0.15s; }
    .bid-window-option:hover { border-color: var(--border-medium); }
    .bid-window-option.selected { border-color: var(--accent-gold); background: var(--accent-gold-soft); }
    .bid-window-time { font-weight: 600; font-size: 0.95rem; margin-bottom: 2px; }
    .bid-window-desc { font-size: 0.72rem; color: var(--text-muted); }
    
    /* Countdown Timer */
    .countdown-timer { display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; background: var(--accent-gold-soft); border-radius: var(--radius-sm); font-size: 0.85rem; font-weight: 500; color: var(--accent-gold); }
    .countdown-timer.urgent { background: rgba(239, 95, 95, 0.15); color: var(--accent-red); }
    .countdown-timer.expired { background: var(--bg-input); color: var(--text-muted); }

    /* Star Ratings */
    .star-rating { display: flex; gap: 4px; }
    .star-rating .star { font-size: 28px; color: var(--border-medium); cursor: pointer; transition: color 0.15s, transform 0.1s; }
    .star-rating .star:hover { transform: scale(1.1); }
    .star-rating .star.active { color: var(--accent-gold); }
    .star-rating.small .star { font-size: 20px; }

    /* Conversation Cards */
    .conversation-card:hover { background: var(--bg-elevated) !important; border-color: var(--border-medium) !important; }

    /* File Upload */
    .file-upload { display: block; border: 2px dashed var(--border-subtle); border-radius: var(--radius-md); padding: 20px; text-align: center; cursor: pointer; transition: all 0.15s; background: var(--bg-input); }
    .file-upload:hover { border-color: var(--accent-gold); background: var(--accent-gold-soft); }

    /* Photo Upload */
    .photo-upload-area { border: 2px dashed var(--border-subtle); border-radius: var(--radius-md); padding: 32px 24px; text-align: center; cursor: pointer; transition: all 0.15s; }
    .photo-upload-area:hover { border-color: var(--accent-gold); background: var(--accent-gold-soft); }
    .vehicle-photo-upload-container:hover { border-color: var(--accent-gold) !important; background: var(--accent-gold-soft) !important; }
    .photo-upload-icon { font-size: 32px; margin-bottom: 8px; }
    .photo-upload-text { font-weight: 500; margin-bottom: 4px; }
    .photo-upload-hint { font-size: 0.8rem; color: var(--text-muted); }
    .photo-previews { display: flex; flex-wrap: wrap; gap: 12px; margin-top: 16px; }
    .photo-preview { position: relative; width: 100px; height: 100px; border-radius: var(--radius-md); overflow: hidden; border: 1px solid var(--border-subtle); }
    .photo-preview img { width: 100%; height: 100%; object-fit: cover; }
    .photo-preview-remove { position: absolute; top: 4px; right: 4px; width: 24px; height: 24px; background: rgba(0,0,0,0.7); border: none; border-radius: 50%; color: white; cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center; }
    .photo-preview-remove:hover { background: var(--accent-red); }

    /* Tabs */
    .tabs { display: flex; gap: 4px; border-bottom: 1px solid var(--border-subtle); margin-bottom: 24px; }
    .tab { padding: 12px 20px; font-size: 0.9rem; color: var(--text-secondary); cursor: pointer; border-bottom: 2px solid transparent; margin-bottom: -1px; transition: all 0.15s; }
    .tab:hover { color: var(--text-primary); }
    .tab.active { color: var(--accent-blue); border-bottom-color: var(--accent-blue); }

    /* Service History */
    .history-item { display: flex; gap: 16px; padding: 16px 0; border-bottom: 1px solid var(--border-subtle); }
    .history-item:last-child { border-bottom: none; }
    .history-date { width: 80px; flex-shrink: 0; text-align: center; }
    .history-date-day { font-size: 1.4rem; font-weight: 600; }
    .history-date-month { font-size: 0.78rem; color: var(--text-muted); text-transform: uppercase; }
    .history-content { flex: 1; }
    .history-title { font-weight: 600; margin-bottom: 4px; }
    .history-details { font-size: 0.88rem; color: var(--text-secondary); }
    .history-cost { font-weight: 600; color: var(--accent-gold); }

    /* Reminders */
    .reminder-item { display: flex; align-items: center; gap: 16px; padding: 14px 16px; background: var(--bg-input); border-radius: var(--radius-md); margin-bottom: 8px; border-left: 4px solid transparent; }
    .reminder-item.type-registration { border-left-color: var(--accent-blue); }
    .reminder-item.type-oil_change { border-left-color: var(--accent-gold); }
    .reminder-item.type-warranty { border-left-color: #9b59b6; }
    .reminder-item.type-maintenance { border-left-color: var(--accent-green); }
    .reminder-item.type-inspection { border-left-color: var(--accent-orange); }
    .reminder-item.type-tire_rotation { border-left-color: #3498db; }
    .reminder-item.type-brake_check { border-left-color: var(--accent-red); }
    .reminder-item.type-other { border-left-color: var(--text-muted); }
    .reminder-icon { width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 16px; }
    .reminder-icon.due { background: var(--accent-orange-soft); }
    .reminder-icon.overdue { background: rgba(239, 95, 95, 0.15); }
    .reminder-icon.ok { background: var(--accent-green-soft); }
    .reminder-content { flex: 1; }
    .reminder-title { font-weight: 500; font-size: 0.92rem; }
    .reminder-type-badge { display: inline-block; font-size: 0.7rem; padding: 2px 8px; border-radius: 100px; background: var(--bg-elevated); color: var(--text-secondary); margin-left: 8px; text-transform: capitalize; }
    .reminder-due { font-size: 0.82rem; color: var(--text-muted); }
    .reminder-actions { display: flex; gap: 6px; align-items: center; }

    /* Service Recommendations */
    .recommendation-item { display: flex; align-items: flex-start; gap: 16px; padding: 16px; background: var(--bg-input); border-radius: var(--radius-md); margin-bottom: 12px; border-left: 4px solid var(--border-subtle); transition: all 0.2s ease; }
    .recommendation-item:hover { background: var(--bg-elevated); }
    .recommendation-item.priority-urgent { border-left-color: var(--accent-red); }
    .recommendation-item.priority-soon { border-left-color: var(--accent-orange); }
    .recommendation-item.priority-upcoming { border-left-color: #eab308; }
    .recommendation-item.priority-routine { border-left-color: var(--accent-blue); }
    .recommendation-icon { width: 44px; height: 44px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 20px; flex-shrink: 0; }
    .recommendation-icon.urgent { background: rgba(239, 95, 95, 0.15); }
    .recommendation-icon.soon { background: var(--accent-orange-soft); }
    .recommendation-icon.upcoming { background: rgba(234, 179, 8, 0.15); }
    .recommendation-icon.routine { background: var(--accent-blue-soft); }
    .recommendation-content { flex: 1; min-width: 0; }
    .recommendation-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 12px; margin-bottom: 6px; flex-wrap: wrap;
      padding-top: env(safe-area-inset-top);
    }
    .recommendation-title { font-weight: 600; font-size: 0.95rem; }
    .recommendation-priority { display: inline-block; padding: 3px 10px; border-radius: 100px; font-size: 0.72rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
    .recommendation-priority.urgent { background: rgba(239, 95, 95, 0.2); color: var(--accent-red); }
    .recommendation-priority.soon { background: var(--accent-orange-soft); color: var(--accent-orange); }
    .recommendation-priority.upcoming { background: rgba(234, 179, 8, 0.15); color: #eab308; }
    .recommendation-priority.routine { background: var(--accent-blue-soft); color: var(--accent-blue); }
    .recommendation-reason { font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 8px; line-height: 1.5; }
    .recommendation-meta { display: flex; gap: 16px; flex-wrap: wrap; font-size: 0.8rem; color: var(--text-muted); margin-bottom: 12px; }
    .recommendation-meta span { display: flex; align-items: center; gap: 4px; }
    .recommendation-vehicle { font-size: 0.78rem; color: var(--text-muted); background: var(--bg-elevated); padding: 2px 8px; border-radius: 4px; margin-bottom: 8px; display: inline-block; }
    .recommendation-actions { display: flex; gap: 8px; flex-wrap: wrap; }

    /* Empty State */
    .empty-state { text-align: center; padding: 48px 24px; color: var(--text-muted); }
    .empty-state-icon { font-size: 48px; margin-bottom: 16px; opacity: 0.5; }

    /* Section visibility */
    .section { display: none; }
    .section.active { display: block; min-height: min-content; }

    /* Toast */
    .toast-container { position: fixed; bottom: 24px; right: 24px; z-index: 200; display: flex; flex-direction: column; gap: 12px; }
    .toast { background: var(--bg-elevated); border: 1px solid var(--border-medium); border-radius: var(--radius-md); padding: 16px 20px; display: flex; align-items: center; gap: 12px; animation: toastIn 0.3s ease; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3); }
    @keyframes toastIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    .toast.success { border-color: var(--accent-green); }
    .toast.error { border-color: var(--accent-red); }

    /* Mobile */
    @media (max-width: 900px) {
      body { display: block; overflow-y: scroll; -webkit-overflow-scrolling: touch; }
      .sidebar { transform: translateX(-100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); width: 300px; padding: calc(16px + env(safe-area-inset-top)) 14px 16px 14px; padding-bottom: 100px; overflow-y: auto; -webkit-overflow-scrolling: touch; position: fixed; top: 0; left: 0; height: 100%; z-index: 100; background: rgba(12, 12, 18, 0.98); 
    }
      .sidebar.open { transform: translateX(0); box-shadow: 8px 0 40px rgba(0,0,0,0.6); }
      .main { margin-left: 0; padding: 24px 16px 120px; min-height: 100vh; overflow: visible; }
      .mobile-header { display: flex; align-items: center; gap: 16px; margin-bottom: 24px;
      padding-top: env(safe-area-inset-top);
    }
      .mobile-menu-btn { display: flex; width: 44px; height: 44px; align-items: center; justify-content: center; background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: var(--radius-md); color: var(--text-primary); cursor: pointer; font-size: 1.2rem; }
      .form-row, .form-row.three, .parts-tiers { grid-template-columns: 1fr; }
      .bidding-window-options { grid-template-columns: repeat(3, 1fr); }
      .vehicles-grid { grid-template-columns: 1fr; }
      .vehicle-card-photo { height: 180px; }
      .vehicle-card-body { padding: 16px 20px 20px; }
      .vehicle-card-actions { flex-wrap: wrap; }
      .nav-item { padding: 13px 16px; font-size: 0.95rem; border-radius: 12px; margin-bottom: 3px; }
      .nav-label { padding: 20px 16px 10px; font-size: 0.68rem; }
      .sidebar-brand-icon { height: 64px; }
      .sidebar-footer { padding: 16px; margin-top: auto; background: rgba(18, 18, 28, 0.5); border-radius: var(--radius-md); margin: auto 4px 8px; }
      .btn { min-height: 48px; }
      body.sidebar-open { overflow: hidden; }
    }
    @media (min-width: 901px) { .mobile-header { display: none;
      padding-top: env(safe-area-inset-top);
    } }

    /* Emergency Button */
    @keyframes emergencyPulse { 0%, 100% { box-shadow: 0 4px 20px rgba(239, 95, 95, 0.4); } 50% { box-shadow: 0 4px 30px rgba(239, 95, 95, 0.7), 0 0 0 10px rgba(239, 95, 95, 0.1); } }

    /* Emergency Banner */
    .emergency-banner { background: linear-gradient(135deg, rgba(239, 95, 95, 0.2), rgba(255, 68, 68, 0.15)); border: 1px solid rgba(239, 95, 95, 0.4); color: var(--accent-red); padding: 16px 20px; border-radius: var(--radius-lg); margin-bottom: 24px; cursor: pointer; display: flex; align-items: center; gap: 12px; animation: emergencyPulse 2s infinite; }
    .emergency-banner:hover { background: linear-gradient(135deg, rgba(239, 95, 95, 0.25), rgba(255, 68, 68, 0.2)); }

    /* Emergency Status Timeline */
    .emergency-timeline { display: flex; flex-direction: column; gap: 0; margin: 20px 0; }
    .emergency-step { display: flex; align-items: flex-start; gap: 12px; position: relative; padding-bottom: 20px; }
    .emergency-step:last-child { padding-bottom: 0; }
    .emergency-step::before { content: ''; position: absolute; left: 15px; top: 32px; bottom: 0; width: 2px; background: var(--border-subtle); }
    .emergency-step:last-child::before { display: none; }
    .emergency-step-dot { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; flex-shrink: 0; border: 2px solid var(--border-subtle); background: var(--bg-input); }
    .emergency-step.completed .emergency-step-dot { background: var(--accent-green); border-color: var(--accent-green); color: #fff; }
    .emergency-step.current .emergency-step-dot { background: var(--accent-orange); border-color: var(--accent-orange); color: #0a0a0f; animation: pulse 2s infinite; }
    .emergency-step.pending .emergency-step-dot { opacity: 0.5; }
    .emergency-step-info { flex: 1; padding-top: 4px; }
    .emergency-step-label { font-weight: 500; font-size: 0.9rem; margin-bottom: 2px; }
    .emergency-step.pending .emergency-step-label { color: var(--text-muted); }
    .emergency-step-time { font-size: 0.78rem; color: var(--text-muted); }

    /* Emergency Photo Grid */
    .emergency-photos { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 12px; }
    .emergency-photo { width: 60px; height: 60px; border-radius: var(--radius-sm); overflow: hidden; position: relative; border: 1px solid var(--border-subtle); }
    .emergency-photo img { width: 100%; height: 100%; object-fit: cover; }
    .emergency-photo-remove { position: absolute; top: 2px; right: 2px; width: 18px; height: 18px; background: rgba(0,0,0,0.7); border: none; border-radius: 50%; color: white; cursor: pointer; font-size: 12px; display: flex; align-items: center; justify-content: center; }

    /* Emergency Type Selection */
    .emergency-type-option:hover { border-color: var(--accent-red); background: rgba(239,95,95,0.1); }
    .emergency-type-option:has(input:checked) { border-color: var(--accent-red); background: rgba(239,95,95,0.15); box-shadow: 0 0 0 2px rgba(239,95,95,0.3); }
    .emergency-type-option:has(input:checked) span:first-of-type { transform: scale(1.1); }

    /* Inspection Report Display Styles */
    .inspection-report-card { background: var(--bg-elevated); border: 1px solid var(--border-subtle); border-radius: var(--radius-lg); padding: 20px; margin-top: 16px; }
    .inspection-report-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px;
      padding-top: env(safe-area-inset-top);
    }
    .inspection-report-title { font-size: 1.1rem; font-weight: 600; display: flex; align-items: center; gap: 8px; }
    .inspection-overall-badge { padding: 6px 16px; border-radius: 100px; font-weight: 600; font-size: 0.85rem; }
    .inspection-overall-badge.excellent { background: var(--accent-green); color: #fff; }
    .inspection-overall-badge.good { background: #22c55e; color: #fff; }
    .inspection-overall-badge.fair { background: #f59e0b; color: #000; }
    .inspection-overall-badge.needs_attention { background: #f97316; color: #fff; }
    .inspection-counts { display: flex; gap: 12px; margin-bottom: 16px; }
    .inspection-count-item { display: flex; align-items: center; gap: 6px; padding: 8px 14px; border-radius: var(--radius-md); font-size: 0.85rem; font-weight: 500; }
    .inspection-count-item.urgent { background: rgba(239, 95, 95, 0.15); color: var(--accent-red); }
    .inspection-count-item.attention { background: rgba(249, 115, 22, 0.15); color: #f97316; }
    .inspection-count-item.good { background: var(--accent-green-soft); color: var(--accent-green); }
    .inspection-category-section { background: var(--bg-input); border: 1px solid var(--border-subtle); border-radius: var(--radius-md); margin-bottom: 12px; overflow: hidden; }
    .inspection-category-toggle { padding: 12px 16px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; font-weight: 500; }
    .inspection-category-toggle:hover { background: var(--bg-elevated); }
    .inspection-category-items { padding: 12px 16px; border-top: 1px solid var(--border-subtle); display: none; }
    .inspection-category-section.expanded .inspection-category-items { display: block; }
    .inspection-item-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border-subtle); font-size: 0.88rem; }
    .inspection-item-row:last-child { border-bottom: none; }
    .inspection-status-badge { padding: 4px 10px; border-radius: 100px; font-size: 0.75rem; font-weight: 500; }
    .inspection-status-badge.good { background: var(--accent-green-soft); color: var(--accent-green); }
    .inspection-status-badge.fair { background: rgba(245, 158, 11, 0.15); color: #f59e0b; }
    .inspection-status-badge.needs_attention { background: rgba(249, 115, 22, 0.15); color: #f97316; }
    .inspection-status-badge.urgent { background: rgba(239, 95, 95, 0.15); color: var(--accent-red); }
    .inspection-status-badge.na { background: var(--bg-elevated); color: var(--text-muted); }
    .inspection-recommendations { background: var(--bg-input); border: 1px solid var(--border-subtle); border-radius: var(--radius-md); padding: 16px; margin-top: 16px; }
    .inspection-recommendations-title { font-weight: 600; margin-bottom: 8px; display: flex; align-items: center; gap: 8px; }
    .inspection-recommendations-text { color: var(--text-secondary); font-size: 0.9rem; line-height: 1.5; }
    .inspection-date { font-size: 0.8rem; color: var(--text-muted); }

    /* Fleet Management Styles */
    .fleet-table { width: 100%; border-collapse: collapse; }
    .fleet-table th, .fleet-table td { padding: 14px 16px; text-align: left; border-bottom: 1px solid var(--border-subtle); }
    .fleet-table th { font-size: 0.78rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-muted); font-weight: 600; background: var(--bg-input); }
    .fleet-table tr:hover td { background: var(--bg-elevated); }
    .fleet-table tbody tr:last-child td { border-bottom: none; }
    .fleet-role-badge { padding: 4px 12px; border-radius: 100px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; }
    .fleet-role-badge.owner { background: linear-gradient(135deg, var(--accent-gold), #c49a45); color: #0a0a0f; }
    .fleet-role-badge.manager { background: var(--accent-blue-soft); color: var(--accent-blue); }
    .fleet-role-badge.driver { background: var(--accent-green-soft); color: var(--accent-green); }
    .fleet-role-badge.viewer { background: var(--bg-elevated); color: var(--text-muted); }
    .fleet-status-badge { padding: 4px 10px; border-radius: 100px; font-size: 0.72rem; font-weight: 500; }
    .fleet-status-badge.active { background: var(--accent-green-soft); color: var(--accent-green); }
    .fleet-status-badge.pending { background: var(--accent-orange-soft); color: var(--accent-orange); }
    .fleet-status-badge.inactive { background: var(--bg-elevated); color: var(--text-muted); }
    .fleet-assignment-badge { padding: 4px 10px; border-radius: 100px; font-size: 0.72rem; font-weight: 500; }
    .fleet-assignment-badge.permanent { background: var(--accent-blue-soft); color: var(--accent-blue); }
    .fleet-assignment-badge.temporary { background: var(--accent-orange-soft); color: var(--accent-orange); }
    .fleet-assignment-badge.pool { background: rgba(168, 85, 247, 0.15); color: #a855f7; }
    .fleet-vehicle-card { background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: var(--radius-lg); overflow: hidden; transition: all 0.2s ease; }
    .fleet-vehicle-card:hover { border-color: var(--accent-gold); transform: translateY(-4px); box-shadow: 0 12px 40px rgba(0,0,0,0.3); }
    .fleet-vehicle-photo { height: 140px; background: linear-gradient(135deg, var(--bg-elevated), var(--bg-input)); display: flex; align-items: center; justify-content: center; font-size: 48px; position: relative; overflow: hidden; }
    .fleet-vehicle-photo img { width: 100%; height: 100%; object-fit: cover; }
    .fleet-vehicle-body { padding: 16px; }
    .fleet-vehicle-title { font-weight: 600; font-size: 1rem; margin-bottom: 4px; }
    .fleet-vehicle-driver { font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 8px; }
    .fleet-vehicle-meta { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 12px; }
    .batch-status-badge { padding: 4px 12px; border-radius: 100px; font-size: 0.75rem; font-weight: 600; }
    .batch-status-badge.draft { background: var(--bg-elevated); color: var(--text-muted); }
    .batch-status-badge.pending_approval { background: var(--accent-orange-soft); color: var(--accent-orange); }
    .batch-status-badge.approved { background: var(--accent-blue-soft); color: var(--accent-blue); }
    .batch-status-badge.in_progress { background: rgba(168, 85, 247, 0.15); color: #a855f7; }
    .batch-status-badge.completed { background: var(--accent-green-soft); color: var(--accent-green); }
    .batch-card { background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: var(--radius-lg); padding: 20px; margin-bottom: 16px; }
    .batch-card:hover { border-color: var(--border-medium); }
    .batch-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;
      padding-top: env(safe-area-inset-top);
    }
    .batch-title { font-weight: 600; font-size: 1.05rem; margin-bottom: 4px; }
    .batch-meta { display: flex; gap: 16px; flex-wrap: wrap; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 12px; }
    .batch-meta span { display: flex; align-items: center; gap: 6px; }
    .batch-actions { display: flex; gap: 8px; padding-top: 12px; border-top: 1px solid var(--border-subtle); }
    .wizard-steps { display: flex; gap: 4px; margin-bottom: 32px; }
    .wizard-step { flex: 1; padding: 12px 8px; text-align: center; background: var(--bg-input); border-radius: var(--radius-sm); font-size: 0.85rem; color: var(--text-muted); position: relative; transition: all 0.2s; }
    .wizard-step.active { background: var(--accent-gold); color: #0a0a0f; font-weight: 600; }
    .wizard-step.completed { background: var(--accent-green-soft); color: var(--accent-green); }
    .wizard-step-num { font-weight: 700; margin-right: 6px; }
    .fleet-business-badge { padding: 4px 12px; border-radius: 100px; font-size: 0.75rem; font-weight: 600; background: linear-gradient(135deg, rgba(212,168,85,0.2), rgba(212,168,85,0.1)); color: var(--accent-gold); }
    .approval-indicator { display: inline-flex; align-items: center; gap: 4px; font-size: 0.75rem; color: var(--accent-orange); }
    .approval-indicator.no-approval { color: var(--accent-green); }
    
    /* Document Expiration Badges */
    .expiration-badge { display: inline-flex; align-items: center; gap: 4px; padding: 4px 10px; border-radius: 100px; font-size: 0.72rem; font-weight: 500; margin-left: 8px; }
    .expiration-badge.valid { background: var(--accent-green-soft); color: var(--accent-green); }
    .expiration-badge.expiring-soon { background: var(--accent-orange); color: #0a0a0f; animation: pulse 2s infinite; }
    .expiration-badge.expired { background: var(--accent-red); color: #fff; }
    .expiration-warning { display: flex; align-items: center; gap: 8px; padding: 12px 16px; background: rgba(239, 95, 95, 0.1); border: 1px solid rgba(239, 95, 95, 0.3); border-radius: var(--radius-md); margin-bottom: 16px; font-size: 0.9rem; color: var(--accent-red); }
    .expiration-warning.warning { background: rgba(245, 158, 11, 0.1); border-color: rgba(245, 158, 11, 0.3); color: var(--accent-orange); }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
  </style>
  <script src="/i18n.js"></script>
</head>
<body>
  <!-- Sidebar -->
  <div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleSidebar()" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:40;"></div>
  <aside class="sidebar" id="sidebar">
    <div class="mobile-close" onclick="toggleSidebar()" style="display:none;position:absolute;top:16px;right:16px;width:36px;height:36px;background:var(--bg-elevated);border:1px solid var(--border-subtle);border-radius:50%;cursor:pointer;font-size:1.2rem;display:flex;align-items:center;justify-content:center;">‚úï</div>
    <a href="index.html" class="sidebar-brand">
      <img src="logo.png" alt="My Car Concierge" class="sidebar-brand-icon">
    </a>
    <div id="language-switcher" style="padding:0 12px 16px;"></div>

    <div class="nav-label" data-i18n="member.navDashboard">Dashboard</div>
    <div class="nav-item active" data-section="overview"><span data-i18n="member.overview">üìä Overview</span></div>
    
    <div class="nav-label" data-i18n="member.navDigitalGarage">Digital Garage</div>
    <div class="nav-item" data-section="vehicles"><span data-i18n="member.myVehicles">üöó My Vehicles</span></div>
    <div class="nav-item" data-section="household"><span>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Household</span> <span class="nav-badge" id="household-count" style="display:none;">0</span></div>
    <div class="nav-item" data-section="fleet" style="background:linear-gradient(135deg, rgba(212,168,85,0.1), rgba(74,124,255,0.05));border:1px solid rgba(212,168,85,0.2);"><span style="color:var(--accent-gold);">üè¢ Fleet</span> <span class="nav-badge" id="fleet-count" style="display:none;">0</span></div>
    <div class="nav-item" data-section="reminders"><span data-i18n="member.reminders">üîî Reminders</span> <span class="nav-badge" id="reminder-count" style="display:none;">0</span></div>
    
    <div class="nav-label" data-i18n="member.navServices">Services</div>
    <div class="nav-item" data-section="packages"><span data-i18n="member.maintenancePackages">üì¶ Maintenance Packages</span></div>
    <div class="nav-item" data-section="upsells"><span data-i18n="member.additionalWork">‚ö†Ô∏è Additional Work</span> <span class="nav-badge" id="upsell-count" style="display:none;background:var(--accent-orange);">0</span></div>
    <div class="nav-item" data-section="messages"><span data-i18n="nav.messages">üí¨ Messages</span> <span class="nav-badge" id="message-count" style="display:none;">0</span></div>
    <div class="nav-item" data-section="history"><span data-i18n="member.serviceHistory">üìú Service History</span></div>
    <div class="nav-item" data-section="emergency" style="background:linear-gradient(135deg, rgba(239,95,95,0.1), rgba(255,68,68,0.05));border:1px solid rgba(239,95,95,0.2);"><span style="color:var(--accent-red);">üÜò Emergency Roadside</span></div>
    <div class="nav-item" data-section="destination-services" style="background:linear-gradient(135deg, rgba(74,124,255,0.1), rgba(212,168,85,0.05));border:1px solid rgba(74,124,255,0.2);"><span style="color:var(--accent-blue);">üöó Destination Services</span> <span class="nav-badge" id="destination-count" style="display:none;background:var(--accent-blue);">0</span></div>

    <div class="nav-label" data-i18n="member.navSupport">Support</div>
    <div class="nav-item" onclick="openSupport()"><span data-i18n="member.helpSupport">üé´ Help & Support</span></div>
    <div class="nav-item" data-section="notifications"><span data-i18n="nav.notifications">üîî Notifications</span> <span class="nav-badge" id="notif-count" style="display:none;background:var(--accent-red);">0</span></div>
    <div class="nav-item" data-section="settings"><span data-i18n="nav.settings">‚öôÔ∏è Settings</span></div>

    <!-- Admin Access (only visible to admins) -->
    <div id="admin-nav" style="display:none;">
      <div class="nav-label">Admin</div>
      <div class="nav-item" onclick="window.location.href='admin.html'" style="background:var(--accent-gold-soft);color:var(--accent-gold);">üëë Admin Portal</div>
    </div>

    <div class="sidebar-footer">
      <div id="realtime-status" style="padding:8px 12px;margin-bottom:8px;font-size:0.75rem;display:flex;align-items:center;gap:6px;color:var(--text-muted);">
        <span id="realtime-dot" style="width:8px;height:8px;border-radius:50%;background:var(--accent-orange);"></span>
        <span id="realtime-text">Connecting...</span>
      </div>
      <div class="user-info">
        <div class="user-avatar" id="user-avatar">JD</div>
        <div>
          <div class="user-name" id="user-name">Loading...</div>
          <div class="user-email" id="user-email">...</div>
        </div>
      </div>
      <div id="switch-portal-container" style="display:none;background:var(--bg-elevated);border:1px solid var(--accent-gold);border-radius:var(--radius-md);padding:12px;margin-bottom:12px;">
        <div style="font-size:0.75rem;color:var(--text-muted);margin-bottom:8px;text-transform:uppercase;letter-spacing:0.05em;">Switch Portal</div>
        <button id="switch-portal-btn" class="btn" onclick="switchToProvider()" style="width:100%;padding:12px 16px;font-size:0.9rem;background:linear-gradient(135deg, var(--accent-gold), #e8bc5a);color:#0a0a0f;font-weight:600;border:none;">
          üîß Provider Portal
        </button>
        <div style="font-size:0.72rem;color:var(--text-muted);margin-top:6px;text-align:center;">You have dual access</div>
      </div>
      <button class="btn btn-secondary" onclick="logout()" style="width:100%;padding:14px 20px;font-size:0.95rem;">üö™ Log Out</button>
      <div class="sidebar-disclaimer" style="margin-top:12px;padding:10px 12px;background:rgba(148,148,168,0.06);border-radius:8px;border:1px solid rgba(148,148,168,0.08);">
        <p style="font-size:0.68rem;color:var(--text-muted);line-height:1.5;margin:0;">
          <strong style="color:var(--text-secondary);">Disclaimer:</strong> MCC is a marketplace only. We connect you with independent providers but do not perform or guarantee any services.
        </p>
      </div>
    </div>
  </aside>

  <!-- Main Content -->
  <main class="main">
    <div class="mobile-header">
      <button class="mobile-menu-btn" onclick="toggleSidebar()">‚ò∞</button>
      <span style="font-weight: 600;">My Car Concierge</span>
    </div>

    <!-- Active Emergency Banner -->
    <div id="emergency-alert-banner" class="emergency-banner" style="display:none;" onclick="openEmergencyStatus()">
      <span style="font-size:24px;">üö®</span>
      <div style="flex:1;">
        <strong>Active Emergency Request</strong>
        <div id="emergency-banner-status" style="font-size:0.9rem;opacity:0.9;">Waiting for a provider...</div>
      </div>
      <span style="text-decoration:underline;">View Status ‚Üí</span>
    </div>

    <!-- Upsell Alert Banner (shows when pending upsells) -->
    <div id="upsell-alert-banner" style="display:none;background:var(--accent-orange-soft);border:1px solid rgba(245,158,11,0.3);color:var(--accent-orange);padding:16px 20px;border-radius:var(--radius-lg);margin-bottom:24px;cursor:pointer;" onclick="showSection('upsells')">
      <strong>‚ö†Ô∏è Action Required:</strong> A provider has found additional issues that need your approval. <span style="text-decoration:underline;">Review now ‚Üí</span>
    </div>

    <!-- Overview Section -->
    <section id="overview" class="section active">
      <div class="page-header" style="margin-bottom: 32px;">
        <h1 class="page-title" data-i18n="member.welcomeBack" style="font-size: 2rem; font-weight: 700; letter-spacing: -0.5px;">Welcome back</h1>
        <p class="page-subtitle" data-i18n="member.garageSubtitle" style="font-size: 1rem; margin-top: 8px;">Here's what's happening with your garage.</p>
      </div>

      <!-- Quick Actions - Turo Style -->
      <div style="display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 32px;">
        <button class="btn btn-primary" onclick="openVehicleModal()" style="padding: 12px 24px; font-weight: 600; border-radius: 100px;">
          <span data-i18n="member.addVehicle">+ Add Vehicle</span>
        </button>
        <button class="btn btn-secondary" onclick="openPackageModal()" style="padding: 12px 24px; font-weight: 600; border-radius: 100px; border: 2px solid var(--accent-gold); background: transparent; color: var(--accent-gold);">
          <span data-i18n="member.newMaintenancePackage">+ New Service Request</span>
        </button>
      </div>

      <div class="stats-grid" style="margin-bottom: 40px;">
        <div class="stat-card" onclick="showSection('vehicles')" style="cursor:pointer;">
          <div class="stat-icon blue">üöó</div>
          <div class="stat-value" id="stat-vehicles">0</div>
          <div class="stat-label" data-i18n="member.vehicles">Vehicles</div>
        </div>
        <div class="stat-card" onclick="showSection('packages')" style="cursor:pointer;">
          <div class="stat-icon gold">üì¶</div>
          <div class="stat-value" id="stat-packages">0</div>
          <div class="stat-label" data-i18n="member.activePackages">Active Requests</div>
        </div>
        <div class="stat-card" onclick="showSection('packages')" style="cursor:pointer;">
          <div class="stat-icon green">üí¨</div>
          <div class="stat-value" id="stat-bids">0</div>
          <div class="stat-label" data-i18n="member.bidsReceived">Bids Received</div>
        </div>
        <div class="stat-card" onclick="showSection('reminders')" style="cursor:pointer;">
          <div class="stat-icon orange">üîî</div>
          <div class="stat-value" id="stat-reminders">0</div>
          <div class="stat-label" data-i18n="member.dueSoon">Due Soon</div>
        </div>
        <div class="stat-card" onclick="showSection('history')" style="cursor:pointer;">
          <div class="stat-icon green">‚úì</div>
          <div class="stat-value" id="stat-completed">0</div>
          <div class="stat-label" data-i18n="member.completed">Completed</div>
        </div>
        <div class="stat-card" onclick="showSection('packages')" style="cursor:pointer;" title="Browse available service providers">
          <div class="stat-icon blue">üîß</div>
          <div class="stat-value" id="stat-providers">0</div>
          <div class="stat-label">Providers</div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h2 class="card-title" data-i18n="member.recentActivity">Recent Activity</h2>
          <button class="btn btn-ghost" onclick="showSection('packages')"><span data-i18n="common.viewAll">View All ‚Üí</span></button>
        </div>
        <div id="recent-activity">
          <div class="empty-state">
            <div class="empty-state-icon">üì¶</div>
            <p>No recent activity.</p>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h2 class="card-title" data-i18n="member.upcomingReminders">Upcoming Reminders</h2>
          <button class="btn btn-ghost" onclick="showSection('reminders')"><span data-i18n="common.viewAll">View All ‚Üí</span></button>
        </div>
        <div id="upcoming-reminders">
          <div class="empty-state">
            <div class="empty-state-icon">üîî</div>
            <p data-i18n="member.noUpcomingReminders">No upcoming reminders.</p>
          </div>
        </div>
      </div>

      <div class="card" id="recommendations-card">
        <div class="card-header">
          <h2 class="card-title">üîß Recommended Services</h2>
          <button class="btn btn-ghost btn-sm" onclick="refreshAllRecommendations()">‚Üª Refresh</button>
        </div>
        <div id="recommendations-list">
          <div class="empty-state" style="padding:24px;">
            <div class="empty-state-icon">‚úÖ</div>
            <p>No service recommendations at this time.</p>
            <p style="font-size:0.85rem;margin-top:8px;">Recommendations will appear based on your vehicle data and service history.</p>
          </div>
        </div>
      </div>
    </section>

    <!-- Vehicles Section (Digital Garage) -->
    <section id="vehicles" class="section">
      <div class="page-header" style="margin-bottom: 32px;">
        <h1 class="page-title" data-i18n="member.vehiclesTitle" style="font-size: 2rem; font-weight: 700; letter-spacing: -0.5px;">My Vehicles</h1>
        <p class="page-subtitle" data-i18n="member.vehiclesSubtitle" style="font-size: 1rem; margin-top: 8px;">Your digital garage - all your vehicles in one place.</p>
      </div>

      <div style="margin-bottom: 28px;">
        <button class="btn btn-primary" onclick="openVehicleModal()" style="padding: 12px 24px; font-weight: 600; border-radius: 100px; border: 2px solid var(--accent-gold); background: transparent; color: var(--accent-gold);">
          <span data-i18n="member.addVehicle">+ Add Vehicle</span>
        </button>
      </div>

      <div class="vehicles-grid" id="vehicles-grid">
        <div class="empty-state">
          <div class="empty-state-icon">üöó</div>
          <p>No vehicles in your garage yet.</p>
        </div>
      </div>
    </section>

    <!-- Reminders Section -->
    <section id="reminders" class="section">
      <div class="page-header" style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:16px;">
        <div>
          <h1 class="page-title">Reminders</h1>
          <p class="page-subtitle">Stay on top of your vehicle maintenance.</p>
        </div>
        <div style="display:flex;gap:12px;align-items:center;">
          <button id="show-dismissed-btn" class="btn btn-ghost btn-sm" onclick="toggleDismissedReminders()" style="display:none;">Show dismissed</button>
          <button class="btn btn-primary" onclick="openCreateReminderModal()">+ Add Reminder</button>
        </div>
      </div>

      <div id="reminders-list">
        <div class="empty-state">
          <div class="empty-state-icon">üîî</div>
          <p>No reminders set.</p>
        </div>
      </div>
    </section>

    <!-- Maintenance Packages Section -->
    <section id="packages" class="section">
      <div class="page-header">
        <h1 class="page-title">Maintenance Packages</h1>
        <p class="page-subtitle">Create packages and let providers compete for your business.</p>
      </div>

      <div style="margin-bottom: 24px;">
        <button class="btn btn-primary" onclick="openPackageModal()">+ New Package</button>
      </div>

      <div class="tabs">
        <div class="tab active" data-tab="open">Open</div>
        <div class="tab" data-tab="active">In Progress</div>
        <div class="tab" data-tab="completed">Completed</div>
        <div class="tab" data-tab="all">All</div>
      </div>

      <div class="packages-list" id="packages-list">
        <div class="empty-state">
          <div class="empty-state-icon">üì¶</div>
          <p>No maintenance packages yet.</p>
        </div>
      </div>
    </section>

    <!-- Messages Section -->
    <section id="messages" class="section">
      <div class="page-header">
        <h1 class="page-title">Messages</h1>
        <p class="page-subtitle">Communicate with service providers.</p>
      </div>

      <div id="conversations-list">
        <div class="empty-state">
          <div class="empty-state-icon">üí¨</div>
          <p>No conversations yet.</p>
        </div>
      </div>
    </section>

    <!-- Upsell Requests Section (Additional Work Requests) -->
    <section id="upsells" class="section">
      <div class="page-header">
        <h1 class="page-title">Additional Work Requests</h1>
        <p class="page-subtitle">Providers may find additional issues during service. Review and approve below.</p>
      </div>

      <div class="card" style="background:var(--accent-blue-soft);border-color:rgba(74,124,255,0.3);margin-bottom:24px;">
        <h3 style="margin-bottom:12px;">üõ°Ô∏è Your Protection</h3>
        <ul style="color:var(--text-secondary);line-height:1.8;padding-left:20px;">
          <li><strong>No pressure:</strong> You have 24 hours to decide on any additional work</li>
          <li><strong>Photo evidence:</strong> Providers must show you what they found</li>
          <li><strong>Your choice:</strong> You can approve, decline, or get competing bids</li>
          <li><strong>Scope locked:</strong> Original work proceeds regardless of your decision</li>
          <li><strong>Second opinion:</strong> Create a new package for competitive bids on any findings</li>
        </ul>
      </div>

      <div class="tabs" style="margin-bottom:20px;">
        <div class="tab active" data-upsell-filter="pending">Pending</div>
        <div class="tab" data-upsell-filter="approved">Approved</div>
        <div class="tab" data-upsell-filter="declined">Declined</div>
        <div class="tab" data-upsell-filter="all">All</div>
      </div>

      <div id="upsells-list">
        <div class="empty-state">
          <div class="empty-state-icon">‚úÖ</div>
          <p>No additional work requests. You're all set!</p>
        </div>
      </div>
    </section>

    <!-- Service History Section -->
    <section id="history" class="section">
      <div class="page-header">
        <h1 class="page-title">Service History</h1>
        <p class="page-subtitle">Complete record of all services performed.</p>
      </div>

      <div class="form-group" style="max-width: 300px; margin-bottom: 24px;">
        <select class="form-select" id="history-vehicle-filter">
          <option value="">All Vehicles</option>
        </select>
      </div>

      <div id="history-list">
        <div class="empty-state">
          <div class="empty-state-icon">üìú</div>
          <p>No service history yet.</p>
        </div>
      </div>
    </section>

    <!-- Notifications Section -->
    <section id="notifications" class="section">
      <div class="page-header">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div>
            <h1 class="page-title">Notifications</h1>
            <p class="page-subtitle">Stay updated on your packages and bids.</p>
          </div>
          <button class="btn btn-secondary" onclick="markAllNotificationsRead()">Mark All Read</button>
        </div>
      </div>

      <div id="notifications-list">
        <div class="empty-state">
          <div class="empty-state-icon">üîî</div>
          <p>No notifications yet.</p>
        </div>
      </div>
    </section>

    <!-- Settings Section -->
    <section id="settings" class="section">
      <div class="page-header">
        <h1 class="page-title">Settings</h1>
        <p class="page-subtitle">Manage your profile and preferences.</p>
      </div>

      <div class="card">
        <div class="card-header">
          <h2 class="card-title">Profile Information</h2>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Full Name</label>
            <input type="text" class="form-input" id="settings-name" placeholder="Your full name">
          </div>
          <div class="form-group">
            <label class="form-label">Phone Number</label>
            <input type="tel" class="form-input" id="settings-phone" placeholder="(555) 555-5555">
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:20px;">
        <div class="card-header">
          <h2 class="card-title">üìç Service Location</h2>
          <p style="font-size:0.9rem;color:var(--text-secondary);margin-top:4px;">This helps providers in your area find your service requests.</p>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">ZIP Code <span class="required">*</span></label>
            <input type="text" class="form-input" id="settings-zip" placeholder="e.g., 07003" maxlength="10" style="max-width:150px;">
          </div>
          <div class="form-group">
            <label class="form-label">City</label>
            <input type="text" class="form-input" id="settings-city" placeholder="City name">
          </div>
          <div class="form-group">
            <label class="form-label">State</label>
            <select class="form-select" id="settings-state">
              <option value="">Select State</option>
              <option value="AL">Alabama</option><option value="AK">Alaska</option><option value="AZ">Arizona</option>
              <option value="AR">Arkansas</option><option value="CA">California</option><option value="CO">Colorado</option>
              <option value="CT">Connecticut</option><option value="DE">Delaware</option><option value="FL">Florida</option>
              <option value="GA">Georgia</option><option value="HI">Hawaii</option><option value="ID">Idaho</option>
              <option value="IL">Illinois</option><option value="IN">Indiana</option><option value="IA">Iowa</option>
              <option value="KS">Kansas</option><option value="KY">Kentucky</option><option value="LA">Louisiana</option>
              <option value="ME">Maine</option><option value="MD">Maryland</option><option value="MA">Massachusetts</option>
              <option value="MI">Michigan</option><option value="MN">Minnesota</option><option value="MS">Mississippi</option>
              <option value="MO">Missouri</option><option value="MT">Montana</option><option value="NE">Nebraska</option>
              <option value="NV">Nevada</option><option value="NH">New Hampshire</option><option value="NJ">New Jersey</option>
              <option value="NM">New Mexico</option><option value="NY">New York</option><option value="NC">North Carolina</option>
              <option value="ND">North Dakota</option><option value="OH">Ohio</option><option value="OK">Oklahoma</option>
              <option value="OR">Oregon</option><option value="PA">Pennsylvania</option><option value="RI">Rhode Island</option>
              <option value="SC">South Carolina</option><option value="SD">South Dakota</option><option value="TN">Tennessee</option>
              <option value="TX">Texas</option><option value="UT">Utah</option><option value="VT">Vermont</option>
              <option value="VA">Virginia</option><option value="WA">Washington</option><option value="WV">West Virginia</option>
              <option value="WI">Wisconsin</option><option value="WY">Wyoming</option><option value="DC">Washington DC</option>
            </select>
          </div>
        </div>
        <div id="location-status" style="margin-top:12px;display:none;"></div>
      </div>

      <!-- SMS Notifications -->
      <div class="card" style="margin-top:20px;">
        <div class="card-header">
          <h2 class="card-title">üì± SMS Notifications</h2>
          <p style="font-size:0.9rem;color:var(--text-secondary);margin-top:4px;">Get text alerts for important updates.</p>
        </div>
        
        <div class="form-group">
          <label style="display:flex;align-items:center;gap:10px;cursor:pointer;">
            <input type="checkbox" id="sms-enabled" onchange="toggleSmsOptions()">
            <span style="font-weight:500;">Enable SMS notifications</span>
          </label>
          <p class="form-hint">Standard messaging rates may apply.</p>
        </div>

        <div id="sms-options" style="display:none;margin-top:16px;padding-top:16px;border-top:1px solid var(--border-subtle);">
          <p style="font-weight:500;margin-bottom:12px;">Notify me when:</p>
          <div style="display:grid;gap:10px;">
            <label style="display:flex;align-items:center;gap:10px;cursor:pointer;">
              <input type="checkbox" id="sms-bid-received" checked>
              <span>üí∞ I receive a new bid</span>
            </label>
            <label style="display:flex;align-items:center;gap:10px;cursor:pointer;">
              <input type="checkbox" id="sms-work-completed" checked>
              <span>‚úÖ Work is completed</span>
            </label>
            <label style="display:flex;align-items:center;gap:10px;cursor:pointer;">
              <input type="checkbox" id="sms-new-message">
              <span>üí¨ I receive a new message</span>
            </label>
            <label style="display:flex;align-items:center;gap:10px;cursor:pointer;">
              <input type="checkbox" id="sms-bidding-ending" checked>
              <span>‚è∞ Bidding window is ending soon</span>
            </label>
          </div>
        </div>
      </div>

      <div style="margin-top:24px;">
        <button class="btn btn-primary" onclick="saveSettings()">Save Settings</button>
      </div>
    </section>

    <!-- Emergency Roadside Section -->
    <section id="emergency" class="section">
      <div class="page-header">
        <h1 class="page-title" style="color:var(--accent-red);">üÜò Emergency Roadside Assistance</h1>
        <p class="page-subtitle">Get immediate help when you're stranded.</p>
      </div>

      <!-- Active Emergency Status (shown when there's an active request) -->
      <div id="emergency-active-status" style="display:none;margin-bottom:24px;">
        <div class="card" style="background:linear-gradient(135deg, rgba(239,95,95,0.15), rgba(255,68,68,0.1));border:2px solid rgba(239,95,95,0.4);">
          <div style="display:flex;align-items:center;gap:16px;margin-bottom:16px;">
            <span style="font-size:2.5rem;animation:pulse 2s infinite;">üö®</span>
            <div>
              <h3 style="margin:0;color:var(--accent-red);">Active Emergency Request</h3>
              <p id="emergency-active-type" style="margin:4px 0 0;color:var(--text-secondary);"></p>
            </div>
          </div>
          <div id="emergency-status-timeline" class="emergency-timeline"></div>
          <div id="emergency-provider-info" style="display:none;margin-top:16px;padding:16px;background:var(--bg-elevated);border-radius:var(--radius-md);"></div>
          <button class="btn btn-secondary" onclick="cancelActiveEmergency()" style="margin-top:16px;">Cancel Request</button>
        </div>
      </div>

      <!-- New Emergency Request Form -->
      <div id="emergency-request-form">
        <div class="card" style="border:2px solid rgba(239,95,95,0.3);">
          <div class="card-header">
            <h2 class="card-title" style="color:var(--accent-red);">Request Emergency Help</h2>
            <p style="color:var(--text-secondary);margin-top:4px;">Describe your situation and we'll dispatch nearby providers.</p>
          </div>

          <div class="form-group">
            <label class="form-label">What's your emergency? *</label>
            <div style="display:grid;grid-template-columns:repeat(auto-fill, minmax(140px, 1fr));gap:12px;margin-top:8px;">
              <label class="emergency-type-option" style="display:flex;flex-direction:column;align-items:center;padding:16px;background:var(--bg-elevated);border:2px solid var(--border-subtle);border-radius:var(--radius-md);cursor:pointer;transition:all 0.2s;">
                <input type="radio" name="emergency-type" value="flat_tire" style="display:none;">
                <span style="font-size:2rem;margin-bottom:8px;">üõû</span>
                <span style="font-size:0.85rem;text-align:center;">Flat Tire</span>
              </label>
              <label class="emergency-type-option" style="display:flex;flex-direction:column;align-items:center;padding:16px;background:var(--bg-elevated);border:2px solid var(--border-subtle);border-radius:var(--radius-md);cursor:pointer;transition:all 0.2s;">
                <input type="radio" name="emergency-type" value="dead_battery" style="display:none;">
                <span style="font-size:2rem;margin-bottom:8px;">üîã</span>
                <span style="font-size:0.85rem;text-align:center;">Dead Battery</span>
              </label>
              <label class="emergency-type-option" style="display:flex;flex-direction:column;align-items:center;padding:16px;background:var(--bg-elevated);border:2px solid var(--border-subtle);border-radius:var(--radius-md);cursor:pointer;transition:all 0.2s;">
                <input type="radio" name="emergency-type" value="lockout" style="display:none;">
                <span style="font-size:2rem;margin-bottom:8px;">üîë</span>
                <span style="font-size:0.85rem;text-align:center;">Locked Out</span>
              </label>
              <label class="emergency-type-option" style="display:flex;flex-direction:column;align-items:center;padding:16px;background:var(--bg-elevated);border:2px solid var(--border-subtle);border-radius:var(--radius-md);cursor:pointer;transition:all 0.2s;">
                <input type="radio" name="emergency-type" value="tow_needed" style="display:none;">
                <span style="font-size:2rem;margin-bottom:8px;">üöõ</span>
                <span style="font-size:0.85rem;text-align:center;">Need a Tow</span>
              </label>
              <label class="emergency-type-option" style="display:flex;flex-direction:column;align-items:center;padding:16px;background:var(--bg-elevated);border:2px solid var(--border-subtle);border-radius:var(--radius-md);cursor:pointer;transition:all 0.2s;">
                <input type="radio" name="emergency-type" value="fuel_delivery" style="display:none;">
                <span style="font-size:2rem;margin-bottom:8px;">‚õΩ</span>
                <span style="font-size:0.85rem;text-align:center;">Out of Fuel</span>
              </label>
              <label class="emergency-type-option" style="display:flex;flex-direction:column;align-items:center;padding:16px;background:var(--bg-elevated);border:2px solid var(--border-subtle);border-radius:var(--radius-md);cursor:pointer;transition:all 0.2s;">
                <input type="radio" name="emergency-type" value="other" style="display:none;">
                <span style="font-size:2rem;margin-bottom:8px;">‚ùì</span>
                <span style="font-size:0.85rem;text-align:center;">Other Issue</span>
              </label>
            </div>
          </div>

          <div class="form-group" style="margin-top:20px;">
            <label class="form-label">Select Vehicle</label>
            <select class="form-select" id="emergency-vehicle">
              <option value="">Loading vehicles...</option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label">Your Location</label>
            <div style="display:flex;gap:12px;align-items:center;">
              <input type="text" class="form-input" id="emergency-address" placeholder="Getting your location..." readonly style="flex:1;">
              <button class="btn btn-secondary" onclick="refreshEmergencyLocation()" style="white-space:nowrap;">üìç Refresh</button>
            </div>
            <input type="hidden" id="emergency-lat">
            <input type="hidden" id="emergency-lng">
          </div>

          <div class="form-group">
            <label class="form-label">Additional Details (optional)</label>
            <textarea class="form-input" id="emergency-description" rows="3" placeholder="Describe your situation..."></textarea>
          </div>

          <div class="form-group">
            <label class="form-label">Photos (optional)</label>
            <div class="emergency-photos" id="emergency-photo-preview"></div>
            <input type="file" id="emergency-photos" accept="image/*" multiple style="display:none;" onchange="previewEmergencyPhotos(this)">
            <button class="btn btn-secondary" onclick="document.getElementById('emergency-photos').click()" style="margin-top:8px;">üì∑ Add Photos</button>
          </div>

          <button class="btn" onclick="submitEmergencyRequest()" style="width:100%;margin-top:20px;padding:18px;font-size:1.1rem;background:linear-gradient(135deg, #ef5f5f, #ff4444);color:white;font-weight:600;">
            üÜò Request Emergency Help
          </button>
        </div>
      </div>

      <!-- Past Emergencies -->
      <div class="card" style="margin-top:24px;">
        <div class="card-header">
          <h2 class="card-title">Past Emergency Requests</h2>
        </div>
        <div id="emergency-history-list">
          <div class="empty-state">
            <div class="empty-state-icon">üÜò</div>
            <p>No emergency requests yet.</p>
          </div>
        </div>
      </div>
    </section>

    <!-- Destination Services Section -->
    <section id="destination-services" class="section">
      <div class="page-header">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:16px;">
          <div>
            <h1 class="page-title" style="color:var(--accent-blue);">üöó Destination Services</h1>
            <p class="page-subtitle">Let a vetted driver take your car where it needs to go.</p>
          </div>
          <button class="btn btn-primary" onclick="openDestinationBookingModal()" style="padding:12px 24px;">+ Book Service</button>
        </div>
      </div>

      <!-- What Are Destination Services Info Card -->
      <div class="card" style="background:linear-gradient(135deg, rgba(74,124,255,0.08), rgba(212,168,85,0.06));border:1px solid rgba(74,124,255,0.2);margin-bottom:24px;">
        <h3 style="margin:0 0 12px;color:var(--accent-blue);">How It Works</h3>
        <p style="color:var(--text-secondary);margin:0 0 16px;line-height:1.6;">
          Need your car somewhere but can't drive it yourself? A verified provider will pick up your vehicle, drive it to the destination, and return it when done. <strong>You stay home while your car gets where it needs to go.</strong>
        </p>
        <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(150px, 1fr));gap:12px;">
          <div style="text-align:center;padding:12px;background:var(--bg-card);border-radius:var(--radius-md);border:1px solid var(--border-subtle);">
            <div style="font-size:1.8rem;margin-bottom:4px;">‚úàÔ∏è</div>
            <strong style="font-size:0.85rem;">Airport</strong>
            <p style="font-size:0.75rem;color:var(--text-muted);margin:4px 0 0;">Pickup or dropoff</p>
          </div>
          <div style="text-align:center;padding:12px;background:var(--bg-card);border-radius:var(--radius-md);border:1px solid var(--border-subtle);">
            <div style="font-size:1.8rem;margin-bottom:4px;">üè¢</div>
            <strong style="font-size:0.85rem;">Dealership</strong>
            <p style="font-size:0.75rem;color:var(--text-muted);margin:4px 0 0;">Warranty & recalls</p>
          </div>
          <div style="text-align:center;padding:12px;background:var(--bg-card);border-radius:var(--radius-md);border:1px solid var(--border-subtle);">
            <div style="font-size:1.8rem;margin-bottom:4px;">‚ú®</div>
            <strong style="font-size:0.85rem;">Detailing</strong>
            <p style="font-size:0.75rem;color:var(--text-muted);margin:4px 0 0;">Full cleaning service</p>
          </div>
          <div style="text-align:center;padding:12px;background:var(--bg-card);border-radius:var(--radius-md);border:1px solid var(--border-subtle);">
            <div style="font-size:1.8rem;margin-bottom:4px;">üîë</div>
            <strong style="font-size:0.85rem;">Valet</strong>
            <p style="font-size:0.75rem;color:var(--text-muted);margin:4px 0 0;">Any service pickup</p>
          </div>
        </div>
      </div>

      <div class="tabs" id="destination-tabs">
        <div class="tab active" data-dest-filter="active">Active</div>
        <div class="tab" data-dest-filter="pending">Pending</div>
        <div class="tab" data-dest-filter="completed">Completed</div>
        <div class="tab" data-dest-filter="all">All</div>
      </div>

      <div id="destination-services-list" class="packages-list">
        <div class="empty-state">
          <div class="empty-state-icon">üöó</div>
          <p>No destination services yet.</p>
          <p style="font-size:0.85rem;color:var(--text-muted);margin-top:8px;">Book airport runs, dealership trips, and more!</p>
          <button class="btn btn-primary" onclick="openDestinationBookingModal()" style="margin-top:16px;">+ Book Your First Service</button>
        </div>
      </div>
    </section>

    <!-- Household Section -->
    <section id="household" class="section">
      <div class="page-header">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:16px;">
          <div>
            <h1 class="page-title">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Household</h1>
            <p class="page-subtitle">Manage your family members and share vehicles.</p>
          </div>
        </div>
      </div>

      <!-- Pending Invitations Banner -->
      <div id="household-pending-invitations-banner" style="display:none;margin-bottom:24px;"></div>

      <!-- No Household - Create Card -->
      <div id="household-no-household" style="display:none;">
        <div class="card" style="text-align:center;padding:48px 32px;">
          <div style="font-size:64px;margin-bottom:20px;">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</div>
          <h2 style="font-size:1.5rem;margin-bottom:12px;">Create Your Household</h2>
          <p style="color:var(--text-secondary);max-width:500px;margin:0 auto 24px;line-height:1.6;">
            Create a household to share vehicles with family members. Everyone in your household can view shared vehicles, request services, and stay informed about maintenance.
          </p>
          <div style="max-width:400px;margin:0 auto;">
            <div class="form-group">
              <input type="text" class="form-input" id="create-household-name" placeholder="e.g., Smith Family" style="text-align:center;font-size:1.1rem;">
            </div>
            <button class="btn btn-primary" onclick="createNewHousehold()" style="width:100%;padding:14px 28px;font-size:1rem;">
              Create Household
            </button>
          </div>
          <div style="margin-top:24px;padding-top:24px;border-top:1px solid var(--border-subtle);">
            <h4 style="margin-bottom:12px;color:var(--accent-gold);">‚ú® Benefits of Household Sharing</h4>
            <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:16px;text-align:left;max-width:600px;margin:0 auto;">
              <div style="padding:12px;background:var(--bg-input);border-radius:var(--radius-md);">
                <strong style="color:var(--accent-blue);">üöó Share Vehicles</strong>
                <p style="font-size:0.85rem;color:var(--text-muted);margin-top:4px;">Family members can view and request services for shared vehicles.</p>
              </div>
              <div style="padding:12px;background:var(--bg-input);border-radius:var(--radius-md);">
                <strong style="color:var(--accent-green);">üëÄ Stay Informed</strong>
                <p style="font-size:0.85rem;color:var(--text-muted);margin-top:4px;">Everyone sees service history and upcoming maintenance.</p>
              </div>
              <div style="padding:12px;background:var(--bg-input);border-radius:var(--radius-md);">
                <strong style="color:var(--accent-gold);">üîí Control Access</strong>
                <p style="font-size:0.85rem;color:var(--text-muted);margin-top:4px;">Set permissions and spending limits for each member.</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Household Dashboard -->
      <div id="household-dashboard" style="display:none;">
        <!-- Header Card -->
        <div class="card" style="margin-bottom:24px;">
          <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:16px;">
            <div style="display:flex;align-items:center;gap:16px;">
              <div style="width:56px;height:56px;background:linear-gradient(135deg, var(--accent-gold), #e8bc5a);border-radius:var(--radius-lg);display:flex;align-items:center;justify-content:center;font-size:28px;">üè†</div>
              <div>
                <h2 id="household-name-display" style="font-size:1.4rem;font-weight:600;margin-bottom:4px;"></h2>
                <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;">
                  <span class="package-status accepted" id="household-member-count-badge" style="font-size:0.8rem;"></span>
                  <span class="package-status" id="household-vehicle-count-badge" style="font-size:0.8rem;background:var(--accent-blue-soft);color:var(--accent-blue);"></span>
                  <span style="color:var(--text-muted);font-size:0.85rem;" id="household-role-display"></span>
                </div>
              </div>
            </div>
            <div style="display:flex;gap:10px;flex-wrap:wrap;">
              <button class="btn btn-ghost btn-sm" onclick="editHouseholdName()" id="edit-household-btn" style="display:none;">‚úèÔ∏è Edit Name</button>
              <button class="btn btn-primary" onclick="openInviteMemberModal()" id="invite-member-btn" style="display:none;">+ Invite Member</button>
            </div>
          </div>
        </div>

        <!-- Members Section -->
        <div class="card" style="margin-bottom:24px;">
          <div class="card-header">
            <h2 class="card-title">üë• Members</h2>
          </div>
          <div id="household-members-grid" style="display:grid;grid-template-columns:repeat(auto-fill, minmax(280px, 1fr));gap:16px;">
          </div>
        </div>

        <!-- Pending Invitations Section -->
        <div class="card" id="household-pending-section" style="margin-bottom:24px;display:none;">
          <div class="card-header">
            <h2 class="card-title">üì® Pending Invitations</h2>
          </div>
          <div id="household-pending-list">
          </div>
        </div>

        <!-- Shared Vehicles Section -->
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">üöó Shared Vehicles</h2>
            <button class="btn btn-secondary btn-sm" onclick="openShareVehicleModal()" id="share-vehicle-btn" style="display:none;">+ Share a Vehicle</button>
          </div>
          <div id="household-vehicles-grid" style="display:grid;grid-template-columns:repeat(auto-fill, minmax(280px, 1fr));gap:16px;">
            <div class="empty-state" style="grid-column:1/-1;padding:32px;">
              <div class="empty-state-icon">üöó</div>
              <p>No vehicles shared yet.</p>
            </div>
          </div>
        </div>

        <!-- Household Activity Section -->
        <div class="card" style="margin-top:24px;">
          <div class="card-header">
            <h2 class="card-title">üìä Household Activity</h2>
            <button class="btn btn-ghost btn-sm" onclick="refreshHouseholdActivity()">‚Üª Refresh</button>
          </div>
          <p style="font-size:0.9rem;color:var(--text-secondary);margin-bottom:20px;">Recent service requests by household members.</p>
          <div id="household-activity-list">
            <div class="empty-state" style="padding:24px;">
              <div class="empty-state-icon">üìä</div>
              <p>No recent activity.</p>
              <p style="font-size:0.85rem;color:var(--text-muted);margin-top:8px;">Service requests from household members will appear here.</p>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Fleet Management Section -->
    <section id="fleet" class="section">
      <div class="page-header">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:16px;">
          <div>
            <h1 class="page-title" style="color:var(--accent-gold);">üè¢ Fleet Management</h1>
            <p class="page-subtitle">Manage your business vehicles and schedule bulk services.</p>
          </div>
        </div>
      </div>

      <!-- No Fleet - Create Card -->
      <div id="fleet-no-fleet" style="display:none;">
        <div class="card" style="text-align:center;padding:48px 32px;">
          <div style="font-size:64px;margin-bottom:20px;">üè¢</div>
          <h2 style="font-size:1.5rem;margin-bottom:12px;">Create Your Fleet</h2>
          <p style="color:var(--text-secondary);max-width:500px;margin:0 auto 24px;line-height:1.6;">
            Set up a business fleet to manage company vehicles, assign drivers, and schedule bulk maintenance services for your organization.
          </p>
          <div style="max-width:600px;margin:0 auto;">
            <div class="form-group">
              <input type="text" class="form-input" id="create-fleet-name" placeholder="Fleet/Company Name" style="text-align:center;font-size:1.1rem;">
            </div>
            <div class="form-row" style="margin-bottom:16px;">
              <div class="form-group" style="margin-bottom:0;">
                <select class="form-select" id="create-fleet-business-type">
                  <option value="">Select Business Type...</option>
                  <option value="rental">Rental</option>
                  <option value="corporate">Corporate</option>
                  <option value="delivery">Delivery</option>
                  <option value="rideshare">Rideshare</option>
                  <option value="logistics">Logistics</option>
                  <option value="government">Government</option>
                  <option value="other">Other</option>
                </select>
              </div>
              <div class="form-group" style="margin-bottom:0;">
                <input type="email" class="form-input" id="create-fleet-billing-email" placeholder="Billing Email">
              </div>
            </div>
            <div class="form-group" style="margin-bottom:16px;">
              <input type="text" class="form-input" id="create-fleet-billing-address" placeholder="Billing Address (Street, City, State, ZIP)">
            </div>
            <div class="form-group" style="margin-bottom:16px;">
              <input type="text" class="form-input" id="create-fleet-tax-id" placeholder="Tax ID / EIN (Optional)">
            </div>
            <button class="btn btn-primary" onclick="createNewFleet()" style="width:100%;padding:14px 28px;font-size:1rem;">
              Create Fleet
            </button>
          </div>
          <div style="margin-top:24px;padding-top:24px;border-top:1px solid var(--border-subtle);">
            <h4 style="margin-bottom:12px;color:var(--accent-gold);">‚ú® Fleet Benefits</h4>
            <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:16px;text-align:left;max-width:700px;margin:0 auto;">
              <div style="padding:12px;background:var(--bg-input);border-radius:var(--radius-md);">
                <strong style="color:var(--accent-blue);">üöó Central Management</strong>
                <p style="font-size:0.85rem;color:var(--text-muted);margin-top:4px;">Manage all company vehicles in one place.</p>
              </div>
              <div style="padding:12px;background:var(--bg-input);border-radius:var(--radius-md);">
                <strong style="color:var(--accent-green);">üìÖ Bulk Scheduling</strong>
                <p style="font-size:0.85rem;color:var(--text-muted);margin-top:4px;">Schedule maintenance for multiple vehicles at once.</p>
              </div>
              <div style="padding:12px;background:var(--bg-input);border-radius:var(--radius-md);">
                <strong style="color:var(--accent-gold);">üë• Role Management</strong>
                <p style="font-size:0.85rem;color:var(--text-muted);margin-top:4px;">Assign roles, spending limits, and approvals.</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Fleet Dashboard -->
      <div id="fleet-dashboard" style="display:none;">
        <!-- Fleet Overview Card -->
        <div class="card" style="margin-bottom:24px;">
          <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:16px;">
            <div style="display:flex;align-items:center;gap:16px;">
              <div style="width:56px;height:56px;background:linear-gradient(135deg, var(--accent-gold), #c49a45);border-radius:var(--radius-lg);display:flex;align-items:center;justify-content:center;font-size:28px;">üè¢</div>
              <div>
                <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;">
                  <h2 id="fleet-name-display" style="font-size:1.4rem;font-weight:600;margin:0;"></h2>
                  <button class="btn btn-ghost btn-sm" onclick="editFleetName()" id="edit-fleet-name-btn" style="padding:4px 8px;">‚úèÔ∏è</button>
                </div>
                <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;margin-top:8px;">
                  <span class="fleet-business-badge" id="fleet-business-type-badge"></span>
                  <span class="package-status accepted" id="fleet-member-count-badge" style="font-size:0.8rem;"></span>
                  <span class="package-status" id="fleet-vehicle-count-badge" style="font-size:0.8rem;background:var(--accent-blue-soft);color:var(--accent-blue);"></span>
                </div>
              </div>
            </div>
            <div style="display:flex;gap:10px;flex-wrap:wrap;">
              <button class="btn btn-secondary btn-sm" onclick="openFleetSettingsModal()">‚öôÔ∏è Settings</button>
            </div>
          </div>
          <div id="fleet-company-info" style="margin-top:16px;padding-top:16px;border-top:1px solid var(--border-subtle);display:none;">
            <div style="display:flex;gap:24px;flex-wrap:wrap;font-size:0.88rem;color:var(--text-secondary);">
              <span id="fleet-billing-email-display" style="display:flex;align-items:center;gap:6px;">üìß</span>
              <span id="fleet-address-display" style="display:flex;align-items:center;gap:6px;">üìç</span>
              <span id="fleet-tax-id-display" style="display:flex;align-items:center;gap:6px;"></span>
            </div>
          </div>
        </div>

        <!-- Quick Stats Cards -->
        <div class="stats-grid" style="margin-bottom:24px;">
          <div class="stat-card">
            <div class="stat-icon green">üîß</div>
            <div class="stat-value" id="fleet-stat-active-services">0</div>
            <div class="stat-label">Active Services</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon orange">‚è≥</div>
            <div class="stat-value" id="fleet-stat-pending-approvals">0</div>
            <div class="stat-label">Pending Approvals</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon blue">üöó</div>
            <div class="stat-value" id="fleet-stat-total-vehicles">0</div>
            <div class="stat-label">Total Vehicles</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon gold">üë•</div>
            <div class="stat-value" id="fleet-stat-team-size">0</div>
            <div class="stat-label">Team Size</div>
          </div>
        </div>

        <!-- Approval Queue Section (for Managers/Owners) -->
        <div class="card" id="fleet-approval-queue-section" style="margin-bottom:24px;display:none;">
          <div class="card-header">
            <h2 class="card-title" style="display:flex;align-items:center;gap:8px;">
              <span style="color:var(--accent-orange);">‚ö†Ô∏è</span> Approval Queue
            </h2>
            <button class="btn btn-ghost btn-sm" onclick="refreshFleetApprovals()">‚Üª Refresh</button>
          </div>
          <p style="font-size:0.9rem;color:var(--text-secondary);margin-bottom:16px;">Service requests requiring your approval.</p>
          <div id="fleet-approval-queue-list">
            <div class="empty-state" style="padding:24px;">
              <div class="empty-state-icon">‚úÖ</div>
              <p>No pending approvals.</p>
              <p style="font-size:0.85rem;color:var(--text-muted);margin-top:8px;">Service requests from team members will appear here.</p>
            </div>
          </div>
        </div>

        <!-- Fleet Members Section -->
        <div class="card" style="margin-bottom:24px;">
          <div class="card-header">
            <h2 class="card-title">üë• Fleet Members</h2>
            <button class="btn btn-primary btn-sm" onclick="openAddFleetEmployeeModal()">+ Add Employee</button>
          </div>
          <div style="overflow-x:auto;">
            <table class="fleet-table" id="fleet-members-table">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Role</th>
                  <th>Employee ID</th>
                  <th>Department</th>
                  <th>Spending Limit</th>
                  <th>Approval</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="fleet-members-tbody">
                <tr>
                  <td colspan="8" style="text-align:center;padding:32px;color:var(--text-muted);">
                    <div style="font-size:32px;margin-bottom:8px;">üë•</div>
                    No fleet members yet. Add your first employee.
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Fleet Vehicles Section -->
        <div class="card" style="margin-bottom:24px;">
          <div class="card-header">
            <h2 class="card-title">üöó Fleet Vehicles</h2>
            <button class="btn btn-primary btn-sm" onclick="openAddFleetVehicleModal()">+ Add Vehicle</button>
          </div>
          <div class="tabs" id="fleet-vehicle-tabs" style="margin-bottom:16px;">
            <div class="tab active" data-fleet-filter="all" onclick="filterFleetVehicles('all')">All</div>
            <div class="tab" data-fleet-filter="assigned" onclick="filterFleetVehicles('assigned')">Assigned</div>
            <div class="tab" data-fleet-filter="pool" onclick="filterFleetVehicles('pool')">Pool</div>
            <div class="tab" data-fleet-filter="needs_service" onclick="filterFleetVehicles('needs_service')">Needs Service</div>
          </div>
          <div id="fleet-vehicles-grid" style="display:grid;grid-template-columns:repeat(auto-fill, minmax(280px, 1fr));gap:16px;">
            <div class="empty-state" style="grid-column:1/-1;padding:32px;">
              <div class="empty-state-icon">üöó</div>
              <p>No vehicles in fleet yet.</p>
              <button class="btn btn-primary btn-sm" onclick="openAddFleetVehicleModal()" style="margin-top:12px;">+ Add First Vehicle</button>
            </div>
          </div>
        </div>

        <!-- Bulk Service Scheduling Section -->
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">üìÖ Bulk Service Scheduling</h2>
            <button class="btn btn-primary" onclick="openBulkServiceWizard()">+ Schedule Bulk Service</button>
          </div>
          <div id="bulk-batches-list">
            <div class="empty-state" style="padding:32px;">
              <div class="empty-state-icon">üìÖ</div>
              <p>No bulk service batches yet.</p>
              <p style="font-size:0.85rem;color:var(--text-muted);margin-top:8px;">Schedule maintenance for multiple vehicles at once.</p>
            </div>
          </div>
        </div>
      </div>
    </section>
    
    <div style="text-align:center;padding:40px 20px 20px;font-size:0.8rem;color:var(--text-muted);">
      ¬© 2025 My Car Concierge. All rights reserved. - IMOR
    </div>
  </main>

  <!-- Invite Household Member Modal -->
  <div class="modal-backdrop" id="invite-member-modal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Invite Household Member</h3>
        <button class="modal-close" onclick="closeModal('invite-member-modal')">√ó</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Email Address *</label>
          <input type="email" class="form-input" id="invite-email" placeholder="family@example.com">
          <p class="form-hint">They'll receive an invitation to join your household.</p>
        </div>
        
        <div class="form-group">
          <label class="form-label">Role *</label>
          <select class="form-select" id="invite-role" onchange="updateInvitePermissions()">
            <option value="adult">Adult - Can manage and approve services</option>
            <option value="driver">Driver - Can request services</option>
            <option value="viewer">Viewer - Can only view vehicle info</option>
          </select>
        </div>
        
        <div class="form-section" id="invite-permissions-section">
          <div class="form-section-title">Permissions</div>
          <div style="display:grid;gap:12px;">
            <label style="display:flex;align-items:center;gap:10px;cursor:pointer;">
              <input type="checkbox" id="perm-request-services" checked>
              <span>Can request services</span>
            </label>
            <label style="display:flex;align-items:center;gap:10px;cursor:pointer;" id="perm-approve-container">
              <input type="checkbox" id="perm-approve-services">
              <span>Can approve services (for Adults)</span>
            </label>
          </div>
          
          <div class="form-group" style="margin-top:16px;">
            <label class="form-label">Spending Limit (Optional)</label>
            <div style="display:flex;align-items:center;gap:8px;">
              <span style="color:var(--text-muted);">$</span>
              <input type="number" class="form-input" id="invite-spending-limit" placeholder="No limit" style="max-width:150px;">
              <span style="color:var(--text-muted);font-size:0.85rem;">per service</span>
            </div>
            <p class="form-hint">Leave empty for no spending limit.</p>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('invite-member-modal')">Cancel</button>
        <button class="btn btn-primary" onclick="sendHouseholdInvitation()">Send Invitation</button>
      </div>
    </div>
  </div>

  <!-- Share Vehicle Modal -->
  <div class="modal-backdrop" id="share-vehicle-modal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Share Vehicle with Household</h3>
        <button class="modal-close" onclick="closeModal('share-vehicle-modal')">√ó</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Select Vehicle *</label>
          <select class="form-select" id="share-vehicle-select">
            <option value="">Choose a vehicle...</option>
          </select>
        </div>
        
        <div class="form-group">
          <label class="form-label">Access Level *</label>
          <div style="display:grid;gap:12px;">
            <label style="display:flex;align-items:flex-start;gap:12px;padding:16px;background:var(--bg-input);border:2px solid var(--border-subtle);border-radius:var(--radius-md);cursor:pointer;transition:all 0.15s;" class="access-level-option" onclick="selectAccessLevel('full')">
              <input type="radio" name="access-level" value="full" style="margin-top:4px;">
              <div>
                <strong style="color:var(--accent-green);">Full Access</strong>
                <p style="font-size:0.85rem;color:var(--text-muted);margin-top:4px;">Members can request any service without approval.</p>
              </div>
            </label>
            <label style="display:flex;align-items:flex-start;gap:12px;padding:16px;background:var(--bg-input);border:2px solid var(--border-subtle);border-radius:var(--radius-md);cursor:pointer;transition:all 0.15s;" class="access-level-option" onclick="selectAccessLevel('request')">
              <input type="radio" name="access-level" value="request" style="margin-top:4px;">
              <div>
                <strong style="color:var(--accent-orange);">Request Only</strong>
                <p style="font-size:0.85rem;color:var(--text-muted);margin-top:4px;">Members can request services, but owner must approve.</p>
              </div>
            </label>
            <label style="display:flex;align-items:flex-start;gap:12px;padding:16px;background:var(--bg-input);border:2px solid var(--border-subtle);border-radius:var(--radius-md);cursor:pointer;transition:all 0.15s;" class="access-level-option" onclick="selectAccessLevel('view')">
              <input type="radio" name="access-level" value="view" style="margin-top:4px;">
              <div>
                <strong style="color:var(--text-muted);">View Only</strong>
                <p style="font-size:0.85rem;color:var(--text-muted);margin-top:4px;">Members can see vehicle info but cannot request services.</p>
              </div>
            </label>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('share-vehicle-modal')">Cancel</button>
        <button class="btn btn-primary" onclick="shareVehicle()">Share Vehicle</button>
      </div>
    </div>
  </div>

  <!-- Manage Member Modal -->
  <div class="modal-backdrop" id="manage-member-modal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Manage Member</h3>
        <button class="modal-close" onclick="closeModal('manage-member-modal')">√ó</button>
      </div>
      <div class="modal-body">
        <div id="manage-member-content"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-danger" onclick="removeMemberFromHousehold()" id="remove-member-btn">Remove from Household</button>
        <button class="btn btn-primary" onclick="saveMemberPermissions()">Save Changes</button>
      </div>
    </div>
  </div>

  <!-- Destination Service Booking Modal -->
  <div class="modal-backdrop" id="destination-booking-modal">
    <div class="modal wide">
      <div class="modal-header">
        <h3 class="modal-title" id="dest-modal-title">Book Destination Service</h3>
        <button class="modal-close" onclick="closeModal('destination-booking-modal')">√ó</button>
      </div>
      <div class="modal-body">
        <!-- Step 1: Service Type Selection -->
        <div id="dest-step-1" class="dest-wizard-step">
          <div class="form-section-title" style="margin-bottom:20px;">Select Service Type</div>
          <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(160px, 1fr));gap:16px;">
            <div class="dest-service-option" data-service="airport" onclick="selectDestServiceType('airport')" style="background:var(--bg-input);border:2px solid var(--border-subtle);border-radius:var(--radius-lg);padding:24px 16px;text-align:center;cursor:pointer;transition:all 0.2s;">
              <div style="font-size:48px;margin-bottom:12px;">‚úàÔ∏è</div>
              <div style="font-weight:600;font-size:1rem;margin-bottom:4px;">Airport Pickup/Drop-off</div>
              <div style="font-size:0.8rem;color:var(--text-muted);">We'll handle your car while you travel</div>
            </div>
            <div class="dest-service-option" data-service="dealership" onclick="selectDestServiceType('dealership')" style="background:var(--bg-input);border:2px solid var(--border-subtle);border-radius:var(--radius-lg);padding:24px 16px;text-align:center;cursor:pointer;transition:all 0.2s;">
              <div style="font-size:48px;margin-bottom:12px;">üè¢</div>
              <div style="font-weight:600;font-size:1rem;margin-bottom:4px;">Dealership Service Run</div>
              <div style="font-size:0.8rem;color:var(--text-muted);">We take your car for warranty/recall work</div>
            </div>
            <div class="dest-service-option" data-service="detailing" onclick="selectDestServiceType('detailing')" style="background:var(--bg-input);border:2px solid var(--border-subtle);border-radius:var(--radius-lg);padding:24px 16px;text-align:center;cursor:pointer;transition:all 0.2s;">
              <div style="font-size:48px;margin-bottom:12px;">‚ú®</div>
              <div style="font-weight:600;font-size:1rem;margin-bottom:4px;">Mobile Detail</div>
              <div style="font-size:0.8rem;color:var(--text-muted);">Premium detailing at your location</div>
            </div>
            <div class="dest-service-option" data-service="valet" onclick="selectDestServiceType('valet')" style="background:var(--bg-input);border:2px solid var(--border-subtle);border-radius:var(--radius-lg);padding:24px 16px;text-align:center;cursor:pointer;transition:all 0.2s;">
              <div style="font-size:48px;margin-bottom:12px;">üîë</div>
              <div style="font-weight:600;font-size:1rem;margin-bottom:4px;">Valet Service</div>
              <div style="font-size:0.8rem;color:var(--text-muted);">Event and venue valet coordination</div>
            </div>
          </div>
        </div>

        <!-- Step 2: Airport Form -->
        <div id="dest-step-airport" class="dest-wizard-step" style="display:none;">
          <button class="btn btn-ghost" onclick="goBackToServiceSelection()" style="margin-bottom:16px;">‚Üê Back to services</button>
          <div class="form-section-title" style="margin-bottom:20px;">‚úàÔ∏è Airport Parking Service</div>
          
          <div class="form-group">
            <label class="form-label">Vehicle *</label>
            <select class="form-select" id="dest-airport-vehicle" required>
              <option value="">Select a vehicle...</option>
            </select>
          </div>
          
          <div class="form-group">
            <label class="form-label">Trip Type *</label>
            <div style="display:grid;grid-template-columns:repeat(3, 1fr);gap:12px;">
              <label class="dest-trip-option" style="display:flex;flex-direction:column;align-items:center;padding:16px;background:var(--bg-input);border:2px solid var(--border-subtle);border-radius:var(--radius-md);cursor:pointer;transition:all 0.2s;">
                <input type="radio" name="dest-trip-type" value="departure" style="display:none;">
                <span style="font-size:24px;margin-bottom:8px;">üõ´</span>
                <span style="font-weight:500;">Departure</span>
                <span style="font-size:0.75rem;color:var(--text-muted);">Drop car at airport</span>
              </label>
              <label class="dest-trip-option" style="display:flex;flex-direction:column;align-items:center;padding:16px;background:var(--bg-input);border:2px solid var(--border-subtle);border-radius:var(--radius-md);cursor:pointer;transition:all 0.2s;">
                <input type="radio" name="dest-trip-type" value="arrival" style="display:none;">
                <span style="font-size:24px;margin-bottom:8px;">üõ¨</span>
                <span style="font-weight:500;">Arrival</span>
                <span style="font-size:0.75rem;color:var(--text-muted);">Pick up from airport</span>
              </label>
              <label class="dest-trip-option" style="display:flex;flex-direction:column;align-items:center;padding:16px;background:var(--bg-input);border:2px solid var(--border-subtle);border-radius:var(--radius-md);cursor:pointer;transition:all 0.2s;">
                <input type="radio" name="dest-trip-type" value="round_trip" style="display:none;">
                <span style="font-size:24px;margin-bottom:8px;">üîÑ</span>
                <span style="font-weight:500;">Round Trip</span>
                <span style="font-size:0.75rem;color:var(--text-muted);">Both ways</span>
              </label>
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Pickup Location *</label>
              <input type="text" class="form-input" id="dest-airport-pickup" placeholder="Home address">
            </div>
            <div class="form-group">
              <label class="form-label">Airport/Parking Location *</label>
              <input type="text" class="form-input" id="dest-airport-location" placeholder="e.g., EWR Terminal A">
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Airline</label>
              <input type="text" class="form-input" id="dest-airport-airline" placeholder="e.g., United, Delta">
            </div>
            <div class="form-group">
              <label class="form-label">Flight Number (optional)</label>
              <input type="text" class="form-input" id="dest-airport-flight" placeholder="e.g., UA123">
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Flight Date/Time *</label>
              <input type="datetime-local" class="form-input" id="dest-airport-datetime">
            </div>
            <div class="form-group" id="dest-airport-return-group">
              <label class="form-label">Return Date/Time</label>
              <input type="datetime-local" class="form-input" id="dest-airport-return">
            </div>
          </div>
          
          <div class="form-group">
            <label class="form-label">Parking Preference</label>
            <div style="display:grid;grid-template-columns:repeat(3, 1fr);gap:12px;">
              <label class="dest-parking-option" style="display:flex;flex-direction:column;align-items:center;padding:14px;background:var(--bg-input);border:2px solid var(--border-subtle);border-radius:var(--radius-md);cursor:pointer;transition:all 0.2s;">
                <input type="radio" name="dest-parking-pref" value="long_term" style="display:none;">
                <span style="font-size:20px;margin-bottom:6px;">üÖøÔ∏è</span>
                <span style="font-weight:500;font-size:0.9rem;">Long-Term</span>
                <span style="font-size:0.72rem;color:var(--text-muted);">Economy lot</span>
              </label>
              <label class="dest-parking-option" style="display:flex;flex-direction:column;align-items:center;padding:14px;background:var(--bg-input);border:2px solid var(--border-subtle);border-radius:var(--radius-md);cursor:pointer;transition:all 0.2s;">
                <input type="radio" name="dest-parking-pref" value="short_term" style="display:none;">
                <span style="font-size:20px;margin-bottom:6px;">üè¢</span>
                <span style="font-weight:500;font-size:0.9rem;">Short-Term</span>
                <span style="font-size:0.72rem;color:var(--text-muted);">Garage parking</span>
              </label>
              <label class="dest-parking-option" style="display:flex;flex-direction:column;align-items:center;padding:14px;background:var(--bg-input);border:2px solid var(--border-subtle);border-radius:var(--radius-md);cursor:pointer;transition:all 0.2s;">
                <input type="radio" name="dest-parking-pref" value="valet" style="display:none;">
                <span style="font-size:20px;margin-bottom:6px;">üé©</span>
                <span style="font-weight:500;font-size:0.9rem;">Valet</span>
                <span style="font-size:0.72rem;color:var(--text-muted);">Premium service</span>
              </label>
            </div>
          </div>
          
          <div class="form-group">
            <label class="form-label">Special Instructions</label>
            <textarea class="form-textarea" id="dest-airport-instructions" placeholder="Key handoff details, specific parking section, etc."></textarea>
          </div>
        </div>

        <!-- Step 2: Dealership Form -->
        <div id="dest-step-dealership" class="dest-wizard-step" style="display:none;">
          <button class="btn btn-ghost" onclick="goBackToServiceSelection()" style="margin-bottom:16px;">‚Üê Back to services</button>
          <div class="form-section-title" style="margin-bottom:20px;">üè¢ Dealership Service Run</div>
          
          <div class="form-group">
            <label class="form-label">Vehicle *</label>
            <select class="form-select" id="dest-dealer-vehicle" required>
              <option value="">Select a vehicle...</option>
            </select>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Pickup Location *</label>
              <input type="text" class="form-input" id="dest-dealer-pickup" placeholder="Home or work address">
            </div>
            <div class="form-group">
              <label class="form-label">Dealership Name *</label>
              <input type="text" class="form-input" id="dest-dealer-name" placeholder="e.g., BMW of Manhattan">
            </div>
          </div>
          
          <div class="form-group">
            <label class="form-label">Dealership Address *</label>
            <input type="text" class="form-input" id="dest-dealer-address" placeholder="Full dealership address">
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Service Type *</label>
              <select class="form-select" id="dest-dealer-service-type">
                <option value="">Select service type...</option>
                <option value="warranty">Warranty Work</option>
                <option value="recall">Recall Service</option>
                <option value="scheduled">Scheduled Maintenance</option>
                <option value="repair">Repair</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Appointment Date/Time *</label>
              <input type="datetime-local" class="form-input" id="dest-dealer-datetime">
            </div>
          </div>
          
          <div class="form-group">
            <label class="form-label">Special Instructions</label>
            <textarea class="form-textarea" id="dest-dealer-instructions" placeholder="Appointment confirmation number, service advisor name, etc."></textarea>
          </div>
        </div>

        <!-- Step 2: Mobile Detailing Form -->
        <div id="dest-step-detailing" class="dest-wizard-step" style="display:none;">
          <button class="btn btn-ghost" onclick="goBackToServiceSelection()" style="margin-bottom:16px;">‚Üê Back to services</button>
          <div class="form-section-title" style="margin-bottom:20px;">‚ú® Mobile Detailing</div>
          
          <div class="form-group">
            <label class="form-label">Vehicle *</label>
            <select class="form-select" id="dest-detail-vehicle" required>
              <option value="">Select a vehicle...</option>
            </select>
          </div>
          
          <div class="form-group">
            <label class="form-label">Service Location *</label>
            <input type="text" class="form-input" id="dest-detail-location" placeholder="Where is the car located?">
          </div>
          
          <div class="form-group">
            <label class="form-label">Service Level *</label>
            <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(140px, 1fr));gap:12px;">
              <label class="dest-detail-level" style="display:flex;flex-direction:column;align-items:center;padding:16px;background:var(--bg-input);border:2px solid var(--border-subtle);border-radius:var(--radius-md);cursor:pointer;transition:all 0.2s;">
                <input type="radio" name="dest-detail-level" value="basic" style="display:none;">
                <span style="font-size:20px;margin-bottom:6px;">üíß</span>
                <span style="font-weight:600;">Basic</span>
                <span style="font-size:0.75rem;color:var(--text-muted);">Exterior wash</span>
                <span style="font-size:0.85rem;color:var(--accent-gold);margin-top:4px;">$</span>
              </label>
              <label class="dest-detail-level" style="display:flex;flex-direction:column;align-items:center;padding:16px;background:var(--bg-input);border:2px solid var(--border-subtle);border-radius:var(--radius-md);cursor:pointer;transition:all 0.2s;">
                <input type="radio" name="dest-detail-level" value="standard" style="display:none;">
                <span style="font-size:20px;margin-bottom:6px;">üöø</span>
                <span style="font-weight:600;">Standard</span>
                <span style="font-size:0.75rem;color:var(--text-muted);">Interior + exterior</span>
                <span style="font-size:0.85rem;color:var(--accent-gold);margin-top:4px;">$$</span>
              </label>
              <label class="dest-detail-level" style="display:flex;flex-direction:column;align-items:center;padding:16px;background:var(--bg-input);border:2px solid var(--border-subtle);border-radius:var(--radius-md);cursor:pointer;transition:all 0.2s;">
                <input type="radio" name="dest-detail-level" value="premium" style="display:none;">
                <span style="font-size:20px;margin-bottom:6px;">‚ú®</span>
                <span style="font-weight:600;">Premium</span>
                <span style="font-size:0.75rem;color:var(--text-muted);">Full detail + wax</span>
                <span style="font-size:0.85rem;color:var(--accent-gold);margin-top:4px;">$$$</span>
              </label>
              <label class="dest-detail-level" style="display:flex;flex-direction:column;align-items:center;padding:16px;background:var(--bg-input);border:2px solid var(--border-subtle);border-radius:var(--radius-md);cursor:pointer;transition:all 0.2s;">
                <input type="radio" name="dest-detail-level" value="full" style="display:none;">
                <span style="font-size:20px;margin-bottom:6px;">üèÜ</span>
                <span style="font-weight:600;">Full Detail</span>
                <span style="font-size:0.75rem;color:var(--text-muted);">Complete restoration</span>
                <span style="font-size:0.85rem;color:var(--accent-gold);margin-top:4px;">$$$$</span>
              </label>
            </div>
          </div>
          
          <div class="form-group">
            <label class="form-label">Preferred Date/Time *</label>
            <input type="datetime-local" class="form-input" id="dest-detail-datetime">
          </div>
          
          <div class="form-group">
            <label class="form-label">Special Instructions</label>
            <textarea class="form-textarea" id="dest-detail-instructions" placeholder="Specific areas of concern, access instructions, etc."></textarea>
          </div>
        </div>

        <!-- Step 2: Valet Form -->
        <div id="dest-step-valet" class="dest-wizard-step" style="display:none;">
          <button class="btn btn-ghost" onclick="goBackToServiceSelection()" style="margin-bottom:16px;">‚Üê Back to services</button>
          <div class="form-section-title" style="margin-bottom:20px;">üîë Valet Service</div>
          
          <div class="form-group">
            <label class="form-label">Vehicle *</label>
            <select class="form-select" id="dest-valet-vehicle" required>
              <option value="">Select a vehicle...</option>
            </select>
          </div>
          
          <div class="form-group">
            <label class="form-label">Pickup Location *</label>
            <input type="text" class="form-input" id="dest-valet-pickup" placeholder="Where to pick up the vehicle">
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Event Name *</label>
              <input type="text" class="form-input" id="dest-valet-event" placeholder="e.g., Wedding, Gala, Party">
            </div>
            <div class="form-group">
              <label class="form-label">Event Venue *</label>
              <input type="text" class="form-input" id="dest-valet-venue" placeholder="Venue name and address">
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Event Date/Time *</label>
              <input type="datetime-local" class="form-input" id="dest-valet-datetime">
            </div>
            <div class="form-group">
              <label class="form-label">Expected Duration</label>
              <select class="form-select" id="dest-valet-duration">
                <option value="2">2 hours</option>
                <option value="3">3 hours</option>
                <option value="4" selected>4 hours</option>
                <option value="5">5 hours</option>
                <option value="6">6 hours</option>
                <option value="8">8 hours</option>
                <option value="12">12 hours</option>
              </select>
            </div>
          </div>
          
          <div class="form-group">
            <label class="form-label">Special Instructions</label>
            <textarea class="form-textarea" id="dest-valet-instructions" placeholder="Parking preferences, timing details, contact person, etc."></textarea>
          </div>
        </div>
      </div>
      <div class="modal-footer" id="dest-modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('destination-booking-modal')">Cancel</button>
        <button class="btn btn-primary" id="dest-submit-btn" onclick="submitDestinationService()" style="display:none;">Book Service</button>
      </div>
    </div>
  </div>

  <!-- Destination Service Detail Modal -->
  <div class="modal-backdrop" id="destination-detail-modal">
    <div class="modal wide">
      <div class="modal-header">
        <h3 class="modal-title" id="dest-detail-title">Service Details</h3>
        <button class="modal-close" onclick="closeModal('destination-detail-modal')">√ó</button>
      </div>
      <div class="modal-body" id="dest-detail-body">
        <!-- Populated by JS -->
      </div>
    </div>
  </div>

  <!-- Add Vehicle Modal -->
  <div class="modal-backdrop" id="vehicle-modal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Add Vehicle to Garage</h3>
        <button class="modal-close" onclick="closeModal('vehicle-modal')">√ó</button>
      </div>
      <div class="modal-body">
        <div class="form-section">
          <div class="form-section-title">Vehicle Photo</div>
          <div id="vehicle-photo-upload-area" class="vehicle-photo-upload-container" onclick="document.getElementById('vehicle-photo-input').click()" style="position:relative;height:200px;background:linear-gradient(135deg, var(--bg-elevated), var(--bg-input));border:2px dashed var(--border-subtle);border-radius:var(--radius-lg);display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;transition:all 0.2s ease;overflow:hidden;">
            <input type="file" id="vehicle-photo-input" accept="image/*" style="display:none;" onchange="handleVehiclePhotoSelect(event)">
            <div id="vehicle-photo-placeholder" style="text-align:center;">
              <div style="font-size:48px;margin-bottom:12px;opacity:0.7;">üì∑</div>
              <div style="font-weight:500;color:var(--text-primary);margin-bottom:4px;">Add a photo of your vehicle</div>
              <div style="font-size:0.8rem;color:var(--text-muted);">Click to upload ‚Ä¢ Max 5MB</div>
            </div>
            <img id="vehicle-photo-preview" src="" alt="Vehicle Preview" style="display:none;width:100%;height:100%;object-fit:cover;">
            <button type="button" id="vehicle-photo-remove" onclick="event.stopPropagation();removeVehiclePhoto();" style="display:none;position:absolute;top:12px;right:12px;width:32px;height:32px;background:rgba(0,0,0,0.7);border:none;border-radius:50%;color:white;cursor:pointer;font-size:16px;">√ó</button>
          </div>
          <p style="font-size:0.78rem;color:var(--text-muted);margin-top:8px;text-align:center;">Show off your car like on Turo! A great photo helps providers identify your vehicle.</p>
        </div>
        
        <div class="form-section">
          <div class="form-section-title">Vehicle Information</div>
          <div class="form-row three">
            <div class="form-group">
              <label class="form-label">Year *</label>
              <select class="form-select" id="v-year" onchange="updateMakeOptions()">
                <option value="">Select Year</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Make *</label>
              <select class="form-select" id="v-make" onchange="updateModelOptions()" disabled>
                <option value="">Select Make</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Model *</label>
              <select class="form-select" id="v-model" onchange="updateTrimOptions()" disabled>
                <option value="">Select Model</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Trim</label>
              <select class="form-select" id="v-trim" disabled>
                <option value="">Select Trim (Optional)</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Color</label>
              <select class="form-select" id="v-color">
                <option value="">Select Color (Optional)</option>
                <option value="Black">Black</option>
                <option value="White">White</option>
                <option value="Silver">Silver</option>
                <option value="Gray">Gray</option>
                <option value="Red">Red</option>
                <option value="Blue">Blue</option>
                <option value="Navy">Navy</option>
                <option value="Green">Green</option>
                <option value="Brown">Brown</option>
                <option value="Tan">Tan</option>
                <option value="Beige">Beige</option>
                <option value="Gold">Gold</option>
                <option value="Orange">Orange</option>
                <option value="Yellow">Yellow</option>
                <option value="Purple">Purple</option>
                <option value="Burgundy">Burgundy</option>
                <option value="Champagne">Champagne</option>
                <option value="Pearl White">Pearl White</option>
                <option value="Metallic Silver">Metallic Silver</option>
                <option value="Other">Other</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Nickname (Optional)</label>
              <input type="text" class="form-input" id="v-nickname" placeholder="My daily driver">
            </div>
            <div class="form-group">
              <label class="form-label">Current Mileage</label>
              <input type="number" class="form-input" id="v-mileage" placeholder="45000">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group" style="flex: 1;">
              <label class="form-label">VIN (Optional but Recommended)</label>
              <input type="text" class="form-input" id="v-vin" placeholder="17-character Vehicle Identification Number" maxlength="17" style="text-transform: uppercase;">
              <small style="color: var(--text-muted); font-size: 12px; margin-top: 4px; display: block;">Helps providers find exact parts for your vehicle</small>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('vehicle-modal')">Cancel</button>
        <button class="btn btn-primary" onclick="saveVehicle()">Add Vehicle</button>
      </div>
    </div>
  </div>

  <!-- Edit Vehicle Modal -->
  <div class="modal-backdrop" id="edit-vehicle-modal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Edit Vehicle</h3>
        <button class="modal-close" onclick="closeModal('edit-vehicle-modal')">√ó</button>
      </div>
      <div class="modal-body">
        <div class="form-section">
          <div class="form-section-title">Vehicle Photo</div>
          <div id="edit-vehicle-photo-upload-area" class="vehicle-photo-upload-container" onclick="document.getElementById('edit-vehicle-photo-input').click()" style="position:relative;height:200px;background:linear-gradient(135deg, var(--bg-elevated), var(--bg-input));border:2px dashed var(--border-subtle);border-radius:var(--radius-lg);display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;transition:all 0.2s ease;overflow:hidden;">
            <input type="file" id="edit-vehicle-photo-input" accept="image/*" style="display:none;" onchange="handleEditVehiclePhotoSelect(event)">
            <div id="edit-vehicle-photo-placeholder" style="text-align:center;">
              <div style="font-size:48px;margin-bottom:12px;opacity:0.7;">üì∑</div>
              <div style="font-weight:500;color:var(--text-primary);margin-bottom:4px;">Add a photo of your vehicle</div>
              <div style="font-size:0.8rem;color:var(--text-muted);">Click to upload ‚Ä¢ Max 5MB</div>
            </div>
            <img id="edit-vehicle-photo-preview" src="" alt="Vehicle Preview" style="display:none;width:100%;height:100%;object-fit:cover;">
            <button type="button" id="edit-vehicle-photo-remove" onclick="event.stopPropagation();removeEditVehiclePhoto();" style="display:none;position:absolute;top:12px;right:12px;width:32px;height:32px;background:rgba(0,0,0,0.7);border:none;border-radius:50%;color:white;cursor:pointer;font-size:16px;">√ó</button>
          </div>
          <p style="font-size:0.78rem;color:var(--text-muted);margin-top:8px;text-align:center;">Show off your car like on Turo! A great photo helps providers identify your vehicle.</p>
        </div>
        
        <div class="form-section">
          <div class="form-section-title">Vehicle Information</div>
          <div class="form-row three">
            <div class="form-group">
              <label class="form-label">Year *</label>
              <select class="form-select" id="edit-v-year" onchange="updateEditMakeOptions()">
                <option value="">Select Year</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Make *</label>
              <select class="form-select" id="edit-v-make" onchange="updateEditModelOptions()">
                <option value="">Select Make</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Model *</label>
              <select class="form-select" id="edit-v-model" onchange="updateEditTrimOptions()">
                <option value="">Select Model</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Trim</label>
              <select class="form-select" id="edit-v-trim">
                <option value="">Select Trim (Optional)</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Color</label>
              <select class="form-select" id="edit-v-color">
                <option value="">Select Color (Optional)</option>
                <option value="Black">Black</option>
                <option value="White">White</option>
                <option value="Silver">Silver</option>
                <option value="Gray">Gray</option>
                <option value="Red">Red</option>
                <option value="Blue">Blue</option>
                <option value="Navy">Navy</option>
                <option value="Green">Green</option>
                <option value="Brown">Brown</option>
                <option value="Tan">Tan</option>
                <option value="Beige">Beige</option>
                <option value="Gold">Gold</option>
                <option value="Orange">Orange</option>
                <option value="Yellow">Yellow</option>
                <option value="Purple">Purple</option>
                <option value="Burgundy">Burgundy</option>
                <option value="Champagne">Champagne</option>
                <option value="Pearl White">Pearl White</option>
                <option value="Metallic Silver">Metallic Silver</option>
                <option value="Other">Other</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Nickname (Optional)</label>
              <input type="text" class="form-input" id="edit-v-nickname" placeholder="My daily driver">
            </div>
            <div class="form-group">
              <label class="form-label">Current Mileage</label>
              <input type="number" class="form-input" id="edit-v-mileage" placeholder="45000">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group" style="flex: 1;">
              <label class="form-label">VIN (Optional but Recommended)</label>
              <input type="text" class="form-input" id="edit-v-vin" placeholder="17-character Vehicle Identification Number" maxlength="17" style="text-transform: uppercase;">
              <small style="color: var(--text-muted); font-size: 12px; margin-top: 4px; display: block;">Helps providers find exact parts for your vehicle</small>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('edit-vehicle-modal')">Cancel</button>
        <button class="btn btn-primary" onclick="saveEditVehicle()">Save Changes</button>
      </div>
    </div>
  </div>

  <!-- New Maintenance Package Modal -->
  <div class="modal-backdrop" id="package-modal">
    <div class="modal wide">
      <div class="modal-header">
        <h3 class="modal-title">Create Maintenance Package</h3>
        <button class="modal-close" onclick="closeModal('package-modal')">√ó</button>
      </div>
      <div class="modal-body">
        <div class="form-section">
          <div class="form-section-title">What do you need?</div>
          <div class="form-group">
            <label class="form-label">Vehicle *</label>
            <select class="form-select" id="p-vehicle" required>
              <option value="">Select a vehicle...</option>
            </select>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Category *</label>
              <select class="form-select" id="p-category" required>
                <option value="maintenance">Maintenance & Mechanical</option>
                <option value="manufacturer_service">Manufacturer Service Packages</option>
                <option value="detailing">Detailing & Cleaning</option>
                <option value="cosmetic">Cosmetic & Body</option>
                <option value="accident_repair">Accident / Insurance Repair</option>
                <option value="other">Other</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Service Type</label>
              <select class="form-select" id="p-service-type">
                <option value="">Select service...</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Title / Summary *</label>
            <input type="text" class="form-input" id="p-title" placeholder="e.g., Full detail + ceramic coating" required>
          </div>
          <div class="form-group">
            <label class="form-label">Description</label>
            <textarea class="form-textarea" id="p-description" placeholder="Describe what you need, any specific concerns, symptoms, etc."></textarea>
          </div>
        </div>

        <div class="form-section">
          <div class="form-section-title">Frequency & Schedule</div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Frequency</label>
              <select class="form-select" id="p-frequency">
                <option value="one_time">One-time service</option>
                <option value="weekly">Weekly</option>
                <option value="bi_weekly">Every 2 weeks</option>
                <option value="monthly">Monthly</option>
                <option value="quarterly">Quarterly</option>
                <option value="annually">Annually</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Preferred Schedule</label>
              <input type="text" class="form-input" id="p-schedule" placeholder="e.g., Weekdays after 5pm, Saturday morning">
            </div>
          </div>
        </div>

        <div class="form-section">
          <div class="form-section-title">Parts Preference</div>
          <div class="parts-tiers" id="parts-tiers">
            <div class="parts-tier" data-tier="economy">
              <div class="parts-tier-name">üí∞ Economy</div>
              <div class="parts-tier-desc">Budget-friendly, gets the job done</div>
            </div>
            <div class="parts-tier selected" data-tier="standard">
              <div class="parts-tier-name">‚öôÔ∏è Standard (OEM)</div>
              <div class="parts-tier-desc">Original equipment quality</div>
            </div>
            <div class="parts-tier" data-tier="premium">
              <div class="parts-tier-name">‚≠ê Premium</div>
              <div class="parts-tier-desc">High-performance, extended warranty</div>
            </div>
          </div>
        </div>

        <div class="form-section">
          <div class="form-section-title">Logistics</div>
          <div class="form-group">
            <label class="form-label">How should the vehicle get to the shop?</label>
            <select class="form-select" id="p-pickup">
              <option value="either">Flexible - any option works</option>
              <option value="provider_pickup">Provider picks up from my location</option>
              <option value="member_dropoff">I'll drop it off</option>
              <option value="rideshare">I'll drive there, need ride home (Uber/Lyft)</option>
            </select>
          </div>
        </div>

        <div class="form-section">
          <div class="form-section-title">Bidding Window</div>
          <p class="form-hint" style="margin-bottom:16px;">How long should providers have to submit bids? After this window closes, no new bids can be submitted.</p>
          <div class="bidding-window-options" id="bidding-window-options">
            <div class="bid-window-option" data-hours="24">
              <div class="bid-window-time">24 hours</div>
              <div class="bid-window-desc">Quick turnaround</div>
            </div>
            <div class="bid-window-option" data-hours="48">
              <div class="bid-window-time">2 days</div>
              <div class="bid-window-desc">Standard</div>
            </div>
            <div class="bid-window-option selected" data-hours="72">
              <div class="bid-window-time">3 days</div>
              <div class="bid-window-desc">Recommended</div>
            </div>
            <div class="bid-window-option" data-hours="120">
              <div class="bid-window-time">5 days</div>
              <div class="bid-window-desc">More options</div>
            </div>
            <div class="bid-window-option" data-hours="168">
              <div class="bid-window-time">7 days</div>
              <div class="bid-window-desc">Maximum reach</div>
            </div>
          </div>
        </div>

        <div class="form-section" id="insurance-section" style="display: none;">
          <div class="form-section-title">Insurance Information</div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Insurance Carrier</label>
              <input type="text" class="form-input" id="p-insurance-carrier" placeholder="State Farm, GEICO, etc.">
            </div>
            <div class="form-group">
              <label class="form-label">Claim Number</label>
              <input type="text" class="form-input" id="p-claim-number" placeholder="Claim #">
            </div>
          </div>
        </div>

        <div class="form-section">
          <div class="form-section-title">üì∑ Photos (Optional)</div>
          <p class="form-hint" style="margin-bottom:12px;">Add photos to help providers understand the issue and provide accurate quotes.</p>
          <div class="photo-upload-area" onclick="document.getElementById('package-photo-input').click()" style="border:2px dashed var(--border-subtle);border-radius:var(--radius-md);padding:24px;text-align:center;cursor:pointer;transition:all 0.2s;">
            <div style="font-size:32px;margin-bottom:8px;">üì∏</div>
            <div style="font-weight:500;color:var(--text-primary);">Click to upload photos</div>
            <div style="font-size:0.85rem;color:var(--text-muted);margin-top:4px;">JPG, PNG up to 5MB each ‚Ä¢ Max 5 photos</div>
          </div>
          <input type="file" id="package-photo-input" accept="image/*" multiple style="display:none;" onchange="handlePackagePhotoSelect(event)">
          <div id="package-photo-preview" style="display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-top:12px;"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('package-modal')">Cancel</button>
        <button class="btn btn-primary" onclick="savePackage()">Create Package</button>
      </div>
    </div>
  </div>

  <!-- View Package Modal (with bids) -->
  <div class="modal-backdrop" id="view-package-modal">
    <div class="modal wide">
      <div class="modal-header">
        <h3 class="modal-title" id="view-package-title">Package Details</h3>
        <button class="modal-close" onclick="closeModal('view-package-modal')">√ó</button>
      </div>
      <div class="modal-body" id="view-package-body">
        <!-- Populated by JS -->
      </div>
    </div>
  </div>

  <!-- Repost Package Modal -->
  <div class="modal-backdrop" id="repost-modal">
    <div class="modal" style="max-width:480px;">
      <div class="modal-header">
        <h3 class="modal-title">Repost Package</h3>
        <button class="modal-close" onclick="closeModal('repost-modal')">√ó</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="repost-package-id">
        <p style="margin-bottom:8px;color:var(--text-secondary);">Reposting:</p>
        <p id="repost-package-title" style="font-weight:600;font-size:1.1rem;margin-bottom:20px;"></p>
        
        <p style="margin-bottom:12px;">How long should providers have to bid?</p>
        <div class="repost-window-options" style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;">
          <div class="repost-window-option bid-window-option" data-hours="24" onclick="selectRepostWindow(this)">
            <div class="bid-window-time">24 hours</div>
            <div class="bid-window-desc">Quick</div>
          </div>
          <div class="repost-window-option bid-window-option" data-hours="48" onclick="selectRepostWindow(this)">
            <div class="bid-window-time">2 days</div>
            <div class="bid-window-desc">Standard</div>
          </div>
          <div class="repost-window-option bid-window-option selected" data-hours="72" onclick="selectRepostWindow(this)">
            <div class="bid-window-time">3 days</div>
            <div class="bid-window-desc">Recommended</div>
          </div>
          <div class="repost-window-option bid-window-option" data-hours="120" onclick="selectRepostWindow(this)">
            <div class="bid-window-time">5 days</div>
            <div class="bid-window-desc">More bids</div>
          </div>
          <div class="repost-window-option bid-window-option" data-hours="168" onclick="selectRepostWindow(this)">
            <div class="bid-window-time">7 days</div>
            <div class="bid-window-desc">Maximum</div>
          </div>
        </div>

        <div class="alert" style="background:var(--accent-blue-soft);border:1px solid rgba(74,124,255,0.3);color:var(--accent-blue);margin-top:20px;padding:14px;border-radius:var(--radius-md);font-size:0.88rem;">
          üí° Previous bids will be cleared. Providers can submit new bids during the new window.
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('repost-modal')">Cancel</button>
        <button class="btn btn-primary" onclick="confirmRepost()">üîÑ Repost Package</button>
      </div>
    </div>
  </div>

  <!-- Extend Deadline Modal -->
  <div class="modal-backdrop" id="extend-modal">
    <div class="modal" style="max-width:480px;">
      <div class="modal-header">
        <h3 class="modal-title">‚è±Ô∏è Extend Bidding Window</h3>
        <button class="modal-close" onclick="closeModal('extend-modal')">√ó</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="extend-package-id">
        <p style="margin-bottom:8px;color:var(--text-secondary);">Package:</p>
        <p id="extend-package-title" style="font-weight:600;font-size:1.1rem;margin-bottom:12px;"></p>
        <p id="extend-current-deadline" style="font-size:0.9rem;color:var(--text-muted);margin-bottom:20px;"></p>
        
        <p style="margin-bottom:12px;">Add more time for providers to bid:</p>
        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;">
          <div class="extend-option bid-window-option" data-hours="12" onclick="selectExtendTime(this)">
            <div class="bid-window-time">+12h</div>
          </div>
          <div class="extend-option bid-window-option selected" data-hours="24" onclick="selectExtendTime(this)">
            <div class="bid-window-time">+24h</div>
          </div>
          <div class="extend-option bid-window-option" data-hours="48" onclick="selectExtendTime(this)">
            <div class="bid-window-time">+2 days</div>
          </div>
          <div class="extend-option bid-window-option" data-hours="72" onclick="selectExtendTime(this)">
            <div class="bid-window-time">+3 days</div>
          </div>
        </div>

        <div id="extend-new-deadline" style="margin-top:16px;padding:12px;background:var(--accent-blue-soft);border-radius:var(--radius-md);border:1px solid rgba(74,124,255,0.3);">
          <span style="color:var(--accent-blue);font-size:0.9rem;">New deadline: <strong id="extend-new-time"></strong></span>
        </div>

        <div class="alert" style="background:var(--bg-input);border:1px solid var(--border-subtle);color:var(--text-secondary);margin-top:16px;padding:14px;border-radius:var(--radius-md);font-size:0.88rem;">
          üí° Existing bids will be preserved. Providers who already bid won't be notified.
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('extend-modal')">Cancel</button>
        <button class="btn btn-primary" onclick="confirmExtend()">‚è±Ô∏è Extend Deadline</button>
      </div>
    </div>
  </div>

  <!-- Message Modal -->
  <div class="modal-backdrop" id="message-modal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title" id="message-modal-title">Message Provider</h3>
        <button class="modal-close" onclick="closeModal('message-modal')">√ó</button>
      </div>
      <div class="modal-body">
        <div class="messages-container" id="message-thread">
          <!-- Messages populated by JS -->
        </div>
        <div class="message-input-row">
          <input type="text" class="form-input" id="message-input" placeholder="Type your message...">
          <button class="btn btn-primary" onclick="sendMessage()">Send</button>
        </div>
        <div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--border-subtle);">
          <button class="btn btn-ghost" onclick="openReportModal()" style="font-size:0.85rem;color:var(--text-muted);">
            üö© Report policy violation
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Report Circumvention Modal -->
  <div class="modal-backdrop" id="report-modal">
    <div class="modal" style="max-width:520px;">
      <div class="modal-header">
        <h3 class="modal-title">üö© Report Policy Violation</h3>
        <button class="modal-close" onclick="closeModal('report-modal')">√ó</button>
      </div>
      <div class="modal-body">
        <div style="background:var(--accent-gold-soft);border:1px solid rgba(212,168,85,0.3);border-radius:var(--radius-md);padding:16px;margin-bottom:20px;">
          <h4 style="margin-bottom:8px;color:var(--accent-gold);">üí∞ Earn a Reward</h4>
          <p style="font-size:0.9rem;color:var(--text-secondary);line-height:1.6;">
            If a provider is trying to take your business outside of My Car Concierge, let us know! 
            Verified reports may qualify for a <strong>reward of up to 25%</strong> of any damages recovered.
          </p>
        </div>

        <div class="form-group">
          <label class="form-label">What happened? <span class="required">*</span></label>
          <select class="form-input" id="report-type" style="cursor:pointer;">
            <option value="">Select violation type...</option>
            <option value="contact_info">Provider shared their contact information</option>
            <option value="solicitation">Provider asked me to contact them directly</option>
            <option value="payment_outside">Provider requested payment outside MCC</option>
            <option value="discount_offer">Provider offered discount to bypass MCC</option>
            <option value="business_card">Provider gave me a business card or flyer</option>
            <option value="other">Other policy violation</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">Describe what happened <span class="required">*</span></label>
          <textarea class="form-textarea" id="report-description" placeholder="Please provide details about the violation. Include any specific language the provider used, when it happened, etc." style="min-height:100px;"></textarea>
        </div>

        <div class="form-group">
          <label class="form-label">Evidence (optional but helps your case)</label>
          <p style="font-size:0.85rem;color:var(--text-muted);margin-bottom:8px;">Upload screenshots of messages, photos of business cards, etc.</p>
          <label class="file-upload" style="padding:20px;cursor:pointer;">
            <div style="text-align:center;">
              <div style="font-size:24px;margin-bottom:8px;">üìé</div>
              <div style="font-size:0.9rem;">Click to upload evidence</div>
            </div>
            <input type="file" id="report-evidence" accept="image/*,.pdf" multiple style="display:none;" onchange="handleReportEvidence(this)">
          </label>
          <div id="report-evidence-list" style="margin-top:8px;"></div>
        </div>

        <label class="checkbox-item" style="width:100%;margin-top:16px;">
          <input type="checkbox" id="report-truthful">
          <span>I confirm this report is truthful and accurate to the best of my knowledge</span>
        </label>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('report-modal')">Cancel</button>
        <button class="btn btn-primary" onclick="submitReport()">Submit Report</button>
      </div>
    </div>
  </div>

  <!-- Vehicle Details Modal -->
  <div class="modal-backdrop" id="vehicle-details-modal">
    <div class="modal wide">
      <div class="modal-header">
        <h3 class="modal-title" id="vehicle-details-title">Vehicle Details</h3>
        <button class="modal-close" onclick="closeModal('vehicle-details-modal')">√ó</button>
      </div>
      <div class="modal-body" id="vehicle-details-body">
        <!-- Populated by JS -->
      </div>
    </div>
  </div>

  <!-- Dispute Modal -->
  <div class="modal-backdrop" id="dispute-modal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Open a Dispute</h3>
        <button class="modal-close" onclick="closeModal('dispute-modal')">√ó</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="dispute-package-id">
        
        <div class="alert" style="background:var(--accent-orange-soft);border:1px solid rgba(245,158,11,0.3);color:var(--accent-orange);margin-bottom:20px;">
          ‚ö†Ô∏è Opening a dispute will put the payment on hold while our team reviews the issue.
        </div>

        <div class="form-group">
          <label class="form-label">Reason for Dispute</label>
          <select class="form-select" id="dispute-reason">
            <option value="">Select a reason...</option>
            <option value="work_not_started">Work was never started</option>
            <option value="work_incomplete">Work is incomplete</option>
            <option value="poor_quality">Poor quality work</option>
            <option value="overcharged">Overcharged / unexpected fees</option>
            <option value="damage_caused">Provider caused damage to vehicle</option>
            <option value="no_show">Provider no-show</option>
            <option value="other">Other issue</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">Describe the Issue</label>
          <textarea class="form-textarea" id="dispute-description" placeholder="Please describe what happened in detail. Include any relevant dates, communications, and specifics about the problem."></textarea>
        </div>

        <div class="form-group">
          <label class="form-label">Upload Evidence (optional)</label>
          <div style="border:2px dashed var(--border-subtle);border-radius:var(--radius-md);padding:20px;text-align:center;cursor:pointer;">
            <div style="font-size:24px;margin-bottom:8px;">üì∏</div>
            <div style="color:var(--text-secondary);font-size:0.9rem;">Click to upload photos or videos</div>
            <input type="file" id="dispute-evidence" multiple accept="image/*,video/*" style="display:none;">
          </div>
          <div class="form-hint">Photos of damage, incomplete work, or other evidence will help us resolve your dispute faster.</div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('dispute-modal')">Cancel</button>
        <button class="btn btn-danger" onclick="submitDispute()">Submit Dispute</button>
      </div>
    </div>
  </div>

  <!-- Support Ticket Modal -->
  <div class="modal-backdrop" id="support-modal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Contact Support</h3>
        <button class="modal-close" onclick="closeModal('support-modal')">√ó</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Category</label>
          <select class="form-select" id="support-category">
            <option value="account">Account Issue</option>
            <option value="payment">Payment / Billing</option>
            <option value="technical">Technical Problem</option>
            <option value="feedback">Feedback / Suggestion</option>
            <option value="other">Other</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">Subject</label>
          <input type="text" class="form-input" id="support-subject" placeholder="Brief description of your issue">
        </div>

        <div class="form-group">
          <label class="form-label">Message</label>
          <textarea class="form-textarea" id="support-message" placeholder="Describe your issue or question in detail..."></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('support-modal')">Cancel</button>
        <button class="btn btn-primary" onclick="submitSupportTicket()">Submit</button>
      </div>
    </div>
  </div>

  <!-- Schedule Appointment Modal -->
  <div class="modal-backdrop" id="schedule-modal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">üìÖ Schedule Service Appointment</h3>
        <button class="modal-close" onclick="closeModal('schedule-modal')">√ó</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="schedule-package-id">
        <input type="hidden" id="schedule-member-id">
        <input type="hidden" id="schedule-provider-id">
        
        <div class="form-group">
          <label class="form-label">Preferred Date *</label>
          <input type="date" class="form-input" id="schedule-date" min="">
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Start Time</label>
            <input type="time" class="form-input" id="schedule-time-start" value="09:00">
          </div>
          <div class="form-group">
            <label class="form-label">End Time (optional)</label>
            <input type="time" class="form-input" id="schedule-time-end" value="17:00">
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Estimated Duration (days)</label>
          <select class="form-select" id="schedule-duration">
            <option value="">Not sure</option>
            <option value="1">Same day</option>
            <option value="2">1-2 days</option>
            <option value="3">2-3 days</option>
            <option value="5">Up to a week</option>
            <option value="7">More than a week</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">Notes for Provider</label>
          <textarea class="form-textarea" id="schedule-notes" placeholder="Any special instructions, preferred drop-off time, etc."></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('schedule-modal')">Cancel</button>
        <button class="btn btn-primary" onclick="submitScheduleProposal()">Send Proposal</button>
      </div>
    </div>
  </div>

  <!-- Counter Proposal Modal -->
  <div class="modal-backdrop" id="counter-proposal-modal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">üìÖ Propose Different Time</h3>
        <button class="modal-close" onclick="closeModal('counter-proposal-modal')">√ó</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="counter-appointment-id">
        <input type="hidden" id="counter-package-id">
        
        <div style="background:var(--bg-input);padding:16px;border-radius:var(--radius-md);margin-bottom:20px;">
          <div style="font-size:0.85rem;color:var(--text-muted);margin-bottom:4px;">Originally proposed:</div>
          <div id="counter-original-time" style="font-weight:500;"></div>
        </div>
        
        <div class="form-group">
          <label class="form-label">New Preferred Date *</label>
          <input type="date" class="form-input" id="counter-date" min="">
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label">New Start Time</label>
            <input type="time" class="form-input" id="counter-time-start" value="09:00">
          </div>
          <div class="form-group">
            <label class="form-label">New End Time (optional)</label>
            <input type="time" class="form-input" id="counter-time-end" value="17:00">
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Reason for Change</label>
          <textarea class="form-textarea" id="counter-notes" placeholder="Why does this time work better for you?"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('counter-proposal-modal')">Cancel</button>
        <button class="btn btn-primary" onclick="submitCounterProposal()">Send Counter Proposal</button>
      </div>
    </div>
  </div>

  <!-- Transfer Setup Modal -->
  <div class="modal-backdrop" id="transfer-modal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">üöó Setup Vehicle Transfer</h3>
        <button class="modal-close" onclick="closeModal('transfer-modal')">√ó</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="transfer-package-id">
        <input type="hidden" id="transfer-member-id">
        <input type="hidden" id="transfer-provider-id">
        <input type="hidden" id="selected-transfer-type" value="">
        
        <div class="form-group">
          <label class="form-label">Transfer Method *</label>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
            <div class="transfer-type-option" onclick="selectTransferType('member_dropoff')" data-transfer-type="member_dropoff" style="background:var(--bg-input);border:2px solid var(--border-subtle);border-radius:var(--radius-md);padding:16px;cursor:pointer;text-align:center;transition:all 0.15s;">
              <div style="font-size:24px;margin-bottom:8px;">üöô</div>
              <div style="font-weight:600;margin-bottom:4px;">Drop-off</div>
              <div style="font-size:0.8rem;color:var(--text-muted);">I'll bring my car to the shop</div>
            </div>
            <div class="transfer-type-option" onclick="selectTransferType('provider_pickup')" data-transfer-type="provider_pickup" style="background:var(--bg-input);border:2px solid var(--border-subtle);border-radius:var(--radius-md);padding:16px;cursor:pointer;text-align:center;transition:all 0.15s;">
              <div style="font-size:24px;margin-bottom:8px;">üè†</div>
              <div style="font-weight:600;margin-bottom:4px;">Pickup</div>
              <div style="font-size:0.8rem;color:var(--text-muted);">Provider picks up from me</div>
            </div>
            <div class="transfer-type-option" onclick="selectTransferType('mobile_service')" data-transfer-type="mobile_service" style="background:var(--bg-input);border:2px solid var(--border-subtle);border-radius:var(--radius-md);padding:16px;cursor:pointer;text-align:center;transition:all 0.15s;">
              <div style="font-size:24px;margin-bottom:8px;">üîß</div>
              <div style="font-weight:600;margin-bottom:4px;">Mobile Service</div>
              <div style="font-size:0.8rem;color:var(--text-muted);">Work done at my location</div>
            </div>
            <div class="transfer-type-option" onclick="selectTransferType('towing')" data-transfer-type="towing" style="background:var(--bg-input);border:2px solid var(--border-subtle);border-radius:var(--radius-md);padding:16px;cursor:pointer;text-align:center;transition:all 0.15s;">
              <div style="font-size:24px;margin-bottom:8px;">üöõ</div>
              <div style="font-weight:600;margin-bottom:4px;">Towing</div>
              <div style="font-size:0.8rem;color:var(--text-muted);">Vehicle needs to be towed</div>
            </div>
          </div>
        </div>

        <div id="transfer-address-section" style="display:none;">
          <div class="form-group">
            <label class="form-label">Pickup Address *</label>
            <input type="text" class="form-input" id="transfer-pickup-address" placeholder="Street address for pickup">
          </div>
          <div class="form-group">
            <label class="form-label">Pickup Notes</label>
            <input type="text" class="form-input" id="transfer-pickup-notes" placeholder="Gate code, parking spot, etc.">
          </div>
          <div class="form-group">
            <label class="form-label">Return Address (if different)</label>
            <input type="text" class="form-input" id="transfer-return-address" placeholder="Leave empty if same as pickup">
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Special Instructions</label>
          <textarea class="form-textarea" id="transfer-special-instructions" placeholder="Any special instructions for vehicle handling..."></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('transfer-modal')">Cancel</button>
        <button class="btn btn-primary" onclick="submitTransferSetup()">Setup Transfer</button>
      </div>
    </div>
  </div>

  <!-- Location Share Modal -->
  <div class="modal-backdrop" id="location-share-modal">
    <div class="modal" style="max-width:450px;">
      <div class="modal-header">
        <h3 class="modal-title">üìç Share Your Location</h3>
        <button class="modal-close" onclick="closeModal('location-share-modal')">√ó</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="location-share-package-id">
        <input type="hidden" id="location-share-provider-id">
        
        <div style="text-align:center;padding:20px 0;">
          <div style="font-size:48px;margin-bottom:16px;">üìç</div>
          <p style="color:var(--text-secondary);margin-bottom:16px;">Share your current location with the provider so they can find you for pickup or delivery.</p>
          <div style="background:var(--bg-input);padding:12px;border-radius:var(--radius-md);font-size:0.85rem;color:var(--text-muted);">
            Your location will only be visible to this provider and will expire after 24 hours.
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Add a message (optional)</label>
          <input type="text" class="form-input" id="location-share-message" placeholder="e.g., I'm in the parking lot by the blue car">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('location-share-modal')">Cancel</button>
        <button class="btn btn-primary" onclick="confirmShareLocation()">üìç Share Location</button>
      </div>
    </div>
  </div>

  <!-- View Shared Location Modal -->
  <div class="modal-backdrop" id="view-location-modal">
    <div class="modal" style="max-width:500px;">
      <div class="modal-header">
        <h3 class="modal-title">üìç Provider Location</h3>
        <button class="modal-close" onclick="closeModal('view-location-modal')">√ó</button>
      </div>
      <div class="modal-body" id="view-location-body">
        <!-- Populated by JS -->
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('view-location-modal')">Close</button>
      </div>
    </div>
  </div>

  <!-- Review Modal -->
  <div class="modal-backdrop" id="review-modal">
    <div class="modal" style="max-width:550px;">
      <div class="modal-header">
        <h3 class="modal-title">Leave a Review</h3>
        <button class="modal-close" onclick="skipReview()">√ó</button>
      </div>
      <div class="modal-body">
        <div style="text-align:center;margin-bottom:24px;">
          <div style="font-size:48px;margin-bottom:8px;">‚≠ê</div>
          <h3 id="review-provider-name" style="margin-bottom:4px;">Provider Name</h3>
          <div style="color:var(--text-muted);font-size:0.9rem;">
            <span id="review-service-title">Service</span> ‚Ä¢ <span id="review-amount">$0</span>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Overall Rating *</label>
          <div class="star-rating" data-type="overall" data-value="5">
            <span class="star active" onclick="setRating('overall', 1)">‚òÖ</span>
            <span class="star active" onclick="setRating('overall', 2)">‚òÖ</span>
            <span class="star active" onclick="setRating('overall', 3)">‚òÖ</span>
            <span class="star active" onclick="setRating('overall', 4)">‚òÖ</span>
            <span class="star active" onclick="setRating('overall', 5)">‚òÖ</span>
          </div>
        </div>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px;">
          <div class="form-group" style="margin-bottom:0;">
            <label class="form-label" style="font-size:0.85rem;">Quality of Work</label>
            <div class="star-rating small" data-type="quality" data-value="5">
              <span class="star active" onclick="setRating('quality', 1)">‚òÖ</span>
              <span class="star active" onclick="setRating('quality', 2)">‚òÖ</span>
              <span class="star active" onclick="setRating('quality', 3)">‚òÖ</span>
              <span class="star active" onclick="setRating('quality', 4)">‚òÖ</span>
              <span class="star active" onclick="setRating('quality', 5)">‚òÖ</span>
            </div>
          </div>
          <div class="form-group" style="margin-bottom:0;">
            <label class="form-label" style="font-size:0.85rem;">Communication</label>
            <div class="star-rating small" data-type="communication" data-value="5">
              <span class="star active" onclick="setRating('communication', 1)">‚òÖ</span>
              <span class="star active" onclick="setRating('communication', 2)">‚òÖ</span>
              <span class="star active" onclick="setRating('communication', 3)">‚òÖ</span>
              <span class="star active" onclick="setRating('communication', 4)">‚òÖ</span>
              <span class="star active" onclick="setRating('communication', 5)">‚òÖ</span>
            </div>
          </div>
          <div class="form-group" style="margin-bottom:0;">
            <label class="form-label" style="font-size:0.85rem;">Timeliness</label>
            <div class="star-rating small" data-type="timeliness" data-value="5">
              <span class="star active" onclick="setRating('timeliness', 1)">‚òÖ</span>
              <span class="star active" onclick="setRating('timeliness', 2)">‚òÖ</span>
              <span class="star active" onclick="setRating('timeliness', 3)">‚òÖ</span>
              <span class="star active" onclick="setRating('timeliness', 4)">‚òÖ</span>
              <span class="star active" onclick="setRating('timeliness', 5)">‚òÖ</span>
            </div>
          </div>
          <div class="form-group" style="margin-bottom:0;">
            <label class="form-label" style="font-size:0.85rem;">Value for Money</label>
            <div class="star-rating small" data-type="value" data-value="5">
              <span class="star active" onclick="setRating('value', 1)">‚òÖ</span>
              <span class="star active" onclick="setRating('value', 2)">‚òÖ</span>
              <span class="star active" onclick="setRating('value', 3)">‚òÖ</span>
              <span class="star active" onclick="setRating('value', 4)">‚òÖ</span>
              <span class="star active" onclick="setRating('value', 5)">‚òÖ</span>
            </div>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Review Title (optional)</label>
          <input type="text" class="form-input" id="review-title" placeholder="Summarize your experience">
        </div>

        <div class="form-group">
          <label class="form-label">Your Review (optional)</label>
          <textarea class="form-textarea" id="review-text" placeholder="Tell others about your experience with this provider..."></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="skipReview()">Skip for Now</button>
        <button class="btn btn-primary" onclick="submitReview()">Submit Review</button>
      </div>
    </div>
  </div>

  <!-- Create Reminder Modal -->
  <div class="modal-backdrop" id="create-reminder-modal">
    <div class="modal" style="max-width:550px;">
      <div class="modal-header">
        <h3 class="modal-title">Create Reminder</h3>
        <button class="modal-close" onclick="closeModal('create-reminder-modal')">√ó</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Vehicle *</label>
          <select class="form-select" id="reminder-vehicle">
            <option value="">Select a vehicle...</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">Reminder Title *</label>
          <input type="text" class="form-input" id="reminder-title-input" placeholder="e.g., Brake pad replacement">
        </div>

        <div class="form-group">
          <label class="form-label">Reminder Type *</label>
          <select class="form-select" id="reminder-type-select">
            <option value="maintenance">Maintenance</option>
            <option value="inspection">Inspection</option>
            <option value="tire_rotation">Tire Rotation</option>
            <option value="brake_check">Brake Check</option>
            <option value="other">Other</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">Due Type *</label>
          <div style="display:flex;gap:12px;">
            <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
              <input type="radio" name="reminder-due-type" value="date" checked onchange="toggleReminderDueType()"> Due Date
            </label>
            <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
              <input type="radio" name="reminder-due-type" value="mileage" onchange="toggleReminderDueType()"> Due Mileage
            </label>
          </div>
        </div>

        <div class="form-group" id="reminder-date-group">
          <label class="form-label">Due Date</label>
          <input type="date" class="form-input" id="reminder-due-date">
        </div>

        <div class="form-group" id="reminder-mileage-group" style="display:none;">
          <label class="form-label">Due Mileage</label>
          <input type="number" class="form-input" id="reminder-due-mileage" placeholder="e.g., 60000">
        </div>

        <div class="form-group">
          <label class="form-label">Notes (optional)</label>
          <textarea class="form-textarea" id="reminder-notes" placeholder="Add any additional notes..."></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('create-reminder-modal')">Cancel</button>
        <button class="btn btn-primary" onclick="saveReminder()">Create Reminder</button>
      </div>
    </div>
  </div>

  <!-- Member Evidence Capture Modal -->
  <div class="modal-backdrop" id="member-evidence-modal">
    <div class="modal" style="max-width:640px;">
      <div class="modal-header">
        <h3 class="modal-title">üì∏ <span id="member-evidence-modal-title">Document Vehicle Condition</span></h3>
        <button class="modal-close" onclick="closeModal('member-evidence-modal')">√ó</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="member-evidence-package-id">
        <input type="hidden" id="member-evidence-type">
        
        <div class="alert" style="background:var(--accent-blue-soft);border:1px solid rgba(74,124,255,0.3);color:var(--accent-blue);margin-bottom:20px;padding:16px;border-radius:var(--radius-md);">
          üì∏ Document your vehicle's condition before pickup for your protection.
        </div>

        <div class="form-group">
          <label class="form-label">Photos (up to 10) *</label>
          <div style="display:flex;flex-wrap:wrap;gap:10px;margin-bottom:12px;" id="member-evidence-photo-preview"></div>
          <input type="file" id="member-evidence-photos" accept="image/*" multiple onchange="previewMemberEvidencePhotos()" style="display:none;">
          <button type="button" class="btn btn-secondary" onclick="document.getElementById('member-evidence-photos').click()">üì∑ Add Photos</button>
          <p class="form-hint">Take photos of vehicle condition, odometer, fuel gauge</p>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Odometer Reading *</label>
            <input type="number" class="form-input" id="member-evidence-odometer" placeholder="e.g., 45230" required>
          </div>
          <div class="form-group">
            <label class="form-label">Fuel Level *</label>
            <select class="form-input" id="member-evidence-fuel" required>
              <option value="">Select...</option>
              <option value="empty">Empty</option>
              <option value="1/4">1/4</option>
              <option value="1/2">1/2</option>
              <option value="3/4">3/4</option>
              <option value="full">Full</option>
            </select>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Exterior Condition</label>
          <textarea class="form-textarea" id="member-evidence-exterior" placeholder="Note any scratches, dents, or damage on the exterior..."></textarea>
        </div>

        <div class="form-group">
          <label class="form-label">Interior Condition</label>
          <textarea class="form-textarea" id="member-evidence-interior" placeholder="Note interior condition, cleanliness, any damage..."></textarea>
        </div>

        <div class="form-group">
          <label class="form-label">General Notes</label>
          <textarea class="form-textarea" id="member-evidence-notes" placeholder="Any additional observations..."></textarea>
        </div>

        <div id="member-evidence-upload-status" style="display:none;padding:16px;background:var(--bg-input);border-radius:var(--radius-md);margin-top:16px;"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('member-evidence-modal')">Cancel</button>
        <button class="btn btn-primary" id="submit-member-evidence-btn" onclick="submitMemberEvidence()">üì∏ Save Evidence</button>
      </div>
    </div>
  </div>


  <!-- Emergency Request Modal -->
  <div class="modal-backdrop" id="emergency-request-modal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">üö® Request Emergency Help</h3>
        <button class="modal-close" onclick="closeModal('emergency-request-modal')">√ó</button>
      </div>
      <div class="modal-body">
        <div id="emergency-location-status" style="background:var(--bg-input);border-radius:var(--radius-md);padding:16px;margin-bottom:20px;display:flex;align-items:center;gap:12px;">
          <span style="font-size:24px;">üìç</span>
          <div>
            <div id="emergency-location-text" style="font-weight:500;">Getting your location...</div>
            <div id="emergency-address-text" style="font-size:0.85rem;color:var(--text-muted);"></div>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Select Vehicle (Optional)</label>
          <select class="form-select" id="emergency-vehicle"></select>
        </div>

        <div class="form-group">
          <label class="form-label">What's the emergency? *</label>
          <select class="form-select" id="emergency-type" required onchange="handleEmergencyTypeChange()">
            <option value="">Select emergency type...</option>
            <option value="flat_tire">üõû Flat Tire</option>
            <option value="dead_battery">üîã Dead Battery / Jump Start</option>
            <option value="lockout">üîê Locked Out of Vehicle</option>
            <option value="tow_needed">üöõ Need a Tow</option>
            <option value="fuel_delivery">‚õΩ Out of Fuel</option>
            <option value="accident">üí• Accident / Collision</option>
            <option value="other">‚ùì Other Emergency</option>
          </select>
        </div>

        <div class="form-group" id="tow-distance-group" style="display:none;">
          <label class="form-label">Estimated tow distance (miles)</label>
          <input type="number" class="form-input" id="emergency-tow-miles" value="10" min="1" max="500" oninput="updateEmergencyPricePreview()">
          <p class="form-hint">Base rate covers up to 10 miles. Additional miles charged at $6/mile.</p>
        </div>

        <div id="emergency-price-preview" style="display:none;background:var(--accent-gold-soft);border-radius:var(--radius-md);padding:16px;margin-bottom:20px;">
          <div style="font-weight:600;margin-bottom:8px;">üí∞ Estimated Cost</div>
          <div style="display:flex;justify-content:space-between;font-size:0.9rem;margin-bottom:4px;">
            <span>Activation Fee:</span>
            <span>$25.00</span>
          </div>
          <div style="display:flex;justify-content:space-between;font-size:0.9rem;margin-bottom:8px;">
            <span>Service Escrow:</span>
            <span id="emergency-escrow-preview">$0.00</span>
          </div>
          <div style="display:flex;justify-content:space-between;font-weight:600;padding-top:8px;border-top:1px solid var(--border-subtle);">
            <span>Total Pre-Authorization:</span>
            <span id="emergency-total-preview">$25.00</span>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Describe the situation</label>
          <textarea class="form-textarea" id="emergency-description" placeholder="Any additional details that would help the provider..."></textarea>
        </div>

        <div class="form-group">
          <label class="form-label">Photos (Optional - up to 5)</label>
          <div class="photo-upload-area" onclick="document.getElementById('emergency-photo-input').click()">
            <div class="photo-upload-icon">üì∏</div>
            <div class="photo-upload-text">Tap to add photos</div>
            <div class="photo-upload-hint">Take photos of the issue or your location</div>
          </div>
          <input type="file" id="emergency-photo-input" accept="image/*" multiple style="display:none;" onchange="handleEmergencyPhotos(this)">
          <div id="emergency-photo-previews" class="emergency-photos"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('emergency-request-modal')">Cancel</button>
        <button class="btn" style="background:linear-gradient(135deg, #ef5f5f, #ff4444);color:white;" onclick="submitEmergencyRequest()">üö® Request Help Now</button>
      </div>
    </div>
  </div>

  <!-- Emergency Status Modal -->
  <div class="modal-backdrop" id="emergency-status-modal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">üö® Emergency Status</h3>
        <button class="modal-close" onclick="closeModal('emergency-status-modal')">√ó</button>
      </div>
      <div class="modal-body">
        <div id="emergency-status-content">
          <div style="text-align:center;padding:40px;">
            <div style="font-size:48px;margin-bottom:16px;">‚è≥</div>
            <div style="color:var(--text-muted);">Loading...</div>
          </div>
        </div>
      </div>
      <div class="modal-footer" id="emergency-status-footer"></div>
    </div>
  </div>

  <!-- Emergency Payment Authorization Modal -->
  <div class="modal-backdrop" id="emergency-payment-modal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">üí≥ Emergency Service Authorization</h3>
        <button class="modal-close" onclick="closeModal('emergency-payment-modal')">√ó</button>
      </div>
      <div class="modal-body">
        <div style="text-align:center;margin-bottom:24px;">
          <div style="font-size:48px;margin-bottom:12px;">üö®</div>
          <div style="font-size:1.1rem;font-weight:600;">Confirm Emergency Request</div>
          <div style="color:var(--text-secondary);margin-top:4px;">Payment authorization required</div>
        </div>

        <div style="background:var(--bg-input);border-radius:var(--radius-md);padding:20px;margin-bottom:20px;">
          <div style="display:flex;justify-content:space-between;margin-bottom:12px;">
            <span style="color:var(--text-secondary);">Activation Fee (non-refundable):</span>
            <span style="font-weight:600;">$25.00</span>
          </div>
          <div style="display:flex;justify-content:space-between;margin-bottom:12px;">
            <span style="color:var(--text-secondary);">Service Escrow:</span>
            <span style="font-weight:600;" id="payment-modal-escrow">$0.00</span>
          </div>
          <div style="display:flex;justify-content:space-between;padding-top:12px;border-top:1px solid var(--border-subtle);">
            <span style="font-weight:600;">Total Pre-Authorization:</span>
            <span style="font-weight:700;font-size:1.2rem;color:var(--accent-gold);" id="payment-modal-total">$25.00</span>
          </div>
        </div>

        <div style="background:var(--accent-blue-soft);border-radius:var(--radius-md);padding:16px;margin-bottom:20px;">
          <div style="display:flex;gap:12px;">
            <span style="font-size:20px;">‚ÑπÔ∏è</span>
            <div style="font-size:0.9rem;color:var(--text-secondary);line-height:1.5;">
              <strong style="color:var(--text-primary);">Your card will be charged $25.00 immediately.</strong><br>
              An additional <span id="payment-modal-escrow-text">$0.00</span> will be held until service is complete. 
              The escrow is only captured when you confirm the service is done. If no provider responds, the escrow hold will be released.
            </div>
          </div>
        </div>

        <div style="background:rgba(239, 95, 95, 0.1);border:1px solid rgba(239, 95, 95, 0.3);border-radius:var(--radius-md);padding:16px;">
          <div style="display:flex;gap:12px;">
            <span style="font-size:20px;">‚ö†Ô∏è</span>
            <div style="font-size:0.85rem;color:var(--text-secondary);line-height:1.5;">
              The $25 activation fee is <strong style="color:var(--accent-red);">non-refundable</strong> once a provider claims your request.
              Providers will have 5 minutes to claim your emergency.
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('emergency-payment-modal')">Cancel</button>
        <button class="btn" style="background:linear-gradient(135deg, #ef5f5f, #ff4444);color:white;" onclick="confirmEmergencyPayment()">üí≥ Authorize & Request Help</button>
      </div>
    </div>
  </div>

  <!-- Add Fleet Employee Modal -->
  <div class="modal-backdrop" id="add-fleet-employee-modal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Add Fleet Employee</h3>
        <button class="modal-close" onclick="closeModal('add-fleet-employee-modal')">√ó</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Email Address *</label>
          <input type="email" class="form-input" id="fleet-employee-email" placeholder="employee@company.com">
          <p class="form-hint">They'll receive an invitation to join your fleet.</p>
        </div>
        
        <div class="form-group">
          <label class="form-label">Role *</label>
          <select class="form-select" id="fleet-employee-role">
            <option value="driver">Driver - Can request services for assigned vehicles</option>
            <option value="manager">Manager - Can manage vehicles and approve services</option>
            <option value="viewer">Viewer - View-only access to fleet information</option>
          </select>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Employee ID</label>
            <input type="text" class="form-input" id="fleet-employee-id" placeholder="e.g., EMP-001">
          </div>
          <div class="form-group">
            <label class="form-label">Department</label>
            <input type="text" class="form-input" id="fleet-employee-dept" placeholder="e.g., Sales">
          </div>
        </div>
        
        <div class="form-group">
          <label class="form-label">Spending Limit (per service)</label>
          <div style="display:flex;align-items:center;gap:8px;">
            <span style="color:var(--text-muted);">$</span>
            <input type="number" class="form-input" id="fleet-employee-spending-limit" placeholder="No limit" style="max-width:150px;">
          </div>
          <p class="form-hint">Leave empty for no spending limit.</p>
        </div>
        
        <div class="form-group">
          <label style="display:flex;align-items:center;gap:10px;cursor:pointer;">
            <input type="checkbox" id="fleet-employee-requires-approval">
            <span>Requires approval for all service requests</span>
          </label>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('add-fleet-employee-modal')">Cancel</button>
        <button class="btn btn-primary" onclick="addFleetEmployee()">Add Employee</button>
      </div>
    </div>
  </div>

  <!-- Edit Fleet Employee Modal -->
  <div class="modal-backdrop" id="edit-fleet-employee-modal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Edit Fleet Employee</h3>
        <button class="modal-close" onclick="closeModal('edit-fleet-employee-modal')">√ó</button>
      </div>
      <div class="modal-body" id="edit-fleet-employee-content"></div>
      <div class="modal-footer">
        <button class="btn btn-danger" onclick="removeFleetEmployee()">Remove from Fleet</button>
        <button class="btn btn-primary" onclick="saveFleetEmployee()">Save Changes</button>
      </div>
    </div>
  </div>

  <!-- Add Fleet Vehicle Modal -->
  <div class="modal-backdrop" id="add-fleet-vehicle-modal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Add Vehicle to Fleet</h3>
        <button class="modal-close" onclick="closeModal('add-fleet-vehicle-modal')">√ó</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Select Vehicle *</label>
          <select class="form-select" id="fleet-vehicle-select">
            <option value="">Choose a vehicle from your garage...</option>
          </select>
          <p class="form-hint">Or <a href="#" onclick="openVehicleModal();closeModal('add-fleet-vehicle-modal');" style="color:var(--accent-gold);">add a new vehicle</a> first.</p>
        </div>
        
        <div class="form-group">
          <label class="form-label">Assigned Driver</label>
          <select class="form-select" id="fleet-vehicle-driver">
            <option value="">No assigned driver (Pool vehicle)</option>
          </select>
        </div>
        
        <div class="form-group">
          <label class="form-label">Assignment Type *</label>
          <div style="display:grid;grid-template-columns:repeat(3, 1fr);gap:12px;">
            <label class="fleet-assignment-option" style="display:flex;flex-direction:column;align-items:center;padding:16px;background:var(--bg-input);border:2px solid var(--border-subtle);border-radius:var(--radius-md);cursor:pointer;transition:all 0.2s;">
              <input type="radio" name="fleet-assignment-type" value="permanent" style="display:none;">
              <span style="font-size:24px;margin-bottom:8px;">üîí</span>
              <span style="font-weight:500;">Permanent</span>
              <span style="font-size:0.75rem;color:var(--text-muted);">Long-term assignment</span>
            </label>
            <label class="fleet-assignment-option" style="display:flex;flex-direction:column;align-items:center;padding:16px;background:var(--bg-input);border:2px solid var(--border-subtle);border-radius:var(--radius-md);cursor:pointer;transition:all 0.2s;">
              <input type="radio" name="fleet-assignment-type" value="temporary" style="display:none;">
              <span style="font-size:24px;margin-bottom:8px;">‚è±Ô∏è</span>
              <span style="font-weight:500;">Temporary</span>
              <span style="font-size:0.75rem;color:var(--text-muted);">Short-term use</span>
            </label>
            <label class="fleet-assignment-option" style="display:flex;flex-direction:column;align-items:center;padding:16px;background:var(--bg-input);border:2px solid var(--border-subtle);border-radius:var(--radius-md);cursor:pointer;transition:all 0.2s;">
              <input type="radio" name="fleet-assignment-type" value="pool" checked style="display:none;">
              <span style="font-size:24px;margin-bottom:8px;">üîÑ</span>
              <span style="font-weight:500;">Pool</span>
              <span style="font-size:0.75rem;color:var(--text-muted);">Shared vehicle</span>
            </label>
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Department / Cost Center</label>
            <input type="text" class="form-input" id="fleet-vehicle-dept" placeholder="e.g., Sales">
          </div>
        </div>
        
        <div class="form-row" id="fleet-vehicle-dates-row" style="display:none;">
          <div class="form-group">
            <label class="form-label">Start Date</label>
            <input type="date" class="form-input" id="fleet-vehicle-start-date">
          </div>
          <div class="form-group">
            <label class="form-label">End Date</label>
            <input type="date" class="form-input" id="fleet-vehicle-end-date">
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('add-fleet-vehicle-modal')">Cancel</button>
        <button class="btn btn-primary" onclick="addVehicleToFleet()">Add to Fleet</button>
      </div>
    </div>
  </div>

  <!-- Edit Fleet Vehicle Modal -->
  <div class="modal-backdrop" id="edit-fleet-vehicle-modal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Edit Fleet Vehicle Assignment</h3>
        <button class="modal-close" onclick="closeModal('edit-fleet-vehicle-modal')">√ó</button>
      </div>
      <div class="modal-body" id="edit-fleet-vehicle-content"></div>
      <div class="modal-footer">
        <button class="btn btn-danger" onclick="removeVehicleFromFleet()">Remove from Fleet</button>
        <button class="btn btn-primary" onclick="saveFleetVehicle()">Save Changes</button>
      </div>
    </div>
  </div>

  <!-- Bulk Service Wizard Modal -->
  <div class="modal-backdrop" id="bulk-service-wizard-modal">
    <div class="modal wide">
      <div class="modal-header">
        <h3 class="modal-title">üìÖ Schedule Bulk Service</h3>
        <button class="modal-close" onclick="closeModal('bulk-service-wizard-modal')">√ó</button>
      </div>
      <div class="modal-body">
        <!-- Wizard Steps Indicator -->
        <div class="wizard-steps">
          <div class="wizard-step active" data-step="1"><span class="wizard-step-num">1</span> Service Details</div>
          <div class="wizard-step" data-step="2"><span class="wizard-step-num">2</span> Select Vehicles</div>
          <div class="wizard-step" data-step="3"><span class="wizard-step-num">3</span> Schedule Dates</div>
          <div class="wizard-step" data-step="4"><span class="wizard-step-num">4</span> Review & Submit</div>
        </div>

        <!-- Step 1: Service Details -->
        <div class="bulk-wizard-step" id="bulk-step-1">
          <div class="form-group">
            <label class="form-label">Batch Title *</label>
            <input type="text" class="form-input" id="bulk-batch-title" placeholder="e.g., Q1 Oil Change - All Vehicles">
          </div>
          
          <div class="form-group">
            <label class="form-label">Service Type *</label>
            <select class="form-select" id="bulk-service-type">
              <option value="">Select service type...</option>
              <option value="oil_change">Oil Change</option>
              <option value="tire_rotation">Tire Rotation</option>
              <option value="brake_inspection">Brake Inspection</option>
              <option value="full_inspection">Full Vehicle Inspection</option>
              <option value="detailing">Detailing/Wash</option>
              <option value="other">Other Maintenance</option>
            </select>
          </div>
          
          <div class="form-group">
            <label class="form-label">Description</label>
            <textarea class="form-textarea" id="bulk-batch-description" placeholder="Additional details about the service requirements..."></textarea>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Preferred Date Range Start *</label>
              <input type="date" class="form-input" id="bulk-date-start">
            </div>
            <div class="form-group">
              <label class="form-label">Preferred Date Range End *</label>
              <input type="date" class="form-input" id="bulk-date-end">
            </div>
          </div>
        </div>

        <!-- Step 2: Select Vehicles -->
        <div class="bulk-wizard-step" id="bulk-step-2" style="display:none;">
          <div style="margin-bottom:16px;display:flex;justify-content:space-between;align-items:center;">
            <span style="font-weight:500;"><span id="bulk-selected-count">0</span> vehicles selected</span>
            <button class="btn btn-ghost btn-sm" onclick="toggleAllBulkVehicles()">Select All</button>
          </div>
          <div id="bulk-vehicles-list" style="display:grid;gap:12px;max-height:400px;overflow-y:auto;"></div>
        </div>

        <!-- Step 3: Schedule Dates -->
        <div class="bulk-wizard-step" id="bulk-step-3" style="display:none;">
          <p style="color:var(--text-secondary);margin-bottom:16px;">Set preferred service dates for each selected vehicle:</p>
          <div id="bulk-schedule-list" style="display:grid;gap:12px;max-height:400px;overflow-y:auto;"></div>
        </div>

        <!-- Step 4: Review & Submit -->
        <div class="bulk-wizard-step" id="bulk-step-4" style="display:none;">
          <div id="bulk-review-content"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="bulk-prev-btn" onclick="bulkWizardPrev()" style="display:none;">‚Üê Previous</button>
        <button class="btn btn-secondary" onclick="closeModal('bulk-service-wizard-modal')">Cancel</button>
        <button class="btn btn-primary" id="bulk-next-btn" onclick="bulkWizardNext()">Next ‚Üí</button>
        <button class="btn btn-primary" id="bulk-submit-btn" onclick="submitBulkServiceBatch()" style="display:none;">Submit for Approval</button>
      </div>
    </div>
  </div>

  <!-- Fleet Settings Modal -->
  <div class="modal-backdrop" id="fleet-settings-modal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">‚öôÔ∏è Fleet Settings</h3>
        <button class="modal-close" onclick="closeModal('fleet-settings-modal')">√ó</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Fleet Name *</label>
          <input type="text" class="form-input" id="fleet-settings-name">
        </div>
        
        <div class="form-group">
          <label class="form-label">Company Name</label>
          <input type="text" class="form-input" id="fleet-settings-company-name" placeholder="Legal company name">
        </div>
        
        <div class="form-group">
          <label class="form-label">Business Type</label>
          <select class="form-select" id="fleet-settings-business-type">
            <option value="rental">Rental</option>
            <option value="corporate">Corporate</option>
            <option value="delivery">Delivery</option>
            <option value="rideshare">Rideshare</option>
            <option value="logistics">Logistics</option>
            <option value="government">Government</option>
            <option value="other">Other</option>
          </select>
        </div>
        
        <div class="form-group">
          <label class="form-label">Billing Email</label>
          <input type="email" class="form-input" id="fleet-settings-billing-email" placeholder="billing@company.com">
        </div>
        
        <div class="form-group">
          <label class="form-label">Business Address</label>
          <textarea class="form-textarea" id="fleet-settings-address" placeholder="Street address, City, State, ZIP" style="min-height:60px;"></textarea>
        </div>
        
        <div class="form-group">
          <label class="form-label">Tax ID / EIN (Optional)</label>
          <input type="text" class="form-input" id="fleet-settings-tax-id" placeholder="XX-XXXXXXX">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('fleet-settings-modal')">Cancel</button>
        <button class="btn btn-primary" onclick="saveFleetSettings()">Save Settings</button>
      </div>
    </div>
  </div>

  <!-- Toast Container -->
  <div class="toast-container" id="toast-container"></div>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="supabaseclient.js"></script>
  <script src="tos-modal.js"></script>
  <script src="emailService.js"></script>
  <script>
    // ========== STATE ==========
    let currentUser = null;
    let userProfile = null;
    let vehicles = [];
    let packages = [];
    let reminders = [];
    let serviceHistory = [];
    let upsellRequests = [];
    let currentPackageFilter = 'open';
    let currentUpsellFilter = 'pending';
    let currentViewPackage = null;
    let currentMessageProvider = null;
    let selectedPartsTier = 'standard';
    let selectedBiddingWindowHours = 72; // Default 3 days
    let pendingPackagePhotos = []; // Photos to upload with new package
    let pendingVehiclePhoto = null; // Photo to upload with new vehicle
    let pendingEditVehiclePhoto = null; // Photo to upload when editing vehicle
    let editingVehicleId = null; // Vehicle ID being edited
    let activeEmergency = null; // Current active emergency request
    let emergencyLocation = null; // Current GPS coordinates
    let pendingEmergencyPhotos = []; // Photos for emergency request
    
    // Fleet Management State
    let currentFleet = null; // Current fleet data
    let fleetMembers = []; // Fleet members list
    let fleetVehicles = []; // Fleet vehicles list
    let bulkBatches = []; // Bulk service batches
    let bulkWizardStep = 1; // Current bulk wizard step
    let bulkSelectedVehicles = []; // Selected vehicles for bulk service
    let editingFleetMemberId = null; // Member being edited
    let editingFleetVehicleId = null; // Vehicle assignment being edited

    // Service types by category
    const serviceTypes = {
      maintenance: [
        'Oil change / fluids', 'Tire rotation / alignment', 'Brake service', 'Battery / electrical',
        'Engine tune-up', 'Transmission service', 'Suspension / steering', 'Diagnostic / check engine',
        'AC / heating service', 'Belt / hose replacement', 'Spark plugs', 'Fuel system cleaning'
      ],
      detailing: [
        'Exterior wash', 'Interior cleaning', 'Interior & Exterior', 'Full detail package', 'Paint correction',
        'Ceramic coating', 'Wax / polish', 'Leather conditioning', 'Odor removal', 'Engine bay cleaning'
      ],
      cosmetic: [
        'Scratch repair', 'Dent repair (PDR)', 'Paint touch-up', 'Bumper repair',
        'Window tinting', 'Vinyl wrap', 'Headlight restoration', 'Wheel repair / refinish'
      ],
      accident_repair: [
        'Collision repair', 'Frame straightening', 'Panel replacement', 'Airbag replacement',
        'Glass replacement', 'Full body restoration', 'Paint matching', 'Structural assessment'
      ],
      manufacturer_service: [
        '‚îÄ‚îÄ Mercedes-Benz ‚îÄ‚îÄ',
        'Mercedes Service A (10K miles)',
        'Mercedes Service B (20K miles)',
        '‚îÄ‚îÄ BMW ‚îÄ‚îÄ',
        'BMW Oil Service',
        'BMW Inspection I (Minor)',
        'BMW Inspection II (Major)',
        '‚îÄ‚îÄ Audi/VW ‚îÄ‚îÄ',
        'Audi/VW Minor Service',
        'Audi/VW Major Service',
        'Audi/VW DSG Service',
        '‚îÄ‚îÄ Lexus/Toyota ‚îÄ‚îÄ',
        'Toyota/Lexus 5K Service',
        'Toyota/Lexus 10K Service',
        'Toyota/Lexus 15K Service',
        'Toyota/Lexus 30K Service',
        'Toyota/Lexus 60K Service',
        '‚îÄ‚îÄ Porsche ‚îÄ‚îÄ',
        'Porsche Minor Service',
        'Porsche Major Service',
        '‚îÄ‚îÄ Land Rover/Jaguar ‚îÄ‚îÄ',
        'Land Rover Annual Service',
        'Jaguar Annual Service',
        '‚îÄ‚îÄ Volvo ‚îÄ‚îÄ',
        'Volvo Scheduled Service',
        '‚îÄ‚îÄ Other Brands ‚îÄ‚îÄ',
        'Manufacturer Scheduled Service',
        'Factory Recommended Maintenance'
      ],
      other: ['Custom request']
    };

    // Vehicle makes, models, and trims data
    const vehicleData = {
      makes: ['Acura', 'Alfa Romeo', 'Aston Martin', 'Audi', 'Bentley', 'BMW', 'Buick', 'Cadillac', 'Chevrolet', 'Chrysler', 'Dodge', 'Ferrari', 'Fiat', 'Ford', 'Genesis', 'GMC', 'Honda', 'Hyundai', 'Infiniti', 'Jaguar', 'Jeep', 'Kia', 'Lamborghini', 'Land Rover', 'Lexus', 'Lincoln', 'Lucid', 'Maserati', 'Mazda', 'McLaren', 'Mercedes-Benz', 'Mini', 'Mitsubishi', 'Nissan', 'Polestar', 'Porsche', 'Ram', 'Rivian', 'Rolls-Royce', 'Subaru', 'Tesla', 'Toyota', 'Volkswagen', 'Volvo'],
      models: {
        'Acura': ['ILX', 'Integra', 'MDX', 'NSX', 'RDX', 'TLX'],
        'Alfa Romeo': ['Giulia', 'Stelvio', 'Tonale'],
        'Aston Martin': ['DB11', 'DB12', 'DBX', 'Vantage'],
        'Audi': ['A3', 'A4', 'A5', 'A6', 'A7', 'A8', 'e-tron', 'e-tron GT', 'Q3', 'Q4 e-tron', 'Q5', 'Q7', 'Q8', 'RS3', 'RS5', 'RS6', 'RS7', 'S3', 'S4', 'S5', 'TT'],
        'Bentley': ['Bentayga', 'Continental GT', 'Flying Spur'],
        'BMW': ['2 Series', '3 Series', '4 Series', '5 Series', '7 Series', '8 Series', 'i4', 'i5', 'i7', 'iX', 'M2', 'M3', 'M4', 'M5', 'M8', 'X1', 'X2', 'X3', 'X4', 'X5', 'X6', 'X7', 'Z4'],
        'Buick': ['Enclave', 'Encore', 'Encore GX', 'Envision'],
        'Cadillac': ['CT4', 'CT5', 'Escalade', 'Lyriq', 'XT4', 'XT5', 'XT6'],
        'Chevrolet': ['Blazer', 'Bolt EUV', 'Bolt EV', 'Camaro', 'Colorado', 'Corvette', 'Equinox', 'Malibu', 'Silverado', 'Suburban', 'Tahoe', 'Trailblazer', 'Traverse', 'Trax'],
        'Chrysler': ['300', 'Pacifica', 'Voyager'],
        'Dodge': ['Challenger', 'Charger', 'Durango', 'Hornet'],
        'Ferrari': ['296 GTB', '488', 'F8', 'Portofino', 'Purosangue', 'Roma', 'SF90'],
        'Fiat': ['500X'],
        'Ford': ['Bronco', 'Bronco Sport', 'Edge', 'Escape', 'Expedition', 'Explorer', 'F-150', 'F-150 Lightning', 'Maverick', 'Mustang', 'Mustang Mach-E', 'Ranger', 'Transit'],
        'Genesis': ['Electrified G80', 'Electrified GV70', 'G70', 'G80', 'G90', 'GV60', 'GV70', 'GV80'],
        'GMC': ['Acadia', 'Canyon', 'Hummer EV', 'Sierra', 'Terrain', 'Yukon'],
        'Honda': ['Accord', 'Civic', 'CR-V', 'HR-V', 'Odyssey', 'Passport', 'Pilot', 'Ridgeline'],
        'Hyundai': ['Elantra', 'Ioniq 5', 'Ioniq 6', 'Kona', 'Palisade', 'Santa Cruz', 'Santa Fe', 'Sonata', 'Tucson', 'Venue'],
        'Infiniti': ['Q50', 'Q60', 'QX50', 'QX55', 'QX60', 'QX80'],
        'Jaguar': ['E-Pace', 'F-Pace', 'F-Type', 'I-Pace', 'XF'],
        'Jeep': ['Cherokee', 'Compass', 'Gladiator', 'Grand Cherokee', 'Grand Cherokee L', 'Grand Wagoneer', 'Renegade', 'Wagoneer', 'Wrangler'],
        'Kia': ['Carnival', 'EV6', 'EV9', 'Forte', 'K5', 'Niro', 'Rio', 'Seltos', 'Sorento', 'Soul', 'Sportage', 'Stinger', 'Telluride'],
        'Lamborghini': ['Huracan', 'Revuelto', 'Urus'],
        'Land Rover': ['Defender', 'Discovery', 'Discovery Sport', 'Range Rover', 'Range Rover Evoque', 'Range Rover Sport', 'Range Rover Velar'],
        'Lexus': ['ES', 'GX', 'IS', 'LC', 'LS', 'LX', 'NX', 'RC', 'RX', 'RZ', 'TX', 'UX'],
        'Lincoln': ['Aviator', 'Corsair', 'Nautilus', 'Navigator'],
        'Lucid': ['Air'],
        'Maserati': ['Ghibli', 'GranTurismo', 'Grecale', 'Levante', 'MC20', 'Quattroporte'],
        'Mazda': ['CX-30', 'CX-5', 'CX-50', 'CX-9', 'CX-90', 'Mazda3', 'Mazda6', 'MX-30', 'MX-5 Miata'],
        'McLaren': ['720S', '750S', 'Artura', 'GT'],
        'Mercedes-Benz': ['A-Class', 'AMG GT', 'C-Class', 'CLA', 'CLE', 'E-Class', 'EQB', 'EQE', 'EQS', 'G-Class', 'GLA', 'GLB', 'GLC', 'GLE', 'GLS', 'Maybach', 'S-Class', 'SL'],
        'Mini': ['Clubman', 'Convertible', 'Countryman', 'Hardtop'],
        'Mitsubishi': ['Eclipse Cross', 'Mirage', 'Outlander', 'Outlander Sport'],
        'Nissan': ['Altima', 'Armada', 'Ariya', 'Frontier', 'Kicks', 'Leaf', 'Maxima', 'Murano', 'Pathfinder', 'Rogue', 'Sentra', 'Titan', 'Versa', 'Z'],
        'Polestar': ['Polestar 2', 'Polestar 3'],
        'Porsche': ['718 Boxster', '718 Cayman', '911', 'Cayenne', 'Macan', 'Panamera', 'Taycan'],
        'Ram': ['1500', '2500', '3500', 'ProMaster'],
        'Rivian': ['R1S', 'R1T'],
        'Rolls-Royce': ['Cullinan', 'Ghost', 'Phantom', 'Spectre'],
        'Subaru': ['Ascent', 'BRZ', 'Crosstrek', 'Forester', 'Impreza', 'Legacy', 'Outback', 'Solterra', 'WRX'],
        'Tesla': ['Model 3', 'Model S', 'Model X', 'Model Y', 'Cybertruck'],
        'Toyota': ['4Runner', '86', 'bZ4X', 'Camry', 'Corolla', 'Corolla Cross', 'Crown', 'GR Supra', 'Grand Highlander', 'Highlander', 'Land Cruiser', 'Prius', 'RAV4', 'Sequoia', 'Sienna', 'Tacoma', 'Tundra', 'Venza'],
        'Volkswagen': ['Arteon', 'Atlas', 'Atlas Cross Sport', 'Golf', 'Golf GTI', 'Golf R', 'ID.4', 'Jetta', 'Taos', 'Tiguan'],
        'Volvo': ['C40 Recharge', 'S60', 'S90', 'V60', 'V90', 'XC40', 'XC60', 'XC90']
      },
      trims: {
        // Common trim levels by make (simplified)
        'default': ['Base', 'S', 'SE', 'SEL', 'Limited', 'Premium', 'Sport', 'Touring'],
        'Toyota': ['L', 'LE', 'SE', 'XLE', 'XSE', 'Limited', 'TRD Sport', 'TRD Off-Road', 'TRD Pro', 'Nightshade', 'Platinum'],
        'Honda': ['LX', 'EX', 'EX-L', 'Sport', 'Touring', 'Elite', 'Type R'],
        'Ford': ['Base', 'XL', 'XLT', 'Lariat', 'King Ranch', 'Platinum', 'Limited', 'Raptor', 'ST', 'GT'],
        'Chevrolet': ['LS', 'LT', 'RS', 'Premier', 'High Country', 'ZR2', 'Z71', 'SS', 'ZL1'],
        'BMW': ['Base', 'xDrive', 'M Sport', 'M', 'Competition'],
        'Mercedes-Benz': ['Base', '4MATIC', 'AMG Line', 'AMG 43', 'AMG 53', 'AMG 63'],
        'Audi': ['Base', 'Premium', 'Premium Plus', 'Prestige', 'S Line', 'Black Optics'],
        'Lexus': ['Base', 'Premium', 'Luxury', 'F Sport', 'Ultra Luxury'],
        'Tesla': ['Standard Range', 'Long Range', 'Performance', 'Plaid'],
        'Hyundai': ['SE', 'SEL', 'N Line', 'Limited', 'Calligraphy'],
        'Kia': ['LX', 'LXS', 'S', 'EX', 'GT-Line', 'SX', 'SX Prestige'],
        'Jeep': ['Sport', 'Sport S', 'Latitude', 'Altitude', 'Limited', 'Trailhawk', 'Overland', 'Summit', 'Rubicon', 'Sahara'],
        'Subaru': ['Base', 'Premium', 'Sport', 'Limited', 'Touring', 'Wilderness', 'Onyx Edition XT']
      }
    };

    // Populate year dropdown (current year down to 1990)
    function initYearDropdown() {
      const yearSelect = document.getElementById('v-year');
      const currentYear = new Date().getFullYear() + 1; // Include next model year
      for (let y = currentYear; y >= 1990; y--) {
        const opt = document.createElement('option');
        opt.value = y;
        opt.textContent = y;
        yearSelect.appendChild(opt);
      }
    }

    // Update make options when year is selected
    function updateMakeOptions() {
      const yearSelect = document.getElementById('v-year');
      const makeSelect = document.getElementById('v-make');
      const modelSelect = document.getElementById('v-model');
      const trimSelect = document.getElementById('v-trim');
      
      // Reset dependent dropdowns
      makeSelect.innerHTML = '<option value="">Select Make</option>';
      modelSelect.innerHTML = '<option value="">Select Model</option>';
      trimSelect.innerHTML = '<option value="">Select Trim (Optional)</option>';
      modelSelect.disabled = true;
      trimSelect.disabled = true;
      
      if (!yearSelect.value) {
        makeSelect.disabled = true;
        return;
      }
      
      makeSelect.disabled = false;
      vehicleData.makes.forEach(make => {
        const opt = document.createElement('option');
        opt.value = make;
        opt.textContent = make;
        makeSelect.appendChild(opt);
      });
    }

    // Update model options when make is selected
    function updateModelOptions() {
      const makeSelect = document.getElementById('v-make');
      const modelSelect = document.getElementById('v-model');
      const trimSelect = document.getElementById('v-trim');
      
      // Reset dependent dropdowns
      modelSelect.innerHTML = '<option value="">Select Model</option>';
      trimSelect.innerHTML = '<option value="">Select Trim (Optional)</option>';
      trimSelect.disabled = true;
      
      if (!makeSelect.value) {
        modelSelect.disabled = true;
        return;
      }
      
      modelSelect.disabled = false;
      const models = vehicleData.models[makeSelect.value] || [];
      models.forEach(model => {
        const opt = document.createElement('option');
        opt.value = model;
        opt.textContent = model;
        modelSelect.appendChild(opt);
      });
    }

    // Update trim options when model is selected
    function updateTrimOptions() {
      const makeSelect = document.getElementById('v-make');
      const modelSelect = document.getElementById('v-model');
      const trimSelect = document.getElementById('v-trim');
      
      trimSelect.innerHTML = '<option value="">Select Trim (Optional)</option>';
      
      if (!modelSelect.value) {
        trimSelect.disabled = true;
        return;
      }
      
      trimSelect.disabled = false;
      const trims = vehicleData.trims[makeSelect.value] || vehicleData.trims['default'];
      trims.forEach(trim => {
        const opt = document.createElement('option');
        opt.value = trim;
        opt.textContent = trim;
        trimSelect.appendChild(opt);
      });
    }

    // ========== INITIALIZATION ==========
    window.addEventListener('load', async () => {
      try {
        const user = await getCurrentUser();
        if (!user) return window.location.href = 'login.html';
        currentUser = user;
        
        // Check ToS acceptance before loading dashboard
        const tosAccepted = await TosModal.check(supabaseClient, user.id);
        if (!tosAccepted) {
          TosModal.show(async () => {
            const accepted = await TosModal.accept(supabaseClient, user.id);
            if (accepted) {
              await initializeDashboard();
            }
          });
          return;
        }
        
        await initializeDashboard();
      } catch (err) {
        console.error('Page initialization error:', err);
        showToast('Error loading page. Check console for details.', 'error');
      }
    });

    async function initializeDashboard() {
      initYearDropdown(); // Initialize year dropdown
      
      await loadProfile();
      await loadVehicles();
      await loadPackages();
      await loadDestinationServices();
      await loadReminders();
      await loadRecommendations();
      await loadServiceHistory();
      await loadUpsellRequests();
      await loadConversations();
      await loadNotifications();
      await checkActiveEmergency();
      updateStats();
      setupEventListeners();
      setupRealtimeSubscriptions();
    }

    // ========== REALTIME SUBSCRIPTIONS ==========
    let realtimeChannel = null;

    function setupRealtimeSubscriptions() {
      // Subscribe to changes relevant to this member
      realtimeChannel = supabaseClient.channel('member-updates')
        
        // New bids on member's packages
        .on('postgres_changes', {
          event: 'INSERT',
          schema: 'public',
          table: 'bids'
        }, async (payload) => {
          // Check if this bid is for one of our packages
          const pkg = packages.find(p => p.id === payload.new.package_id);
          if (pkg) {
            console.log('[REALTIME] New bid received:', payload.new);
            showToast('üí∞ New bid received!', 'success');
            await loadPackages();
            updateStats();
          }
        })

        // New messages for this member
        .on('postgres_changes', {
          event: 'INSERT',
          schema: 'public',
          table: 'messages',
          filter: `recipient_id=eq.${currentUser.id}`
        }, async (payload) => {
          console.log('[REALTIME] New message:', payload.new);
          showToast('üí¨ New message received!', 'success');
          await loadConversations();
          
          // If message modal is open, refresh it
          if (document.getElementById('message-modal').classList.contains('active')) {
            const msgThread = document.getElementById('message-thread');
            const newMsg = payload.new;
            const msgHtml = `
              <div class="message received">
                <div class="message-bubble">${newMsg.content}</div>
                <div class="message-time">${new Date(newMsg.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</div>
              </div>
            `;
            msgThread.insertAdjacentHTML('beforeend', msgHtml);
            msgThread.scrollTop = msgThread.scrollHeight;
          }
        })

        // New notifications
        .on('postgres_changes', {
          event: 'INSERT',
          schema: 'public',
          table: 'notifications',
          filter: `user_id=eq.${currentUser.id}`
        }, async (payload) => {
          console.log('[REALTIME] New notification:', payload.new);
          await loadNotifications();
        })

        // Package status changes
        .on('postgres_changes', {
          event: 'UPDATE',
          schema: 'public',
          table: 'maintenance_packages'
        }, async (payload) => {
          const pkg = packages.find(p => p.id === payload.new.id);
          if (pkg) {
            console.log('[REALTIME] Package updated:', payload.new);
            if (payload.old.status !== payload.new.status) {
              showToast(`üì¶ Package "${payload.new.title}" is now ${payload.new.status}`, 'success');
            }
            await loadPackages();
            updateStats();
          }
        })

        // Upsell requests
        .on('postgres_changes', {
          event: 'INSERT',
          schema: 'public',
          table: 'upsell_requests',
          filter: `member_id=eq.${currentUser.id}`
        }, async (payload) => {
          console.log('[REALTIME] New upsell request:', payload.new);
          showToast('‚ö†Ô∏è Provider found additional work needed!', 'success');
          await loadUpsellRequests();
        })

        .subscribe((status) => {
          console.log('[REALTIME] Subscription status:', status);
          updateRealtimeStatus(status);
        });
    }

    function updateRealtimeStatus(status) {
      const dot = document.getElementById('realtime-dot');
      const text = document.getElementById('realtime-text');
      
      if (status === 'SUBSCRIBED') {
        dot.style.background = 'var(--accent-green)';
        text.textContent = 'Live updates on';
      } else if (status === 'CHANNEL_ERROR') {
        dot.style.background = 'var(--accent-red)';
        text.textContent = 'Connection error';
      } else if (status === 'CLOSED') {
        dot.style.background = 'var(--text-muted)';
        text.textContent = 'Disconnected';
      } else {
        dot.style.background = 'var(--accent-orange)';
        text.textContent = 'Connecting...';
      }
    }

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
      if (realtimeChannel) {
        supabaseClient.removeChannel(realtimeChannel);
      }
    });

    async function loadProfile() {
      const { data, error } = await supabaseClient.from('profiles').select('*').eq('id', currentUser.id).single();
      
      // If no profile exists, create one
      if (error || !data) {
        console.log('No profile found, creating one...');
        const { data: newProfile, error: createError } = await supabaseClient.from('profiles').insert({
          id: currentUser.id,
          email: currentUser.email,
          role: 'member'
        }).select().single();
        
        if (createError) {
          console.error('Failed to create profile:', createError);
          // Continue anyway with defaults
          userProfile = { role: 'member' };
        } else {
          userProfile = newProfile;
        }
      } else {
        userProfile = data;
      }
      
      const name = userProfile?.full_name || 'Member';
      const initials = name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
      document.getElementById('user-name').textContent = name;
      document.getElementById('user-email').textContent = currentUser.email;
      document.getElementById('user-avatar').textContent = initials;

      // Populate settings fields
      document.getElementById('settings-name').value = userProfile?.full_name || '';
      document.getElementById('settings-phone').value = userProfile?.phone || '';
      document.getElementById('settings-zip').value = userProfile?.zip_code || '';
      document.getElementById('settings-city').value = userProfile?.city || '';
      document.getElementById('settings-state').value = userProfile?.state || '';

      // SMS notification settings
      document.getElementById('sms-enabled').checked = userProfile?.sms_notifications || false;
      document.getElementById('sms-bid-received').checked = userProfile?.sms_bid_received !== false;
      document.getElementById('sms-work-completed').checked = userProfile?.sms_work_completed !== false;
      document.getElementById('sms-new-message').checked = userProfile?.sms_new_message || false;
      if (document.getElementById('sms-bidding-ending')) {
        document.getElementById('sms-bidding-ending').checked = userProfile?.sms_bidding_ending !== false;
      }
      toggleSmsOptions();

      // Show location reminder if ZIP not set
      if (!userProfile?.zip_code) {
        const status = document.getElementById('location-status');
        status.innerHTML = '<div style="background:var(--accent-orange-soft);border:1px solid rgba(245,158,11,0.3);color:var(--accent-orange);padding:12px;border-radius:var(--radius-md);">‚ö†Ô∏è Please set your ZIP code so providers in your area can find your service requests.</div>';
        status.style.display = 'block';
      }

      // Show admin link if user is admin
      if (userProfile?.role === 'admin') {
        document.getElementById('admin-nav').style.display = 'block';
      }

      // Check if user has approved provider access before showing switch portal button
      checkProviderAccess();
    }

    async function checkProviderAccess() {
      try {
        const { data: providerRecord } = await supabaseClient
          .from('service_providers')
          .select('id, status')
          .eq('user_id', currentUser.id)
          .single();
        
        // Only show dual access if user has an approved provider record
        if (providerRecord && providerRecord.status === 'approved') {
          document.getElementById('switch-portal-container').style.display = 'block';
        } else {
          document.getElementById('switch-portal-container').style.display = 'none';
        }
      } catch (err) {
        // No provider record found - hide the switch portal option
        document.getElementById('switch-portal-container').style.display = 'none';
      }
    }

    function switchToProvider() {
      localStorage.setItem('mcc_portal', 'provider');
      window.location.href = 'providers.html';
    }

    async function loadVehicles() {
      try {
        const { data, error } = await supabaseClient.from('vehicles').select('*').eq('owner_id', currentUser.id).order('created_at', { ascending: false });
        
        if (error) {
          console.error('Error loading vehicles:', error);
          vehicles = [];
        } else {
          vehicles = data || [];
        }
        
        renderVehicles();
        updateVehicleSelects();
      } catch (err) {
        console.error('loadVehicles error:', err);
        vehicles = [];
        renderVehicles();
      }
    }

    async function loadUpsellRequests() {
      const { data } = await supabaseClient.from('upsell_requests')
        .select('*, maintenance_packages(title, vehicles(year, make, model))')
        .eq('member_id', currentUser.id)
        .order('created_at', { ascending: false });
      upsellRequests = data || [];
      renderUpsells();
      
      // Show alert banner if pending upsells
      const pending = upsellRequests.filter(u => u.status === 'pending');
      const banner = document.getElementById('upsell-alert-banner');
      const badge = document.getElementById('upsell-count');
      if (pending.length > 0) {
        banner.style.display = 'block';
        badge.style.display = 'inline';
        badge.textContent = pending.length;
      } else {
        banner.style.display = 'none';
        badge.style.display = 'none';
      }
    }

    function renderUpsells() {
      const filtered = upsellRequests.filter(u => 
        currentUpsellFilter === 'all' || u.status === currentUpsellFilter
      );
      
      const container = document.getElementById('upsells-list');
      if (!filtered.length) {
        container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">‚úÖ</div><p>No ${currentUpsellFilter === 'all' ? '' : currentUpsellFilter} additional work requests.</p></div>`;
        return;
      }

      container.innerHTML = filtered.map(u => {
        const pkg = u.maintenance_packages;
        const vehicle = pkg?.vehicles;
        const vehicleName = vehicle ? `${vehicle.year} ${vehicle.make} ${vehicle.model}` : 'Vehicle';
        const timeLeft = u.expires_at ? getTimeRemaining(u.expires_at) : null;
        const urgencyColors = { critical: 'var(--accent-red)', recommended: 'var(--accent-orange)', optional: 'var(--text-muted)' };
        
        return `
          <div class="card" style="margin-bottom:16px;">
            <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:16px;">
              <div>
                <h3 style="margin-bottom:4px;">${u.title}</h3>
                <div style="color:var(--text-muted);font-size:0.88rem;">
                  ${pkg?.title || 'Package'} ‚Ä¢ ${vehicleName}
                </div>
              </div>
              <div style="text-align:right;">
                <div style="font-size:1.2rem;font-weight:600;">$${(u.estimated_cost || 0).toFixed(2)}</div>
                <span style="font-size:0.8rem;color:${urgencyColors[u.urgency] || 'var(--text-muted)'};font-weight:500;">${(u.urgency || 'recommended').toUpperCase()}</span>
              </div>
            </div>

            ${u.description ? `<p style="color:var(--text-secondary);margin-bottom:16px;">${u.description}</p>` : ''}

            ${u.photo_urls?.length ? `
              <div style="display:flex;gap:8px;margin-bottom:16px;overflow-x:auto;">
                ${u.photo_urls.map(url => `
                  <img src="${url}" style="width:100px;height:75px;object-fit:cover;border-radius:var(--radius-sm);cursor:pointer;" onclick="window.open('${url}','_blank')">
                `).join('')}
              </div>
            ` : ''}

            ${u.status === 'pending' ? `
              ${timeLeft ? `<div style="color:var(--accent-orange);font-size:0.88rem;margin-bottom:16px;">‚è∞ ${timeLeft} to respond</div>` : ''}
              <div style="display:flex;gap:12px;flex-wrap:wrap;">
                <button class="btn btn-success" onclick="approveUpsell('${u.id}')">‚úì Approve ($${(u.estimated_cost || 0).toFixed(2)})</button>
                <button class="btn btn-secondary" onclick="declineUpsell('${u.id}')">‚úó Decline</button>
                <button class="btn btn-ghost" onclick="rebidUpsell('${u.id}', '${u.title.replace(/'/g, "\\'")}', ${u.estimated_cost || 0})">üîÑ Get Competing Bids</button>
              </div>
            ` : `
              <div style="padding:12px;background:${u.status === 'approved' ? 'var(--accent-green-soft)' : 'var(--bg-input)'};border-radius:var(--radius-md);color:${u.status === 'approved' ? 'var(--accent-green)' : 'var(--text-muted)'};">
                ${u.status === 'approved' ? '‚úì Approved' : u.status === 'declined' ? '‚úó Declined' : u.status === 'rebid' ? 'üîÑ Sent for competing bids' : u.status === 'expired' ? '‚è∞ Expired' : u.status}
                ${u.responded_at ? ` on ${new Date(u.responded_at).toLocaleDateString()}` : ''}
              </div>
            `}
          </div>
        `;
      }).join('');
    }

    function getTimeRemaining(expiresAt) {
      const now = new Date();
      const expiry = new Date(expiresAt);
      const diff = expiry - now;
      if (diff <= 0) return null;
      const hours = Math.floor(diff / (1000 * 60 * 60));
      const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
      if (hours > 0) return `${hours}h ${minutes}m left`;
      return `${minutes}m left`;
    }

    async function approveUpsell(upsellId) {
      const upsell = upsellRequests.find(u => u.id === upsellId);
      if (!confirm(`Approve this additional work for $${(upsell?.estimated_cost || 0).toFixed(2)}?\n\nThis amount will be added to your escrow payment.`)) return;

      await supabaseClient.from('upsell_requests').update({
        status: 'approved',
        responded_at: new Date().toISOString()
      }).eq('id', upsellId);

      // Update payment to add upsell amount
      if (upsell?.package_id) {
        const { data: payment } = await supabaseClient.from('payments')
          .select('*')
          .eq('package_id', upsell.package_id)
          .single();
        
        if (payment) {
          const newTotal = (payment.amount_total || 0) + (upsell.estimated_cost || 0);
          const mccFee = newTotal * 0.02;
          const providerAmount = newTotal - mccFee;
          
          await supabaseClient.from('payments').update({
            amount_total: newTotal,
            amount_provider: providerAmount,
            amount_mcc_fee: mccFee
          }).eq('id', payment.id);
        }
      }

      showToast('Additional work approved. Payment updated.', 'success');
      await loadUpsellRequests();
    }

    async function declineUpsell(upsellId) {
      if (!confirm('Decline this additional work?\n\nThe provider will proceed with only the original scope.')) return;

      await supabaseClient.from('upsell_requests').update({
        status: 'declined',
        responded_at: new Date().toISOString()
      }).eq('id', upsellId);

      showToast('Additional work declined. Original service will continue.', 'success');
      await loadUpsellRequests();
    }

    async function rebidUpsell(upsellId, title, estimatedCost) {
      if (!confirm(`Create a new package to get competing bids on "${title}"?\n\nOther providers can bid on this work.`)) return;

      const upsell = upsellRequests.find(u => u.id === upsellId);
      const pkg = packages.find(p => p.id === upsell?.package_id);

      // Create new package for the upsell work
      const { data: newPkg } = await supabaseClient.from('maintenance_packages').insert({
        member_id: currentUser.id,
        vehicle_id: pkg?.vehicle_id,
        title: `Rebid: ${title}`,
        description: `Getting competitive bids for: ${upsell?.description || title}\n\nOriginal estimate from previous provider: $${estimatedCost.toFixed(2)}`,
        category: 'other',
        service_type: 'Custom request',
        frequency: 'one_time',
        parts_preference: 'standard',
        pickup_preference: 'either',
        status: 'open'
      }).select().single();

      // Update upsell request
      await supabaseClient.from('upsell_requests').update({
        status: 'rebid',
        responded_at: new Date().toISOString(),
        rebid_package_id: newPkg?.id
      }).eq('id', upsellId);

      showToast('New package created for competitive bidding!', 'success');
      await loadUpsellRequests();
      await loadPackages();
    }

    async function loadPackages() {
      const { data } = await supabaseClient.from('maintenance_packages').select('*, vehicles(nickname, year, make, model)').eq('member_id', currentUser.id).order('created_at', { ascending: false });
      packages = data || [];
      
      // Fetch bid counts for all packages
      if (packages.length > 0) {
        const packageIds = packages.map(p => p.id);
        const { data: bidsData } = await supabaseClient
          .from('bids')
          .select('package_id')
          .in('package_id', packageIds);
        
        // Count bids per package
        const bidCounts = {};
        (bidsData || []).forEach(bid => {
          bidCounts[bid.package_id] = (bidCounts[bid.package_id] || 0) + 1;
        });
        
        // Attach bid count to each package
        packages.forEach(p => {
          p.bid_count = bidCounts[p.id] || 0;
        });
      }
      
      renderPackages();
      renderRecentActivity();
    }

    async function loadConversations() {
      try {
        // Get all messages where user is sender or recipient
        const { data: messages, error } = await supabaseClient
          .from('messages')
          .select('*, maintenance_packages(id, title)')
          .or(`sender_id.eq.${currentUser.id},recipient_id.eq.${currentUser.id}`)
          .order('created_at', { ascending: false });

        if (error) {
          console.error('Error loading conversations:', error);
          return;
        }

        // Group by package_id and get the other party
        const conversationMap = new Map();
        
        for (const msg of messages || []) {
          const key = msg.package_id;
          const otherPartyId = msg.sender_id === currentUser.id ? msg.recipient_id : msg.sender_id;
          
          if (!conversationMap.has(key)) {
            conversationMap.set(key, {
              packageId: msg.package_id,
              packageTitle: msg.maintenance_packages?.title || 'Unknown Package',
              otherPartyId,
              lastMessage: msg.content,
              lastMessageTime: msg.created_at,
              unread: msg.recipient_id === currentUser.id && !msg.read_at
            });
          }
        }

        // Fetch provider alias for each conversation
        const conversations = Array.from(conversationMap.values());
        const providerIds = [...new Set(conversations.map(c => c.otherPartyId))];
        
        if (providerIds.length > 0) {
          const { data: providers } = await supabaseClient
            .from('profiles')
            .select('id, provider_alias')
            .in('id', providerIds);

          const providerMap = new Map(providers?.map(p => [p.id, p]) || []);
          
          conversations.forEach(c => {
            const provider = providerMap.get(c.otherPartyId);
            // Use alias, never real business name
            c.providerName = provider?.provider_alias || `Provider #${c.otherPartyId.slice(0,4).toUpperCase()}`;
          });
        }

        renderConversations(conversations);
        
        // Update unread badge
        const unreadCount = conversations.filter(c => c.unread).length;
        const badge = document.getElementById('message-count');
        if (unreadCount > 0) {
          badge.textContent = unreadCount;
          badge.style.display = 'inline';
        } else {
          badge.style.display = 'none';
        }
      } catch (err) {
        console.error('loadConversations error:', err);
      }
    }

    function renderConversations(conversations) {
      const container = document.getElementById('conversations-list');
      
      if (!conversations.length) {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üí¨</div><p>No conversations yet. Messages will appear here when you communicate with providers.</p></div>';
        return;
      }

      container.innerHTML = conversations.map(c => `
        <div class="conversation-card" onclick="openMessageWithProvider('${c.packageId}', '${c.otherPartyId}')" style="background:var(--bg-card);border:1px solid var(--border-subtle);border-radius:var(--radius-md);padding:16px 20px;margin-bottom:12px;cursor:pointer;transition:all 0.15s;">
          <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px;">
            <div>
              <div style="font-weight:600;margin-bottom:2px;">${c.providerName}</div>
              <div style="font-size:0.85rem;color:var(--text-muted);">Re: ${c.packageTitle}</div>
            </div>
            <div style="text-align:right;">
              <div style="font-size:0.8rem;color:var(--text-muted);">${formatMessageTime(c.lastMessageTime)}</div>
              ${c.unread ? '<span style="display:inline-block;width:10px;height:10px;background:var(--accent-gold);border-radius:50%;margin-top:4px;"></span>' : ''}
            </div>
          </div>
          <div style="font-size:0.9rem;color:var(--text-secondary);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">
            ${c.lastMessage}
          </div>
        </div>
      `).join('');
    }

    function formatMessageTime(timestamp) {
      const date = new Date(timestamp);
      const now = new Date();
      const diff = now - date;
      
      if (diff < 60000) return 'Just now';
      if (diff < 3600000) return Math.floor(diff / 60000) + 'm ago';
      if (diff < 86400000) return Math.floor(diff / 3600000) + 'h ago';
      if (diff < 604800000) return Math.floor(diff / 86400000) + 'd ago';
      return date.toLocaleDateString();
    }

    async function loadReminders() {
      const dismissedIds = getDismissedReminderIds();
      const snoozedIds = getSnoozedReminderIds();
      reminders = [];
      
      vehicles.forEach(v => {
        const vehicleName = v.nickname || `${v.year} ${v.make} ${v.model}`;
        
        if (v.registration_expiration) {
          const expDate = new Date(v.registration_expiration);
          const daysUntil = Math.ceil((expDate - new Date()) / (1000 * 60 * 60 * 24));
          if (daysUntil <= 60) {
            const reminderId = `reg-${v.id}`;
            if (!dismissedIds.includes(reminderId) && !snoozedIds.includes(reminderId)) {
              reminders.push({
                id: reminderId,
                vehicleId: v.id,
                vehicleName,
                type: 'registration',
                title: 'Registration Renewal',
                dueDate: v.registration_expiration,
                daysUntil,
                status: daysUntil < 0 ? 'overdue' : daysUntil <= 14 ? 'due' : 'ok'
              });
            }
          }
        }
        
        if (v.warranty_expiration) {
          const expDate = new Date(v.warranty_expiration);
          const daysUntil = Math.ceil((expDate - new Date()) / (1000 * 60 * 60 * 24));
          if (daysUntil <= 90 && daysUntil > -30) {
            const reminderId = `warranty-${v.id}`;
            if (!dismissedIds.includes(reminderId) && !snoozedIds.includes(reminderId)) {
              reminders.push({
                id: reminderId,
                vehicleId: v.id,
                vehicleName,
                type: 'warranty',
                title: 'Warranty Expiring',
                dueDate: v.warranty_expiration,
                daysUntil,
                status: daysUntil < 0 ? 'overdue' : daysUntil <= 30 ? 'due' : 'ok'
              });
            }
          }
        }
        
        if (v.mileage) {
          const nextOilChange = Math.ceil(v.mileage / 5000) * 5000;
          const milesUntil = nextOilChange - v.mileage;
          if (milesUntil <= 1000) {
            const reminderId = `oil-${v.id}`;
            if (!dismissedIds.includes(reminderId) && !snoozedIds.includes(reminderId)) {
              reminders.push({
                id: reminderId,
                vehicleId: v.id,
                vehicleName,
                type: 'oil_change',
                title: 'Oil Change Due',
                dueMileage: nextOilChange,
                milesUntil,
                status: milesUntil < 0 ? 'overdue' : 'due'
              });
            }
          }
        }
      });
      
      const vehicleIds = vehicles.map(v => v.id);
      if (vehicleIds.length > 0) {
        const { data: dbReminders } = await supabaseClient
          .from('reminders')
          .select('*, vehicles(nickname, year, make, model, mileage)')
          .in('vehicle_id', vehicleIds)
          .neq('status', 'completed');
        
        if (dbReminders) {
          dbReminders.forEach(r => {
            const reminderId = `db-${r.id}`;
            if (dismissedIds.includes(reminderId)) return;
            
            if (r.status === 'snoozed') {
              const snoozedUntil = getSnoozedUntilDate(reminderId);
              if (snoozedUntil && new Date() < new Date(snoozedUntil)) return;
            }
            
            const vehicleName = r.vehicles ? (r.vehicles.nickname || `${r.vehicles.year} ${r.vehicles.make} ${r.vehicles.model}`) : 'Unknown Vehicle';
            let status = 'ok';
            let daysUntil = null;
            let milesUntil = null;
            
            if (r.due_date) {
              const expDate = new Date(r.due_date);
              daysUntil = Math.ceil((expDate - new Date()) / (1000 * 60 * 60 * 24));
              status = daysUntil < 0 ? 'overdue' : daysUntil <= 14 ? 'due' : 'ok';
            }
            
            if (r.due_mileage && r.vehicles?.mileage) {
              milesUntil = r.due_mileage - r.vehicles.mileage;
              if (milesUntil < 0) status = 'overdue';
              else if (milesUntil <= 500) status = 'due';
            }
            
            reminders.push({
              id: reminderId,
              dbId: r.id,
              vehicleId: r.vehicle_id,
              vehicleName,
              type: r.reminder_type || 'other',
              title: r.title,
              description: r.description,
              dueDate: r.due_date,
              dueMileage: r.due_mileage,
              daysUntil,
              milesUntil,
              status,
              isFromDb: true
            });
          });
        }
      }
      
      updateShowDismissedButton();
      renderReminders();
      renderUpcomingReminders();
    }
    
    function getSnoozedReminderIds() {
      try {
        const snoozed = JSON.parse(localStorage.getItem('mcc_snoozed_reminders') || '{}');
        const now = new Date();
        return Object.entries(snoozed)
          .filter(([id, until]) => new Date(until) > now)
          .map(([id]) => id);
      } catch {
        return [];
      }
    }
    
    function getSnoozedUntilDate(reminderId) {
      try {
        const snoozed = JSON.parse(localStorage.getItem('mcc_snoozed_reminders') || '{}');
        return snoozed[reminderId];
      } catch {
        return null;
      }
    }
    
    async function snoozeReminder(reminderId, dbId) {
      const snoozedUntil = new Date();
      snoozedUntil.setDate(snoozedUntil.getDate() + 7);
      
      try {
        const snoozed = JSON.parse(localStorage.getItem('mcc_snoozed_reminders') || '{}');
        snoozed[reminderId] = snoozedUntil.toISOString();
        localStorage.setItem('mcc_snoozed_reminders', JSON.stringify(snoozed));
      } catch {}
      
      if (dbId) {
        await supabaseClient.from('reminders').update({ status: 'snoozed' }).eq('id', dbId);
      }
      
      reminders = reminders.filter(r => r.id !== reminderId);
      renderReminders();
      renderUpcomingReminders();
      updateStats();
      showToast('Reminder snoozed for 7 days');
    }
    
    function openCreateReminderModal() {
      const vehicleSelect = document.getElementById('reminder-vehicle');
      vehicleSelect.innerHTML = '<option value="">Select a vehicle...</option>' + 
        vehicles.map(v => `<option value="${v.id}">${v.nickname || `${v.year || ''} ${v.make} ${v.model}`.trim()}</option>`).join('');
      
      document.getElementById('reminder-title-input').value = '';
      document.getElementById('reminder-type-select').value = 'maintenance';
      document.getElementById('reminder-due-date').value = '';
      document.getElementById('reminder-due-mileage').value = '';
      document.getElementById('reminder-notes').value = '';
      document.querySelector('input[name="reminder-due-type"][value="date"]').checked = true;
      toggleReminderDueType();
      
      openModal('create-reminder-modal');
    }
    
    function toggleReminderDueType() {
      const dueType = document.querySelector('input[name="reminder-due-type"]:checked').value;
      document.getElementById('reminder-date-group').style.display = dueType === 'date' ? 'block' : 'none';
      document.getElementById('reminder-mileage-group').style.display = dueType === 'mileage' ? 'block' : 'none';
    }
    
    async function saveReminder() {
      const vehicleId = document.getElementById('reminder-vehicle').value;
      const title = document.getElementById('reminder-title-input').value.trim();
      const reminderType = document.getElementById('reminder-type-select').value;
      const dueType = document.querySelector('input[name="reminder-due-type"]:checked').value;
      const dueDate = document.getElementById('reminder-due-date').value;
      const dueMileage = document.getElementById('reminder-due-mileage').value;
      const notes = document.getElementById('reminder-notes').value.trim();
      
      if (!vehicleId) {
        showToast('Please select a vehicle', 'error');
        return;
      }
      if (!title) {
        showToast('Please enter a reminder title', 'error');
        return;
      }
      if (dueType === 'date' && !dueDate) {
        showToast('Please enter a due date', 'error');
        return;
      }
      if (dueType === 'mileage' && !dueMileage) {
        showToast('Please enter a due mileage', 'error');
        return;
      }
      
      const reminderData = {
        vehicle_id: vehicleId,
        title: title,
        reminder_type: reminderType,
        description: notes || null,
        due_date: dueType === 'date' ? dueDate : null,
        due_mileage: dueType === 'mileage' ? parseInt(dueMileage) : null,
        status: 'pending'
      };
      
      const { error } = await supabaseClient.from('reminders').insert(reminderData);
      
      if (error) {
        showToast('Failed to create reminder: ' + error.message, 'error');
        return;
      }
      
      closeModal('create-reminder-modal');
      showToast('Reminder created successfully', 'success');
      await loadReminders();
      updateStats();
    }

    function getDismissedReminderIds() {
      try {
        return JSON.parse(localStorage.getItem('mcc_dismissed_reminders') || '[]');
      } catch {
        return [];
      }
    }

    function dismissReminder(reminderId) {
      const dismissedIds = getDismissedReminderIds();
      if (!dismissedIds.includes(reminderId)) {
        dismissedIds.push(reminderId);
        localStorage.setItem('mcc_dismissed_reminders', JSON.stringify(dismissedIds));
      }
      reminders = reminders.filter(r => r.id !== reminderId);
      updateShowDismissedButton();
      renderReminders();
      renderUpcomingReminders();
      updateStats();
      showToast('Reminder dismissed');
    }

    function updateShowDismissedButton() {
      const dismissedIds = getDismissedReminderIds();
      const btn = document.getElementById('show-dismissed-btn');
      if (btn) {
        btn.style.display = dismissedIds.length > 0 ? 'block' : 'none';
      }
    }

    let showingDismissed = false;
    function toggleDismissedReminders() {
      showingDismissed = !showingDismissed;
      const btn = document.getElementById('show-dismissed-btn');
      if (showingDismissed) {
        btn.textContent = 'Hide dismissed';
        localStorage.removeItem('mcc_dismissed_reminders');
        loadReminders();
        showToast('Dismissed reminders restored');
      } else {
        btn.textContent = 'Show dismissed';
        loadReminders();
      }
    }

    async function loadServiceHistory() {
      const { data } = await supabaseClient.from('service_history').select('*, vehicles(nickname, year, make, model)').eq('vehicles.owner_id', currentUser.id).order('service_date', { ascending: false });
      serviceHistory = data || [];
      renderServiceHistory();
    }

    // ========== SERVICE RECOMMENDATIONS ==========
    let recommendations = [];

    async function loadRecommendations() {
      try {
        const vehicleIds = vehicles.map(v => v.id);
        if (vehicleIds.length === 0) {
          recommendations = [];
          renderRecommendations();
          return;
        }

        const { data, error } = await supabaseClient
          .from('service_recommendations')
          .select('*, vehicles(id, nickname, year, make, model)')
          .in('vehicle_id', vehicleIds)
          .eq('is_dismissed', false)
          .order('priority', { ascending: true })
          .order('created_at', { ascending: false });

        if (error) {
          console.log('service_recommendations table may not exist:', error);
          await generateLocalRecommendations();
          return;
        }

        recommendations = data || [];
        if (recommendations.length === 0) {
          await generateLocalRecommendations();
        } else {
          renderRecommendations();
        }
      } catch (err) {
        console.log('loadRecommendations error:', err);
        await generateLocalRecommendations();
      }
    }

    async function generateLocalRecommendations() {
      recommendations = [];
      const now = new Date();

      for (const vehicle of vehicles) {
        const vehicleName = vehicle.nickname || `${vehicle.year || ''} ${vehicle.make} ${vehicle.model}`.trim();
        const mileage = vehicle.mileage || vehicle.current_mileage || 0;

        if (vehicle.last_oil_change_date) {
          const lastOilChange = new Date(vehicle.last_oil_change_date);
          const monthsSince = (now - lastOilChange) / (1000 * 60 * 60 * 24 * 30);
          if (monthsSince > 6) {
            recommendations.push({
              id: `local-oil-${vehicle.id}`,
              vehicle_id: vehicle.id,
              vehicles: { id: vehicle.id, nickname: vehicle.nickname, year: vehicle.year, make: vehicle.make, model: vehicle.model },
              service_type: 'Oil Change',
              priority: monthsSince > 9 ? 'urgent' : 'soon',
              reason: `Last oil change was ${Math.floor(monthsSince)} months ago`,
              estimated_cost_low: 35,
              estimated_cost_high: 85,
              source: 'time',
              isLocal: true
            });
          }
        } else if (!vehicle.last_oil_change_date && mileage > 0) {
          recommendations.push({
            id: `local-oil-unknown-${vehicle.id}`,
            vehicle_id: vehicle.id,
            vehicles: { id: vehicle.id, nickname: vehicle.nickname, year: vehicle.year, make: vehicle.make, model: vehicle.model },
            service_type: 'Oil Change',
            priority: 'upcoming',
            reason: 'No oil change records found - consider scheduling soon',
            estimated_cost_low: 35,
            estimated_cost_high: 85,
            source: 'time',
            isLocal: true
          });
        }

        if (vehicle.last_tire_rotation_date) {
          const lastRotation = new Date(vehicle.last_tire_rotation_date);
          const monthsSince = (now - lastRotation) / (1000 * 60 * 60 * 24 * 30);
          if (monthsSince > 6) {
            recommendations.push({
              id: `local-tire-${vehicle.id}`,
              vehicle_id: vehicle.id,
              vehicles: { id: vehicle.id, nickname: vehicle.nickname, year: vehicle.year, make: vehicle.make, model: vehicle.model },
              service_type: 'Tire Rotation',
              priority: monthsSince > 12 ? 'soon' : 'routine',
              reason: `Last tire rotation was ${Math.floor(monthsSince)} months ago`,
              estimated_cost_low: 25,
              estimated_cost_high: 50,
              source: 'time',
              isLocal: true
            });
          }
        }

        if (vehicle.last_brake_service_date) {
          const lastBrake = new Date(vehicle.last_brake_service_date);
          const monthsSince = (now - lastBrake) / (1000 * 60 * 60 * 24 * 30);
          if (monthsSince > 24) {
            recommendations.push({
              id: `local-brake-${vehicle.id}`,
              vehicle_id: vehicle.id,
              vehicles: { id: vehicle.id, nickname: vehicle.nickname, year: vehicle.year, make: vehicle.make, model: vehicle.model },
              service_type: 'Brake Inspection',
              priority: monthsSince > 36 ? 'urgent' : 'soon',
              reason: `Last brake service was ${Math.floor(monthsSince)} months ago`,
              estimated_cost_low: 50,
              estimated_cost_high: 400,
              source: 'time',
              isLocal: true
            });
          }
        }

        if (mileage > 30000 && !vehicle.last_transmission_service_date) {
          recommendations.push({
            id: `local-trans-${vehicle.id}`,
            vehicle_id: vehicle.id,
            vehicles: { id: vehicle.id, nickname: vehicle.nickname, year: vehicle.year, make: vehicle.make, model: vehicle.model },
            service_type: 'Transmission Service',
            priority: mileage > 60000 ? 'soon' : 'routine',
            reason: `At ${mileage.toLocaleString()} miles, consider a transmission fluid check`,
            estimated_cost_low: 100,
            estimated_cost_high: 250,
            source: 'mileage',
            isLocal: true
          });
        }

        if (mileage > 50000 && !vehicle.last_coolant_flush_date) {
          recommendations.push({
            id: `local-coolant-${vehicle.id}`,
            vehicle_id: vehicle.id,
            vehicles: { id: vehicle.id, nickname: vehicle.nickname, year: vehicle.year, make: vehicle.make, model: vehicle.model },
            service_type: 'Coolant Flush',
            priority: 'routine',
            reason: `At ${mileage.toLocaleString()} miles, a coolant flush is recommended`,
            estimated_cost_low: 100,
            estimated_cost_high: 200,
            source: 'mileage',
            isLocal: true
          });
        }
      }

      const priorityOrder = { urgent: 0, soon: 1, upcoming: 2, routine: 3 };
      recommendations.sort((a, b) => priorityOrder[a.priority] - priorityOrder[b.priority]);

      renderRecommendations();
    }

    async function generateRecommendations(vehicleId) {
      const vehicle = vehicles.find(v => v.id === vehicleId);
      if (!vehicle) return;

      const now = new Date();
      const vehicleName = vehicle.nickname || `${vehicle.year || ''} ${vehicle.make} ${vehicle.model}`.trim();
      const mileage = vehicle.mileage || vehicle.current_mileage || 0;
      const newRecs = [];

      if (vehicle.last_oil_change_date) {
        const lastOilChange = new Date(vehicle.last_oil_change_date);
        const monthsSince = (now - lastOilChange) / (1000 * 60 * 60 * 24 * 30);
        if (monthsSince > 6) {
          newRecs.push({
            vehicle_id: vehicleId,
            service_type: 'Oil Change',
            priority: monthsSince > 9 ? 'urgent' : 'soon',
            reason: `Last oil change was ${Math.floor(monthsSince)} months ago`,
            estimated_cost_low: 35,
            estimated_cost_high: 85,
            source: 'time'
          });
        }
      }

      if (vehicle.last_tire_rotation_date) {
        const lastRotation = new Date(vehicle.last_tire_rotation_date);
        const monthsSince = (now - lastRotation) / (1000 * 60 * 60 * 24 * 30);
        if (monthsSince > 6) {
          newRecs.push({
            vehicle_id: vehicleId,
            service_type: 'Tire Rotation',
            priority: monthsSince > 12 ? 'soon' : 'routine',
            reason: `Last tire rotation was ${Math.floor(monthsSince)} months ago`,
            estimated_cost_low: 25,
            estimated_cost_high: 50,
            source: 'time'
          });
        }
      }

      if (vehicle.last_brake_service_date) {
        const lastBrake = new Date(vehicle.last_brake_service_date);
        const monthsSince = (now - lastBrake) / (1000 * 60 * 60 * 24 * 30);
        if (monthsSince > 24) {
          newRecs.push({
            vehicle_id: vehicleId,
            service_type: 'Brake Inspection',
            priority: monthsSince > 36 ? 'urgent' : 'soon',
            reason: `Last brake service was ${Math.floor(monthsSince)} months ago`,
            estimated_cost_low: 50,
            estimated_cost_high: 400,
            source: 'time'
          });
        }
      }

      if (mileage > 30000 && !vehicle.last_transmission_service_date) {
        newRecs.push({
          vehicle_id: vehicleId,
          service_type: 'Transmission Service',
          priority: mileage > 60000 ? 'soon' : 'routine',
          reason: `At ${mileage.toLocaleString()} miles, consider a transmission fluid check`,
          estimated_cost_low: 100,
          estimated_cost_high: 250,
          source: 'mileage'
        });
      }

      if (mileage > 50000 && !vehicle.last_coolant_flush_date) {
        newRecs.push({
          vehicle_id: vehicleId,
          service_type: 'Coolant Flush',
          priority: 'routine',
          reason: `At ${mileage.toLocaleString()} miles, a coolant flush is recommended`,
          estimated_cost_low: 100,
          estimated_cost_high: 200,
          source: 'mileage'
        });
      }

      for (const rec of newRecs) {
        try {
          const { data: existing } = await supabaseClient
            .from('service_recommendations')
            .select('id')
            .eq('vehicle_id', vehicleId)
            .eq('service_type', rec.service_type)
            .eq('is_dismissed', false)
            .single();

          if (existing) {
            await supabaseClient
              .from('service_recommendations')
              .update({ priority: rec.priority, reason: rec.reason })
              .eq('id', existing.id);
          } else {
            await supabaseClient
              .from('service_recommendations')
              .insert(rec);
          }
        } catch (err) {
          console.log('Could not save recommendation to database:', err);
        }
      }

      await loadRecommendations();
    }

    async function refreshAllRecommendations() {
      showToast('Refreshing recommendations...', 'success');
      for (const vehicle of vehicles) {
        await generateRecommendations(vehicle.id);
      }
      await loadRecommendations();
      showToast('Recommendations updated', 'success');
    }

    function getRecommendationIcon(serviceType) {
      const icons = {
        'Oil Change': 'üõ¢Ô∏è',
        'Tire Rotation': 'üîÑ',
        'Brake Inspection': 'üõë',
        'Brake Service': 'üõë',
        'Transmission Service': '‚öôÔ∏è',
        'Coolant Flush': 'üíß',
        'Air Filter': 'üå¨Ô∏è',
        'Battery Check': 'üîã',
        'Alignment': 'üìê',
        'Inspection': 'üîç',
        'Tune-Up': 'üîß',
        'default': 'üîß'
      };
      return icons[serviceType] || icons['default'];
    }

    function renderRecommendations() {
      const container = document.getElementById('recommendations-list');

      if (!recommendations.length) {
        container.innerHTML = `
          <div class="empty-state" style="padding:24px;">
            <div class="empty-state-icon">‚úÖ</div>
            <p>No service recommendations at this time.</p>
            <p style="font-size:0.85rem;margin-top:8px;">Recommendations will appear based on your vehicle data and service history.</p>
          </div>`;
        return;
      }

      const groupedByVehicle = {};
      recommendations.forEach(rec => {
        const vId = rec.vehicle_id;
        if (!groupedByVehicle[vId]) {
          groupedByVehicle[vId] = {
            vehicle: rec.vehicles,
            recs: []
          };
        }
        groupedByVehicle[vId].recs.push(rec);
      });

      let html = '';
      Object.entries(groupedByVehicle).forEach(([vehicleId, group]) => {
        const vehicleName = group.vehicle ? 
          (group.vehicle.nickname || `${group.vehicle.year || ''} ${group.vehicle.make} ${group.vehicle.model}`.trim()) : 
          'Unknown Vehicle';

        if (Object.keys(groupedByVehicle).length > 1) {
          html += `<div class="recommendation-vehicle">üöó ${vehicleName}</div>`;
        }

        group.recs.forEach(rec => {
          const icon = getRecommendationIcon(rec.service_type);
          const priorityClass = rec.priority || 'routine';
          const costRange = (rec.estimated_cost_low && rec.estimated_cost_high) 
            ? `$${rec.estimated_cost_low} - $${rec.estimated_cost_high}` 
            : '';
          const dueInfo = rec.due_date 
            ? `Due: ${new Date(rec.due_date).toLocaleDateString()}` 
            : (rec.due_mileage ? `Due at ${rec.due_mileage.toLocaleString()} miles` : '');

          html += `
            <div class="recommendation-item priority-${priorityClass}">
              <div class="recommendation-icon ${priorityClass}">${icon}</div>
              <div class="recommendation-content">
                <div class="recommendation-header">
                  <span class="recommendation-title">${rec.service_type}</span>
                  <span class="recommendation-priority ${priorityClass}">${priorityClass}</span>
                </div>
                <div class="recommendation-reason">${rec.reason || 'Regular maintenance recommended'}</div>
                <div class="recommendation-meta">
                  ${costRange ? `<span>üí∞ ${costRange}</span>` : ''}
                  ${dueInfo ? `<span>üìÖ ${dueInfo}</span>` : ''}
                  ${rec.source ? `<span>üìä ${rec.source === 'time' ? 'Time-based' : rec.source === 'mileage' ? 'Mileage-based' : rec.source === 'inspection' ? 'Inspection' : 'Manual'}</span>` : ''}
                </div>
                <div class="recommendation-actions">
                  <button class="btn btn-primary btn-sm" onclick="scheduleFromRecommendation('${rec.vehicle_id}', '${rec.service_type.replace(/'/g, "\\'")}')">üìÖ Schedule Service</button>
                  <button class="btn btn-ghost btn-sm" onclick="dismissRecommendation('${rec.id}', ${rec.isLocal || false})">Dismiss</button>
                </div>
              </div>
            </div>
          `;
        });
      });

      container.innerHTML = html;
    }

    function scheduleFromRecommendation(vehicleId, serviceType) {
      openPackageModal();
      setTimeout(() => {
        const vehicleSelect = document.getElementById('p-vehicle');
        if (vehicleSelect) vehicleSelect.value = vehicleId;
        const titleInput = document.getElementById('p-title');
        if (titleInput) titleInput.value = serviceType;
        const categorySelect = document.getElementById('p-category');
        if (categorySelect) categorySelect.value = 'maintenance';
      }, 100);
    }

    async function dismissRecommendation(recId, isLocal = false) {
      if (isLocal) {
        recommendations = recommendations.filter(r => r.id !== recId);
        renderRecommendations();
        showToast('Recommendation dismissed');
        return;
      }

      try {
        const { error } = await supabaseClient
          .from('service_recommendations')
          .update({ is_dismissed: true, dismissed_at: new Date().toISOString() })
          .eq('id', recId);

        if (error) throw error;

        recommendations = recommendations.filter(r => r.id !== recId);
        renderRecommendations();
        showToast('Recommendation dismissed');
      } catch (err) {
        console.log('Could not dismiss recommendation:', err);
        recommendations = recommendations.filter(r => r.id !== recId);
        renderRecommendations();
        showToast('Recommendation dismissed');
      }
    }

    async function updateStats() {
      document.getElementById('stat-vehicles').textContent = vehicles.length;
      document.getElementById('stat-packages').textContent = packages.filter(p => ['open', 'pending', 'accepted', 'in_progress'].includes(p.status)).length;
      document.getElementById('stat-reminders').textContent = reminders.filter(r => r.status === 'due' || r.status === 'overdue').length;
      document.getElementById('stat-completed').textContent = packages.filter(p => p.status === 'completed').length;
      
      // Calculate total bids received across all open packages
      const totalBids = packages
        .filter(p => p.status === 'open')
        .reduce((sum, p) => sum + (p.bid_count || 0), 0);
      document.getElementById('stat-bids').textContent = totalBids;
      
      // Load provider count
      try {
        const { count } = await supabaseClient.from('profiles').select('*', { count: 'exact', head: true }).eq('role', 'provider').eq('is_suspended', false);
        document.getElementById('stat-providers').textContent = count || 0;
      } catch (e) {
        document.getElementById('stat-providers').textContent = '--';
      }
      
      // Update nav badges
      const reminderCount = reminders.filter(r => r.status === 'due' || r.status === 'overdue').length;
      const reminderBadge = document.getElementById('reminder-count');
      if (reminderCount > 0) {
        reminderBadge.textContent = reminderCount;
        reminderBadge.style.display = 'inline';
      }
    }

    // ========== RENDERING ==========
    function renderVehicles() {
      const grid = document.getElementById('vehicles-grid');
      if (!vehicles.length) {
        grid.innerHTML = `
          <div class="empty-state" style="grid-column: 1 / -1; padding: 60px 20px;">
            <div class="empty-state-icon" style="font-size: 64px; margin-bottom: 20px;">üöó</div>
            <h3 style="font-size: 1.3rem; margin-bottom: 8px;">No vehicles yet</h3>
            <p style="color: var(--text-muted); margin-bottom: 24px;">Add your first vehicle to get started with maintenance tracking.</p>
            <button class="btn btn-primary" onclick="openVehicleModal()" style="padding: 14px 28px; font-size: 1rem;">+ Add Your First Vehicle</button>
          </div>`;
        return;
      }
      grid.innerHTML = vehicles.map(v => {
        const healthClass = v.health_score >= 90 ? 'excellent' : v.health_score >= 70 ? 'good' : v.health_score >= 50 ? 'fair' : 'poor';
        const healthLabel = v.health_score >= 90 ? 'Excellent' : v.health_score >= 70 ? 'Good' : v.health_score >= 50 ? 'Fair' : 'Needs Attention';
        const vehicleTitle = `${v.year || ''} ${v.make} ${v.model}`.trim();
        const vehicleSubtitle = `${v.year || ''} ${v.make} ${v.model} ${v.trim || ''} ${v.color ? '‚Ä¢ ' + v.color : ''}`.trim();
        const photoContent = v.photo_url 
          ? `<img src="${v.photo_url}" alt="${vehicleTitle}" style="width:100%;height:100%;object-fit:cover;">`
          : `<span class="vehicle-emoji">üöó</span>`;
        return `
          <div class="vehicle-card">
            <div class="vehicle-card-photo">
              ${photoContent}
              <span class="vehicle-card-badge ${healthClass}">${healthLabel}</span>
            </div>
            <div class="vehicle-card-body">
              <div class="vehicle-card-title">${v.nickname || vehicleTitle}</div>
              <div class="vehicle-card-subtitle">${vehicleSubtitle}</div>
              <div class="vehicle-card-meta">
                <span>üè∑Ô∏è ${v.mileage ? v.mileage.toLocaleString() + ' mi' : 'No mileage'}</span>
                ${v.vin ? `<span>VIN: ...${v.vin.slice(-6)}</span>` : ''}
              </div>
              <div class="vehicle-card-actions">
                <button class="btn btn-secondary btn-sm" onclick="viewVehicleDetails('${v.id}')" style="flex: 1;">View Details</button>
                <button class="btn btn-primary btn-sm" onclick="createPackageForVehicle('${v.id}')" style="flex: 1;">+ Service</button>
                <button class="btn btn-ghost btn-sm" onclick="generateHealthReportPDF('${v.id}')" title="Download Health Report" style="padding: 8px;">üìÑ</button>
                <button class="btn btn-ghost btn-sm" onclick="deleteVehicle('${v.id}')" title="Delete" style="padding: 8px;">üóëÔ∏è</button>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    function renderPackages() {
      const list = document.getElementById('packages-list');
      let filtered = packages;
      
      if (currentPackageFilter === 'open') filtered = packages.filter(p => p.status === 'open');
      else if (currentPackageFilter === 'active') filtered = packages.filter(p => ['pending', 'accepted', 'in_progress'].includes(p.status));
      else if (currentPackageFilter === 'completed') filtered = packages.filter(p => p.status === 'completed');

      if (!filtered.length) {
        list.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì¶</div><p>No packages in this category.</p></div>';
        return;
      }

      list.innerHTML = filtered.map(p => {
        const vehicle = p.vehicles;
        const vehicleName = vehicle ? (vehicle.nickname || `${vehicle.year || ''} ${vehicle.make} ${vehicle.model}`.trim()) : 'Unknown Vehicle';
        
        // Check if bidding has expired (but package still shows as 'open')
        const isExpired = p.status === 'open' && p.bidding_deadline && new Date(p.bidding_deadline) < new Date();
        const displayStatus = isExpired ? 'expired' : p.status;
        const statusClass = displayStatus === 'open' ? 'open' : displayStatus === 'completed' ? 'completed' : displayStatus === 'expired' ? 'expired' : ['pending', 'accepted'].includes(displayStatus) ? 'pending' : 'accepted';
        
        // Countdown timer for open packages
        let countdownHtml = '';
        if (p.status === 'open' && p.bidding_deadline) {
          const countdown = formatCountdown(p.bidding_deadline);
          const urgentClass = countdown.expired ? 'expired' : countdown.urgent ? 'urgent' : '';
          countdownHtml = `<span class="countdown-timer ${urgentClass}">‚è±Ô∏è ${countdown.text}</span>`;
        }
        
        // Repost button for expired packages
        const repostButton = isExpired ? `<button class="btn btn-primary btn-sm" onclick="repostPackage('${p.id}')">üîÑ Repost</button>` : '';
        
        // Extend deadline button for open (non-expired) packages
        const extendButton = (p.status === 'open' && !isExpired) ? `<button class="btn btn-ghost btn-sm" onclick="extendDeadline('${p.id}')" title="Add more time">‚è±Ô∏è+</button>` : '';
        
        return `
          <div class="package-card">
            <div class="package-header">
              <div>
                <div class="package-title">${p.title}</div>
                <div class="package-vehicle">${vehicleName}</div>
              </div>
              <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px;">
                <span class="package-status ${statusClass}">${displayStatus}</span>
                ${countdownHtml}
              </div>
            </div>
            <div class="package-meta">
              <span>üìÖ ${new Date(p.created_at).toLocaleDateString()}</span>
              <span>üîÑ ${formatFrequency(p.frequency)}</span>
              <span>üîß ${p.parts_preference || 'Standard'} parts</span>
              <span>üöó ${formatPickup(p.pickup_preference)}</span>
            </div>
            ${p.description ? `<div class="package-description">${p.description}</div>` : ''}
            <div class="package-footer">
              <span class="bid-count">${isExpired ? 'Bidding ended' : (p.bid_count > 0 ? `üí¨ ${p.bid_count} bid${p.bid_count === 1 ? '' : 's'} received` : 'No bids yet')}</span>
              <div style="display:flex;gap:8px;">
                ${extendButton}
                ${repostButton}
                <button class="btn btn-secondary btn-sm" onclick="viewPackage('${p.id}')">Open ‚Üí</button>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    function renderRecentActivity() {
      const container = document.getElementById('recent-activity');
      const recent = packages.slice(0, 3);
      if (!recent.length) {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì¶</div><p>No recent activity.</p></div>';
        return;
      }
      container.innerHTML = recent.map(p => {
        const vehicle = p.vehicles;
        const vehicleName = vehicle ? (vehicle.nickname || `${vehicle.make} ${vehicle.model}`) : 'Vehicle';
        const bidInfo = p.status === 'open' && p.bid_count > 0 
          ? `<div style="color:var(--accent-gold);font-size:0.85rem;margin-top:4px;">üí¨ ${p.bid_count} bid${p.bid_count === 1 ? '' : 's'}</div>` 
          : '';
        return `
          <div class="package-card" style="margin-bottom:12px;padding:16px 20px;cursor:pointer;" onclick="viewPackage('${p.id}')">
            <div class="package-header" style="margin-bottom:8px;">
              <div>
                <div class="package-title" style="font-size:1rem;">${p.title}</div>
                <div class="package-vehicle">${vehicleName}</div>
                ${bidInfo}
              </div>
              <span class="package-status ${p.status}">${p.status}</span>
            </div>
          </div>
        `;
      }).join('');
    }

    function getReminderIcon(type) {
      const icons = {
        'registration': 'üìã',
        'oil_change': 'üõ¢Ô∏è',
        'warranty': 'üõ°Ô∏è',
        'maintenance': 'üîß',
        'inspection': 'üîç',
        'tire_rotation': 'üîÑ',
        'brake_check': 'üõë',
        'other': 'üìå'
      };
      return icons[type] || 'üîß';
    }
    
    function formatReminderType(type) {
      const labels = {
        'registration': 'Registration',
        'oil_change': 'Oil Change',
        'warranty': 'Warranty',
        'maintenance': 'Maintenance',
        'inspection': 'Inspection',
        'tire_rotation': 'Tire Rotation',
        'brake_check': 'Brake Check',
        'other': 'Other'
      };
      return labels[type] || type;
    }

    function renderReminders() {
      const list = document.getElementById('reminders-list');
      if (!reminders.length) {
        list.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üîî</div><p>No reminders. Your vehicles are up to date!</p></div>';
        return;
      }
      list.innerHTML = reminders.map(r => `
        <div class="reminder-item type-${r.type}">
          <div class="reminder-icon ${r.status}">
            ${getReminderIcon(r.type)}
          </div>
          <div class="reminder-content">
            <div class="reminder-title">
              ${r.title} - ${r.vehicleName}
              <span class="reminder-type-badge">${formatReminderType(r.type)}</span>
            </div>
            <div class="reminder-due">
              ${r.dueDate ? `Due: ${new Date(r.dueDate).toLocaleDateString()}${r.daysUntil !== null ? ` (${r.daysUntil > 0 ? r.daysUntil + ' days left' : r.daysUntil === 0 ? 'Today' : Math.abs(r.daysUntil) + ' days overdue'})` : ''}` : ''}
              ${r.dueMileage ? `Due at ${r.dueMileage.toLocaleString()} miles${r.milesUntil !== null ? ` (${r.milesUntil > 0 ? r.milesUntil.toLocaleString() + ' miles away' : 'Overdue'})` : ''}` : ''}
              ${r.description ? `<br><span style="color:var(--text-muted);font-size:0.8rem;">${r.description}</span>` : ''}
            </div>
          </div>
          <div class="reminder-actions">
            <button class="btn btn-sm btn-primary" onclick="createPackageFromReminder('${r.vehicleId}', '${r.title.replace(/'/g, "\\'")}')">Schedule</button>
            <button class="btn btn-sm btn-secondary" onclick="snoozeReminder('${r.id}', ${r.dbId ? `'${r.dbId}'` : 'null'})" title="Snooze for 7 days">üí§</button>
            <button class="btn btn-sm btn-ghost" onclick="dismissReminder('${r.id}')" title="Dismiss reminder">‚úï</button>
          </div>
        </div>
      `).join('');
    }

    function renderUpcomingReminders() {
      const container = document.getElementById('upcoming-reminders');
      const upcoming = reminders.filter(r => r.status === 'due' || r.status === 'overdue').slice(0, 3);
      if (!upcoming.length) {
        container.innerHTML = '<div class="empty-state" style="padding:24px"><div class="empty-state-icon">‚úÖ</div><p>All caught up!</p></div>';
        return;
      }
      container.innerHTML = upcoming.map(r => `
        <div class="reminder-item type-${r.type}">
          <div class="reminder-icon ${r.status}">
            ${getReminderIcon(r.type)}
          </div>
          <div class="reminder-content">
            <div class="reminder-title">${r.title} <span class="reminder-type-badge">${formatReminderType(r.type)}</span></div>
            <div class="reminder-due">${r.vehicleName}</div>
          </div>
          <div class="reminder-actions" style="margin-left:auto;">
            <button class="btn btn-sm btn-secondary" onclick="snoozeReminder('${r.id}', ${r.dbId ? `'${r.dbId}'` : 'null'})" title="Snooze for 7 days">üí§</button>
            <button class="btn btn-sm btn-ghost" onclick="dismissReminder('${r.id}')" title="Dismiss reminder">‚úï</button>
          </div>
        </div>
      `).join('');
    }

    function renderServiceHistory() {
      const list = document.getElementById('history-list');
      const filter = document.getElementById('history-vehicle-filter').value;
      let filtered = serviceHistory;
      if (filter) filtered = serviceHistory.filter(h => h.vehicle_id === filter);

      if (!filtered.length) {
        list.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìú</div><p>No service history yet. Completed packages will appear here.</p></div>';
        return;
      }
      list.innerHTML = filtered.map(h => {
        const date = new Date(h.service_date);
        return `
          <div class="history-item">
            <div class="history-date">
              <div class="history-date-day">${date.getDate()}</div>
              <div class="history-date-month">${date.toLocaleDateString('en-US', { month: 'short', year: '2-digit' })}</div>
            </div>
            <div class="history-content">
              <div class="history-title">${h.service_type || h.description}</div>
              <div class="history-details">
                ${h.vehicles ? (h.vehicles.nickname || `${h.vehicles.year} ${h.vehicles.make} ${h.vehicles.model}`) : ''}
                ${h.mileage_at_service ? ` ‚Ä¢ ${h.mileage_at_service.toLocaleString()} miles` : ''}
              </div>
            </div>
            <div class="history-cost">${h.cost ? '$' + h.cost.toFixed(2) : ''}</div>
          </div>
        `;
      }).join('');
    }

    function updateVehicleSelects() {
      const options = '<option value="">Select a vehicle...</option>' + vehicles.map(v => 
        `<option value="${v.id}">${v.nickname || `${v.year || ''} ${v.make} ${v.model}`.trim()}</option>`
      ).join('');
      document.getElementById('p-vehicle').innerHTML = options;
      document.getElementById('history-vehicle-filter').innerHTML = '<option value="">All Vehicles</option>' + vehicles.map(v => 
        `<option value="${v.id}">${v.nickname || `${v.year || ''} ${v.make} ${v.model}`.trim()}</option>`
      ).join('');
    }

    // ========== EVENT LISTENERS ==========
    function setupEventListeners() {
      // Navigation
      document.querySelectorAll('.nav-item[data-section]').forEach(item => {
        item.addEventListener('click', () => showSection(item.dataset.section));
      });

      // Package tabs
      document.querySelectorAll('.tab[data-tab]').forEach(tab => {
        tab.addEventListener('click', () => {
          document.querySelectorAll('.tab[data-tab]').forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          currentPackageFilter = tab.dataset.tab;
          renderPackages();
        });
      });

      // Upsell tabs
      document.querySelectorAll('.tab[data-upsell-filter]').forEach(tab => {
        tab.addEventListener('click', () => {
          document.querySelectorAll('.tab[data-upsell-filter]').forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          currentUpsellFilter = tab.dataset.upsellFilter;
          renderUpsells();
        });
      });

      // Parts tier selection
      document.querySelectorAll('.parts-tier').forEach(tier => {
        tier.addEventListener('click', () => {
          document.querySelectorAll('.parts-tier').forEach(t => t.classList.remove('selected'));
          tier.classList.add('selected');
          selectedPartsTier = tier.dataset.tier;
        });
      });

      // Bidding window selection
      document.querySelectorAll('.bid-window-option').forEach(opt => {
        opt.addEventListener('click', () => {
          document.querySelectorAll('.bid-window-option').forEach(o => o.classList.remove('selected'));
          opt.classList.add('selected');
          selectedBiddingWindowHours = parseInt(opt.dataset.hours);
        });
      });

      // Category change -> update service types
      document.getElementById('p-category').addEventListener('change', (e) => {
        const types = serviceTypes[e.target.value] || [];
        const options = types.map(t => {
          // Check if this is a separator (starts with ‚îÄ‚îÄ)
          if (t.startsWith('‚îÄ‚îÄ')) {
            return `<option value="" disabled style="font-weight:600;color:var(--accent-gold);background:var(--bg-elevated);">${t}</option>`;
          }
          return `<option value="${t}">${t}</option>`;
        }).join('');
        document.getElementById('p-service-type').innerHTML = '<option value="">Select service...</option>' + options;
        document.getElementById('insurance-section').style.display = e.target.value === 'accident_repair' ? 'block' : 'none';
      });

      // History filter
      document.getElementById('history-vehicle-filter').addEventListener('change', renderServiceHistory);

      // Close modals on backdrop click
      document.querySelectorAll('.modal-backdrop').forEach(backdrop => {
        backdrop.addEventListener('click', e => { if (e.target === backdrop) backdrop.classList.remove('active'); });
      });

      // Message input enter key
      document.getElementById('message-input').addEventListener('keypress', e => {
        if (e.key === 'Enter') sendMessage();
      });
    }

    // ========== NAVIGATION ==========
    function showSection(sectionId) {
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      document.getElementById(sectionId).classList.add('active');
      document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
      document.querySelector(`.nav-item[data-section="${sectionId}"]`)?.classList.add('active');
      document.getElementById('sidebar').classList.remove('open');
      
      // Reset scroll position to top
      document.querySelector('.main').scrollTop = 0;
      
      if (sectionId === 'emergency') {
        loadEmergencySection();
      }
      if (sectionId === 'destination-services') {
        loadDestinationServices();
      }
      if (sectionId === 'household') {
        loadHouseholdSection();
      }
      if (sectionId === 'fleet') {
        loadFleetSection();
      }
    }

    function toggleSidebar() { 
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('sidebar-overlay');
      sidebar.classList.toggle('open'); 
      if (sidebar.classList.contains('open')) {
        overlay.style.display = 'block';
        document.querySelector('.mobile-close').style.display = 'flex';
        document.body.classList.add('sidebar-open');
      } else {
        overlay.style.display = 'none';
        document.body.classList.remove('sidebar-open');
      }
    }

    // ========== MODALS ==========
    function openVehicleModal() {
      document.getElementById('vehicle-modal').classList.add('active');
      
      // Reset all form fields
      ['v-year','v-make','v-model','v-trim','v-color','v-nickname','v-mileage','v-vin'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = '';
      });
      
      // Reset dropdowns to initial state
      document.getElementById('v-make').innerHTML = '<option value="">Select Make</option>';
      document.getElementById('v-model').innerHTML = '<option value="">Select Model</option>';
      document.getElementById('v-trim').innerHTML = '<option value="">Select Trim (Optional)</option>';
      document.getElementById('v-make').disabled = true;
      document.getElementById('v-model').disabled = true;
      document.getElementById('v-trim').disabled = true;
      
      // Reset vehicle photo
      pendingVehiclePhoto = null;
      document.getElementById('vehicle-photo-preview').style.display = 'none';
      document.getElementById('vehicle-photo-preview').src = '';
      document.getElementById('vehicle-photo-placeholder').style.display = 'block';
      document.getElementById('vehicle-photo-remove').style.display = 'none';
      document.getElementById('vehicle-photo-upload-area').style.borderStyle = 'dashed';
    }

    function openPackageModal() {
      if (!vehicles.length) {
        showToast('Please add a vehicle first', 'error');
        return openVehicleModal();
      }
      document.getElementById('package-modal').classList.add('active');
      document.getElementById('p-vehicle').value = '';
      document.getElementById('p-title').value = '';
      document.getElementById('p-description').value = '';
      document.getElementById('p-category').value = 'maintenance';
      document.getElementById('p-category').dispatchEvent(new Event('change'));
      document.getElementById('p-frequency').value = 'one_time';
      document.getElementById('p-schedule').value = '';
      document.getElementById('p-pickup').value = 'either';
      selectedPartsTier = 'standard';
      document.querySelectorAll('.parts-tier').forEach(t => t.classList.toggle('selected', t.dataset.tier === 'standard'));
      selectedBiddingWindowHours = 72;
      document.querySelectorAll('.bid-window-option').forEach(o => o.classList.toggle('selected', o.dataset.hours === '72'));
      
      // Clear photos
      pendingPackagePhotos = [];
      document.getElementById('package-photo-previews').innerHTML = '';
    }

    function openModal(id) {
      document.getElementById(id).classList.add('active');
    }

    function closeModal(id) { 
      document.getElementById(id).classList.remove('active');
      if (id === 'view-package-modal' && driverLocationRefreshInterval) {
        clearInterval(driverLocationRefreshInterval);
        driverLocationRefreshInterval = null;
      }
    }

    function createPackageForVehicle(vehicleId) {
      openPackageModal();
      document.getElementById('p-vehicle').value = vehicleId;
    }

    function createPackageFromReminder(vehicleId, title) {
      openPackageModal();
      document.getElementById('p-vehicle').value = vehicleId;
      document.getElementById('p-title').value = title;
    }

    // ========== PACKAGE PHOTO HANDLING ==========
    function handlePackagePhotoSelect(event) {
      const files = Array.from(event.target.files);
      const maxPhotos = 5;
      
      if (pendingPackagePhotos.length + files.length > maxPhotos) {
        showToast(`Maximum ${maxPhotos} photos allowed`, 'error');
        return;
      }

      files.forEach(file => {
        if (file.size > 5 * 1024 * 1024) {
          showToast(`${file.name} is too large (max 5MB)`, 'error');
          return;
        }

        const reader = new FileReader();
        reader.onload = (e) => {
          pendingPackagePhotos.push({
            file: file,
            preview: e.target.result
          });
          renderPackagePhotoPreviews();
        };
        reader.readAsDataURL(file);
      });

      // Clear input so same file can be selected again
      event.target.value = '';
    }

    function renderPackagePhotoPreviews() {
      const container = document.getElementById('package-photo-preview');
      if (!container) return;
      
      if (!pendingPackagePhotos.length) {
        container.innerHTML = '';
        return;
      }

      container.innerHTML = pendingPackagePhotos.map((photo, index) => `
        <div style="position:relative;aspect-ratio:1;border-radius:var(--radius-sm);overflow:hidden;border:1px solid var(--border-subtle);">
          <img src="${photo.preview}" alt="Preview" style="width:100%;height:100%;object-fit:cover;">
          <button onclick="removePackagePhoto(${index})" style="position:absolute;top:4px;right:4px;width:24px;height:24px;background:rgba(0,0,0,0.7);color:white;border:none;border-radius:50%;cursor:pointer;font-size:14px;">√ó</button>
        </div>
      `).join('');
    }

    function removePackagePhoto(index) {
      pendingPackagePhotos.splice(index, 1);
      renderPackagePhotoPreviews();
    }

    async function uploadPackagePhotos(packageId) {
      if (!pendingPackagePhotos.length) return;

      for (const photo of pendingPackagePhotos) {
        try {
          const fileName = `${packageId}/${Date.now()}-${photo.file.name}`;
          
          // Upload to Supabase Storage
          const { data, error } = await supabaseClient.storage
            .from('package-photos')
            .upload(fileName, photo.file);
          
          if (error) {
            console.error('Upload error:', error);
            continue;
          }

          // Get public URL
          const { data: urlData } = supabaseClient.storage
            .from('package-photos')
            .getPublicUrl(fileName);

          // Save to package_photos table
          await supabaseClient.from('package_photos').insert({
            package_id: packageId,
            url: urlData.publicUrl,
            file_name: photo.file.name,
            file_size: photo.file.size,
            photo_type: 'issue'
          });
        } catch (err) {
          console.error('Error uploading photo:', err);
        }
      }
    }

    // ========== VEHICLE PHOTO HANDLING ==========
    function handleVehiclePhotoSelect(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      if (file.size > 5 * 1024 * 1024) {
        showToast('Photo is too large (max 5MB)', 'error');
        return;
      }

      const reader = new FileReader();
      reader.onload = (e) => {
        pendingVehiclePhoto = {
          file: file,
          preview: e.target.result
        };
        
        // Update UI
        document.getElementById('vehicle-photo-preview').src = e.target.result;
        document.getElementById('vehicle-photo-preview').style.display = 'block';
        document.getElementById('vehicle-photo-placeholder').style.display = 'none';
        document.getElementById('vehicle-photo-remove').style.display = 'flex';
        document.getElementById('vehicle-photo-upload-area').style.borderStyle = 'solid';
      };
      reader.readAsDataURL(file);
      
      // Clear input so same file can be selected again
      event.target.value = '';
    }

    function removeVehiclePhoto() {
      pendingVehiclePhoto = null;
      document.getElementById('vehicle-photo-preview').style.display = 'none';
      document.getElementById('vehicle-photo-preview').src = '';
      document.getElementById('vehicle-photo-placeholder').style.display = 'block';
      document.getElementById('vehicle-photo-remove').style.display = 'none';
      document.getElementById('vehicle-photo-upload-area').style.borderStyle = 'dashed';
    }

    // ========== EDIT VEHICLE PHOTO HANDLING ==========
    function handleEditVehiclePhotoSelect(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      if (file.size > 5 * 1024 * 1024) {
        showToast('Photo is too large (max 5MB)', 'error');
        return;
      }

      const reader = new FileReader();
      reader.onload = (e) => {
        pendingEditVehiclePhoto = {
          file: file,
          preview: e.target.result
        };
        
        // Update UI
        document.getElementById('edit-vehicle-photo-preview').src = e.target.result;
        document.getElementById('edit-vehicle-photo-preview').style.display = 'block';
        document.getElementById('edit-vehicle-photo-placeholder').style.display = 'none';
        document.getElementById('edit-vehicle-photo-remove').style.display = 'flex';
        document.getElementById('edit-vehicle-photo-upload-area').style.borderStyle = 'solid';
      };
      reader.readAsDataURL(file);
      
      // Clear input so same file can be selected again
      event.target.value = '';
    }

    function removeEditVehiclePhoto() {
      pendingEditVehiclePhoto = null;
      document.getElementById('edit-vehicle-photo-preview').style.display = 'none';
      document.getElementById('edit-vehicle-photo-preview').src = '';
      document.getElementById('edit-vehicle-photo-placeholder').style.display = 'block';
      document.getElementById('edit-vehicle-photo-remove').style.display = 'none';
      document.getElementById('edit-vehicle-photo-upload-area').style.borderStyle = 'dashed';
    }

    // ========== EDIT VEHICLE FUNCTIONS ==========
    function editVehicle(vehicleId) {
      const vehicle = vehicles.find(v => v.id === vehicleId);
      if (!vehicle) {
        showToast('Vehicle not found', 'error');
        return;
      }
      
      editingVehicleId = vehicleId;
      pendingEditVehiclePhoto = null;
      
      // Close the view details modal if open
      closeModal('vehicle-details-modal');
      
      // Populate year dropdown
      const yearSelect = document.getElementById('edit-v-year');
      yearSelect.innerHTML = '<option value="">Select Year</option>';
      const currentYear = new Date().getFullYear() + 1;
      for (let y = currentYear; y >= 1990; y--) {
        yearSelect.innerHTML += `<option value="${y}" ${vehicle.year == y ? 'selected' : ''}>${y}</option>`;
      }
      
      // Populate make dropdown with all makes and select current
      const makeSelect = document.getElementById('edit-v-make');
      makeSelect.innerHTML = '<option value="">Select Make</option>';
      vehicleData.makes.forEach(make => {
        makeSelect.innerHTML += `<option value="${make}" ${vehicle.make === make ? 'selected' : ''}>${make}</option>`;
      });
      
      // Populate model dropdown based on make
      const modelSelect = document.getElementById('edit-v-model');
      modelSelect.innerHTML = '<option value="">Select Model</option>';
      if (vehicle.make && vehicleData.models[vehicle.make]) {
        vehicleData.models[vehicle.make].forEach(model => {
          modelSelect.innerHTML += `<option value="${model}" ${vehicle.model === model ? 'selected' : ''}>${model}</option>`;
        });
      }
      // If vehicle model not in list, add it as an option
      if (vehicle.model && !vehicleData.models[vehicle.make]?.includes(vehicle.model)) {
        modelSelect.innerHTML += `<option value="${vehicle.model}" selected>${vehicle.model}</option>`;
      }
      
      // Populate trim dropdown based on make/model
      const trimSelect = document.getElementById('edit-v-trim');
      trimSelect.innerHTML = '<option value="">Select Trim (Optional)</option>';
      if (vehicle.make && vehicle.model && vehicleData.trims[vehicle.make]?.[vehicle.model]) {
        vehicleData.trims[vehicle.make][vehicle.model].forEach(trim => {
          trimSelect.innerHTML += `<option value="${trim}" ${vehicle.trim === trim ? 'selected' : ''}>${trim}</option>`;
        });
      }
      // If vehicle trim not in list, add it as an option
      if (vehicle.trim && !vehicleData.trims[vehicle.make]?.[vehicle.model]?.includes(vehicle.trim)) {
        trimSelect.innerHTML += `<option value="${vehicle.trim}" selected>${vehicle.trim}</option>`;
      }
      
      // Set color
      document.getElementById('edit-v-color').value = vehicle.color || '';
      
      // Set nickname
      document.getElementById('edit-v-nickname').value = vehicle.nickname || '';
      
      // Set mileage
      document.getElementById('edit-v-mileage').value = vehicle.mileage || '';
      
      // Set VIN
      document.getElementById('edit-v-vin').value = vehicle.vin || '';
      
      // Handle existing photo
      if (vehicle.photo_url) {
        document.getElementById('edit-vehicle-photo-preview').src = vehicle.photo_url;
        document.getElementById('edit-vehicle-photo-preview').style.display = 'block';
        document.getElementById('edit-vehicle-photo-placeholder').style.display = 'none';
        document.getElementById('edit-vehicle-photo-remove').style.display = 'flex';
        document.getElementById('edit-vehicle-photo-upload-area').style.borderStyle = 'solid';
      } else {
        document.getElementById('edit-vehicle-photo-preview').style.display = 'none';
        document.getElementById('edit-vehicle-photo-preview').src = '';
        document.getElementById('edit-vehicle-photo-placeholder').style.display = 'block';
        document.getElementById('edit-vehicle-photo-remove').style.display = 'none';
        document.getElementById('edit-vehicle-photo-upload-area').style.borderStyle = 'dashed';
      }
      
      // Open the modal
      document.getElementById('edit-vehicle-modal').classList.add('active');
    }

    async function saveEditVehicle() {
      const make = document.getElementById('edit-v-make').value.trim();
      const model = document.getElementById('edit-v-model').value.trim();
      if (!make || !model) return showToast('Make and model are required', 'error');
      if (!editingVehicleId) return showToast('No vehicle selected for editing', 'error');

      // Get the current vehicle to check for existing photo
      const currentVehicle = vehicles.find(v => v.id === editingVehicleId);
      let photoUrl = currentVehicle?.photo_url || null;

      // Upload new photo if one was selected
      if (pendingEditVehiclePhoto) {
        showToast('Uploading photo...', 'success');
        const fileName = `${currentUser.id}/${editingVehicleId}-${Date.now()}-${pendingEditVehiclePhoto.file.name}`;
        
        try {
          const { data: uploadData, error: uploadError } = await supabaseClient.storage
            .from('vehicle-photos')
            .upload(fileName, pendingEditVehiclePhoto.file);
          
          if (!uploadError) {
            const { data: urlData } = supabaseClient.storage
              .from('vehicle-photos')
              .getPublicUrl(fileName);
            photoUrl = urlData.publicUrl;
          } else {
            console.error('Photo upload error:', uploadError);
            showToast('Photo upload failed, but updating vehicle info...', 'error');
          }
        } catch (err) {
          console.error('Error uploading vehicle photo:', err);
        }
      }

      // Check if photo was removed (preview hidden but no new photo selected)
      const previewVisible = document.getElementById('edit-vehicle-photo-preview').style.display !== 'none';
      if (!previewVisible && !pendingEditVehiclePhoto) {
        photoUrl = null;
      }

      const vehicleData = {
        make, 
        model,
        year: document.getElementById('edit-v-year').value ? Number(document.getElementById('edit-v-year').value) : null,
        trim: document.getElementById('edit-v-trim').value || null,
        color: document.getElementById('edit-v-color').value || null,
        nickname: document.getElementById('edit-v-nickname').value.trim() || null,
        mileage: document.getElementById('edit-v-mileage').value ? Number(document.getElementById('edit-v-mileage').value) : null,
        vin: document.getElementById('edit-v-vin').value.trim().toUpperCase() || null,
        photo_url: photoUrl
      };

      const { data, error } = await supabaseClient
        .from('vehicles')
        .update(vehicleData)
        .eq('id', editingVehicleId)
        .select();
      
      if (error) {
        console.error('Vehicle update error:', error);
        return showToast('Failed to update vehicle: ' + (error.message || 'Unknown error'), 'error');
      }
      
      closeModal('edit-vehicle-modal');
      showToast('Vehicle updated successfully!', 'success');
      
      // Reset state
      editingVehicleId = null;
      pendingEditVehiclePhoto = null;
      
      await loadVehicles();
      await loadReminders();
      updateStats();
    }

    // Helper functions for edit modal dropdowns
    function updateEditMakeOptions() {
      const yearValue = document.getElementById('edit-v-year').value;
      const makeSelect = document.getElementById('edit-v-make');
      const modelSelect = document.getElementById('edit-v-model');
      const trimSelect = document.getElementById('edit-v-trim');
      
      // Reset model and trim
      modelSelect.innerHTML = '<option value="">Select Model</option>';
      trimSelect.innerHTML = '<option value="">Select Trim (Optional)</option>';
      
      // Populate makes (same makes regardless of year)
      makeSelect.innerHTML = '<option value="">Select Make</option>';
      vehicleData.makes.forEach(make => {
        makeSelect.innerHTML += `<option value="${make}">${make}</option>`;
      });
    }

    function updateEditModelOptions() {
      const makeValue = document.getElementById('edit-v-make').value;
      const modelSelect = document.getElementById('edit-v-model');
      const trimSelect = document.getElementById('edit-v-trim');
      
      modelSelect.innerHTML = '<option value="">Select Model</option>';
      trimSelect.innerHTML = '<option value="">Select Trim (Optional)</option>';
      
      if (makeValue && vehicleData.models[makeValue]) {
        vehicleData.models[makeValue].forEach(model => {
          modelSelect.innerHTML += `<option value="${model}">${model}</option>`;
        });
      }
    }

    function updateEditTrimOptions() {
      const makeValue = document.getElementById('edit-v-make').value;
      const modelValue = document.getElementById('edit-v-model').value;
      const trimSelect = document.getElementById('edit-v-trim');
      
      trimSelect.innerHTML = '<option value="">Select Trim (Optional)</option>';
      
      if (makeValue && modelValue && vehicleData.trims[makeValue]?.[modelValue]) {
        vehicleData.trims[makeValue][modelValue].forEach(trim => {
          trimSelect.innerHTML += `<option value="${trim}">${trim}</option>`;
        });
      }
    }

    async function uploadVehiclePhoto(vehicleId) {
      if (!pendingVehiclePhoto) return null;
      
      try {
        const fileName = `${vehicleId}/${Date.now()}-${pendingVehiclePhoto.file.name}`;
        
        // Upload to Supabase Storage
        const { data, error } = await supabaseClient.storage
          .from('vehicle-photos')
          .upload(fileName, pendingVehiclePhoto.file);
        
        if (error) {
          console.error('Vehicle photo upload error:', error);
          return null;
        }

        // Get public URL
        const { data: urlData } = supabaseClient.storage
          .from('vehicle-photos')
          .getPublicUrl(fileName);

        return urlData.publicUrl;
      } catch (err) {
        console.error('Error uploading vehicle photo:', err);
        return null;
      }
    }

    // ========== SAVE FUNCTIONS ==========
    async function saveVehicle() {
      const make = document.getElementById('v-make').value.trim();
      const model = document.getElementById('v-model').value.trim();
      if (!make || !model) return showToast('Make and model are required', 'error');

      // Upload photo first if one is selected
      let photoUrl = null;
      if (pendingVehiclePhoto) {
        showToast('Uploading photo...', 'success');
        // Create a temporary ID for the upload path
        const tempId = `temp-${Date.now()}`;
        const fileName = `${currentUser.id}/${tempId}-${pendingVehiclePhoto.file.name}`;
        
        try {
          const { data: uploadData, error: uploadError } = await supabaseClient.storage
            .from('vehicle-photos')
            .upload(fileName, pendingVehiclePhoto.file);
          
          if (!uploadError) {
            const { data: urlData } = supabaseClient.storage
              .from('vehicle-photos')
              .getPublicUrl(fileName);
            photoUrl = urlData.publicUrl;
          } else {
            console.error('Photo upload error:', uploadError);
          }
        } catch (err) {
          console.error('Error uploading vehicle photo:', err);
        }
      }

      const vehicleData = {
        owner_id: currentUser.id,
        make, 
        model,
        year: document.getElementById('v-year').value ? Number(document.getElementById('v-year').value) : null,
        trim: document.getElementById('v-trim').value || null,
        color: document.getElementById('v-color').value || null,
        nickname: document.getElementById('v-nickname').value.trim() || null,
        mileage: document.getElementById('v-mileage').value ? Number(document.getElementById('v-mileage').value) : null,
        vin: document.getElementById('v-vin').value.trim().toUpperCase() || null,
        health_score: 100,
        photo_url: photoUrl
      };

      const { data, error } = await supabaseClient.from('vehicles').insert(vehicleData).select();
      
      if (error) {
        console.error('Vehicle insert error:', error);
        // Show more specific error message
        if (error.code === '42P01') {
          return showToast('Database table not found. Please run the schema setup.', 'error');
        } else if (error.code === '42501') {
          return showToast('Permission denied. Check RLS policies.', 'error');
        } else if (error.message?.includes('violates')) {
          return showToast('Invalid data: ' + error.message, 'error');
        }
        return showToast('Failed to add vehicle: ' + (error.message || 'Unknown error'), 'error');
      }
      
      closeModal('vehicle-modal');
      showToast('Vehicle added to your garage!', 'success');
      await loadVehicles();
      await loadReminders();
      updateStats();
    }

    async function savePackage() {
      const vehicleId = document.getElementById('p-vehicle').value;
      const title = document.getElementById('p-title').value.trim();
      if (!vehicleId || !title) return showToast('Vehicle and title are required', 'error');

      // Check if member has set their location
      if (!userProfile?.zip_code) {
        showToast('Please set your ZIP code in Settings first so providers can find your request.', 'error');
        showSection('settings');
        return;
      }

      // Calculate bidding deadline
      const biddingDeadline = new Date(Date.now() + selectedBiddingWindowHours * 60 * 60 * 1000).toISOString();

      const packageData = {
        member_id: currentUser.id,
        vehicle_id: vehicleId,
        title,
        description: document.getElementById('p-description').value.trim() || null,
        category: document.getElementById('p-category').value,
        service_type: document.getElementById('p-service-type').value || null,
        frequency: document.getElementById('p-frequency').value,
        parts_preference: selectedPartsTier,
        pickup_preference: document.getElementById('p-pickup').value,
        bidding_deadline: biddingDeadline,
        insurance_claim: document.getElementById('p-category').value === 'accident_repair',
        insurance_company: document.getElementById('p-insurance-carrier')?.value.trim() || null,
        claim_number: document.getElementById('p-claim-number')?.value.trim() || null,
        member_zip: userProfile.zip_code,
        member_city: userProfile.city || null,
        member_state: userProfile.state || null,
        status: 'open'
      };

      const { data, error } = await supabaseClient.from('maintenance_packages').insert(packageData).select();
      if (error) {
        console.error('Package creation error:', error);
        return showToast('Failed to create package: ' + (error.message || 'Unknown error'), 'error');
      }
      
      // Upload any photos
      if (data && data[0] && pendingPackagePhotos.length > 0) {
        showToast('Uploading photos...', 'success');
        await uploadPackagePhotos(data[0].id);
      }
      
      // Clear photos
      pendingPackagePhotos = [];
      
      closeModal('package-modal');
      showToast('Package created! Providers have ' + formatBiddingWindow(selectedBiddingWindowHours) + ' to submit bids.', 'success');
      await loadPackages();
      updateStats();
    }

    function formatBiddingWindow(hours) {
      if (hours < 24) return hours + ' hours';
      const days = hours / 24;
      return days + (days === 1 ? ' day' : ' days');
    }

    function formatCountdown(deadline) {
      const now = new Date();
      const end = new Date(deadline);
      const diff = end - now;
      
      if (diff <= 0) return { text: 'Bidding closed', expired: true, urgent: false };
      
      const days = Math.floor(diff / (1000 * 60 * 60 * 24));
      const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
      const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
      
      let text = '';
      if (days > 0) {
        text = `${days}d ${hours}h left`;
      } else if (hours > 0) {
        text = `${hours}h ${minutes}m left`;
      } else {
        text = `${minutes}m left`;
      }
      
      return { 
        text, 
        expired: false, 
        urgent: diff < 4 * 60 * 60 * 1000 // Less than 4 hours
      };
    }

    // ========== REPOST EXPIRED PACKAGE ==========
    async function repostPackage(packageId) {
      const pkg = packages.find(p => p.id === packageId);
      if (!pkg) return;

      // Show repost modal with duration options
      document.getElementById('repost-package-title').textContent = pkg.title;
      document.getElementById('repost-package-id').value = packageId;
      
      // Reset to default 3 days
      selectedRepostHours = 72;
      document.querySelectorAll('.repost-window-option').forEach(o => {
        o.classList.toggle('selected', o.dataset.hours === '72');
      });
      
      document.getElementById('repost-modal').classList.add('active');
    }

    let selectedRepostHours = 72;

    function selectRepostWindow(el) {
      document.querySelectorAll('.repost-window-option').forEach(o => o.classList.remove('selected'));
      el.classList.add('selected');
      selectedRepostHours = parseInt(el.dataset.hours);
    }

    async function confirmRepost() {
      const packageId = document.getElementById('repost-package-id').value;
      if (!packageId) return;

      const newDeadline = new Date(Date.now() + selectedRepostHours * 60 * 60 * 1000).toISOString();

      const { error } = await supabaseClient
        .from('maintenance_packages')
        .update({ 
          bidding_deadline: newDeadline,
          status: 'open',
          updated_at: new Date().toISOString()
        })
        .eq('id', packageId);

      if (error) {
        console.error('Error reposting:', error);
        showToast('Failed to repost package', 'error');
        return;
      }

      closeModal('repost-modal');
      showToast('Package reposted! Providers have ' + formatBiddingWindow(selectedRepostHours) + ' to submit bids.', 'success');
      await loadPackages();
    }

    // ========== EXTEND DEADLINE ==========
    let selectedExtendHours = 24;
    let currentExtendPackage = null;

    function extendDeadline(packageId) {
      const pkg = packages.find(p => p.id === packageId);
      if (!pkg) return;

      currentExtendPackage = pkg;
      selectedExtendHours = 24;

      document.getElementById('extend-package-id').value = packageId;
      document.getElementById('extend-package-title').textContent = pkg.title;
      
      const currentDeadline = new Date(pkg.bidding_deadline);
      document.getElementById('extend-current-deadline').textContent = 
        `Current deadline: ${currentDeadline.toLocaleDateString()} at ${currentDeadline.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;

      // Reset selection
      document.querySelectorAll('.extend-option').forEach(opt => opt.classList.remove('selected'));
      document.querySelector('.extend-option[data-hours="24"]').classList.add('selected');

      updateExtendPreview();
      document.getElementById('extend-modal').classList.add('active');
    }

    function selectExtendTime(el) {
      document.querySelectorAll('.extend-option').forEach(opt => opt.classList.remove('selected'));
      el.classList.add('selected');
      selectedExtendHours = parseInt(el.dataset.hours);
      updateExtendPreview();
    }

    function updateExtendPreview() {
      if (!currentExtendPackage) return;
      
      const currentDeadline = new Date(currentExtendPackage.bidding_deadline);
      const newDeadline = new Date(currentDeadline.getTime() + selectedExtendHours * 60 * 60 * 1000);
      
      document.getElementById('extend-new-time').textContent = 
        `${newDeadline.toLocaleDateString()} at ${newDeadline.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;
    }

    async function confirmExtend() {
      const packageId = document.getElementById('extend-package-id').value;
      if (!packageId || !currentExtendPackage) return;

      const currentDeadline = new Date(currentExtendPackage.bidding_deadline);
      const newDeadline = new Date(currentDeadline.getTime() + selectedExtendHours * 60 * 60 * 1000).toISOString();

      const { error } = await supabaseClient
        .from('maintenance_packages')
        .update({ 
          bidding_deadline: newDeadline,
          updated_at: new Date().toISOString()
        })
        .eq('id', packageId);

      if (error) {
        console.error('Error extending deadline:', error);
        showToast('Failed to extend deadline', 'error');
        return;
      }

      closeModal('extend-modal');
      currentExtendPackage = null;
      
      const timeText = selectedExtendHours < 24 ? `${selectedExtendHours} hours` : `${selectedExtendHours / 24} day${selectedExtendHours > 24 ? 's' : ''}`;
      showToast(`Deadline extended by ${timeText}!`, 'success');
      await loadPackages();
    }

    // ========== VIEW PACKAGE WITH BIDS ==========
    async function viewPackage(packageId) {
      currentViewPackage = packageId;
      const pkg = packages.find(p => p.id === packageId);
      if (!pkg) {
        showToast('Package not found', 'error');
        return;
      }

      // Load bids for this package (without join)
      const { data: bids, error: bidsError } = await supabaseClient
        .from('bids')
        .select('*')
        .eq('package_id', packageId)
        .order('created_at', { ascending: false });

      if (bidsError) {
        console.error('Error loading bids:', bidsError);
        showToast('Error loading bids: ' + bidsError.message, 'error');
      }

      // Load provider profiles separately
      if (bids?.length) {
        const providerIds = bids.map(b => b.provider_id);
        const { data: profiles } = await supabaseClient
          .from('profiles')
          .select('id, provider_alias, business_name')
          .in('id', providerIds);
        
        // Attach profile info to bids
        bids.forEach(bid => {
          const profile = profiles?.find(p => p.id === bid.provider_id);
          bid.profiles = profile || null;
        });
      }

      // Store bids for acceptBid function
      currentPackageBids = bids || [];

      // Load provider stats for each bid
      const providerStats = {};
      const providerPerformance = {};
      if (bids?.length) {
        const providerIds = bids.map(b => b.provider_id);
        const { data: stats } = await supabaseClient.from('provider_stats').select('*').in('provider_id', providerIds);
        stats?.forEach(s => providerStats[s.provider_id] = s);
        
        // Load provider performance data
        const { data: perfData } = await getProviderPerformanceByIds(providerIds);
        perfData?.forEach(p => providerPerformance[p.provider_id] = p);
      }

      // Load provider application data for enhanced transparency
      const providerApplications = {};
      if (bids?.length) {
        const providerIds = bids.map(b => b.provider_id);
        const { data: applications } = await supabaseClient
          .from('provider_applications')
          .select('user_id, business_name, years_in_business, services_offered, brand_specializations, license_verified, insurance_verified, certifications_verified')
          .in('user_id', providerIds)
          .eq('status', 'approved');
        applications?.forEach(app => providerApplications[app.user_id] = app);
      }

      const vehicle = pkg.vehicles;
      const vehicleName = vehicle ? (vehicle.nickname || `${vehicle.year || ''} ${vehicle.make} ${vehicle.model}`.trim()) : 'Unknown Vehicle';

      document.getElementById('view-package-title').textContent = pkg.title;
      document.getElementById('view-package-body').innerHTML = `
        <div class="form-section">
          <div class="form-section-title">Package Details</div>
          <div class="package-meta" style="margin-bottom:0;">
            <span>üöó ${vehicleName}</span>
            <span>üìÖ Created ${new Date(pkg.created_at).toLocaleDateString()}</span>
            <span>üîÑ ${formatFrequency(pkg.frequency)}</span>
            <span>üîß ${pkg.parts_preference || 'Standard'} parts</span>
          </div>
          ${pkg.description ? `<p style="color:var(--text-secondary);margin-top:16px;line-height:1.6;">${pkg.description}</p>` : ''}
        </div>

        <div class="form-section">
          <div class="form-section-title">Bids (${bids?.length || 0})</div>
          ${!bids?.length ? '<p style="color:var(--text-muted);">No bids yet. Providers are reviewing your package.</p>' : `
            <div class="bids-list">
              ${bids.map(bid => {
                const stats = providerStats[bid.provider_id] || {};
                const perf = providerPerformance[bid.provider_id];
                const appData = providerApplications[bid.provider_id] || {};
                const rating = perf?.rating_avg ? perf.rating_avg.toFixed(1) : (stats.average_rating ? stats.average_rating.toFixed(1) : 'New');
                const jobs = perf?.jobs_completed || stats.jobs_completed || 0;
                const providerName = bid.profiles?.provider_alias || `Provider #${bid.provider_id.slice(0,4).toUpperCase()}`;
                const businessName = appData.business_name || bid.profiles?.business_name;
                const yearsInBusiness = appData.years_in_business;
                const isVerified = appData.license_verified && appData.insurance_verified && appData.certifications_verified;
                const services = appData.services_offered || [];
                const brands = appData.brand_specializations || [];
                const specialties = [...services.slice(0, 2), ...brands.slice(0, 1)].slice(0, 3);
                const bidPrice = bid.price || 0;
                
                // Performance data
                const tier = perf?.tier || 'bronze';
                const tierIcon = {'platinum': 'üíé', 'gold': 'ü•á', 'silver': 'ü•à', 'bronze': 'ü•â'}[tier] || 'ü•â';
                const tierColors = {'platinum': '#e5e4e2', 'gold': 'var(--accent-gold)', 'silver': '#c0c0c0', 'bronze': '#cd7f32'};
                const overallScore = perf?.overall_score ? Math.round(perf.overall_score) : null;
                const onTimeRate = perf?.on_time_rate && jobs > 0 ? Math.round(perf.on_time_rate) : null;
                const badges = perf?.badges || [];
                const badgeIcons = {'top_rated': 'üèÜ', 'quick_responder': '‚ö°', 'veteran': 'üéñÔ∏è', 'perfect_score': '‚≠ê', 'dispute_free': 'üõ°Ô∏è'};
                
                return `
                  <div class="bid-card" style="background:var(--bg-elevated);border:1px solid var(--border-subtle);border-radius:var(--radius-md);padding:20px;margin-bottom:12px;">
                    <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px;">
                      <div style="display:flex;gap:12px;align-items:flex-start;">
                        <div style="width:48px;height:48px;background:var(--accent-gold-soft);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0;">üîß</div>
                        <div>
                          <div style="display:flex;align-items:center;gap:8px;margin-bottom:2px;">
                            <h4 style="margin:0;font-size:1rem;">${providerName}</h4>
                            ${perf ? `<span style="display:inline-flex;align-items:center;gap:4px;padding:2px 8px;border-radius:100px;font-size:0.7rem;font-weight:600;background:${tierColors[tier]}20;color:${tierColors[tier]};border:1px solid ${tierColors[tier]}40;">${tierIcon} ${tier.charAt(0).toUpperCase() + tier.slice(1)}</span>` : ''}
                          </div>
                          <div style="font-size:0.82rem;color:var(--text-secondary);margin-top:2px;">
                            ${businessName && businessName !== providerName ? `${businessName}` : ''}
                            ${businessName && businessName !== providerName && yearsInBusiness ? ' ‚Ä¢ ' : ''}
                            ${yearsInBusiness ? `${yearsInBusiness} years in business` : ''}
                          </div>
                          <div style="font-size:0.85rem;color:var(--text-muted);margin-top:4px;">
                            ‚≠ê ${rating} 
                            ${jobs > 0 ? `‚Ä¢ ${jobs} jobs` : '‚Ä¢ New provider'}
                            ${onTimeRate !== null ? ` ‚Ä¢ ${onTimeRate}% on-time` : ''}
                            ${overallScore !== null ? ` ‚Ä¢ Score: ${overallScore}` : ''}
                          </div>
                          ${badges.length > 0 ? `<div style="display:flex;gap:4px;margin-top:6px;">${badges.map(b => `<span title="${b.replace('_', ' ')}" style="font-size:1rem;">${badgeIcons[b] || ''}</span>`).join('')}</div>` : ''}
                        </div>
                      </div>
                      <div style="text-align:right;">
                        <div style="font-size:1.4rem;font-weight:600;color:var(--accent-gold);">$${bidPrice.toFixed(2)}</div>
                        ${bid.status === 'accepted' ? '<span style="color:var(--accent-green);font-size:0.8rem;">‚úì Accepted</span>' : ''}
                        ${bid.status === 'rejected' ? '<span style="color:var(--accent-red);font-size:0.8rem;">‚úó Not selected</span>' : ''}
                      </div>
                    </div>
                    
                    ${isVerified || specialties.length > 0 ? `
                      <div style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:12px;">
                        ${isVerified ? `<span style="display:inline-flex;align-items:center;gap:4px;background:linear-gradient(135deg, var(--accent-gold), #c49a45);color:#0a0a0f;padding:4px 10px;border-radius:100px;font-size:0.75rem;font-weight:600;">‚úì Concierge Verified</span>` : ''}
                        ${specialties.map(s => `<span style="display:inline-block;background:var(--bg-input);border:1px solid var(--border-subtle);color:var(--text-secondary);padding:3px 10px;border-radius:100px;font-size:0.75rem;">${s}</span>`).join('')}
                      </div>
                    ` : ''}
                    
                    ${bid.parts_cost || bid.labor_cost ? `
                      <div style="font-size:0.85rem;color:var(--text-secondary);margin-bottom:8px;">
                        ${bid.parts_cost ? `Parts: $${bid.parts_cost.toFixed(2)}` : ''}
                        ${bid.parts_cost && bid.labor_cost ? ' ‚Ä¢ ' : ''}
                        ${bid.labor_cost ? `Labor: $${bid.labor_cost.toFixed(2)}` : ''}
                      </div>
                    ` : ''}
                    ${bid.estimated_duration ? `<div style="font-size:0.85rem;color:var(--text-secondary);margin-bottom:8px;">‚è±Ô∏è Estimated time: ${bid.estimated_duration}</div>` : ''}
                    ${bid.available_dates ? `<div style="font-size:0.85rem;color:var(--text-secondary);margin-bottom:8px;">üìÖ Availability: ${bid.available_dates}</div>` : ''}
                    ${bid.notes ? `<div style="color:var(--text-secondary);margin-bottom:12px;padding:12px;background:var(--bg-input);border-radius:var(--radius-sm);font-size:0.9rem;">"${bid.notes}"</div>` : ''}
                    <div style="display:flex;gap:8px;flex-wrap:wrap;">
                      <button class="btn btn-secondary btn-sm" onclick="openMessageWithProvider('${packageId}', '${bid.provider_id}')">üí¨ Message</button>
                      ${pkg.status === 'open' && bid.status === 'pending' ? `<button class="btn btn-primary btn-sm" onclick="acceptBid('${bid.id}', '${packageId}')">‚úì Accept Bid</button>` : ''}
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
          `}
        </div>

        ${(pkg.status === 'accepted' || pkg.status === 'in_progress') ? `
          <div class="form-section" id="logistics-dashboard-${packageId}">
            <div class="form-section-title">üéâ Service Coordination Dashboard</div>
            <p style="color:var(--text-secondary);margin-bottom:20px;">Coordinate scheduling, vehicle transfer, and location with your service provider.</p>
            
            <!-- Scheduling Section -->
            <div style="background:var(--bg-elevated);border:1px solid var(--border-subtle);border-radius:var(--radius-lg);padding:20px;margin-bottom:16px;">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
                <h4 style="margin:0;font-size:1rem;display:flex;align-items:center;gap:8px;">üìÖ Appointment Scheduling</h4>
              </div>
              <div id="appointment-status-${packageId}" style="margin-bottom:16px;">
                <div style="color:var(--text-muted);font-size:0.9rem;">Loading appointment status...</div>
              </div>
              <div style="display:flex;gap:8px;flex-wrap:wrap;">
                <button class="btn btn-primary btn-sm" onclick="openScheduleModal('${packageId}', '${pkg.member_id}', '${acceptedBid?.provider_id || ''}')">üìÖ Propose Appointment</button>
              </div>
            </div>

            <!-- Vehicle Transfer Section -->
            <div style="background:var(--bg-elevated);border:1px solid var(--border-subtle);border-radius:var(--radius-lg);padding:20px;margin-bottom:16px;">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
                <h4 style="margin:0;font-size:1rem;display:flex;align-items:center;gap:8px;">üöó Vehicle Transfer</h4>
              </div>
              <div id="transfer-status-${packageId}" style="margin-bottom:16px;">
                <div style="color:var(--text-muted);font-size:0.9rem;">Loading transfer status...</div>
              </div>
              <div style="display:flex;gap:8px;flex-wrap:wrap;">
                <button class="btn btn-secondary btn-sm" onclick="openTransferModal('${packageId}', '${pkg.member_id}', '${acceptedBid?.provider_id || ''}')">‚öôÔ∏è Setup Transfer</button>
              </div>
            </div>

            <!-- Location Sharing Section -->
            <div style="background:var(--bg-elevated);border:1px solid var(--border-subtle);border-radius:var(--radius-lg);padding:20px;margin-bottom:16px;">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
                <h4 style="margin:0;font-size:1rem;display:flex;align-items:center;gap:8px;">üìç Location Sharing</h4>
              </div>
              <div id="location-status-${packageId}" style="margin-bottom:16px;">
                <div style="color:var(--text-muted);font-size:0.9rem;">Share your location for pickup coordination.</div>
              </div>
              <div style="display:flex;gap:8px;flex-wrap:wrap;">
                <button class="btn btn-primary btn-sm" onclick="shareMyLocation('${packageId}', '${acceptedBid?.provider_id || ''}')">üìç Share My Location</button>
                <button class="btn btn-secondary btn-sm" onclick="viewSharedLocation('${packageId}')">üó∫Ô∏è View Provider Location</button>
              </div>
            </div>

            <!-- Vehicle Condition Evidence Section -->
            <div style="background:var(--bg-elevated);border:1px solid var(--border-subtle);border-radius:var(--radius-lg);padding:20px;margin-bottom:16px;">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
                <h4 style="margin:0;font-size:1rem;display:flex;align-items:center;gap:8px;">üì∏ Vehicle Condition Evidence</h4>
              </div>
              <div id="evidence-timeline-${packageId}" style="margin-bottom:16px;">
                <div style="color:var(--text-muted);font-size:0.9rem;">Loading evidence timeline...</div>
              </div>
              <div style="display:flex;gap:8px;flex-wrap:wrap;">
                <button class="btn btn-primary btn-sm" onclick="openMemberEvidenceModal('${packageId}', 'pre_pickup')">üì∏ Document Pre-Pickup Condition</button>
              </div>
            </div>

            <!-- Key Exchange Verification Section -->
            <div style="background:var(--bg-elevated);border:1px solid var(--border-subtle);border-radius:var(--radius-lg);padding:20px;margin-bottom:16px;">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
                <h4 style="margin:0;font-size:1rem;display:flex;align-items:center;gap:8px;">üîë Key Exchange Verification</h4>
              </div>
              <p style="color:var(--text-muted);font-size:0.9rem;margin-bottom:16px;">Track key handoffs between you and the provider for security and liability protection.</p>
              <div id="key-exchange-timeline-${packageId}">
                <div style="color:var(--text-muted);font-size:0.9rem;">Loading key exchange status...</div>
              </div>
            </div>

            <!-- Inspection Report Section -->
            <div id="inspection-report-container-${packageId}" style="background:var(--bg-elevated);border:1px solid var(--border-subtle);border-radius:var(--radius-lg);padding:20px;">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
                <h4 style="margin:0;font-size:1rem;display:flex;align-items:center;gap:8px;">üîç Multi-Point Inspection</h4>
              </div>
              <div id="inspection-report-content-${packageId}">
                <div style="color:var(--text-muted);font-size:0.9rem;">Loading inspection report...</div>
              </div>
            </div>
          </div>
        ` : ''}
        ${(pkg.status === 'accepted' || pkg.status === 'in_progress') ? `<div id="logistics-loader-${packageId}" data-load-logistics="true"></div>` : ''}

        ${pkg.status === 'in_progress' || pkg.status === 'accepted' ? `
          <div class="form-section" style="margin-top:24px;padding-top:20px;border-top:1px solid var(--border-subtle);">
            <div class="form-section-title">Job Status</div>
            <div class="alert info" style="margin-bottom:16px;padding:16px;background:var(--accent-blue-soft);border:1px solid rgba(74,124,255,0.3);color:var(--accent-blue);border-radius:var(--radius-md);">
              ${pkg.status === 'accepted' ? '‚è≥ Waiting for provider to start work...' : 'üîß Work is in progress...'}
            </div>
            ${pkg.work_completed_at && pkg.status === 'in_progress' ? `
              <div class="alert" style="margin-bottom:16px;padding:16px;background:var(--accent-green-soft);border:1px solid rgba(74,200,140,0.3);color:var(--accent-green);border-radius:var(--radius-md);">
                ‚úì Provider has marked work as complete on ${new Date(pkg.work_completed_at).toLocaleDateString()}
              </div>
              <p style="color:var(--text-secondary);margin-bottom:16px;">Once you receive your vehicle and verify the work is complete, confirm below to release payment to the provider.</p>
              <div style="display:flex;gap:12px;">
                <button class="btn btn-primary" onclick="confirmCompletion('${packageId}')">‚úì Confirm Complete & Release Payment</button>
                <button class="btn btn-danger btn-sm" onclick="openDispute('${packageId}')">‚ö†Ô∏è Open Dispute</button>
              </div>
            ` : ''}
          </div>
        ` : ''}

        ${pkg.status === 'completed' ? `
          <div class="form-section" style="margin-top:24px;padding-top:20px;border-top:1px solid var(--border-subtle);">
            <div class="form-section-title">‚úì Completed</div>
            <div class="alert" style="background:var(--accent-green-soft);border:1px solid rgba(74,200,140,0.3);color:var(--accent-green);padding:16px;border-radius:var(--radius-md);margin-bottom:16px;">
              ‚úì This job was completed on ${new Date(pkg.member_confirmed_at || pkg.work_completed_at).toLocaleDateString()}
            </div>
            <button class="btn btn-secondary" onclick="openReviewModal('${packageId}')">‚≠ê Leave a Review</button>
          </div>
        ` : ''}
      `;

      document.getElementById('view-package-modal').classList.add('active');
      
      // Load logistics data if applicable
      if (pkg.status === 'accepted' || pkg.status === 'in_progress') {
        setTimeout(() => loadLogisticsData(packageId), 100);
      }
    }

    // Store bids for the current package
    let currentPackageBids = [];

    async function acceptBid(bidId, packageId) {
      const bid = currentPackageBids.find(b => b.id === bidId);
      if (!bid) {
        showToast('Bid not found', 'error');
        return;
      }
      
      const amount = bid.price || 0;
      const mccFee = amount * 0.02;
      const providerAmount = amount - mccFee;

      if (!confirm(`Accept this bid for $${amount.toFixed(2)}?\n\nThis will:\n‚Ä¢ Hold payment in escrow\n‚Ä¢ Close the package to other providers\n‚Ä¢ Notify the provider to begin work\n\nMCC Fee (2%): $${mccFee.toFixed(2)}\nProvider receives: $${providerAmount.toFixed(2)}`)) return;

      try {
        // Update this bid to accepted
        await supabaseClient.from('bids').update({ status: 'accepted' }).eq('id', bidId);
        
        // Reject all other bids for this package
        await supabaseClient.from('bids').update({ status: 'rejected' }).eq('package_id', packageId).neq('id', bidId);
        
        // Update package status
        await supabaseClient.from('maintenance_packages').update({ 
          status: 'accepted', 
          accepted_bid_id: bidId, 
          accepted_at: new Date().toISOString() 
        }).eq('id', packageId);

        // Create payment record (escrow)
        await supabaseClient.from('payments').insert({
          package_id: packageId,
          member_id: currentUser.id,
          provider_id: bid.provider_id,
          amount_total: amount,
          amount_provider: providerAmount,
          mcc_fee: mccFee,
          status: 'held',
          held_at: new Date().toISOString()
        });

        // Notify provider that their bid was accepted (in-app + email)
        const pkg = packages.find(p => p.id === packageId);
        try {
          // In-app notification
          await supabaseClient.from('notifications').insert({
            user_id: bid.provider_id,
            type: 'bid_accepted',
            title: 'üéâ Your bid was accepted!',
            message: `Your bid of $${amount.toFixed(2)} for "${pkg?.title || 'Maintenance Package'}" has been accepted. Contact the member to schedule the work.`,
            link_type: 'package',
            link_id: packageId
          });

          // Email notification to provider
          const { data: providerProfile } = await supabaseClient.from('profiles').select('email, full_name, business_name').eq('id', bid.provider_id).single();
          if (providerProfile?.email && typeof EmailService !== 'undefined') {
            await EmailService.sendBidAcceptedEmail(
              providerProfile.email,
              providerProfile.business_name || providerProfile.full_name || 'Provider',
              pkg?.title || 'Maintenance Package',
              amount
            );
          }
        } catch (e) {
          console.log('Notification error (non-critical):', e);
        }

        closeModal('view-package-modal');
        showToast('Bid accepted! Payment held in escrow. Provider has been notified.', 'success');
        await loadPackages();
      } catch (err) {
        console.error('Error accepting bid:', err);
        showToast('Failed to accept bid. Please try again.', 'error');
      }
    }

    async function confirmCompletion(packageId) {
      if (!confirm('Confirm that the work is complete and you have received your vehicle?\n\nThis will release payment to the provider.')) return;

      try {
        // Get the package and accepted bid for provider info
        const pkg = packages.find(p => p.id === packageId);
        const { data: bid } = await supabaseClient.from('bids').select('*, profiles:provider_id(provider_alias)').eq('package_id', packageId).eq('status', 'accepted').single();

        // Update package
        await supabaseClient.from('maintenance_packages').update({
          status: 'completed',
          member_confirmed_at: new Date().toISOString()
        }).eq('id', packageId);

        // Release payment
        await supabaseClient.from('payments').update({
          status: 'released',
          released_at: new Date().toISOString()
        }).eq('package_id', packageId);

        // Create service history record
        const vehicle = vehicles.find(v => v.id === pkg?.vehicle_id);
        await supabaseClient.from('service_history').insert({
          vehicle_id: pkg?.vehicle_id,
          package_id: packageId,
          provider_id: bid?.provider_id,
          service_date: new Date().toISOString().split('T')[0],
          service_type: pkg?.service_type,
          service_category: pkg?.category,
          description: pkg?.title,
          mileage_at_service: vehicle?.mileage,
          total_cost: bid?.price,
          provider_name: bid?.profiles?.provider_alias || `Provider #${bid?.provider_id?.slice(0,4).toUpperCase()}`
        });

        closeModal('view-package-modal');
        showToast('Payment released! Thank you for using My Car Concierge.', 'success');
        await loadPackages();
        await loadServiceHistory();

        // Open review modal
        setTimeout(() => {
          openReviewModal(packageId, bid?.provider_id, bid?.profiles?.business_name || bid?.profiles?.full_name, pkg?.title, bid?.price);
        }, 500);
      } catch (err) {
        console.error('Error confirming completion:', err);
        showToast('Error completing job. Please try again.', 'error');
      }
    }

    // ========== REVIEWS ==========
    let currentReviewPackageId = null;
    let currentReviewProviderId = null;

    function openReviewModal(packageId, providerId, providerName, serviceTitle, amount) {
      currentReviewPackageId = packageId;
      currentReviewProviderId = providerId;
      
      document.getElementById('review-provider-name').textContent = providerName || 'Provider';
      document.getElementById('review-service-title').textContent = serviceTitle || 'Service';
      document.getElementById('review-amount').textContent = `$${(amount || 0).toFixed(2)}`;
      
      // Reset form
      document.querySelectorAll('.star-rating').forEach(container => {
        container.querySelectorAll('.star').forEach((star, i) => {
          star.classList.toggle('active', i < 5); // Default to 5 stars
        });
        container.dataset.value = '5';
      });
      document.getElementById('review-title').value = '';
      document.getElementById('review-text').value = '';
      
      document.getElementById('review-modal').classList.add('active');
    }

    function setRating(ratingType, value) {
      const container = document.querySelector(`.star-rating[data-type="${ratingType}"]`);
      container.dataset.value = value;
      container.querySelectorAll('.star').forEach((star, i) => {
        star.classList.toggle('active', i < value);
      });
    }

    async function submitReview() {
      const overallRating = parseInt(document.querySelector('.star-rating[data-type="overall"]').dataset.value) || 5;
      const qualityRating = parseInt(document.querySelector('.star-rating[data-type="quality"]').dataset.value) || 5;
      const communicationRating = parseInt(document.querySelector('.star-rating[data-type="communication"]').dataset.value) || 5;
      const timelinessRating = parseInt(document.querySelector('.star-rating[data-type="timeliness"]').dataset.value) || 5;
      const valueRating = parseInt(document.querySelector('.star-rating[data-type="value"]').dataset.value) || 5;
      const reviewTitle = document.getElementById('review-title').value.trim();
      const reviewText = document.getElementById('review-text').value.trim();

      const pkg = packages.find(p => p.id === currentReviewPackageId);
      const vehicle = vehicles.find(v => v.id === pkg?.vehicle_id);
      const { data: bid } = await supabaseClient.from('bids').select('price_estimate').eq('package_id', currentReviewPackageId).eq('status', 'accepted').single();

      const reviewData = {
        provider_id: currentReviewProviderId,
        member_id: currentUser.id,
        package_id: currentReviewPackageId,
        overall_rating: overallRating,
        quality_rating: qualityRating,
        communication_rating: communicationRating,
        timeliness_rating: timelinessRating,
        value_rating: valueRating,
        review_title: reviewTitle || null,
        review_text: reviewText || null,
        service_type: pkg?.service_type,
        vehicle_info: vehicle ? `${vehicle.year} ${vehicle.make} ${vehicle.model}` : null,
        amount_paid: bid?.price_estimate,
        status: 'published',
        verified_purchase: true
      };

      const result = await submitProviderReview(reviewData);
      
      if (result.error) {
        showToast('Failed to submit review. Please try again.', 'error');
        return;
      }

      closeModal('review-modal');
      showToast('Thank you for your review! It helps other members make informed decisions.', 'success');
    }

    function skipReview() {
      closeModal('review-modal');
      showToast('You can leave a review later from your service history.', 'info');
    }

    async function openDispute(packageId) {
      currentViewPackage = packageId;
      document.getElementById('dispute-package-id').value = packageId;
      document.getElementById('dispute-reason').value = '';
      document.getElementById('dispute-description').value = '';
      document.getElementById('dispute-modal').classList.add('active');
    }

    async function submitDispute() {
      const packageId = document.getElementById('dispute-package-id').value;
      const reason = document.getElementById('dispute-reason').value;
      const description = document.getElementById('dispute-description').value;

      if (!reason) return showToast('Please select a reason for the dispute.', 'error');

      // Get payment for this package
      const { data: payment } = await supabaseClient.from('payments').select('*').eq('package_id', packageId).single();

      // Create dispute
      await supabaseClient.from('disputes').insert({
        package_id: packageId,
        payment_id: payment?.id,
        filed_by: currentUser.id,
        filed_by_role: 'member',
        reason: reason,
        description: description,
        status: 'open',
        requires_inspection: (payment?.amount_total || 0) > 1000
      });

      // Update payment status
      if (payment) {
        await supabaseClient.from('payments').update({ status: 'disputed' }).eq('id', payment.id);
      }

      closeModal('dispute-modal');
      showToast('Dispute submitted. Our team will review and contact you within 24-48 hours.', 'success');
      await loadPackages();
    }

    async function requestRefund(packageId) {
      if (!confirm('Request a refund because the provider cannot start work?\\n\\nYour payment will be refunded immediately.')) return;

      // Get payment
      const { data: payment } = await supabaseClient.from('payments').select('*').eq('package_id', packageId).single();
      
      if (payment) {
        await supabaseClient.from('payments').update({
          status: 'refunded',
          refund_amount: payment.amount_total,
          refund_reason: 'Provider unable to start work',
          refunded_at: new Date().toISOString()
        }).eq('id', payment.id);
      }

      // Update package
      await supabaseClient.from('maintenance_packages').update({
        status: 'cancelled'
      }).eq('id', packageId);

      closeModal('view-package-modal');
      showToast('Refund processed! The funds will be returned to your payment method.', 'success');
      await loadPackages();
    }

    // ========== MESSAGING ==========
    async function openMessageWithProvider(packageId, providerId) {
      currentViewPackage = packageId;
      currentMessageProvider = providerId;

      // Get provider alias (not real name for privacy)
      const { data: providerProfile } = await supabaseClient
        .from('profiles')
        .select('provider_alias')
        .eq('id', providerId)
        .single();

      // Use alias or generate anonymous ID
      const providerName = providerProfile?.provider_alias || `Provider #${providerId.slice(0,4).toUpperCase()}`;

      const { data: messages } = await supabaseClient.from('messages').select('*').eq('package_id', packageId).or(`sender_id.eq.${currentUser.id},recipient_id.eq.${currentUser.id}`).order('created_at', { ascending: true });

      const thread = document.getElementById('message-thread');
      if (!messages?.length) {
        thread.innerHTML = '<p style="color:var(--text-muted);text-align:center;">No messages yet. Start the conversation!</p>';
      } else {
        thread.innerHTML = messages.map(m => `
          <div class="message ${m.sender_id === currentUser.id ? 'sent' : 'received'}">
            <div class="message-bubble">${m.content}</div>
            <div class="message-time">${new Date(m.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</div>
          </div>
        `).join('');
        thread.scrollTop = thread.scrollHeight;
      }

      document.getElementById('message-modal-title').textContent = `Message ${providerName}`;
      document.getElementById('message-input').value = '';
      document.getElementById('message-modal').classList.add('active');
    }

    async function sendMessage() {
      const input = document.getElementById('message-input');
      const content = input.value.trim();
      if (!content || !currentMessageProvider || !currentViewPackage) return;

      const { error } = await supabaseClient.from('messages').insert({
        package_id: currentViewPackage,
        sender_id: currentUser.id,
        recipient_id: currentMessageProvider,
        content
      });

      if (error) {
        console.error('Error sending message:', error);
        showToast('Failed to send message', 'error');
        return;
      }

      input.value = '';
      await openMessageWithProvider(currentViewPackage, currentMessageProvider);
    }

    // ========== VEHICLE DETAILS ==========
    async function viewVehicleDetails(vehicleId) {
      const vehicle = vehicles.find(v => v.id === vehicleId);
      if (!vehicle) return;

      // Try to load photos and documents, but don't fail if tables don't exist
      let photos = [];
      let documents = [];
      
      try {
        const photoResult = await window.listVehiclePhotos(vehicleId);
        photos = photoResult?.data || [];
      } catch (e) {
        console.log('Could not load photos:', e);
      }
      
      try {
        const docResult = await window.listVehicleDocuments(vehicleId);
        documents = docResult?.data || [];
      } catch (e) {
        console.log('Could not load documents:', e);
      }
      
      const vehicleHistory = serviceHistory.filter(h => h.vehicle_id === vehicleId);

      document.getElementById('vehicle-details-title').textContent = vehicle.nickname || `${vehicle.year || ''} ${vehicle.make} ${vehicle.model}`;
      document.getElementById('vehicle-details-body').innerHTML = `
        <div class="tabs" style="margin-bottom:20px;">
          <div class="tab active" onclick="showVehicleTab('info', '${vehicleId}')">Info</div>
          <div class="tab" onclick="showVehicleTab('photos', '${vehicleId}')">Photos (${photos?.length || 0})</div>
          <div class="tab" onclick="showVehicleTab('documents', '${vehicleId}')">Documents (${documents?.length || 0})</div>
          <div class="tab" onclick="showVehicleTab('history', '${vehicleId}')">Service History</div>
        </div>
        
        <div id="vehicle-tab-info">
          <div class="form-row">
            <div><strong>Year:</strong> ${vehicle.year || 'N/A'}</div>
            <div><strong>Make:</strong> ${vehicle.make}</div>
          </div>
          <div class="form-row" style="margin-top:12px;">
            <div><strong>Model:</strong> ${vehicle.model}</div>
            <div><strong>Trim:</strong> ${vehicle.trim || 'N/A'}</div>
          </div>
          <div class="form-row" style="margin-top:12px;">
            <div><strong>Color:</strong> ${vehicle.color || 'N/A'}</div>
            <div><strong>Mileage:</strong> ${vehicle.mileage ? vehicle.mileage.toLocaleString() + ' mi' : 'N/A'}</div>
          </div>
          <div class="form-row" style="margin-top:12px;">
            <div style="flex:1;"><strong>VIN:</strong> <span style="font-family: monospace;">${vehicle.vin || 'Not provided'}</span></div>
          </div>
          <div style="margin-top:24px;display:flex;gap:12px;">
            <button class="btn btn-secondary" onclick="editVehicle('${vehicleId}')">Edit Details</button>
            <button class="btn btn-danger" onclick="deleteVehicle('${vehicleId}')">Delete Vehicle</button>
          </div>
        </div>
        
        <div id="vehicle-tab-photos" style="display:none;">
          <div style="display:flex;gap:12px;align-items:center;margin-bottom:16px;">
            <input type="file" class="form-input" id="vehicle-photo-upload" accept="image/*" multiple style="flex:1;">
            <select class="form-select" id="photo-type-select" style="width:auto;">
              <option value="general">General</option>
              <option value="exterior">Exterior</option>
              <option value="interior">Interior</option>
              <option value="damage">Damage</option>
            </select>
            <button class="btn btn-primary" onclick="uploadVehiclePhotos('${vehicleId}')">üì§ Upload</button>
          </div>
          <div class="photo-grid" style="margin-top:16px;" id="vehicle-photos-grid">
            ${photos?.length ? photos.map(p => `
              <div class="photo-item" style="position:relative;">
                <img src="${p.url}" onclick="window.open('${p.url}','_blank')" style="cursor:pointer;">
                ${p.is_primary ? '<span style="position:absolute;top:4px;left:4px;background:var(--accent-gold);color:#000;padding:2px 6px;border-radius:4px;font-size:0.7rem;">Primary</span>' : ''}
                <div style="position:absolute;bottom:0;left:0;right:0;background:rgba(0,0,0,0.7);padding:4px;display:flex;justify-content:space-between;">
                  <button class="btn btn-ghost btn-sm" style="padding:2px 6px;font-size:0.7rem;" onclick="event.stopPropagation();window.setPrimaryPhoto('${p.id}','${vehicleId}')">‚≠ê</button>
                  <button class="btn btn-ghost btn-sm" style="padding:2px 6px;font-size:0.7rem;color:var(--accent-red);" onclick="event.stopPropagation();window.deleteVehiclePhoto('${p.id}','${vehicleId}')">üóë</button>
                </div>
              </div>
            `).join('') : '<p style="color:var(--text-muted);grid-column:1/-1;">No photos yet. Upload photos of your vehicle!</p>'}
          </div>
        </div>
        
        <div id="vehicle-tab-documents" style="display:none;">
          <div style="display:flex;gap:12px;align-items:center;margin-bottom:16px;flex-wrap:wrap;">
            <input type="file" class="form-input" id="vehicle-doc-upload" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" style="flex:1;min-width:200px;">
            <select class="form-select" id="doc-type-select" style="width:auto;">
              <option value="registration">Registration</option>
              <option value="insurance_card">Insurance Card</option>
              <option value="title">Title</option>
              <option value="inspection">Inspection</option>
              <option value="warranty">Warranty</option>
              <option value="service_record">Service Record</option>
              <option value="other">Other</option>
            </select>
            <input type="date" class="form-input" id="doc-expiration" style="width:auto;" placeholder="Expiration (optional)">
            <button class="btn btn-primary" onclick="uploadVehicleDocument('${vehicleId}')">üì§ Upload</button>
          </div>
          <div id="vehicle-documents-list">
            ${documents?.length ? documents.map(d => `
              <div style="display:flex;align-items:center;justify-content:space-between;padding:12px;background:var(--bg-input);border-radius:var(--radius-md);margin-bottom:8px;">
                <div style="display:flex;align-items:center;gap:12px;">
                  <span style="font-size:1.5rem;">${getDocIcon(d.document_type)}</span>
                  <div>
                    <div style="font-weight:500;">${formatDocType(d.document_type)}</div>
                    <div style="font-size:0.8rem;color:var(--text-muted);">
                      ${d.document_name || 'Document'} 
                      ${d.expiration_date ? `‚Ä¢ Expires: ${new Date(d.expiration_date).toLocaleDateString()}` : ''}
                    </div>
                  </div>
                </div>
                <div style="display:flex;gap:8px;">
                  <a href="${d.file_url}" target="_blank" class="btn btn-secondary btn-sm">View</a>
                  <button class="btn btn-ghost btn-sm" style="color:var(--accent-red);" onclick="window.deleteVehicleDocument('${d.id}','${vehicleId}')">üóë</button>
                </div>
              </div>
            `).join('') : '<p style="color:var(--text-muted);">No documents yet. Upload your registration, insurance card, etc.</p>'}
          </div>
        </div>
        
        <div id="vehicle-tab-history" style="display:none;">
          ${vehicleHistory.length ? vehicleHistory.map(h => `
            <div class="history-item">
              <div class="history-date">
                <div class="history-date-day">${new Date(h.service_date).getDate()}</div>
                <div class="history-date-month">${new Date(h.service_date).toLocaleDateString('en-US', { month: 'short' })}</div>
              </div>
              <div class="history-content">
                <div class="history-title">${h.service_type || h.description}</div>
                <div class="history-details">${h.mileage_at_service ? h.mileage_at_service.toLocaleString() + ' miles' : ''}</div>
              </div>
              <div class="history-cost">${h.total_cost ? '$' + h.total_cost.toFixed(2) : ''}</div>
            </div>
          `).join('') : '<p style="color:var(--text-muted)">No service history for this vehicle.</p>'}
        </div>
      `;

      document.getElementById('vehicle-details-modal').classList.add('active');
    }

    function getDocIcon(type) {
      const icons = {
        registration: 'üìã',
        insurance_card: 'üõ°Ô∏è',
        title: 'üìú',
        inspection: 'üîç',
        warranty: '‚úÖ',
        service_record: 'üîß',
        other: 'üìÑ'
      };
      return icons[type] || 'üìÑ';
    }

    function formatDocType(type) {
      const names = {
        registration: 'Registration',
        insurance_card: 'Insurance Card',
        title: 'Title',
        inspection: 'Inspection',
        warranty: 'Warranty',
        service_record: 'Service Record',
        other: 'Other'
      };
      return names[type] || type;
    }

    function showVehicleTab(tabName, vehicleId) {
      ['info', 'photos', 'documents', 'history'].forEach(t => {
        document.getElementById(`vehicle-tab-${t}`).style.display = t === tabName ? 'block' : 'none';
      });
      // Update tab active state
      document.querySelectorAll('.tabs .tab').forEach(tab => tab.classList.remove('active'));
      event.target.classList.add('active');
    }

    async function uploadVehiclePhotos(vehicleId) {
      const input = document.getElementById('vehicle-photo-upload');
      const photoType = document.getElementById('photo-type-select')?.value || 'general';
      
      if (!input.files.length) {
        showToast('Please select photos to upload', 'error');
        return;
      }
      
      showToast('Uploading photos...', 'info');
      
      let successCount = 0;
      for (const file of Array.from(input.files)) {
        const result = await window.uploadVehiclePhoto(vehicleId, file, photoType);
        if (result) successCount++;
      }
      
      if (successCount > 0) {
        showToast(`${successCount} photo(s) uploaded!`, 'success');
        input.value = ''; // Clear input
        viewVehicleDetails(vehicleId);
      }
    }

    async function uploadVehicleDocument(vehicleId) {
      const input = document.getElementById('vehicle-doc-upload');
      const docType = document.getElementById('doc-type-select')?.value || 'other';
      const expiration = document.getElementById('doc-expiration')?.value || null;
      
      if (!input.files.length) {
        showToast('Please select a document to upload', 'error');
        return;
      }
      
      showToast('Uploading document...', 'info');
      
      const file = input.files[0];
      const result = await window.uploadVehicleDocument(vehicleId, file, docType, expiration);
      
      if (result) {
        showToast('Document uploaded!', 'success');
        input.value = ''; // Clear input
        document.getElementById('doc-expiration').value = '';
        viewVehicleDetails(vehicleId);
      }
    }

    async function generateHealthReportPDF(vehicleId) {
      showToast('Generating health report...', 'info');
      
      try {
        const { jsPDF } = window.jspdf;
        
        const { data: vehicle } = await supabaseClient
          .from('vehicles')
          .select('*')
          .eq('id', vehicleId)
          .single();
        
        if (!vehicle) {
          showToast('Vehicle not found', 'error');
          return;
        }
        
        const { data: profile } = await supabaseClient
          .from('profiles')
          .select('full_name, email')
          .eq('id', vehicle.owner_id)
          .single();
        
        const { data: inspections } = await supabaseClient
          .from('inspection_reports')
          .select('*, profiles:provider_id(full_name, business_name)')
          .eq('vehicle_id', vehicleId)
          .order('inspection_date', { ascending: false })
          .limit(1);
        
        const latestInspection = inspections?.[0] || null;
        
        const { data: completedPackages } = await supabaseClient
          .from('maintenance_packages')
          .select('*, profiles:accepted_provider_id(full_name, business_name)')
          .eq('vehicle_id', vehicleId)
          .eq('status', 'completed')
          .order('completed_at', { ascending: false })
          .limit(20);
        
        const { data: recommendations } = await supabaseClient
          .from('service_recommendations')
          .select('*')
          .eq('vehicle_id', vehicleId)
          .eq('is_dismissed', false)
          .order('priority', { ascending: true });
        
        const doc = new jsPDF();
        let yPos = 20;
        const pageWidth = doc.internal.pageSize.width;
        const pageHeight = doc.internal.pageSize.height;
        const margin = 20;
        const contentWidth = pageWidth - (margin * 2);
        
        const colors = {
          gold: [212, 168, 85],
          darkBlue: [10, 10, 15],
          textPrimary: [40, 40, 50],
          textSecondary: [100, 100, 110],
          green: [74, 200, 140],
          orange: [245, 158, 11],
          red: [239, 95, 95],
          blue: [74, 124, 255]
        };
        
        function addNewPageIfNeeded(requiredSpace = 40) {
          if (yPos + requiredSpace > pageHeight - 30) {
            doc.addPage();
            yPos = 20;
            return true;
          }
          return false;
        }
        
        function drawSectionHeader(title) {
          addNewPageIfNeeded(30);
          doc.setFillColor(...colors.gold);
          doc.rect(margin, yPos, contentWidth, 8, 'F');
          doc.setFont('helvetica', 'bold');
          doc.setFontSize(11);
          doc.setTextColor(10, 10, 15);
          doc.text(title.toUpperCase(), margin + 4, yPos + 5.5);
          yPos += 14;
        }
        
        function getHealthColor(score) {
          if (score >= 90) return colors.green;
          if (score >= 70) return colors.blue;
          if (score >= 50) return colors.orange;
          return colors.red;
        }
        
        function getHealthLabel(score) {
          if (score >= 90) return 'Excellent';
          if (score >= 70) return 'Good';
          if (score >= 50) return 'Fair';
          return 'Needs Attention';
        }
        
        function getConditionColor(condition) {
          if (condition === 'good') return colors.green;
          if (condition === 'fair') return colors.blue;
          if (condition === 'needs_attention') return colors.orange;
          if (condition === 'urgent') return colors.red;
          return colors.textSecondary;
        }
        
        doc.setFillColor(...colors.darkBlue);
        doc.rect(0, 0, pageWidth, 50, 'F');
        
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(24);
        doc.setTextColor(...colors.gold);
        doc.text('MY CAR CONCIERGE', margin, 22);
        
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(14);
        doc.setTextColor(255, 255, 255);
        doc.text('Vehicle Health Report', margin, 35);
        
        doc.setFontSize(10);
        doc.setTextColor(180, 180, 190);
        doc.text(`Generated: ${new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}`, margin, 45);
        
        yPos = 60;
        
        const vehicleTitle = `${vehicle.year || ''} ${vehicle.make} ${vehicle.model}`.trim();
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(18);
        doc.setTextColor(...colors.textPrimary);
        doc.text(vehicle.nickname || vehicleTitle, margin, yPos);
        yPos += 8;
        
        if (vehicle.nickname) {
          doc.setFont('helvetica', 'normal');
          doc.setFontSize(12);
          doc.setTextColor(...colors.textSecondary);
          doc.text(vehicleTitle, margin, yPos);
          yPos += 8;
        }
        
        const healthScore = vehicle.health_score || 85;
        const healthColor = getHealthColor(healthScore);
        const healthLabel = getHealthLabel(healthScore);
        
        doc.setFillColor(...healthColor);
        doc.roundedRect(pageWidth - margin - 50, 55, 50, 20, 3, 3, 'F');
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(10);
        doc.setTextColor(255, 255, 255);
        doc.text(healthLabel, pageWidth - margin - 25, 67, { align: 'center' });
        
        yPos += 6;
        
        drawSectionHeader('Vehicle Information');
        
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(10);
        doc.setTextColor(...colors.textPrimary);
        
        const vehicleInfo = [
          ['Owner', profile?.full_name || 'N/A'],
          ['VIN', vehicle.vin || 'Not recorded'],
          ['Current Mileage', vehicle.mileage ? `${vehicle.mileage.toLocaleString()} miles` : 'Not recorded'],
          ['Color', vehicle.color || 'N/A'],
          ['License Plate', vehicle.license_plate || 'N/A']
        ];
        
        vehicleInfo.forEach(([label, value]) => {
          doc.setFont('helvetica', 'bold');
          doc.text(`${label}:`, margin, yPos);
          doc.setFont('helvetica', 'normal');
          doc.text(value, margin + 45, yPos);
          yPos += 6;
        });
        
        yPos += 6;
        
        if (latestInspection) {
          drawSectionHeader('Latest Inspection Report');
          
          const providerName = latestInspection.profiles?.business_name || latestInspection.profiles?.full_name || 'Unknown Provider';
          const inspectionDate = new Date(latestInspection.inspection_date).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
          
          doc.setFontSize(10);
          doc.setTextColor(...colors.textSecondary);
          doc.text(`Performed by ${providerName} on ${inspectionDate}`, margin, yPos);
          yPos += 10;
          
          const checkpoints = [
            { category: 'Engine & Fluids', items: [
              { name: 'Engine Oil', status: latestInspection.engine_oil, notes: latestInspection.engine_oil_notes },
              { name: 'Transmission Fluid', status: latestInspection.transmission_fluid },
              { name: 'Coolant Level', status: latestInspection.coolant_level },
              { name: 'Brake Fluid', status: latestInspection.brake_fluid },
              { name: 'Power Steering Fluid', status: latestInspection.power_steering_fluid }
            ]},
            { category: 'Brakes', items: [
              { name: 'Front Brake Pads', status: latestInspection.brake_pads_front, extra: latestInspection.brake_pads_front_percent ? `${latestInspection.brake_pads_front_percent}%` : null },
              { name: 'Rear Brake Pads', status: latestInspection.brake_pads_rear, extra: latestInspection.brake_pads_rear_percent ? `${latestInspection.brake_pads_rear_percent}%` : null },
              { name: 'Brake Rotors', status: latestInspection.brake_rotors }
            ]},
            { category: 'Tires', items: [
              { name: 'Front Left Tire', status: latestInspection.tire_front_left, extra: latestInspection.tire_front_left_tread ? `${latestInspection.tire_front_left_tread}/32"` : null },
              { name: 'Front Right Tire', status: latestInspection.tire_front_right, extra: latestInspection.tire_front_right_tread ? `${latestInspection.tire_front_right_tread}/32"` : null },
              { name: 'Rear Left Tire', status: latestInspection.tire_rear_left, extra: latestInspection.tire_rear_left_tread ? `${latestInspection.tire_rear_left_tread}/32"` : null },
              { name: 'Rear Right Tire', status: latestInspection.tire_rear_right, extra: latestInspection.tire_rear_right_tread ? `${latestInspection.tire_rear_right_tread}/32"` : null }
            ]},
            { category: 'Electrical', items: [
              { name: 'Battery', status: latestInspection.battery, extra: latestInspection.battery_voltage ? `${latestInspection.battery_voltage}V` : null },
              { name: 'Headlights', status: latestInspection.headlights },
              { name: 'Taillights', status: latestInspection.taillights },
              { name: 'Turn Signals', status: latestInspection.turn_signals }
            ]},
            { category: 'Belts & Hoses', items: [
              { name: 'Serpentine Belt', status: latestInspection.serpentine_belt },
              { name: 'Radiator Hoses', status: latestInspection.radiator_hoses },
              { name: 'Heater Hoses', status: latestInspection.heater_hoses }
            ]}
          ];
          
          const urgentItems = [];
          const attentionItems = [];
          
          checkpoints.forEach(category => {
            category.items.forEach(item => {
              if (item.status === 'urgent') urgentItems.push(item.name);
              if (item.status === 'needs_attention') attentionItems.push(item.name);
            });
          });
          
          if (urgentItems.length > 0) {
            addNewPageIfNeeded(20);
            doc.setFillColor(239, 95, 95, 0.1);
            doc.setDrawColor(...colors.red);
            doc.roundedRect(margin, yPos - 4, contentWidth, 8 + (urgentItems.length * 5), 2, 2, 'FD');
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(9);
            doc.setTextColor(...colors.red);
            doc.text('‚ö† URGENT ITEMS:', margin + 4, yPos + 2);
            yPos += 6;
            doc.setFont('helvetica', 'normal');
            urgentItems.forEach(item => {
              doc.text(`‚Ä¢ ${item}`, margin + 8, yPos);
              yPos += 5;
            });
            yPos += 6;
          }
          
          if (attentionItems.length > 0) {
            addNewPageIfNeeded(20);
            doc.setFillColor(245, 158, 11, 0.1);
            doc.setDrawColor(...colors.orange);
            doc.roundedRect(margin, yPos - 4, contentWidth, 8 + (attentionItems.length * 5), 2, 2, 'FD');
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(9);
            doc.setTextColor(...colors.orange);
            doc.text('‚ö° NEEDS ATTENTION:', margin + 4, yPos + 2);
            yPos += 6;
            doc.setFont('helvetica', 'normal');
            attentionItems.forEach(item => {
              doc.text(`‚Ä¢ ${item}`, margin + 8, yPos);
              yPos += 5;
            });
            yPos += 6;
          }
          
          checkpoints.forEach(category => {
            addNewPageIfNeeded(40);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(10);
            doc.setTextColor(...colors.textPrimary);
            doc.text(category.category, margin, yPos);
            yPos += 6;
            
            category.items.forEach(item => {
              if (!item.status || item.status === 'na') return;
              
              addNewPageIfNeeded(8);
              doc.setFont('helvetica', 'normal');
              doc.setFontSize(9);
              doc.setTextColor(...colors.textSecondary);
              doc.text(`‚Ä¢ ${item.name}`, margin + 4, yPos);
              
              const conditionColor = getConditionColor(item.status);
              doc.setFillColor(...conditionColor);
              doc.circle(margin + 70, yPos - 1.5, 2, 'F');
              doc.setTextColor(...conditionColor);
              doc.text(item.status.replace('_', ' ').toUpperCase(), margin + 74, yPos);
              
              if (item.extra) {
                doc.setTextColor(...colors.textSecondary);
                doc.text(`(${item.extra})`, margin + 105, yPos);
              }
              
              yPos += 5;
            });
            yPos += 4;
          });
          
          if (latestInspection.general_notes) {
            addNewPageIfNeeded(20);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(10);
            doc.setTextColor(...colors.textPrimary);
            doc.text('Inspector Notes:', margin, yPos);
            yPos += 5;
            doc.setFont('helvetica', 'italic');
            doc.setFontSize(9);
            doc.setTextColor(...colors.textSecondary);
            const noteLines = doc.splitTextToSize(latestInspection.general_notes, contentWidth - 10);
            doc.text(noteLines, margin + 4, yPos);
            yPos += noteLines.length * 4 + 6;
          }
        }
        
        if (completedPackages && completedPackages.length > 0) {
          yPos += 4;
          drawSectionHeader('Service History');
          
          completedPackages.forEach((pkg, index) => {
            if (index >= 10) return;
            addNewPageIfNeeded(20);
            
            const serviceDate = pkg.completed_at ? new Date(pkg.completed_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : 'N/A';
            const providerName = pkg.profiles?.business_name || pkg.profiles?.full_name || 'Unknown';
            
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(10);
            doc.setTextColor(...colors.textPrimary);
            doc.text(pkg.title, margin, yPos);
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(9);
            doc.setTextColor(...colors.textSecondary);
            doc.text(serviceDate, pageWidth - margin - 30, yPos, { align: 'right' });
            yPos += 5;
            
            doc.text(`Provider: ${providerName}`, margin + 4, yPos);
            yPos += 4;
            
            if (pkg.description) {
              const descLines = doc.splitTextToSize(pkg.description, contentWidth - 10);
              doc.text(descLines.slice(0, 2), margin + 4, yPos);
              yPos += Math.min(descLines.length, 2) * 4;
            }
            
            yPos += 4;
            doc.setDrawColor(220, 220, 230);
            doc.line(margin, yPos, pageWidth - margin, yPos);
            yPos += 4;
          });
        }
        
        if (recommendations && recommendations.length > 0) {
          yPos += 4;
          drawSectionHeader('Current Recommendations');
          
          const priorityLabels = { urgent: 'üî¥ Urgent', soon: 'üü† Soon', upcoming: 'üü° Upcoming', routine: 'üîµ Routine' };
          
          recommendations.forEach((rec, index) => {
            if (index >= 8) return;
            addNewPageIfNeeded(15);
            
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(10);
            doc.setTextColor(...colors.textPrimary);
            doc.text(rec.service_type, margin, yPos);
            
            const priorityText = priorityLabels[rec.priority] || rec.priority;
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(9);
            doc.text(priorityText, pageWidth - margin - 30, yPos, { align: 'right' });
            yPos += 5;
            
            if (rec.reason) {
              doc.setTextColor(...colors.textSecondary);
              const reasonLines = doc.splitTextToSize(rec.reason, contentWidth - 10);
              doc.text(reasonLines.slice(0, 2), margin + 4, yPos);
              yPos += Math.min(reasonLines.length, 2) * 4;
            }
            
            if (rec.estimated_cost_low && rec.estimated_cost_high) {
              doc.setTextColor(...colors.gold);
              doc.text(`Estimated: $${rec.estimated_cost_low} - $${rec.estimated_cost_high}`, margin + 4, yPos);
              yPos += 4;
            }
            
            yPos += 3;
          });
        }
        
        const totalPages = doc.internal.getNumberOfPages();
        for (let i = 1; i <= totalPages; i++) {
          doc.setPage(i);
          doc.setFillColor(240, 240, 245);
          doc.rect(0, pageHeight - 20, pageWidth, 20, 'F');
          doc.setFont('helvetica', 'normal');
          doc.setFontSize(8);
          doc.setTextColor(...colors.textSecondary);
          doc.text('Generated by My Car Concierge ‚Ä¢ mycarconcierge.co', margin, pageHeight - 10);
          doc.text(`Page ${i} of ${totalPages}`, pageWidth - margin, pageHeight - 10, { align: 'right' });
        }
        
        const filename = `${vehicleTitle.replace(/\s+/g, '_')}_Health_Report_${new Date().toISOString().split('T')[0]}.pdf`;
        doc.save(filename);
        
        showToast('Health report downloaded!', 'success');
        
      } catch (error) {
        console.error('Error generating health report:', error);
        showToast('Error generating report. Please try again.', 'error');
      }
    }

    async function deleteVehicle(vehicleId) {
      if (!confirm('Delete this vehicle? This cannot be undone.')) return;
      await supabaseClient.from('vehicles').delete().eq('id', vehicleId);
      closeModal('vehicle-details-modal');
      showToast('Vehicle removed', 'success');
      await loadVehicles();
      await loadReminders();
      updateStats();
    }

    // ========== UTILITIES ==========
    function formatFrequency(freq) {
      const map = { one_time: 'One-time', weekly: 'Weekly', bi_weekly: 'Bi-weekly', monthly: 'Monthly', quarterly: 'Quarterly', annually: 'Annually' };
      return map[freq] || freq;
    }

    function formatPickup(pref) {
      const map = { provider_pickup: 'Provider pickup', member_dropoff: 'Drop-off', rideshare: 'Rideshare', either: 'Flexible' };
      return map[pref] || pref;
    }

    function showToast(message, type = 'success') {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.innerHTML = `<span>${type === 'success' ? '‚úì' : '‚ö†'}</span><span>${message}</span>`;
      container.appendChild(toast);
      setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 300); }, 3000);
    }

    async function submitSupportTicket() {
      const category = document.getElementById('support-category').value;
      const subject = document.getElementById('support-subject').value.trim();
      const message = document.getElementById('support-message').value.trim();

      if (!subject || !message) return showToast('Please fill in all fields.', 'error');

      await supabaseClient.from('support_tickets').insert({
        user_id: currentUser.id,
        user_role: 'member',
        category: category,
        subject: subject,
        description: message,
        status: 'open',
        priority: 'normal'
      });

      closeModal('support-modal');
      showToast('Support ticket submitted. We\'ll get back to you within 24-48 hours.', 'success');
      
      // Clear form
      document.getElementById('support-subject').value = '';
      document.getElementById('support-message').value = '';
    }

    function openSupport() {
      document.getElementById('support-modal').classList.add('active');
    }

    // ========== CIRCUMVENTION REPORTING ==========
    let reportEvidenceFiles = [];

    function openReportModal() {
      // Reset form
      document.getElementById('report-type').value = '';
      document.getElementById('report-description').value = '';
      document.getElementById('report-truthful').checked = false;
      reportEvidenceFiles = [];
      document.getElementById('report-evidence-list').innerHTML = '';
      
      closeModal('message-modal');
      document.getElementById('report-modal').classList.add('active');
    }

    function handleReportEvidence(input) {
      const files = Array.from(input.files);
      files.forEach(file => {
        if (file.size > 10 * 1024 * 1024) {
          showToast(`${file.name} is too large (max 10MB)`, 'error');
          return;
        }
        reportEvidenceFiles.push(file);
      });
      renderReportEvidence();
      input.value = '';
    }

    function renderReportEvidence() {
      const container = document.getElementById('report-evidence-list');
      container.innerHTML = reportEvidenceFiles.map((file, i) => `
        <div style="display:flex;justify-content:space-between;align-items:center;padding:8px 12px;background:var(--bg-input);border-radius:var(--radius-sm);margin-bottom:4px;">
          <span style="font-size:0.85rem;">üìé ${file.name}</span>
          <button onclick="removeReportEvidence(${i})" style="background:none;border:none;color:var(--text-muted);cursor:pointer;">√ó</button>
        </div>
      `).join('');
    }

    function removeReportEvidence(index) {
      reportEvidenceFiles.splice(index, 1);
      renderReportEvidence();
    }

    async function submitReport() {
      const reportType = document.getElementById('report-type').value;
      const description = document.getElementById('report-description').value.trim();
      const truthful = document.getElementById('report-truthful').checked;

      if (!reportType) return showToast('Please select a violation type', 'error');
      if (!description) return showToast('Please describe what happened', 'error');
      if (!truthful) return showToast('Please confirm this report is truthful', 'error');

      showToast('Submitting report...', 'success');

      try {
        // Upload evidence files if any
        let evidenceUrls = [];
        for (const file of reportEvidenceFiles) {
          const fileName = `${currentUser.id}/${Date.now()}-${file.name}`;
          const { data, error } = await supabaseClient.storage
            .from('report-evidence')
            .upload(fileName, file);
          
          if (!error && data) {
            const { data: urlData } = supabaseClient.storage
              .from('report-evidence')
              .getPublicUrl(fileName);
            evidenceUrls.push(urlData.publicUrl);
          }
        }

        // Create report record
        const { error } = await supabaseClient.from('circumvention_reports').insert({
          reporter_id: currentUser.id,
          provider_id: currentMessageProvider,
          package_id: currentViewPackage,
          report_type: reportType,
          description: description,
          evidence_urls: evidenceUrls.length > 0 ? evidenceUrls : null,
          status: 'pending'
        });

        if (error) {
          console.error('Report submission error:', error);
          // If table doesn't exist, still show success (report noted)
          if (error.code === '42P01') {
            closeModal('report-modal');
            showToast('Report received. Our team will investigate. Thank you for helping keep MCC safe!', 'success');
            return;
          }
          throw error;
        }

        closeModal('report-modal');
        showToast('Report submitted successfully. Our team will investigate and you may be eligible for a reward if the violation is confirmed. Thank you!', 'success');
      } catch (err) {
        console.error('Report error:', err);
        showToast('Report noted. Our team will review. Thank you!', 'success');
        closeModal('report-modal');
      }
    }

    // ========== NOTIFICATIONS ==========
    let notifications = [];

    async function loadNotifications() {
      try {
        const { data, error } = await supabaseClient
          .from('notifications')
          .select('*')
          .eq('user_id', currentUser.id)
          .order('created_at', { ascending: false })
          .limit(50);

        if (error) {
          console.log('Notifications table may not exist:', error);
          return;
        }

        notifications = data || [];
        renderNotifications();
        updateNotificationBadge();
      } catch (err) {
        console.log('loadNotifications error:', err);
      }
    }

    function updateNotificationBadge() {
      const unreadCount = notifications.filter(n => !n.read).length;
      const badge = document.getElementById('notif-count');
      if (unreadCount > 0) {
        badge.textContent = unreadCount > 9 ? '9+' : unreadCount;
        badge.style.display = 'inline';
      } else {
        badge.style.display = 'none';
      }
    }

    function renderNotifications() {
      const container = document.getElementById('notifications-list');
      
      if (!notifications.length) {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üîî</div><p>No notifications yet.</p></div>';
        return;
      }

      const notifIcons = {
        'bid_received': 'üí∞',
        'bid_accepted': '‚úÖ',
        'work_started': 'üîß',
        'work_completed': '‚úì',
        'message_received': 'üí¨',
        'payment_released': 'üí≥',
        'upsell_request': '‚ö†Ô∏è',
        'reminder': 'üîî',
        'default': 'üì¢'
      };

      container.innerHTML = notifications.map(n => {
        const icon = notifIcons[n.type] || notifIcons['default'];
        const timeAgo = formatTimeAgo(n.created_at);
        const unreadClass = n.read ? '' : 'unread';
        
        return `
          <div class="notification-item ${unreadClass}" onclick="handleNotificationClick('${n.id}', '${n.link_type || ''}', '${n.link_id || ''}')" style="display:flex;gap:16px;padding:16px 20px;background:${n.read ? 'var(--bg-card)' : 'var(--accent-gold-soft)'};border:1px solid ${n.read ? 'var(--border-subtle)' : 'rgba(212,168,85,0.3)'};border-radius:var(--radius-md);margin-bottom:12px;cursor:pointer;transition:all 0.15s;">
            <div style="font-size:24px;">${icon}</div>
            <div style="flex:1;">
              <div style="font-weight:${n.read ? '400' : '600'};margin-bottom:4px;">${n.title}</div>
              ${n.message ? `<div style="font-size:0.9rem;color:var(--text-secondary);line-height:1.5;">${n.message}</div>` : ''}
              <div style="font-size:0.8rem;color:var(--text-muted);margin-top:8px;">${timeAgo}</div>
            </div>
            ${!n.read ? '<div style="width:10px;height:10px;background:var(--accent-gold);border-radius:50%;flex-shrink:0;margin-top:6px;"></div>' : ''}
          </div>
        `;
      }).join('');
    }

    function formatTimeAgo(timestamp) {
      const date = new Date(timestamp);
      const now = new Date();
      const diff = now - date;
      
      const minutes = Math.floor(diff / 60000);
      const hours = Math.floor(diff / 3600000);
      const days = Math.floor(diff / 86400000);
      
      if (minutes < 1) return 'Just now';
      if (minutes < 60) return `${minutes}m ago`;
      if (hours < 24) return `${hours}h ago`;
      if (days < 7) return `${days}d ago`;
      return date.toLocaleDateString();
    }

    async function handleNotificationClick(notifId, linkType, linkId) {
      // Mark as read
      await supabaseClient
        .from('notifications')
        .update({ read: true, read_at: new Date().toISOString() })
        .eq('id', notifId);

      // Navigate based on link type
      if (linkType === 'package' && linkId) {
        showSection('packages');
        setTimeout(() => viewPackage(linkId), 100);
      } else if (linkType === 'message' && linkId) {
        showSection('messages');
      } else if (linkType === 'upsell') {
        showSection('upsells');
      }

      // Refresh notifications
      await loadNotifications();
    }

    async function markAllNotificationsRead() {
      const unreadIds = notifications.filter(n => !n.read).map(n => n.id);
      if (!unreadIds.length) {
        showToast('All notifications already read', 'success');
        return;
      }

      await supabaseClient
        .from('notifications')
        .update({ read: true, read_at: new Date().toISOString() })
        .in('id', unreadIds);

      showToast('All notifications marked as read', 'success');
      await loadNotifications();
    }

    // Create notification helper (called when actions happen)
    async function createNotification(type, title, message, linkType = null, linkId = null) {
      try {
        await supabaseClient.from('notifications').insert({
          user_id: currentUser.id,
          type,
          title,
          message,
          link_type: linkType,
          link_id: linkId
        });
      } catch (err) {
        console.log('Could not create notification:', err);
      }
    }

    // ========== SETTINGS ==========
    async function saveSettings() {
      const fullName = document.getElementById('settings-name').value.trim();
      const phone = document.getElementById('settings-phone').value.trim();
      const zipCode = document.getElementById('settings-zip').value.trim();
      const city = document.getElementById('settings-city').value.trim();
      const state = document.getElementById('settings-state').value;

      // SMS preferences
      const smsEnabled = document.getElementById('sms-enabled').checked;
      const smsBidReceived = document.getElementById('sms-bid-received').checked;
      const smsWorkCompleted = document.getElementById('sms-work-completed').checked;
      const smsNewMessage = document.getElementById('sms-new-message').checked;
      const smsBiddingEnding = document.getElementById('sms-bidding-ending')?.checked || false;

      if (!zipCode) {
        showToast('Please enter your ZIP code', 'error');
        return;
      }

      // Validate phone if SMS enabled
      if (smsEnabled && !phone) {
        showToast('Please enter your phone number to enable SMS notifications', 'error');
        return;
      }

      try {
        const { error } = await supabaseClient.from('profiles').update({
          full_name: fullName || null,
          phone: phone || null,
          zip_code: zipCode,
          city: city || null,
          state: state || null,
          sms_notifications: smsEnabled,
          sms_bid_received: smsBidReceived,
          sms_work_completed: smsWorkCompleted,
          sms_new_message: smsNewMessage,
          sms_bidding_ending: smsBiddingEnding
        }).eq('id', currentUser.id);

        if (error) throw error;

        // Update local profile
        userProfile.full_name = fullName;
        userProfile.phone = phone;
        userProfile.zip_code = zipCode;
        userProfile.city = city;
        userProfile.state = state;
        userProfile.sms_notifications = smsEnabled;

        // Update display name
        const name = fullName || 'Member';
        const initials = name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
        document.getElementById('user-name').textContent = name;
        document.getElementById('user-avatar').textContent = initials;

        // Hide location warning
        document.getElementById('location-status').style.display = 'none';

        showToast('Settings saved!', 'success');
      } catch (err) {
        console.error('Save settings error:', err);
        showToast('Failed to save settings', 'error');
      }
    }

    function toggleSmsOptions() {
      const enabled = document.getElementById('sms-enabled').checked;
      document.getElementById('sms-options').style.display = enabled ? 'block' : 'none';
    }

    // ==================== SERVICE COORDINATION FUNCTIONS ====================

    // Store current logistics context
    let currentLogisticsContext = {
      packageId: null,
      memberId: null,
      providerId: null,
      appointmentId: null,
      transferId: null
    };

    // Load logistics data for a package
    let driverLocationRefreshInterval = null;
    
    async function loadLogisticsData(packageId) {
      try {
        const [appointmentResult, transferResult, locationResult, driverLocationResult] = await Promise.all([
          getAppointment(packageId),
          getVehicleTransfer(packageId),
          getActiveLocationShare(packageId),
          window.getDriverLocation(packageId)
        ]);

        renderAppointmentStatus(packageId, appointmentResult.data);
        renderTransferStatus(packageId, transferResult.data);
        renderLocationStatus(packageId, locationResult.data, driverLocationResult.data);
        loadEvidenceTimeline(packageId);
        loadKeyExchangeTimeline(packageId);
        loadInspectionReport(packageId);
        
        if (driverLocationRefreshInterval) {
          clearInterval(driverLocationRefreshInterval);
        }
        driverLocationRefreshInterval = setInterval(async () => {
          const { data: driverLoc } = await window.getDriverLocation(packageId);
          const { data: providerLoc } = await getActiveLocationShare(packageId);
          renderLocationStatus(packageId, providerLoc, driverLoc);
        }, 18000);
      } catch (err) {
        console.error('Error loading logistics data:', err);
      }
    }

    // Render appointment status
    function renderAppointmentStatus(packageId, appointment) {
      const container = document.getElementById(`appointment-status-${packageId}`);
      if (!container) return;

      if (!appointment) {
        container.innerHTML = `
          <div style="padding:16px;background:var(--bg-input);border-radius:var(--radius-md);border:1px dashed var(--border-subtle);">
            <div style="color:var(--text-muted);font-size:0.9rem;text-align:center;">
              <span style="font-size:1.5rem;display:block;margin-bottom:8px;">üìÖ</span>
              No appointment scheduled yet. Propose a time to get started.
            </div>
          </div>
        `;
        return;
      }

      const statusColors = {
        'proposed': { bg: 'var(--accent-gold-soft)', color: 'var(--accent-gold)', icon: '‚è≥' },
        'counter_proposed': { bg: 'var(--accent-orange-soft)', color: 'var(--accent-orange)', icon: 'üîÑ' },
        'confirmed': { bg: 'var(--accent-green-soft)', color: 'var(--accent-green)', icon: '‚úì' },
        'cancelled': { bg: 'rgba(239, 95, 95, 0.15)', color: 'var(--accent-red)', icon: '‚úó' }
      };
      const status = statusColors[appointment.status] || statusColors['proposed'];
      const date = new Date(appointment.proposed_date).toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
      const timeStart = appointment.proposed_time_start || 'TBD';
      const timeEnd = appointment.proposed_time_end || 'TBD';
      const proposedByMe = appointment.proposed_by === currentUser?.id;

      container.innerHTML = `
        <div style="padding:16px;background:${status.bg};border-radius:var(--radius-md);border:1px solid ${status.color}30;">
          <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px;">
            <div>
              <div style="font-size:0.8rem;text-transform:uppercase;letter-spacing:0.05em;color:${status.color};margin-bottom:4px;">
                ${status.icon} ${appointment.status.replace('_', ' ').toUpperCase()}
              </div>
              <div style="font-size:1.1rem;font-weight:600;color:var(--text-primary);">${date}</div>
              <div style="font-size:0.9rem;color:var(--text-secondary);margin-top:4px;">üïê ${timeStart} - ${timeEnd}</div>
            </div>
            ${appointment.estimated_days ? `<div style="text-align:right;"><div style="font-size:0.8rem;color:var(--text-muted);">Est. Duration</div><div style="font-weight:600;color:var(--text-primary);">${appointment.estimated_days} day(s)</div></div>` : ''}
          </div>
          ${appointment.notes ? `<div style="font-size:0.85rem;color:var(--text-secondary);padding:12px;background:var(--bg-input);border-radius:var(--radius-sm);margin-bottom:12px;">"${appointment.notes}"</div>` : ''}
          <div style="display:flex;gap:8px;flex-wrap:wrap;">
            ${appointment.status === 'proposed' && !proposedByMe ? `
              <button class="btn btn-success btn-sm" onclick="confirmScheduleFromMember('${appointment.id}', '${packageId}')">‚úì Confirm Time</button>
              <button class="btn btn-secondary btn-sm" onclick="proposeNewTimeFromMember('${appointment.id}', '${packageId}')">üîÑ Propose Different Time</button>
            ` : ''}
            ${appointment.status === 'counter_proposed' && proposedByMe ? `
              <button class="btn btn-success btn-sm" onclick="acceptCounterProposalFromMember('${appointment.id}', '${packageId}')">‚úì Accept New Time</button>
              <button class="btn btn-secondary btn-sm" onclick="proposeNewTimeFromMember('${appointment.id}', '${packageId}')">üîÑ Counter Again</button>
            ` : ''}
            ${appointment.status === 'proposed' && proposedByMe ? `
              <div style="font-size:0.85rem;color:var(--text-muted);">‚è≥ Waiting for provider response...</div>
            ` : ''}
            ${appointment.status === 'counter_proposed' && !proposedByMe ? `
              <button class="btn btn-success btn-sm" onclick="acceptCounterProposalFromMember('${appointment.id}', '${packageId}')">‚úì Accept New Time</button>
              <button class="btn btn-secondary btn-sm" onclick="proposeNewTimeFromMember('${appointment.id}', '${packageId}')">üîÑ Counter Again</button>
            ` : ''}
            ${appointment.status === 'confirmed' ? `
              <div style="font-size:0.85rem;color:var(--accent-green);">‚úì Appointment confirmed! See you on ${date}.</div>
            ` : ''}
          </div>
        </div>
      `;
    }

    // Render transfer status with timeline
    function renderTransferStatus(packageId, transfer) {
      const container = document.getElementById(`transfer-status-${packageId}`);
      if (!container) return;

      if (!transfer) {
        container.innerHTML = `
          <div style="padding:16px;background:var(--bg-input);border-radius:var(--radius-md);border:1px dashed var(--border-subtle);">
            <div style="color:var(--text-muted);font-size:0.9rem;text-align:center;">
              <span style="font-size:1.5rem;display:block;margin-bottom:8px;">üöó</span>
              No transfer method set. Configure how your vehicle will be delivered.
            </div>
          </div>
        `;
        return;
      }

      const transferTypes = {
        'member_dropoff': { label: 'Member Drop-off', icon: 'üöó', desc: 'You bring the vehicle to the provider' },
        'provider_pickup': { label: 'Provider Pickup', icon: 'üöö', desc: 'Provider picks up from your location' },
        'mobile_service': { label: 'Mobile Service', icon: 'üîß', desc: 'Service performed at your location' },
        'towing': { label: 'Towing Required', icon: 'üöú', desc: 'Vehicle will be towed' }
      };
      const type = transferTypes[transfer.transfer_type] || transferTypes['member_dropoff'];

      const statusSteps = [
        { key: 'pending', label: 'Pending', icon: '‚è≥' },
        { key: 'scheduled', label: 'Scheduled', icon: 'üìÖ' },
        { key: 'in_transit_to_provider', label: 'In Transit', icon: 'üöó' },
        { key: 'with_provider', label: 'With Provider', icon: 'üîß' },
        { key: 'work_complete', label: 'Work Complete', icon: '‚úÖ' },
        { key: 'in_transit_to_member', label: 'Returning', icon: 'üè†' },
        { key: 'returned', label: 'Returned', icon: '‚úì' }
      ];

      const currentStepIndex = statusSteps.findIndex(s => s.key === transfer.vehicle_status) || 0;

      container.innerHTML = `
        <div style="padding:16px;background:var(--bg-input);border-radius:var(--radius-md);">
          <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;">
            <div style="width:48px;height:48px;background:var(--accent-blue-soft);border-radius:var(--radius-md);display:flex;align-items:center;justify-content:center;font-size:24px;">${type.icon}</div>
            <div>
              <div style="font-weight:600;color:var(--text-primary);">${type.label}</div>
              <div style="font-size:0.85rem;color:var(--text-secondary);">${type.desc}</div>
            </div>
          </div>
          
          <!-- Timeline -->
          <div style="margin-bottom:16px;">
            <div style="display:flex;justify-content:space-between;position:relative;padding:0 4px;">
              <div style="position:absolute;top:12px;left:20px;right:20px;height:3px;background:var(--border-subtle);z-index:0;"></div>
              <div style="position:absolute;top:12px;left:20px;height:3px;background:var(--accent-green);z-index:1;width:${Math.max(0, (currentStepIndex / (statusSteps.length - 1)) * 100)}%;transition:width 0.3s;"></div>
              ${statusSteps.map((step, i) => `
                <div style="display:flex;flex-direction:column;align-items:center;z-index:2;flex:1;">
                  <div style="width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;
                    ${i < currentStepIndex ? 'background:var(--accent-green);color:#022c22;' : 
                      i === currentStepIndex ? 'background:var(--accent-blue);color:white;animation:pulse 2s infinite;' : 
                      'background:var(--bg-elevated);border:2px solid var(--border-subtle);color:var(--text-muted);'}">
                    ${i <= currentStepIndex ? step.icon : (i + 1)}
                  </div>
                  <div style="font-size:0.65rem;color:${i <= currentStepIndex ? 'var(--text-primary)' : 'var(--text-muted)'};margin-top:6px;text-align:center;max-width:60px;">${step.label}</div>
                </div>
              `).join('')}
            </div>
          </div>

          ${transfer.pickup_address ? `<div style="font-size:0.85rem;color:var(--text-secondary);margin-bottom:8px;">üìç Pickup: ${transfer.pickup_address}</div>` : ''}
          ${transfer.return_address ? `<div style="font-size:0.85rem;color:var(--text-secondary);margin-bottom:8px;">üè† Return: ${transfer.return_address}</div>` : ''}
          
          <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:12px;">
            ${transfer.vehicle_status === 'pending' || transfer.vehicle_status === 'scheduled' ? `
              <button class="btn btn-success btn-sm" onclick="confirmVehicleHandoff('${transfer.id}', '${packageId}', 'pickup')">‚úì Confirm Handoff</button>
            ` : ''}
            ${transfer.vehicle_status === 'in_transit_to_member' || transfer.vehicle_status === 'work_complete' ? `
              <button class="btn btn-success btn-sm" onclick="confirmVehicleHandoff('${transfer.id}', '${packageId}', 'return')">‚úì Confirm Vehicle Received</button>
            ` : ''}
          </div>
        </div>
      `;
    }

    // Render location status
    function renderLocationStatus(packageId, locationShare, driverLocation) {
      const container = document.getElementById(`location-status-${packageId}`);
      if (!container) return;

      let html = '';
      
      if (driverLocation && driverLocation.lat && driverLocation.lng) {
        const updatedAt = new Date(driverLocation.updated_at).toLocaleTimeString();
        const updatedDate = new Date(driverLocation.updated_at).toLocaleDateString();
        const mapsUrl = `https://www.google.com/maps?q=${driverLocation.lat},${driverLocation.lng}`;
        const driverName = driverLocation.profiles?.business_name || driverLocation.profiles?.provider_alias || driverLocation.profiles?.full_name || 'Driver';
        const trackingTypeLabels = {
          'pickup': 'üöó Picking up your vehicle',
          'return': 'üöó Returning your vehicle',
          'in_transit': 'üöó In transit'
        };
        const trackingLabel = trackingTypeLabels[driverLocation.tracking_type] || 'üöó Driver is on the way';
        
        html += `
          <div style="padding:16px;background:var(--accent-green-soft);border:1px solid rgba(74,200,140,0.3);border-radius:var(--radius-md);margin-bottom:12px;">
            <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px;">
              <div style="width:12px;height:12px;border-radius:50%;background:var(--accent-green);animation:pulse 1.5s ease-in-out infinite;flex-shrink:0;"></div>
              <div>
                <div style="font-weight:600;color:var(--accent-green);font-size:0.95rem;">${trackingLabel}</div>
                <div style="font-size:0.8rem;color:var(--text-secondary);">${driverName} is sharing live location</div>
              </div>
            </div>
            
            <div style="background:var(--bg-input);border-radius:var(--radius-md);padding:16px;margin-bottom:12px;">
              <div style="display:flex;justify-content:space-between;align-items:flex-start;">
                <div>
                  <div style="font-size:0.75rem;text-transform:uppercase;letter-spacing:0.05em;color:var(--text-muted);margin-bottom:6px;">
                    üìç Live Location
                  </div>
                  <div style="font-size:0.95rem;color:var(--text-primary);margin-bottom:4px;">
                    ${parseFloat(driverLocation.lat).toFixed(6)}, ${parseFloat(driverLocation.lng).toFixed(6)}
                  </div>
                  ${driverLocation.speed ? `<div style="font-size:0.85rem;color:var(--text-secondary);margin-bottom:4px;">Speed: ${driverLocation.speed} mph</div>` : ''}
                  <div style="font-size:0.8rem;color:var(--text-muted);">Last update: ${updatedAt} on ${updatedDate}</div>
                </div>
                <a href="${mapsUrl}" target="_blank" class="btn btn-primary btn-sm" style="text-decoration:none;">
                  üó∫Ô∏è Open Maps
                </a>
              </div>
            </div>
            
            <div style="text-align:center;">
              <div style="display:inline-block;padding:8px 16px;background:var(--bg-card);border-radius:var(--radius-sm);border:1px solid var(--border-subtle);">
                <iframe 
                  src="https://www.openstreetmap.org/export/embed.html?bbox=${parseFloat(driverLocation.lng) - 0.01},${parseFloat(driverLocation.lat) - 0.01},${parseFloat(driverLocation.lng) + 0.01},${parseFloat(driverLocation.lat) + 0.01}&layer=mapnik&marker=${driverLocation.lat},${driverLocation.lng}" 
                  style="width:100%;min-width:280px;height:180px;border:none;border-radius:var(--radius-sm);"
                  loading="lazy"
                ></iframe>
              </div>
            </div>
          </div>
        `;
      }
      
      if (locationShare) {
        const isFromMe = locationShare.shared_by === currentUser?.id;
        const sharedAt = new Date(locationShare.shared_at).toLocaleString();
        const mapsUrl = `https://www.google.com/maps?q=${locationShare.latitude},${locationShare.longitude}`;

        html += `
          <div style="padding:16px;background:${isFromMe ? 'var(--accent-green-soft)' : 'var(--accent-blue-soft)'};border-radius:var(--radius-md);">
            <div style="display:flex;justify-content:space-between;align-items:flex-start;">
              <div>
                <div style="font-size:0.8rem;text-transform:uppercase;letter-spacing:0.05em;color:${isFromMe ? 'var(--accent-green)' : 'var(--accent-blue)'};margin-bottom:4px;">
                  ${isFromMe ? 'üìç Your Shared Location' : 'üìç Provider Location (One-time)'}
                </div>
                ${locationShare.address ? `<div style="font-size:0.95rem;color:var(--text-primary);margin-bottom:4px;">${locationShare.address}</div>` : ''}
                <div style="font-size:0.8rem;color:var(--text-muted);">Shared: ${sharedAt}</div>
                ${locationShare.message ? `<div style="font-size:0.85rem;color:var(--text-secondary);margin-top:8px;">"${locationShare.message}"</div>` : ''}
              </div>
              <a href="${mapsUrl}" target="_blank" class="btn btn-sm btn-secondary" style="text-decoration:none;">
                üó∫Ô∏è Open Maps
              </a>
            </div>
          </div>
        `;
      }
      
      if (!html) {
        html = `
          <div style="color:var(--text-muted);font-size:0.9rem;">
            Share your location to help the provider find you for pickup. When the driver is on the way, you'll see their live location here.
          </div>
        `;
      }
      
      container.innerHTML = html;
    }

    // ========== MEMBER EVIDENCE FUNCTIONS ==========

    const memberEvidenceTypeLabels = {
      'pre_pickup': { label: 'Pre-Pickup Condition', icon: 'üîµ', color: 'var(--accent-blue)' },
      'arrival_shop': { label: 'Arrival at Shop', icon: 'üü†', color: '#f59e0b' },
      'post_service': { label: 'Post-Service Condition', icon: 'üü¢', color: 'var(--accent-green)' },
      'return': { label: 'Vehicle Return', icon: 'üü£', color: '#a855f7' }
    };

    async function loadEvidenceTimeline(packageId) {
      const container = document.getElementById(`evidence-timeline-${packageId}`);
      if (!container) return;

      try {
        const { data: evidence } = await window.getPackageEvidence(packageId);

        if (!evidence || evidence.length === 0) {
          container.innerHTML = `
            <div style="padding:16px;background:var(--bg-input);border-radius:var(--radius-md);border:1px dashed var(--border-subtle);">
              <div style="color:var(--text-muted);font-size:0.9rem;text-align:center;">
                <span style="font-size:1.5rem;display:block;margin-bottom:8px;">üì∏</span>
                No evidence captured yet. Document your vehicle condition before pickup.
              </div>
            </div>
          `;
          return;
        }

        const timeline = evidence.map(e => {
          const typeInfo = memberEvidenceTypeLabels[e.type] || { label: e.type, icon: 'üì∑', color: 'var(--text-muted)' };
          const photoGrid = e.photos?.length ? `
            <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:12px;">
              ${e.photos.slice(0, 4).map(url => `
                <div style="width:60px;height:60px;border-radius:6px;overflow:hidden;border:1px solid var(--border-subtle);cursor:pointer;" onclick="window.open('${url}','_blank')">
                  <img src="${url}" style="width:100%;height:100%;object-fit:cover;">
                </div>
              `).join('')}
              ${e.photos.length > 4 ? `<div style="width:60px;height:60px;border-radius:6px;background:var(--bg-input);display:flex;align-items:center;justify-content:center;font-size:0.8rem;color:var(--text-muted);">+${e.photos.length - 4}</div>` : ''}
            </div>
          ` : '';

          const createdByName = e.profiles?.business_name || e.profiles?.full_name || (e.created_by_role === 'member' ? 'You' : 'Provider');

          return `
            <div style="display:flex;gap:12px;padding:12px;background:var(--bg-input);border-radius:var(--radius-md);border-left:3px solid ${typeInfo.color};margin-bottom:12px;">
              <div style="font-size:20px;">${typeInfo.icon}</div>
              <div style="flex:1;">
                <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:4px;">
                  <div style="font-weight:600;font-size:0.9rem;">${typeInfo.label}</div>
                  <div style="font-size:0.75rem;color:var(--text-muted);">by ${createdByName}</div>
                </div>
                <div style="display:flex;gap:16px;font-size:0.82rem;color:var(--text-secondary);margin-bottom:4px;">
                  <span>üî¢ ${e.odometer?.toLocaleString() || 'N/A'} mi</span>
                  <span>‚õΩ ${e.fuel_level || 'N/A'}</span>
                </div>
                ${e.exterior_condition ? `<div style="font-size:0.82rem;color:var(--text-secondary);margin-top:4px;"><strong>Exterior:</strong> ${e.exterior_condition}</div>` : ''}
                ${e.interior_condition ? `<div style="font-size:0.82rem;color:var(--text-secondary);margin-top:4px;"><strong>Interior:</strong> ${e.interior_condition}</div>` : ''}
                ${e.notes ? `<div style="font-size:0.85rem;color:var(--text-secondary);margin-top:6px;">${e.notes}</div>` : ''}
                <div style="font-size:0.75rem;color:var(--text-muted);margin-top:8px;">${new Date(e.created_at).toLocaleString()}</div>
                ${photoGrid}
              </div>
            </div>
          `;
        }).join('');

        container.innerHTML = timeline || '<div style="color:var(--text-muted);font-size:0.9rem;">No evidence captured yet.</div>';
      } catch (err) {
        console.error('Error loading evidence timeline:', err);
        container.innerHTML = '<div style="color:var(--accent-red);font-size:0.9rem;">Failed to load evidence.</div>';
      }
    }

    async function loadKeyExchangeTimeline(packageId) {
      const container = document.getElementById(`key-exchange-timeline-${packageId}`);
      if (!container) return;

      try {
        const { data: keyExchanges, error } = await supabaseClient
          .from('key_exchanges')
          .select('*')
          .eq('package_id', packageId)
          .order('created_at', { ascending: true });

        if (error) throw error;

        if (!keyExchanges || keyExchanges.length === 0) {
          container.innerHTML = `
            <div style="padding:16px;background:var(--bg-input);border-radius:var(--radius-md);border:1px dashed var(--border-subtle);">
              <div style="color:var(--text-muted);font-size:0.9rem;text-align:center;">
                <span style="font-size:1.5rem;display:block;margin-bottom:8px;">üîë</span>
                No key exchanges recorded yet. The provider will document key handoffs at pickup and return.
              </div>
            </div>
          `;
          return;
        }

        const stageInfo = {
          'pickup': { label: 'Pickup Key Exchange', icon: 'üîµ', color: 'var(--accent-blue)' },
          'return': { label: 'Return Key Exchange', icon: 'üü£', color: '#a855f7' }
        };

        const timeline = keyExchanges.map(exchange => {
          const info = stageInfo[exchange.stage] || { label: exchange.stage, icon: 'üîë', color: 'var(--text-muted)' };
          
          const photoGrid = `
            <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:12px;">
              ${exchange.driver_id_photo_url ? `
                <div style="width:60px;height:60px;border-radius:6px;overflow:hidden;border:2px solid var(--accent-gold);position:relative;cursor:pointer;" onclick="window.open('${exchange.driver_id_photo_url}','_blank')">
                  <img src="${exchange.driver_id_photo_url}" style="width:100%;height:100%;object-fit:cover;">
                  <div style="position:absolute;top:2px;right:2px;background:var(--accent-gold);color:#000;padding:1px 3px;border-radius:3px;font-size:0.55rem;font-weight:600;">ID</div>
                </div>
              ` : ''}
              ${(exchange.key_photos || []).slice(0, 3).map(url => `
                <div style="width:60px;height:60px;border-radius:6px;overflow:hidden;border:1px solid var(--border-subtle);cursor:pointer;" onclick="window.open('${url}','_blank')">
                  <img src="${url}" style="width:100%;height:100%;object-fit:cover;">
                </div>
              `).join('')}
            </div>
          `;

          return `
            <div style="display:flex;gap:12px;padding:12px;background:var(--bg-input);border-radius:var(--radius-md);border-left:3px solid ${exchange.verified_at ? 'var(--accent-green)' : info.color};margin-bottom:12px;">
              <div style="font-size:20px;">${info.icon}</div>
              <div style="flex:1;">
                <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:4px;">
                  <div style="display:flex;align-items:center;gap:8px;">
                    <span style="font-weight:600;font-size:0.9rem;">${info.label}</span>
                    ${exchange.verified_at ? `<span style="background:var(--accent-green);color:#fff;padding:2px 8px;border-radius:12px;font-size:0.7rem;font-weight:600;">‚úì Verified</span>` : ''}
                  </div>
                  <div style="font-size:0.75rem;color:var(--text-muted);">by Provider</div>
                </div>
                ${exchange.verified_at ? `<div style="font-size:0.75rem;color:var(--text-muted);margin-bottom:4px;">${new Date(exchange.verified_at).toLocaleString()}</div>` : ''}
                ${exchange.notes ? `<div style="font-size:0.85rem;color:var(--text-secondary);margin-top:6px;">${exchange.notes}</div>` : ''}
                ${photoGrid}
              </div>
            </div>
          `;
        }).join('');

        container.innerHTML = timeline || '<div style="color:var(--text-muted);font-size:0.9rem;">No key exchanges recorded yet.</div>';
      } catch (err) {
        console.error('Error loading key exchange timeline:', err);
        container.innerHTML = '<div style="color:var(--accent-red);font-size:0.9rem;">Failed to load key exchanges.</div>';
      }
    }

    function openMemberEvidenceModal(packageId, type) {
      document.getElementById('member-evidence-package-id').value = packageId;
      document.getElementById('member-evidence-type').value = type;
      document.getElementById('member-evidence-modal-title').textContent = memberEvidenceTypeLabels[type]?.label || 'Document Vehicle Condition';
      document.getElementById('member-evidence-photo-preview').innerHTML = '';
      document.getElementById('member-evidence-photos').value = '';
      document.getElementById('member-evidence-odometer').value = '';
      document.getElementById('member-evidence-fuel').value = '';
      document.getElementById('member-evidence-exterior').value = '';
      document.getElementById('member-evidence-interior').value = '';
      document.getElementById('member-evidence-notes').value = '';
      document.getElementById('member-evidence-upload-status').style.display = 'none';
      document.getElementById('member-evidence-modal').classList.add('active');
    }

    function previewMemberEvidencePhotos() {
      const fileInput = document.getElementById('member-evidence-photos');
      const preview = document.getElementById('member-evidence-photo-preview');
      const files = Array.from(fileInput.files).slice(0, 10);
      preview.innerHTML = '';
      files.forEach((file) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const img = document.createElement('div');
          img.style.cssText = 'width:80px;height:80px;border-radius:8px;overflow:hidden;border:1px solid var(--border-subtle);position:relative;';
          img.innerHTML = `<img src="${e.target.result}" style="width:100%;height:100%;object-fit:cover;">`;
          preview.appendChild(img);
        };
        reader.readAsDataURL(file);
      });
    }

    async function submitMemberEvidence() {
      const packageId = document.getElementById('member-evidence-package-id').value;
      const type = document.getElementById('member-evidence-type').value;
      const fileInput = document.getElementById('member-evidence-photos');
      const odometer = document.getElementById('member-evidence-odometer').value;
      const fuelLevel = document.getElementById('member-evidence-fuel').value;
      const exteriorCondition = document.getElementById('member-evidence-exterior').value;
      const interiorCondition = document.getElementById('member-evidence-interior').value;
      const notes = document.getElementById('member-evidence-notes').value;

      if (!odometer || !fuelLevel) {
        return showToast('Please provide odometer reading and fuel level', 'error');
      }

      const files = Array.from(fileInput.files).slice(0, 10);
      if (files.length === 0) {
        return showToast('Please add at least one photo', 'error');
      }

      const btn = document.getElementById('submit-member-evidence-btn');
      const statusDiv = document.getElementById('member-evidence-upload-status');
      btn.disabled = true;
      btn.textContent = 'Uploading...';
      statusDiv.style.display = 'block';
      statusDiv.innerHTML = '<p style="color:var(--accent-gold);">üì§ Uploading photos...</p>';

      try {
        const photoUrls = await window.uploadEvidencePhotos(packageId, files);
        if (photoUrls.length === 0) {
          throw new Error('Failed to upload photos');
        }

        statusDiv.innerHTML = '<p style="color:var(--accent-gold);">üìù Saving evidence...</p>';

        let lat = null, lng = null;
        try {
          const pos = await new Promise((resolve, reject) => {
            navigator.geolocation.getCurrentPosition(resolve, reject, { timeout: 5000 });
          });
          lat = pos.coords.latitude;
          lng = pos.coords.longitude;
        } catch (e) { }

        const { data, error } = await window.saveEvidence({
          packageId,
          type,
          photos: photoUrls,
          odometer: parseInt(odometer),
          fuelLevel,
          exteriorCondition,
          interiorCondition,
          notes,
          role: 'member',
          lat,
          lng
        });

        if (error) throw error;

        statusDiv.innerHTML = '<p style="color:var(--accent-green);">‚úÖ Evidence saved successfully!</p>';
        showToast('Vehicle condition documented!', 'success');

        setTimeout(() => {
          closeModal('member-evidence-modal');
          loadEvidenceTimeline(packageId);
        }, 1500);
      } catch (err) {
        console.error('Evidence submission error:', err);
        statusDiv.innerHTML = `<p style="color:var(--accent-red);">‚ùå Error: ${err.message || 'Failed to save evidence'}</p>`;
        showToast('Failed to save evidence', 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = 'üì∏ Save Evidence';
      }
    }

    // Open schedule modal
    function openScheduleModal(packageId, memberId, providerId) {
      currentLogisticsContext = { packageId, memberId, providerId };
      document.getElementById('schedule-package-id').value = packageId;
      document.getElementById('schedule-member-id').value = memberId;
      document.getElementById('schedule-provider-id').value = providerId;
      
      // Set minimum date to today
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('schedule-date').min = today;
      document.getElementById('schedule-date').value = '';
      document.getElementById('schedule-time-start').value = '09:00';
      document.getElementById('schedule-time-end').value = '17:00';
      document.getElementById('schedule-duration').value = '1';
      document.getElementById('schedule-notes').value = '';
      
      openModal('schedule-modal');
    }

    // Submit schedule proposal
    async function submitScheduleProposal() {
      const packageId = document.getElementById('schedule-package-id').value;
      const memberId = document.getElementById('schedule-member-id').value;
      const providerId = document.getElementById('schedule-provider-id').value;
      const date = document.getElementById('schedule-date').value;
      const timeStart = document.getElementById('schedule-time-start').value;
      const timeEnd = document.getElementById('schedule-time-end').value;
      const duration = parseInt(document.getElementById('schedule-duration').value) || 1;
      const notes = document.getElementById('schedule-notes').value;

      if (!date) {
        showToast('Please select a date', 'error');
        return;
      }

      try {
        const result = await createAppointment(packageId, memberId, providerId, date, timeStart, timeEnd, duration, notes);
        
        if (result.error) {
          throw new Error(result.error);
        }

        showToast('Appointment proposed successfully!', 'success');
        closeModal('schedule-modal');
        loadLogisticsData(packageId);
      } catch (err) {
        console.error('Error proposing appointment:', err);
        showToast('Failed to propose appointment: ' + err.message, 'error');
      }
    }

    // Confirm schedule from member
    async function confirmScheduleFromMember(appointmentId, packageId) {
      if (!confirm('Confirm this appointment time?')) return;

      try {
        const result = await confirmAppointment(appointmentId, packageId);
        
        if (result.error) {
          throw new Error(result.error);
        }

        showToast('Appointment confirmed!', 'success');
        loadLogisticsData(packageId);
      } catch (err) {
        console.error('Error confirming appointment:', err);
        showToast('Failed to confirm appointment: ' + err.message, 'error');
      }
    }

    // Accept counter proposal
    async function acceptCounterProposalFromMember(appointmentId, packageId) {
      if (!confirm('Accept the proposed new time?')) return;

      try {
        const result = await acceptCounterProposal(appointmentId, packageId);
        
        if (result.error) {
          throw new Error(result.error);
        }

        showToast('Counter proposal accepted!', 'success');
        loadLogisticsData(packageId);
      } catch (err) {
        console.error('Error accepting counter proposal:', err);
        showToast('Failed to accept counter proposal: ' + err.message, 'error');
      }
    }

    // Open counter proposal modal
    function proposeNewTimeFromMember(appointmentId, packageId) {
      currentLogisticsContext.appointmentId = appointmentId;
      currentLogisticsContext.packageId = packageId;
      
      document.getElementById('counter-appointment-id').value = appointmentId;
      document.getElementById('counter-package-id').value = packageId;
      
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('counter-date').min = today;
      document.getElementById('counter-date').value = '';
      document.getElementById('counter-time-start').value = '09:00';
      document.getElementById('counter-time-end').value = '17:00';
      document.getElementById('counter-notes').value = '';
      
      openModal('counter-proposal-modal');
    }

    // Submit counter proposal
    async function submitCounterProposal() {
      const appointmentId = document.getElementById('counter-appointment-id').value;
      const packageId = document.getElementById('counter-package-id').value;
      const date = document.getElementById('counter-date').value;
      const timeStart = document.getElementById('counter-time-start').value;
      const timeEnd = document.getElementById('counter-time-end').value;
      const notes = document.getElementById('counter-notes').value;

      if (!date) {
        showToast('Please select a date', 'error');
        return;
      }

      try {
        const result = await proposeNewTime(appointmentId, packageId, date, timeStart, timeEnd, notes);
        
        if (result.error) {
          throw new Error(result.error);
        }

        showToast('New time proposed!', 'success');
        closeModal('counter-proposal-modal');
        loadLogisticsData(packageId);
      } catch (err) {
        console.error('Error proposing new time:', err);
        showToast('Failed to propose new time: ' + err.message, 'error');
      }
    }

    // Open transfer modal
    function openTransferModal(packageId, memberId, providerId) {
      currentLogisticsContext = { packageId, memberId, providerId };
      document.getElementById('transfer-package-id').value = packageId;
      document.getElementById('transfer-member-id').value = memberId;
      document.getElementById('transfer-provider-id').value = providerId;
      
      // Reset form
      document.querySelectorAll('.transfer-type-option').forEach(opt => opt.classList.remove('selected'));
      document.getElementById('transfer-pickup-address').value = '';
      document.getElementById('transfer-pickup-notes').value = '';
      document.getElementById('transfer-return-address').value = '';
      document.getElementById('transfer-special-instructions').value = '';
      document.getElementById('transfer-address-section').style.display = 'none';
      
      openModal('transfer-modal');
    }

    // Select transfer type
    function selectTransferType(type) {
      document.querySelectorAll('.transfer-type-option').forEach(opt => opt.classList.remove('selected'));
      document.querySelector(`[data-transfer-type="${type}"]`).classList.add('selected');
      document.getElementById('selected-transfer-type').value = type;
      
      // Show address fields for pickup or towing
      const addressSection = document.getElementById('transfer-address-section');
      if (type === 'provider_pickup' || type === 'towing') {
        addressSection.style.display = 'block';
      } else {
        addressSection.style.display = 'none';
      }
    }

    // Submit transfer setup
    async function submitTransferSetup() {
      const packageId = document.getElementById('transfer-package-id').value;
      const memberId = document.getElementById('transfer-member-id').value;
      const providerId = document.getElementById('transfer-provider-id').value;
      const transferType = document.getElementById('selected-transfer-type').value;
      const pickupAddress = document.getElementById('transfer-pickup-address').value;
      const pickupNotes = document.getElementById('transfer-pickup-notes').value;
      const returnAddress = document.getElementById('transfer-return-address').value;
      const specialInstructions = document.getElementById('transfer-special-instructions').value;

      if (!transferType) {
        showToast('Please select a transfer method', 'error');
        return;
      }

      if ((transferType === 'provider_pickup' || transferType === 'towing') && !pickupAddress) {
        showToast('Please enter a pickup address', 'error');
        return;
      }

      try {
        const result = await createVehicleTransfer(packageId, memberId, providerId, transferType, pickupAddress, pickupNotes, returnAddress, specialInstructions);
        
        if (result.error) {
          throw new Error(result.error);
        }

        showToast('Transfer method set up successfully!', 'success');
        closeModal('transfer-modal');
        loadLogisticsData(packageId);
      } catch (err) {
        console.error('Error setting up transfer:', err);
        showToast('Failed to set up transfer: ' + err.message, 'error');
      }
    }

    // Confirm vehicle handoff
    async function confirmVehicleHandoff(transferId, packageId, type) {
      const confirmMsg = type === 'pickup' 
        ? 'Confirm that you have handed over your vehicle?' 
        : 'Confirm that you have received your vehicle back?';
      
      if (!confirm(confirmMsg)) return;

      try {
        let result;
        if (type === 'pickup') {
          result = await confirmPickup(transferId, packageId, 'member');
        } else {
          result = await confirmReturn(transferId, packageId, 'member');
        }
        
        if (result.error) {
          throw new Error(result.error);
        }

        showToast(type === 'pickup' ? 'Handoff confirmed!' : 'Return confirmed!', 'success');
        loadLogisticsData(packageId);
      } catch (err) {
        console.error('Error confirming handoff:', err);
        showToast('Failed to confirm: ' + err.message, 'error');
      }
    }

    // Share my location
    async function shareMyLocation(packageId, providerId) {
      if (!providerId) {
        showToast('No provider assigned yet', 'error');
        return;
      }

      document.getElementById('location-share-package-id').value = packageId;
      document.getElementById('location-share-provider-id').value = providerId;
      document.getElementById('location-share-message').value = '';
      
      openModal('location-share-modal');
    }

    // Confirm and share location
    async function confirmShareLocation() {
      const packageId = document.getElementById('location-share-package-id').value;
      const providerId = document.getElementById('location-share-provider-id').value;
      const message = document.getElementById('location-share-message').value;

      try {
        showToast('Getting your location...', 'success');
        
        const result = await shareLocation(packageId, providerId, 'pickup', message);
        
        if (result.error) {
          throw new Error(result.error);
        }

        showToast('Location shared successfully!', 'success');
        closeModal('location-share-modal');
        loadLogisticsData(packageId);
      } catch (err) {
        console.error('Error sharing location:', err);
        showToast('Failed to share location: ' + err.message, 'error');
      }
    }

    // View shared location from provider
    async function viewSharedLocation(packageId) {
      try {
        const result = await getActiveLocationShare(packageId);
        
        if (result.error) {
          throw new Error(result.error);
        }

        if (!result.data) {
          showToast('No location shared by provider yet', 'error');
          return;
        }

        const location = result.data;
        const sharedAt = new Date(location.shared_at).toLocaleString();
        const mapsUrl = `https://www.google.com/maps?q=${location.latitude},${location.longitude}`;

        document.getElementById('view-location-body').innerHTML = `
          <div style="text-align:center;margin-bottom:20px;">
            <div style="font-size:48px;margin-bottom:12px;">üìç</div>
            <div style="font-size:1.1rem;font-weight:600;color:var(--text-primary);margin-bottom:4px;">
              ${location.shared_by === currentUser?.id ? 'Your Shared Location' : 'Provider Location'}
            </div>
            ${location.address ? `<div style="color:var(--text-secondary);margin-bottom:8px;">${location.address}</div>` : ''}
            <div style="font-size:0.85rem;color:var(--text-muted);">Shared: ${sharedAt}</div>
          </div>
          ${location.message ? `
            <div style="padding:16px;background:var(--bg-input);border-radius:var(--radius-md);margin-bottom:20px;">
              <div style="font-size:0.8rem;color:var(--text-muted);margin-bottom:4px;">Message:</div>
              <div style="color:var(--text-secondary);">"${location.message}"</div>
            </div>
          ` : ''}
          <div style="display:flex;flex-direction:column;gap:8px;">
            <a href="${mapsUrl}" target="_blank" class="btn btn-primary" style="justify-content:center;text-decoration:none;">
              üó∫Ô∏è Open in Google Maps
            </a>
            <a href="https://www.google.com/maps/dir/?api=1&destination=${location.latitude},${location.longitude}" target="_blank" class="btn btn-secondary" style="justify-content:center;text-decoration:none;">
              üöó Get Directions
            </a>
          </div>
        `;

        // Mark as viewed
        if (location.shared_by !== currentUser?.id) {
          await markLocationViewed(location.id);
        }

        openModal('view-location-modal');
      } catch (err) {
        console.error('Error viewing location:', err);
        showToast('Failed to load location: ' + err.message, 'error');
      }
    }

    // ========== EMERGENCY FUNCTIONS ==========
    async function checkActiveEmergency() {
      try {
        const { data } = await getActiveEmergency(currentUser.id);
        activeEmergency = data;
        updateEmergencyBanner();
      } catch (err) {
        console.error('Error checking emergency:', err);
      }
    }

    function updateEmergencyBanner() {
      const banner = document.getElementById('emergency-alert-banner');
      const statusText = document.getElementById('emergency-banner-status');
      
      if (activeEmergency) {
        banner.style.display = 'flex';
        const statusLabels = {
          'pending': 'Waiting for a provider to accept...',
          'accepted': `Provider assigned! ETA: ${activeEmergency.eta_minutes || '--'} minutes`,
          'en_route': 'Provider is on the way!',
          'arrived': 'Provider has arrived',
          'in_progress': 'Help in progress...'
        };
        statusText.textContent = statusLabels[activeEmergency.status] || activeEmergency.status;
      } else {
        banner.style.display = 'none';
      }
    }

    function openEmergencyRequest() {
      if (activeEmergency) {
        openEmergencyStatus();
        return;
      }
      
      pendingEmergencyPhotos = [];
      document.getElementById('emergency-photo-previews').innerHTML = '';
      document.getElementById('emergency-type').value = '';
      document.getElementById('emergency-description').value = '';
      document.getElementById('emergency-location-text').textContent = 'Getting your location...';
      document.getElementById('emergency-address-text').textContent = '';
      
      const vehicleOptions = '<option value="">No vehicle selected</option>' + vehicles.map(v => 
        `<option value="${v.id}">${v.nickname || `${v.year || ''} ${v.make} ${v.model}`.trim()}</option>`
      ).join('');
      document.getElementById('emergency-vehicle').innerHTML = vehicleOptions;
      
      openModal('emergency-request-modal');
      getEmergencyLocation();
    }

    function getEmergencyLocation() {
      if (!navigator.geolocation) {
        document.getElementById('emergency-location-text').textContent = 'Location not available';
        return;
      }
      
      navigator.geolocation.getCurrentPosition(
        async (position) => {
          emergencyLocation = {
            lat: position.coords.latitude,
            lng: position.coords.longitude
          };
          document.getElementById('emergency-location-text').textContent = 'üìç Location captured';
          
          try {
            const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${emergencyLocation.lat}&lon=${emergencyLocation.lng}`);
            const data = await response.json();
            if (data.display_name) {
              document.getElementById('emergency-address-text').textContent = data.display_name;
              emergencyLocation.address = data.display_name;
            }
          } catch (e) {
            console.log('Could not get address');
          }
        },
        (error) => {
          document.getElementById('emergency-location-text').textContent = '‚ö†Ô∏è Could not get location';
          document.getElementById('emergency-address-text').textContent = 'Please enable location services';
        },
        { enableHighAccuracy: true, timeout: 10000 }
      );
    }

    function handleEmergencyPhotos(input) {
      const files = Array.from(input.files);
      if (pendingEmergencyPhotos.length + files.length > 5) {
        showToast('Maximum 5 photos allowed', 'error');
        return;
      }
      
      files.forEach(file => {
        pendingEmergencyPhotos.push(file);
        const reader = new FileReader();
        reader.onload = (e) => {
          const idx = pendingEmergencyPhotos.length - 1;
          const preview = document.createElement('div');
          preview.className = 'emergency-photo';
          preview.innerHTML = `
            <img src="${e.target.result}" alt="Photo ${idx + 1}">
            <button class="emergency-photo-remove" onclick="removeEmergencyPhoto(${idx})">√ó</button>
          `;
          document.getElementById('emergency-photo-previews').appendChild(preview);
        };
        reader.readAsDataURL(file);
      });
      input.value = '';
    }

    function removeEmergencyPhoto(idx) {
      pendingEmergencyPhotos.splice(idx, 1);
      renderEmergencyPhotoPreviews();
    }

    function renderEmergencyPhotoPreviews() {
      const container = document.getElementById('emergency-photo-previews');
      container.innerHTML = '';
      pendingEmergencyPhotos.forEach((file, idx) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const preview = document.createElement('div');
          preview.className = 'emergency-photo';
          preview.innerHTML = `
            <img src="${e.target.result}" alt="Photo ${idx + 1}">
            <button class="emergency-photo-remove" onclick="removeEmergencyPhoto(${idx})">√ó</button>
          `;
          container.appendChild(preview);
        };
        reader.readAsDataURL(file);
      });
    }

    const EMERGENCY_SERVICE_RATES = {
      lockout: { base: 100, perMile: 0, includedMiles: 0, display: 'üîê Lockout' },
      dead_battery: { base: 100, perMile: 0, includedMiles: 0, display: 'üîã Jump Start' },
      flat_tire: { base: 125, perMile: 0, includedMiles: 0, display: 'üõû Flat Tire' },
      fuel_delivery: { base: 125, perMile: 0, includedMiles: 0, display: '‚õΩ Fuel Delivery' },
      tow_needed: { base: 200, perMile: 6, includedMiles: 10, display: 'üöõ Towing' },
      accident: { base: 250, perMile: 6, includedMiles: 10, display: 'üí• Accident' },
      other: { base: 150, perMile: 0, includedMiles: 0, display: 'üîß Other' }
    };
    const EMERGENCY_ACTIVATION_FEE = 25;
    let pendingEmergencyPaymentData = null;

    function calculateEmergencyEscrow(emergencyType, miles = 10) {
      const rate = EMERGENCY_SERVICE_RATES[emergencyType];
      if (!rate) return 0;
      
      let escrow = rate.base;
      if (rate.perMile > 0 && miles > rate.includedMiles) {
        escrow += (miles - rate.includedMiles) * rate.perMile;
      }
      return escrow;
    }

    function handleEmergencyTypeChange() {
      const emergencyType = document.getElementById('emergency-type').value;
      const towDistanceGroup = document.getElementById('tow-distance-group');
      const pricePreview = document.getElementById('emergency-price-preview');
      
      const needsDistance = emergencyType === 'tow_needed' || emergencyType === 'accident';
      towDistanceGroup.style.display = needsDistance ? 'block' : 'none';
      
      if (emergencyType) {
        pricePreview.style.display = 'block';
        updateEmergencyPricePreview();
      } else {
        pricePreview.style.display = 'none';
      }
    }

    function updateEmergencyPricePreview() {
      const emergencyType = document.getElementById('emergency-type').value;
      if (!emergencyType) return;
      
      const miles = parseFloat(document.getElementById('emergency-tow-miles').value) || 10;
      const escrow = calculateEmergencyEscrow(emergencyType, miles);
      const total = EMERGENCY_ACTIVATION_FEE + escrow;
      
      document.getElementById('emergency-escrow-preview').textContent = '$' + escrow.toFixed(2);
      document.getElementById('emergency-total-preview').textContent = '$' + total.toFixed(2);
    }

    function showEmergencyPaymentModal(escrowAmount, totalAmount) {
      document.getElementById('payment-modal-escrow').textContent = '$' + escrowAmount.toFixed(2);
      document.getElementById('payment-modal-escrow-text').textContent = '$' + escrowAmount.toFixed(2);
      document.getElementById('payment-modal-total').textContent = '$' + totalAmount.toFixed(2);
      closeModal('emergency-request-modal');
      openModal('emergency-payment-modal');
    }

    async function submitEmergencyRequest() {
      const emergencyType = document.getElementById('emergency-type').value;
      const description = document.getElementById('emergency-description').value;
      const vehicleId = document.getElementById('emergency-vehicle').value;
      
      if (!emergencyType) {
        showToast('Please select an emergency type', 'error');
        return;
      }
      
      const lat = document.getElementById('emergency-lat').value;
      const lng = document.getElementById('emergency-lng').value;
      
      if (!lat || !lng) {
        showToast('Could not get your location. Please enable location services.', 'error');
        return;
      }
      
      const needsDistance = emergencyType === 'tow_needed' || emergencyType === 'accident';
      const estimatedMiles = needsDistance ? (parseFloat(document.getElementById('emergency-tow-miles').value) || 10) : null;
      const escrowAmount = calculateEmergencyEscrow(emergencyType, estimatedMiles || 10);
      const totalAmount = EMERGENCY_ACTIVATION_FEE + escrowAmount;
      
      pendingEmergencyPaymentData = {
        vehicleId: vehicleId || null,
        lat: parseFloat(lat),
        lng: parseFloat(lng),
        address: document.getElementById('emergency-address').value || null,
        emergencyType: emergencyType,
        description: description,
        estimatedMiles: estimatedMiles,
        activationFee: EMERGENCY_ACTIVATION_FEE,
        escrowAmount: escrowAmount
      };
      
      showEmergencyPaymentModal(escrowAmount, totalAmount);
    }

    async function confirmEmergencyPayment() {
      if (!pendingEmergencyPaymentData) {
        showToast('No pending emergency request', 'error');
        return;
      }
      
      try {
        closeModal('emergency-payment-modal');
        showToast('Processing payment and submitting emergency request...', 'success');
        
        const claimDeadline = new Date(Date.now() + 5 * 60 * 1000).toISOString();
        
        const { data, error } = await createEmergencyRequest({
          vehicleId: pendingEmergencyPaymentData.vehicleId,
          lat: pendingEmergencyPaymentData.lat,
          lng: pendingEmergencyPaymentData.lng,
          address: pendingEmergencyPaymentData.address,
          emergencyType: pendingEmergencyPaymentData.emergencyType,
          description: pendingEmergencyPaymentData.description,
          photos: [],
          activationFee: pendingEmergencyPaymentData.activationFee,
          escrowAmount: pendingEmergencyPaymentData.escrowAmount,
          estimatedMiles: pendingEmergencyPaymentData.estimatedMiles,
          claimDeadline: claimDeadline,
          paymentStatus: 'pending_payment'
        });
        
        if (error) throw new Error(error);
        
        if (pendingEmergencyPhotos.length > 0) {
          const photoUrls = [];
          for (const file of pendingEmergencyPhotos) {
            const { data: url, error: uploadError } = await uploadEmergencyPhoto(data.id, file);
            if (!uploadError && url) photoUrls.push(url);
          }
          
          if (photoUrls.length > 0) {
            await supabaseClient.from('emergency_requests')
              .update({ photos: photoUrls })
              .eq('id', data.id);
          }
        }
        
        pendingEmergencyPaymentData = null;
        activeEmergency = data;
        updateEmergencyBanner();
        showSection('emergency');
        loadEmergencySection();
        showToast('üö® Emergency request submitted! Providers are being notified.', 'success');
        
      } catch (err) {
        console.error('Error submitting emergency:', err);
        showToast('Failed to submit emergency request: ' + err.message, 'error');
      }
    }

    function previewEmergencyPhotos(input) {
      const files = Array.from(input.files);
      pendingEmergencyPhotos = pendingEmergencyPhotos.concat(files);
      const container = document.getElementById('emergency-photo-preview');
      container.innerHTML = '';
      pendingEmergencyPhotos.forEach((file, idx) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const preview = document.createElement('div');
          preview.className = 'emergency-photo';
          preview.innerHTML = `
            <img src="${e.target.result}" alt="Photo ${idx + 1}">
            <button class="emergency-photo-remove" onclick="removeEmergencyPhoto(${idx})">√ó</button>
          `;
          container.appendChild(preview);
        };
        reader.readAsDataURL(file);
      });
    }

    async function refreshEmergencyLocation() {
      document.getElementById('emergency-address').value = 'Getting your location...';
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(async (pos) => {
          document.getElementById('emergency-lat').value = pos.coords.latitude;
          document.getElementById('emergency-lng').value = pos.coords.longitude;
          try {
            const resp = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${pos.coords.latitude}&lon=${pos.coords.longitude}&format=json`);
            const data = await resp.json();
            document.getElementById('emergency-address').value = data.display_name || `${pos.coords.latitude.toFixed(5)}, ${pos.coords.longitude.toFixed(5)}`;
          } catch (e) {
            document.getElementById('emergency-address').value = `${pos.coords.latitude.toFixed(5)}, ${pos.coords.longitude.toFixed(5)}`;
          }
        }, (err) => {
          document.getElementById('emergency-address').value = 'Unable to get location';
          showToast('Please enable location services', 'error');
        }, { enableHighAccuracy: true });
      }
    }

    async function loadEmergencySection() {
      if (!currentUser) return;
      
      // Check for active emergency
      const { data: activeData } = await getActiveEmergency(currentUser.id);
      if (activeData) {
        activeEmergency = activeData;
        document.getElementById('emergency-active-status').style.display = 'block';
        document.getElementById('emergency-request-form').style.display = 'none';
        renderEmergencySectionStatus();
        startEmergencyPolling();
      } else {
        stopEmergencyPolling();
        document.getElementById('emergency-active-status').style.display = 'none';
        document.getElementById('emergency-request-form').style.display = 'block';
        refreshEmergencyLocation();
        populateEmergencyVehicles();
      }
      
      // Load history
      const { data: history } = await getMyEmergencies(currentUser.id);
      renderEmergencyHistory(history || []);
    }

    function renderEmergencySectionStatus() {
      const e = activeEmergency;
      if (!e) return;
      
      const typeLabels = {
        'flat_tire': 'üõû Flat Tire',
        'dead_battery': 'üîã Dead Battery',
        'lockout': 'üîê Locked Out',
        'tow_needed': 'üöõ Tow Needed',
        'fuel_delivery': '‚õΩ Out of Fuel',
        'accident': 'üí• Accident',
        'other': '‚ùì Other'
      };
      
      document.getElementById('emergency-active-type').textContent = typeLabels[e.emergency_type] || e.emergency_type;
      
      const statuses = ['pending', 'accepted', 'en_route', 'arrived', 'in_progress', 'completed'];
      const currentIdx = statuses.indexOf(e.status);
      
      const statusLabels = {
        'pending': { icon: '‚è≥', label: 'Waiting for provider' },
        'accepted': { icon: '‚úì', label: 'Provider accepted' },
        'en_route': { icon: 'üöó', label: 'Provider en route' },
        'arrived': { icon: 'üìç', label: 'Provider arrived' },
        'in_progress': { icon: 'üîß', label: 'Work in progress' },
        'completed': { icon: '‚úÖ', label: 'Completed' }
      };
      
      // Show round info for pending status
      let roundInfoHtml = '';
      if (e.status === 'pending') {
        const currentRound = e.claim_round || 1;
        const claimDeadline = e.claim_deadline ? new Date(e.claim_deadline) : null;
        let timeRemaining = '';
        if (claimDeadline) {
          const remaining = Math.max(0, Math.floor((claimDeadline - new Date()) / 1000));
          const mins = Math.floor(remaining / 60);
          const secs = remaining % 60;
          timeRemaining = `${mins}:${secs.toString().padStart(2, '0')} remaining`;
        }
        roundInfoHtml = `
          <div style="background:var(--accent-orange-soft);border:1px solid var(--accent-orange);border-radius:var(--radius-md);padding:12px 16px;margin-bottom:16px;text-align:center;">
            <div style="font-weight:600;color:var(--accent-orange);margin-bottom:4px;">üîç Round ${currentRound} of 3</div>
            <div style="font-size:0.85rem;color:var(--text-secondary);">Searching for nearby providers... ${timeRemaining}</div>
          </div>
        `;
      }
      
      const timelineHtml = statuses.slice(0, 5).map((status, idx) => {
        const stepClass = idx < currentIdx ? 'completed' : idx === currentIdx ? 'current' : 'pending';
        const info = statusLabels[status];
        return `
          <div class="emergency-step ${stepClass}">
            <div class="emergency-step-dot">${info.icon}</div>
            <div class="emergency-step-info">
              <div class="emergency-step-label">${info.label}</div>
            </div>
          </div>
        `;
      }).join('');
      
      document.getElementById('emergency-status-timeline').innerHTML = roundInfoHtml + timelineHtml;
      
      if (e.provider) {
        document.getElementById('emergency-provider-info').style.display = 'block';
        document.getElementById('emergency-provider-info').innerHTML = `
          <div style="font-weight:600;margin-bottom:8px;">Your Provider</div>
          <div style="font-size:1.1rem;margin-bottom:4px;">${e.provider.business_name || e.provider.full_name}</div>
          ${e.provider.phone ? `<a href="tel:${e.provider.phone}" class="btn btn-primary" style="margin-top:8px;width:100%;justify-content:center;">üìû Call Provider</a>` : ''}
          ${e.eta_minutes ? `<div style="color:var(--accent-gold);margin-top:8px;">ETA: ${e.eta_minutes} minutes</div>` : ''}
        `;
      }
    }

    function renderEmergencyHistory(emergencies) {
      const container = document.getElementById('emergency-history-list');
      const completed = emergencies.filter(e => ['completed', 'cancelled'].includes(e.status));
      
      if (completed.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üÜò</div>
            <p>No emergency requests yet.</p>
          </div>
        `;
        return;
      }
      
      const typeLabels = {
        'flat_tire': 'üõû Flat Tire',
        'dead_battery': 'üîã Dead Battery',
        'lockout': 'üîê Locked Out',
        'tow_needed': 'üöõ Tow Needed',
        'fuel_delivery': '‚õΩ Out of Fuel',
        'accident': 'üí• Accident',
        'other': '‚ùì Other'
      };
      
      container.innerHTML = completed.map(e => `
        <div style="padding:16px;background:var(--bg-elevated);border-radius:var(--radius-md);margin-bottom:12px;border:1px solid var(--border-subtle);">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <div>
              <span style="font-size:1.1rem;">${typeLabels[e.emergency_type] || e.emergency_type}</span>
              <span class="status-badge ${e.status === 'completed' ? 'status-completed' : 'status-cancelled'}" style="margin-left:12px;">${e.status}</span>
            </div>
            <span style="color:var(--text-muted);font-size:0.85rem;">${new Date(e.created_at).toLocaleDateString()}</span>
          </div>
          ${e.vehicles ? `<div style="color:var(--text-secondary);font-size:0.9rem;margin-top:4px;">${e.vehicles.year} ${e.vehicles.make} ${e.vehicles.model}</div>` : ''}
        </div>
      `).join('');
    }

    async function populateEmergencyVehicles() {
      const select = document.getElementById('emergency-vehicle');
      if (!userVehicles || userVehicles.length === 0) {
        select.innerHTML = '<option value="">No vehicles - add one first</option>';
        return;
      }
      select.innerHTML = '<option value="">Select a vehicle (optional)</option>' + 
        userVehicles.map(v => `<option value="${v.id}">${v.year} ${v.make} ${v.model}</option>`).join('');
    }

    async function openEmergencyStatus() {
      if (!activeEmergency) {
        await checkActiveEmergency();
      }
      
      if (!activeEmergency) {
        showToast('No active emergency', 'error');
        return;
      }
      
      openModal('emergency-status-modal');
      renderEmergencyStatus();
    }

    function renderEmergencyStatus() {
      const e = activeEmergency;
      if (!e) return;
      
      const typeLabels = {
        'flat_tire': 'üõû Flat Tire',
        'dead_battery': 'üîã Dead Battery',
        'lockout': 'üîê Locked Out',
        'tow_needed': 'üöõ Tow Needed',
        'fuel_delivery': '‚õΩ Out of Fuel',
        'accident': 'üí• Accident',
        'other': '‚ùì Other'
      };
      
      const statuses = ['pending', 'accepted', 'en_route', 'arrived', 'in_progress', 'completed'];
      const currentIdx = statuses.indexOf(e.status);
      
      const statusLabels = {
        'pending': { icon: '‚è≥', label: 'Waiting for provider' },
        'accepted': { icon: '‚úì', label: 'Provider accepted' },
        'en_route': { icon: 'üöó', label: 'Provider en route' },
        'arrived': { icon: 'üìç', label: 'Provider arrived' },
        'in_progress': { icon: 'üîß', label: 'Work in progress' },
        'completed': { icon: '‚úÖ', label: 'Completed' }
      };
      
      const timelineHtml = statuses.slice(0, 5).map((status, idx) => {
        const stepClass = idx < currentIdx ? 'completed' : idx === currentIdx ? 'current' : 'pending';
        const info = statusLabels[status];
        return `
          <div class="emergency-step ${stepClass}">
            <div class="emergency-step-dot">${info.icon}</div>
            <div class="emergency-step-info">
              <div class="emergency-step-label">${info.label}</div>
              ${idx === currentIdx && e.accepted_at ? `<div class="emergency-step-time">${new Date(e.accepted_at).toLocaleTimeString()}</div>` : ''}
            </div>
          </div>
        `;
      }).join('');
      
      const providerHtml = e.provider ? `
        <div style="background:var(--bg-input);border-radius:var(--radius-md);padding:16px;margin-top:20px;">
          <div style="font-weight:600;margin-bottom:8px;">Your Provider</div>
          <div style="font-size:1.1rem;margin-bottom:4px;">${e.provider.business_name || e.provider.full_name}</div>
          ${e.provider.phone ? `<a href="tel:${e.provider.phone}" class="btn btn-primary" style="margin-top:12px;width:100%;justify-content:center;">üìû Call Provider</a>` : ''}
          ${e.eta_minutes ? `<div style="color:var(--accent-gold);margin-top:12px;">ETA: ${e.eta_minutes} minutes</div>` : ''}
        </div>
      ` : '';
      
      const vehicleName = e.vehicles ? `${e.vehicles.year} ${e.vehicles.make} ${e.vehicles.model}` : 'No vehicle selected';
      
      document.getElementById('emergency-status-content').innerHTML = `
        <div style="text-align:center;margin-bottom:20px;">
          <div style="font-size:32px;margin-bottom:8px;">${typeLabels[e.emergency_type]?.split(' ')[0] || 'üö®'}</div>
          <div style="font-size:1.1rem;font-weight:600;">${typeLabels[e.emergency_type] || e.emergency_type}</div>
          <div style="color:var(--text-muted);font-size:0.9rem;">${vehicleName}</div>
        </div>
        
        <div class="emergency-timeline">${timelineHtml}</div>
        
        ${providerHtml}
        
        ${e.address ? `
          <div style="margin-top:20px;padding:16px;background:var(--bg-input);border-radius:var(--radius-md);">
            <div style="font-size:0.85rem;color:var(--text-muted);margin-bottom:4px;">üìç Your Location</div>
            <div style="font-size:0.9rem;color:var(--text-secondary);">${e.address}</div>
          </div>
        ` : ''}
        
        ${e.description ? `
          <div style="margin-top:16px;padding:16px;background:var(--bg-input);border-radius:var(--radius-md);">
            <div style="font-size:0.85rem;color:var(--text-muted);margin-bottom:4px;">Description</div>
            <div style="font-size:0.9rem;color:var(--text-secondary);">${e.description}</div>
          </div>
        ` : ''}
      `;
      
      document.getElementById('emergency-status-footer').innerHTML = e.status === 'pending' ? `
        <button class="btn btn-danger" onclick="cancelActiveEmergency()">Cancel Request</button>
        <button class="btn btn-secondary" onclick="closeModal('emergency-status-modal')">Close</button>
      ` : `<button class="btn btn-secondary" onclick="closeModal('emergency-status-modal')">Close</button>`;
    }

    async function cancelActiveEmergency() {
      if (!activeEmergency) return;
      if (!confirm('Are you sure you want to cancel this emergency request?')) return;
      
      try {
        const { error } = await cancelEmergency(activeEmergency.id);
        if (error) throw new Error(error);
        
        activeEmergency = null;
        updateEmergencyBanner();
        closeModal('emergency-status-modal');
        loadEmergencySection();
        showToast('Emergency request cancelled', 'success');
      } catch (err) {
        console.error('Error cancelling emergency:', err);
        showToast('Failed to cancel: ' + err.message, 'error');
      }
    }

    // Real-time polling for emergency status updates
    let emergencyPollInterval = null;
    
    async function checkEmergencyRoundExpiry() {
      if (!activeEmergency || activeEmergency.status !== 'pending') return;
      
      const claimDeadline = activeEmergency.claim_deadline ? new Date(activeEmergency.claim_deadline) : null;
      const now = new Date();
      
      if (claimDeadline && claimDeadline <= now) {
        const currentRound = activeEmergency.claim_round || 1;
        
        if (currentRound >= 3) {
          // All 3 rounds exhausted - show fallback message
          showEmergencyNoProvidersMessage();
          return;
        }
        
        // Extend to next round
        const { data, error } = await extendEmergencyRound(activeEmergency.id);
        if (data) {
          activeEmergency = { ...activeEmergency, ...data };
          renderEmergencySectionStatus();
          showToast(`Extending search - Round ${data.claim_round} of 3`, 'info');
        } else if (error && error.roundsExhausted) {
          showEmergencyNoProvidersMessage();
        }
      }
    }
    
    function showEmergencyNoProvidersMessage() {
      const container = document.getElementById('emergency-active-status');
      if (!container) return;
      
      container.innerHTML = `
        <div class="card" style="text-align:center;padding:40px 24px;">
          <div style="font-size:48px;margin-bottom:16px;">üòî</div>
          <h3 style="margin-bottom:12px;color:var(--accent-red);">No Providers Available</h3>
          <p style="color:var(--text-secondary);margin-bottom:24px;line-height:1.6;">
            We're sorry, but no providers were able to respond to your emergency request after 15 minutes of searching.
          </p>
          <div style="background:var(--bg-input);border-radius:var(--radius-md);padding:16px;margin-bottom:24px;">
            <p style="font-weight:600;margin-bottom:8px;">Alternative Help:</p>
            <p style="color:var(--text-secondary);margin-bottom:12px;">Please try calling 911 or a local towing service.</p>
            <a href="tel:911" class="btn btn-danger" style="width:100%;justify-content:center;margin-bottom:8px;">üìû Call 911</a>
          </div>
          <button class="btn btn-secondary" onclick="cancelActiveEmergency()" style="width:100%;justify-content:center;">Cancel Request & Try Again</button>
        </div>
      `;
      
      stopEmergencyPolling();
    }
    
    function startEmergencyPolling() {
      if (emergencyPollInterval) return;
      emergencyPollInterval = setInterval(async () => {
        if (!activeEmergency || !currentUser) return;
        
        // Check for round expiry first
        await checkEmergencyRoundExpiry();
        
        const { data } = await getActiveEmergency(currentUser.id);
        if (data && data.status !== activeEmergency.status) {
          activeEmergency = data;
          renderEmergencySectionStatus();
          updateEmergencyBanner();
          if (data.status === 'completed') {
            showToast('Your emergency service has been completed!', 'success');
            stopEmergencyPolling();
            setTimeout(() => loadEmergencySection(), 2000);
          } else if (data.status === 'accepted') {
            showToast('A provider has accepted your request!', 'success');
          } else if (data.status === 'en_route') {
            showToast('Your provider is on the way!', 'success');
          } else if (data.status === 'arrived') {
            showToast('Your provider has arrived!', 'success');
          }
        } else if (data) {
          // Update activeEmergency even if status hasn't changed (to get latest round info)
          activeEmergency = data;
          renderEmergencySectionStatus();
        }
        if (!data) {
          activeEmergency = null;
          updateEmergencyBanner();
          loadEmergencySection();
          stopEmergencyPolling();
        }
      }, 10000);
    }
    
    function stopEmergencyPolling() {
      if (emergencyPollInterval) {
        clearInterval(emergencyPollInterval);
        emergencyPollInterval = null;
      }
    }

    // ==================== INSPECTION REPORT DISPLAY ====================
    async function loadInspectionReport(packageId) {
      const container = document.getElementById(`inspection-report-content-${packageId}`);
      if (!container) return;
      
      try {
        const { data: inspection, error } = await supabaseClient
          .from('inspection_reports')
          .select('*')
          .eq('package_id', packageId)
          .single();
        
        if (error || !inspection) {
          container.innerHTML = `
            <div style="color:var(--text-muted);font-size:0.9rem;text-align:center;padding:16px;">
              <span style="font-size:1.5rem;display:block;margin-bottom:8px;">üìã</span>
              No inspection report available yet. Your provider will complete an inspection during service.
            </div>
          `;
          return;
        }
        
        renderInspectionReport(packageId, inspection);
      } catch (err) {
        console.error('Error loading inspection:', err);
        container.innerHTML = `<div style="color:var(--text-muted);font-size:0.9rem;">Could not load inspection report.</div>`;
      }
    }
    
    function renderInspectionReport(packageId, inspection) {
      const container = document.getElementById(`inspection-report-content-${packageId}`);
      if (!container) return;
      
      const conditionLabels = { excellent: 'Excellent', good: 'Good', fair: 'Fair', needs_attention: 'Needs Attention' };
      const statusLabels = { good: 'Good', fair: 'Fair', needs_attention: 'Attention', urgent: 'Urgent', na: 'N/A' };
      const inspectionDate = new Date(inspection.inspection_date).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
      
      const categories = [
        { 
          name: 'üõ¢Ô∏è Fluids', 
          items: [
            { label: 'Engine Oil', field: 'engine_oil' },
            { label: 'Transmission Fluid', field: 'transmission_fluid' },
            { label: 'Coolant Level', field: 'coolant_level' },
            { label: 'Brake Fluid', field: 'brake_fluid' },
            { label: 'Power Steering Fluid', field: 'power_steering_fluid' }
          ]
        },
        { 
          name: 'üõû Brakes', 
          items: [
            { label: 'Front Brake Pads', field: 'brake_pads_front', extra: inspection.brake_pads_front_percent ? `${inspection.brake_pads_front_percent}%` : null },
            { label: 'Rear Brake Pads', field: 'brake_pads_rear', extra: inspection.brake_pads_rear_percent ? `${inspection.brake_pads_rear_percent}%` : null },
            { label: 'Brake Rotors', field: 'brake_rotors' }
          ]
        },
        { 
          name: 'üöó Tires', 
          items: [
            { label: 'Front Left', field: 'tire_front_left', extra: inspection.tire_front_left_tread ? `${inspection.tire_front_left_tread}/32"` : null },
            { label: 'Front Right', field: 'tire_front_right', extra: inspection.tire_front_right_tread ? `${inspection.tire_front_right_tread}/32"` : null },
            { label: 'Rear Left', field: 'tire_rear_left', extra: inspection.tire_rear_left_tread ? `${inspection.tire_rear_left_tread}/32"` : null },
            { label: 'Rear Right', field: 'tire_rear_right', extra: inspection.tire_rear_right_tread ? `${inspection.tire_rear_right_tread}/32"` : null },
            { label: 'Spare Tire', field: 'spare_tire' }
          ]
        },
        { 
          name: '‚ö° Electrical & Lights', 
          items: [
            { label: 'Battery', field: 'battery', extra: inspection.battery_voltage ? `${inspection.battery_voltage}V` : null },
            { label: 'Headlights', field: 'headlights' },
            { label: 'Taillights', field: 'taillights' },
            { label: 'Turn Signals', field: 'turn_signals' }
          ]
        },
        { 
          name: 'üîó Belts & Hoses', 
          items: [
            { label: 'Serpentine Belt', field: 'serpentine_belt' },
            { label: 'Hoses', field: 'hoses' }
          ]
        },
        { 
          name: 'üåßÔ∏è Wipers & Glass', 
          items: [
            { label: 'Wiper Blades', field: 'wiper_blades' },
            { label: 'Windshield', field: 'windshield' }
          ]
        },
        { 
          name: 'üîß Suspension & Steering', 
          items: [
            { label: 'Shocks/Struts', field: 'shocks_struts' },
            { label: 'Alignment', field: 'alignment' }
          ]
        },
        { 
          name: 'üå¨Ô∏è Filters', 
          items: [
            { label: 'Air Filter', field: 'air_filter' },
            { label: 'Cabin Filter', field: 'cabin_filter' }
          ]
        }
      ];
      
      let categoriesHtml = categories.map(cat => {
        const hasIssues = cat.items.some(item => inspection[item.field] === 'urgent' || inspection[item.field] === 'needs_attention');
        const itemsHtml = cat.items.filter(item => inspection[item.field]).map(item => {
          const status = inspection[item.field];
          return `
            <div class="inspection-item-row">
              <span>${item.label}${item.extra ? ` <span style="color:var(--text-muted);font-size:0.8rem;">(${item.extra})</span>` : ''}</span>
              <span class="inspection-status-badge ${status}">${statusLabels[status] || status}</span>
            </div>
          `;
        }).join('');
        
        if (!itemsHtml) return '';
        
        return `
          <div class="inspection-category-section ${hasIssues ? 'expanded' : ''}">
            <div class="inspection-category-toggle" onclick="this.parentElement.classList.toggle('expanded')">
              <span>${cat.name}</span>
              <span style="font-size:0.8rem;color:var(--text-muted);">‚ñº</span>
            </div>
            <div class="inspection-category-items">${itemsHtml}</div>
          </div>
        `;
      }).join('');
      
      container.innerHTML = `
        <div class="inspection-report-header">
          <div>
            <span class="inspection-overall-badge ${inspection.overall_condition}">${conditionLabels[inspection.overall_condition] || 'N/A'}</span>
            <div class="inspection-date" style="margin-top:8px;">üìÖ Inspected: ${inspectionDate}</div>
          </div>
        </div>
        
        <div class="inspection-counts">
          ${inspection.urgent_items > 0 ? `<div class="inspection-count-item urgent">üî¥ ${inspection.urgent_items} Urgent</div>` : ''}
          ${inspection.attention_items > 0 ? `<div class="inspection-count-item attention">üü† ${inspection.attention_items} Need Attention</div>` : ''}
          ${!inspection.urgent_items && !inspection.attention_items ? `<div class="inspection-count-item good">‚úÖ All items in good condition</div>` : ''}
        </div>
        
        ${categoriesHtml}
        
        ${inspection.recommendations ? `
          <div class="inspection-recommendations">
            <div class="inspection-recommendations-title">üí° Provider Recommendations</div>
            <div class="inspection-recommendations-text">${inspection.recommendations}</div>
          </div>
        ` : ''}
        
        ${inspection.technician_notes ? `
          <div class="inspection-recommendations" style="margin-top:12px;">
            <div class="inspection-recommendations-title">üìù Technician Notes</div>
            <div class="inspection-recommendations-text">${inspection.technician_notes}</div>
          </div>
        ` : ''}
      `;
    }

    // ========== DESTINATION SERVICES ==========
    let destinationServices = [];
    let currentDestServiceType = null;
    let currentDestFilter = 'active';

    async function loadDestinationServices() {
      if (!currentUser) return;
      
      const { data, error } = await getMyDestinationServices(currentUser.id);
      if (error) {
        console.log('Error loading destination services:', error);
        destinationServices = [];
      } else {
        destinationServices = data || [];
      }
      
      renderDestinationServices();
      updateDestinationCount();
    }

    function updateDestinationCount() {
      const activeCount = destinationServices.filter(s => ['pending', 'assigned', 'in_progress', 'en_route'].includes(s.status)).length;
      const badge = document.getElementById('destination-count');
      if (badge) {
        badge.textContent = activeCount;
        badge.style.display = activeCount > 0 ? 'inline-flex' : 'none';
      }
    }

    function renderDestinationServices() {
      const container = document.getElementById('destination-services-list');
      if (!container) return;
      
      let filtered = destinationServices;
      if (currentDestFilter === 'active') {
        filtered = destinationServices.filter(s => ['pending', 'assigned', 'in_progress', 'en_route'].includes(s.status));
      } else if (currentDestFilter === 'pending') {
        filtered = destinationServices.filter(s => s.status === 'pending');
      } else if (currentDestFilter === 'completed') {
        filtered = destinationServices.filter(s => s.status === 'completed');
      }
      
      if (!filtered.length) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üöó</div>
            <p>No ${currentDestFilter === 'all' ? '' : currentDestFilter + ' '}destination services.</p>
            <button class="btn btn-primary" onclick="openDestinationBookingModal()" style="margin-top:16px;">+ Book Service</button>
          </div>`;
        return;
      }
      
      container.innerHTML = filtered.map(service => {
        const pkg = service.maintenance_packages;
        const vehicle = pkg?.vehicles;
        const vehicleName = vehicle ? `${vehicle.year || ''} ${vehicle.make} ${vehicle.model}`.trim() : 'Vehicle';
        
        const serviceIcons = {
          airport: '‚úàÔ∏è',
          dealership: 'üè¢',
          detailing: '‚ú®',
          valet: 'üîë'
        };
        const serviceLabels = {
          airport: 'Airport',
          dealership: 'Dealership',
          detailing: 'Detailing',
          valet: 'Valet'
        };
        const serviceColors = {
          airport: '#1E90FF',
          dealership: '#9B59B6',
          detailing: '#2ECC71',
          valet: '#D4AF37'
        };
        
        const statusColors = {
          pending: 'var(--text-muted)',
          assigned: 'var(--accent-blue)',
          in_progress: 'var(--accent-blue)',
          en_route: 'var(--accent-orange)',
          completed: 'var(--accent-green)',
          cancelled: 'var(--accent-red)'
        };
        const statusLabels = {
          pending: 'Pending',
          assigned: 'Driver Assigned',
          in_progress: 'In Progress',
          en_route: 'Driver En Route',
          completed: 'Completed',
          cancelled: 'Cancelled'
        };
        
        const icon = serviceIcons[service.service_type] || 'üöó';
        const label = serviceLabels[service.service_type] || service.service_type;
        const color = serviceColors[service.service_type] || 'var(--accent-blue)';
        
        let datetime = '';
        if (service.service_type === 'airport' && service.flight_datetime) {
          datetime = new Date(service.flight_datetime).toLocaleString();
        } else if (service.service_type === 'dealership' && service.appointment_datetime) {
          datetime = new Date(service.appointment_datetime).toLocaleString();
        } else if ((service.service_type === 'detailing' || service.service_type === 'valet') && service.event_datetime) {
          datetime = new Date(service.event_datetime).toLocaleString();
        } else if (service.created_at) {
          datetime = 'Booked: ' + new Date(service.created_at).toLocaleDateString();
        }
        
        const driverInfo = service.driver_name ? `
          <div style="display:flex;align-items:center;gap:8px;margin-top:12px;padding:10px 12px;background:var(--accent-blue-soft);border-radius:var(--radius-md);">
            <span style="font-size:20px;">üë§</span>
            <div>
              <div style="font-size:0.85rem;font-weight:500;color:var(--accent-blue);">Driver: ${service.driver_name}</div>
              ${service.driver_phone ? `<div style="font-size:0.78rem;color:var(--text-muted);">üìû ${service.driver_phone}</div>` : ''}
            </div>
          </div>
        ` : '';
        
        const statusSteps = ['pending', 'assigned', 'en_route', 'picked_up', 'at_destination', 'returning', 'completed'];
        const statusStepLabels = {
          pending: 'Pending',
          assigned: 'Driver Assigned',
          en_route: 'En Route',
          picked_up: 'Picked Up',
          at_destination: 'At Destination',
          returning: 'Returning',
          completed: 'Completed'
        };
        const currentStepIndex = statusSteps.indexOf(service.status);
        
        const timelineHtml = service.status !== 'cancelled' && service.status !== 'pending' ? `
          <div style="display:flex;align-items:center;gap:4px;margin:12px 0;overflow-x:auto;padding:4px 0;">
            ${statusSteps.slice(0, 5).map((step, idx) => {
              const isCompleted = idx < currentStepIndex;
              const isCurrent = idx === currentStepIndex;
              const stepColor = isCompleted ? 'var(--accent-green)' : (isCurrent ? 'var(--accent-blue)' : 'var(--text-muted)');
              return `
                <div style="display:flex;align-items:center;flex-shrink:0;">
                  <div style="width:20px;height:20px;border-radius:50%;background:${stepColor}${isCompleted || isCurrent ? '' : '33'};display:flex;align-items:center;justify-content:center;font-size:10px;color:white;">
                    ${isCompleted ? '‚úì' : (idx + 1)}
                  </div>
                  ${idx < 4 ? `<div style="width:24px;height:2px;background:${isCompleted ? 'var(--accent-green)' : 'var(--border-subtle)'};"></div>` : ''}
                </div>
              `;
            }).join('')}
          </div>
        ` : '';
        
        return `
          <div class="package-card" style="margin-bottom:16px;">
            <div class="package-card-header" style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:16px;">
              <div style="display:flex;align-items:center;gap:12px;">
                <span style="font-size:28px;">${icon}</span>
                <div>
                  <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
                    <span style="font-weight:600;font-size:1.1rem;">${label} Service</span>
                    <span style="padding:4px 10px;background:${color}22;color:${color};border-radius:100px;font-size:0.75rem;font-weight:600;">${label.toUpperCase()}</span>
                  </div>
                  <div style="color:var(--text-muted);font-size:0.9rem;margin-top:4px;">
                    ${vehicleName} ‚Ä¢ ${datetime}
                  </div>
                </div>
              </div>
              <span class="package-status" style="background:${statusColors[service.status] || 'gray'}22;color:${statusColors[service.status] || 'gray'};">
                ${statusLabels[service.status] || service.status}
              </span>
            </div>
            ${timelineHtml}
            <div class="package-card-body" style="margin-bottom:16px;">
              ${service.pickup_location ? `<div style="margin-bottom:8px;"><strong>From:</strong> ${service.pickup_location}</div>` : ''}
              ${service.dropoff_location ? `<div style="margin-bottom:8px;"><strong>To:</strong> ${service.dropoff_location}</div>` : ''}
              ${service.special_instructions ? `<div style="margin-bottom:8px;color:var(--text-muted);font-style:italic;">"${service.special_instructions.substring(0, 100)}${service.special_instructions.length > 100 ? '...' : ''}"</div>` : ''}
              ${driverInfo}
            </div>
            <div class="package-card-footer" style="display:flex;gap:10px;flex-wrap:wrap;padding-top:16px;border-top:1px solid var(--border-subtle);">
              <button class="btn btn-secondary" onclick="viewDestinationService('${service.id}')">View Details</button>
              ${['en_route', 'in_progress'].includes(service.status) && service.tracking_url ? `<a href="${service.tracking_url}" target="_blank" class="btn btn-primary">üìç Track Driver</a>` : ''}
              ${service.status === 'pending' ? `<button class="btn btn-danger btn-sm" onclick="cancelDestinationService('${service.id}')" style="margin-left:auto;">Cancel Service</button>` : ''}
            </div>
          </div>
        `;
      }).join('');
    }

    function openDestinationBookingModal() {
      currentDestServiceType = null;
      document.getElementById('dest-step-1').style.display = 'block';
      document.getElementById('dest-step-airport').style.display = 'none';
      document.getElementById('dest-step-dealership').style.display = 'none';
      document.getElementById('dest-step-detailing').style.display = 'none';
      document.getElementById('dest-step-valet').style.display = 'none';
      document.getElementById('dest-submit-btn').style.display = 'none';
      document.getElementById('dest-modal-title').textContent = 'Book Destination Service';
      
      document.querySelectorAll('.dest-service-option').forEach(opt => {
        opt.style.borderColor = 'var(--border-subtle)';
        opt.style.background = 'var(--bg-input)';
      });
      
      populateDestVehicleSelects();
      openModal('destination-booking-modal');
    }

    function populateDestVehicleSelects() {
      const selects = ['dest-airport-vehicle', 'dest-dealer-vehicle', 'dest-detail-vehicle', 'dest-valet-vehicle'];
      selects.forEach(id => {
        const select = document.getElementById(id);
        if (select) {
          select.innerHTML = '<option value="">Select a vehicle...</option>' + 
            vehicles.map(v => `<option value="${v.id}">${v.nickname || `${v.year || ''} ${v.make} ${v.model}`.trim()}</option>`).join('');
        }
      });
    }

    function selectDestServiceType(type) {
      currentDestServiceType = type;
      
      document.querySelectorAll('.dest-service-option').forEach(opt => {
        const isSelected = opt.dataset.service === type;
        opt.style.borderColor = isSelected ? 'var(--accent-gold)' : 'var(--border-subtle)';
        opt.style.background = isSelected ? 'rgba(212,168,85,0.15)' : 'var(--bg-input)';
      });
      
      document.getElementById('dest-step-1').style.display = 'none';
      document.getElementById('dest-step-airport').style.display = type === 'airport' ? 'block' : 'none';
      document.getElementById('dest-step-dealership').style.display = type === 'dealership' ? 'block' : 'none';
      document.getElementById('dest-step-detailing').style.display = type === 'detailing' ? 'block' : 'none';
      document.getElementById('dest-step-valet').style.display = type === 'valet' ? 'block' : 'none';
      
      const submitBtn = document.getElementById('dest-submit-btn');
      submitBtn.style.display = 'inline-flex';
      
      const titles = {
        airport: '‚úàÔ∏è Airport Pickup/Drop-off',
        dealership: 'üè¢ Dealership Service Run',
        detailing: '‚ú® Mobile Detailing',
        valet: 'üîë Valet Service'
      };
      
      const buttonLabels = {
        airport: '‚úàÔ∏è Book Airport Service',
        dealership: 'üè¢ Schedule Dealership Run',
        detailing: '‚ú® Book Detail Service',
        valet: 'üîë Book Valet Service'
      };
      
      document.getElementById('dest-modal-title').textContent = titles[type] || 'Book Destination Service';
      submitBtn.textContent = buttonLabels[type] || 'Book Service';
      
      setupTripTypeListeners();
      setupDetailLevelListeners();
      setupParkingPrefListeners();
    }

    function goBackToServiceSelection() {
      currentDestServiceType = null;
      document.getElementById('dest-step-1').style.display = 'block';
      document.getElementById('dest-step-airport').style.display = 'none';
      document.getElementById('dest-step-dealership').style.display = 'none';
      document.getElementById('dest-step-detailing').style.display = 'none';
      document.getElementById('dest-step-valet').style.display = 'none';
      document.getElementById('dest-submit-btn').style.display = 'none';
      document.getElementById('dest-modal-title').textContent = 'Book Destination Service';
    }

    function setupTripTypeListeners() {
      document.querySelectorAll('.dest-trip-option').forEach(option => {
        option.onclick = function() {
          document.querySelectorAll('.dest-trip-option').forEach(o => {
            o.style.borderColor = 'var(--border-subtle)';
            o.style.background = 'var(--bg-input)';
          });
          this.style.borderColor = 'var(--accent-blue)';
          this.style.background = 'rgba(74,124,255,0.1)';
          this.querySelector('input').checked = true;
          
          const tripType = this.querySelector('input').value;
          const returnGroup = document.getElementById('dest-airport-return-group');
          if (returnGroup) {
            returnGroup.style.display = (tripType === 'round_trip' || tripType === 'arrival') ? 'block' : 'none';
          }
        };
      });
    }

    function setupDetailLevelListeners() {
      document.querySelectorAll('.dest-detail-level').forEach(option => {
        option.onclick = function() {
          document.querySelectorAll('.dest-detail-level').forEach(o => {
            o.style.borderColor = 'var(--border-subtle)';
            o.style.background = 'var(--bg-input)';
          });
          this.style.borderColor = 'var(--accent-gold)';
          this.style.background = 'rgba(212,168,85,0.15)';
          this.querySelector('input').checked = true;
        };
      });
    }

    function setupParkingPrefListeners() {
      document.querySelectorAll('.dest-parking-option').forEach(option => {
        option.onclick = function() {
          document.querySelectorAll('.dest-parking-option').forEach(o => {
            o.style.borderColor = 'var(--border-subtle)';
            o.style.background = 'var(--bg-input)';
          });
          this.style.borderColor = 'var(--accent-blue)';
          this.style.background = 'rgba(74,124,255,0.1)';
          this.querySelector('input').checked = true;
        };
      });
    }

    async function submitDestinationService() {
      if (!currentDestServiceType) {
        showToast('Please select a service type', 'error');
        return;
      }
      
      let vehicleId, serviceData = {};
      
      if (currentDestServiceType === 'airport') {
        vehicleId = document.getElementById('dest-airport-vehicle').value;
        const tripType = document.querySelector('input[name="dest-trip-type"]:checked')?.value;
        const pickupLocation = document.getElementById('dest-airport-pickup').value;
        const airportLocation = document.getElementById('dest-airport-location').value;
        const flightDatetime = document.getElementById('dest-airport-datetime').value;
        
        if (!vehicleId || !tripType || !pickupLocation || !airportLocation || !flightDatetime) {
          showToast('Please fill in all required fields', 'error');
          return;
        }
        
        const parkingPref = document.querySelector('input[name="dest-parking-pref"]:checked')?.value;
        
        serviceData = {
          service_type: 'airport',
          trip_type: tripType,
          pickup_location: pickupLocation,
          dropoff_location: airportLocation,
          parking_location: airportLocation,
          parking_preference: parkingPref || null,
          flight_number: document.getElementById('dest-airport-flight').value,
          airline: document.getElementById('dest-airport-airline').value,
          flight_datetime: flightDatetime,
          return_datetime: document.getElementById('dest-airport-return').value || null,
          special_instructions: document.getElementById('dest-airport-instructions').value
        };
      } else if (currentDestServiceType === 'dealership') {
        vehicleId = document.getElementById('dest-dealer-vehicle').value;
        const pickupLocation = document.getElementById('dest-dealer-pickup').value;
        const dealerName = document.getElementById('dest-dealer-name').value;
        const dealerAddress = document.getElementById('dest-dealer-address').value;
        const serviceType = document.getElementById('dest-dealer-service-type').value;
        const appointmentDatetime = document.getElementById('dest-dealer-datetime').value;
        
        if (!vehicleId || !pickupLocation || !dealerName || !dealerAddress || !serviceType || !appointmentDatetime) {
          showToast('Please fill in all required fields', 'error');
          return;
        }
        
        serviceData = {
          service_type: 'dealership',
          pickup_location: pickupLocation,
          dropoff_location: dealerAddress,
          dealership_name: dealerName,
          dealership_address: dealerAddress,
          dealership_service_type: serviceType,
          appointment_datetime: appointmentDatetime,
          special_instructions: document.getElementById('dest-dealer-instructions').value
        };
      } else if (currentDestServiceType === 'detailing') {
        vehicleId = document.getElementById('dest-detail-vehicle').value;
        const serviceLocation = document.getElementById('dest-detail-location').value;
        const detailLevel = document.querySelector('input[name="dest-detail-level"]:checked')?.value;
        const detailDatetime = document.getElementById('dest-detail-datetime').value;
        
        if (!vehicleId || !serviceLocation || !detailLevel || !detailDatetime) {
          showToast('Please fill in all required fields', 'error');
          return;
        }
        
        serviceData = {
          service_type: 'detailing',
          pickup_location: serviceLocation,
          dropoff_location: serviceLocation,
          detail_level: detailLevel,
          event_datetime: detailDatetime,
          special_instructions: document.getElementById('dest-detail-instructions').value
        };
      } else if (currentDestServiceType === 'valet') {
        vehicleId = document.getElementById('dest-valet-vehicle').value;
        const pickupLocation = document.getElementById('dest-valet-pickup').value;
        const eventName = document.getElementById('dest-valet-event').value;
        const eventVenue = document.getElementById('dest-valet-venue').value;
        const eventDatetime = document.getElementById('dest-valet-datetime').value;
        
        if (!vehicleId || !pickupLocation || !eventName || !eventVenue || !eventDatetime) {
          showToast('Please fill in all required fields', 'error');
          return;
        }
        
        serviceData = {
          service_type: 'valet',
          pickup_location: pickupLocation,
          dropoff_location: eventVenue,
          event_name: eventName,
          event_venue: eventVenue,
          event_datetime: eventDatetime,
          expected_duration: document.getElementById('dest-valet-duration').value,
          special_instructions: document.getElementById('dest-valet-instructions').value
        };
      }
      
      const serviceLabels = {
        airport: 'Airport Parking Service',
        dealership: 'Dealership Service Run',
        detailing: 'Mobile Detailing',
        valet: 'Valet Service'
      };
      
      try {
        const { data: pkg, error: pkgError } = await supabaseClient
          .from('maintenance_packages')
          .insert({
            member_id: currentUser.id,
            vehicle_id: vehicleId,
            title: serviceLabels[currentDestServiceType] || 'Destination Service',
            category: 'destination_service',
            status: 'pending',
            description: serviceData.special_instructions || `${serviceLabels[currentDestServiceType]} booking`,
            bidding_ends_at: new Date(Date.now() + 72 * 60 * 60 * 1000).toISOString()
          })
          .select()
          .single();
        
        if (pkgError) {
          showToast('Error creating service package: ' + pkgError.message, 'error');
          return;
        }
        
        serviceData.package_id = pkg.id;
        
        const { data: destService, error: destError } = await createDestinationService(serviceData);
        
        if (destError) {
          showToast('Error creating destination service: ' + destError, 'error');
          return;
        }
        
        closeModal('destination-booking-modal');
        showToast(`${serviceLabels[currentDestServiceType]} booked successfully!`, 'success');
        await loadDestinationServices();
        showSection('destination-services');
        
      } catch (err) {
        console.error('Error booking destination service:', err);
        showToast('An error occurred while booking the service', 'error');
      }
    }

    async function viewDestinationService(serviceId) {
      const service = destinationServices.find(s => s.id === serviceId);
      if (!service) {
        showToast('Service not found', 'error');
        return;
      }
      
      const pkg = service.maintenance_packages;
      const vehicle = pkg?.vehicles;
      const vehicleName = vehicle ? `${vehicle.year || ''} ${vehicle.make} ${vehicle.model}`.trim() : 'Vehicle';
      
      const serviceIcons = { airport: '‚úàÔ∏è', dealership: 'üè¢', detailing: '‚ú®', valet: 'üîë' };
      const serviceLabels = { airport: 'Airport Parking', dealership: 'Dealership Run', detailing: 'Mobile Detailing', valet: 'Valet Service' };
      const statusLabels = { pending: 'Pending', assigned: 'Driver Assigned', in_progress: 'In Progress', en_route: 'Driver En Route', completed: 'Completed', cancelled: 'Cancelled' };
      const statusColors = { pending: 'gray', assigned: 'var(--accent-blue)', in_progress: 'var(--accent-blue)', en_route: 'var(--accent-orange)', completed: 'var(--accent-green)', cancelled: 'var(--accent-red)' };
      
      let detailsHtml = '';
      
      if (service.service_type === 'airport') {
        detailsHtml = `
          <div style="display:grid;gap:12px;">
            <div><strong>Trip Type:</strong> ${service.trip_type?.replace('_', ' ').charAt(0).toUpperCase() + service.trip_type?.slice(1).replace('_', ' ') || 'N/A'}</div>
            <div><strong>Pickup:</strong> ${service.pickup_location || 'N/A'}</div>
            <div><strong>Airport/Parking:</strong> ${service.parking_location || service.dropoff_location || 'N/A'}</div>
            ${service.parking_preference ? `<div><strong>Parking Type:</strong> ${service.parking_preference.replace('_', '-').charAt(0).toUpperCase() + service.parking_preference.slice(1).replace('_', '-')}</div>` : ''}
            ${service.airline ? `<div><strong>Airline:</strong> ${service.airline}</div>` : ''}
            ${service.flight_number ? `<div><strong>Flight:</strong> ${service.flight_number}</div>` : ''}
            <div><strong>Flight Date/Time:</strong> ${service.flight_datetime ? new Date(service.flight_datetime).toLocaleString() : 'N/A'}</div>
            ${service.return_datetime ? `<div><strong>Return:</strong> ${new Date(service.return_datetime).toLocaleString()}</div>` : ''}
          </div>
        `;
      } else if (service.service_type === 'dealership') {
        detailsHtml = `
          <div style="display:grid;gap:12px;">
            <div><strong>Pickup:</strong> ${service.pickup_location || 'N/A'}</div>
            <div><strong>Dealership:</strong> ${service.dealership_name || 'N/A'}</div>
            <div><strong>Address:</strong> ${service.dealership_address || service.dropoff_location || 'N/A'}</div>
            <div><strong>Service Type:</strong> ${service.dealership_service_type?.charAt(0).toUpperCase() + service.dealership_service_type?.slice(1) || 'N/A'}</div>
            <div><strong>Appointment:</strong> ${service.appointment_datetime ? new Date(service.appointment_datetime).toLocaleString() : 'N/A'}</div>
          </div>
        `;
      } else if (service.service_type === 'detailing') {
        const levelLabels = { basic: 'Basic ($)', standard: 'Standard ($$)', premium: 'Premium ($$$)', full: 'Full Detail ($$$$)' };
        detailsHtml = `
          <div style="display:grid;gap:12px;">
            <div><strong>Location:</strong> ${service.pickup_location || 'N/A'}</div>
            <div><strong>Service Level:</strong> ${levelLabels[service.detail_level] || service.detail_level || 'N/A'}</div>
            <div><strong>Scheduled:</strong> ${service.event_datetime ? new Date(service.event_datetime).toLocaleString() : 'N/A'}</div>
          </div>
        `;
      } else if (service.service_type === 'valet') {
        detailsHtml = `
          <div style="display:grid;gap:12px;">
            <div><strong>Pickup:</strong> ${service.pickup_location || 'N/A'}</div>
            <div><strong>Event:</strong> ${service.event_name || 'N/A'}</div>
            <div><strong>Venue:</strong> ${service.event_venue || service.dropoff_location || 'N/A'}</div>
            <div><strong>Date/Time:</strong> ${service.event_datetime ? new Date(service.event_datetime).toLocaleString() : 'N/A'}</div>
            ${service.expected_duration ? `<div><strong>Duration:</strong> ${service.expected_duration} hours</div>` : ''}
          </div>
        `;
      }
      
      const timelineSteps = [
        { status: 'pending', label: 'Pending', icon: 'üìù' },
        { status: 'assigned', label: 'Assigned', icon: 'üë§' },
        { status: 'en_route', label: 'En Route', icon: 'üöó' },
        { status: 'in_progress', label: 'In Progress', icon: '‚öôÔ∏è' },
        { status: 'completed', label: 'Completed', icon: '‚úÖ' }
      ];
      
      const currentStatusIndex = timelineSteps.findIndex(s => s.status === service.status);
      
      const timelineHtml = `
        <div style="display:flex;justify-content:space-between;margin:24px 0;position:relative;">
          <div style="position:absolute;top:16px;left:0;right:0;height:2px;background:var(--border-subtle);z-index:0;"></div>
          ${timelineSteps.map((step, i) => {
            const isCompleted = i < currentStatusIndex;
            const isCurrent = i === currentStatusIndex;
            const color = isCompleted || isCurrent ? 'var(--accent-green)' : 'var(--text-muted)';
            return `
              <div style="display:flex;flex-direction:column;align-items:center;z-index:1;">
                <div style="width:32px;height:32px;border-radius:50%;background:${isCompleted || isCurrent ? color : 'var(--bg-elevated)'};border:2px solid ${color};display:flex;align-items:center;justify-content:center;font-size:14px;">
                  ${isCompleted ? '‚úì' : step.icon}
                </div>
                <div style="font-size:0.75rem;margin-top:6px;color:${isCurrent ? 'var(--text-primary)' : 'var(--text-muted)'};">${step.label}</div>
              </div>
            `;
          }).join('')}
        </div>
      `;
      
      document.getElementById('dest-detail-title').textContent = `${serviceIcons[service.service_type]} ${serviceLabels[service.service_type]}`;
      document.getElementById('dest-detail-body').innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
          <div style="display:flex;align-items:center;gap:12px;">
            <span style="font-size:36px;">${serviceIcons[service.service_type]}</span>
            <div>
              <div style="font-weight:600;font-size:1.2rem;">${serviceLabels[service.service_type]}</div>
              <div style="color:var(--text-muted);">${vehicleName}</div>
            </div>
          </div>
          <span style="padding:6px 14px;border-radius:100px;font-size:0.85rem;font-weight:600;background:${statusColors[service.status]}22;color:${statusColors[service.status]};">
            ${statusLabels[service.status]}
          </span>
        </div>
        
        ${timelineHtml}
        
        <div class="card" style="margin-bottom:20px;">
          <div class="card-header"><h4 class="card-title">Service Details</h4></div>
          <div style="padding:16px;">
            ${detailsHtml}
            ${service.special_instructions ? `
              <div style="margin-top:16px;padding:12px;background:var(--bg-input);border-radius:var(--radius-md);">
                <strong>Special Instructions:</strong><br>
                <span style="color:var(--text-secondary);">${service.special_instructions}</span>
              </div>
            ` : ''}
          </div>
        </div>
        
        ${service.driver_id ? `
          <div class="card" style="margin-bottom:20px;">
            <div class="card-header"><h4 class="card-title">Driver Information</h4></div>
            <div style="padding:16px;display:flex;align-items:center;gap:16px;">
              <div style="width:60px;height:60px;border-radius:50%;background:var(--accent-blue);display:flex;align-items:center;justify-content:center;font-size:24px;">üë§</div>
              <div>
                <div style="font-weight:600;">${service.driver_name || 'Driver Assigned'}</div>
                ${service.driver_phone ? `<div style="color:var(--text-muted);">üìû ${service.driver_phone}</div>` : ''}
              </div>
              ${service.driver_phone ? `<button class="btn btn-secondary" onclick="window.open('tel:${service.driver_phone}')" style="margin-left:auto;">üìû Contact</button>` : ''}
            </div>
          </div>
        ` : ''}
        
        ${['en_route', 'in_progress'].includes(service.status) && service.tracking_url ? `
          <a href="${service.tracking_url}" target="_blank" class="btn btn-primary" style="width:100%;padding:16px;font-size:1.1rem;">
            üìç Track Driver in Real-Time
          </a>
        ` : ''}
        
        <div style="margin-top:20px;padding:12px;background:var(--bg-input);border-radius:var(--radius-md);font-size:0.85rem;color:var(--text-muted);">
          <strong>Booked:</strong> ${new Date(service.created_at).toLocaleString()}
        </div>
      `;
      
      openModal('destination-detail-modal');
    }

    document.querySelectorAll('#destination-tabs .tab').forEach(tab => {
      tab.addEventListener('click', function() {
        document.querySelectorAll('#destination-tabs .tab').forEach(t => t.classList.remove('active'));
        this.classList.add('active');
        currentDestFilter = this.dataset.destFilter;
        renderDestinationServices();
      });
    });

    async function cancelDestinationService(serviceId) {
      if (!confirm('Are you sure you want to cancel this service? This action cannot be undone.')) {
        return;
      }
      
      const { data, error } = await updateDestinationServiceStatus(serviceId, 'cancelled');
      if (error) {
        showToast('Failed to cancel service: ' + error, 'error');
        return;
      }
      
      showToast('Service cancelled successfully', 'success');
      await loadDestinationServices();
    }

    // ==================== HOUSEHOLD MANAGEMENT ====================
    let currentHousehold = null;
    let householdMembers = [];
    let householdVehicles = [];
    let pendingInvitations = [];
    let myMembershipId = null;
    let isHouseholdOwner = false;
    let managingMember = null;

    async function loadHouseholdSection() {
      if (!currentUser) return;
      
      try {
        const { data, error } = await getMyHouseholds(currentUser.id);
        if (error) {
          console.error('Error loading households:', error);
          return;
        }
        
        const pendingBanner = document.getElementById('household-pending-invitations-banner');
        const allMemberships = await checkPendingInvitations();
        
        if (allMemberships.length > 0) {
          pendingBanner.style.display = 'block';
          const roleLabels = { owner: 'Owner', adult: 'Adult', driver: 'Driver', viewer: 'Viewer', member: 'Member' };
          pendingBanner.innerHTML = allMemberships.map(inv => `
            <div class="card" style="background:linear-gradient(135deg, rgba(212,168,85,0.08), rgba(212,168,85,0.03));border:2px solid rgba(212,168,85,0.3);margin-bottom:12px;position:relative;">
              <div style="position:absolute;top:-8px;left:16px;background:var(--accent-gold);color:#0a0a0f;padding:2px 10px;border-radius:100px;font-size:0.7rem;font-weight:700;">üì® INVITATION</div>
              <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:16px;padding-top:8px;">
                <div style="flex:1;min-width:200px;">
                  <div style="font-size:1.1rem;font-weight:600;margin-bottom:6px;">${inv.household?.name || 'Household'}</div>
                  <div style="display:flex;flex-wrap:wrap;gap:8px;align-items:center;">
                    <span style="font-size:0.85rem;color:var(--text-secondary);">Invited by <strong>${inv.household?.owner?.full_name || 'Owner'}</strong></span>
                    <span style="padding:3px 10px;border-radius:100px;font-size:0.72rem;font-weight:600;background:var(--accent-blue-soft);color:var(--accent-blue);">${roleLabels[inv.role] || 'Member'} Role</span>
                  </div>
                </div>
                <div style="display:flex;gap:10px;">
                  <button class="btn btn-primary" onclick="acceptInvitation('${inv.id}')" style="padding:10px 20px;">‚úì Accept</button>
                  <button class="btn btn-secondary" onclick="declineInvitation('${inv.id}')" style="padding:10px 20px;">‚úó Decline</button>
                </div>
              </div>
            </div>
          `).join('');
        } else {
          pendingBanner.style.display = 'none';
        }
        
        const owned = data.owned || [];
        const memberOf = data.memberOf || [];
        
        if (owned.length === 0 && memberOf.length === 0) {
          document.getElementById('household-no-household').style.display = 'block';
          document.getElementById('household-dashboard').style.display = 'none';
          return;
        }
        
        currentHousehold = owned.length > 0 ? owned[0] : memberOf[0];
        isHouseholdOwner = owned.length > 0 && owned[0].id === currentHousehold.id;
        
        if (memberOf.length > 0 && !isHouseholdOwner) {
          myMembershipId = currentHousehold.membership?.id;
        }
        
        document.getElementById('household-no-household').style.display = 'none';
        document.getElementById('household-dashboard').style.display = 'block';
        
        await loadHouseholdDetails(currentHousehold.id);
        
      } catch (err) {
        console.error('Error loading household section:', err);
      }
    }

    async function checkPendingInvitations() {
      if (!currentUser) return [];
      
      const { data } = await supabaseClient
        .from('household_members')
        .select(`
          *,
          household:household_id(name, owner_id, owner:owner_id(full_name))
        `)
        .eq('email', currentUser.email)
        .eq('status', 'pending');
      
      return data || [];
    }

    async function loadHouseholdDetails(householdId) {
      const { data, error } = await getHouseholdDetails(householdId);
      if (error) {
        console.error('Error loading household details:', error);
        return;
      }
      
      currentHousehold = data;
      householdMembers = data.members || [];
      
      document.getElementById('household-name-display').textContent = data.name;
      
      const memberCount = householdMembers.filter(m => m.status === 'active').length + 1;
      document.getElementById('household-member-count-badge').textContent = `üë• ${memberCount} member${memberCount !== 1 ? 's' : ''}`;
      
      document.getElementById('household-role-display').textContent = isHouseholdOwner ? 'Owner' : 
        (householdMembers.find(m => m.user_id === currentUser.id)?.role || 'Member');
      
      if (isHouseholdOwner) {
        document.getElementById('edit-household-btn').style.display = 'inline-flex';
        document.getElementById('invite-member-btn').style.display = 'inline-flex';
        document.getElementById('share-vehicle-btn').style.display = 'inline-flex';
      } else {
        document.getElementById('edit-household-btn').style.display = 'none';
        document.getElementById('invite-member-btn').style.display = 'none';
        document.getElementById('share-vehicle-btn').style.display = 'none';
      }
      
      renderHouseholdMembers();
      renderPendingInvitations();
      await loadHouseholdVehicles(householdId);
      await loadHouseholdActivity();
    }

    function renderHouseholdMembers() {
      const grid = document.getElementById('household-members-grid');
      
      const roleColors = {
        owner: 'var(--accent-gold)',
        adult: 'var(--accent-blue)',
        driver: 'var(--accent-green)',
        viewer: 'var(--text-muted)'
      };
      
      const roleLabels = {
        owner: 'Owner',
        adult: 'Adult',
        driver: 'Driver',
        viewer: 'Viewer',
        member: 'Member'
      };
      
      let membersHtml = '';
      
      if (currentHousehold.owner) {
        const owner = currentHousehold.owner;
        const initial = (owner.full_name || owner.email || 'O').charAt(0).toUpperCase();
        const isCurrentUserOwner = currentUser && owner.id === currentUser.id;
        membersHtml += `
          <div style="background:var(--bg-elevated);border:2px solid var(--accent-gold);border-radius:var(--radius-lg);padding:20px;position:relative;">
            <div style="position:absolute;top:-8px;right:16px;background:linear-gradient(135deg, var(--accent-gold), #e8bc5a);color:#0a0a0f;padding:2px 10px;border-radius:100px;font-size:0.7rem;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;">üëë Owner</div>
            <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
              <div style="width:52px;height:52px;background:linear-gradient(135deg, var(--accent-gold), #e8bc5a);border:3px solid rgba(212,168,85,0.3);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:22px;font-weight:700;color:#0a0a0f;box-shadow:0 4px 12px rgba(212,168,85,0.3);">
                ${initial}
              </div>
              <div style="flex:1;">
                <div style="display:flex;align-items:center;gap:8px;">
                  <span style="font-weight:600;font-size:1.05rem;">${owner.full_name || 'Owner'}</span>
                  ${isCurrentUserOwner ? '<span style="padding:2px 8px;border-radius:100px;font-size:0.68rem;font-weight:500;background:var(--accent-blue-soft);color:var(--accent-blue);">You</span>' : ''}
                  <span style="padding:2px 8px;border-radius:100px;font-size:0.68rem;font-weight:500;background:var(--accent-green-soft);color:var(--accent-green);">Active</span>
                </div>
                <div style="font-size:0.85rem;color:var(--text-muted);">${owner.email || ''}</div>
              </div>
            </div>
            <div style="display:flex;flex-wrap:wrap;gap:6px;">
              <span style="display:inline-block;padding:2px 8px;border-radius:100px;font-size:0.7rem;background:var(--accent-blue-soft);color:var(--accent-blue);">üìù Can Request</span>
              <span style="display:inline-block;padding:2px 8px;border-radius:100px;font-size:0.7rem;background:var(--accent-green-soft);color:var(--accent-green);">‚úì Can Approve</span>
              <span style="display:inline-block;padding:2px 8px;border-radius:100px;font-size:0.7rem;background:var(--accent-gold-soft);color:var(--accent-gold);">üîì Full Access</span>
            </div>
          </div>
        `;
      }
      
      const activeMembers = householdMembers.filter(m => m.status === 'active');
      activeMembers.forEach(member => {
        const user = member.user || {};
        const name = user.full_name || member.email || 'Member';
        const email = user.email || member.email || '';
        const initial = name.charAt(0).toUpperCase();
        const role = member.role || 'member';
        const roleColor = roleColors[role] || roleColors.viewer;
        const perms = member.permissions || {};
        
        let permsBadges = [];
        if (perms.can_request_services) permsBadges.push('<span style="display:inline-block;padding:2px 8px;border-radius:100px;font-size:0.7rem;background:var(--accent-blue-soft);color:var(--accent-blue);">üìù Can Request</span>');
        if (perms.can_approve_services) permsBadges.push('<span style="display:inline-block;padding:2px 8px;border-radius:100px;font-size:0.7rem;background:var(--accent-green-soft);color:var(--accent-green);">‚úì Can Approve</span>');
        if (perms.spending_limit) permsBadges.push(`<span style="display:inline-block;padding:2px 8px;border-radius:100px;font-size:0.7rem;background:var(--accent-gold-soft);color:var(--accent-gold);">üí∞ $${perms.spending_limit} limit</span>`);
        
        const manageBtn = isHouseholdOwner ? `<button class="btn btn-ghost btn-sm" onclick="openManageMemberModal('${member.id}')">Manage</button>` : '';
        
        membersHtml += `
          <div style="background:var(--bg-elevated);border:1px solid var(--border-subtle);border-radius:var(--radius-lg);padding:20px;">
            <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
              <div style="width:48px;height:48px;background:linear-gradient(135deg, ${roleColor}44, ${roleColor}22);border:2px solid ${roleColor}44;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:20px;font-weight:600;color:${roleColor};">
                ${initial}
              </div>
              <div style="flex:1;">
                <div style="display:flex;align-items:center;gap:8px;">
                  <span style="font-weight:600;">${name}</span>
                  <span style="padding:2px 8px;border-radius:100px;font-size:0.68rem;font-weight:500;background:var(--accent-green-soft);color:var(--accent-green);">Active</span>
                </div>
                <div style="font-size:0.85rem;color:var(--text-muted);">${email}</div>
              </div>
            </div>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:${permsBadges.length > 0 ? '12px' : '0'};">
              <span style="padding:4px 10px;border-radius:100px;font-size:0.75rem;font-weight:600;background:${roleColor}22;color:${roleColor};">
                ${roleLabels[role] || role}
              </span>
              ${manageBtn}
            </div>
            ${permsBadges.length > 0 ? `<div style="display:flex;flex-wrap:wrap;gap:6px;">${permsBadges.join('')}</div>` : ''}
          </div>
        `;
      });
      
      grid.innerHTML = membersHtml || '<div class="empty-state" style="grid-column:1/-1;padding:32px;"><div class="empty-state-icon">üë•</div><p>No members yet.</p></div>';
    }

    function renderPendingInvitations() {
      const pendingSection = document.getElementById('household-pending-section');
      const pendingList = document.getElementById('household-pending-list');
      
      const pending = householdMembers.filter(m => m.status === 'pending');
      
      if (!isHouseholdOwner || pending.length === 0) {
        pendingSection.style.display = 'none';
        return;
      }
      
      const roleLabels = { owner: 'Owner', adult: 'Adult', driver: 'Driver', viewer: 'Viewer', member: 'Member' };
      const roleColors = { owner: 'var(--accent-gold)', adult: 'var(--accent-blue)', driver: 'var(--accent-green)', viewer: 'var(--text-muted)', member: 'var(--text-secondary)' };
      
      pendingSection.style.display = 'block';
      pendingList.innerHTML = pending.map(inv => {
        const role = inv.role || 'member';
        const roleColor = roleColors[role] || roleColors.member;
        return `
          <div style="display:flex;justify-content:space-between;align-items:center;padding:16px;background:var(--bg-input);border:1px solid var(--border-subtle);border-radius:var(--radius-md);margin-bottom:10px;">
            <div style="display:flex;align-items:center;gap:12px;flex:1;">
              <div style="width:40px;height:40px;background:var(--accent-orange-soft);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:16px;color:var(--accent-orange);">üìß</div>
              <div style="flex:1;">
                <div style="font-weight:500;margin-bottom:4px;">${inv.email}</div>
                <div style="display:flex;flex-wrap:wrap;gap:6px;align-items:center;">
                  <span style="padding:2px 8px;border-radius:100px;font-size:0.7rem;font-weight:600;background:var(--accent-orange-soft);color:var(--accent-orange);">‚è≥ Pending</span>
                  <span style="padding:2px 8px;border-radius:100px;font-size:0.7rem;font-weight:500;background:${roleColor}22;color:${roleColor};">${roleLabels[role] || 'Member'}</span>
                </div>
              </div>
            </div>
            <button class="btn btn-danger btn-sm" onclick="cancelInvitation('${inv.id}')" title="Cancel invitation">‚úï Cancel</button>
          </div>
        `;
      }).join('');
    }

    async function loadHouseholdVehicles(householdId) {
      const { data, error } = await getHouseholdVehicles(householdId);
      if (error) {
        console.error('Error loading household vehicles:', error);
        return;
      }
      
      householdVehicles = data || [];
      
      const vehicleCountBadge = document.getElementById('household-vehicle-count-badge');
      if (vehicleCountBadge) {
        vehicleCountBadge.textContent = `üöó ${householdVehicles.length} vehicle${householdVehicles.length !== 1 ? 's' : ''}`;
      }
      
      renderHouseholdVehicles();
    }

    function renderHouseholdVehicles() {
      const grid = document.getElementById('household-vehicles-grid');
      
      if (householdVehicles.length === 0) {
        grid.innerHTML = `
          <div class="empty-state" style="grid-column:1/-1;padding:32px;">
            <div class="empty-state-icon">üöó</div>
            <p>No vehicles shared yet.</p>
            ${isHouseholdOwner ? '<button class="btn btn-secondary" onclick="openShareVehicleModal()" style="margin-top:12px;">+ Share a Vehicle</button>' : ''}
          </div>
        `;
        return;
      }
      
      const accessColors = {
        full: 'var(--accent-green)',
        request: 'var(--accent-orange)',
        view: 'var(--text-muted)'
      };
      
      const accessLabels = {
        full: 'Full Access',
        request: 'Request Only',
        view: 'View Only'
      };
      
      grid.innerHTML = householdVehicles.map(hv => {
        const v = hv.vehicle || {};
        const vehicleName = `${v.year || ''} ${v.make || ''} ${v.model || ''}`.trim() || 'Unknown Vehicle';
        const sharedBy = hv.shared_by_user?.full_name || 'Owner';
        const accessLevel = hv.access_level || 'view';
        const accessColor = accessColors[accessLevel] || accessColors.view;
        
        const canManage = isHouseholdOwner || hv.shared_by === currentUser.id;
        const canRequestService = !isHouseholdOwner && (accessLevel === 'full' || accessLevel === 'request');
        const isViewOnly = accessLevel === 'view' && !isHouseholdOwner;
        
        let actionButtons = '';
        if (canManage) {
          actionButtons = `<button class="btn btn-ghost btn-sm" onclick="removeSharedVehicle('${hv.id}')">Remove</button>`;
        } else if (canRequestService) {
          actionButtons = `<button class="btn btn-primary btn-sm" onclick="requestServiceForHouseholdVehicle('${v.id}', '${vehicleName}')">Request Service</button>`;
        } else if (isViewOnly) {
          actionButtons = `<span style="font-size:0.8rem;color:var(--text-muted);font-style:italic;">üëÅÔ∏è View Only</span>`;
        }
        
        return `
          <div style="background:var(--bg-elevated);border:1px solid var(--border-subtle);border-radius:var(--radius-lg);overflow:hidden;transition:all 0.2s;" class="household-vehicle-card">
            <div style="height:140px;background:linear-gradient(135deg, rgba(74,124,255,0.1), rgba(212,168,85,0.1));display:flex;align-items:center;justify-content:center;font-size:56px;position:relative;">
              üöó
              <span style="position:absolute;top:12px;right:12px;padding:4px 10px;border-radius:100px;font-size:0.72rem;font-weight:600;background:${accessColor}22;color:${accessColor};">
                ${accessLabels[accessLevel]}
              </span>
            </div>
            <div style="padding:16px;">
              <div style="font-weight:600;font-size:1.05rem;margin-bottom:4px;">${vehicleName}</div>
              <div style="font-size:0.85rem;color:var(--text-muted);margin-bottom:12px;">Shared by ${sharedBy}</div>
              <div style="display:flex;justify-content:flex-end;align-items:center;padding-top:12px;border-top:1px solid var(--border-subtle);">
                ${actionButtons}
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    async function createNewHousehold() {
      const name = document.getElementById('create-household-name').value.trim();
      if (!name) {
        showToast('Please enter a household name', 'error');
        return;
      }
      
      const { data, error } = await createHousehold(name, currentUser.id);
      if (error) {
        showToast('Failed to create household: ' + error.message, 'error');
        return;
      }
      
      showToast('Household created successfully!', 'success');
      document.getElementById('create-household-name').value = '';
      isHouseholdOwner = true;
      await loadHouseholdSection();
    }

    function openInviteMemberModal() {
      document.getElementById('invite-email').value = '';
      document.getElementById('invite-role').value = 'adult';
      document.getElementById('perm-request-services').checked = true;
      document.getElementById('perm-approve-services').checked = false;
      document.getElementById('invite-spending-limit').value = '';
      updateInvitePermissions();
      openModal('invite-member-modal');
    }

    function updateInvitePermissions() {
      const role = document.getElementById('invite-role').value;
      const approveContainer = document.getElementById('perm-approve-container');
      const requestCheckbox = document.getElementById('perm-request-services');
      const approveCheckbox = document.getElementById('perm-approve-services');
      
      if (role === 'viewer') {
        requestCheckbox.checked = false;
        requestCheckbox.disabled = true;
        approveCheckbox.checked = false;
        approveContainer.style.display = 'none';
      } else if (role === 'driver') {
        requestCheckbox.checked = true;
        requestCheckbox.disabled = false;
        approveCheckbox.checked = false;
        approveContainer.style.display = 'none';
      } else {
        requestCheckbox.checked = true;
        requestCheckbox.disabled = false;
        approveContainer.style.display = 'flex';
      }
    }

    async function sendHouseholdInvitation() {
      const email = document.getElementById('invite-email').value.trim();
      const role = document.getElementById('invite-role').value;
      
      if (!email) {
        showToast('Please enter an email address', 'error');
        return;
      }
      
      if (!email.includes('@')) {
        showToast('Please enter a valid email address', 'error');
        return;
      }
      
      const permissions = {
        can_request_services: document.getElementById('perm-request-services').checked,
        can_approve_services: document.getElementById('perm-approve-services').checked,
        spending_limit: document.getElementById('invite-spending-limit').value ? 
          parseFloat(document.getElementById('invite-spending-limit').value) : null
      };
      
      const { data, error } = await inviteHouseholdMember(currentHousehold.id, email, role, currentUser.id);
      
      if (error) {
        showToast('Failed to send invitation: ' + error.message, 'error');
        return;
      }
      
      if (data && permissions) {
        await updateHouseholdMemberPermissions(data.id, permissions);
      }
      
      showToast('Invitation sent successfully!', 'success');
      closeModal('invite-member-modal');
      await loadHouseholdDetails(currentHousehold.id);
    }

    async function cancelInvitation(membershipId) {
      if (!confirm('Cancel this invitation?')) return;
      
      const { error } = await removeHouseholdMember(membershipId);
      if (error) {
        showToast('Failed to cancel invitation', 'error');
        return;
      }
      
      showToast('Invitation cancelled', 'success');
      await loadHouseholdDetails(currentHousehold.id);
    }

    async function acceptInvitation(membershipId) {
      const { data, error } = await acceptHouseholdInvitation(membershipId);
      if (error) {
        showToast('Failed to accept invitation: ' + error.message, 'error');
        return;
      }
      
      showToast('You have joined the household!', 'success');
      await loadHouseholdSection();
    }

    async function declineInvitation(membershipId) {
      if (!confirm('Decline this invitation?')) return;
      
      const { error } = await removeHouseholdMember(membershipId);
      if (error) {
        showToast('Failed to decline invitation', 'error');
        return;
      }
      
      showToast('Invitation declined', 'success');
      await loadHouseholdSection();
    }

    function openShareVehicleModal() {
      const select = document.getElementById('share-vehicle-select');
      
      const sharedVehicleIds = householdVehicles.map(hv => hv.vehicle_id);
      const availableVehicles = vehicles.filter(v => !sharedVehicleIds.includes(v.id));
      
      if (availableVehicles.length === 0) {
        showToast('All your vehicles are already shared with this household', 'error');
        return;
      }
      
      select.innerHTML = '<option value="">Choose a vehicle...</option>' + 
        availableVehicles.map(v => `<option value="${v.id}">${v.nickname || `${v.year || ''} ${v.make} ${v.model}`.trim()}</option>`).join('');
      
      document.querySelectorAll('input[name="access-level"]').forEach(r => r.checked = false);
      document.querySelectorAll('.access-level-option').forEach(opt => {
        opt.style.borderColor = 'var(--border-subtle)';
      });
      
      openModal('share-vehicle-modal');
    }

    function selectAccessLevel(level) {
      document.querySelectorAll('.access-level-option').forEach(opt => {
        opt.style.borderColor = 'var(--border-subtle)';
      });
      const selected = document.querySelector(`input[name="access-level"][value="${level}"]`);
      if (selected) {
        selected.checked = true;
        selected.closest('.access-level-option').style.borderColor = 'var(--accent-gold)';
      }
    }

    async function shareVehicle() {
      const vehicleId = document.getElementById('share-vehicle-select').value;
      const accessLevel = document.querySelector('input[name="access-level"]:checked')?.value;
      
      if (!vehicleId) {
        showToast('Please select a vehicle', 'error');
        return;
      }
      
      if (!accessLevel) {
        showToast('Please select an access level', 'error');
        return;
      }
      
      const { data, error } = await shareVehicleWithHousehold(currentHousehold.id, vehicleId, accessLevel, currentUser.id);
      
      if (error) {
        showToast('Failed to share vehicle: ' + error.message, 'error');
        return;
      }
      
      showToast('Vehicle shared successfully!', 'success');
      closeModal('share-vehicle-modal');
      await loadHouseholdVehicles(currentHousehold.id);
    }

    async function removeSharedVehicle(accessId) {
      if (!confirm('Remove this vehicle from household sharing?')) return;
      
      const { error } = await removeVehicleFromHousehold(accessId);
      if (error) {
        showToast('Failed to remove vehicle', 'error');
        return;
      }
      
      showToast('Vehicle removed from household', 'success');
      await loadHouseholdVehicles(currentHousehold.id);
    }

    function requestServiceForHouseholdVehicle(vehicleId, vehicleName) {
      showSection('packages');
      setTimeout(() => {
        openNewPackageModal();
        const vehicleSelect = document.getElementById('p-vehicle');
        if (vehicleSelect) {
          for (let i = 0; i < vehicleSelect.options.length; i++) {
            if (vehicleSelect.options[i].value === vehicleId) {
              vehicleSelect.selectedIndex = i;
              break;
            }
          }
        }
        showToast(`Creating service request for ${vehicleName}`, 'success');
      }, 200);
    }

    function openManageMemberModal(membershipId) {
      managingMember = householdMembers.find(m => m.id === membershipId);
      if (!managingMember) return;
      
      const user = managingMember.user || {};
      const name = user.full_name || managingMember.email || 'Member';
      const perms = managingMember.permissions || {};
      
      document.getElementById('manage-member-content').innerHTML = `
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:20px;">
          <div style="width:48px;height:48px;background:var(--accent-blue-soft);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:20px;font-weight:600;color:var(--accent-blue);">
            ${name.charAt(0).toUpperCase()}
          </div>
          <div>
            <div style="font-weight:600;">${name}</div>
            <div style="font-size:0.85rem;color:var(--text-muted);">${user.email || managingMember.email || ''}</div>
          </div>
        </div>
        
        <div class="form-group">
          <label class="form-label">Role</label>
          <select class="form-select" id="manage-role">
            <option value="adult" ${managingMember.role === 'adult' ? 'selected' : ''}>Adult</option>
            <option value="driver" ${managingMember.role === 'driver' ? 'selected' : ''}>Driver</option>
            <option value="viewer" ${managingMember.role === 'viewer' ? 'selected' : ''}>Viewer</option>
          </select>
        </div>
        
        <div class="form-section">
          <div class="form-section-title">Permissions</div>
          <div style="display:grid;gap:12px;">
            <label style="display:flex;align-items:center;gap:10px;cursor:pointer;">
              <input type="checkbox" id="manage-perm-request" ${perms.can_request_services ? 'checked' : ''}>
              <span>Can request services</span>
            </label>
            <label style="display:flex;align-items:center;gap:10px;cursor:pointer;">
              <input type="checkbox" id="manage-perm-approve" ${perms.can_approve_services ? 'checked' : ''}>
              <span>Can approve services</span>
            </label>
          </div>
          
          <div class="form-group" style="margin-top:16px;">
            <label class="form-label">Spending Limit</label>
            <div style="display:flex;align-items:center;gap:8px;">
              <span style="color:var(--text-muted);">$</span>
              <input type="number" class="form-input" id="manage-spending-limit" placeholder="No limit" value="${perms.spending_limit || ''}" style="max-width:150px;">
              <span style="color:var(--text-muted);font-size:0.85rem;">per service</span>
            </div>
          </div>
        </div>
      `;
      
      openModal('manage-member-modal');
    }

    async function saveMemberPermissions() {
      if (!managingMember) return;
      
      const role = document.getElementById('manage-role').value;
      const permissions = {
        can_request_services: document.getElementById('manage-perm-request').checked,
        can_approve_services: document.getElementById('manage-perm-approve').checked,
        spending_limit: document.getElementById('manage-spending-limit').value ? 
          parseFloat(document.getElementById('manage-spending-limit').value) : null
      };
      
      await supabaseClient
        .from('household_members')
        .update({ role: role })
        .eq('id', managingMember.id);
      
      await updateHouseholdMemberPermissions(managingMember.id, permissions);
      
      showToast('Member permissions updated', 'success');
      closeModal('manage-member-modal');
      managingMember = null;
      await loadHouseholdDetails(currentHousehold.id);
    }

    async function removeMemberFromHousehold() {
      if (!managingMember) return;
      
      const name = managingMember.user?.full_name || managingMember.email || 'this member';
      if (!confirm(`Remove ${name} from the household?`)) return;
      
      const { error } = await removeHouseholdMember(managingMember.id);
      if (error) {
        showToast('Failed to remove member', 'error');
        return;
      }
      
      showToast('Member removed from household', 'success');
      closeModal('manage-member-modal');
      managingMember = null;
      await loadHouseholdDetails(currentHousehold.id);
    }

    async function editHouseholdName() {
      const newName = prompt('Enter new household name:', currentHousehold.name);
      if (!newName || newName.trim() === currentHousehold.name) return;
      
      const { error } = await supabaseClient
        .from('households')
        .update({ name: newName.trim() })
        .eq('id', currentHousehold.id);
      
      if (error) {
        showToast('Failed to update household name', 'error');
        return;
      }
      
      showToast('Household name updated', 'success');
      await loadHouseholdDetails(currentHousehold.id);
    }

    async function loadHouseholdActivity() {
      if (!currentHousehold) return;
      
      const activityList = document.getElementById('household-activity-list');
      if (!activityList) return;
      
      try {
        const memberUserIds = householdMembers
          .filter(m => m.status === 'active' && m.user_id)
          .map(m => m.user_id);
        
        if (isHouseholdOwner && currentUser) {
          memberUserIds.push(currentUser.id);
        }
        
        const sharedVehicleIds = householdVehicles.map(hv => hv.vehicle_id);
        
        if (memberUserIds.length === 0 && sharedVehicleIds.length === 0) {
          activityList.innerHTML = `
            <div class="empty-state" style="padding:24px;">
              <div class="empty-state-icon">üìä</div>
              <p>No recent activity.</p>
              <p style="font-size:0.85rem;color:var(--text-muted);margin-top:8px;">Service requests from household members will appear here.</p>
            </div>
          `;
          return;
        }
        
        let query = supabaseClient
          .from('maintenance_packages')
          .select(`
            id, title, status, created_at,
            member:member_id(id, full_name, email),
            vehicle:vehicle_id(year, make, model)
          `)
          .order('created_at', { ascending: false })
          .limit(10);
        
        if (sharedVehicleIds.length > 0) {
          query = query.in('vehicle_id', sharedVehicleIds);
        } else if (memberUserIds.length > 0) {
          query = query.in('member_id', memberUserIds);
        }
        
        const { data: activity, error } = await query;
        
        if (error || !activity || activity.length === 0) {
          activityList.innerHTML = `
            <div class="empty-state" style="padding:24px;">
              <div class="empty-state-icon">üìä</div>
              <p>No recent activity.</p>
              <p style="font-size:0.85rem;color:var(--text-muted);margin-top:8px;">Service requests from household members will appear here.</p>
            </div>
          `;
          return;
        }
        
        const statusColors = {
          open: { bg: 'var(--accent-green-soft)', color: 'var(--accent-green)', label: 'Open' },
          pending: { bg: 'var(--accent-orange-soft)', color: 'var(--accent-orange)', label: 'Pending' },
          accepted: { bg: 'var(--accent-blue-soft)', color: 'var(--accent-blue)', label: 'Accepted' },
          in_progress: { bg: 'var(--accent-blue-soft)', color: 'var(--accent-blue)', label: 'In Progress' },
          completed: { bg: 'var(--bg-elevated)', color: 'var(--text-muted)', label: 'Completed' },
          cancelled: { bg: 'rgba(239,95,95,0.15)', color: 'var(--accent-red)', label: 'Cancelled' }
        };
        
        activityList.innerHTML = activity.map(item => {
          const memberName = item.member?.full_name || item.member?.email || 'Unknown';
          const vehicleName = item.vehicle ? `${item.vehicle.year || ''} ${item.vehicle.make || ''} ${item.vehicle.model || ''}`.trim() : 'Unknown Vehicle';
          const status = statusColors[item.status] || statusColors.pending;
          const initial = memberName.charAt(0).toUpperCase();
          const date = new Date(item.created_at);
          const timeAgo = getTimeAgo(date);
          const isCurrentUser = currentUser && item.member?.id === currentUser.id;
          
          return `
            <div style="display:flex;gap:16px;padding:16px;background:var(--bg-input);border:1px solid var(--border-subtle);border-radius:var(--radius-md);margin-bottom:12px;transition:all 0.2s;" onmouseover="this.style.borderColor='var(--accent-gold)'" onmouseout="this.style.borderColor='var(--border-subtle)'">
              <div style="width:44px;height:44px;background:linear-gradient(135deg, var(--accent-gold-soft), var(--accent-blue-soft));border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:600;color:var(--accent-gold);flex-shrink:0;">
                ${initial}
              </div>
              <div style="flex:1;min-width:0;">
                <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:12px;margin-bottom:6px;">
                  <div style="flex:1;min-width:0;">
                    <span style="font-weight:600;color:var(--text-primary);">${isCurrentUser ? 'You' : memberName}</span>
                    <span style="color:var(--text-muted);font-size:0.9rem;"> requested service</span>
                  </div>
                  <span style="padding:3px 10px;border-radius:100px;font-size:0.72rem;font-weight:600;background:${status.bg};color:${status.color};white-space:nowrap;">${status.label}</span>
                </div>
                <div style="font-size:0.92rem;color:var(--text-secondary);margin-bottom:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">
                  <span style="color:var(--accent-gold);">üì¶</span> ${item.title}
                </div>
                <div style="display:flex;align-items:center;gap:12px;font-size:0.82rem;color:var(--text-muted);">
                  <span>üöó ${vehicleName}</span>
                  <span>‚Ä¢</span>
                  <span>${timeAgo}</span>
                </div>
              </div>
            </div>
          `;
        }).join('');
        
      } catch (err) {
        console.error('Error loading household activity:', err);
        activityList.innerHTML = `
          <div class="empty-state" style="padding:24px;">
            <div class="empty-state-icon">‚ö†Ô∏è</div>
            <p>Could not load activity.</p>
          </div>
        `;
      }
    }

    function getTimeAgo(date) {
      const now = new Date();
      const diffMs = now - date;
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMins / 60);
      const diffDays = Math.floor(diffHours / 24);
      
      if (diffMins < 1) return 'Just now';
      if (diffMins < 60) return `${diffMins}m ago`;
      if (diffHours < 24) return `${diffHours}h ago`;
      if (diffDays < 7) return `${diffDays}d ago`;
      return date.toLocaleDateString();
    }

    async function refreshHouseholdActivity() {
      await loadHouseholdActivity();
      showToast('Activity refreshed', 'success');
    }

    // ========== FLEET MANAGEMENT ==========
    
    async function loadFleetSection() {
      if (!currentUser) return;
      
      const { owned, memberOf } = await getMyFleets(currentUser.id);
      const allFleets = [...(owned || []), ...(memberOf || [])];
      
      if (allFleets.length === 0) {
        document.getElementById('fleet-no-fleet').style.display = 'block';
        document.getElementById('fleet-dashboard').style.display = 'none';
        return;
      }
      
      currentFleet = owned && owned.length > 0 ? owned[0] : (memberOf && memberOf.length > 0 ? memberOf[0] : null);
      
      if (currentFleet) {
        document.getElementById('fleet-no-fleet').style.display = 'none';
        document.getElementById('fleet-dashboard').style.display = 'block';
        await loadFleetDetails(currentFleet.id);
      } else {
        document.getElementById('fleet-no-fleet').style.display = 'block';
        document.getElementById('fleet-dashboard').style.display = 'none';
      }
    }
    
    let currentFleetVehicleFilter = 'all';
    let fleetPendingApprovals = [];
    
    async function loadFleetDetails(fleetId) {
      const { data, error } = await getFleetDetails(fleetId);
      if (error || !data) {
        console.error('Error loading fleet details:', error);
        return;
      }
      
      currentFleet = data;
      fleetMembers = data.members || [];
      fleetVehicles = data.vehicles || [];
      
      document.getElementById('fleet-name-display').textContent = data.name || data.company_name || 'Unnamed Fleet';
      document.getElementById('fleet-business-type-badge').textContent = formatBusinessType(data.business_type);
      document.getElementById('fleet-member-count-badge').textContent = `${fleetMembers.length} Member${fleetMembers.length !== 1 ? 's' : ''}`;
      document.getElementById('fleet-vehicle-count-badge').textContent = `${fleetVehicles.length} Vehicle${fleetVehicles.length !== 1 ? 's' : ''}`;
      
      const fleetCountBadge = document.getElementById('fleet-count');
      if (fleetCountBadge) {
        fleetCountBadge.textContent = fleetVehicles.length;
        fleetCountBadge.style.display = fleetVehicles.length > 0 ? 'inline-flex' : 'none';
      }
      
      if (data.billing_email || data.address || data.tax_id) {
        document.getElementById('fleet-company-info').style.display = 'block';
        document.getElementById('fleet-billing-email-display').innerHTML = data.billing_email ? `üìß ${data.billing_email}` : '';
        document.getElementById('fleet-address-display').innerHTML = data.address ? `üìç ${data.address}` : '';
        const taxIdEl = document.getElementById('fleet-tax-id-display');
        if (taxIdEl) taxIdEl.innerHTML = data.tax_id ? `üèõÔ∏è Tax ID: ${data.tax_id}` : '';
      } else {
        document.getElementById('fleet-company-info').style.display = 'none';
      }
      
      updateFleetStats();
      renderFleetMembers();
      renderFleetVehicles();
      await loadBulkBatches();
      await loadFleetApprovals();
    }
    
    function updateFleetStats() {
      const activeServices = fleetVehicles.filter(fv => fv.vehicle?.health_status === 'in_service').length;
      const pendingCount = fleetPendingApprovals.length;
      
      document.getElementById('fleet-stat-active-services').textContent = activeServices;
      document.getElementById('fleet-stat-pending-approvals').textContent = pendingCount;
      document.getElementById('fleet-stat-total-vehicles').textContent = fleetVehicles.length;
      document.getElementById('fleet-stat-team-size').textContent = fleetMembers.length;
    }
    
    async function loadFleetApprovals() {
      if (!currentFleet || !currentUser) return;
      
      const isOwnerOrManager = currentFleet.owner_id === currentUser.id || 
        fleetMembers.some(m => m.user_id === currentUser.id && (m.role === 'owner' || m.role === 'manager'));
      
      const approvalSection = document.getElementById('fleet-approval-queue-section');
      if (!approvalSection) return;
      
      if (!isOwnerOrManager) {
        approvalSection.style.display = 'none';
        return;
      }
      
      const { data: approvals, error } = await supabaseClient
        .from('maintenance_packages')
        .select('*, vehicles(*), profiles:member_id(*)')
        .eq('fleet_id', currentFleet.id)
        .eq('status', 'pending_approval')
        .order('created_at', { ascending: false });
      
      fleetPendingApprovals = approvals || [];
      updateFleetStats();
      
      if (fleetPendingApprovals.length === 0) {
        approvalSection.style.display = 'none';
        return;
      }
      
      approvalSection.style.display = 'block';
      renderFleetApprovals();
    }
    
    function renderFleetApprovals() {
      const container = document.getElementById('fleet-approval-queue-list');
      if (!container) return;
      
      if (fleetPendingApprovals.length === 0) {
        container.innerHTML = `
          <div class="empty-state" style="padding:24px;">
            <div class="empty-state-icon">‚úÖ</div>
            <p>No pending approvals.</p>
          </div>
        `;
        return;
      }
      
      container.innerHTML = fleetPendingApprovals.map(pkg => {
        const v = pkg.vehicles || {};
        const requester = pkg.profiles || {};
        const vehicleName = `${v.year || ''} ${v.make || ''} ${v.model || ''}`.trim();
        const requesterName = requester.full_name || requester.email || 'Unknown';
        
        return `
          <div class="batch-card" style="margin-bottom:12px;">
            <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:16px;flex-wrap:wrap;">
              <div>
                <div style="font-weight:600;font-size:1rem;margin-bottom:4px;">${pkg.title || 'Service Request'}</div>
                <div style="font-size:0.88rem;color:var(--text-secondary);margin-bottom:8px;">${vehicleName}</div>
                <div style="display:flex;gap:16px;flex-wrap:wrap;font-size:0.85rem;color:var(--text-muted);">
                  <span>üë§ ${requesterName}</span>
                  ${pkg.estimated_cost ? `<span>üí∞ ~$${Number(pkg.estimated_cost).toLocaleString()}</span>` : ''}
                  <span>üìÖ ${new Date(pkg.created_at).toLocaleDateString()}</span>
                </div>
              </div>
              <div style="display:flex;gap:8px;">
                <button class="btn btn-success btn-sm" onclick="approveFleetServiceRequest('${pkg.id}')">‚úì Approve</button>
                <button class="btn btn-danger btn-sm" onclick="rejectFleetServiceRequest('${pkg.id}')">‚úï Reject</button>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }
    
    async function approveFleetServiceRequest(packageId) {
      const { error } = await supabaseClient
        .from('maintenance_packages')
        .update({ status: 'open', approved_at: new Date().toISOString(), approved_by: currentUser.id })
        .eq('id', packageId);
      
      if (error) {
        showToast('Failed to approve request', 'error');
        return;
      }
      
      showToast('Service request approved!', 'success');
      await loadFleetApprovals();
    }
    
    async function rejectFleetServiceRequest(packageId) {
      if (!confirm('Reject this service request?')) return;
      
      const { error } = await supabaseClient
        .from('maintenance_packages')
        .update({ status: 'rejected', rejected_at: new Date().toISOString(), rejected_by: currentUser.id })
        .eq('id', packageId);
      
      if (error) {
        showToast('Failed to reject request', 'error');
        return;
      }
      
      showToast('Service request rejected', 'success');
      await loadFleetApprovals();
    }
    
    async function refreshFleetApprovals() {
      await loadFleetApprovals();
      showToast('Approval queue refreshed', 'success');
    }
    
    function filterFleetVehicles(filter) {
      currentFleetVehicleFilter = filter;
      
      document.querySelectorAll('#fleet-vehicle-tabs .tab').forEach(tab => {
        tab.classList.remove('active');
        if (tab.dataset.fleetFilter === filter) tab.classList.add('active');
      });
      
      renderFleetVehicles();
    }
    
    function formatBusinessType(type) {
      const types = {
        rental: 'Rental',
        corporate: 'Corporate',
        delivery: 'Delivery',
        rideshare: 'Rideshare',
        logistics: 'Logistics',
        small_business: 'Small Business',
        government: 'Government',
        nonprofit: 'Non-Profit',
        other: 'Other'
      };
      return types[type] || type || 'Business';
    }
    
    function renderFleetMembers() {
      const tbody = document.getElementById('fleet-members-tbody');
      if (!tbody) return;
      
      if (fleetMembers.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="8" style="text-align:center;padding:32px;color:var(--text-muted);">
              <div style="font-size:32px;margin-bottom:8px;">üë•</div>
              No fleet members yet. Add your first employee.
            </td>
          </tr>
        `;
        return;
      }
      
      tbody.innerHTML = fleetMembers.map(member => {
        const profile = member.user || {};
        const name = profile.full_name || member.email || 'Unknown';
        const email = profile.email || member.email || '-';
        const role = member.role || 'driver';
        const status = member.status || 'active';
        
        return `
          <tr>
            <td>
              <div style="display:flex;align-items:center;gap:12px;">
                <div style="width:36px;height:36px;background:var(--accent-gold-soft);border-radius:50%;display:flex;align-items:center;justify-content:center;">
                  ${name.charAt(0).toUpperCase()}
                </div>
                <div>
                  <div style="font-weight:500;">${name}</div>
                  <div style="font-size:0.82rem;color:var(--text-muted);">${email}</div>
                </div>
              </div>
            </td>
            <td><span class="fleet-role-badge ${role}">${role}</span></td>
            <td>${member.employee_id || '-'}</td>
            <td>${member.department || '-'}</td>
            <td>${member.spending_limit ? '$' + Number(member.spending_limit).toLocaleString() : 'No limit'}</td>
            <td>
              ${member.requires_approval 
                ? '<span class="approval-indicator">‚ö†Ô∏è Required</span>' 
                : '<span class="approval-indicator no-approval">‚úì Auto</span>'}
            </td>
            <td><span class="fleet-status-badge ${status}">${status}</span></td>
            <td>
              <div style="display:flex;gap:6px;">
                <button class="btn btn-ghost btn-sm" onclick="openEditFleetEmployee('${member.id}')" title="Edit">‚úèÔ∏è</button>
                ${status === 'active' 
                  ? `<button class="btn btn-ghost btn-sm" onclick="suspendFleetMember('${member.id}', '${name.replace(/'/g, "\\'")}')" title="Suspend" style="color:var(--accent-orange);">‚è∏Ô∏è</button>`
                  : `<button class="btn btn-ghost btn-sm" onclick="activateFleetMember('${member.id}', '${name.replace(/'/g, "\\'")}')" title="Activate" style="color:var(--accent-green);">‚ñ∂Ô∏è</button>`
                }
                <button class="btn btn-ghost btn-sm" onclick="confirmRemoveFleetEmployee('${member.id}', '${name.replace(/'/g, "\\'")}')" title="Remove" style="color:var(--accent-red);">üóëÔ∏è</button>
              </div>
            </td>
          </tr>
        `;
      }).join('');
    }
    
    function renderFleetVehicles() {
      const grid = document.getElementById('fleet-vehicles-grid');
      if (!grid) return;
      
      let filteredVehicles = fleetVehicles;
      
      if (currentFleetVehicleFilter === 'assigned') {
        filteredVehicles = fleetVehicles.filter(fv => fv.assigned_driver_id && fv.assignment_type !== 'pool');
      } else if (currentFleetVehicleFilter === 'pool') {
        filteredVehicles = fleetVehicles.filter(fv => fv.assignment_type === 'pool' || !fv.assigned_driver_id);
      } else if (currentFleetVehicleFilter === 'needs_service') {
        filteredVehicles = fleetVehicles.filter(fv => {
          const v = fv.vehicle || {};
          return v.health_status === 'needs_attention' || v.health_status === 'poor' || v.health_status === 'fair';
        });
      }
      
      if (fleetVehicles.length === 0) {
        grid.innerHTML = `
          <div class="empty-state" style="grid-column:1/-1;padding:32px;">
            <div class="empty-state-icon">üöó</div>
            <p>No vehicles in fleet yet.</p>
            <button class="btn btn-primary btn-sm" onclick="openAddFleetVehicleModal()" style="margin-top:12px;">+ Add First Vehicle</button>
          </div>
        `;
        return;
      }
      
      if (filteredVehicles.length === 0) {
        grid.innerHTML = `
          <div class="empty-state" style="grid-column:1/-1;padding:24px;">
            <div class="empty-state-icon">üîç</div>
            <p>No vehicles match this filter.</p>
          </div>
        `;
        return;
      }
      
      grid.innerHTML = filteredVehicles.map(fv => {
        const v = fv.vehicle || {};
        const driver = fv.assigned_driver;
        const driverName = driver?.full_name || 'Pool Vehicle';
        const assignment = fv.assignment_type || 'pool';
        const healthStatus = v.health_status || 'good';
        const needsService = healthStatus === 'needs_attention' || healthStatus === 'poor' || healthStatus === 'fair';
        
        return `
          <div class="fleet-vehicle-card">
            <div class="fleet-vehicle-photo">
              ${v.photo_url 
                ? `<img src="${v.photo_url}" alt="${v.make} ${v.model}">` 
                : 'üöó'}
              <span class="fleet-assignment-badge ${assignment}" style="position:absolute;top:8px;right:8px;">${assignment}</span>
              ${needsService ? `<span class="fleet-assignment-badge" style="position:absolute;top:8px;left:8px;background:rgba(239,95,95,0.9);color:#fff;">‚ö†Ô∏è Needs Service</span>` : ''}
            </div>
            <div class="fleet-vehicle-body">
              <div class="fleet-vehicle-title">${v.year || ''} ${v.make || ''} ${v.model || ''}</div>
              <div class="fleet-vehicle-driver">üë§ ${driverName}</div>
              <div class="fleet-vehicle-meta">
                ${fv.department ? `<span style="font-size:0.78rem;color:var(--text-muted);">üìÅ ${fv.department}</span>` : ''}
                <span class="fleet-status-badge ${healthStatus === 'excellent' || healthStatus === 'good' ? 'active' : healthStatus === 'fair' ? 'pending' : 'inactive'}" style="font-size:0.7rem;">${healthStatus}</span>
              </div>
              <div style="display:flex;gap:8px;">
                <button class="btn btn-secondary btn-sm" style="flex:1;" onclick="openEditFleetVehicle('${fv.id}')">‚úèÔ∏è Edit</button>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }
    
    async function loadBulkBatches() {
      if (!currentFleet) return;
      
      const { data, error } = await getFleetBulkBatches(currentFleet.id);
      if (error) {
        console.error('Error loading bulk batches:', error);
        return;
      }
      
      bulkBatches = data || [];
      renderBulkBatches();
    }
    
    function renderBulkBatches() {
      const container = document.getElementById('bulk-batches-list');
      if (!container) return;
      
      if (bulkBatches.length === 0) {
        container.innerHTML = `
          <div class="empty-state" style="padding:32px;">
            <div class="empty-state-icon">üìÖ</div>
            <p>No bulk service batches yet.</p>
            <p style="font-size:0.85rem;color:var(--text-muted);margin-top:8px;">Schedule maintenance for multiple vehicles at once.</p>
          </div>
        `;
        return;
      }
      
      container.innerHTML = bulkBatches.map(batch => {
        const statusClass = (batch.status || 'draft').replace(/ /g, '_');
        const vehicleCount = batch.vehicles?.length || 0;
        
        return `
          <div class="batch-card">
            <div class="batch-header">
              <div>
                <div class="batch-title">${batch.name || 'Untitled Batch'}</div>
                <div style="font-size:0.85rem;color:var(--text-muted);">${batch.service_type || 'Maintenance'}</div>
              </div>
              <span class="batch-status-badge ${statusClass}">${formatBatchStatus(batch.status)}</span>
            </div>
            <div class="batch-meta">
              <span>üöó ${vehicleCount} vehicle${vehicleCount !== 1 ? 's' : ''}</span>
              <span>üìÖ ${formatDateRange(batch.start_date, batch.end_date)}</span>
              ${batch.total_estimated_cost ? `<span>üí∞ ~$${Number(batch.total_estimated_cost).toLocaleString()}</span>` : ''}
            </div>
            <div class="batch-actions">
              ${batch.status === 'draft' ? `<button class="btn btn-secondary btn-sm" onclick="editBulkBatch('${batch.id}')">Edit</button>` : ''}
              ${batch.status === 'draft' ? `<button class="btn btn-primary btn-sm" onclick="submitBulkBatch('${batch.id}')">Submit for Approval</button>` : ''}
              ${batch.status === 'pending_approval' && currentFleet.owner_id === currentUser?.id ? `<button class="btn btn-success btn-sm" onclick="approveBulkBatch('${batch.id}')">Approve</button>` : ''}
            </div>
          </div>
        `;
      }).join('');
    }
    
    function formatBatchStatus(status) {
      const statuses = {
        draft: 'Draft',
        pending_approval: 'Pending Approval',
        approved: 'Approved',
        in_progress: 'In Progress',
        completed: 'Completed'
      };
      return statuses[status] || status || 'Draft';
    }
    
    function formatDateRange(start, end) {
      if (!start) return 'No dates set';
      const s = new Date(start).toLocaleDateString();
      const e = end ? new Date(end).toLocaleDateString() : '';
      return e ? `${s} - ${e}` : s;
    }
    
    async function createNewFleet() {
      const name = document.getElementById('create-fleet-name').value.trim();
      const businessType = document.getElementById('create-fleet-business-type').value;
      const billingEmail = document.getElementById('create-fleet-billing-email').value.trim();
      const billingAddress = document.getElementById('create-fleet-billing-address')?.value.trim() || '';
      const taxId = document.getElementById('create-fleet-tax-id')?.value.trim() || '';
      
      if (!name) {
        showToast('Please enter a fleet name', 'error');
        return;
      }
      
      const { data, error } = await createFleet({
        name,
        business_type: businessType || 'other',
        billing_email: billingEmail || null,
        address: billingAddress || null,
        tax_id: taxId || null,
        owner_id: currentUser.id
      });
      
      if (error) {
        showToast('Failed to create fleet: ' + error.message, 'error');
        return;
      }
      
      showToast('Fleet created successfully!', 'success');
      currentFleet = data;
      await loadFleetSection();
    }
    
    function openAddFleetEmployeeModal() {
      document.getElementById('fleet-employee-email').value = '';
      document.getElementById('fleet-employee-role').value = 'driver';
      document.getElementById('fleet-employee-id').value = '';
      document.getElementById('fleet-employee-dept').value = '';
      document.getElementById('fleet-employee-spending-limit').value = '';
      document.getElementById('fleet-employee-requires-approval').checked = false;
      openModal('add-fleet-employee-modal');
    }
    
    async function addFleetEmployee() {
      const email = document.getElementById('fleet-employee-email').value.trim();
      const role = document.getElementById('fleet-employee-role').value;
      const employeeId = document.getElementById('fleet-employee-id').value.trim();
      const department = document.getElementById('fleet-employee-dept').value.trim();
      const spendingLimit = document.getElementById('fleet-employee-spending-limit').value;
      const requiresApproval = document.getElementById('fleet-employee-requires-approval').checked;
      
      if (!email) {
        showToast('Please enter an email address', 'error');
        return;
      }
      
      const { data: userLookup } = await supabaseClient
        .from('profiles')
        .select('id')
        .eq('email', email)
        .single();
      
      const userId = userLookup?.id || null;
      
      const { error } = await addFleetMember(currentFleet.id, userId, role, {
        email,
        employee_id: employeeId || null,
        department: department || null,
        spending_limit: spendingLimit ? Number(spendingLimit) : null,
        requires_approval: requiresApproval
      });
      
      if (error) {
        showToast('Failed to add employee: ' + error.message, 'error');
        return;
      }
      
      showToast('Employee added to fleet!', 'success');
      closeModal('add-fleet-employee-modal');
      await loadFleetDetails(currentFleet.id);
    }
    
    function openEditFleetEmployee(memberId) {
      const member = fleetMembers.find(m => m.id === memberId);
      if (!member) return;
      
      editingFleetMemberId = memberId;
      const profile = member.user || {};
      const name = profile.full_name || member.email || 'Unknown';
      
      document.getElementById('edit-fleet-employee-content').innerHTML = `
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:20px;">
          <div style="width:48px;height:48px;background:var(--accent-gold-soft);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:20px;">
            ${name.charAt(0).toUpperCase()}
          </div>
          <div>
            <div style="font-weight:600;font-size:1.1rem;">${name}</div>
            <div style="color:var(--text-muted);font-size:0.88rem;">${profile.email || member.email || ''}</div>
          </div>
        </div>
        
        <div class="form-group">
          <label class="form-label">Role</label>
          <select class="form-select" id="edit-fleet-employee-role">
            <option value="driver" ${member.role === 'driver' ? 'selected' : ''}>Driver</option>
            <option value="manager" ${member.role === 'manager' ? 'selected' : ''}>Manager</option>
            <option value="viewer" ${member.role === 'viewer' ? 'selected' : ''}>Viewer</option>
          </select>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Employee ID</label>
            <input type="text" class="form-input" id="edit-fleet-employee-id" value="${member.employee_id || ''}">
          </div>
          <div class="form-group">
            <label class="form-label">Department</label>
            <input type="text" class="form-input" id="edit-fleet-employee-dept" value="${member.department || ''}">
          </div>
        </div>
        
        <div class="form-group">
          <label class="form-label">Spending Limit</label>
          <div style="display:flex;align-items:center;gap:8px;">
            <span style="color:var(--text-muted);">$</span>
            <input type="number" class="form-input" id="edit-fleet-employee-spending" value="${member.spending_limit || ''}" style="max-width:150px;">
          </div>
        </div>
        
        <div class="form-group">
          <label style="display:flex;align-items:center;gap:10px;cursor:pointer;">
            <input type="checkbox" id="edit-fleet-employee-approval" ${member.requires_approval ? 'checked' : ''}>
            <span>Requires approval for all service requests</span>
          </label>
        </div>
      `;
      
      openModal('edit-fleet-employee-modal');
    }
    
    async function saveFleetEmployee() {
      if (!editingFleetMemberId) return;
      
      const role = document.getElementById('edit-fleet-employee-role').value;
      const employeeId = document.getElementById('edit-fleet-employee-id').value.trim();
      const department = document.getElementById('edit-fleet-employee-dept').value.trim();
      const spendingLimit = document.getElementById('edit-fleet-employee-spending').value;
      const requiresApproval = document.getElementById('edit-fleet-employee-approval').checked;
      
      const { error } = await updateFleetMember(editingFleetMemberId, {
        role,
        employee_id: employeeId || null,
        department: department || null,
        spending_limit: spendingLimit ? Number(spendingLimit) : null,
        requires_approval: requiresApproval
      });
      
      if (error) {
        showToast('Failed to update employee', 'error');
        return;
      }
      
      showToast('Employee updated', 'success');
      closeModal('edit-fleet-employee-modal');
      editingFleetMemberId = null;
      await loadFleetDetails(currentFleet.id);
    }
    
    async function confirmRemoveFleetEmployee(memberId, name) {
      if (!confirm(`Remove ${name} from the fleet?`)) return;
      
      const { error } = await removeFleetMember(memberId);
      if (error) {
        showToast('Failed to remove employee', 'error');
        return;
      }
      
      showToast('Employee removed from fleet', 'success');
      await loadFleetDetails(currentFleet.id);
    }
    
    async function removeFleetEmployee() {
      if (!editingFleetMemberId) return;
      
      const member = fleetMembers.find(m => m.id === editingFleetMemberId);
      const name = member?.user?.full_name || member?.email || 'this employee';
      
      if (!confirm(`Remove ${name} from the fleet?`)) return;
      
      const { error } = await removeFleetMember(editingFleetMemberId);
      if (error) {
        showToast('Failed to remove employee', 'error');
        return;
      }
      
      showToast('Employee removed from fleet', 'success');
      closeModal('edit-fleet-employee-modal');
      editingFleetMemberId = null;
      await loadFleetDetails(currentFleet.id);
    }
    
    function openAddFleetVehicleModal() {
      const select = document.getElementById('fleet-vehicle-select');
      select.innerHTML = '<option value="">Choose a vehicle from your garage...</option>' + 
        vehicles.filter(v => !fleetVehicles.some(fv => fv.vehicle_id === v.id))
          .map(v => `<option value="${v.id}">${v.year} ${v.make} ${v.model}</option>`)
          .join('');
      
      const driverSelect = document.getElementById('fleet-vehicle-driver');
      driverSelect.innerHTML = '<option value="">No assigned driver (Pool vehicle)</option>' + 
        fleetMembers.filter(m => m.role === 'driver' || m.role === 'manager')
          .map(m => `<option value="${m.user_id || m.id}">${m.user?.full_name || m.email}</option>`)
          .join('');
      
      document.getElementById('fleet-vehicle-dept').value = '';
      document.querySelectorAll('input[name="fleet-assignment-type"]').forEach(r => r.checked = r.value === 'pool');
      
      setupFleetAssignmentOptions();
      openModal('add-fleet-vehicle-modal');
    }
    
    function setupFleetAssignmentOptions() {
      document.querySelectorAll('.fleet-assignment-option').forEach(opt => {
        opt.addEventListener('click', function() {
          document.querySelectorAll('.fleet-assignment-option').forEach(o => o.style.borderColor = 'var(--border-subtle)');
          this.style.borderColor = 'var(--accent-gold)';
          
          const type = this.querySelector('input').value;
          document.getElementById('fleet-vehicle-dates-row').style.display = type === 'temporary' ? 'grid' : 'none';
        });
      });
    }
    
    async function addVehicleToFleet() {
      const vehicleId = document.getElementById('fleet-vehicle-select').value;
      const driverId = document.getElementById('fleet-vehicle-driver').value || null;
      const assignmentType = document.querySelector('input[name="fleet-assignment-type"]:checked')?.value || 'pool';
      const department = document.getElementById('fleet-vehicle-dept').value.trim();
      const startDate = document.getElementById('fleet-vehicle-start-date').value;
      const endDate = document.getElementById('fleet-vehicle-end-date').value;
      
      if (!vehicleId) {
        showToast('Please select a vehicle', 'error');
        return;
      }
      
      const { error } = await assignVehicleToFleet(currentFleet.id, vehicleId, {
        assigned_driver_id: driverId,
        assignment_type: assignmentType,
        department: department || null,
        start_date: startDate || null,
        end_date: endDate || null
      });
      
      if (error) {
        showToast('Failed to add vehicle to fleet: ' + error.message, 'error');
        return;
      }
      
      showToast('Vehicle added to fleet!', 'success');
      closeModal('add-fleet-vehicle-modal');
      await loadFleetDetails(currentFleet.id);
    }
    
    function openEditFleetVehicle(assignmentId) {
      const fv = fleetVehicles.find(v => v.id === assignmentId);
      if (!fv) return;
      
      editingFleetVehicleId = assignmentId;
      const v = fv.vehicle || {};
      
      const driverOptions = '<option value="">No assigned driver (Pool vehicle)</option>' + 
        fleetMembers.filter(m => m.role === 'driver' || m.role === 'manager')
          .map(m => `<option value="${m.user_id || m.id}" ${(m.user_id || m.id) === fv.assigned_driver_id ? 'selected' : ''}>${m.user?.full_name || m.email}</option>`)
          .join('');
      
      document.getElementById('edit-fleet-vehicle-content').innerHTML = `
        <div style="display:flex;align-items:center;gap:16px;margin-bottom:20px;">
          <div style="width:80px;height:60px;background:var(--bg-input);border-radius:var(--radius-md);display:flex;align-items:center;justify-content:center;font-size:32px;overflow:hidden;">
            ${v.photo_url ? `<img src="${v.photo_url}" style="width:100%;height:100%;object-fit:cover;">` : 'üöó'}
          </div>
          <div>
            <div style="font-weight:600;font-size:1.1rem;">${v.year} ${v.make} ${v.model}</div>
            <div style="color:var(--text-muted);font-size:0.88rem;">VIN: ${v.vin || 'N/A'}</div>
          </div>
        </div>
        
        <div class="form-group">
          <label class="form-label">Assigned Driver</label>
          <select class="form-select" id="edit-fleet-vehicle-driver">${driverOptions}</select>
        </div>
        
        <div class="form-group">
          <label class="form-label">Assignment Type</label>
          <select class="form-select" id="edit-fleet-vehicle-type">
            <option value="permanent" ${fv.assignment_type === 'permanent' ? 'selected' : ''}>Permanent</option>
            <option value="temporary" ${fv.assignment_type === 'temporary' ? 'selected' : ''}>Temporary</option>
            <option value="pool" ${fv.assignment_type === 'pool' ? 'selected' : ''}>Pool</option>
          </select>
        </div>
        
        <div class="form-group">
          <label class="form-label">Department / Cost Center</label>
          <input type="text" class="form-input" id="edit-fleet-vehicle-dept" value="${fv.department || ''}">
        </div>
      `;
      
      openModal('edit-fleet-vehicle-modal');
    }
    
    async function saveFleetVehicle() {
      if (!editingFleetVehicleId) return;
      
      const driverId = document.getElementById('edit-fleet-vehicle-driver').value || null;
      const assignmentType = document.getElementById('edit-fleet-vehicle-type').value;
      const department = document.getElementById('edit-fleet-vehicle-dept').value.trim();
      
      const { error } = await updateFleetVehicleAssignment(editingFleetVehicleId, {
        assigned_driver_id: driverId,
        assignment_type: assignmentType,
        department: department || null
      });
      
      if (error) {
        showToast('Failed to update vehicle assignment', 'error');
        return;
      }
      
      showToast('Vehicle assignment updated', 'success');
      closeModal('edit-fleet-vehicle-modal');
      editingFleetVehicleId = null;
      await loadFleetDetails(currentFleet.id);
    }
    
    async function removeVehicleFromFleet() {
      if (!editingFleetVehicleId) return;
      
      const fv = fleetVehicles.find(v => v.id === editingFleetVehicleId);
      const vehicleName = fv?.vehicle ? `${fv.vehicle.year} ${fv.vehicle.make} ${fv.vehicle.model}` : 'this vehicle';
      
      if (!confirm(`Remove ${vehicleName} from the fleet?`)) return;
      
      const { error } = await supabaseClient
        .from('fleet_vehicles')
        .delete()
        .eq('id', editingFleetVehicleId);
      
      if (error) {
        showToast('Failed to remove vehicle', 'error');
        return;
      }
      
      showToast('Vehicle removed from fleet', 'success');
      closeModal('edit-fleet-vehicle-modal');
      editingFleetVehicleId = null;
      await loadFleetDetails(currentFleet.id);
    }
    
    function openBulkServiceWizard() {
      bulkWizardStep = 1;
      bulkSelectedVehicles = [];
      
      document.getElementById('bulk-batch-title').value = '';
      document.getElementById('bulk-service-type').value = '';
      document.getElementById('bulk-batch-description').value = '';
      document.getElementById('bulk-date-start').value = '';
      document.getElementById('bulk-date-end').value = '';
      
      updateBulkWizardUI();
      openModal('bulk-service-wizard-modal');
    }
    
    function updateBulkWizardUI() {
      document.querySelectorAll('.wizard-step').forEach((step, i) => {
        step.classList.remove('active', 'completed');
        if (i + 1 < bulkWizardStep) step.classList.add('completed');
        if (i + 1 === bulkWizardStep) step.classList.add('active');
      });
      
      document.querySelectorAll('.bulk-wizard-step').forEach((step, i) => {
        step.style.display = i + 1 === bulkWizardStep ? 'block' : 'none';
      });
      
      document.getElementById('bulk-prev-btn').style.display = bulkWizardStep > 1 ? 'inline-flex' : 'none';
      document.getElementById('bulk-next-btn').style.display = bulkWizardStep < 4 ? 'inline-flex' : 'none';
      document.getElementById('bulk-submit-btn').style.display = bulkWizardStep === 4 ? 'inline-flex' : 'none';
    }
    
    function bulkWizardNext() {
      if (bulkWizardStep === 1) {
        const title = document.getElementById('bulk-batch-title').value.trim();
        const serviceType = document.getElementById('bulk-service-type').value;
        const startDate = document.getElementById('bulk-date-start').value;
        const endDate = document.getElementById('bulk-date-end').value;
        
        if (!title || !serviceType || !startDate || !endDate) {
          showToast('Please fill in all required fields', 'error');
          return;
        }
        
        renderBulkVehiclesList();
      } else if (bulkWizardStep === 2) {
        if (bulkSelectedVehicles.length === 0) {
          showToast('Please select at least one vehicle', 'error');
          return;
        }
        renderBulkScheduleList();
      } else if (bulkWizardStep === 3) {
        renderBulkReview();
      }
      
      bulkWizardStep++;
      updateBulkWizardUI();
    }
    
    function bulkWizardPrev() {
      if (bulkWizardStep > 1) {
        bulkWizardStep--;
        updateBulkWizardUI();
      }
    }
    
    function renderBulkVehiclesList() {
      const container = document.getElementById('bulk-vehicles-list');
      
      container.innerHTML = fleetVehicles.map(fv => {
        const v = fv.vehicle || {};
        const isSelected = bulkSelectedVehicles.includes(fv.id);
        
        return `
          <label style="display:flex;align-items:center;gap:12px;padding:12px;background:var(--bg-input);border:2px solid ${isSelected ? 'var(--accent-gold)' : 'var(--border-subtle)'};border-radius:var(--radius-md);cursor:pointer;transition:all 0.15s;">
            <input type="checkbox" ${isSelected ? 'checked' : ''} onchange="toggleBulkVehicle('${fv.id}')">
            <div style="width:50px;height:40px;background:var(--bg-elevated);border-radius:var(--radius-sm);display:flex;align-items:center;justify-content:center;overflow:hidden;">
              ${v.photo_url ? `<img src="${v.photo_url}" style="width:100%;height:100%;object-fit:cover;">` : 'üöó'}
            </div>
            <div style="flex:1;">
              <div style="font-weight:500;">${v.year} ${v.make} ${v.model}</div>
              <div style="font-size:0.82rem;color:var(--text-muted);">${fv.department || 'No department'}</div>
            </div>
          </label>
        `;
      }).join('');
      
      updateBulkSelectedCount();
    }
    
    function toggleBulkVehicle(vehicleId) {
      if (bulkSelectedVehicles.includes(vehicleId)) {
        bulkSelectedVehicles = bulkSelectedVehicles.filter(id => id !== vehicleId);
      } else {
        bulkSelectedVehicles.push(vehicleId);
      }
      renderBulkVehiclesList();
    }
    
    function toggleAllBulkVehicles() {
      if (bulkSelectedVehicles.length === fleetVehicles.length) {
        bulkSelectedVehicles = [];
      } else {
        bulkSelectedVehicles = fleetVehicles.map(fv => fv.id);
      }
      renderBulkVehiclesList();
    }
    
    function updateBulkSelectedCount() {
      document.getElementById('bulk-selected-count').textContent = bulkSelectedVehicles.length;
    }
    
    function renderBulkScheduleList() {
      const container = document.getElementById('bulk-schedule-list');
      const startDate = document.getElementById('bulk-date-start').value;
      
      container.innerHTML = bulkSelectedVehicles.map(fvId => {
        const fv = fleetVehicles.find(v => v.id === fvId);
        if (!fv) return '';
        const v = fv.vehicle || {};
        
        return `
          <div style="display:flex;align-items:center;gap:12px;padding:12px;background:var(--bg-input);border-radius:var(--radius-md);">
            <div style="flex:1;">
              <div style="font-weight:500;">${v.year} ${v.make} ${v.model}</div>
            </div>
            <input type="date" class="form-input" style="width:auto;" id="bulk-schedule-${fvId}" value="${startDate}">
          </div>
        `;
      }).join('');
    }
    
    function renderBulkReview() {
      const title = document.getElementById('bulk-batch-title').value;
      const serviceType = document.getElementById('bulk-service-type').value;
      const description = document.getElementById('bulk-batch-description').value;
      const startDate = document.getElementById('bulk-date-start').value;
      const endDate = document.getElementById('bulk-date-end').value;
      
      const vehiclesList = bulkSelectedVehicles.map(fvId => {
        const fv = fleetVehicles.find(v => v.id === fvId);
        if (!fv) return '';
        const v = fv.vehicle || {};
        const schedDate = document.getElementById(`bulk-schedule-${fvId}`)?.value || startDate;
        
        return `
          <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border-subtle);">
            <span>${v.year} ${v.make} ${v.model}</span>
            <span style="color:var(--text-muted);">${new Date(schedDate).toLocaleDateString()}</span>
          </div>
        `;
      }).join('');
      
      document.getElementById('bulk-review-content').innerHTML = `
        <div class="card" style="margin-bottom:16px;">
          <h4 style="margin-bottom:12px;">üìã Batch Details</h4>
          <div style="display:grid;gap:8px;font-size:0.9rem;">
            <div><strong>Title:</strong> ${title}</div>
            <div><strong>Service Type:</strong> ${serviceType}</div>
            <div><strong>Date Range:</strong> ${new Date(startDate).toLocaleDateString()} - ${new Date(endDate).toLocaleDateString()}</div>
            ${description ? `<div><strong>Description:</strong> ${description}</div>` : ''}
          </div>
        </div>
        
        <div class="card">
          <h4 style="margin-bottom:12px;">üöó Vehicles (${bulkSelectedVehicles.length})</h4>
          ${vehiclesList}
        </div>
        
        <div style="margin-top:16px;padding:16px;background:var(--accent-gold-soft);border-radius:var(--radius-md);">
          <strong style="color:var(--accent-gold);">‚ÑπÔ∏è What happens next:</strong>
          <p style="font-size:0.88rem;color:var(--text-secondary);margin-top:8px;">
            This batch will be submitted for approval. Once approved, individual maintenance packages will be created for each vehicle and sent out for provider bids.
          </p>
        </div>
      `;
    }
    
    async function submitBulkServiceBatch() {
      const title = document.getElementById('bulk-batch-title').value.trim();
      const serviceType = document.getElementById('bulk-service-type').value;
      const description = document.getElementById('bulk-batch-description').value.trim();
      const startDate = document.getElementById('bulk-date-start').value;
      const endDate = document.getElementById('bulk-date-end').value;
      
      const vehicleSchedules = bulkSelectedVehicles.map(fvId => {
        const schedDate = document.getElementById(`bulk-schedule-${fvId}`)?.value || startDate;
        return { fleet_vehicle_id: fvId, scheduled_date: schedDate };
      });
      
      const { data, error } = await createBulkServiceBatch(currentFleet.id, {
        name: title,
        service_type: serviceType,
        description: description || null,
        start_date: startDate,
        end_date: endDate,
        vehicles: vehicleSchedules,
        status: 'pending_approval'
      });
      
      if (error) {
        showToast('Failed to create bulk service batch: ' + error.message, 'error');
        return;
      }
      
      showToast('Bulk service batch submitted for approval!', 'success');
      closeModal('bulk-service-wizard-modal');
      await loadBulkBatches();
    }
    
    async function approveBulkBatch(batchId) {
      if (!confirm('Approve this bulk service batch? This will create maintenance packages for all vehicles.')) return;
      
      const { error } = await approveBulkServiceBatch(batchId);
      if (error) {
        showToast('Failed to approve batch: ' + error.message, 'error');
        return;
      }
      
      showToast('Batch approved! Maintenance packages are being created.', 'success');
      await loadBulkBatches();
    }
    
    function openFleetSettingsModal() {
      if (!currentFleet) return;
      
      document.getElementById('fleet-settings-name').value = currentFleet.name || '';
      document.getElementById('fleet-settings-company-name').value = currentFleet.company_name || '';
      document.getElementById('fleet-settings-business-type').value = currentFleet.business_type || 'other';
      document.getElementById('fleet-settings-billing-email').value = currentFleet.billing_email || '';
      document.getElementById('fleet-settings-address').value = currentFleet.address || '';
      const taxIdEl = document.getElementById('fleet-settings-tax-id');
      if (taxIdEl) taxIdEl.value = currentFleet.tax_id || '';
      
      openModal('fleet-settings-modal');
    }
    
    async function saveFleetSettings() {
      const name = document.getElementById('fleet-settings-name').value.trim();
      const companyName = document.getElementById('fleet-settings-company-name').value.trim();
      const businessType = document.getElementById('fleet-settings-business-type').value;
      const billingEmail = document.getElementById('fleet-settings-billing-email').value.trim();
      const address = document.getElementById('fleet-settings-address').value.trim();
      const taxId = document.getElementById('fleet-settings-tax-id')?.value.trim() || '';
      
      if (!name) {
        showToast('Please enter a fleet name', 'error');
        return;
      }
      
      const { error } = await supabaseClient
        .from('fleets')
        .update({
          name,
          company_name: companyName || null,
          business_type: businessType,
          billing_email: billingEmail || null,
          address: address || null,
          tax_id: taxId || null
        })
        .eq('id', currentFleet.id);
      
      if (error) {
        showToast('Failed to update fleet settings', 'error');
        return;
      }
      
      showToast('Fleet settings updated', 'success');
      closeModal('fleet-settings-modal');
      await loadFleetDetails(currentFleet.id);
    }
    
    async function suspendFleetMember(memberId, memberName) {
      if (!confirm(`Suspend ${memberName}? They will not be able to request services.`)) return;
      
      const { error } = await updateFleetMember(memberId, { status: 'suspended' });
      if (error) {
        showToast('Failed to suspend member', 'error');
        return;
      }
      
      showToast('Member suspended', 'success');
      await loadFleetDetails(currentFleet.id);
    }
    
    async function activateFleetMember(memberId, memberName) {
      const { error } = await updateFleetMember(memberId, { status: 'active' });
      if (error) {
        showToast('Failed to activate member', 'error');
        return;
      }
      
      showToast('Member activated', 'success');
      await loadFleetDetails(currentFleet.id);
    }
    
    function editFleetName() {
      const newName = prompt('Enter new fleet name:', currentFleet?.name || '');
      if (!newName || newName.trim() === currentFleet?.name) return;
      
      supabaseClient
        .from('fleets')
        .update({ name: newName.trim() })
        .eq('id', currentFleet.id)
        .then(({ error }) => {
          if (error) {
            showToast('Failed to update fleet name', 'error');
            return;
          }
          showToast('Fleet name updated', 'success');
          loadFleetDetails(currentFleet.id);
        });
    }

    async function logout() {
      await supabaseClient.auth.signOut();
      window.location.href = 'login.html';
    }
  </script>
  <script src="/pwa-init.js"></script>
  <script src="/ai-chat.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      await I18n.init();
      I18n.createLanguageSwitcher('language-switcher');
    });
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Provider Portal ‚Äì My Car Concierge</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0a0a0f" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="My Car Concierge" />
  <link rel="manifest" href="/manifest.json" />
  <link rel="apple-touch-icon" href="/icons/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="192x192" href="/icons/icon-192.png" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Playfair+Display:wght@500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-deep: #0a0a0f;
      --bg-card: rgba(18, 18, 28, 0.85);
      --bg-elevated: rgba(28, 28, 42, 0.95);
      --bg-input: rgba(22, 22, 34, 0.9);
      --text-primary: #f4f4f6;
      --text-secondary: #9898a8;
      --text-muted: #6b6b7a;
      --accent-gold: #d4a855;
      --accent-gold-soft: rgba(212, 168, 85, 0.15);
      --accent-blue: #4a7cff;
      --accent-blue-soft: rgba(74, 124, 255, 0.12);
      --accent-green: #4ac88c;
      --accent-green-soft: rgba(74, 200, 140, 0.12);
      --accent-red: #ef5f5f;
      --accent-orange: #f59e0b;
      --border-subtle: rgba(148, 148, 168, 0.12);
      --border-medium: rgba(148, 148, 168, 0.2);
      --border-focus: rgba(212, 168, 85, 0.5);
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-xl: 24px;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { height: 100vh; font-family: 'Outfit', -apple-system, sans-serif; background: var(--bg-deep); color: var(--text-primary); display: flex; overflow: hidden;
      padding-top: env(safe-area-inset-top);
    }

    .sidebar { width: 260px; background: linear-gradient(180deg, rgba(18, 18, 28, 0.98) 0%, rgba(12, 12, 20, 0.99) 100%); border-right: 1px solid var(--border-subtle); padding: calc(20px + env(safe-area-inset-top)) 12px 20px 12px; display: flex; flex-direction: column; position: fixed; height: 100vh; z-index: 50; overflow-y: auto; -webkit-overflow-scrolling: touch; padding-bottom: 100px; scrollbar-width: none; -ms-overflow-style: none; backdrop-filter: blur(20px); 
    }
    .sidebar::-webkit-scrollbar { display: none; }
    .sidebar-brand { display: flex; align-items: center; justify-content: center; padding: 8px 12px 20px; border-bottom: 1px solid rgba(148, 148, 168, 0.08); margin-bottom: 20px; text-decoration: none; }
    .sidebar-brand-icon { height: 72px; width: auto; border-radius: var(--radius-md); image-rendering: -webkit-optimize-contrast; image-rendering: crisp-edges; filter: drop-shadow(0 2px 12px rgba(212, 168, 85, 0.2)); }
    .sidebar-brand-text { font-family: 'Playfair Display', serif; font-weight: 500; color: var(--text-primary); }
    .nav-label { font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.14em; color: var(--text-muted); padding: 16px 14px 8px; margin-bottom: 4px; font-weight: 600; opacity: 0.7; }
    .nav-item { display: flex; align-items: center; gap: 10px; padding: 11px 14px; border-radius: 10px; cursor: pointer; font-size: 0.88rem; color: var(--text-secondary); transition: all 0.2s ease; margin-bottom: 2px; border: 1px solid transparent; font-weight: 450; }
    .nav-item:hover { background: rgba(212, 168, 85, 0.08); color: var(--text-primary); border-color: rgba(212, 168, 85, 0.12); }
    .nav-item.active { background: linear-gradient(135deg, rgba(212, 168, 85, 0.15), rgba(212, 168, 85, 0.08)); color: var(--accent-gold); border-color: rgba(212, 168, 85, 0.25); font-weight: 500; }
    .nav-badge { margin-left: auto; background: var(--accent-green); color: #022c22; font-size: 0.7rem; font-weight: 600; padding: 3px 8px; border-radius: 100px; min-width: 22px; text-align: center; }
    .sidebar-footer { margin-top: auto; padding: 16px; border-top: 1px solid rgba(148, 148, 168, 0.08); background: linear-gradient(180deg, transparent, rgba(18, 18, 28, 0.5)); }
    .user-info { display: flex; align-items: center; gap: 12px; padding: 12px 14px; border-radius: 12px; background: linear-gradient(135deg, rgba(28, 28, 42, 0.6), rgba(18, 18, 28, 0.8)); margin-bottom: 12px; border: 1px solid rgba(148, 148, 168, 0.08); }
    .user-avatar { width: 38px; height: 38px; background: linear-gradient(135deg, var(--accent-gold), #c49a45); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 600; color: #0a0a0f; box-shadow: 0 2px 8px rgba(212, 168, 85, 0.25); }
    .user-name { font-size: 0.88rem; font-weight: 500; }
    .user-email { font-size: 0.75rem; color: var(--text-muted); }

    .main { flex: 1; margin-left: 260px; padding: 32px 40px; height: 100vh; overflow-y: auto; -webkit-overflow-scrolling: touch; }
    .page-header { margin-bottom: 32px;
      padding-top: env(safe-area-inset-top);
    }
    .page-title { font-family: 'Playfair Display', serif; font-size: 1.8rem; font-weight: 500; margin-bottom: 8px; }
    .page-subtitle { color: var(--text-secondary); font-size: 0.95rem; }

    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 16px; margin-bottom: 32px; }
    .stat-card { background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: var(--radius-lg); padding: 20px; }
    .stat-icon { width: 40px; height: 40px; border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; font-size: 18px; margin-bottom: 12px; }
    .stat-icon.gold { background: var(--accent-gold-soft); }
    .stat-icon.blue { background: var(--accent-blue-soft); }
    .stat-icon.green { background: var(--accent-green-soft); }
    .stat-value { font-size: 1.6rem; font-weight: 600; margin-bottom: 2px; }
    .stat-label { font-size: 0.82rem; color: var(--text-muted); }

    .card { background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: var(--radius-lg); padding: 24px; margin-bottom: 20px; }
    .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;
      padding-top: env(safe-area-inset-top);
    }
    .card-title { font-size: 1.1rem; font-weight: 600; }

    .btn { display: inline-flex; align-items: center; gap: 8px; padding: 10px 20px; font-family: inherit; font-size: 0.88rem; font-weight: 500; border: none; border-radius: var(--radius-md); cursor: pointer; transition: all 0.2s ease; }
    .btn-primary { background: linear-gradient(135deg, var(--accent-gold), #c49a45); color: #0a0a0f; }
    .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 16px rgba(212, 168, 85, 0.3); }
    .btn-secondary { background: var(--bg-elevated); color: var(--text-primary); border: 1px solid var(--border-subtle); }
    .btn-ghost { background: transparent; color: var(--text-secondary); padding: 8px 12px; }
    .btn-sm { padding: 6px 12px; font-size: 0.82rem; }

    .package-card { background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: var(--radius-lg); padding: 24px; margin-bottom: 16px; }
    .package-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;
      padding-top: env(safe-area-inset-top);
    }
    .package-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 4px; }
    .package-vehicle { font-size: 0.88rem; color: var(--text-secondary); }
    .package-badge { padding: 4px 12px; border-radius: 100px; font-size: 0.78rem; font-weight: 500; }
    .package-badge.open { background: var(--accent-green-soft); color: var(--accent-green); }
    .package-badge.recurring { background: var(--accent-blue-soft); color: var(--accent-blue); }
    .package-meta { display: flex; gap: 16px; flex-wrap: wrap; margin-bottom: 12px; font-size: 0.85rem; color: var(--text-muted); }
    .package-description { color: var(--text-secondary); font-size: 0.9rem; line-height: 1.6; margin-bottom: 16px; }
    .package-footer { display: flex; justify-content: space-between; align-items: center; padding-top: 16px; border-top: 1px solid var(--border-subtle); }

    .bid-card { background: var(--bg-elevated); border: 1px solid var(--border-subtle); border-radius: var(--radius-md); padding: 16px 20px; margin-bottom: 12px; }
    .bid-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;
      padding-top: env(safe-area-inset-top);
    }
    .bid-package { font-weight: 600; }
    .bid-amount { font-size: 1.2rem; font-weight: 600; color: var(--accent-gold); }
    .bid-status { padding: 4px 12px; border-radius: 100px; font-size: 0.75rem; font-weight: 500; }
    .bid-status.pending { background: var(--accent-gold-soft); color: var(--accent-gold); }
    .bid-status.accepted { background: var(--accent-green-soft); color: var(--accent-green); }
    .bid-status.rejected { background: rgba(239,95,95,0.15); color: var(--accent-red); }
    .bid-meta { font-size: 0.85rem; color: var(--text-muted); }

    .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(4px); display: none; align-items: center; justify-content: center; z-index: 100; padding: 24px; }
    .modal-backdrop.active { display: flex; }
    .modal { background: var(--bg-elevated); border: 1px solid var(--border-medium); border-radius: var(--radius-xl); width: 100%; max-width: 560px; max-height: 90vh; overflow-y: auto; animation: modalIn 0.2s ease; }
    @keyframes modalIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 24px 28px; border-bottom: 1px solid var(--border-subtle);
      padding-top: env(safe-area-inset-top);
    }
    .modal-title { font-size: 1.15rem; font-weight: 600; }
    .modal-close { width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; background: transparent; border: none; color: var(--text-muted); cursor: pointer; border-radius: var(--radius-sm); font-size: 20px; }
    .modal-body { padding: 24px 28px; }
    .modal-footer { display: flex; justify-content: flex-end; gap: 12px; padding: 20px 28px; border-top: 1px solid var(--border-subtle); }

    .form-group { margin-bottom: 20px; }
    .form-label { display: block; font-size: 0.85rem; font-weight: 500; margin-bottom: 8px; color: var(--text-secondary); }
    .form-input, .form-textarea { width: 100%; padding: 12px 16px; background: var(--bg-input); border: 1px solid var(--border-subtle); border-radius: var(--radius-md); color: var(--text-primary); font-family: inherit; font-size: 0.92rem; }
    .form-input:focus, .form-textarea:focus { outline: none; border-color: var(--border-focus); }
    .form-textarea { min-height: 100px; resize: vertical; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .form-hint { font-size: 0.78rem; color: var(--text-muted); margin-top: 6px; }

    .messages-container { max-height: 300px; overflow-y: auto; margin-bottom: 16px; padding: 16px; background: var(--bg-input); border-radius: var(--radius-md); }
    .message { margin-bottom: 12px; }
    .message.sent { text-align: right; }
    .message-bubble { display: inline-block; max-width: 80%; padding: 10px 14px; border-radius: var(--radius-md); font-size: 0.9rem; }
    .message.received .message-bubble { background: var(--bg-elevated); }
    .message.sent .message-bubble { background: var(--accent-gold); color: #0a0a0f; }
    .message-time { font-size: 0.72rem; color: var(--text-muted); margin-top: 4px; }
    .message-input-row { display: flex; gap: 12px; }

    .photo-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 12px; }
    .photo-item { aspect-ratio: 4/3; border-radius: var(--radius-md); overflow: hidden; border: 1px solid var(--border-subtle); cursor: pointer; }
    .photo-item img { width: 100%; height: 100%; object-fit: cover; }

    .section { display: none; }
    .section.active { display: block; }
    .empty-state { text-align: center; padding: 48px 24px; color: var(--text-muted); }
    .empty-state-icon { font-size: 48px; margin-bottom: 16px; opacity: 0.5; }

    /* Countdown Timer */
    .countdown-timer { display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; background: var(--accent-gold-soft); border-radius: var(--radius-sm); font-size: 0.82rem; font-weight: 500; color: var(--accent-gold); }
    .countdown-timer.urgent { background: rgba(239, 95, 95, 0.15); color: var(--accent-red); animation: pulse 2s infinite; }
    .countdown-timer.expired { background: var(--bg-input); color: var(--text-muted); }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }

    /* Services Grid */
    .services-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 10px; }
    .service-checkbox { display: flex; align-items: center; gap: 10px; padding: 12px 14px; background: var(--bg-input); border: 1px solid var(--border-subtle); border-radius: var(--radius-md); cursor: pointer; font-size: 0.9rem; transition: all 0.15s; }
    .service-checkbox:hover { border-color: var(--border-medium); }
    .service-checkbox:has(input:checked) { border-color: var(--accent-gold); background: var(--accent-gold-soft); }
    .service-checkbox input { width: 18px; height: 18px; accent-color: var(--accent-gold); cursor: pointer; }

    .toast-container { position: fixed; bottom: 24px; right: 24px; z-index: 200; }
    .toast { background: var(--bg-elevated); border: 1px solid var(--accent-green); border-radius: var(--radius-md); padding: 16px 20px; display: flex; align-items: center; gap: 12px; animation: toastIn 0.3s ease; }
    @keyframes toastIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

    /* Logistics Dashboard Styles */
    .job-dashboard { background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: var(--radius-lg); padding: 24px; margin-bottom: 20px; }
    .job-dashboard-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 1px solid var(--border-subtle);
      padding-top: env(safe-area-inset-top);
    }
    .job-dashboard-title { font-size: 1.15rem; font-weight: 600; margin-bottom: 4px; }
    .job-dashboard-vehicle { font-size: 0.9rem; color: var(--text-secondary); }
    .job-dashboard-price { font-size: 1.3rem; font-weight: 600; color: var(--accent-gold); }
    
    .logistics-section { background: var(--bg-elevated); border: 1px solid var(--border-subtle); border-radius: var(--radius-md); padding: 20px; margin-bottom: 16px; }
    .logistics-section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;
      padding-top: env(safe-area-inset-top);
    }
    .logistics-section-title { font-size: 1rem; font-weight: 600; display: flex; align-items: center; gap: 8px; }
    .logistics-section-content { color: var(--text-secondary); font-size: 0.9rem; }
    
    /* Status Timeline */
    .status-timeline { display: flex; flex-direction: column; gap: 0; margin: 16px 0; }
    .status-step { display: flex; align-items: flex-start; gap: 12px; position: relative; padding-bottom: 16px; }
    .status-step:last-child { padding-bottom: 0; }
    .status-step::before { content: ''; position: absolute; left: 15px; top: 32px; bottom: 0; width: 2px; background: var(--border-subtle); }
    .status-step:last-child::before { display: none; }
    .status-dot { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; flex-shrink: 0; border: 2px solid var(--border-subtle); background: var(--bg-input); }
    .status-step.completed .status-dot { background: var(--accent-green); border-color: var(--accent-green); color: #fff; }
    .status-step.current .status-dot { background: var(--accent-gold); border-color: var(--accent-gold); color: #0a0a0f; animation: pulse 2s infinite; }
    .status-step.pending .status-dot { opacity: 0.5; }
    .status-info { flex: 1; padding-top: 4px; }
    .status-label { font-weight: 500; font-size: 0.9rem; margin-bottom: 2px; }
    .status-step.pending .status-label { color: var(--text-muted); }
    .status-time { font-size: 0.78rem; color: var(--text-muted); }
    .status-action { margin-top: 8px; }
    
    /* Appointment Card */
    .appointment-card { background: var(--bg-input); border: 1px solid var(--border-subtle); border-radius: var(--radius-md); padding: 16px; }
    .appointment-date { font-size: 1.1rem; font-weight: 600; color: var(--accent-gold); margin-bottom: 4px; }
    .appointment-time { font-size: 0.9rem; color: var(--text-secondary); }
    .appointment-status { display: inline-block; padding: 4px 12px; border-radius: 100px; font-size: 0.78rem; font-weight: 500; margin-top: 8px; }
    .appointment-status.proposed { background: var(--accent-gold-soft); color: var(--accent-gold); }
    .appointment-status.confirmed { background: var(--accent-green-soft); color: var(--accent-green); }
    .appointment-status.rescheduled { background: var(--accent-blue-soft); color: var(--accent-blue); }
    
    /* Location Card */
    .location-card { background: var(--bg-input); border: 1px solid var(--border-subtle); border-radius: var(--radius-md); padding: 16px; display: flex; gap: 12px; align-items: flex-start; }
    .location-icon { font-size: 24px; }
    .location-details { flex: 1; }
    .location-address { font-size: 0.9rem; margin-bottom: 4px; line-height: 1.4; }
    .location-time { font-size: 0.78rem; color: var(--text-muted); }

    @media (max-width: 900px) {
      .sidebar { transform: translateX(-100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); width: 300px; padding: calc(16px + env(safe-area-inset-top)) 14px 16px 14px; padding-bottom: 100px; overflow-y: auto; -webkit-overflow-scrolling: touch; background: rgba(12, 12, 18, 0.98); 
    }
      .sidebar.open { transform: translateX(0); box-shadow: 8px 0 40px rgba(0,0,0,0.6); }
      .main { margin-left: 0; padding: 24px 16px; }
      .mobile-header { display: flex; align-items: center; gap: 16px; margin-bottom: 24px;
      padding-top: env(safe-area-inset-top);
    }
      .mobile-menu-btn { width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: var(--radius-md); color: var(--text-primary); cursor: pointer; font-size: 1.2rem; }
      .form-row { grid-template-columns: 1fr; }
      .nav-item { padding: 13px 16px; font-size: 0.95rem; border-radius: 12px; margin-bottom: 3px; }
      .nav-label { padding: 20px 16px 10px; font-size: 0.68rem; }
      .sidebar-brand-icon { height: 64px; }
      .sidebar-footer { padding: 16px; margin-top: auto; background: rgba(18, 18, 28, 0.5); border-radius: var(--radius-md); margin: auto 4px 8px; }
      .btn { min-height: 48px; }
      .package-card { padding: 16px; }
      .filter-bar { flex-direction: column; }
      .filter-group { min-width: 100% !important; }
      body.sidebar-open { overflow: hidden; }
    }
    @media (min-width: 901px) { .mobile-header { display: none;
      padding-top: env(safe-area-inset-top);
    } }

    /* Emergency Queue Styles */
    .emergency-card { background: linear-gradient(135deg, rgba(239, 95, 95, 0.15), rgba(255, 68, 68, 0.1)); border: 1px solid rgba(239, 95, 95, 0.3); border-radius: var(--radius-lg); padding: 20px; margin-bottom: 16px; transition: all 0.3s ease; }
    .emergency-card:hover { border-color: rgba(239, 95, 95, 0.5); }
    .emergency-card.urgent-emergency { background: linear-gradient(135deg, rgba(239, 95, 95, 0.25), rgba(255, 68, 68, 0.2)); border-color: rgba(239, 95, 95, 0.6); animation: urgentPulse 1.5s infinite; }
    @keyframes urgentPulse { 0%, 100% { box-shadow: 0 0 0 0 rgba(239, 95, 95, 0.4); } 50% { box-shadow: 0 0 20px 4px rgba(239, 95, 95, 0.3); } }
    .emergency-type-badge { display: inline-block; padding: 4px 12px; border-radius: 100px; font-size: 0.78rem; font-weight: 500; background: rgba(239, 95, 95, 0.2); color: var(--accent-red); }
    .emergency-distance { font-size: 0.9rem; color: var(--accent-gold); font-weight: 500; }
    .emergency-time { font-size: 0.8rem; color: var(--text-muted); }
    .emergency-actions { display: flex; gap: 12px; margin-top: 16px; }
    .btn-emergency { background: linear-gradient(135deg, #ef5f5f, #ff4444); color: white; }
    .btn-emergency:hover { box-shadow: 0 4px 16px rgba(239, 95, 95, 0.3); }
    .nav-badge.emergency { background: var(--accent-red); animation: pulse 2s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }

    /* Team Member Cards */
    .team-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
    .team-card { background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: var(--radius-lg); padding: 24px; transition: all 0.2s ease; }
    .team-card:hover { border-color: var(--accent-gold); box-shadow: 0 4px 20px rgba(212, 168, 85, 0.15); transform: translateY(-2px); }
    .team-card-header { display: flex; gap: 16px; align-items: flex-start; margin-bottom: 16px;
      padding-top: env(safe-area-inset-top);
    }
    .team-avatar { width: 80px; height: 80px; border-radius: 50%; background: linear-gradient(135deg, var(--accent-gold-soft), var(--bg-elevated)); display: flex; align-items: center; justify-content: center; font-size: 32px; color: var(--accent-gold); flex-shrink: 0; overflow: hidden; border: 2px solid var(--border-subtle); }
    .team-avatar img { width: 100%; height: 100%; object-fit: cover; }
    .team-info { flex: 1; min-width: 0; }
    .team-name { font-size: 1.1rem; font-weight: 600; margin-bottom: 4px; }
    .team-role { display: inline-block; padding: 4px 12px; border-radius: 100px; font-size: 0.78rem; font-weight: 500; background: var(--accent-blue-soft); color: var(--accent-blue); }
    .team-experience { font-size: 0.85rem; color: var(--text-muted); margin-top: 8px; }
    .team-bio { font-size: 0.9rem; color: var(--text-secondary); line-height: 1.5; margin-bottom: 16px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    .team-badges { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 16px; }
    .team-badge { padding: 4px 10px; border-radius: 100px; font-size: 0.72rem; font-weight: 500; background: var(--accent-gold-soft); color: var(--accent-gold); }
    .team-actions { display: flex; gap: 8px; padding-top: 16px; border-top: 1px solid var(--border-subtle); }
    .team-photo-upload { width: 150px; height: 150px; border-radius: 50%; background: var(--bg-input); border: 2px dashed var(--border-subtle); display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; margin: 0 auto 20px; transition: all 0.2s ease; overflow: hidden; }
    .team-photo-upload:hover { border-color: var(--accent-gold); }
    .team-photo-upload.has-photo { border-style: solid; }
    .team-photo-upload img { width: 100%; height: 100%; object-fit: cover; }
    .team-photo-upload-icon { font-size: 36px; margin-bottom: 8px; color: var(--text-muted); }
    .team-photo-upload-text { font-size: 0.85rem; color: var(--text-muted); }
    .team-status-badge { display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; border-radius: 100px; font-size: 0.75rem; font-weight: 500; }
    .team-status-badge.active { background: var(--accent-green-soft); color: var(--accent-green); }
    .team-status-badge.inactive { background: rgba(107, 107, 122, 0.15); color: var(--text-muted); }

    /* Multi-Point Inspection Styles */
    .inspection-modal { max-width: 800px; }
    .inspection-category { background: var(--bg-input); border: 1px solid var(--border-subtle); border-radius: var(--radius-md); margin-bottom: 16px; overflow: hidden; }
    .inspection-category-header { padding: 14px 16px; background: var(--bg-elevated); display: flex; justify-content: space-between; align-items: center; cursor: pointer; border-bottom: 1px solid var(--border-subtle);
      padding-top: env(safe-area-inset-top);
    }
    .inspection-category-header:hover { background: rgba(28, 28, 42, 0.98); }
    .inspection-category-title { font-weight: 600; font-size: 0.95rem; display: flex; align-items: center; gap: 8px; }
    .inspection-category-count { font-size: 0.78rem; color: var(--text-muted); }
    .inspection-category-body { padding: 16px; display: none; }
    .inspection-category.expanded .inspection-category-body { display: block; }
    .inspection-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--border-subtle); gap: 12px; flex-wrap: wrap; }
    .inspection-item:last-child { border-bottom: none; padding-bottom: 0; }
    .inspection-item-label { font-size: 0.9rem; font-weight: 500; min-width: 120px; }
    .inspection-status-btns { display: flex; gap: 6px; flex-wrap: wrap; }
    .inspection-status-btn { padding: 6px 12px; border-radius: 100px; font-size: 0.75rem; font-weight: 500; border: 1px solid var(--border-subtle); background: var(--bg-input); color: var(--text-muted); cursor: pointer; transition: all 0.15s; }
    .inspection-status-btn:hover { border-color: var(--text-secondary); }
    .inspection-status-btn.good { border-color: var(--accent-green); color: var(--accent-green); }
    .inspection-status-btn.good.active { background: var(--accent-green); color: #fff; }
    .inspection-status-btn.fair { border-color: #f59e0b; color: #f59e0b; }
    .inspection-status-btn.fair.active { background: #f59e0b; color: #000; }
    .inspection-status-btn.needs_attention { border-color: #f97316; color: #f97316; }
    .inspection-status-btn.needs_attention.active { background: #f97316; color: #fff; }
    .inspection-status-btn.urgent { border-color: var(--accent-red); color: var(--accent-red); }
    .inspection-status-btn.urgent.active { background: var(--accent-red); color: #fff; }
    .inspection-status-btn.na { border-color: var(--text-muted); color: var(--text-muted); }
    .inspection-status-btn.na.active { background: var(--text-muted); color: var(--bg-deep); }
    .inspection-measurement { display: flex; align-items: center; gap: 8px; margin-left: auto; }
    .inspection-measurement input { width: 60px; padding: 6px 8px; background: var(--bg-elevated); border: 1px solid var(--border-subtle); border-radius: var(--radius-sm); color: var(--text-primary); font-size: 0.85rem; text-align: center; }
    .inspection-measurement span { font-size: 0.78rem; color: var(--text-muted); }
    .inspection-summary { background: var(--bg-elevated); border: 1px solid var(--border-subtle); border-radius: var(--radius-md); padding: 20px; margin-bottom: 16px; }
    .inspection-summary-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; text-align: center; }
    .inspection-summary-item { padding: 12px; border-radius: var(--radius-sm); }
    .inspection-summary-item.excellent { background: var(--accent-green-soft); color: var(--accent-green); }
    .inspection-summary-item.good { background: rgba(34, 197, 94, 0.15); color: #22c55e; }
    .inspection-summary-item.fair { background: rgba(245, 158, 11, 0.15); color: #f59e0b; }
    .inspection-summary-item.attention { background: rgba(249, 115, 22, 0.15); color: #f97316; }
    .inspection-summary-item.urgent { background: rgba(239, 95, 95, 0.15); color: var(--accent-red); }
    .inspection-summary-count { font-size: 1.5rem; font-weight: 600; }
    .inspection-summary-label { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; }
    .inspection-overall { display: flex; align-items: center; gap: 16px; padding: 16px; background: var(--bg-input); border-radius: var(--radius-md); margin-bottom: 16px; }
    .inspection-overall-badge { padding: 8px 20px; border-radius: 100px; font-weight: 600; font-size: 0.9rem; }
    .inspection-overall-badge.excellent { background: var(--accent-green); color: #fff; }
    .inspection-overall-badge.good { background: #22c55e; color: #fff; }
    .inspection-overall-badge.fair { background: #f59e0b; color: #000; }
    .inspection-overall-badge.needs_attention { background: #f97316; color: #fff; }
    .inspection-btn { display: inline-flex; align-items: center; gap: 6px; padding: 8px 14px; background: linear-gradient(135deg, var(--accent-blue), #6b9fff); color: #fff; border: none; border-radius: var(--radius-md); font-size: 0.85rem; font-weight: 500; cursor: pointer; transition: all 0.2s; }
    .inspection-btn:hover { box-shadow: 0 4px 12px rgba(74, 124, 255, 0.3); transform: translateY(-1px); }

    /* Performance Scoring Styles */
    .performance-score-display { display: flex; flex-direction: column; align-items: center; justify-content: center; width: 180px; height: 180px; border-radius: 50%; background: linear-gradient(135deg, var(--bg-elevated), var(--bg-input)); border: 4px solid var(--accent-gold); position: relative; }
    .performance-score-value { font-size: 3.5rem; font-weight: 700; color: var(--accent-gold); line-height: 1; }
    .performance-score-label { font-size: 0.85rem; color: var(--text-muted); margin-top: 4px; }
    .performance-tier-badge { display: inline-flex; align-items: center; gap: 8px; padding: 10px 24px; border-radius: 100px; font-size: 1rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.1em; }
    .performance-tier-badge.platinum { background: linear-gradient(135deg, #e5e4e2, #c0c0c0); color: #1a1a2e; box-shadow: 0 4px 20px rgba(229, 228, 226, 0.4); }
    .performance-tier-badge.gold { background: linear-gradient(135deg, var(--accent-gold), #c49a45); color: #1a1a2e; box-shadow: 0 4px 20px rgba(212, 168, 85, 0.4); }
    .performance-tier-badge.silver { background: linear-gradient(135deg, #c0c0c0, #a8a8a8); color: #1a1a2e; box-shadow: 0 4px 20px rgba(192, 192, 192, 0.4); }
    .performance-tier-badge.bronze { background: linear-gradient(135deg, #cd7f32, #b87333); color: #fff; box-shadow: 0 4px 20px rgba(205, 127, 50, 0.4); }
    .performance-metrics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px; }
    .performance-metric-card { background: var(--bg-elevated); border: 1px solid var(--border-subtle); border-radius: var(--radius-lg); padding: 20px; text-align: center; transition: all 0.2s; }
    .performance-metric-card:hover { border-color: var(--accent-gold); transform: translateY(-2px); }
    .performance-metric-icon { font-size: 1.5rem; margin-bottom: 8px; }
    .performance-metric-value { font-size: 1.6rem; font-weight: 700; color: var(--text-primary); margin-bottom: 4px; }
    .performance-metric-label { font-size: 0.82rem; color: var(--text-muted); }
    .performance-badges-grid { display: flex; flex-wrap: wrap; gap: 12px; }
    .performance-badge { display: inline-flex; align-items: center; gap: 8px; padding: 12px 18px; background: var(--bg-elevated); border: 1px solid var(--border-subtle); border-radius: var(--radius-md); font-size: 0.9rem; font-weight: 500; transition: all 0.2s; }
    .performance-badge.earned { background: var(--accent-gold-soft); border-color: var(--accent-gold); color: var(--accent-gold); }
    .performance-badge.locked { opacity: 0.4; }
    .performance-badge-icon { font-size: 1.3rem; }
    .performance-tip { display: flex; align-items: flex-start; gap: 12px; padding: 16px; background: var(--accent-blue-soft); border: 1px solid rgba(74, 124, 255, 0.3); border-radius: var(--radius-md); margin-bottom: 12px; }
    .performance-tip-icon { font-size: 1.2rem; flex-shrink: 0; }
    .performance-tip-text { font-size: 0.9rem; color: var(--text-secondary); }
    .stars-display { display: inline-flex; gap: 2px; color: var(--accent-gold); }

    /* Destination Tasks Styles */
    .dest-filter-tabs { display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; }
    .dest-filter-tab { padding: 10px 18px; background: var(--bg-input); border: 1px solid var(--border-subtle); border-radius: var(--radius-md); cursor: pointer; font-size: 0.88rem; color: var(--text-secondary); transition: all 0.15s; display: flex; align-items: center; gap: 6px; }
    .dest-filter-tab:hover { border-color: var(--accent-gold); color: var(--text-primary); }
    .dest-filter-tab.active { background: var(--accent-gold-soft); border-color: var(--accent-gold); color: var(--accent-gold); }
    .dest-task-card { background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: var(--radius-lg); padding: 20px; margin-bottom: 16px; cursor: pointer; transition: all 0.2s; }
    .dest-task-card:hover { border-color: var(--accent-gold); box-shadow: 0 4px 20px rgba(0,0,0,0.2); transform: translateY(-2px); }
    .dest-task-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;
      padding-top: env(safe-area-inset-top);
    }
    .dest-task-type { display: inline-flex; align-items: center; gap: 8px; padding: 6px 14px; border-radius: 100px; font-size: 0.82rem; font-weight: 500; }
    .dest-task-type.airport { background: rgba(74, 124, 255, 0.15); color: var(--accent-blue); }
    .dest-task-type.dealership { background: rgba(249, 115, 22, 0.15); color: #f97316; }
    .dest-task-type.detail { background: rgba(168, 85, 247, 0.15); color: #a855f7; }
    .dest-task-type.valet { background: rgba(236, 72, 153, 0.15); color: #ec4899; }
    .dest-task-status { padding: 4px 12px; border-radius: 100px; font-size: 0.75rem; font-weight: 500; text-transform: capitalize; }
    .dest-task-status.pending { background: var(--accent-gold-soft); color: var(--accent-gold); }
    .dest-task-status.assigned { background: var(--accent-blue-soft); color: var(--accent-blue); }
    .dest-task-status.en_route, .dest-task-status.in_transit { background: rgba(249, 115, 22, 0.15); color: #f97316; }
    .dest-task-status.picked_up, .dest-task-status.in_progress { background: rgba(168, 85, 247, 0.15); color: #a855f7; }
    .dest-task-status.at_destination { background: rgba(34, 197, 94, 0.15); color: #22c55e; }
    .dest-task-status.completed { background: var(--accent-green-soft); color: var(--accent-green); }
    .dest-task-route { display: flex; align-items: center; gap: 12px; margin: 12px 0; padding: 12px; background: var(--bg-input); border-radius: var(--radius-md); font-size: 0.9rem; }
    .dest-task-route-arrow { color: var(--accent-gold); font-weight: bold; }
    .dest-task-meta { display: flex; gap: 16px; flex-wrap: wrap; font-size: 0.85rem; color: var(--text-muted); }
    .dest-task-time { display: flex; align-items: center; gap: 6px; color: var(--accent-gold); font-weight: 500; }
    .dest-task-priority { display: inline-flex; align-items: center; gap: 4px; padding: 2px 8px; border-radius: 4px; font-size: 0.72rem; font-weight: 600; }
    .dest-task-priority.high { background: rgba(239, 95, 95, 0.15); color: var(--accent-red); }
    .dest-task-priority.normal { background: var(--accent-blue-soft); color: var(--accent-blue); }
    .dest-task-priority.low { background: rgba(107, 107, 122, 0.15); color: var(--text-muted); }
    .dest-task-actions { display: flex; gap: 8px; margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-subtle); flex-wrap: wrap; }
    .dest-timeline { margin: 20px 0; }
    .dest-timeline-item { display: flex; gap: 12px; position: relative; padding-bottom: 16px; }
    .dest-timeline-item:last-child { padding-bottom: 0; }
    .dest-timeline-item::before { content: ''; position: absolute; left: 15px; top: 32px; bottom: 0; width: 2px; background: var(--border-subtle); }
    .dest-timeline-item:last-child::before { display: none; }
    .dest-timeline-dot { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; flex-shrink: 0; background: var(--bg-input); border: 2px solid var(--border-subtle); }
    .dest-timeline-item.completed .dest-timeline-dot { background: var(--accent-green); border-color: var(--accent-green); color: #fff; }
    .dest-timeline-item.current .dest-timeline-dot { background: var(--accent-gold); border-color: var(--accent-gold); color: #0a0a0f; animation: pulse 2s infinite; }
    .dest-service-icon { font-size: 1.5rem; }
    .dest-driver-select { padding: 12px; background: var(--bg-elevated); border: 1px solid var(--border-subtle); border-radius: var(--radius-md); margin-top: 12px; }
    .dest-completed-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin-bottom: 20px; }
    .dest-completed-stat { background: var(--bg-elevated); border: 1px solid var(--border-subtle); border-radius: var(--radius-md); padding: 16px; text-align: center; }
    .dest-completed-stat-value { font-size: 1.5rem; font-weight: 600; color: var(--accent-gold); }
    .dest-completed-stat-label { font-size: 0.82rem; color: var(--text-muted); }

    /* Fleet Services Styles */
    .fleet-batch-card { background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: var(--radius-lg); padding: 24px; margin-bottom: 16px; transition: all 0.2s; cursor: pointer; }
    .fleet-batch-card:hover { border-color: var(--accent-gold); box-shadow: 0 4px 20px rgba(0,0,0,0.2); transform: translateY(-2px); }
    .fleet-batch-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px;
      padding-top: env(safe-area-inset-top);
    }
    .fleet-batch-title { font-size: 1.15rem; font-weight: 600; margin-bottom: 4px; }
    .fleet-batch-company { display: flex; align-items: center; gap: 8px; font-size: 0.9rem; color: var(--accent-blue); }
    .fleet-batch-company-logo { width: 24px; height: 24px; border-radius: 4px; background: var(--accent-blue-soft); display: flex; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: 600; }
    .fleet-batch-status { padding: 6px 14px; border-radius: 100px; font-size: 0.78rem; font-weight: 500; }
    .fleet-batch-status.draft { background: rgba(107, 107, 122, 0.15); color: var(--text-muted); }
    .fleet-batch-status.pending_approval { background: var(--accent-gold-soft); color: var(--accent-gold); }
    .fleet-batch-status.approved { background: var(--accent-blue-soft); color: var(--accent-blue); }
    .fleet-batch-status.in_progress { background: rgba(168, 85, 247, 0.15); color: #a855f7; }
    .fleet-batch-status.completed { background: var(--accent-green-soft); color: var(--accent-green); }
    .fleet-batch-status.open { background: var(--accent-green-soft); color: var(--accent-green); }
    .fleet-batch-meta { display: flex; gap: 20px; flex-wrap: wrap; font-size: 0.88rem; color: var(--text-secondary); margin-bottom: 16px; }
    .fleet-batch-meta-item { display: flex; align-items: center; gap: 6px; }
    .fleet-progress-bar { height: 8px; background: var(--bg-input); border-radius: 4px; overflow: hidden; margin: 12px 0; }
    .fleet-progress-fill { height: 100%; background: linear-gradient(90deg, var(--accent-gold), #c49a45); border-radius: 4px; transition: width 0.3s ease; }
    .fleet-progress-text { font-size: 0.85rem; color: var(--text-secondary); display: flex; justify-content: space-between; }
    .fleet-batch-value { font-size: 1.3rem; font-weight: 600; color: var(--accent-gold); }
    
    .fleet-vehicle-badge { display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; background: linear-gradient(135deg, var(--accent-blue-soft), rgba(74, 124, 255, 0.2)); border: 1px solid rgba(74, 124, 255, 0.3); border-radius: 100px; font-size: 0.75rem; font-weight: 500; color: var(--accent-blue); }
    .fleet-vehicle-badge-icon { font-size: 0.9rem; }
    
    .fleet-item-card { background: var(--bg-elevated); border: 1px solid var(--border-subtle); border-radius: var(--radius-md); padding: 16px; margin-bottom: 12px; }
    .fleet-item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;
      padding-top: env(safe-area-inset-top);
    }
    .fleet-item-vehicle { font-weight: 600; font-size: 0.95rem; }
    .fleet-item-driver { font-size: 0.85rem; color: var(--text-secondary); margin-top: 4px; }
    .fleet-item-status { padding: 4px 10px; border-radius: 100px; font-size: 0.72rem; font-weight: 500; }
    .fleet-item-status.pending { background: var(--accent-gold-soft); color: var(--accent-gold); }
    .fleet-item-status.scheduled { background: var(--accent-blue-soft); color: var(--accent-blue); }
    .fleet-item-status.in_progress { background: rgba(168, 85, 247, 0.15); color: #a855f7; }
    .fleet-item-status.completed { background: var(--accent-green-soft); color: var(--accent-green); }
    .fleet-item-status.skipped { background: rgba(239, 95, 95, 0.15); color: var(--accent-red); }
    .fleet-item-meta { display: flex; gap: 16px; flex-wrap: wrap; font-size: 0.82rem; color: var(--text-muted); margin-bottom: 12px; }
    .fleet-item-actions { display: flex; gap: 8px; flex-wrap: wrap; }
    
    .fleet-bulk-actions { display: flex; gap: 12px; flex-wrap: wrap; padding: 16px; background: var(--bg-elevated); border: 1px solid var(--border-subtle); border-radius: var(--radius-md); margin-bottom: 20px; }
    
    .fleet-bid-calculator { background: var(--bg-elevated); border: 1px solid var(--border-subtle); border-radius: var(--radius-md); padding: 20px; margin-bottom: 20px; }
    .fleet-bid-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--border-subtle); }
    .fleet-bid-row:last-child { border-bottom: none; }
    .fleet-bid-total { font-size: 1.4rem; font-weight: 700; color: var(--accent-gold); }
    
    .fleet-report-summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 16px; margin-bottom: 24px; }
    .fleet-report-stat { background: var(--bg-elevated); border: 1px solid var(--border-subtle); border-radius: var(--radius-md); padding: 20px; text-align: center; }
    .fleet-report-stat-value { font-size: 1.6rem; font-weight: 600; color: var(--accent-gold); margin-bottom: 4px; }
    .fleet-report-stat-label { font-size: 0.82rem; color: var(--text-muted); }
    
    .fleet-tabs { display: flex; gap: 8px; margin-bottom: 24px; flex-wrap: wrap; }
    .fleet-tab { padding: 10px 20px; background: var(--bg-input); border: 1px solid var(--border-subtle); border-radius: var(--radius-md); cursor: pointer; font-size: 0.88rem; color: var(--text-secondary); transition: all 0.15s; }
    .fleet-tab:hover { border-color: var(--accent-gold); color: var(--text-primary); }
    .fleet-tab.active { background: var(--accent-gold-soft); border-color: var(--accent-gold); color: var(--accent-gold); }
    
    .fleet-section { display: none; }
    .fleet-section.active { display: block; }
    
    /* Document Expiration Badges */
    .expiration-badge { display: inline-flex; align-items: center; gap: 4px; padding: 4px 10px; border-radius: 100px; font-size: 0.72rem; font-weight: 500; margin-left: 8px; }
    .expiration-badge.valid { background: var(--accent-green-soft); color: var(--accent-green); }
    .expiration-badge.expiring-soon { background: var(--accent-orange); color: #0a0a0f; animation: pulse 2s infinite; }
    .expiration-badge.expired { background: var(--accent-red); color: #fff; }
    .expiration-warning { display: flex; align-items: center; gap: 8px; padding: 12px 16px; background: rgba(239, 95, 95, 0.1); border: 1px solid rgba(239, 95, 95, 0.3); border-radius: var(--radius-md); margin-bottom: 16px; font-size: 0.9rem; color: var(--accent-red); }
    .expiration-warning.warning { background: rgba(245, 158, 11, 0.1); border-color: rgba(245, 158, 11, 0.3); color: var(--accent-orange); }
  </style>
  <script src="/i18n.js"></script>
</head>
<body>
  <div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleSidebar()" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:40;"></div>
  <aside class="sidebar" id="sidebar">
    <div class="mobile-close" onclick="toggleSidebar()" style="display:none;position:absolute;top:16px;right:16px;width:36px;height:36px;background:var(--bg-elevated);border:1px solid var(--border-subtle);border-radius:50%;cursor:pointer;font-size:1.2rem;align-items:center;justify-content:center;">‚úï</div>
    <a href="index.html" class="sidebar-brand">
      <img src="logo.png" alt="My Car Concierge" class="sidebar-brand-icon">
    </a>
    <div id="language-switcher" style="padding:0 12px 16px;"></div>
    <div class="nav-label">Provider Portal</div>
    <div class="nav-item active" data-section="overview">üìä Dashboard</div>
    <div class="nav-item" data-section="subscription">üéüÔ∏è Bid Credits <span class="nav-badge" id="sub-badge" style="display:none;"></span></div>
    <div class="nav-item" data-section="browse">üì¶ Browse Packages <span class="nav-badge" id="open-count">0</span></div>
    <div class="nav-item" data-section="bids">üí¨ My Bids</div>
    <div class="nav-item" data-section="jobs">‚úì Active Jobs</div>
    <div class="nav-item" data-section="emergencies">üö® Emergency Queue <span class="nav-badge emergency" id="emergency-count" style="display:none;">0</span></div>
    <div class="nav-item" data-section="destination-tasks">üöó Destination Tasks <span class="nav-badge" id="destination-count" style="display:none;background:var(--accent-blue);">0</span></div>
    <div class="nav-item" data-section="fleet-services">üè¢ Fleet Services <span class="nav-badge" id="fleet-count" style="display:none;background:var(--accent-gold);">0</span></div>
    <div class="nav-item" data-section="earnings">üí∞ Earnings</div>
    <div class="nav-item" data-section="reviews">‚≠ê My Reviews</div>
    <div class="nav-item" data-section="performance">üìà Performance</div>
    <div class="nav-item" data-section="messages">üí¨ Messages</div>
    <div class="nav-item" data-section="notifications">üîî Notifications <span class="nav-badge" id="notif-count" style="display:none;background:var(--accent-red);">0</span></div>
    
    <div class="nav-label">Settings</div>
    <div class="nav-item" data-section="profile">‚öôÔ∏è Business Profile</div>
    <div class="nav-item" data-section="team">üë• Team Members</div>
    <div class="sidebar-footer">
      <div id="realtime-status" style="padding:8px 12px;margin-bottom:8px;font-size:0.75rem;display:flex;align-items:center;gap:6px;color:var(--text-muted);">
        <span id="realtime-dot" style="width:8px;height:8px;border-radius:50%;background:var(--accent-orange);"></span>
        <span id="realtime-text">Connecting...</span>
      </div>
      <div class="user-info">
        <div class="user-avatar" id="user-avatar">P</div>
        <div><div class="user-name" id="user-name">Loading...</div><div class="user-email" id="user-email">...</div></div>
      </div>
      <div id="switch-portal-container" style="display:none;background:var(--bg-elevated);border:1px solid var(--accent-blue);border-radius:var(--radius-md);padding:12px;margin-bottom:12px;">
        <div style="font-size:0.75rem;color:var(--text-muted);margin-bottom:8px;text-transform:uppercase;letter-spacing:0.05em;">Switch Portal</div>
        <button id="switch-portal-btn" class="btn" onclick="switchToMember()" style="width:100%;padding:12px 16px;font-size:0.9rem;background:linear-gradient(135deg, var(--accent-blue), #6b9fff);color:#fff;font-weight:600;border:none;">
          üöó Member Portal
        </button>
        <div style="font-size:0.72rem;color:var(--text-muted);margin-top:6px;text-align:center;">You have dual access</div>
      </div>
      <button class="btn btn-secondary" onclick="logout()" style="width:100%;padding:14px 20px;font-size:0.95rem;">üö™ Log Out</button>
    </div>
  </aside>

  <main class="main">
    <div class="mobile-header">
      <button class="mobile-menu-btn" onclick="toggleSidebar()">‚ò∞</button>
      <span style="font-weight:600">Provider Portal</span>
    </div>

    <section id="overview" class="section active">
      <div class="page-header">
        <h1 class="page-title">Provider Dashboard</h1>
        <p class="page-subtitle">Find jobs and grow your business.</p>
      </div>
      
      <!-- Bid Credits Info Card -->
      <div class="card" style="background:linear-gradient(135deg, var(--bg-card), var(--accent-gold-soft));border:1px solid var(--accent-gold);margin-bottom:24px;">
        <div style="display:flex;align-items:center;gap:20px;flex-wrap:wrap;">
          <div style="flex:1;min-width:200px;">
            <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px;">
              <span style="font-size:2rem;">üéüÔ∏è</span>
              <div>
                <div style="font-size:0.8rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.05em;">Your Bid Credits</div>
                <div style="font-size:1.8rem;font-weight:700;color:var(--accent-gold);" id="dashboard-bid-credits">0</div>
              </div>
            </div>
          </div>
          <div style="flex:2;min-width:280px;">
            <p style="font-size:0.9rem;color:var(--text-secondary);margin:0 0 8px 0;line-height:1.5;">
              <strong>How it works:</strong> Each bid costs 1 credit. Members see your bid and choose based on price, ratings, and reviews. Win jobs to grow your business!
            </p>
            <button class="btn btn-primary" onclick="showSection('subscription')" style="padding:10px 20px;font-size:0.9rem;">Buy More Credits ‚Üí</button>
          </div>
        </div>
      </div>

      <div class="stats-grid">
        <div class="stat-card" onclick="showSection('subscription')" style="cursor:pointer;border:2px solid var(--accent-gold);">
          <div class="stat-icon gold">üéüÔ∏è</div>
          <div class="stat-value" id="stat-credits">0</div>
          <div class="stat-label">Bid Credits</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon blue">üë•</div>
          <div class="stat-value" id="stat-members-nearby">0</div>
          <div class="stat-label">Members In Your Area</div>
        </div>
        <div class="stat-card"><div class="stat-icon gold">üì¶</div><div class="stat-value" id="stat-open">0</div><div class="stat-label">Open Packages</div></div>
        <div class="stat-card"><div class="stat-icon blue">üí¨</div><div class="stat-value" id="stat-bids">0</div><div class="stat-label">Pending Bids</div></div>
        <div class="stat-card"><div class="stat-icon green">‚úì</div><div class="stat-value" id="stat-won">0</div><div class="stat-label">Jobs Won</div></div>
        <div class="stat-card" onclick="showSection('reviews')" style="cursor:pointer;">
          <div class="stat-icon gold">‚≠ê</div>
          <div class="stat-value" id="stat-rating">--</div>
          <div class="stat-label">Your Rating <span id="stat-review-count" style="color:var(--text-muted);font-size:0.8rem;">(0 reviews)</span></div>
        </div>
      </div>
      <div class="card">
        <div class="card-header"><h2 class="card-title">Recent Opportunities</h2><button class="btn btn-ghost" onclick="showSection('browse')">View All ‚Üí</button></div>
        <div id="recent-packages"><div class="empty-state"><div class="empty-state-icon">üì¶</div><p>Loading packages...</p></div></div>
      </div>
    </section>

    <section id="browse" class="section">
      <div class="page-header"><h1 class="page-title">Browse Packages</h1><p class="page-subtitle">Find maintenance packages to bid on.</p></div>
      
      <!-- Credits Indicator for Browse -->
      <div id="browse-credits-bar" style="background:var(--bg-card);border:1px solid var(--border-subtle);border-radius:var(--radius-lg);padding:16px 20px;margin-bottom:20px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px;">
        <div style="display:flex;align-items:center;gap:12px;">
          <span style="font-size:1.5rem;">üéüÔ∏è</span>
          <div>
            <span style="font-size:0.85rem;color:var(--text-muted);">Your Bid Credits:</span>
            <span style="font-size:1.2rem;font-weight:700;color:var(--accent-gold);margin-left:8px;" id="browse-credits-count">0</span>
          </div>
        </div>
        <button class="btn btn-primary btn-sm" onclick="showSection('subscription')" style="padding:10px 18px;">üõí Buy More Credits</button>
      </div>

      <!-- Filter Bar -->
      <div class="filter-bar" style="display:flex;flex-wrap:wrap;gap:12px;margin-bottom:24px;padding:16px;background:var(--bg-card);border:1px solid var(--border-subtle);border-radius:var(--radius-lg);">
        <div class="filter-group" style="flex:1;min-width:150px;">
          <label style="font-size:0.8rem;color:var(--text-muted);display:block;margin-bottom:4px;">üìç Distance</label>
          <select class="form-input" id="filter-distance" onchange="applyFilters()" style="padding:10px 12px;">
            <option value="" selected>All Locations</option>
            <option value="10">Within 10 miles</option>
            <option value="25">Within 25 miles</option>
            <option value="50">Within 50 miles</option>
            <option value="100">Within 100 miles</option>
          </select>
        </div>
        <div class="filter-group" style="flex:1;min-width:150px;">
          <label style="font-size:0.8rem;color:var(--text-muted);display:block;margin-bottom:4px;">Category</label>
          <select class="form-input" id="filter-category" onchange="applyFilters()" style="padding:10px 12px;">
            <option value="">All Categories</option>
            <option value="maintenance">üîß Maintenance</option>
            <option value="detailing">‚ú® Detailing</option>
            <option value="cosmetic">üé® Cosmetic</option>
            <option value="accident_repair">üöó Accident Repair</option>
            <option value="other">üì¶ Other</option>
          </select>
        </div>
        <div class="filter-group" style="flex:1;min-width:150px;">
          <label style="font-size:0.8rem;color:var(--text-muted);display:block;margin-bottom:4px;">Urgency</label>
          <select class="form-input" id="filter-urgency" onchange="applyFilters()" style="padding:10px 12px;">
            <option value="">Any Deadline</option>
            <option value="urgent">‚ö° Under 24 hours</option>
            <option value="soon">‚è∞ Under 3 days</option>
            <option value="flexible">üìÖ More than 3 days</option>
          </select>
        </div>
        <div class="filter-group" style="flex:1;min-width:150px;">
          <label style="font-size:0.8rem;color:var(--text-muted);display:block;margin-bottom:4px;">Parts Preference</label>
          <select class="form-input" id="filter-parts" onchange="applyFilters()" style="padding:10px 12px;">
            <option value="">Any Parts</option>
            <option value="economy">üí∞ Economy</option>
            <option value="standard">‚öôÔ∏è Standard OEM</option>
            <option value="premium">‚≠ê Premium</option>
          </select>
        </div>
        <div class="filter-group" style="flex:1;min-width:150px;">
          <label style="font-size:0.8rem;color:var(--text-muted);display:block;margin-bottom:4px;">Sort By</label>
          <select class="form-input" id="filter-sort" onchange="applyFilters()" style="padding:10px 12px;">
            <option value="nearest">Nearest First</option>
            <option value="newest">Newest First</option>
            <option value="ending">Ending Soon</option>
            <option value="oldest">Oldest First</option>
          </select>
        </div>
        <div class="filter-group" style="display:flex;align-items:flex-end;">
          <button class="btn btn-secondary btn-sm" onclick="clearFilters()">Clear Filters</button>
        </div>
      </div>

      <div id="location-warning" style="display:none;background:var(--accent-orange-soft);border:1px solid rgba(245,158,11,0.3);color:var(--accent-orange);padding:14px 16px;border-radius:var(--radius-md);margin-bottom:16px;">
        ‚ö†Ô∏è <strong>Set your location</strong> to see packages in your service area. <a href="#" onclick="showSection('profile');return false;" style="color:inherit;text-decoration:underline;">Go to Business Profile ‚Üí</a>
      </div>

      <div id="filter-results-info" style="margin-bottom:16px;font-size:0.9rem;color:var(--text-muted);"></div>
      <div id="open-packages"><div class="empty-state"><div class="empty-state-icon">üì¶</div><p>No open packages.</p></div></div>
    </section>

    <section id="bids" class="section">
      <div class="page-header"><h1 class="page-title">My Bids</h1><p class="page-subtitle">Track your submitted bids.</p></div>
      <div id="my-bids"><div class="empty-state"><div class="empty-state-icon">üí¨</div><p>No bids yet.</p></div></div>
    </section>

    <section id="jobs" class="section">
      <div class="page-header"><h1 class="page-title">Active Jobs</h1><p class="page-subtitle">Packages where your bid was accepted.</p></div>
      <div id="active-jobs"><div class="empty-state"><div class="empty-state-icon">‚úì</div><p>No active jobs.</p></div></div>
    </section>

    <section id="earnings" class="section">
      <div class="page-header"><h1 class="page-title">Earnings</h1><p class="page-subtitle">Track your income and payments.</p></div>
      <div class="stats-grid" style="margin-bottom:24px;">
        <div class="stat-card"><div class="stat-value" id="earnings-pending">$0</div><div class="stat-label">Pending (In Escrow)</div></div>
        <div class="stat-card"><div class="stat-value" id="earnings-released">$0</div><div class="stat-label">Released (30 days)</div></div>
        <div class="stat-card"><div class="stat-value" id="earnings-total">$0</div><div class="stat-label">Total Earnings</div></div>
      </div>
      <div class="card">
        <div class="card-header"><h2 class="card-title">Payment History</h2></div>
        <div id="earnings-list"><div class="empty-state"><div class="empty-state-icon">üí∞</div><p>No payments yet. Complete jobs to see your earnings!</p></div></div>
      </div>
      <div class="alert" style="background:var(--accent-blue-soft);border:1px solid rgba(74,124,255,0.3);color:var(--accent-blue);margin-top:16px;padding:16px;border-radius:var(--radius-md);">
        üí° <strong>How payments work:</strong> When a member accepts your bid, payment is held in escrow. Once the job is complete and the member confirms, the payment is released to you (minus the 2% MCC fee). Payments are processed within 3-5 business days.
      </div>
    </section>

    <!-- Reviews Section -->
    <section id="reviews" class="section">
      <div class="page-header">
        <h1 class="page-title">My Reviews</h1>
        <p class="page-subtitle">See what members are saying about your work.</p>
      </div>

      <!-- Suspension Alert -->
      <div id="suspension-alert" style="display:none;margin-bottom:24px;padding:20px;background:rgba(239,95,95,0.15);border:1px solid rgba(239,95,95,0.4);border-radius:var(--radius-lg);">
        <div style="display:flex;align-items:flex-start;gap:16px;">
          <div style="font-size:2rem;">‚ö†Ô∏è</div>
          <div style="flex:1;">
            <h3 style="color:var(--accent-red);margin-bottom:8px;">Account Suspended</h3>
            <p style="color:var(--text-secondary);margin-bottom:12px;" id="suspension-reason">Your average rating has dropped below 4 stars. You cannot place new bids until this is resolved.</p>
            <div style="font-size:0.9rem;color:var(--text-muted);margin-bottom:16px;">
              <span id="suspension-date"></span>
            </div>
            <div id="refund-info" style="display:none;padding:12px 16px;background:var(--bg-input);border-radius:var(--radius-md);margin-bottom:12px;">
              <div style="font-size:0.9rem;color:var(--text-secondary);">
                <strong>Bid Credits Refunded:</strong> <span id="refunded-credits">0</span> credits
              </div>
            </div>
            <p style="font-size:0.9rem;color:var(--text-muted);">Please contact support at <a href="mailto:support@mycarconcierge.co" style="color:var(--accent-blue);">support@mycarconcierge.co</a> to discuss next steps.</p>
          </div>
        </div>
      </div>

      <!-- Rating Warning (close to suspension) -->
      <div id="rating-warning" style="display:none;margin-bottom:24px;padding:16px;background:var(--accent-orange-soft);border:1px solid rgba(245,158,11,0.4);border-radius:var(--radius-lg);">
        <div style="display:flex;align-items:center;gap:12px;">
          <span style="font-size:1.5rem;">‚ö°</span>
          <div>
            <strong style="color:var(--accent-orange);">Rating Warning</strong>
            <p style="color:var(--text-secondary);font-size:0.9rem;margin:4px 0 0;">Your rating is approaching the 4-star minimum. If it drops below 4 stars with 3+ reviews, your account will be suspended and bid credits refunded.</p>
          </div>
        </div>
      </div>

      <div class="stats-grid" style="margin-bottom:24px;">
        <div class="stat-card">
          <div class="stat-value" id="reviews-avg-rating" style="color:var(--accent-gold);">--</div>
          <div class="stat-label">Average Rating</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="reviews-total-count">0</div>
          <div class="stat-label">Total Reviews</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="reviews-5-star">0%</div>
          <div class="stat-label">5-Star Rate</div>
        </div>
      </div>

      <!-- Rating breakdown -->
      <div class="card" style="margin-bottom:24px;">
        <div class="card-header"><h2 class="card-title">Rating Breakdown</h2></div>
        <div id="rating-breakdown" style="display:grid;grid-template-columns:repeat(4,1fr);gap:16px;text-align:center;">
          <div>
            <div style="font-weight:600;margin-bottom:4px;" id="breakdown-quality">--</div>
            <div style="font-size:0.85rem;color:var(--text-muted);">Quality</div>
          </div>
          <div>
            <div style="font-weight:600;margin-bottom:4px;" id="breakdown-communication">--</div>
            <div style="font-size:0.85rem;color:var(--text-muted);">Communication</div>
          </div>
          <div>
            <div style="font-weight:600;margin-bottom:4px;" id="breakdown-timeliness">--</div>
            <div style="font-size:0.85rem;color:var(--text-muted);">Timeliness</div>
          </div>
          <div>
            <div style="font-weight:600;margin-bottom:4px;" id="breakdown-value">--</div>
            <div style="font-size:0.85rem;color:var(--text-muted);">Value</div>
          </div>
        </div>
      </div>

      <!-- Reviews list -->
      <div class="card">
        <div class="card-header"><h2 class="card-title">Recent Reviews</h2></div>
        <div id="reviews-list">
          <div class="empty-state">
            <div class="empty-state-icon">‚≠ê</div>
            <p>No reviews yet. Complete jobs to receive reviews!</p>
          </div>
        </div>
      </div>
    </section>

    <!-- Performance Section -->
    <section id="performance" class="section">
      <div class="page-header">
        <h1 class="page-title">üìà Performance Dashboard</h1>
        <p class="page-subtitle">Track your performance metrics and earn badges to stand out.</p>
      </div>

      <div style="display:grid;grid-template-columns:1fr 2fr;gap:24px;margin-bottom:24px;" class="performance-hero">
        <div class="card" style="display:flex;flex-direction:column;align-items:center;justify-content:center;padding:32px;">
          <div class="performance-score-display" id="perf-score-display">
            <div class="performance-score-value" id="perf-overall-score">--</div>
            <div class="performance-score-label">Overall Score</div>
          </div>
          <div style="margin-top:20px;">
            <div class="performance-tier-badge bronze" id="perf-tier-badge">
              <span>ü•â</span>
              <span id="perf-tier-text">Bronze</span>
            </div>
          </div>
          <button class="btn btn-ghost btn-sm" onclick="refreshPerformance()" style="margin-top:16px;">‚Üª Refresh</button>
        </div>

        <div class="card">
          <div class="card-header">
            <h2 class="card-title">Performance Metrics</h2>
          </div>
          <div class="performance-metrics-grid">
            <div class="performance-metric-card">
              <div class="performance-metric-icon">‚≠ê</div>
              <div class="performance-metric-value" id="perf-rating">--</div>
              <div class="performance-metric-label">Average Rating</div>
              <div class="stars-display" id="perf-stars"></div>
            </div>
            <div class="performance-metric-card">
              <div class="performance-metric-icon">‚úÖ</div>
              <div class="performance-metric-value" id="perf-jobs-completed">0</div>
              <div class="performance-metric-label">Jobs Completed</div>
            </div>
            <div class="performance-metric-card">
              <div class="performance-metric-icon">‚è±Ô∏è</div>
              <div class="performance-metric-value" id="perf-on-time">--</div>
              <div class="performance-metric-label">On-Time Rate</div>
            </div>
            <div class="performance-metric-card">
              <div class="performance-metric-icon">‚ö°</div>
              <div class="performance-metric-value" id="perf-response-time">--</div>
              <div class="performance-metric-label">Avg Response Time</div>
            </div>
            <div class="performance-metric-card">
              <div class="performance-metric-icon">üéØ</div>
              <div class="performance-metric-value" id="perf-acceptance-rate">--</div>
              <div class="performance-metric-label">Bid Acceptance Rate</div>
            </div>
            <div class="performance-metric-card">
              <div class="performance-metric-icon">üìä</div>
              <div class="performance-metric-value" id="perf-bids-submitted">0</div>
              <div class="performance-metric-label">Bids Submitted</div>
            </div>
          </div>
        </div>
      </div>

      <style>
        @media (max-width: 900px) {
          .performance-hero { grid-template-columns: 1fr !important; }
        }
      </style>

      <div class="card" style="margin-bottom:24px;">
        <div class="card-header">
          <h2 class="card-title">üèÖ Earned Badges</h2>
          <p style="font-size:0.85rem;color:var(--text-muted);margin-top:4px;">Unlock badges to boost your visibility to members</p>
        </div>
        <div class="performance-badges-grid" id="perf-badges-grid">
          <div class="performance-badge locked" data-badge="top_rated">
            <span class="performance-badge-icon">üèÜ</span>
            <span>Top Rated</span>
          </div>
          <div class="performance-badge locked" data-badge="quick_responder">
            <span class="performance-badge-icon">‚ö°</span>
            <span>Quick Responder</span>
          </div>
          <div class="performance-badge locked" data-badge="veteran">
            <span class="performance-badge-icon">üéñÔ∏è</span>
            <span>Veteran</span>
          </div>
          <div class="performance-badge locked" data-badge="perfect_score">
            <span class="performance-badge-icon">‚≠ê</span>
            <span>Perfect Score</span>
          </div>
          <div class="performance-badge locked" data-badge="dispute_free">
            <span class="performance-badge-icon">üõ°Ô∏è</span>
            <span>Dispute-Free</span>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h2 class="card-title">üí° Performance Tips</h2>
        </div>
        <div id="perf-tips">
          <div class="performance-tip">
            <span class="performance-tip-icon">üìä</span>
            <div class="performance-tip-text">Loading performance insights...</div>
          </div>
        </div>
      </div>

      <div class="alert" style="background:var(--accent-gold-soft);border:1px solid rgba(212,168,85,0.3);color:var(--text-secondary);margin-top:24px;padding:16px;border-radius:var(--radius-md);">
        <strong style="color:var(--accent-gold);">üèÜ How Tiers Work:</strong>
        <div style="margin-top:8px;display:grid;grid-template-columns:repeat(auto-fit, minmax(140px, 1fr));gap:12px;font-size:0.9rem;">
          <div><span style="color:#e5e4e2;">‚¨• Platinum:</span> 90+ score</div>
          <div><span style="color:var(--accent-gold);">‚¨• Gold:</span> 75-89 score</div>
          <div><span style="color:#c0c0c0;">‚¨• Silver:</span> 50-74 score</div>
          <div><span style="color:#cd7f32;">‚¨• Bronze:</span> 0-49 score</div>
        </div>
      </div>
    </section>

    <section id="messages" class="section">
      <div class="page-header"><h1 class="page-title">Messages</h1><p class="page-subtitle">Conversations with members.</p></div>
      <div id="conversations"><div class="empty-state"><div class="empty-state-icon">üí¨</div><p>No conversations yet.</p></div></div>
    </section>

    <!-- Notifications Section -->
    <section id="notifications" class="section">
      <div class="page-header">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div>
            <h1 class="page-title">Notifications</h1>
            <p class="page-subtitle">Stay updated on bids and jobs.</p>
          </div>
          <button class="btn btn-secondary" onclick="markAllNotificationsRead()">Mark All Read</button>
        </div>
      </div>
      <div id="notifications-list">
        <div class="empty-state"><div class="empty-state-icon">üîî</div><p>No notifications yet.</p></div>
      </div>
    </section>

    <!-- Bid Credits Section -->
    <section id="subscription" class="section">
      <div class="page-header">
        <h1 class="page-title">üéüÔ∏è Bid Credits</h1>
        <p class="page-subtitle">Purchase credits to bid on service packages.</p>
      </div>

      <!-- Quick Checkout Banner -->
      <div id="quick-checkout-banner" style="background:linear-gradient(135deg, var(--accent-gold), #c49a45);border-radius:var(--radius-lg);padding:20px 24px;margin-bottom:24px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:16px;">
        <div style="display:flex;align-items:center;gap:16px;">
          <span style="font-size:2.5rem;">üõí</span>
          <div>
            <div style="font-size:1.2rem;font-weight:700;color:#0a0a0f;">Ready to buy credits?</div>
            <div style="font-size:0.9rem;color:rgba(10,10,15,0.7);">Skip to checkout and choose your bid pack below</div>
          </div>
        </div>
        <button class="btn" onclick="document.getElementById('bid-packs-grid').scrollIntoView({behavior:'smooth',block:'center'})" style="background:#0a0a0f;color:var(--accent-gold);padding:14px 28px;font-size:1rem;font-weight:600;">
          View Bid Packs ‚Üì
        </button>
      </div>

      <!-- Current Balance -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">Your Balance</h2>
        </div>
        <div style="display:flex;align-items:center;gap:24px;flex-wrap:wrap;">
          <div style="text-align:center;padding:20px 32px;background:var(--accent-gold-soft);border-radius:var(--radius-lg);border:1px solid rgba(212,168,85,0.3);">
            <div style="font-size:3rem;font-weight:700;color:var(--accent-gold);" id="credits-balance">0</div>
            <div style="font-size:0.9rem;color:var(--text-secondary);">Bid Credits</div>
          </div>
          <div style="flex:1;min-width:200px;">
            <div style="display:grid;gap:8px;">
              <div style="display:flex;justify-content:space-between;">
                <span style="color:var(--text-muted);">Free Trial Bids</span>
                <span style="font-weight:500;" id="free-bids-remaining">0</span>
              </div>
              <div style="display:flex;justify-content:space-between;">
                <span style="color:var(--text-muted);">Total Purchased</span>
                <span style="font-weight:500;" id="total-purchased">0</span>
              </div>
              <div style="display:flex;justify-content:space-between;">
                <span style="color:var(--text-muted);">Total Used</span>
                <span style="font-weight:500;" id="total-used">0</span>
              </div>
            </div>
          </div>
        </div>
        <div id="low-credits-warning" style="display:none;margin-top:16px;padding:14px;background:var(--accent-orange-soft);border:1px solid rgba(245,158,11,0.3);border-radius:var(--radius-md);display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px;">
          <span style="color:var(--accent-orange);">‚ö†Ô∏è <strong>Low on credits!</strong> Purchase more to keep bidding on packages.</span>
          <button class="btn btn-sm" onclick="document.getElementById('bid-packs-grid').scrollIntoView({behavior:'smooth',block:'center'})" style="background:var(--accent-orange);color:#0a0a0f;font-weight:600;">Buy Now ‚Üí</button>
        </div>
        <div id="no-credits-warning" style="display:none;margin-top:16px;padding:14px;background:var(--accent-red-soft);border:1px solid rgba(239,95,95,0.3);border-radius:var(--radius-md);display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px;">
          <span style="color:var(--accent-red);">üö´ <strong>No credits remaining.</strong> Purchase a bid pack to continue bidding.</span>
          <button class="btn btn-sm" onclick="document.getElementById('bid-packs-grid').scrollIntoView({behavior:'smooth',block:'center'})" style="background:var(--accent-red);color:#fff;font-weight:600;">Buy Credits ‚Üí</button>
        </div>
      </div>

      <!-- Bid Packs -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">Buy Bid Packs</h2>
          <span style="color:var(--text-muted);font-size:0.9rem;">Volume discounts available!</span>
        </div>

        <div id="bid-packs-grid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px;">
          <!-- Packs loaded dynamically -->
          <div class="empty-state"><p>Loading bid packs...</p></div>
        </div>
      </div>

      <!-- How It Works -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">üí° How Bid Credits Work</h2>
        </div>
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;">
          <div style="text-align:center;padding:16px;">
            <div style="font-size:2rem;margin-bottom:8px;">üéüÔ∏è</div>
            <div style="font-weight:600;margin-bottom:4px;">1 Credit = 1 Bid</div>
            <div style="font-size:0.85rem;color:var(--text-muted);">Each bid on a package uses one credit</div>
          </div>
          <div style="text-align:center;padding:16px;">
            <div style="font-size:2rem;margin-bottom:8px;">üí∞</div>
            <div style="font-weight:600;margin-bottom:4px;">Buy More, Save More</div>
            <div style="font-size:0.85rem;color:var(--text-muted);">Larger packs have better per-bid rates</div>
          </div>
          <div style="text-align:center;padding:16px;">
            <div style="font-size:2rem;margin-bottom:8px;">‚ôæÔ∏è</div>
            <div style="font-weight:600;margin-bottom:4px;">Never Expire</div>
            <div style="font-size:0.85rem;color:var(--text-muted);">Your credits stay until you use them</div>
          </div>
          <div style="text-align:center;padding:16px;">
            <div style="font-size:2rem;margin-bottom:8px;">üéÅ</div>
            <div style="font-weight:600;margin-bottom:4px;">Bonus Credits</div>
            <div style="font-size:0.85rem;color:var(--text-muted);">Get extra free bids on larger packs</div>
          </div>
        </div>
      </div>

      <!-- Purchase History -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">Purchase History</h2>
        </div>
        <div id="purchase-history">
          <p style="color:var(--text-muted);">No purchases yet.</p>
        </div>
      </div>
    </section>

    <!-- Business Profile Section -->
    <section id="profile" class="section">
      <div class="page-header">
        <h1 class="page-title">Business Profile</h1>
        <p class="page-subtitle">Set up your profile to attract more customers.</p>
      </div>

      <div class="card">
        <div class="card-header">
          <h2 class="card-title">Profile Completion</h2>
        </div>
        <div style="margin-bottom:20px;">
          <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
            <span style="font-size:0.9rem;">Profile strength</span>
            <span style="font-size:0.9rem;font-weight:600;" id="profile-completion-pct">0%</span>
          </div>
          <div style="height:8px;background:var(--bg-input);border-radius:4px;overflow:hidden;">
            <div id="profile-completion-bar" style="height:100%;width:0%;background:linear-gradient(90deg,var(--accent-gold),#c49a45);transition:width 0.3s;"></div>
          </div>
          <p style="font-size:0.82rem;color:var(--text-muted);margin-top:8px;">Complete your profile to appear higher in search results and build trust with members.</p>
        </div>
      </div>

      <!-- Verification Status Card -->
      <div class="card" id="verification-status-card">
        <div class="card-header">
          <h2 class="card-title">üõ°Ô∏è Verification Status</h2>
        </div>
        <div id="verified-badge-container" style="display:none;margin-bottom:20px;padding:16px;background:linear-gradient(135deg, rgba(74,200,140,0.15), rgba(212,168,85,0.15));border:2px solid var(--accent-gold);border-radius:var(--radius-lg);text-align:center;">
          <div style="font-size:2rem;margin-bottom:8px;">üèÜ</div>
          <div style="font-size:1.1rem;font-weight:600;color:var(--accent-gold);">Concierge Verified Provider</div>
          <p style="font-size:0.85rem;color:var(--text-secondary);margin-top:6px;">Your business credentials have been verified by My Car Concierge</p>
        </div>
        <div id="verification-checklist" style="display:grid;gap:12px;">
          <div class="verification-item" id="verify-license" style="display:flex;align-items:center;gap:12px;padding:14px 16px;background:var(--bg-elevated);border:1px solid var(--border-subtle);border-radius:var(--radius-md);">
            <span class="verify-status" style="font-size:1.2rem;">‚è≥</span>
            <div style="flex:1;">
              <div style="font-weight:500;">Business License</div>
              <div style="font-size:0.82rem;color:var(--text-muted);">Upload your business license for verification</div>
            </div>
            <span class="verify-badge" style="padding:4px 10px;border-radius:100px;font-size:0.75rem;font-weight:500;background:var(--accent-gold-soft);color:var(--accent-gold);">Pending</span>
          </div>
          <div class="verification-item" id="verify-insurance" style="display:flex;align-items:center;gap:12px;padding:14px 16px;background:var(--bg-elevated);border:1px solid var(--border-subtle);border-radius:var(--radius-md);">
            <span class="verify-status" style="font-size:1.2rem;">‚è≥</span>
            <div style="flex:1;">
              <div style="font-weight:500;">Insurance Certificate</div>
              <div style="font-size:0.82rem;color:var(--text-muted);">Proof of liability insurance coverage</div>
            </div>
            <span class="verify-badge" style="padding:4px 10px;border-radius:100px;font-size:0.75rem;font-weight:500;background:var(--accent-gold-soft);color:var(--accent-gold);">Pending</span>
          </div>
          <div class="verification-item" id="verify-certifications" style="display:flex;align-items:center;gap:12px;padding:14px 16px;background:var(--bg-elevated);border:1px solid var(--border-subtle);border-radius:var(--radius-md);">
            <span class="verify-status" style="font-size:1.2rem;">‚è≥</span>
            <div style="flex:1;">
              <div style="font-weight:500;">Certifications</div>
              <div style="font-size:0.82rem;color:var(--text-muted);">ASE, I-CAR, or other professional certifications</div>
            </div>
            <span class="verify-badge" style="padding:4px 10px;border-radius:100px;font-size:0.75rem;font-weight:500;background:var(--accent-gold-soft);color:var(--accent-gold);">Pending</span>
          </div>
        </div>
        <p style="font-size:0.82rem;color:var(--text-muted);margin-top:16px;">üìã Upload documents below. Our team will review and verify within 1-2 business days.</p>
      </div>

      <!-- Verification Documents Upload -->
      <div class="card" id="verification-docs-card">
        <div class="card-header">
          <h2 class="card-title">üìÑ Verification Documents</h2>
        </div>
        <p style="color:var(--text-secondary);margin-bottom:20px;font-size:0.9rem;">Upload documents to get verified and earn the Concierge Verified badge. Accepted formats: PDF, JPG, PNG.</p>
        
        <div style="display:grid;gap:16px;">
          <!-- Business License Upload -->
          <div class="doc-upload-item" style="padding:20px;background:var(--bg-elevated);border:1px solid var(--border-subtle);border-radius:var(--radius-md);">
            <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:16px;flex-wrap:wrap;">
              <div style="flex:1;min-width:200px;">
                <div style="font-weight:600;margin-bottom:4px;">üìú Business License</div>
                <div style="font-size:0.85rem;color:var(--text-muted);">Your official business or trade license</div>
                <div id="license-upload-status" style="margin-top:8px;font-size:0.85rem;"></div>
              </div>
              <div style="display:flex;gap:8px;align-items:center;">
                <input type="file" id="license-file-input" accept=".pdf,.jpg,.jpeg,.png" style="display:none;" onchange="uploadVerificationDoc('license')">
                <button class="btn btn-secondary btn-sm" onclick="document.getElementById('license-file-input').click()">
                  üì§ Upload
                </button>
                <a id="license-view-btn" href="#" target="_blank" class="btn btn-ghost btn-sm" style="display:none;">View</a>
              </div>
            </div>
          </div>

          <!-- Insurance Certificate Upload -->
          <div class="doc-upload-item" style="padding:20px;background:var(--bg-elevated);border:1px solid var(--border-subtle);border-radius:var(--radius-md);">
            <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:16px;flex-wrap:wrap;">
              <div style="flex:1;min-width:200px;">
                <div style="font-weight:600;margin-bottom:4px;">üõ°Ô∏è Insurance Certificate</div>
                <div style="font-size:0.85rem;color:var(--text-muted);">Proof of liability insurance coverage</div>
                <div id="insurance-upload-status" style="margin-top:8px;font-size:0.85rem;"></div>
              </div>
              <div style="display:flex;gap:8px;align-items:center;">
                <input type="file" id="insurance-file-input" accept=".pdf,.jpg,.jpeg,.png" style="display:none;" onchange="uploadVerificationDoc('insurance')">
                <button class="btn btn-secondary btn-sm" onclick="document.getElementById('insurance-file-input').click()">
                  üì§ Upload
                </button>
                <a id="insurance-view-btn" href="#" target="_blank" class="btn btn-ghost btn-sm" style="display:none;">View</a>
              </div>
            </div>
          </div>

          <!-- Certifications Upload -->
          <div class="doc-upload-item" style="padding:20px;background:var(--bg-elevated);border:1px solid var(--border-subtle);border-radius:var(--radius-md);">
            <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:16px;flex-wrap:wrap;">
              <div style="flex:1;min-width:200px;">
                <div style="font-weight:600;margin-bottom:4px;">üèÖ Certifications</div>
                <div style="font-size:0.85rem;color:var(--text-muted);">ASE, I-CAR, manufacturer, or other professional certifications</div>
                <div id="certifications-upload-status" style="margin-top:8px;font-size:0.85rem;"></div>
              </div>
              <div style="display:flex;gap:8px;align-items:center;">
                <input type="file" id="certifications-file-input" accept=".pdf,.jpg,.jpeg,.png" style="display:none;" onchange="uploadVerificationDoc('certifications')">
                <button class="btn btn-secondary btn-sm" onclick="document.getElementById('certifications-file-input').click()">
                  üì§ Upload
                </button>
                <a id="certifications-view-btn" href="#" target="_blank" class="btn btn-ghost btn-sm" style="display:none;">View</a>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h2 class="card-title">Business Information</h2>
        </div>
        
        <div class="form-group">
          <label class="form-label">Business Name *</label>
          <input type="text" class="form-input" id="profile-business-name" placeholder="e.g., Mike's Auto Service">
          <div class="form-hint">This is how members will see your business</div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Your Name</label>
            <input type="text" class="form-input" id="profile-full-name" placeholder="e.g., Mike Johnson">
          </div>
          <div class="form-group">
            <label class="form-label">Business Phone</label>
            <input type="tel" class="form-input" id="profile-phone" placeholder="(555) 123-4567">
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Business Address</label>
          <input type="text" class="form-input" id="profile-address" placeholder="123 Main St, City, State ZIP">
          <div class="form-hint">Members may need this for drop-off</div>
        </div>

        <div class="form-group">
          <label class="form-label">Years in Business</label>
          <select class="form-input" id="profile-years" style="cursor:pointer;">
            <option value="">Select...</option>
            <option value="1">Less than 1 year</option>
            <option value="2">1-2 years</option>
            <option value="5">3-5 years</option>
            <option value="10">6-10 years</option>
            <option value="15">11-15 years</option>
            <option value="20">16-20 years</option>
            <option value="25">20+ years</option>
          </select>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h2 class="card-title">Services Offered</h2>
        </div>
        <p style="color:var(--text-secondary);margin-bottom:16px;font-size:0.9rem;">Select all services your shop provides:</p>
        
        <div class="services-grid" id="services-grid">
          <label class="service-checkbox"><input type="checkbox" value="Oil Change"> Oil Change</label>
          <label class="service-checkbox"><input type="checkbox" value="Brake Service"> Brake Service</label>
          <label class="service-checkbox"><input type="checkbox" value="Tire Service"> Tire Service</label>
          <label class="service-checkbox"><input type="checkbox" value="Engine Repair"> Engine Repair</label>
          <label class="service-checkbox"><input type="checkbox" value="Transmission"> Transmission</label>
          <label class="service-checkbox"><input type="checkbox" value="AC/Heating"> AC/Heating</label>
          <label class="service-checkbox"><input type="checkbox" value="Electrical"> Electrical</label>
          <label class="service-checkbox"><input type="checkbox" value="Suspension"> Suspension</label>
          <label class="service-checkbox"><input type="checkbox" value="Exhaust"> Exhaust</label>
          <label class="service-checkbox"><input type="checkbox" value="Diagnostics"> Diagnostics</label>
          <label class="service-checkbox"><input type="checkbox" value="State Inspection"> State Inspection</label>
          <label class="service-checkbox"><input type="checkbox" value="Emissions"> Emissions</label>
          <label class="service-checkbox"><input type="checkbox" value="Detailing"> Detailing</label>
          <label class="service-checkbox"><input type="checkbox" value="Body Work"> Body Work</label>
          <label class="service-checkbox"><input type="checkbox" value="Paint"> Paint</label>
          <label class="service-checkbox"><input type="checkbox" value="Glass Repair"> Glass Repair</label>
          <label class="service-checkbox"><input type="checkbox" value="Towing"> Towing</label>
          <label class="service-checkbox"><input type="checkbox" value="Mobile Service"> Mobile Service</label>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h2 class="card-title">Certifications</h2>
        </div>
        <p style="color:var(--text-secondary);margin-bottom:16px;font-size:0.9rem;">Add your certifications to build trust:</p>
        
        <div class="services-grid" id="certifications-grid">
          <label class="service-checkbox"><input type="checkbox" value="ASE Certified"> ASE Certified</label>
          <label class="service-checkbox"><input type="checkbox" value="ASE Master Technician"> ASE Master Technician</label>
          <label class="service-checkbox"><input type="checkbox" value="Manufacturer Certified"> Manufacturer Certified</label>
          <label class="service-checkbox"><input type="checkbox" value="I-CAR Certified"> I-CAR Certified</label>
          <label class="service-checkbox"><input type="checkbox" value="EPA Certified"> EPA Certified</label>
          <label class="service-checkbox"><input type="checkbox" value="AAA Approved"> AAA Approved</label>
          <label class="service-checkbox"><input type="checkbox" value="BBB Accredited"> BBB Accredited</label>
        </div>

        <div class="form-group" style="margin-top:16px;">
          <label class="form-label">Other Certifications</label>
          <input type="text" class="form-input" id="profile-other-certs" placeholder="e.g., Tesla Certified, BMW Specialist">
          <div class="form-hint">Separate multiple certifications with commas</div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h2 class="card-title">Service Areas</h2>
        </div>
        <div class="form-group">
          <label class="form-label">ZIP Codes You Serve</label>
          <input type="text" class="form-input" id="profile-zip-codes" placeholder="e.g., 07003, 07004, 07006">
          <div class="form-hint">Enter ZIP codes separated by commas. Leave blank to serve all areas.</div>
        </div>
        
        <div class="form-group">
          <label class="form-label">Service Radius (miles)</label>
          <select class="form-input" id="profile-radius" style="cursor:pointer;">
            <option value="5">5 miles</option>
            <option value="10">10 miles</option>
            <option value="15" selected>15 miles</option>
            <option value="25">25 miles</option>
            <option value="50">50 miles</option>
            <option value="100">No limit</option>
          </select>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h2 class="card-title">About Your Business</h2>
        </div>
        <div class="form-group">
          <label class="form-label">Description</label>
          <textarea class="form-textarea" id="profile-description" placeholder="Tell members about your shop, your experience, specialties, what sets you apart..." style="min-height:120px;"></textarea>
          <div class="form-hint">A good description helps you win more bids</div>
        </div>
      </div>

      <!-- Availability Calendar -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">üìÖ Availability</h2>
          <p style="font-size:0.9rem;color:var(--text-secondary);margin-top:4px;">Set your regular hours and block off dates when you're unavailable.</p>
        </div>
        
        <div style="margin-bottom:24px;">
          <label class="form-label" style="margin-bottom:12px;">Regular Business Hours</label>
          <div id="weekly-hours" style="display:grid;gap:8px;">
            <div class="hour-row" style="display:grid;grid-template-columns:100px 1fr 80px auto;gap:10px;align-items:center;">
              <span style="font-weight:500;">Monday</span>
              <div style="display:flex;gap:8px;align-items:center;">
                <select class="form-input time-select" id="hours-mon-start" style="padding:8px;min-width:110px;"></select>
                <span>to</span>
                <select class="form-input time-select" id="hours-mon-end" style="padding:8px;min-width:110px;"></select>
              </div>
              <label style="display:flex;align-items:center;gap:6px;cursor:pointer;"><input type="checkbox" id="hours-mon-open" checked> Open</label>
            </div>
            <div class="hour-row" style="display:grid;grid-template-columns:100px 1fr 80px auto;gap:10px;align-items:center;">
              <span style="font-weight:500;">Tuesday</span>
              <div style="display:flex;gap:8px;align-items:center;">
                <select class="form-input time-select" id="hours-tue-start" style="padding:8px;min-width:110px;"></select>
                <span>to</span>
                <select class="form-input time-select" id="hours-tue-end" style="padding:8px;min-width:110px;"></select>
              </div>
              <label style="display:flex;align-items:center;gap:6px;cursor:pointer;"><input type="checkbox" id="hours-tue-open" checked> Open</label>
            </div>
            <div class="hour-row" style="display:grid;grid-template-columns:100px 1fr 80px auto;gap:10px;align-items:center;">
              <span style="font-weight:500;">Wednesday</span>
              <div style="display:flex;gap:8px;align-items:center;">
                <select class="form-input time-select" id="hours-wed-start" style="padding:8px;min-width:110px;"></select>
                <span>to</span>
                <select class="form-input time-select" id="hours-wed-end" style="padding:8px;min-width:110px;"></select>
              </div>
              <label style="display:flex;align-items:center;gap:6px;cursor:pointer;"><input type="checkbox" id="hours-wed-open" checked> Open</label>
            </div>
            <div class="hour-row" style="display:grid;grid-template-columns:100px 1fr 80px auto;gap:10px;align-items:center;">
              <span style="font-weight:500;">Thursday</span>
              <div style="display:flex;gap:8px;align-items:center;">
                <select class="form-input time-select" id="hours-thu-start" style="padding:8px;min-width:110px;"></select>
                <span>to</span>
                <select class="form-input time-select" id="hours-thu-end" style="padding:8px;min-width:110px;"></select>
              </div>
              <label style="display:flex;align-items:center;gap:6px;cursor:pointer;"><input type="checkbox" id="hours-thu-open" checked> Open</label>
            </div>
            <div class="hour-row" style="display:grid;grid-template-columns:100px 1fr 80px auto;gap:10px;align-items:center;">
              <span style="font-weight:500;">Friday</span>
              <div style="display:flex;gap:8px;align-items:center;">
                <select class="form-input time-select" id="hours-fri-start" style="padding:8px;min-width:110px;"></select>
                <span>to</span>
                <select class="form-input time-select" id="hours-fri-end" style="padding:8px;min-width:110px;"></select>
              </div>
              <label style="display:flex;align-items:center;gap:6px;cursor:pointer;"><input type="checkbox" id="hours-fri-open" checked> Open</label>
            </div>
            <div class="hour-row" style="display:grid;grid-template-columns:100px 1fr 80px auto;gap:10px;align-items:center;">
              <span style="font-weight:500;">Saturday</span>
              <div style="display:flex;gap:8px;align-items:center;">
                <select class="form-input time-select" id="hours-sat-start" style="padding:8px;min-width:110px;"></select>
                <span>to</span>
                <select class="form-input time-select" id="hours-sat-end" style="padding:8px;min-width:110px;"></select>
              </div>
              <label style="display:flex;align-items:center;gap:6px;cursor:pointer;"><input type="checkbox" id="hours-sat-open" checked> Open</label>
            </div>
            <div class="hour-row" style="display:grid;grid-template-columns:100px 1fr 80px auto;gap:10px;align-items:center;">
              <span style="font-weight:500;">Sunday</span>
              <div style="display:flex;gap:8px;align-items:center;">
                <select class="form-input time-select" id="hours-sun-start" style="padding:8px;min-width:110px;"></select>
                <span>to</span>
                <select class="form-input time-select" id="hours-sun-end" style="padding:8px;min-width:110px;"></select>
              </div>
              <label style="display:flex;align-items:center;gap:6px;cursor:pointer;"><input type="checkbox" id="hours-sun-open"> Open</label>
            </div>
          </div>
        </div>

        <div style="border-top:1px solid var(--border-subtle);padding-top:20px;">
          <label class="form-label" style="margin-bottom:12px;">Block Off Dates</label>
          <p class="form-hint" style="margin-bottom:12px;">Mark specific dates when you're unavailable (vacation, holidays, etc.)</p>
          <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:flex-end;">
            <div class="form-group" style="margin-bottom:0;">
              <label class="form-label" style="font-size:0.8rem;">Start Date</label>
              <input type="date" class="form-input" id="block-start" style="padding:8px;">
            </div>
            <div class="form-group" style="margin-bottom:0;">
              <label class="form-label" style="font-size:0.8rem;">End Date</label>
              <input type="date" class="form-input" id="block-end" style="padding:8px;">
            </div>
            <div class="form-group" style="margin-bottom:0;">
              <label class="form-label" style="font-size:0.8rem;">Reason (optional)</label>
              <input type="text" class="form-input" id="block-reason" placeholder="e.g., Vacation" style="padding:8px;">
            </div>
            <button class="btn btn-secondary" onclick="addBlockedDate()">+ Add</button>
          </div>
          <div id="blocked-dates-list" style="margin-top:16px;"></div>
        </div>
      </div>

      <!-- Emergency Services Settings -->
      <div class="card" style="border:1px solid rgba(239, 95, 95, 0.3);background:linear-gradient(135deg, var(--bg-card), rgba(239, 95, 95, 0.05));">
        <div class="card-header">
          <h2 class="card-title">üö® Emergency Services</h2>
        </div>
        <p style="color:var(--text-secondary);margin-bottom:20px;font-size:0.9rem;">Accept emergency roadside assistance requests from members in need.</p>
        
        <div class="form-group">
          <label style="display:flex;align-items:center;gap:12px;cursor:pointer;padding:16px;background:var(--bg-elevated);border-radius:var(--radius-md);">
            <input type="checkbox" id="emergency-accept-calls" style="width:20px;height:20px;cursor:pointer;">
            <div>
              <div style="font-weight:600;">Accept Emergency Calls</div>
              <div style="font-size:0.85rem;color:var(--text-muted);">Enable to receive emergency roadside assistance requests</div>
            </div>
          </label>
        </div>
        
        <div id="emergency-settings-details" style="display:none;">
          <div class="form-group">
            <label class="form-label">Emergency Services You Offer</label>
            <div style="display:grid;grid-template-columns:repeat(auto-fill, minmax(150px, 1fr));gap:8px;">
              <label class="service-checkbox"><input type="checkbox" value="flat_tire" class="emergency-service-check"> üõû Flat Tire</label>
              <label class="service-checkbox"><input type="checkbox" value="dead_battery" class="emergency-service-check"> üîã Jump Start</label>
              <label class="service-checkbox"><input type="checkbox" value="lockout" class="emergency-service-check"> üîê Lockout</label>
              <label class="service-checkbox"><input type="checkbox" value="tow_needed" class="emergency-service-check"> üöõ Towing</label>
              <label class="service-checkbox"><input type="checkbox" value="fuel_delivery" class="emergency-service-check"> ‚õΩ Fuel Delivery</label>
              <label class="service-checkbox"><input type="checkbox" value="other" class="emergency-service-check"> üîß Other</label>
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Emergency Service Radius (miles)</label>
              <select class="form-input" id="emergency-radius">
                <option value="5">5 miles</option>
                <option value="10">10 miles</option>
                <option value="15" selected>15 miles</option>
                <option value="25">25 miles</option>
                <option value="50">50 miles</option>
              </select>
            </div>
            <div class="form-group">
              <label style="display:flex;align-items:center;gap:8px;cursor:pointer;margin-top:28px;">
                <input type="checkbox" id="emergency-24-7" style="width:18px;height:18px;">
                <span>Available 24/7</span>
              </label>
            </div>
          </div>
          
          <div class="form-group">
            <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
              <input type="checkbox" id="emergency-can-tow" style="width:18px;height:18px;">
              <span>I have towing capability</span>
            </label>
          </div>
          
          <!-- No-show penalty warning -->
          <div style="background:rgba(239, 95, 95, 0.15);border:1px solid rgba(239, 95, 95, 0.3);padding:16px;border-radius:var(--radius-md);margin-top:20px;">
            <div style="display:flex;align-items:flex-start;gap:12px;">
              <span style="font-size:1.5rem;">‚ö†Ô∏è</span>
              <div>
                <div style="font-weight:600;color:var(--accent-red);margin-bottom:4px;">No-Show Penalty Policy</div>
                <div style="font-size:0.9rem;color:var(--text-secondary);line-height:1.5;">
                  If you claim an emergency and fail to arrive within your ETA + 15 minutes, members can report a no-show. 
                  <strong style="color:var(--accent-red);">Penalty: 3 bid credits + 24-hour suspension from the emergency queue.</strong>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Claim cost info -->
          <div style="background:var(--accent-gold-soft);padding:16px;border-radius:var(--radius-md);margin-top:16px;">
            <div style="display:flex;align-items:flex-start;gap:12px;">
              <span style="font-size:1.5rem;">üéüÔ∏è</span>
              <div>
                <div style="font-weight:600;color:var(--accent-gold);margin-bottom:4px;">Emergency Claim Cost</div>
                <div style="font-size:0.9rem;color:var(--text-secondary);line-height:1.5;">
                  Claiming an emergency requires <strong>1 bid credit</strong>. The credit is deducted when you accept the job.
                  Each emergency has a 5-minute claim window per round.
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div style="display:flex;gap:12px;justify-content:flex-end;margin-top:24px;">
        <button class="btn btn-secondary" onclick="loadProviderProfile()">Cancel Changes</button>
        <button class="btn btn-primary" onclick="saveProviderProfile()">üíæ Save Profile</button>
      </div>
    </section>

    <!-- Team Members Section -->
    <section id="team" class="section">
      <div class="page-header">
        <h1 class="page-title">üë• Your Team</h1>
        <p class="page-subtitle">Showcase your skilled professionals to build trust with members</p>
      </div>

      <div class="card">
        <div class="card-header">
          <h2 class="card-title">Team Members</h2>
          <button class="btn btn-primary" onclick="openTeamMemberModal()">+ Add Team Member</button>
        </div>
        <div id="team-members-grid" class="team-grid">
          <div class="empty-state">
            <div class="empty-state-icon">üë•</div>
            <p>No team members yet. Add your first team member to showcase your team!</p>
          </div>
        </div>
      </div>
    </section>

    <!-- Emergency Queue Section -->
    <section id="emergencies" class="section">
      <div class="page-header">
        <h1 class="page-title">üö® Emergency Queue</h1>
        <p class="page-subtitle">Nearby members need emergency roadside assistance.</p>
      </div>

      <div id="emergency-settings-notice" style="display:none;background:var(--accent-gold-soft);border:1px solid rgba(212,168,85,0.3);padding:16px 20px;border-radius:var(--radius-lg);margin-bottom:24px;">
        <strong>‚ö†Ô∏è Emergency services not enabled</strong>
        <p style="font-size:0.9rem;margin-top:4px;color:var(--text-secondary);">Enable emergency services in your <a href="#" onclick="showSection('profile')" style="color:var(--accent-gold);text-decoration:underline;">Business Profile</a> to receive emergency requests.</p>
      </div>

      <div class="card">
        <div class="card-header">
          <h2 class="card-title">üìç Nearby Emergencies</h2>
          <button class="btn btn-secondary btn-sm" onclick="refreshEmergencies()">üîÑ Refresh</button>
        </div>
        <div id="emergency-queue">
          <div class="empty-state">
            <div class="empty-state-icon">‚úÖ</div>
            <p>No pending emergencies nearby</p>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h2 class="card-title">‚úì Your Active Emergency</h2>
        </div>
        <div id="my-active-emergency">
          <div class="empty-state" style="padding:24px;">
            <p style="color:var(--text-muted);">No active emergency job</p>
          </div>
        </div>
      </div>
    </section>

    <!-- Destination Tasks Section -->
    <section id="destination-tasks" class="section">
      <div class="page-header">
        <h1 class="page-title">üöó Destination Services</h1>
        <p class="page-subtitle">Pick up and deliver member vehicles for special transport needs.</p>
      </div>

      <!-- What Are Destination Services Info Card -->
      <div class="card" style="background:linear-gradient(135deg, rgba(74,124,255,0.1), rgba(168,85,247,0.08));border:1px solid rgba(74,124,255,0.25);margin-bottom:24px;">
        <div style="display:flex;gap:16px;align-items:flex-start;">
          <div style="font-size:2.5rem;">üöô</div>
          <div style="flex:1;">
            <h3 style="margin:0 0 8px;color:var(--accent-blue);">What Are Destination Services?</h3>
            <p style="color:var(--text-secondary);margin:0 0 16px;line-height:1.6;">
              Members request these services when they need someone to <strong>drive their vehicle</strong> to a specific location. You (or your team driver) pick up their car, take it where it needs to go, and return it when done.
            </p>
            <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:12px;">
              <div style="background:var(--bg-card);padding:12px;border-radius:var(--radius-md);border:1px solid var(--border-subtle);">
                <strong style="color:var(--accent-gold);">‚úàÔ∏è Airport Runs</strong>
                <p style="font-size:0.85rem;color:var(--text-muted);margin:4px 0 0;">Drive member to/from airport in their car, or pick up their car while they're traveling.</p>
              </div>
              <div style="background:var(--bg-card);padding:12px;border-radius:var(--radius-md);border:1px solid var(--border-subtle);">
                <strong style="color:var(--accent-green);">üè¢ Dealership Trips</strong>
                <p style="font-size:0.85rem;color:var(--text-muted);margin:4px 0 0;">Take their car to the dealer for warranty work, recalls, or scheduled maintenance.</p>
              </div>
              <div style="background:var(--bg-card);padding:12px;border-radius:var(--radius-md);border:1px solid var(--border-subtle);">
                <strong style="color:var(--accent-blue);">‚ú® Mobile Detailing</strong>
                <p style="font-size:0.85rem;color:var(--text-muted);margin:4px 0 0;">Pick up, detail the vehicle at your shop, and return it looking brand new.</p>
              </div>
              <div style="background:var(--bg-card);padding:12px;border-radius:var(--radius-md);border:1px solid var(--border-subtle);">
                <strong style="color:#a855f7;">üîë Valet Service</strong>
                <p style="font-size:0.85rem;color:var(--text-muted);margin:4px 0 0;">Pick up for any service (oil change, tires, etc.) and return when complete.</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Quick Stats Dashboard -->
      <div class="stats-grid" style="margin-bottom:24px;">
        <div class="stat-card">
          <div class="stat-icon gold">üìÖ</div>
          <div class="stat-value" id="dest-today-count">0</div>
          <div class="stat-label">Today's Tasks</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon green">‚úÖ</div>
          <div class="stat-value" id="dest-week-completed">0</div>
          <div class="stat-label">Completed This Week</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon blue">‚è±Ô∏è</div>
          <div class="stat-value" id="dest-avg-time">--</div>
          <div class="stat-label">Avg Completion Time</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon" style="background:rgba(168,85,247,0.12);">üöó</div>
          <div class="stat-value" id="dest-inprogress-count">0</div>
          <div class="stat-label">In Progress</div>
        </div>
      </div>

      <!-- Filter Tabs & Sort -->
      <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px;margin-bottom:20px;">
        <div class="dest-filter-tabs" id="dest-filter-tabs" style="margin-bottom:0;">
          <div class="dest-filter-tab active" data-filter="all" onclick="filterDestinationTasks('all')">
            üìã All
          </div>
          <div class="dest-filter-tab" data-filter="today" onclick="filterDestinationTasks('today')">
            üìÖ Today
          </div>
          <div class="dest-filter-tab" data-filter="upcoming" onclick="filterDestinationTasks('upcoming')">
            ‚è≥ Upcoming
          </div>
          <div class="dest-filter-tab" data-filter="completed" onclick="filterDestinationTasks('completed')">
            ‚úÖ Completed
          </div>
        </div>
        <div style="display:flex;align-items:center;gap:8px;">
          <span style="font-size:0.85rem;color:var(--text-muted);">Sort by:</span>
          <select class="form-input" id="dest-sort-select" onchange="sortDestinationTasks(this.value)" style="padding:8px 12px;min-width:120px;">
            <option value="time">Time</option>
            <option value="type">Type</option>
            <option value="status">Status</option>
            <option value="priority">Priority</option>
          </select>
        </div>
      </div>

      <!-- Service Type Quick Filters -->
      <div style="display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap;">
        <button class="btn btn-ghost btn-sm dest-type-filter active" data-type="all" onclick="filterDestTypeQuick('all')" style="font-size:0.8rem;">All Types</button>
        <button class="btn btn-ghost btn-sm dest-type-filter" data-type="airport" onclick="filterDestTypeQuick('airport')" style="font-size:0.8rem;">‚úàÔ∏è Airport</button>
        <button class="btn btn-ghost btn-sm dest-type-filter" data-type="dealership" onclick="filterDestTypeQuick('dealership')" style="font-size:0.8rem;">üè¢ Dealership</button>
        <button class="btn btn-ghost btn-sm dest-type-filter" data-type="detail" onclick="filterDestTypeQuick('detail')" style="font-size:0.8rem;">‚ú® Detail</button>
        <button class="btn btn-ghost btn-sm dest-type-filter" data-type="valet" onclick="filterDestTypeQuick('valet')" style="font-size:0.8rem;">üîë Valet</button>
      </div>

      <!-- Task Queue -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">üìã Task Queue</h2>
          <button class="btn btn-secondary btn-sm" onclick="loadDestinationTasks()">üîÑ Refresh</button>
        </div>
        <div id="destination-task-list">
          <div class="empty-state">
            <div class="empty-state-icon">üöó</div>
            <p>No destination tasks yet. Tasks will appear here when members request transport services.</p>
          </div>
        </div>
      </div>

      <!-- Completed Tasks Summary -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">üìä Performance Summary</h2>
          <button class="btn btn-ghost btn-sm" onclick="toggleCompletedTasksHistory()">View History ‚Üí</button>
        </div>
        
        <div class="dest-completed-stats" id="dest-completed-stats">
          <div class="dest-completed-stat">
            <div class="dest-completed-stat-value" id="dest-total-completed">0</div>
            <div class="dest-completed-stat-label">Total Completed</div>
          </div>
          <div class="dest-completed-stat">
            <div class="dest-completed-stat-value" id="dest-ontime-rate">--%</div>
            <div class="dest-completed-stat-label">On-Time Rate</div>
          </div>
          <div class="dest-completed-stat">
            <div class="dest-completed-stat-value" id="dest-avg-rating">--</div>
            <div class="dest-completed-stat-label">Avg Rating</div>
          </div>
          <div class="dest-completed-stat">
            <div class="dest-completed-stat-value" id="dest-week-earnings">$0</div>
            <div class="dest-completed-stat-label">This Week</div>
          </div>
        </div>

        <div id="completed-tasks-list" style="display:none;">
          <div class="empty-state" style="padding:24px;">
            <p style="color:var(--text-muted);">No completed tasks yet</p>
          </div>
        </div>
      </div>
    </section>

    <!-- Fleet Services Section -->
    <section id="fleet-services" class="section">
      <div class="page-header">
        <h1 class="page-title">üè¢ Fleet Services</h1>
        <p class="page-subtitle">Manage fleet accounts, bulk service batches, and high-volume jobs.</p>
      </div>

      <!-- Fleet Performance Metrics -->
      <div class="stats-grid" style="margin-bottom:24px;">
        <div class="stat-card">
          <div class="stat-icon gold">üèÜ</div>
          <div class="stat-value" id="fleet-jobs-completed">0</div>
          <div class="stat-label">Fleet Jobs Completed</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon blue">üöó</div>
          <div class="stat-value" id="fleet-avg-vehicles">0</div>
          <div class="stat-label">Avg Vehicles per Batch</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon green">üîÑ</div>
          <div class="stat-value" id="fleet-retention">--%</div>
          <div class="stat-label">Fleet Client Retention</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon" style="background:rgba(168,85,247,0.12);">üìã</div>
          <div class="stat-value" id="fleet-active-batches">0</div>
          <div class="stat-label">Active Batches</div>
        </div>
      </div>

      <!-- Fleet Tab Navigation -->
      <div class="fleet-tabs" id="fleet-tabs">
        <div class="fleet-tab active" data-fleet-tab="queue" onclick="switchFleetTab('queue')">
          üì• Job Queue <span id="fleet-queue-badge" class="nav-badge" style="display:none;margin-left:6px;">0</span>
        </div>
        <div class="fleet-tab" data-fleet-tab="batches" onclick="switchFleetTab('batches')">
          üì¶ Active Batches
        </div>
        <div class="fleet-tab" data-fleet-tab="completed" onclick="switchFleetTab('completed')">
          ‚úÖ Completed
        </div>
      </div>

      <!-- Fleet Job Queue Section -->
      <div id="fleet-queue-section" class="fleet-section active">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">üì• Fleet Job Queue</h2>
            <button class="btn btn-secondary btn-sm" onclick="loadFleetJobQueue()">üîÑ Refresh</button>
          </div>
          
          <!-- Fleet Account Benefits Info -->
          <div style="background:linear-gradient(135deg, var(--accent-gold-soft), rgba(212,168,85,0.05));border:1px solid rgba(212,168,85,0.3);border-radius:var(--radius-md);padding:16px;margin-bottom:20px;">
            <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;">
              <span class="fleet-badge" style="background:linear-gradient(135deg, var(--accent-gold), #c49a45);color:#0a0a0f;padding:6px 14px;border-radius:100px;font-size:0.82rem;font-weight:600;">üè¢ Fleet Account</span>
              <span style="color:var(--accent-green);font-size:0.88rem;font-weight:500;">‚úì Guaranteed Payment</span>
              <span style="color:var(--accent-blue);font-size:0.88rem;font-weight:500;">üí∞ Volume Discounts</span>
              <span style="color:var(--text-secondary);font-size:0.88rem;">üîÑ Recurring Service Potential</span>
            </div>
          </div>

          <div id="fleet-job-queue">
            <div class="empty-state">
              <div class="empty-state-icon">üè¢</div>
              <p>No fleet job requests at the moment. Fleet requests from verified business accounts will appear here.</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Bulk Service Batches Section -->
      <div id="fleet-batches-section" class="fleet-section">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">üì¶ Active Bulk Service Batches</h2>
            <button class="btn btn-secondary btn-sm" onclick="loadFleetBatches()">üîÑ Refresh</button>
          </div>

          <div id="fleet-batches-list">
            <div class="empty-state">
              <div class="empty-state-icon">üì¶</div>
              <p>No active bulk service batches. Accept fleet jobs to see batches here.</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Completed Fleet Jobs Section -->
      <div id="fleet-completed-section" class="fleet-section">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">‚úÖ Completed Fleet Jobs</h2>
          </div>
          <div id="fleet-completed-list">
            <div class="empty-state">
              <div class="empty-state-icon">‚úÖ</div>
              <p>No completed fleet jobs yet.</p>
            </div>
          </div>
        </div>
      </div>
    </section>
    
    <div style="text-align:center;padding:40px 20px 20px;font-size:0.8rem;color:var(--text-muted);">
      ¬© 2025 My Car Concierge. All rights reserved. - IMOR
    </div>
  </main>

  <!-- Bid Modal -->
  <div class="modal-backdrop" id="bid-modal">
    <div class="modal">
      <div class="modal-header"><h3 class="modal-title">Submit Bid</h3><button class="modal-close" onclick="closeModal('bid-modal')">√ó</button></div>
      <div class="modal-body">
        <p id="bid-package-title" style="font-weight:600;margin-bottom:16px;"></p>
        <div class="form-row">
          <div class="form-group"><label class="form-label">Price Estimate ($) *</label>
            <select class="form-input" id="bid-price" required>
              <option value="">Select Amount</option>
              <option value="20">$20</option>
              <option value="50">$50</option>
              <option value="75">$75</option>
              <option value="100">$100</option>
              <option value="150">$150</option>
              <option value="200">$200</option>
              <option value="250">$250</option>
              <option value="300">$300</option>
              <option value="350">$350</option>
              <option value="400">$400</option>
              <option value="500">$500</option>
              <option value="750">$750</option>
              <option value="1000">$1,000</option>
              <option value="1500">$1,500</option>
              <option value="2000">$2,000</option>
              <option value="2500">$2,500</option>
              <option value="3000">$3,000</option>
              <option value="5000">$5,000</option>
              <option value="custom">Custom Amount...</option>
            </select>
            <input type="number" class="form-input" id="bid-price-custom" placeholder="Enter custom amount" min="0" style="display:none;margin-top:8px;">
          </div>
          <div class="form-group"><label class="form-label">Estimated Duration</label><input type="text" class="form-input" id="bid-duration" placeholder="2-3 hours"></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label class="form-label">Parts Cost ($)</label><input type="number" class="form-input" id="bid-parts" placeholder="100" min="0"></div>
          <div class="form-group"><label class="form-label">Labor Cost ($)</label><input type="number" class="form-input" id="bid-labor" placeholder="150" min="0"></div>
        </div>
        <div class="form-group"><label class="form-label">Your Availability</label><input type="text" class="form-input" id="bid-availability" placeholder="Available Mon-Fri, can start next week"></div>
        <div class="form-group"><label class="form-label">Notes for Member</label><textarea class="form-textarea" id="bid-notes" placeholder="Describe your approach, experience with this type of work, etc."></textarea></div>
      </div>
      <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('bid-modal')">Cancel</button><button class="btn btn-primary" onclick="submitBid()">Submit Bid</button></div>
    </div>
  </div>

  <!-- Package Details Modal -->
  <div class="modal-backdrop" id="package-details-modal">
    <div class="modal" style="max-width:700px;">
      <div class="modal-header"><h3 class="modal-title" id="package-details-title">Package Details</h3><button class="modal-close" onclick="closeModal('package-details-modal')">√ó</button></div>
      <div class="modal-body" id="package-details-body"></div>
    </div>
  </div>

  <!-- Message Modal -->
  <div class="modal-backdrop" id="message-modal">
    <div class="modal">
      <div class="modal-header"><h3 class="modal-title" id="message-modal-title">Message Member</h3><button class="modal-close" onclick="closeModal('message-modal')">√ó</button></div>
      <div class="modal-body">
        <div class="messages-container" id="message-thread"></div>
        <div class="message-input-row">
          <input type="text" class="form-input" id="message-input" placeholder="Type your message...">
          <button class="btn btn-primary" onclick="sendMessage()">Send</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Upsell Request Modal -->
  <div class="modal-backdrop" id="upsell-modal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Report Additional Issue Found</h3>
        <button class="modal-close" onclick="closeModal('upsell-modal')">√ó</button>
      </div>
      <div class="modal-body">
        <div class="alert" style="background:var(--accent-blue-soft);border:1px solid rgba(74,124,255,0.3);color:var(--accent-blue);margin-bottom:20px;padding:16px;border-radius:var(--radius-md);">
          <strong>Important:</strong> The member has 24 hours to approve, decline, or seek competing bids. Photo evidence helps build trust.
        </div>

        <div class="form-group">
          <label class="form-label">Issue Found *</label>
          <input type="text" class="form-input" id="upsell-title" placeholder="e.g., Worn brake pads, Leaking coolant hose">
        </div>

        <div class="form-group">
          <label class="form-label">Description</label>
          <textarea class="form-textarea" id="upsell-description" placeholder="Explain what you found and why it needs attention..."></textarea>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Estimated Cost ($) *</label>
            <input type="number" class="form-input" id="upsell-cost" placeholder="150.00" min="0" step="0.01">
          </div>
          <div class="form-group">
            <label class="form-label">Urgency</label>
            <select class="form-select" id="upsell-urgency">
              <option value="critical">üî¥ Critical - Safety issue</option>
              <option value="recommended" selected>üü° Recommended - Should address soon</option>
              <option value="optional">üü¢ Optional - Can wait</option>
            </select>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Photo Evidence (recommended)</label>
          <div style="border:2px dashed var(--border-subtle);border-radius:var(--radius-md);padding:20px;text-align:center;cursor:pointer;">
            <div style="font-size:24px;margin-bottom:8px;">üì∏</div>
            <div style="color:var(--text-secondary);font-size:0.9rem;">Click to upload photos of the issue</div>
            <input type="file" id="upsell-photos" multiple accept="image/*" style="display:none;">
          </div>
          <div class="form-hint">Photos help the member understand the issue and increase approval rates.</div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('upsell-modal')">Cancel</button>
        <button class="btn btn-primary" onclick="submitUpsellRequest()">Send to Member</button>
      </div>
    </div>
  </div>

  <!-- Provider Schedule Proposal Modal -->
  <div class="modal-backdrop" id="provider-schedule-modal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">üìÖ Propose Service Appointment</h3>
        <button class="modal-close" onclick="closeModal('provider-schedule-modal')">√ó</button>
      </div>
      <div class="modal-body">
        <div class="alert" style="background:var(--accent-gold-soft);border:1px solid rgba(212,168,85,0.3);color:var(--accent-gold);margin-bottom:20px;padding:16px;border-radius:var(--radius-md);">
          üìÖ Propose a date and time for the service. The member will be notified and can confirm or suggest alternatives.
        </div>
        <input type="hidden" id="schedule-package-id">
        <input type="hidden" id="schedule-member-id">
        <input type="hidden" id="schedule-provider-id">
        <div class="form-group">
          <label class="form-label">Proposed Date *</label>
          <input type="date" class="form-input" id="schedule-date" required>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Start Time</label>
            <input type="time" class="form-input" id="schedule-time-start" value="09:00">
          </div>
          <div class="form-group">
            <label class="form-label">End Time</label>
            <input type="time" class="form-input" id="schedule-time-end" value="17:00">
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Estimated Days to Complete</label>
          <select class="form-input" id="schedule-duration">
            <option value="1">Same day</option>
            <option value="2">2 days</option>
            <option value="3">3 days</option>
            <option value="5">Up to a week</option>
            <option value="7">1 week+</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Notes for Member</label>
          <textarea class="form-textarea" id="schedule-notes" placeholder="Any special instructions or details about timing..."></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('provider-schedule-modal')">Cancel</button>
        <button class="btn btn-primary" onclick="submitProviderScheduleProposal()">üìÖ Send Proposal</button>
      </div>
    </div>
  </div>

  <!-- Provider Counter Proposal Modal -->
  <div class="modal-backdrop" id="provider-counter-modal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">üîÑ Propose New Time</h3>
        <button class="modal-close" onclick="closeModal('provider-counter-modal')">√ó</button>
      </div>
      <div class="modal-body">
        <div class="alert" style="background:var(--accent-blue-soft);border:1px solid rgba(74,124,255,0.3);color:var(--accent-blue);margin-bottom:20px;padding:16px;border-radius:var(--radius-md);">
          The proposed time doesn't work? Suggest an alternative and the member will be notified.
        </div>
        <input type="hidden" id="counter-appointment-id">
        <input type="hidden" id="counter-package-id">
        <div class="form-group">
          <label class="form-label">New Proposed Date *</label>
          <input type="date" class="form-input" id="counter-date" required>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Start Time</label>
            <input type="time" class="form-input" id="counter-time-start" value="09:00">
          </div>
          <div class="form-group">
            <label class="form-label">End Time</label>
            <input type="time" class="form-input" id="counter-time-end" value="17:00">
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Reason for Change</label>
          <textarea class="form-textarea" id="counter-notes" placeholder="Explain why this time works better..."></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('provider-counter-modal')">Cancel</button>
        <button class="btn btn-primary" onclick="submitProviderCounterProposal()">üîÑ Propose New Time</button>
      </div>
    </div>
  </div>

  <!-- Provider Location Share Modal -->
  <div class="modal-backdrop" id="provider-location-modal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">üìç Share Your Location</h3>
        <button class="modal-close" onclick="closeModal('provider-location-modal')">√ó</button>
      </div>
      <div class="modal-body">
        <div class="alert" style="background:var(--accent-gold-soft);border:1px solid rgba(212,168,85,0.3);color:var(--accent-gold);margin-bottom:20px;padding:16px;border-radius:var(--radius-md);">
          üìç Share your current location with the member. This is useful for pickups or when you're on your way.
        </div>
        <input type="hidden" id="location-package-id">
        <input type="hidden" id="location-member-id">
        <div class="form-group">
          <label class="form-label">Context</label>
          <select class="form-input" id="location-context">
            <option value="shop_location">Shop Location</option>
            <option value="on_my_way">On My Way for Pickup</option>
            <option value="delivering">Delivering Vehicle</option>
            <option value="general">General</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Message (optional)</label>
          <input type="text" class="form-input" id="location-message" placeholder="e.g., I'll be there in 15 minutes">
        </div>
        <div id="location-status" style="display:none;padding:16px;background:var(--bg-input);border-radius:var(--radius-md);margin-top:16px;"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('provider-location-modal')">Cancel</button>
        <button class="btn btn-primary" id="share-location-btn" onclick="executeProviderLocationShare()">üìç Share Location</button>
      </div>
    </div>
  </div>

  <!-- Evidence Capture Modal -->
  <div class="modal-backdrop" id="evidence-modal">
    <div class="modal" style="max-width:640px;">
      <div class="modal-header">
        <h3 class="modal-title">üì∏ <span id="evidence-modal-title">Capture Evidence</span></h3>
        <button class="modal-close" onclick="closeModal('evidence-modal')">√ó</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="evidence-package-id">
        <input type="hidden" id="evidence-type">
        
        <div class="form-group">
          <label class="form-label">Photos (up to 10) *</label>
          <div style="display:flex;flex-wrap:wrap;gap:10px;margin-bottom:12px;" id="evidence-photo-preview"></div>
          <input type="file" id="evidence-photos" accept="image/*" multiple onchange="previewEvidencePhotos()" style="display:none;">
          <button type="button" class="btn btn-secondary" onclick="document.getElementById('evidence-photos').click()">üì∑ Add Photos</button>
          <p class="form-hint">Take photos of vehicle condition, odometer, fuel gauge</p>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Odometer Reading *</label>
            <input type="number" class="form-input" id="evidence-odometer" placeholder="e.g., 45230" required>
          </div>
          <div class="form-group">
            <label class="form-label">Fuel Level *</label>
            <select class="form-input" id="evidence-fuel" required>
              <option value="">Select...</option>
              <option value="empty">Empty</option>
              <option value="1/4">1/4</option>
              <option value="1/2">1/2</option>
              <option value="3/4">3/4</option>
              <option value="full">Full</option>
            </select>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Exterior Condition</label>
          <textarea class="form-textarea" id="evidence-exterior" placeholder="Note any scratches, dents, or damage on the exterior..."></textarea>
        </div>

        <div class="form-group">
          <label class="form-label">Interior Condition</label>
          <textarea class="form-textarea" id="evidence-interior" placeholder="Note interior condition, cleanliness, any damage..."></textarea>
        </div>

        <div class="form-group">
          <label class="form-label">General Notes</label>
          <textarea class="form-textarea" id="evidence-notes" placeholder="Any additional observations..."></textarea>
        </div>

        <div id="evidence-upload-status" style="display:none;padding:16px;background:var(--bg-input);border-radius:var(--radius-md);margin-top:16px;"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('evidence-modal')">Cancel</button>
        <button class="btn btn-primary" id="submit-evidence-btn" onclick="submitEvidence()">üì∏ Save Evidence</button>
      </div>
    </div>
  </div>

  <!-- Key Exchange Modal -->
  <div class="modal-backdrop" id="key-exchange-modal">
    <div class="modal" style="max-width:640px;">
      <div class="modal-header">
        <h3 class="modal-title">üîë <span id="key-exchange-modal-title">Key Exchange Verification</span></h3>
        <button class="modal-close" onclick="closeModal('key-exchange-modal')">√ó</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="key-exchange-package-id">
        <input type="hidden" id="key-exchange-stage">
        
        <div class="alert" style="background:var(--accent-gold-soft);border:1px solid rgba(212,168,85,0.3);color:var(--accent-gold);margin-bottom:20px;padding:16px;border-radius:var(--radius-md);">
          üîë Document the key handoff for verification and liability protection.
        </div>

        <div class="form-group">
          <label class="form-label">Driver ID Photo *</label>
          <div style="display:flex;flex-wrap:wrap;gap:10px;margin-bottom:12px;" id="key-exchange-id-preview"></div>
          <input type="file" id="key-exchange-id-photo" accept="image/*" onchange="previewKeyExchangeIdPhoto()" style="display:none;">
          <button type="button" class="btn btn-secondary" onclick="document.getElementById('key-exchange-id-photo').click()">üì∑ Capture ID Photo</button>
          <p class="form-hint">Take a photo of the driver's ID for verification</p>
        </div>

        <div class="form-group">
          <label class="form-label">Key Handoff Photos (up to 3) *</label>
          <div style="display:flex;flex-wrap:wrap;gap:10px;margin-bottom:12px;" id="key-exchange-photos-preview"></div>
          <input type="file" id="key-exchange-key-photos" accept="image/*" multiple onchange="previewKeyExchangePhotos()" style="display:none;">
          <button type="button" class="btn btn-secondary" onclick="document.getElementById('key-exchange-key-photos').click()">üì∑ Add Key Photos</button>
          <p class="form-hint">Photograph keys being handed over, with vehicle visible if possible</p>
        </div>

        <div class="form-group">
          <label class="form-label">Notes (optional)</label>
          <textarea class="form-textarea" id="key-exchange-notes" placeholder="Any notes about the key exchange, number of keys, remotes, valet key, etc..."></textarea>
        </div>

        <div id="key-exchange-upload-status" style="display:none;padding:16px;background:var(--bg-input);border-radius:var(--radius-md);margin-top:16px;"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('key-exchange-modal')">Cancel</button>
        <button class="btn btn-primary" id="submit-key-exchange-btn" onclick="submitKeyExchange()">üîë Verify Key Exchange</button>
      </div>
    </div>
  </div>

  <!-- Destination Task Detail Modal -->
  <div class="modal-backdrop" id="destination-task-modal">
    <div class="modal" style="max-width:720px;">
      <div class="modal-header">
        <h3 class="modal-title" id="dest-task-modal-title">Task Details</h3>
        <button class="modal-close" onclick="closeModal('destination-task-modal')">√ó</button>
      </div>
      <div class="modal-body" id="dest-task-modal-body">
        <div class="empty-state"><p>Loading task details...</p></div>
      </div>
      <div class="modal-footer" id="dest-task-modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('destination-task-modal')">Close</button>
      </div>
    </div>
  </div>

  <!-- Destination Task Status Update Modal -->
  <div class="modal-backdrop" id="dest-status-modal">
    <div class="modal" style="max-width:560px;">
      <div class="modal-header">
        <h3 class="modal-title" id="dest-status-modal-title">Update Status</h3>
        <button class="modal-close" onclick="closeModal('dest-status-modal')">√ó</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="dest-status-service-id">
        <input type="hidden" id="dest-status-new-status">
        
        <div class="alert" style="background:var(--accent-gold-soft);border:1px solid rgba(212,168,85,0.3);color:var(--accent-gold);margin-bottom:20px;padding:16px;border-radius:var(--radius-md);">
          <span id="dest-status-info">Updating task status...</span>
        </div>

        <div class="form-group" id="dest-photo-group">
          <label class="form-label">üì∏ Photo Evidence <span style="color:var(--accent-red);">*</span></label>
          <div style="display:flex;flex-wrap:wrap;gap:10px;margin-bottom:12px;" id="dest-status-photo-preview"></div>
          <input type="file" id="dest-status-photo" accept="image/*" capture="environment" onchange="previewDestStatusPhoto()" style="display:none;">
          <button type="button" class="btn btn-secondary" onclick="document.getElementById('dest-status-photo').click()">üì∑ Capture Vehicle Photo</button>
          <p class="form-hint">Take a photo of the vehicle for documentation</p>
        </div>

        <div class="form-group" id="dest-odometer-group" style="display:none;">
          <label class="form-label">üî¢ Odometer Reading</label>
          <input type="number" class="form-input" id="dest-odometer-reading" placeholder="e.g., 45678" min="0">
          <p class="form-hint">Enter current odometer reading</p>
        </div>

        <div class="form-group" id="dest-fuel-group" style="display:none;">
          <label class="form-label">‚õΩ Fuel Level</label>
          <select class="form-input" id="dest-fuel-level">
            <option value="">Select fuel level...</option>
            <option value="empty">Empty</option>
            <option value="1/4">1/4 Tank</option>
            <option value="1/2">1/2 Tank</option>
            <option value="3/4">3/4 Tank</option>
            <option value="full">Full</option>
          </select>
          <p class="form-hint">Select current fuel level</p>
        </div>

        <div class="form-group" id="dest-parking-group" style="display:none;">
          <label class="form-label">üÖøÔ∏è Parking Location/Spot</label>
          <input type="text" class="form-input" id="dest-parking-spot" placeholder="e.g., Terminal B, Level 3, Spot 427">
          <p class="form-hint">Enter the parking location for airport services</p>
        </div>

        <div class="form-group" id="dest-final-odometer-group" style="display:none;">
          <label class="form-label">üî¢ Final Odometer Reading</label>
          <input type="number" class="form-input" id="dest-final-odometer" placeholder="e.g., 45698" min="0">
          <p class="form-hint">Enter final odometer reading at delivery</p>
        </div>

        <div class="form-group">
          <label class="form-label" id="dest-notes-label">Notes (optional)</label>
          <textarea class="form-textarea" id="dest-status-notes" placeholder="Any notes about this status update..."></textarea>
        </div>

        <div class="form-group" id="dest-location-group">
          <label class="form-label">üìç Current Location</label>
          <div id="dest-location-status" style="padding:12px;background:var(--bg-input);border-radius:var(--radius-md);font-size:0.9rem;color:var(--text-muted);">
            Click "Capture Location" to record GPS coordinates
          </div>
          <input type="hidden" id="dest-location-lat">
          <input type="hidden" id="dest-location-lng">
          <button type="button" class="btn btn-secondary btn-sm" onclick="captureDestLocation()" style="margin-top:8px;">üìç Capture Location</button>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('dest-status-modal')">Cancel</button>
        <button class="btn btn-primary" id="dest-status-submit-btn" onclick="submitDestStatusUpdate()">Update Status</button>
      </div>
    </div>
  </div>

  <!-- Driver Assignment Modal -->
  <div class="modal-backdrop" id="dest-driver-modal">
    <div class="modal" style="max-width:480px;">
      <div class="modal-header">
        <h3 class="modal-title">Assign Driver</h3>
        <button class="modal-close" onclick="closeModal('dest-driver-modal')">√ó</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="dest-driver-service-id">
        
        <div class="form-group">
          <label class="form-label">Select Driver</label>
          <select class="form-input" id="dest-driver-select">
            <option value="">Select a team member...</option>
          </select>
          <p class="form-hint">Assign this task to a team member</p>
        </div>

        <div id="dest-driver-workload" style="display:none;padding:16px;background:var(--bg-input);border-radius:var(--radius-md);margin-top:12px;">
          <div style="font-size:0.85rem;color:var(--text-muted);margin-bottom:8px;">Current Workload</div>
          <div id="dest-driver-workload-info" style="font-size:0.9rem;"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('dest-driver-modal')">Cancel</button>
        <button class="btn btn-primary" onclick="assignDestDriver()">Assign Driver</button>
      </div>
    </div>
  </div>

  <!-- Team Member Modal -->
  <div class="modal-backdrop" id="team-member-modal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title" id="team-modal-title">Add Team Member</h3>
        <button class="modal-close" onclick="closeModal('team-member-modal')">√ó</button>
      </div>
      <div class="modal-body">
        <div class="team-photo-upload" id="team-photo-upload" onclick="document.getElementById('team-photo-input').click()">
          <div class="team-photo-upload-icon">üì∑</div>
          <div class="team-photo-upload-text">Upload Photo</div>
        </div>
        <input type="file" id="team-photo-input" accept="image/*" style="display:none;" onchange="handleTeamPhotoSelect(event)">
        <button type="button" class="btn btn-ghost btn-sm" id="remove-team-photo-btn" onclick="removeTeamPhoto()" style="display:none;margin:0 auto 16px;width:auto;">Remove Photo</button>

        <div class="form-group">
          <label class="form-label">Name *</label>
          <input type="text" class="form-input" id="team-member-name" placeholder="Full name" required>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Role *</label>
            <select class="form-input" id="team-member-role" required>
              <option value="">Select role...</option>
              <option value="mechanic">Mechanic</option>
              <option value="driver">Driver</option>
              <option value="detailer">Detailer</option>
              <option value="technician">Technician</option>
              <option value="manager">Manager</option>
              <option value="other">Other</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Years of Experience</label>
            <input type="number" class="form-input" id="team-member-experience" placeholder="e.g., 5" min="0" max="50">
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Bio</label>
          <textarea class="form-textarea" id="team-member-bio" placeholder="Brief description of skills and background..."></textarea>
        </div>

        <div class="form-group">
          <label class="form-label">Certifications</label>
          <input type="text" class="form-input" id="team-member-certifications" placeholder="ASE Certified, I-CAR Gold, etc. (comma-separated)">
          <p class="form-hint">Enter certifications separated by commas</p>
        </div>

        <div class="form-group">
          <label class="form-label">Specialties</label>
          <input type="text" class="form-input" id="team-member-specialties" placeholder="Brakes, Engine repair, Detailing, etc. (comma-separated)">
          <p class="form-hint">Enter specialties separated by commas</p>
        </div>

        <div class="form-group">
          <label style="display:flex;align-items:center;gap:12px;cursor:pointer;padding:12px;background:var(--bg-input);border-radius:var(--radius-md);">
            <input type="checkbox" id="team-member-active" checked style="width:20px;height:20px;cursor:pointer;">
            <div>
              <div style="font-weight:500;">Active Team Member</div>
              <div style="font-size:0.85rem;color:var(--text-muted);">Active members are visible to customers</div>
            </div>
          </label>
        </div>

        <div class="form-group">
          <label style="display:flex;align-items:flex-start;gap:12px;cursor:pointer;padding:12px;background:var(--bg-input);border-radius:var(--radius-md);border:1px solid var(--accent-gold);">
            <input type="checkbox" id="team-member-consent" style="width:20px;height:20px;cursor:pointer;flex-shrink:0;margin-top:2px;">
            <div>
              <div style="font-weight:500;color:var(--accent-gold);">‚öñÔ∏è Photo & Information Consent</div>
              <div style="font-size:0.85rem;color:var(--text-muted);line-height:1.5;margin-top:4px;">I confirm that I have obtained written permission from this team member to display their photo and personal information on the My Car Concierge platform. I understand that I am responsible for ensuring proper consent has been obtained.</div>
            </div>
          </label>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('team-member-modal')">Cancel</button>
        <button class="btn btn-primary" onclick="saveTeamMember()">Save Team Member</button>
      </div>
    </div>
  </div>

  <!-- Emergency Detail Modal -->
  <div class="modal-backdrop" id="emergency-detail-modal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">üö® Emergency Details</h3>
        <button class="modal-close" onclick="closeModal('emergency-detail-modal')">√ó</button>
      </div>
      <div class="modal-body" id="emergency-detail-content">
        <div style="text-align:center;padding:40px;">
          <div style="font-size:48px;margin-bottom:16px;">‚è≥</div>
          <div style="color:var(--text-muted);">Loading...</div>
        </div>
      </div>
      <div class="modal-footer" id="emergency-detail-footer"></div>
    </div>
  </div>

  <!-- Emergency Accept Modal -->
  <div class="modal-backdrop" id="emergency-accept-modal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">üöó Claim Emergency</h3>
        <button class="modal-close" onclick="closeModal('emergency-accept-modal')">√ó</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="accept-emergency-id">
        
        <div style="background:var(--accent-gold-soft);padding:14px;border-radius:var(--radius-md);margin-bottom:20px;display:flex;align-items:center;gap:12px;">
          <span style="font-size:1.5rem;">üéüÔ∏è</span>
          <div>
            <div style="font-weight:600;color:var(--accent-gold);">Claim Cost: 1 Bid Credit</div>
            <div style="font-size:0.85rem;color:var(--text-muted);">This credit will be deducted when you claim.</div>
          </div>
        </div>
        
        <div class="form-group">
          <label class="form-label">Your Estimated Time of Arrival *</label>
          <select class="form-input" id="accept-eta" required>
            <option value="">Select ETA...</option>
            <option value="10">~10 minutes</option>
            <option value="15">~15 minutes</option>
            <option value="20">~20 minutes</option>
            <option value="30">~30 minutes</option>
            <option value="45">~45 minutes</option>
            <option value="60">~1 hour</option>
          </select>
          <div class="form-hint">‚ö†Ô∏è You must arrive within ETA + 15 min or member can report no-show.</div>
        </div>
        
        <div style="background:var(--bg-input);padding:12px;border-radius:var(--radius-md);font-size:0.9rem;color:var(--text-secondary);">
          ‚úì The member will be notified immediately that you're on your way.
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('emergency-accept-modal')">Cancel</button>
        <button class="btn btn-emergency" onclick="confirmAcceptEmergency()">üöó Claim & Go!</button>
      </div>
    </div>
  </div>

  <!-- Emergency Complete Modal (Invoice Submission) -->
  <div class="modal-backdrop" id="emergency-complete-modal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">üìã Submit Invoice & Complete</h3>
        <button class="modal-close" onclick="closeModal('emergency-complete-modal')">√ó</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="complete-emergency-id">
        <input type="hidden" id="complete-is-towing" value="false">
        
        <div style="background:var(--accent-gold-soft);padding:12px;border-radius:var(--radius-md);margin-bottom:20px;">
          <div style="font-size:0.85rem;color:var(--text-muted);">üí∞ Member Escrow</div>
          <div id="complete-escrow-display" style="font-size:1.2rem;font-weight:600;color:var(--accent-gold);">--</div>
        </div>
        
        <div id="complete-miles-group" class="form-group" style="display:none;">
          <label class="form-label">Actual Miles Towed *</label>
          <input type="number" class="form-input" id="complete-actual-miles" placeholder="e.g., 15" min="0" step="0.1">
          <div class="form-hint">Enter actual miles from pickup to destination (for towing/accident jobs)</div>
        </div>
        
        <div class="form-group">
          <label class="form-label">Invoice Amount ($) *</label>
          <input type="number" class="form-input" id="complete-amount" placeholder="0.00" min="0" step="0.01">
          <div class="form-hint">Enter the final amount to charge the member</div>
        </div>
        
        <div class="form-group">
          <label class="form-label">Service Notes</label>
          <textarea class="form-textarea" id="complete-notes" placeholder="Describe what was done to resolve the emergency..."></textarea>
        </div>
        
        <div style="background:var(--bg-input);padding:12px;border-radius:var(--radius-md);font-size:0.85rem;color:var(--text-muted);">
          ‚ÑπÔ∏è The member's escrow will be captured for the invoice amount. Any remaining balance will be refunded to the member.
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('emergency-complete-modal')">Cancel</button>
        <button class="btn btn-primary" onclick="confirmCompleteEmergency()">üìã Submit Invoice</button>
      </div>
    </div>
  </div>

  <!-- Multi-Point Inspection Modal -->
  <div class="modal-backdrop" id="inspection-modal">
    <div class="modal inspection-modal">
      <div class="modal-header">
        <h3 class="modal-title">üîç Multi-Point Inspection Report</h3>
        <button class="modal-close" onclick="closeModal('inspection-modal')">√ó</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="inspection-package-id">
        <input type="hidden" id="inspection-vehicle-id">
        <input type="hidden" id="inspection-report-id">
        
        <div class="form-group">
          <label class="form-label">Inspection Type</label>
          <select class="form-input" id="inspection-type">
            <option value="standard">Standard Multi-Point</option>
            <option value="comprehensive">Comprehensive</option>
            <option value="pre_purchase">Pre-Purchase</option>
          </select>
        </div>

        <div id="inspection-summary" class="inspection-summary" style="display:none;">
          <div style="font-weight:600;margin-bottom:12px;">Inspection Summary</div>
          <div class="inspection-summary-grid">
            <div class="inspection-summary-item good">
              <div class="inspection-summary-count" id="count-good">0</div>
              <div class="inspection-summary-label">Good</div>
            </div>
            <div class="inspection-summary-item fair">
              <div class="inspection-summary-count" id="count-fair">0</div>
              <div class="inspection-summary-label">Fair</div>
            </div>
            <div class="inspection-summary-item attention">
              <div class="inspection-summary-count" id="count-attention">0</div>
              <div class="inspection-summary-label">Attention</div>
            </div>
            <div class="inspection-summary-item urgent">
              <div class="inspection-summary-count" id="count-urgent">0</div>
              <div class="inspection-summary-label">Urgent</div>
            </div>
          </div>
        </div>

        <div id="inspection-categories">
          <!-- Fluids Category -->
          <div class="inspection-category expanded" data-category="fluids">
            <div class="inspection-category-header" onclick="toggleInspectionCategory(this)">
              <div class="inspection-category-title">üõ¢Ô∏è Fluids</div>
              <div class="inspection-category-count">5 items</div>
            </div>
            <div class="inspection-category-body">
              <div class="inspection-item" data-field="engine_oil">
                <div class="inspection-item-label">Engine Oil</div>
                <div class="inspection-status-btns">
                  <button class="inspection-status-btn good" onclick="setInspectionStatus(this, 'good')">Good</button>
                  <button class="inspection-status-btn fair" onclick="setInspectionStatus(this, 'fair')">Fair</button>
                  <button class="inspection-status-btn needs_attention" onclick="setInspectionStatus(this, 'needs_attention')">Attention</button>
                  <button class="inspection-status-btn urgent" onclick="setInspectionStatus(this, 'urgent')">Urgent</button>
                  <button class="inspection-status-btn na" onclick="setInspectionStatus(this, 'na')">N/A</button>
                </div>
              </div>
              <div class="inspection-item" data-field="transmission_fluid">
                <div class="inspection-item-label">Transmission Fluid</div>
                <div class="inspection-status-btns">
                  <button class="inspection-status-btn good" onclick="setInspectionStatus(this, 'good')">Good</button>
                  <button class="inspection-status-btn fair" onclick="setInspectionStatus(this, 'fair')">Fair</button>
                  <button class="inspection-status-btn needs_attention" onclick="setInspectionStatus(this, 'needs_attention')">Attention</button>
                  <button class="inspection-status-btn urgent" onclick="setInspectionStatus(this, 'urgent')">Urgent</button>
                  <button class="inspection-status-btn na" onclick="setInspectionStatus(this, 'na')">N/A</button>
                </div>
              </div>
              <div class="inspection-item" data-field="coolant_level">
                <div class="inspection-item-label">Coolant Level</div>
                <div class="inspection-status-btns">
                  <button class="inspection-status-btn good" onclick="setInspectionStatus(this, 'good')">Good</button>
                  <button class="inspection-status-btn fair" onclick="setInspectionStatus(this, 'fair')">Fair</button>
                  <button class="inspection-status-btn needs_attention" onclick="setInspectionStatus(this, 'needs_attention')">Attention</button>
                  <button class="inspection-status-btn urgent" onclick="setInspectionStatus(this, 'urgent')">Urgent</button>
                  <button class="inspection-status-btn na" onclick="setInspectionStatus(this, 'na')">N/A</button>
                </div>
              </div>
              <div class="inspection-item" data-field="brake_fluid">
                <div class="inspection-item-label">Brake Fluid</div>
                <div class="inspection-status-btns">
                  <button class="inspection-status-btn good" onclick="setInspectionStatus(this, 'good')">Good</button>
                  <button class="inspection-status-btn fair" onclick="setInspectionStatus(this, 'fair')">Fair</button>
                  <button class="inspection-status-btn needs_attention" onclick="setInspectionStatus(this, 'needs_attention')">Attention</button>
                  <button class="inspection-status-btn urgent" onclick="setInspectionStatus(this, 'urgent')">Urgent</button>
                  <button class="inspection-status-btn na" onclick="setInspectionStatus(this, 'na')">N/A</button>
                </div>
              </div>
              <div class="inspection-item" data-field="power_steering_fluid">
                <div class="inspection-item-label">Power Steering Fluid</div>
                <div class="inspection-status-btns">
                  <button class="inspection-status-btn good" onclick="setInspectionStatus(this, 'good')">Good</button>
                  <button class="inspection-status-btn fair" onclick="setInspectionStatus(this, 'fair')">Fair</button>
                  <button class="inspection-status-btn needs_attention" onclick="setInspectionStatus(this, 'needs_attention')">Attention</button>
                  <button class="inspection-status-btn urgent" onclick="setInspectionStatus(this, 'urgent')">Urgent</button>
                  <button class="inspection-status-btn na" onclick="setInspectionStatus(this, 'na')">N/A</button>
                </div>
              </div>
            </div>
          </div>

          <!-- Brakes Category -->
          <div class="inspection-category" data-category="brakes">
            <div class="inspection-category-header" onclick="toggleInspectionCategory(this)">
              <div class="inspection-category-title">üõû Brakes</div>
              <div class="inspection-category-count">3 items</div>
            </div>
            <div class="inspection-category-body">
              <div class="inspection-item" data-field="brake_pads_front">
                <div class="inspection-item-label">Front Brake Pads</div>
                <div class="inspection-status-btns">
                  <button class="inspection-status-btn good" onclick="setInspectionStatus(this, 'good')">Good</button>
                  <button class="inspection-status-btn fair" onclick="setInspectionStatus(this, 'fair')">Fair</button>
                  <button class="inspection-status-btn needs_attention" onclick="setInspectionStatus(this, 'needs_attention')">Attention</button>
                  <button class="inspection-status-btn urgent" onclick="setInspectionStatus(this, 'urgent')">Urgent</button>
                  <button class="inspection-status-btn na" onclick="setInspectionStatus(this, 'na')">N/A</button>
                </div>
                <div class="inspection-measurement">
                  <input type="number" id="brake_pads_front_percent" min="0" max="100" placeholder="0">
                  <span>%</span>
                </div>
              </div>
              <div class="inspection-item" data-field="brake_pads_rear">
                <div class="inspection-item-label">Rear Brake Pads</div>
                <div class="inspection-status-btns">
                  <button class="inspection-status-btn good" onclick="setInspectionStatus(this, 'good')">Good</button>
                  <button class="inspection-status-btn fair" onclick="setInspectionStatus(this, 'fair')">Fair</button>
                  <button class="inspection-status-btn needs_attention" onclick="setInspectionStatus(this, 'needs_attention')">Attention</button>
                  <button class="inspection-status-btn urgent" onclick="setInspectionStatus(this, 'urgent')">Urgent</button>
                  <button class="inspection-status-btn na" onclick="setInspectionStatus(this, 'na')">N/A</button>
                </div>
                <div class="inspection-measurement">
                  <input type="number" id="brake_pads_rear_percent" min="0" max="100" placeholder="0">
                  <span>%</span>
                </div>
              </div>
              <div class="inspection-item" data-field="brake_rotors">
                <div class="inspection-item-label">Brake Rotors</div>
                <div class="inspection-status-btns">
                  <button class="inspection-status-btn good" onclick="setInspectionStatus(this, 'good')">Good</button>
                  <button class="inspection-status-btn fair" onclick="setInspectionStatus(this, 'fair')">Fair</button>
                  <button class="inspection-status-btn needs_attention" onclick="setInspectionStatus(this, 'needs_attention')">Attention</button>
                  <button class="inspection-status-btn urgent" onclick="setInspectionStatus(this, 'urgent')">Urgent</button>
                  <button class="inspection-status-btn na" onclick="setInspectionStatus(this, 'na')">N/A</button>
                </div>
              </div>
            </div>
          </div>

          <!-- Tires Category -->
          <div class="inspection-category" data-category="tires">
            <div class="inspection-category-header" onclick="toggleInspectionCategory(this)">
              <div class="inspection-category-title">üöó Tires</div>
              <div class="inspection-category-count">6 items</div>
            </div>
            <div class="inspection-category-body">
              <div class="inspection-item" data-field="tire_front_left">
                <div class="inspection-item-label">Front Left Tire</div>
                <div class="inspection-status-btns">
                  <button class="inspection-status-btn good" onclick="setInspectionStatus(this, 'good')">Good</button>
                  <button class="inspection-status-btn fair" onclick="setInspectionStatus(this, 'fair')">Fair</button>
                  <button class="inspection-status-btn needs_attention" onclick="setInspectionStatus(this, 'needs_attention')">Attention</button>
                  <button class="inspection-status-btn urgent" onclick="setInspectionStatus(this, 'urgent')">Urgent</button>
                  <button class="inspection-status-btn na" onclick="setInspectionStatus(this, 'na')">N/A</button>
                </div>
                <div class="inspection-measurement">
                  <input type="number" id="tire_front_left_tread" min="0" max="12" placeholder="0">
                  <span>/32"</span>
                </div>
              </div>
              <div class="inspection-item" data-field="tire_front_right">
                <div class="inspection-item-label">Front Right Tire</div>
                <div class="inspection-status-btns">
                  <button class="inspection-status-btn good" onclick="setInspectionStatus(this, 'good')">Good</button>
                  <button class="inspection-status-btn fair" onclick="setInspectionStatus(this, 'fair')">Fair</button>
                  <button class="inspection-status-btn needs_attention" onclick="setInspectionStatus(this, 'needs_attention')">Attention</button>
                  <button class="inspection-status-btn urgent" onclick="setInspectionStatus(this, 'urgent')">Urgent</button>
                  <button class="inspection-status-btn na" onclick="setInspectionStatus(this, 'na')">N/A</button>
                </div>
                <div class="inspection-measurement">
                  <input type="number" id="tire_front_right_tread" min="0" max="12" placeholder="0">
                  <span>/32"</span>
                </div>
              </div>
              <div class="inspection-item" data-field="tire_rear_left">
                <div class="inspection-item-label">Rear Left Tire</div>
                <div class="inspection-status-btns">
                  <button class="inspection-status-btn good" onclick="setInspectionStatus(this, 'good')">Good</button>
                  <button class="inspection-status-btn fair" onclick="setInspectionStatus(this, 'fair')">Fair</button>
                  <button class="inspection-status-btn needs_attention" onclick="setInspectionStatus(this, 'needs_attention')">Attention</button>
                  <button class="inspection-status-btn urgent" onclick="setInspectionStatus(this, 'urgent')">Urgent</button>
                  <button class="inspection-status-btn na" onclick="setInspectionStatus(this, 'na')">N/A</button>
                </div>
                <div class="inspection-measurement">
                  <input type="number" id="tire_rear_left_tread" min="0" max="12" placeholder="0">
                  <span>/32"</span>
                </div>
              </div>
              <div class="inspection-item" data-field="tire_rear_right">
                <div class="inspection-item-label">Rear Right Tire</div>
                <div class="inspection-status-btns">
                  <button class="inspection-status-btn good" onclick="setInspectionStatus(this, 'good')">Good</button>
                  <button class="inspection-status-btn fair" onclick="setInspectionStatus(this, 'fair')">Fair</button>
                  <button class="inspection-status-btn needs_attention" onclick="setInspectionStatus(this, 'needs_attention')">Attention</button>
                  <button class="inspection-status-btn urgent" onclick="setInspectionStatus(this, 'urgent')">Urgent</button>
                  <button class="inspection-status-btn na" onclick="setInspectionStatus(this, 'na')">N/A</button>
                </div>
                <div class="inspection-measurement">
                  <input type="number" id="tire_rear_right_tread" min="0" max="12" placeholder="0">
                  <span>/32"</span>
                </div>
              </div>
              <div class="inspection-item" data-field="tire_pressure_ok">
                <div class="inspection-item-label">Tire Pressure</div>
                <div class="inspection-status-btns">
                  <button class="inspection-status-btn good" onclick="setInspectionStatus(this, 'good')">OK</button>
                  <button class="inspection-status-btn needs_attention" onclick="setInspectionStatus(this, 'needs_attention')">Adjusted</button>
                </div>
              </div>
              <div class="inspection-item" data-field="spare_tire">
                <div class="inspection-item-label">Spare Tire</div>
                <div class="inspection-status-btns">
                  <button class="inspection-status-btn good" onclick="setInspectionStatus(this, 'good')">Good</button>
                  <button class="inspection-status-btn fair" onclick="setInspectionStatus(this, 'fair')">Fair</button>
                  <button class="inspection-status-btn needs_attention" onclick="setInspectionStatus(this, 'needs_attention')">Attention</button>
                  <button class="inspection-status-btn urgent" onclick="setInspectionStatus(this, 'urgent')">Urgent</button>
                  <button class="inspection-status-btn na" onclick="setInspectionStatus(this, 'na')">N/A</button>
                </div>
              </div>
            </div>
          </div>

          <!-- Electrical Category -->
          <div class="inspection-category" data-category="electrical">
            <div class="inspection-category-header" onclick="toggleInspectionCategory(this)">
              <div class="inspection-category-title">‚ö° Electrical & Lights</div>
              <div class="inspection-category-count">5 items</div>
            </div>
            <div class="inspection-category-body">
              <div class="inspection-item" data-field="battery">
                <div class="inspection-item-label">Battery</div>
                <div class="inspection-status-btns">
                  <button class="inspection-status-btn good" onclick="setInspectionStatus(this, 'good')">Good</button>
                  <button class="inspection-status-btn fair" onclick="setInspectionStatus(this, 'fair')">Fair</button>
                  <button class="inspection-status-btn needs_attention" onclick="setInspectionStatus(this, 'needs_attention')">Attention</button>
                  <button class="inspection-status-btn urgent" onclick="setInspectionStatus(this, 'urgent')">Urgent</button>
                  <button class="inspection-status-btn na" onclick="setInspectionStatus(this, 'na')">N/A</button>
                </div>
                <div class="inspection-measurement">
                  <input type="number" id="battery_voltage" min="0" max="15" step="0.1" placeholder="12.6">
                  <span>V</span>
                </div>
              </div>
              <div class="inspection-item" data-field="headlights">
                <div class="inspection-item-label">Headlights</div>
                <div class="inspection-status-btns">
                  <button class="inspection-status-btn good" onclick="setInspectionStatus(this, 'good')">Good</button>
                  <button class="inspection-status-btn fair" onclick="setInspectionStatus(this, 'fair')">Fair</button>
                  <button class="inspection-status-btn needs_attention" onclick="setInspectionStatus(this, 'needs_attention')">Attention</button>
                  <button class="inspection-status-btn urgent" onclick="setInspectionStatus(this, 'urgent')">Urgent</button>
                  <button class="inspection-status-btn na" onclick="setInspectionStatus(this, 'na')">N/A</button>
                </div>
              </div>
              <div class="inspection-item" data-field="taillights">
                <div class="inspection-item-label">Taillights</div>
                <div class="inspection-status-btns">
                  <button class="inspection-status-btn good" onclick="setInspectionStatus(this, 'good')">Good</button>
                  <button class="inspection-status-btn fair" onclick="setInspectionStatus(this, 'fair')">Fair</button>
                  <button class="inspection-status-btn needs_attention" onclick="setInspectionStatus(this, 'needs_attention')">Attention</button>
                  <button class="inspection-status-btn urgent" onclick="setInspectionStatus(this, 'urgent')">Urgent</button>
                  <button class="inspection-status-btn na" onclick="setInspectionStatus(this, 'na')">N/A</button>
                </div>
              </div>
              <div class="inspection-item" data-field="turn_signals">
                <div class="inspection-item-label">Turn Signals</div>
                <div class="inspection-status-btns">
                  <button class="inspection-status-btn good" onclick="setInspectionStatus(this, 'good')">Good</button>
                  <button class="inspection-status-btn fair" onclick="setInspectionStatus(this, 'fair')">Fair</button>
                  <button class="inspection-status-btn needs_attention" onclick="setInspectionStatus(this, 'needs_attention')">Attention</button>
                  <button class="inspection-status-btn urgent" onclick="setInspectionStatus(this, 'urgent')">Urgent</button>
                  <button class="inspection-status-btn na" onclick="setInspectionStatus(this, 'na')">N/A</button>
                </div>
              </div>
            </div>
          </div>

          <!-- Belts & Hoses Category -->
          <div class="inspection-category" data-category="belts">
            <div class="inspection-category-header" onclick="toggleInspectionCategory(this)">
              <div class="inspection-category-title">üîó Belts & Hoses</div>
              <div class="inspection-category-count">2 items</div>
            </div>
            <div class="inspection-category-body">
              <div class="inspection-item" data-field="serpentine_belt">
                <div class="inspection-item-label">Serpentine Belt</div>
                <div class="inspection-status-btns">
                  <button class="inspection-status-btn good" onclick="setInspectionStatus(this, 'good')">Good</button>
                  <button class="inspection-status-btn fair" onclick="setInspectionStatus(this, 'fair')">Fair</button>
                  <button class="inspection-status-btn needs_attention" onclick="setInspectionStatus(this, 'needs_attention')">Attention</button>
                  <button class="inspection-status-btn urgent" onclick="setInspectionStatus(this, 'urgent')">Urgent</button>
                  <button class="inspection-status-btn na" onclick="setInspectionStatus(this, 'na')">N/A</button>
                </div>
              </div>
              <div class="inspection-item" data-field="hoses">
                <div class="inspection-item-label">Hoses</div>
                <div class="inspection-status-btns">
                  <button class="inspection-status-btn good" onclick="setInspectionStatus(this, 'good')">Good</button>
                  <button class="inspection-status-btn fair" onclick="setInspectionStatus(this, 'fair')">Fair</button>
                  <button class="inspection-status-btn needs_attention" onclick="setInspectionStatus(this, 'needs_attention')">Attention</button>
                  <button class="inspection-status-btn urgent" onclick="setInspectionStatus(this, 'urgent')">Urgent</button>
                  <button class="inspection-status-btn na" onclick="setInspectionStatus(this, 'na')">N/A</button>
                </div>
              </div>
            </div>
          </div>

          <!-- Wipers & Glass Category -->
          <div class="inspection-category" data-category="wipers">
            <div class="inspection-category-header" onclick="toggleInspectionCategory(this)">
              <div class="inspection-category-title">üåßÔ∏è Wipers & Glass</div>
              <div class="inspection-category-count">2 items</div>
            </div>
            <div class="inspection-category-body">
              <div class="inspection-item" data-field="wiper_blades">
                <div class="inspection-item-label">Wiper Blades</div>
                <div class="inspection-status-btns">
                  <button class="inspection-status-btn good" onclick="setInspectionStatus(this, 'good')">Good</button>
                  <button class="inspection-status-btn fair" onclick="setInspectionStatus(this, 'fair')">Fair</button>
                  <button class="inspection-status-btn needs_attention" onclick="setInspectionStatus(this, 'needs_attention')">Attention</button>
                  <button class="inspection-status-btn urgent" onclick="setInspectionStatus(this, 'urgent')">Urgent</button>
                  <button class="inspection-status-btn na" onclick="setInspectionStatus(this, 'na')">N/A</button>
                </div>
              </div>
              <div class="inspection-item" data-field="windshield">
                <div class="inspection-item-label">Windshield</div>
                <div class="inspection-status-btns">
                  <button class="inspection-status-btn good" onclick="setInspectionStatus(this, 'good')">Good</button>
                  <button class="inspection-status-btn fair" onclick="setInspectionStatus(this, 'fair')">Fair</button>
                  <button class="inspection-status-btn needs_attention" onclick="setInspectionStatus(this, 'needs_attention')">Attention</button>
                  <button class="inspection-status-btn urgent" onclick="setInspectionStatus(this, 'urgent')">Urgent</button>
                  <button class="inspection-status-btn na" onclick="setInspectionStatus(this, 'na')">N/A</button>
                </div>
              </div>
            </div>
          </div>

          <!-- Suspension & Steering Category -->
          <div class="inspection-category" data-category="suspension">
            <div class="inspection-category-header" onclick="toggleInspectionCategory(this)">
              <div class="inspection-category-title">üîß Suspension & Steering</div>
              <div class="inspection-category-count">2 items</div>
            </div>
            <div class="inspection-category-body">
              <div class="inspection-item" data-field="shocks_struts">
                <div class="inspection-item-label">Shocks/Struts</div>
                <div class="inspection-status-btns">
                  <button class="inspection-status-btn good" onclick="setInspectionStatus(this, 'good')">Good</button>
                  <button class="inspection-status-btn fair" onclick="setInspectionStatus(this, 'fair')">Fair</button>
                  <button class="inspection-status-btn needs_attention" onclick="setInspectionStatus(this, 'needs_attention')">Attention</button>
                  <button class="inspection-status-btn urgent" onclick="setInspectionStatus(this, 'urgent')">Urgent</button>
                  <button class="inspection-status-btn na" onclick="setInspectionStatus(this, 'na')">N/A</button>
                </div>
              </div>
              <div class="inspection-item" data-field="alignment">
                <div class="inspection-item-label">Alignment</div>
                <div class="inspection-status-btns">
                  <button class="inspection-status-btn good" onclick="setInspectionStatus(this, 'good')">Good</button>
                  <button class="inspection-status-btn fair" onclick="setInspectionStatus(this, 'fair')">Fair</button>
                  <button class="inspection-status-btn needs_attention" onclick="setInspectionStatus(this, 'needs_attention')">Attention</button>
                  <button class="inspection-status-btn urgent" onclick="setInspectionStatus(this, 'urgent')">Urgent</button>
                  <button class="inspection-status-btn na" onclick="setInspectionStatus(this, 'na')">N/A</button>
                </div>
              </div>
            </div>
          </div>

          <!-- Filters Category -->
          <div class="inspection-category" data-category="filters">
            <div class="inspection-category-header" onclick="toggleInspectionCategory(this)">
              <div class="inspection-category-title">üå¨Ô∏è Filters</div>
              <div class="inspection-category-count">2 items</div>
            </div>
            <div class="inspection-category-body">
              <div class="inspection-item" data-field="air_filter">
                <div class="inspection-item-label">Air Filter</div>
                <div class="inspection-status-btns">
                  <button class="inspection-status-btn good" onclick="setInspectionStatus(this, 'good')">Good</button>
                  <button class="inspection-status-btn fair" onclick="setInspectionStatus(this, 'fair')">Fair</button>
                  <button class="inspection-status-btn needs_attention" onclick="setInspectionStatus(this, 'needs_attention')">Attention</button>
                  <button class="inspection-status-btn urgent" onclick="setInspectionStatus(this, 'urgent')">Urgent</button>
                  <button class="inspection-status-btn na" onclick="setInspectionStatus(this, 'na')">N/A</button>
                </div>
              </div>
              <div class="inspection-item" data-field="cabin_filter">
                <div class="inspection-item-label">Cabin Filter</div>
                <div class="inspection-status-btns">
                  <button class="inspection-status-btn good" onclick="setInspectionStatus(this, 'good')">Good</button>
                  <button class="inspection-status-btn fair" onclick="setInspectionStatus(this, 'fair')">Fair</button>
                  <button class="inspection-status-btn needs_attention" onclick="setInspectionStatus(this, 'needs_attention')">Attention</button>
                  <button class="inspection-status-btn urgent" onclick="setInspectionStatus(this, 'urgent')">Urgent</button>
                  <button class="inspection-status-btn na" onclick="setInspectionStatus(this, 'na')">N/A</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Technician Notes</label>
          <textarea class="form-textarea" id="inspection-notes" placeholder="Add any notes about the vehicle condition, issues found, or work performed..."></textarea>
        </div>

        <div class="form-group">
          <label class="form-label">Recommendations</label>
          <textarea class="form-textarea" id="inspection-recommendations" placeholder="Recommended services, repairs, or follow-up actions..."></textarea>
        </div>

        <div class="form-group">
          <label class="form-label">Photos (optional)</label>
          <input type="file" class="form-input" id="inspection-photos" accept="image/*" multiple>
          <div class="form-hint">Upload photos of any issues found</div>
          <div id="inspection-photo-preview" class="photo-grid" style="margin-top:12px;"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('inspection-modal')">Cancel</button>
        <button class="btn btn-primary" onclick="saveInspectionReport()">üíæ Save Inspection Report</button>
      </div>
    </div>
  </div>

  <!-- Fleet Batch Detail Modal -->
  <div class="modal-backdrop" id="fleet-batch-modal">
    <div class="modal" style="max-width:900px;">
      <div class="modal-header">
        <h3 class="modal-title" id="fleet-batch-modal-title">üì¶ Batch Details</h3>
        <button class="modal-close" onclick="closeModal('fleet-batch-modal')">√ó</button>
      </div>
      <div class="modal-body" id="fleet-batch-modal-body">
        <div class="empty-state"><p>Loading batch details...</p></div>
      </div>
      <div class="modal-footer" id="fleet-batch-modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('fleet-batch-modal')">Close</button>
      </div>
    </div>
  </div>

  <!-- Fleet Bulk Bid Modal -->
  <div class="modal-backdrop" id="fleet-bulk-bid-modal">
    <div class="modal" style="max-width:700px;">
      <div class="modal-header">
        <h3 class="modal-title">üíº Submit Bulk Bid</h3>
        <button class="modal-close" onclick="closeModal('fleet-bulk-bid-modal')">√ó</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="fleet-bid-batch-id">
        
        <div style="background:linear-gradient(135deg, var(--accent-gold-soft), rgba(212,168,85,0.05));border:1px solid rgba(212,168,85,0.3);border-radius:var(--radius-md);padding:16px;margin-bottom:20px;">
          <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
            <span class="fleet-badge" style="background:linear-gradient(135deg, var(--accent-gold), #c49a45);color:#0a0a0f;padding:4px 12px;border-radius:100px;font-size:0.78rem;font-weight:600;">üè¢ Fleet Account</span>
            <span style="color:var(--accent-green);font-size:0.85rem;">‚úì Guaranteed Payment</span>
          </div>
          <div id="fleet-bid-batch-summary" style="font-size:0.9rem;color:var(--text-secondary);"></div>
        </div>

        <div class="form-group">
          <label class="form-label">Pricing Type</label>
          <div style="display:flex;gap:12px;margin-bottom:12px;">
            <label style="display:flex;align-items:center;gap:8px;cursor:pointer;padding:12px 16px;background:var(--bg-input);border:1px solid var(--border-subtle);border-radius:var(--radius-md);flex:1;">
              <input type="radio" name="fleet-pricing-type" value="per_vehicle" checked onchange="updateFleetBidTotal()">
              <div><strong>Per Vehicle</strong><div style="font-size:0.82rem;color:var(--text-muted);">Same price for each</div></div>
            </label>
            <label style="display:flex;align-items:center;gap:8px;cursor:pointer;padding:12px 16px;background:var(--bg-input);border:1px solid var(--border-subtle);border-radius:var(--radius-md);flex:1;">
              <input type="radio" name="fleet-pricing-type" value="flat_rate" onchange="updateFleetBidTotal()">
              <div><strong>Flat Rate</strong><div style="font-size:0.82rem;color:var(--text-muted);">Total for all vehicles</div></div>
            </label>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label" id="fleet-bid-price-label">Price Per Vehicle ($)</label>
            <input type="number" class="form-input" id="fleet-bid-price" placeholder="75.00" min="0" step="0.01" oninput="updateFleetBidTotal()">
          </div>
          <div class="form-group">
            <label class="form-label">Estimated Duration Per Vehicle</label>
            <input type="text" class="form-input" id="fleet-bid-duration" placeholder="45 min - 1 hour">
          </div>
        </div>

        <div class="fleet-bid-calculator">
          <div style="font-weight:600;margin-bottom:12px;">üí∞ Bid Summary</div>
          <div class="fleet-bid-row">
            <span>Vehicles in Batch</span>
            <span id="fleet-bid-vehicle-count">0</span>
          </div>
          <div class="fleet-bid-row">
            <span>Price per Vehicle</span>
            <span id="fleet-bid-per-vehicle">$0.00</span>
          </div>
          <div class="fleet-bid-row" style="border-bottom:2px solid var(--accent-gold);">
            <span style="font-weight:600;">Total Batch Value</span>
            <span class="fleet-bid-total" id="fleet-bid-total">$0.00</span>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Proposed Schedule</label>
          <div class="form-row">
            <div class="form-group" style="margin-bottom:0;">
              <label class="form-label" style="font-size:0.82rem;">Start Date</label>
              <input type="date" class="form-input" id="fleet-bid-start-date">
            </div>
            <div class="form-group" style="margin-bottom:0;">
              <label class="form-label" style="font-size:0.82rem;">End Date</label>
              <input type="date" class="form-input" id="fleet-bid-end-date">
            </div>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Notes for Fleet Manager</label>
          <textarea class="form-textarea" id="fleet-bid-notes" placeholder="Describe your capacity to handle this batch, experience with fleet services, etc."></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('fleet-bulk-bid-modal')">Cancel</button>
        <button class="btn btn-primary" onclick="submitFleetBulkBid()">üíº Submit Bulk Bid</button>
      </div>
    </div>
  </div>

  <!-- Fleet Request Detail Modal -->
  <div class="modal-backdrop" id="fleet-request-modal">
    <div class="modal" style="max-width:800px;">
      <div class="modal-header">
        <h3 class="modal-title" id="fleet-request-modal-title">üìã Fleet Service Request</h3>
        <button class="modal-close" onclick="closeModal('fleet-request-modal')">√ó</button>
      </div>
      <div class="modal-body" id="fleet-request-modal-body">
        <div class="empty-state"><p>Loading request details...</p></div>
      </div>
      <div class="modal-footer" id="fleet-request-modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('fleet-request-modal')">Close</button>
      </div>
    </div>
  </div>

  <div class="toast-container" id="toast-container"></div>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="supabaseclient.js"></script>
  <script src="tos-modal.js"></script>
  <script src="emailService.js"></script>
  <script>
    let currentUser = null;
    let providerProfile = null;
    let openPackages = [];
    let myBids = [];
    let myReviews = [];
    let currentBidPackageId = null;
    let currentMessageMemberId = null;
    let currentMessagePackageId = null;
    let myPayments = [];
    
    // GPS Tracking State
    let activeTrackingPackageId = null;
    let trackingWatchId = null;
    let trackingIntervalId = null;
    let lastTrackingPosition = null;
    
    // Emergency State
    let nearbyEmergencies = [];
    let myActiveEmergency = null;
    let providerLocation = null;

    window.addEventListener('load', async () => {
      try {
        const user = await getCurrentUser();
        if (!user) return window.location.href = 'login.html';
        currentUser = user;

        const { data: profile, error: profileError } = await supabaseClient.from('profiles').select('*').eq('id', user.id).single();
        
        // If no profile exists, create one as provider
        if (profileError || !profile) {
          console.log('No profile found, creating provider profile...');
          const { data: newProfile, error: createError } = await supabaseClient.from('profiles').insert({
            id: user.id,
            email: user.email,
            role: 'provider'
          }).select().single();
          
          if (createError) {
            console.error('Failed to create profile:', createError);
            showToast('Error setting up profile. Please try again.', 'error');
            return;
          }
          providerProfile = newProfile;
        } else if (profile.role !== 'provider' && !profile.is_also_provider) {
          alert('Provider access required.');
          return window.location.href = 'login.html';
        } else {
          providerProfile = profile;
        }

        // Check ToS acceptance before loading dashboard
        const tosAccepted = await TosModal.check(supabaseClient, user.id);
        if (!tosAccepted) {
          TosModal.show(async () => {
            const accepted = await TosModal.accept(supabaseClient, user.id);
            if (accepted) {
              await initializeProviderDashboard(user);
            }
          });
          return;
        }
        
        await initializeProviderDashboard(user);
      } catch (err) {
        console.error('Page initialization error:', err);
        showToast('Error loading page. Check console for details.', 'error');
      }
    });

    async function initializeProviderDashboard(user) {
      // Always show switch portal button for easy navigation between portals
      document.getElementById('switch-portal-container').style.display = 'block';

      // Display business name or full name
      const displayName = providerProfile.business_name || providerProfile.full_name || 'Provider';
      document.getElementById('user-name').textContent = displayName;
      document.getElementById('user-email').textContent = user.email;
      document.getElementById('user-avatar').textContent = displayName[0].toUpperCase();

      await loadOpenPackages();
      await loadMyBids();
      await loadEarnings();
      await loadMyReviews();
      await loadProviderProfile();
      await loadSubscription();
      await loadNotifications();
      await loadPerformance();
      updateStats();
      setupNav();
      
      // Setup emergency settings
      setupEmergencySettings();
      await refreshEmergencies();
      
      // Load destination tasks
      await loadDestinationTasks();
      
      // Check if returning from Stripe checkout
      checkPurchaseStatus();
      
      // Apply initial filters (includes distance)
      applyFilters();
      
      // Setup realtime updates
      setupRealtimeSubscriptions();
    }

    // ========== REALTIME SUBSCRIPTIONS ==========
    let realtimeChannel = null;

    function setupRealtimeSubscriptions() {
      realtimeChannel = supabaseClient.channel('provider-updates')
        
        // New packages posted (for browse)
        .on('postgres_changes', {
          event: 'INSERT',
          schema: 'public',
          table: 'maintenance_packages'
        }, async (payload) => {
          if (payload.new.status === 'open') {
            console.log('[REALTIME] New package posted:', payload.new);
            showToast('üì¶ New package available!', 'success');
            await loadOpenPackages();
            applyFilters();
          }
        })

        // Bid status changes (accepted/rejected)
        .on('postgres_changes', {
          event: 'UPDATE',
          schema: 'public',
          table: 'bids',
          filter: `provider_id=eq.${currentUser.id}`
        }, async (payload) => {
          console.log('[REALTIME] Bid updated:', payload.new);
          if (payload.old.status !== payload.new.status) {
            if (payload.new.status === 'accepted') {
              showToast('üéâ Your bid was accepted!', 'success');
            } else if (payload.new.status === 'rejected') {
              showToast('Your bid was not selected', 'success');
            }
            await loadMyBids();
            updateStats();
          }
        })

        // New messages
        .on('postgres_changes', {
          event: 'INSERT',
          schema: 'public',
          table: 'messages',
          filter: `recipient_id=eq.${currentUser.id}`
        }, async (payload) => {
          console.log('[REALTIME] New message:', payload.new);
          showToast('üí¨ New message from member!', 'success');
          
          // If message modal is open, add message
          if (document.getElementById('message-modal').classList.contains('active')) {
            const msgThread = document.getElementById('message-thread');
            const newMsg = payload.new;
            const msgHtml = `
              <div class="message received">
                <div class="message-bubble">${newMsg.content}</div>
                <div class="message-time">${new Date(newMsg.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</div>
              </div>
            `;
            msgThread.insertAdjacentHTML('beforeend', msgHtml);
            msgThread.scrollTop = msgThread.scrollHeight;
          }
        })

        // New notifications
        .on('postgres_changes', {
          event: 'INSERT',
          schema: 'public',
          table: 'notifications',
          filter: `user_id=eq.${currentUser.id}`
        }, async (payload) => {
          console.log('[REALTIME] New notification:', payload.new);
          await loadNotifications();
        })

        // New reviews
        .on('postgres_changes', {
          event: 'INSERT',
          schema: 'public',
          table: 'provider_reviews',
          filter: `provider_id=eq.${currentUser.id}`
        }, async (payload) => {
          console.log('[REALTIME] New review:', payload.new);
          showToast('‚≠ê You received a new review!', 'success');
          await loadMyReviews();
        })

        // Payment released
        .on('postgres_changes', {
          event: 'UPDATE',
          schema: 'public',
          table: 'payments',
          filter: `provider_id=eq.${currentUser.id}`
        }, async (payload) => {
          if (payload.new.status === 'released' && payload.old.status !== 'released') {
            console.log('[REALTIME] Payment released:', payload.new);
            showToast('üí∞ Payment released to your account!', 'success');
            await loadEarnings();
          }
        })

        .subscribe((status) => {
          console.log('[REALTIME] Subscription status:', status);
          updateRealtimeStatus(status);
        });
    }

    function updateRealtimeStatus(status) {
      const dot = document.getElementById('realtime-dot');
      const text = document.getElementById('realtime-text');
      
      if (status === 'SUBSCRIBED') {
        dot.style.background = 'var(--accent-green)';
        text.textContent = 'Live updates on';
      } else if (status === 'CHANNEL_ERROR') {
        dot.style.background = 'var(--accent-red)';
        text.textContent = 'Connection error';
      } else if (status === 'CLOSED') {
        dot.style.background = 'var(--text-muted)';
        text.textContent = 'Disconnected';
      } else {
        dot.style.background = 'var(--accent-orange)';
        text.textContent = 'Connecting...';
      }
    }

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
      if (realtimeChannel) {
        supabaseClient.removeChannel(realtimeChannel);
      }
    });

    // ========== REVIEWS ==========
    async function loadMyReviews() {
      const { data } = await supabaseClient.from('provider_reviews')
        .select('*')
        .eq('provider_id', currentUser.id)
        .eq('status', 'published')
        .order('created_at', { ascending: false });
      myReviews = data || [];
      
      const suspensionStatus = await isProviderSuspended(currentUser.id);
      if (suspensionStatus.data) {
        const { suspended, reason, suspended_at, current_rating } = suspensionStatus.data;
        
        const suspensionAlert = document.getElementById('suspension-alert');
        const ratingWarning = document.getElementById('rating-warning');
        
        if (suspended) {
          suspensionAlert.style.display = 'block';
          document.getElementById('suspension-reason').textContent = reason || 'Your average rating has dropped below 4 stars.';
          if (suspended_at) {
            document.getElementById('suspension-date').textContent = 'Suspended on: ' + new Date(suspended_at).toLocaleDateString();
          }
          ratingWarning.style.display = 'none';
        } else {
          suspensionAlert.style.display = 'none';
          const avgRating = parseFloat(current_rating) || 0;
          const reviewCount = myReviews.length;
          if (avgRating >= 4.0 && avgRating < 4.3 && reviewCount >= 2) {
            ratingWarning.style.display = 'block';
          } else {
            ratingWarning.style.display = 'none';
          }
        }
      }
      
      renderReviews();
    }

    function renderReviews() {
      // Calculate stats
      const totalReviews = myReviews.length;
      const avgRating = totalReviews ? (myReviews.reduce((sum, r) => sum + r.overall_rating, 0) / totalReviews).toFixed(1) : '--';
      const fiveStarCount = myReviews.filter(r => r.overall_rating === 5).length;
      const fiveStarRate = totalReviews ? Math.round((fiveStarCount / totalReviews) * 100) : 0;

      // Update dashboard stat
      document.getElementById('stat-rating').textContent = avgRating;
      document.getElementById('stat-review-count').textContent = `(${totalReviews} reviews)`;

      // Update reviews section stats
      document.getElementById('reviews-avg-rating').textContent = avgRating;
      document.getElementById('reviews-total-count').textContent = totalReviews;
      document.getElementById('reviews-5-star').textContent = fiveStarRate + '%';

      // Calculate category breakdowns
      if (totalReviews > 0) {
        const avgQuality = (myReviews.reduce((sum, r) => sum + (r.quality_rating || 5), 0) / totalReviews).toFixed(1);
        const avgCommunication = (myReviews.reduce((sum, r) => sum + (r.communication_rating || 5), 0) / totalReviews).toFixed(1);
        const avgTimeliness = (myReviews.reduce((sum, r) => sum + (r.timeliness_rating || 5), 0) / totalReviews).toFixed(1);
        const avgValue = (myReviews.reduce((sum, r) => sum + (r.value_rating || 5), 0) / totalReviews).toFixed(1);

        document.getElementById('breakdown-quality').textContent = avgQuality + ' ‚≠ê';
        document.getElementById('breakdown-communication').textContent = avgCommunication + ' ‚≠ê';
        document.getElementById('breakdown-timeliness').textContent = avgTimeliness + ' ‚≠ê';
        document.getElementById('breakdown-value').textContent = avgValue + ' ‚≠ê';
      }

      // Render reviews list
      const container = document.getElementById('reviews-list');
      if (!myReviews.length) {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚≠ê</div><p>No reviews yet. Complete jobs to receive reviews!</p></div>';
        return;
      }

      container.innerHTML = myReviews.map(r => `
        <div style="padding:20px 0;border-bottom:1px solid var(--border-subtle);">
          <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px;">
            <div>
              <div style="color:var(--accent-gold);font-size:1.1rem;margin-bottom:4px;">
                ${'‚òÖ'.repeat(r.overall_rating)}${'‚òÜ'.repeat(5 - r.overall_rating)}
              </div>
              ${r.review_title ? `<strong style="font-size:1rem;">${r.review_title}</strong>` : ''}
            </div>
            <div style="text-align:right;font-size:0.85rem;color:var(--text-muted);">
              ${new Date(r.created_at).toLocaleDateString()}
              ${r.verified_purchase ? '<span style="color:var(--accent-green);margin-left:8px;">‚úì Verified</span>' : ''}
            </div>
          </div>
          ${r.review_text ? `<p style="color:var(--text-secondary);margin-bottom:12px;">${r.review_text}</p>` : ''}
          <div style="font-size:0.85rem;color:var(--text-muted);">
            ${r.service_type ? `<span style="margin-right:16px;">üîß ${r.service_type}</span>` : ''}
            ${r.vehicle_info ? `<span style="margin-right:16px;">üöó ${r.vehicle_info}</span>` : ''}
            ${r.amount_paid ? `<span>üí∞ $${r.amount_paid.toFixed(2)}</span>` : ''}
          </div>
          ${r.provider_response ? `
            <div style="margin-top:16px;padding:12px 16px;background:var(--bg-input);border-radius:var(--radius-md);border-left:3px solid var(--accent-gold);">
              <div style="font-size:0.82rem;color:var(--text-muted);margin-bottom:4px;">Your Response:</div>
              <p style="margin:0;">${r.provider_response}</p>
            </div>
          ` : `
            <button class="btn btn-ghost btn-sm" style="margin-top:12px;" onclick="respondToReview('${r.id}')">üí¨ Respond to Review</button>
          `}
        </div>
      `).join('');
    }

    async function respondToReview(reviewId) {
      const response = prompt('Your response to this review:');
      if (!response) return;

      await supabaseClient.from('provider_reviews').update({
        provider_response: response,
        provider_responded_at: new Date().toISOString()
      }).eq('id', reviewId);

      showToast('Response submitted!', 'success');
      await loadMyReviews();
    }

    // ========== PERFORMANCE SCORING ==========
    let myPerformance = null;

    function getTierIcon(tier) {
      return {'platinum': 'üíé', 'gold': 'ü•á', 'silver': 'ü•à', 'bronze': 'ü•â'}[tier] || 'ü•â';
    }

    function getTierLabel(tier) {
      return tier ? tier.charAt(0).toUpperCase() + tier.slice(1) : 'Bronze';
    }

    function generateStarsHtml(rating) {
      const fullStars = Math.floor(rating);
      const halfStar = rating % 1 >= 0.5 ? 1 : 0;
      const emptyStars = 5 - fullStars - halfStar;
      return '‚òÖ'.repeat(fullStars) + (halfStar ? '¬Ω' : '') + '‚òÜ'.repeat(emptyStars);
    }

    function formatResponseTime(hours) {
      if (!hours && hours !== 0) return '--';
      if (hours < 1) return `${Math.round(hours * 60)}min`;
      if (hours < 24) return `${Math.round(hours)}hr`;
      return `${Math.round(hours / 24)}d`;
    }

    function getPerformanceTips(perf) {
      const tips = [];
      if (!perf) {
        tips.push({ icon: 'üí°', text: 'Start bidding on packages to build your performance record and earn badges!' });
        return tips;
      }
      if (perf.jobs_completed < 5) {
        tips.push({ icon: 'üöÄ', text: 'Complete more jobs to improve your experience score. Each completed job boosts your overall rating!' });
      }
      if (perf.rating_avg && perf.rating_avg < 4.5) {
        tips.push({ icon: '‚≠ê', text: 'Focus on quality service to improve your rating. Aim for 4.8+ to earn the Top Rated badge!' });
      }
      if (perf.avg_response_time_hours && perf.avg_response_time_hours > 2) {
        tips.push({ icon: '‚ö°', text: 'Respond to bid requests faster! Under 2 hours average earns you the Quick Responder badge.' });
      }
      if (perf.on_time_rate && perf.on_time_rate < 90) {
        tips.push({ icon: '‚è∞', text: 'Improve your on-time completion rate. Reliable providers earn more repeat customers!' });
      }
      if (perf.acceptance_rate && perf.acceptance_rate < 30) {
        tips.push({ icon: 'üìù', text: 'Your bid acceptance rate is low. Try competitive pricing or highlight your specialties.' });
      }
      if (tips.length === 0) {
        tips.push({ icon: 'üéâ', text: 'Great job! Keep up the excellent work to maintain your performance tier.' });
      }
      return tips;
    }

    async function loadPerformance() {
      try {
        // First, try to get existing performance data
        const { data: existing } = await getProviderPerformance(currentUser.id);
        
        if (existing) {
          myPerformance = existing;
        } else {
          // Calculate and create performance data
          const { data: calculated } = await calculateProviderPerformance(currentUser.id);
          myPerformance = calculated;
        }
        
        renderPerformance();
      } catch (err) {
        console.error('Error loading performance:', err);
        renderPerformance();
      }
    }

    async function refreshPerformance() {
      showToast('Calculating performance...', 'success');
      const { data, error } = await calculateProviderPerformance(currentUser.id);
      if (error) {
        console.error('Error calculating performance:', error);
        showToast('Error updating performance', 'error');
        return;
      }
      myPerformance = data;
      renderPerformance();
      showToast('Performance updated!', 'success');
    }

    function renderPerformance() {
      const perf = myPerformance;
      
      // Overall Score
      const scoreEl = document.getElementById('perf-overall-score');
      scoreEl.textContent = perf ? Math.round(perf.overall_score) : '--';
      
      // Tier badge
      const tier = perf?.tier || 'bronze';
      const tierBadge = document.getElementById('perf-tier-badge');
      tierBadge.className = `performance-tier-badge ${tier}`;
      tierBadge.querySelector('span:first-child').textContent = getTierIcon(tier);
      document.getElementById('perf-tier-text').textContent = getTierLabel(tier);
      
      // Update score display border based on tier
      const scoreDisplay = document.getElementById('perf-score-display');
      const tierColors = {
        platinum: '#e5e4e2',
        gold: 'var(--accent-gold)',
        silver: '#c0c0c0',
        bronze: '#cd7f32'
      };
      scoreDisplay.style.borderColor = tierColors[tier] || tierColors.bronze;
      document.getElementById('perf-overall-score').style.color = tierColors[tier] || tierColors.bronze;
      
      // Metrics
      if (perf) {
        document.getElementById('perf-rating').textContent = perf.rating_avg ? perf.rating_avg.toFixed(1) : '--';
        document.getElementById('perf-stars').innerHTML = perf.rating_avg ? generateStarsHtml(perf.rating_avg) : '';
        document.getElementById('perf-jobs-completed').textContent = perf.jobs_completed || 0;
        document.getElementById('perf-on-time').textContent = perf.jobs_completed > 0 ? `${Math.round(perf.on_time_rate)}%` : '--';
        document.getElementById('perf-response-time').textContent = formatResponseTime(perf.avg_response_time_hours);
        document.getElementById('perf-acceptance-rate').textContent = perf.bids_submitted > 0 ? `${Math.round(perf.acceptance_rate)}%` : '--';
        document.getElementById('perf-bids-submitted').textContent = perf.bids_submitted || 0;
      }
      
      // Badges
      const badges = perf?.badges || [];
      document.querySelectorAll('#perf-badges-grid .performance-badge').forEach(badgeEl => {
        const badgeName = badgeEl.dataset.badge;
        if (badges.includes(badgeName)) {
          badgeEl.classList.add('earned');
          badgeEl.classList.remove('locked');
        } else {
          badgeEl.classList.remove('earned');
          badgeEl.classList.add('locked');
        }
      });
      
      // Performance Tips
      const tips = getPerformanceTips(perf);
      const tipsContainer = document.getElementById('perf-tips');
      tipsContainer.innerHTML = tips.map(tip => `
        <div class="performance-tip">
          <span class="performance-tip-icon">${tip.icon}</span>
          <div class="performance-tip-text">${tip.text}</div>
        </div>
      `).join('');
    }

    async function loadEarnings() {
      const { data } = await supabaseClient.from('payments')
        .select('*, maintenance_packages(title)')
        .eq('provider_id', currentUser.id)
        .order('created_at', { ascending: false });
      myPayments = data || [];
      renderEarnings();
    }

    function renderEarnings() {
      const pending = myPayments.filter(p => p.status === 'held').reduce((sum, p) => sum + (p.amount_provider || 0), 0);
      const released = myPayments.filter(p => p.status === 'released').reduce((sum, p) => sum + (p.amount_provider || 0), 0);
      const total = myPayments.filter(p => p.status === 'released').reduce((sum, p) => sum + (p.amount_provider || 0), 0);

      document.getElementById('earnings-pending').textContent = '$' + pending.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
      document.getElementById('earnings-released').textContent = '$' + released.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
      document.getElementById('earnings-total').textContent = '$' + total.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});

      const container = document.getElementById('earnings-list');
      if (!myPayments.length) {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üí∞</div><p>No payments yet. Complete jobs to see your earnings!</p></div>';
        return;
      }

      container.innerHTML = myPayments.map(p => `
        <div style="display:flex;justify-content:space-between;align-items:center;padding:16px;border-bottom:1px solid var(--border-subtle);">
          <div>
            <div style="font-weight:500;">${p.maintenance_packages?.title || 'Package'}</div>
            <div style="font-size:0.85rem;color:var(--text-muted);">${new Date(p.created_at).toLocaleDateString()}</div>
          </div>
          <div style="text-align:right;">
            <div style="font-weight:600;color:${p.status === 'released' ? 'var(--accent-green)' : p.status === 'held' ? 'var(--accent-blue)' : 'var(--text-muted)'};">
              ${p.status === 'released' ? '+' : ''}$${(p.amount_provider || 0).toFixed(2)}
            </div>
            <div style="font-size:0.8rem;color:var(--text-muted);">
              ${p.status === 'held' ? '‚è≥ In Escrow' : p.status === 'released' ? '‚úì Released' : p.status === 'refunded' ? '‚Ü© Refunded' : p.status}
            </div>
          </div>
        </div>
      `).join('');
    }

    function setupNav() {
      document.querySelectorAll('.nav-item[data-section]').forEach(item => {
        item.addEventListener('click', () => showSection(item.dataset.section));
      });
    }

    function showSection(id) {
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
      document.querySelector(`.nav-item[data-section="${id}"]`)?.classList.add('active');
      document.getElementById('sidebar').classList.remove('open');
      
      // Load team members when team section is shown
      if (id === 'team') {
        loadTeamMembers();
      }
      // Load destination tasks when section is shown
      if (id === 'destination-tasks') {
        loadDestinationTasks();
      }
    }

    async function loadOpenPackages() {
      try {
        const { data, error } = await supabaseClient.from('maintenance_packages').select('*, vehicles(year, make, model, nickname, vin)').eq('status', 'open').order('created_at', { ascending: false });
        if (error) {
          console.error('Error loading packages:', error);
          openPackages = [];
        } else {
          openPackages = data || [];
          
          // Load bid stats for each package
          if (openPackages.length > 0) {
            const packageIds = openPackages.map(p => p.id);
            const { data: allBids } = await supabaseClient
              .from('bids')
              .select('package_id, price, provider_id')
              .in('package_id', packageIds)
              .eq('status', 'pending');
            
            // Attach bid stats to each package
            openPackages.forEach(p => {
              const packageBids = allBids?.filter(b => b.package_id === p.id) || [];
              p._bidCount = packageBids.length;
              p._lowestBid = packageBids.length > 0 ? Math.min(...packageBids.map(b => b.price)) : null;
              p._myBid = packageBids.find(b => b.provider_id === currentUser?.id);
            });
            
            // Fetch destination service data for destination_service packages
            const destServicePackages = openPackages.filter(p => p.category === 'destination_service');
            if (destServicePackages.length > 0) {
              const destPackageIds = destServicePackages.map(p => p.id);
              const { data: destServices } = await supabaseClient
                .from('destination_services')
                .select('*')
                .in('package_id', destPackageIds);
              
              if (destServices) {
                openPackages.forEach(p => {
                  if (p.category === 'destination_service') {
                    p._destinationService = destServices.find(ds => ds.package_id === p.id);
                  }
                });
              }
            }
          }
        }
        
        // Show location warning if provider hasn't set their ZIP
        const locationWarning = document.getElementById('location-warning');
        if (!providerProfile?.zip_code) {
          locationWarning.style.display = 'block';
        } else {
          locationWarning.style.display = 'none';
        }
        
        renderOpenPackages();
        renderRecentPackages();
        document.getElementById('open-count').textContent = openPackages.length;
      } catch (err) {
        console.error('loadOpenPackages error:', err);
        openPackages = [];
        renderOpenPackages();
      }
    }

    async function loadMyBids() {
      try {
        const { data, error } = await supabaseClient.from('bids').select('*, maintenance_packages(title, status, member_id, vehicles(year, make, model))').eq('provider_id', currentUser.id).order('created_at', { ascending: false });
        if (error) {
          console.error('Error loading bids:', error);
          myBids = [];
        } else {
          myBids = data || [];
        }
        renderMyBids();
        renderActiveJobs();
      } catch (err) {
        console.error('loadMyBids error:', err);
        myBids = [];
        renderMyBids();
      }
    }

    function updateStats() {
      document.getElementById('stat-open').textContent = openPackages.length;
      document.getElementById('stat-bids').textContent = myBids.filter(b => b.status === 'pending').length;
      document.getElementById('stat-won').textContent = myBids.filter(b => b.status === 'accepted').length;
      
      // Update bid credits display
      const totalCredits = (providerProfile?.bid_credits || 0) + (providerProfile?.free_trial_bids || 0);
      document.getElementById('stat-credits').textContent = totalCredits;
      document.getElementById('dashboard-bid-credits').textContent = totalCredits;
      document.getElementById('browse-credits-count').textContent = totalCredits;
      
      // Update members nearby count (estimate based on open packages)
      const uniqueMembers = new Set(openPackages.map(p => p.member_id)).size;
      document.getElementById('stat-members-nearby').textContent = uniqueMembers;
    }

    function renderOpenPackages(filtered = null) {
      const container = document.getElementById('open-packages');
      const packagesToRender = filtered || openPackages;
      
      if (!packagesToRender.length) {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì¶</div><p>No packages match your filters. Try adjusting your criteria.</p></div>';
        document.getElementById('filter-results-info').textContent = '';
        return;
      }
      
      // Update results info
      if (filtered && filtered.length !== openPackages.length) {
        document.getElementById('filter-results-info').textContent = `Showing ${filtered.length} of ${openPackages.length} packages`;
      } else {
        document.getElementById('filter-results-info').textContent = `${packagesToRender.length} open packages`;
      }
      
      container.innerHTML = packagesToRender.map(p => renderPackageCard(p, true)).join('');
    }

    function applyFilters() {
      const distance = document.getElementById('filter-distance').value;
      const category = document.getElementById('filter-category').value;
      const urgency = document.getElementById('filter-urgency').value;
      const parts = document.getElementById('filter-parts').value;
      const sort = document.getElementById('filter-sort').value;

      let filtered = [...openPackages];

      // Filter by distance (requires both provider and member ZIP codes)
      if (distance && providerProfile?.zip_code) {
        filtered = filtered.filter(p => {
          if (!p.member_zip) return true; // Show packages without location (legacy)
          const dist = estimateZipDistance(providerProfile.zip_code, p.member_zip);
          p._estimatedDistance = dist; // Store for display and sorting
          return dist <= parseInt(distance);
        });
      } else {
        // Calculate distance for display even if not filtering
        filtered.forEach(p => {
          if (p.member_zip && providerProfile?.zip_code) {
            p._estimatedDistance = estimateZipDistance(providerProfile.zip_code, p.member_zip);
          }
        });
      }

      // Filter by category
      if (category) {
        filtered = filtered.filter(p => p.category === category);
      }

      // Filter by urgency (time until deadline)
      if (urgency) {
        const now = new Date();
        filtered = filtered.filter(p => {
          if (!p.bidding_deadline) return urgency === 'flexible';
          const deadline = new Date(p.bidding_deadline);
          const hoursLeft = (deadline - now) / (1000 * 60 * 60);
          
          if (urgency === 'urgent') return hoursLeft > 0 && hoursLeft <= 24;
          if (urgency === 'soon') return hoursLeft > 0 && hoursLeft <= 72;
          if (urgency === 'flexible') return hoursLeft > 72;
          return true;
        });
      }

      // Filter by parts preference
      if (parts) {
        filtered = filtered.filter(p => p.parts_preference === parts);
      }

      // Sort
      if (sort === 'nearest') {
        filtered.sort((a, b) => (a._estimatedDistance || 999) - (b._estimatedDistance || 999));
      } else if (sort === 'newest') {
        filtered.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
      } else if (sort === 'oldest') {
        filtered.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
      } else if (sort === 'ending') {
        filtered.sort((a, b) => {
          const aDeadline = a.bidding_deadline ? new Date(a.bidding_deadline) : new Date('2099-12-31');
          const bDeadline = b.bidding_deadline ? new Date(b.bidding_deadline) : new Date('2099-12-31');
          return aDeadline - bDeadline;
        });
      }

      renderOpenPackages(filtered);
    }

    // Simple ZIP code distance estimator (uses first 3 digits for rough region)
    // For production, use a proper ZIP code database or API
    function estimateZipDistance(zip1, zip2) {
      if (!zip1 || !zip2) return 999;
      
      // Same ZIP = 0 miles
      if (zip1 === zip2) return 0;
      
      // Same first 3 digits = roughly same area (0-25 miles)
      if (zip1.substring(0, 3) === zip2.substring(0, 3)) {
        return Math.abs(parseInt(zip1) - parseInt(zip2)) * 0.5; // Rough estimate
      }
      
      // Different first 3 digits - use a rough approximation based on ZIP difference
      const diff = Math.abs(parseInt(zip1.substring(0, 3)) - parseInt(zip2.substring(0, 3)));
      
      // Very rough estimate: each ZIP prefix represents ~20-50 miles
      if (diff <= 2) return 15 + (diff * 10);
      if (diff <= 5) return 30 + (diff * 8);
      if (diff <= 10) return 50 + (diff * 5);
      return 100 + (diff * 3);
    }

    function clearFilters() {
      document.getElementById('filter-distance').value = '';
      document.getElementById('filter-category').value = '';
      document.getElementById('filter-urgency').value = '';
      document.getElementById('filter-parts').value = '';
      document.getElementById('filter-sort').value = 'nearest';
      applyFilters();
    }

    function renderRecentPackages() {
      const container = document.getElementById('recent-packages');
      const recent = openPackages.slice(0, 3);
      if (!recent.length) {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì¶</div><p>No open packages.</p></div>';
        return;
      }
      container.innerHTML = recent.map(p => renderPackageCard(p, true)).join('');
    }

    function renderPackageCard(p, showBidButton = false) {
      const vehicle = p.vehicles;
      const vehicleName = vehicle ? (vehicle.nickname || `${vehicle.year || ''} ${vehicle.make} ${vehicle.model}`.trim()) : 'Vehicle';
      const isRecurring = p.frequency && p.frequency !== 'one_time';
      const alreadyBid = myBids.some(b => b.package_id === p.id) || p._myBid;
      const myCurrentBid = p._myBid || myBids.find(b => b.package_id === p.id);
      const vinDisplay = vehicle?.vin ? `<span title="${vehicle.vin}">üîñ VIN: ...${vehicle.vin.slice(-6)}</span>` : '';
      
      // Location display
      const locationDisplay = p.member_city && p.member_state 
        ? `${p.member_city}, ${p.member_state}` 
        : (p.member_zip || 'Location N/A');
      const distanceDisplay = p._estimatedDistance !== undefined 
        ? `~${Math.round(p._estimatedDistance)} mi` 
        : '';
      
      // Check bidding deadline
      const countdown = p.bidding_deadline ? formatCountdown(p.bidding_deadline) : null;
      const biddingExpired = countdown?.expired || false;
      const countdownHtml = countdown ? `
        <div class="countdown-timer ${countdown.expired ? 'expired' : countdown.urgent ? 'urgent' : ''}" style="margin-top:8px;">
          ‚è±Ô∏è ${countdown.text}
        </div>
      ` : '';
      
      // Competition info
      const bidCount = p._bidCount || 0;
      const lowestBid = p._lowestBid;
      const isLowestBidder = myCurrentBid && lowestBid && myCurrentBid.price <= lowestBid;
      const canBeatLowest = myCurrentBid && lowestBid && myCurrentBid.price > lowestBid;
      
      const competitionHtml = bidCount > 0 ? `
        <div style="margin-top:10px;padding:10px;background:var(--bg-elevated);border-radius:var(--radius-md);border:1px solid var(--border-subtle);">
          <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px;">
            <span style="font-size:0.85rem;">üèÜ <strong>${bidCount}</strong> bid${bidCount !== 1 ? 's' : ''} ${lowestBid ? `‚Ä¢ Lowest: <strong style="color:var(--accent-gold);">$${lowestBid}</strong>` : ''}</span>
            ${isLowestBidder ? '<span style="color:var(--accent-green);font-size:0.8rem;">‚úì You\'re the lowest!</span>' : ''}
            ${canBeatLowest ? '<span style="color:var(--accent-orange);font-size:0.8rem;">‚ö° You can beat this!</span>' : ''}
          </div>
        </div>
      ` : '';
      
      // Destination service info for destination_service packages
      const destService = p._destinationService;
      let destinationBadgeHtml = '';
      let destinationInfoHtml = '';
      
      if (p.category === 'destination_service' && destService) {
        const dsIcon = getDestinationServiceIcon(destService.service_type);
        const dsLabel = getDestinationServiceLabel(destService.service_type);
        const pickup = destService.pickup_location || 'TBD';
        const dropoff = destService.dropoff_location || 'TBD';
        
        // Get appropriate datetime based on service type
        let serviceTime = '';
        if (destService.service_type === 'airport' && destService.flight_datetime) {
          serviceTime = formatDestinationDateTime(destService.flight_datetime);
        } else if (destService.service_type === 'dealership' && destService.appointment_datetime) {
          serviceTime = formatDestinationDateTime(destService.appointment_datetime);
        } else if (destService.service_type === 'valet' && destService.event_datetime) {
          serviceTime = formatDestinationDateTime(destService.event_datetime);
        } else if (destService.event_datetime) {
          serviceTime = formatDestinationDateTime(destService.event_datetime);
        }
        
        destinationBadgeHtml = `<span class="package-badge" style="background:var(--accent-blue-soft);color:var(--accent-blue);">${dsIcon} ${dsLabel}</span>`;
        
        destinationInfoHtml = `
          <div style="margin-top:12px;padding:12px 16px;background:var(--accent-blue-soft);border-radius:var(--radius-md);border:1px solid rgba(74, 124, 255, 0.2);">
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;">
              <span style="font-size:1.1rem;">${dsIcon}</span>
              <strong style="color:var(--accent-blue);">${dsLabel}</strong>
            </div>
            <div style="font-size:0.88rem;color:var(--text-secondary);margin-bottom:4px;">
              üìç <span style="color:var(--text-primary);">${pickup}</span> ‚Üí <span style="color:var(--text-primary);">${dropoff}</span>
            </div>
            ${serviceTime ? `<div style="font-size:0.85rem;color:var(--text-muted);">üïê ${serviceTime}</div>` : ''}
          </div>
        `;
      } else if (p.category === 'destination_service') {
        destinationBadgeHtml = '<span class="package-badge" style="background:var(--accent-blue-soft);color:var(--accent-blue);">üìç Destination Service</span>';
      }

      return `
        <div class="package-card">
          <div class="package-header">
            <div>
              <div class="package-title">${p.title}</div>
              <div class="package-vehicle">${vehicleName}</div>
            </div>
            <div style="text-align:right;">
              ${destinationBadgeHtml}
              ${isRecurring ? '<span class="package-badge recurring">Recurring</span>' : ''}
              <span class="package-badge open">Open</span>
              ${countdownHtml}
            </div>
          </div>
          ${destinationInfoHtml}
          <div class="package-meta">
            <span style="color:var(--accent-gold);font-weight:500;">üìç ${locationDisplay} ${distanceDisplay ? `(${distanceDisplay})` : ''}</span>
            <span>üìÖ ${new Date(p.created_at).toLocaleDateString()}</span>
            ${p.category ? `<span>üè∑Ô∏è ${formatCategory(p.category)}</span>` : ''}
            <span>üîÑ ${formatFrequency(p.frequency)}</span>
            <span>üîß ${p.parts_preference || 'Standard'} parts</span>
            <span>üöó ${formatPickup(p.pickup_preference)}</span>
            ${vinDisplay}
          </div>
          ${competitionHtml}
          ${p.description ? `<div class="package-description">${p.description.slice(0, 200)}${p.description.length > 200 ? '...' : ''}</div>` : ''}
          <div class="package-footer">
            <button class="btn btn-secondary btn-sm" onclick="viewPackageDetails('${p.id}')">View Details</button>
            ${showBidButton && !biddingExpired ? `
              ${alreadyBid ? `
                <span style="color:var(--accent-green);font-size:0.85rem;margin-right:8px;">‚úì Your bid: $${myCurrentBid?.price || '?'}</span>
                <button class="btn btn-primary btn-sm" onclick="openBidModal('${p.id}', '${p.title.replace(/'/g, "\\'")}', ${myCurrentBid?.price || 0})">Update Bid</button>
              ` : `
                <button class="btn btn-primary btn-sm" onclick="openBidModal('${p.id}', '${p.title.replace(/'/g, "\\'")}')">Submit Bid</button>
              `}
            ` : ''}
            ${biddingExpired && !alreadyBid ? '<span style="color:var(--text-muted);font-size:0.85rem;">Bidding closed</span>' : ''}
          </div>
        </div>
      `;
    }

    function formatCountdown(deadline) {
      const now = new Date();
      const end = new Date(deadline);
      const diff = end - now;
      
      if (diff <= 0) return { text: 'Bidding closed', expired: true, urgent: false };
      
      const days = Math.floor(diff / (1000 * 60 * 60 * 24));
      const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
      const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
      
      let text = '';
      if (days > 0) {
        text = `${days}d ${hours}h left`;
      } else if (hours > 0) {
        text = `${hours}h ${minutes}m left`;
      } else {
        text = `${minutes}m left`;
      }
      
      return { 
        text, 
        expired: false, 
        urgent: diff < 4 * 60 * 60 * 1000 // Less than 4 hours
      };
    }

    function formatCategory(cat) {
      const map = { maintenance: 'Maintenance', detailing: 'Detailing', cosmetic: 'Cosmetic', accident_repair: 'Accident Repair', destination_service: 'Destination Service', other: 'Other' };
      return map[cat] || cat || 'General';
    }

    async function fetchDestinationServiceDetails(packageId) {
      const { data, error } = await supabaseClient
        .from('destination_services')
        .select('*')
        .eq('package_id', packageId)
        .single();
      return { data, error };
    }

    function getDestinationServiceIcon(serviceType) {
      const icons = { airport: '‚úàÔ∏è', dealership: 'üè¢', detailing: '‚ú®', valet: 'üîë' };
      return icons[serviceType] || 'üìç';
    }

    function getDestinationServiceLabel(serviceType) {
      const labels = { airport: 'Airport Service', dealership: 'Dealership Service', detailing: 'Detailing Service', valet: 'Valet Service' };
      return labels[serviceType] || 'Destination Service';
    }

    function formatDestinationDateTime(datetime) {
      if (!datetime) return 'Not specified';
      const d = new Date(datetime);
      return d.toLocaleString(undefined, { 
        weekday: 'short', 
        month: 'short', 
        day: 'numeric', 
        hour: 'numeric', 
        minute: '2-digit'
      });
    }

    function renderMyBids() {
      const container = document.getElementById('my-bids');
      const pending = myBids.filter(b => b.status === 'pending' || b.status === 'rejected');
      if (!pending.length) {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üí¨</div><p>No pending bids. Browse packages to submit bids!</p></div>';
        return;
      }
      container.innerHTML = pending.map(b => `
        <div class="bid-card">
          <div class="bid-header">
            <div class="bid-package">${b.maintenance_packages?.title || 'Package'}</div>
            <span class="bid-status ${b.status}">${b.status}</span>
          </div>
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <div class="bid-meta">Submitted ${new Date(b.created_at).toLocaleDateString()}</div>
            <div class="bid-amount">$${(b.price || 0).toFixed(2)}</div>
          </div>
          ${b.status === 'pending' ? `<div style="margin-top:12px;"><button class="btn btn-secondary btn-sm" onclick="openMessageWithMember('${b.package_id}', '${b.maintenance_packages?.member_id}')">üí¨ Message Member</button></div>` : ''}
        </div>
      `).join('');
    }

    async function renderActiveJobs() {
      const container = document.getElementById('active-jobs');
      const active = myBids.filter(b => b.status === 'accepted');
      if (!active.length) {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚úì</div><p>No active jobs yet. Keep bidding!</p></div>';
        return;
      }
      
      container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚è≥</div><p>Loading job details...</p></div>';
      
      const jobCards = await Promise.all(active.map(async b => {
        const pkg = b.maintenance_packages;
        const pkgStatus = pkg?.status || 'accepted';
        const vehicleName = pkg?.vehicles ? `${pkg.vehicles.year} ${pkg.vehicles.make} ${pkg.vehicles.model}` : 'Vehicle';
        
        let appointment = null;
        let transfer = null;
        let memberLocation = null;
        
        try {
          const [apptResult, transferResult, locationResult] = await Promise.all([
            window.getAppointment(b.package_id),
            window.getVehicleTransfer(b.package_id),
            window.getActiveLocationShare(b.package_id)
          ]);
          appointment = apptResult.data;
          transfer = transferResult.data;
          memberLocation = locationResult.data;
        } catch (e) {
          console.log('Error loading logistics data:', e);
        }
        
        return renderJobDashboard(b, pkg, pkgStatus, vehicleName, appointment, transfer, memberLocation);
      }));
      
      container.innerHTML = jobCards.join('');
    }
    
    async function renderJobDashboard(bid, pkg, pkgStatus, vehicleName, appointment, transfer, memberLocation) {
      const packageId = bid.package_id;
      const memberId = pkg?.member_id;
      const providerId = currentUser.id;
      const vehicleId = pkg?.vehicle_id;
      
      const schedulingHtml = renderSchedulingSection(packageId, memberId, providerId, appointment);
      const transferHtml = renderTransferSection(packageId, transfer);
      const locationHtml = renderLocationSection(packageId, memberId, memberLocation);
      const evidenceHtml = await renderEvidenceSection(packageId);
      const keyExchangeHtml = await renderKeyExchangeSection(packageId);
      
      const statusBadge = pkgStatus === 'in_progress' ? 'In Progress' : pkgStatus === 'completed' ? 'Completed' : 'Accepted';
      const statusClass = pkgStatus === 'in_progress' ? 'pending' : 'accepted';
      
      return `
        <div class="job-dashboard">
          <div class="job-dashboard-header">
            <div>
              <div class="job-dashboard-title">${pkg?.title || 'Package'}</div>
              <div class="job-dashboard-vehicle">üöó ${vehicleName}</div>
            </div>
            <div style="text-align:right;">
              <div class="job-dashboard-price">$${(bid.price || 0).toFixed(2)}</div>
              <span class="bid-status ${statusClass}">${statusBadge}</span>
            </div>
          </div>
          
          ${pkgStatus === 'accepted' ? `
            <div class="alert" style="background:var(--accent-blue-soft);border:1px solid rgba(74,124,255,0.3);color:var(--accent-blue);margin-bottom:16px;padding:12px;border-radius:var(--radius-md);font-size:0.88rem;">
              üí∞ Payment is held in escrow. Coordinate with member and start work when ready!
            </div>
          ` : ''}
          
          ${schedulingHtml}
          ${transferHtml}
          ${locationHtml}
          ${keyExchangeHtml}
          ${evidenceHtml}
          
          <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:16px;padding-top:16px;border-top:1px solid var(--border-subtle);">
            <button class="btn btn-primary btn-sm" onclick="openMessageWithMember('${packageId}', '${memberId}')">üí¨ Contact Member</button>
            <button class="inspection-btn" onclick="openInspectionModal('${packageId}', '${vehicleId}')">üîç Inspection Report</button>
            ${pkgStatus === 'accepted' ? `
              <button class="btn btn-secondary btn-sm" style="background:var(--accent-green);color:#fff;border:none;" onclick="markWorkStarted('${packageId}')">‚ñ∂Ô∏è Start Work</button>
            ` : pkgStatus === 'in_progress' ? `
              <button class="btn btn-secondary btn-sm" style="background:var(--accent-green);color:#fff;border:none;" onclick="markJobComplete('${packageId}')">‚úì Mark Complete</button>
              <button class="btn btn-secondary btn-sm" onclick="openUpsellModal('${packageId}', '${memberId}')">‚ö†Ô∏è Report Issue</button>
            ` : ''}
          </div>
        </div>
      `;
    }
    
    function renderSchedulingSection(packageId, memberId, providerId, appointment) {
      if (!appointment) {
        return `
          <div class="logistics-section">
            <div class="logistics-section-header">
              <div class="logistics-section-title">üìÖ Service Scheduling</div>
            </div>
            <div class="logistics-section-content">
              <p style="margin-bottom:12px;">No appointment scheduled yet. Propose a date and time for the service.</p>
              <button class="btn btn-primary btn-sm" onclick="openProviderScheduleModal('${packageId}', '${memberId}', '${providerId}')">üìÖ Propose Appointment</button>
            </div>
          </div>
        `;
      }
      
      const proposedDate = appointment.proposed_date ? new Date(appointment.proposed_date).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }) : 'TBD';
      const timeRange = appointment.proposed_time_start && appointment.proposed_time_end ? `${appointment.proposed_time_start} - ${appointment.proposed_time_end}` : (appointment.proposed_time_start || 'Flexible');
      const status = appointment.status || 'proposed';
      const proposedBy = appointment.proposed_by === 'member' ? 'Member' : 'You';
      
      let actionHtml = '';
      if (status === 'proposed' && appointment.proposed_by === 'member') {
        actionHtml = `
          <div style="display:flex;gap:8px;margin-top:12px;">
            <button class="btn btn-primary btn-sm" onclick="confirmScheduleFromProvider('${appointment.id}', '${packageId}')">‚úì Confirm</button>
            <button class="btn btn-secondary btn-sm" onclick="proposeNewTimeFromProvider('${appointment.id}', '${packageId}')">üîÑ Suggest Different Time</button>
          </div>
        `;
      } else if (status === 'rescheduled' && appointment.counter_proposed_by === 'member') {
        const counterDate = appointment.counter_proposed_date ? new Date(appointment.counter_proposed_date).toLocaleDateString() : '';
        actionHtml = `
          <div style="background:var(--accent-blue-soft);padding:12px;border-radius:var(--radius-md);margin-top:12px;">
            <strong>Member proposed: ${counterDate}</strong>
            ${appointment.counter_notes ? `<p style="margin-top:4px;font-size:0.85rem;">${appointment.counter_notes}</p>` : ''}
            <div style="display:flex;gap:8px;margin-top:8px;">
              <button class="btn btn-primary btn-sm" onclick="acceptCounterFromProvider('${appointment.id}', '${packageId}')">‚úì Accept</button>
              <button class="btn btn-secondary btn-sm" onclick="proposeNewTimeFromProvider('${appointment.id}', '${packageId}')">üîÑ Counter</button>
            </div>
          </div>
        `;
      } else if (status === 'proposed' || status === 'rescheduled') {
        actionHtml = `<p style="color:var(--accent-gold);margin-top:8px;font-size:0.85rem;">‚è≥ Waiting for member to respond...</p>`;
      }
      
      const confirmedHtml = status === 'confirmed' ? `
        <div style="background:var(--accent-green-soft);padding:12px;border-radius:var(--radius-md);margin-top:12px;display:flex;align-items:center;gap:8px;">
          <span style="font-size:20px;">‚úÖ</span>
          <div>
            <strong style="color:var(--accent-green);">Appointment Confirmed!</strong>
            <div style="font-size:0.85rem;color:var(--text-secondary);">${appointment.confirmed_date ? new Date(appointment.confirmed_date).toLocaleDateString() : proposedDate}</div>
          </div>
        </div>
      ` : '';
      
      return `
        <div class="logistics-section">
          <div class="logistics-section-header">
            <div class="logistics-section-title">üìÖ Service Scheduling</div>
            <span class="appointment-status ${status}">${status === 'confirmed' ? '‚úì Confirmed' : status === 'rescheduled' ? 'üîÑ Rescheduled' : '‚è≥ Proposed'}</span>
          </div>
          <div class="logistics-section-content">
            <div class="appointment-card">
              <div class="appointment-date">${proposedDate}</div>
              <div class="appointment-time">üïê ${timeRange}</div>
              <div style="font-size:0.8rem;color:var(--text-muted);margin-top:4px;">Proposed by: ${proposedBy}</div>
              ${appointment.provider_notes || appointment.member_notes ? `<div style="font-size:0.85rem;color:var(--text-secondary);margin-top:8px;">üìù ${appointment.provider_notes || appointment.member_notes}</div>` : ''}
            </div>
            ${confirmedHtml}
            ${actionHtml}
          </div>
        </div>
      `;
    }
    
    function renderTransferSection(packageId, transfer) {
      const statusFlow = [
        { key: 'with_member', label: 'With Member', icon: 'üë§' },
        { key: 'in_transit_to_provider', label: 'In Transit to Shop', icon: 'üöó' },
        { key: 'at_provider', label: 'At Shop', icon: 'üè™' },
        { key: 'work_in_progress', label: 'Work Started', icon: 'üîß' },
        { key: 'work_complete', label: 'Work Complete', icon: '‚úÖ' },
        { key: 'ready_for_return', label: 'Ready for Return', icon: 'üì¶' },
        { key: 'in_transit_to_member', label: 'Returning to Member', icon: 'üöó' },
        { key: 'returned', label: 'Returned', icon: 'üéâ' }
      ];
      
      const currentStatus = transfer?.vehicle_status || 'with_member';
      const currentIndex = statusFlow.findIndex(s => s.key === currentStatus);
      const transferType = transfer?.transfer_type || 'member_dropoff';
      
      const transferTypeLabels = {
        'member_dropoff': 'üöó Member drops off',
        'provider_pickup': 'üöö Provider picks up',
        'mobile_service': 'üìç Mobile service'
      };
      
      const timelineHtml = statusFlow.map((step, idx) => {
        let stepClass = 'pending';
        let timestamp = '';
        
        if (idx < currentIndex) {
          stepClass = 'completed';
        } else if (idx === currentIndex) {
          stepClass = 'current';
        }
        
        if (transfer) {
          if (step.key === 'at_provider' && transfer.arrived_at_provider_at) {
            timestamp = new Date(transfer.arrived_at_provider_at).toLocaleString();
          } else if (step.key === 'work_in_progress' && transfer.work_started_at) {
            timestamp = new Date(transfer.work_started_at).toLocaleString();
          } else if (step.key === 'work_complete' && transfer.work_completed_at) {
            timestamp = new Date(transfer.work_completed_at).toLocaleString();
          } else if (step.key === 'returned' && transfer.returned_at) {
            timestamp = new Date(transfer.returned_at).toLocaleString();
          }
        }
        
        return `
          <div class="status-step ${stepClass}">
            <div class="status-dot">${step.icon}</div>
            <div class="status-info">
              <div class="status-label">${step.label}</div>
              ${timestamp ? `<div class="status-time">${timestamp}</div>` : ''}
            </div>
          </div>
        `;
      }).join('');
      
      const nextAction = getNextTransferAction(currentStatus, transfer?.id, packageId);
      
      return `
        <div class="logistics-section">
          <div class="logistics-section-header">
            <div class="logistics-section-title">üöó Vehicle Transfer</div>
            <span style="font-size:0.85rem;color:var(--text-muted);">${transferTypeLabels[transferType] || transferType}</span>
          </div>
          <div class="logistics-section-content">
            <div class="status-timeline">
              ${timelineHtml}
            </div>
            ${nextAction}
          </div>
        </div>
      `;
    }
    
    function getNextTransferAction(currentStatus, transferId, packageId) {
      const actions = {
        'with_member': { label: 'Mark Vehicle Picked Up', nextStatus: 'in_transit_to_provider', icon: 'üöó' },
        'in_transit_to_provider': { label: 'Mark Vehicle Received', nextStatus: 'at_provider', icon: 'üè™' },
        'at_provider': { label: 'Mark Work Started', nextStatus: 'work_in_progress', icon: 'üîß' },
        'work_in_progress': { label: 'Mark Work Complete', nextStatus: 'work_complete', icon: '‚úÖ' },
        'work_complete': { label: 'Mark Ready for Return', nextStatus: 'ready_for_return', icon: 'üì¶' },
        'ready_for_return': { label: 'Mark Vehicle Returned', nextStatus: 'returned', icon: 'üéâ' },
        'in_transit_to_member': { label: 'Mark Vehicle Returned', nextStatus: 'returned', icon: 'üéâ' }
      };
      
      const action = actions[currentStatus];
      if (!action || currentStatus === 'returned') {
        return currentStatus === 'returned' ? `<div style="text-align:center;color:var(--accent-green);font-weight:500;padding:12px;">üéâ Vehicle returned successfully!</div>` : '';
      }
      
      return `
        <div class="status-action" style="text-align:center;padding-top:8px;">
          <button class="btn btn-primary btn-sm" onclick="updateJobVehicleStatus('${transferId}', '${packageId}', '${action.nextStatus}')">
            ${action.icon} ${action.label}
          </button>
        </div>
      `;
    }
    
    function renderLocationSection(packageId, memberId, memberLocation) {
      let memberLocationHtml = '';
      if (memberLocation && memberLocation.is_active) {
        const sharedTime = memberLocation.shared_at ? new Date(memberLocation.shared_at).toLocaleString() : '';
        const sharedByName = memberLocation.profiles?.full_name || 'Member';
        memberLocationHtml = `
          <div class="location-card" style="margin-bottom:12px;">
            <div class="location-icon">üìç</div>
            <div class="location-details">
              <div style="font-weight:500;margin-bottom:4px;">Member's Location</div>
              <div class="location-address">${memberLocation.address_text || 'Location shared'}</div>
              <div class="location-time">Shared ${sharedTime}</div>
              <a href="${memberLocation.maps_link}" target="_blank" class="btn btn-secondary btn-sm" style="margin-top:8px;">
                üó∫Ô∏è Open in Google Maps
              </a>
            </div>
          </div>
        `;
      }
      
      const isTracking = activeTrackingPackageId === packageId;
      const trackingStatusHtml = isTracking ? `
        <div style="display:flex;align-items:center;gap:10px;padding:12px;background:var(--accent-green-soft);border:1px solid rgba(74,200,140,0.3);border-radius:var(--radius-md);margin-bottom:12px;">
          <div style="width:12px;height:12px;border-radius:50%;background:var(--accent-green);animation:pulse 1.5s ease-in-out infinite;"></div>
          <div>
            <div style="font-weight:600;color:var(--accent-green);">üöó Live Tracking Active</div>
            <div style="font-size:0.8rem;color:var(--text-secondary);" id="tracking-status-${packageId}">Sending location updates...</div>
          </div>
        </div>
      ` : '';
      
      const trackingButtonsHtml = isTracking ? `
        <button class="btn btn-sm" style="background:var(--accent-red);color:#fff;border:none;" onclick="stopLocationTracking()">
          üõë Stop Tracking
        </button>
      ` : `
        <div style="display:flex;gap:8px;flex-wrap:wrap;">
          <button class="btn btn-secondary btn-sm" onclick="startLocationTracking('${packageId}', 'pickup')" title="Track while picking up vehicle">
            üìç Start Pickup Tracking
          </button>
          <button class="btn btn-secondary btn-sm" onclick="startLocationTracking('${packageId}', 'return')" title="Track while returning vehicle">
            üìç Start Return Tracking
          </button>
        </div>
      `;
      
      return `
        <div class="logistics-section">
          <div class="logistics-section-header">
            <div class="logistics-section-title">üìç Location & Tracking</div>
          </div>
          <div class="logistics-section-content">
            ${trackingStatusHtml}
            ${memberLocationHtml}
            ${!memberLocation && !isTracking ? '<p style="color:var(--text-muted);margin-bottom:12px;font-size:0.9rem;">No location shared by member yet.</p>' : ''}
            <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
              ${trackingButtonsHtml}
              ${!isTracking ? `
                <button class="btn btn-secondary btn-sm" onclick="shareProviderLocation('${packageId}', '${memberId}')">
                  üìç Share One-Time Location
                </button>
              ` : ''}
            </div>
          </div>
        </div>
      `;
    }

    // ========== GPS LIVE TRACKING FUNCTIONS ==========
    
    function startLocationTracking(packageId, trackingType) {
      if (!navigator.geolocation) {
        showToast('Geolocation is not supported by this browser', 'error');
        return;
      }
      
      if (activeTrackingPackageId) {
        showToast('Already tracking another package. Stop current tracking first.', 'error');
        return;
      }
      
      activeTrackingPackageId = packageId;
      
      const geoOptions = {
        enableHighAccuracy: true,
        timeout: 15000,
        maximumAge: 0
      };
      
      trackingWatchId = navigator.geolocation.watchPosition(
        (position) => {
          lastTrackingPosition = {
            lat: position.coords.latitude,
            lng: position.coords.longitude,
            heading: position.coords.heading,
            speed: position.coords.speed ? (position.coords.speed * 2.237).toFixed(1) : null,
            trackingType: trackingType
          };
          
          const statusEl = document.getElementById(`tracking-status-${packageId}`);
          if (statusEl) {
            statusEl.textContent = `Last update: ${new Date().toLocaleTimeString()}`;
          }
        },
        (error) => {
          console.error('Geolocation error:', error);
          let errorMsg = 'Location error';
          switch (error.code) {
            case error.PERMISSION_DENIED:
              errorMsg = 'Location permission denied';
              stopLocationTracking();
              break;
            case error.POSITION_UNAVAILABLE:
              errorMsg = 'Location unavailable';
              break;
            case error.TIMEOUT:
              errorMsg = 'Location request timed out';
              break;
          }
          showToast(errorMsg, 'error');
        },
        geoOptions
      );
      
      sendLocationUpdateNow(packageId, trackingType);
      
      trackingIntervalId = setInterval(() => {
        if (lastTrackingPosition) {
          sendLocationUpdateNow(packageId, trackingType);
        }
      }, 25000);
      
      showToast(`üìç Live tracking started (${trackingType})`, 'success');
      renderActiveJobs();
    }
    
    async function sendLocationUpdateNow(packageId, trackingType) {
      if (!lastTrackingPosition && navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          async (position) => {
            const { data, error } = await window.updateDriverLocation(
              packageId,
              position.coords.latitude,
              position.coords.longitude,
              position.coords.heading,
              position.coords.speed ? (position.coords.speed * 2.237).toFixed(1) : null,
              trackingType
            );
            if (error) console.error('Failed to send location update:', error);
          },
          (error) => console.error('Location fetch error:', error),
          { enableHighAccuracy: true, timeout: 10000 }
        );
      } else if (lastTrackingPosition) {
        const { data, error } = await window.updateDriverLocation(
          packageId,
          lastTrackingPosition.lat,
          lastTrackingPosition.lng,
          lastTrackingPosition.heading,
          lastTrackingPosition.speed,
          trackingType
        );
        if (error) console.error('Failed to send location update:', error);
      }
    }
    
    async function stopLocationTracking() {
      if (trackingWatchId !== null) {
        navigator.geolocation.clearWatch(trackingWatchId);
        trackingWatchId = null;
      }
      
      if (trackingIntervalId !== null) {
        clearInterval(trackingIntervalId);
        trackingIntervalId = null;
      }
      
      if (activeTrackingPackageId) {
        await window.clearDriverLocation(activeTrackingPackageId);
      }
      
      activeTrackingPackageId = null;
      lastTrackingPosition = null;
      
      showToast('üõë Live tracking stopped', 'success');
      renderActiveJobs();
    }

    async function markWorkStarted(packageId) {
      if (!confirm('Mark this job as started? This will notify the member that work has begun.')) return;

      await supabaseClient.from('maintenance_packages').update({
        status: 'in_progress',
        work_started_at: new Date().toISOString()
      }).eq('id', packageId);

      // Notify member
      try {
        await window.notifyWorkStarted(packageId);
      } catch (e) {
        console.log('Notification error (non-critical):', e);
      }

      showToast('Job marked as started. Keep up the great work!', 'success');
      await loadMyBids();
    }

    async function markJobComplete(packageId) {
      if (!confirm('Mark this job as complete? The member will be notified to confirm and release payment.')) return;

      await supabaseClient.from('maintenance_packages').update({
        status: 'in_progress', // Keep as in_progress until member confirms
        work_completed_at: new Date().toISOString()
      }).eq('id', packageId);

      // Notify member
      try {
        await window.notifyWorkCompleted(packageId);
      } catch (e) {
        console.log('Notification error (non-critical):', e);
      }

      showToast('Job marked complete! Payment will be released once the member confirms.', 'success');
      await loadMyBids();
    }

    // ========== PROVIDER SCHEDULING & COORDINATION ==========

    function openProviderScheduleModal(packageId, memberId, providerId) {
      document.getElementById('schedule-package-id').value = packageId;
      document.getElementById('schedule-member-id').value = memberId;
      document.getElementById('schedule-provider-id').value = providerId;
      document.getElementById('schedule-date').value = '';
      document.getElementById('schedule-time-start').value = '09:00';
      document.getElementById('schedule-time-end').value = '17:00';
      document.getElementById('schedule-duration').value = '1';
      document.getElementById('schedule-notes').value = '';
      document.getElementById('provider-schedule-modal').classList.add('active');
    }

    async function submitProviderScheduleProposal() {
      const packageId = document.getElementById('schedule-package-id').value;
      const memberId = document.getElementById('schedule-member-id').value;
      const providerId = document.getElementById('schedule-provider-id').value;
      const date = document.getElementById('schedule-date').value;
      const timeStart = document.getElementById('schedule-time-start').value;
      const timeEnd = document.getElementById('schedule-time-end').value;
      const duration = document.getElementById('schedule-duration').value;
      const notes = document.getElementById('schedule-notes').value;
      if (!date) return showToast('Please select a date', 'error');
      const { error } = await window.createAppointment(packageId, memberId, providerId, date, timeStart, timeEnd, parseInt(duration), notes);
      if (error) return showToast('Failed to propose appointment: ' + error.message, 'error');
      closeModal('provider-schedule-modal');
      showToast('Appointment proposal sent!', 'success');
      await renderActiveJobs();
    }

    async function confirmScheduleFromProvider(appointmentId, packageId) {
      if (!confirm('Confirm this appointment?')) return;
      const { error } = await window.confirmAppointment(appointmentId, packageId);
      if (error) return showToast('Failed: ' + error.message, 'error');
      showToast('Appointment confirmed!', 'success');
      await renderActiveJobs();
    }

    function proposeNewTimeFromProvider(appointmentId, packageId) {
      document.getElementById('counter-appointment-id').value = appointmentId;
      document.getElementById('counter-package-id').value = packageId;
      document.getElementById('counter-date').value = '';
      document.getElementById('counter-time-start').value = '09:00';
      document.getElementById('counter-time-end').value = '17:00';
      document.getElementById('counter-notes').value = '';
      document.getElementById('provider-counter-modal').classList.add('active');
    }

    async function submitProviderCounterProposal() {
      const appointmentId = document.getElementById('counter-appointment-id').value;
      const packageId = document.getElementById('counter-package-id').value;
      const date = document.getElementById('counter-date').value;
      const timeStart = document.getElementById('counter-time-start').value;
      const timeEnd = document.getElementById('counter-time-end').value;
      const notes = document.getElementById('counter-notes').value;
      if (!date) return showToast('Please select a date', 'error');
      const { error } = await window.proposeNewTime(appointmentId, packageId, date, timeStart, timeEnd, notes);
      if (error) return showToast('Failed: ' + error.message, 'error');
      closeModal('provider-counter-modal');
      showToast('New time proposed!', 'success');
      await renderActiveJobs();
    }

    async function acceptCounterFromProvider(appointmentId, packageId) {
      if (!confirm('Accept this proposed time?')) return;
      const { error } = await window.acceptCounterProposal(appointmentId, packageId);
      if (error) return showToast('Failed: ' + error.message, 'error');
      showToast('Time accepted!', 'success');
      await renderActiveJobs();
    }

    async function updateJobVehicleStatus(transferId, packageId, newStatus) {
      const labels = { 'in_transit_to_provider': 'picked up', 'at_provider': 'received', 'work_in_progress': 'started', 'work_complete': 'completed', 'ready_for_return': 'ready', 'returned': 'returned' };
      if (!confirm(`Mark vehicle as ${labels[newStatus] || newStatus}?`)) return;
      const { error } = await window.updateVehicleStatus(transferId, packageId, newStatus);
      if (error) return showToast('Failed: ' + error.message, 'error');
      showToast('Status updated!', 'success');
      await renderActiveJobs();
    }

    function shareProviderLocation(packageId, memberId) {
      document.getElementById('location-package-id').value = packageId;
      document.getElementById('location-member-id').value = memberId;
      document.getElementById('location-context').value = 'shop_location';
      document.getElementById('location-message').value = '';
      document.getElementById('location-status').style.display = 'none';
      document.getElementById('provider-location-modal').classList.add('active');
    }

    async function executeProviderLocationShare() {
      const packageId = document.getElementById('location-package-id').value;
      const memberId = document.getElementById('location-member-id').value;
      const context = document.getElementById('location-context').value;
      const message = document.getElementById('location-message').value;
      const statusDiv = document.getElementById('location-status');
      const btn = document.getElementById('share-location-btn');
      btn.disabled = true;
      btn.textContent = 'Getting location...';
      statusDiv.style.display = 'block';
      statusDiv.innerHTML = '<p style="color:var(--accent-gold);">üìç Getting your location...</p>';
      const { error, mapsLink } = await window.shareLocation(packageId, memberId, context, message);
      btn.disabled = false;
      btn.textContent = 'üìç Share My Location';
      if (error) { statusDiv.innerHTML = `<p style="color:var(--accent-red);">‚ùå ${error}</p>`; return; }
      statusDiv.innerHTML = `<p style="color:var(--accent-green);">‚úÖ Location shared!</p><a href="${mapsLink}" target="_blank" style="color:var(--accent-gold);">View on Maps</a>`;
      showToast('Location shared with member!', 'success');
      setTimeout(() => { closeModal('provider-location-modal'); renderActiveJobs(); }, 2000);
    }

    async function viewMemberLocation(packageId) {
      const { data: location, error } = await window.getActiveLocationShare(packageId, 'provider');
      if (error || !location) {
        showToast('No active location shared by member', 'error');
        return;
      }
      if (location.maps_link) {
        await window.markLocationViewed(location.id);
        window.open(location.maps_link, '_blank');
      } else {
        showToast('Location link not available', 'error');
      }
    }

    // ========== SERVICE EVIDENCE CAPTURE ==========
    
    const evidenceTypeLabels = {
      'pre_pickup': { label: 'Pre-Pickup Condition', icon: 'üîµ', color: 'var(--accent-blue)' },
      'arrival_shop': { label: 'Arrival at Shop', icon: 'üü†', color: '#f59e0b' },
      'post_service': { label: 'Post-Service Condition', icon: 'üü¢', color: 'var(--accent-green)' },
      'return': { label: 'Vehicle Return', icon: 'üü£', color: '#a855f7' }
    };

    function captureEvidence(packageId, type) {
      document.getElementById('evidence-package-id').value = packageId;
      document.getElementById('evidence-type').value = type;
      document.getElementById('evidence-modal-title').textContent = evidenceTypeLabels[type]?.label || 'Capture Evidence';
      document.getElementById('evidence-photo-preview').innerHTML = '';
      document.getElementById('evidence-photos').value = '';
      document.getElementById('evidence-odometer').value = '';
      document.getElementById('evidence-fuel').value = '';
      document.getElementById('evidence-exterior').value = '';
      document.getElementById('evidence-interior').value = '';
      document.getElementById('evidence-notes').value = '';
      document.getElementById('evidence-upload-status').style.display = 'none';
      document.getElementById('evidence-modal').classList.add('active');
    }

    function previewEvidencePhotos() {
      const fileInput = document.getElementById('evidence-photos');
      const preview = document.getElementById('evidence-photo-preview');
      const files = Array.from(fileInput.files).slice(0, 10);
      preview.innerHTML = '';
      files.forEach((file, index) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const img = document.createElement('div');
          img.style.cssText = 'width:80px;height:80px;border-radius:8px;overflow:hidden;border:1px solid var(--border-subtle);position:relative;';
          img.innerHTML = `<img src="${e.target.result}" style="width:100%;height:100%;object-fit:cover;">`;
          preview.appendChild(img);
        };
        reader.readAsDataURL(file);
      });
    }

    async function submitEvidence() {
      const packageId = document.getElementById('evidence-package-id').value;
      const type = document.getElementById('evidence-type').value;
      const fileInput = document.getElementById('evidence-photos');
      const odometer = document.getElementById('evidence-odometer').value;
      const fuelLevel = document.getElementById('evidence-fuel').value;
      const exteriorCondition = document.getElementById('evidence-exterior').value;
      const interiorCondition = document.getElementById('evidence-interior').value;
      const notes = document.getElementById('evidence-notes').value;

      if (!odometer || !fuelLevel) {
        return showToast('Please provide odometer reading and fuel level', 'error');
      }

      const files = Array.from(fileInput.files).slice(0, 10);
      if (files.length === 0) {
        return showToast('Please add at least one photo', 'error');
      }

      const btn = document.getElementById('submit-evidence-btn');
      const statusDiv = document.getElementById('evidence-upload-status');
      btn.disabled = true;
      btn.textContent = 'Uploading...';
      statusDiv.style.display = 'block';
      statusDiv.innerHTML = '<p style="color:var(--accent-gold);">üì§ Uploading photos...</p>';

      try {
        const photoUrls = await window.uploadEvidencePhotos(packageId, files);
        if (photoUrls.length === 0) {
          throw new Error('Failed to upload photos');
        }

        statusDiv.innerHTML = '<p style="color:var(--accent-gold);">üìù Saving evidence...</p>';

        let lat = null, lng = null;
        try {
          const pos = await new Promise((resolve, reject) => {
            navigator.geolocation.getCurrentPosition(resolve, reject, { timeout: 5000 });
          });
          lat = pos.coords.latitude;
          lng = pos.coords.longitude;
        } catch (e) { }

        const { data, error } = await window.saveEvidence({
          packageId,
          type,
          photos: photoUrls,
          odometer: parseInt(odometer),
          fuelLevel,
          exteriorCondition,
          interiorCondition,
          notes,
          role: 'provider',
          lat,
          lng
        });

        if (error) throw error;

        statusDiv.innerHTML = '<p style="color:var(--accent-green);">‚úÖ Evidence saved successfully!</p>';
        showToast('Evidence captured and saved!', 'success');
        
        setTimeout(() => {
          closeModal('evidence-modal');
          renderActiveJobs();
        }, 1500);
      } catch (err) {
        console.error('Evidence submission error:', err);
        statusDiv.innerHTML = `<p style="color:var(--accent-red);">‚ùå Error: ${err.message || 'Failed to save evidence'}</p>`;
        showToast('Failed to save evidence', 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = 'üì∏ Save Evidence';
      }
    }

    async function renderEvidenceSection(packageId) {
      const { data: evidence } = await window.getPackageEvidence(packageId);
      
      if (!evidence || evidence.length === 0) {
        return `
          <div class="logistics-section">
            <div class="logistics-section-header">
              <div class="logistics-section-title">üì∏ Vehicle Condition Evidence</div>
            </div>
            <div class="logistics-section-content">
              <p style="color:var(--text-muted);margin-bottom:16px;font-size:0.9rem;">No evidence captured yet. Document the vehicle condition at each stage.</p>
              <button class="btn btn-secondary btn-sm" onclick="captureEvidence('${packageId}', 'pre_pickup')">üì∏ Capture Pre-Pickup Evidence</button>
            </div>
          </div>
        `;
      }

      const timeline = evidence.map(e => {
        const typeInfo = evidenceTypeLabels[e.type] || { label: e.type, icon: 'üì∑', color: 'var(--text-muted)' };
        const photoGrid = e.photos?.length ? `
          <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:12px;">
            ${e.photos.slice(0, 4).map(url => `
              <div style="width:60px;height:60px;border-radius:6px;overflow:hidden;border:1px solid var(--border-subtle);cursor:pointer;" onclick="window.open('${url}','_blank')">
                <img src="${url}" style="width:100%;height:100%;object-fit:cover;">
              </div>
            `).join('')}
            ${e.photos.length > 4 ? `<div style="width:60px;height:60px;border-radius:6px;background:var(--bg-input);display:flex;align-items:center;justify-content:center;font-size:0.8rem;color:var(--text-muted);">+${e.photos.length - 4}</div>` : ''}
          </div>
        ` : '';
        
        return `
          <div style="display:flex;gap:12px;padding:12px;background:var(--bg-input);border-radius:var(--radius-md);border-left:3px solid ${typeInfo.color};margin-bottom:12px;">
            <div style="font-size:20px;">${typeInfo.icon}</div>
            <div style="flex:1;">
              <div style="font-weight:600;font-size:0.9rem;margin-bottom:4px;">${typeInfo.label}</div>
              <div style="display:flex;gap:16px;font-size:0.82rem;color:var(--text-secondary);margin-bottom:4px;">
                <span>üî¢ ${e.odometer?.toLocaleString() || 'N/A'} mi</span>
                <span>‚õΩ ${e.fuel_level || 'N/A'}</span>
              </div>
              ${e.notes ? `<div style="font-size:0.85rem;color:var(--text-secondary);margin-top:6px;">${e.notes}</div>` : ''}
              <div style="font-size:0.75rem;color:var(--text-muted);margin-top:8px;">${new Date(e.created_at).toLocaleString()}</div>
              ${photoGrid}
            </div>
          </div>
        `;
      }).join('');

      const capturedTypes = evidence.map(e => e.type);
      let nextButton = '';
      if (!capturedTypes.includes('pre_pickup')) {
        nextButton = `<button class="btn btn-secondary btn-sm" onclick="captureEvidence('${packageId}', 'pre_pickup')">üì∏ Capture Pre-Pickup</button>`;
      } else if (!capturedTypes.includes('arrival_shop')) {
        nextButton = `<button class="btn btn-secondary btn-sm" onclick="captureEvidence('${packageId}', 'arrival_shop')">üì∏ Record Shop Arrival</button>`;
      } else if (!capturedTypes.includes('post_service')) {
        nextButton = `<button class="btn btn-secondary btn-sm" onclick="captureEvidence('${packageId}', 'post_service')">üì∏ Record Post-Service</button>`;
      } else if (!capturedTypes.includes('return')) {
        nextButton = `<button class="btn btn-secondary btn-sm" onclick="captureEvidence('${packageId}', 'return')">üì∏ Record Return</button>`;
      }

      return `
        <div class="logistics-section">
          <div class="logistics-section-header">
            <div class="logistics-section-title">üì∏ Vehicle Condition Evidence</div>
          </div>
          <div class="logistics-section-content">
            ${timeline}
            ${nextButton ? `<div style="margin-top:12px;">${nextButton}</div>` : '<p style="color:var(--accent-green);font-size:0.85rem;margin-top:8px;">‚úÖ All evidence stages captured</p>'}
          </div>
        </div>
      `;
    }

    // ========== KEY EXCHANGE VERIFICATION ==========

    function openKeyExchangeModal(packageId, stage) {
      document.getElementById('key-exchange-package-id').value = packageId;
      document.getElementById('key-exchange-stage').value = stage;
      document.getElementById('key-exchange-modal-title').textContent = stage === 'pickup' ? 'Pickup Key Exchange' : 'Return Key Exchange';
      document.getElementById('key-exchange-id-preview').innerHTML = '';
      document.getElementById('key-exchange-photos-preview').innerHTML = '';
      document.getElementById('key-exchange-id-photo').value = '';
      document.getElementById('key-exchange-key-photos').value = '';
      document.getElementById('key-exchange-notes').value = '';
      document.getElementById('key-exchange-upload-status').style.display = 'none';
      document.getElementById('key-exchange-modal').classList.add('active');
    }

    function previewKeyExchangeIdPhoto() {
      const fileInput = document.getElementById('key-exchange-id-photo');
      const preview = document.getElementById('key-exchange-id-preview');
      preview.innerHTML = '';
      if (fileInput.files.length > 0) {
        const reader = new FileReader();
        reader.onload = (e) => {
          const img = document.createElement('div');
          img.style.cssText = 'width:80px;height:80px;border-radius:8px;overflow:hidden;border:2px solid var(--accent-gold);position:relative;';
          img.innerHTML = `<img src="${e.target.result}" style="width:100%;height:100%;object-fit:cover;"><div style="position:absolute;top:2px;right:2px;background:var(--accent-gold);color:#000;padding:2px 4px;border-radius:4px;font-size:0.65rem;font-weight:600;">ID</div>`;
          preview.appendChild(img);
        };
        reader.readAsDataURL(fileInput.files[0]);
      }
    }

    function previewKeyExchangePhotos() {
      const fileInput = document.getElementById('key-exchange-key-photos');
      const preview = document.getElementById('key-exchange-photos-preview');
      const files = Array.from(fileInput.files).slice(0, 3);
      preview.innerHTML = '';
      files.forEach((file, index) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const img = document.createElement('div');
          img.style.cssText = 'width:80px;height:80px;border-radius:8px;overflow:hidden;border:1px solid var(--border-subtle);position:relative;';
          img.innerHTML = `<img src="${e.target.result}" style="width:100%;height:100%;object-fit:cover;">`;
          preview.appendChild(img);
        };
        reader.readAsDataURL(file);
      });
    }

    async function uploadKeyExchangePhoto(packageId, stage, file, photoType) {
      const timestamp = Date.now();
      const ext = file.name.split('.').pop();
      const filePath = `${packageId}/${stage}/${photoType}_${timestamp}.${ext}`;
      
      const { data: uploadData, error: uploadError } = await supabaseClient.storage
        .from('key-exchange-photos')
        .upload(filePath, file, { cacheControl: '3600', upsert: false });
      
      if (uploadError) {
        console.error('Upload error:', uploadError);
        return null;
      }
      
      const { data: urlData } = supabaseClient.storage
        .from('key-exchange-photos')
        .getPublicUrl(filePath);
      
      return urlData?.publicUrl || null;
    }

    async function submitKeyExchange() {
      const packageId = document.getElementById('key-exchange-package-id').value;
      const stage = document.getElementById('key-exchange-stage').value;
      const idPhotoInput = document.getElementById('key-exchange-id-photo');
      const keyPhotosInput = document.getElementById('key-exchange-key-photos');
      const notes = document.getElementById('key-exchange-notes').value;

      if (!idPhotoInput.files.length) {
        return showToast('Please capture the driver ID photo', 'error');
      }
      if (!keyPhotosInput.files.length) {
        return showToast('Please add at least one key handoff photo', 'error');
      }

      const btn = document.getElementById('submit-key-exchange-btn');
      const statusDiv = document.getElementById('key-exchange-upload-status');
      btn.disabled = true;
      btn.textContent = 'Uploading...';
      statusDiv.style.display = 'block';
      statusDiv.innerHTML = '<p style="color:var(--accent-gold);">üì§ Uploading photos...</p>';

      try {
        const idPhotoUrl = await uploadKeyExchangePhoto(packageId, stage, idPhotoInput.files[0], 'driver_id');
        if (!idPhotoUrl) throw new Error('Failed to upload ID photo');

        const keyPhotoFiles = Array.from(keyPhotosInput.files).slice(0, 3);
        const keyPhotoUrls = [];
        for (let i = 0; i < keyPhotoFiles.length; i++) {
          statusDiv.innerHTML = `<p style="color:var(--accent-gold);">üì§ Uploading photo ${i + 2} of ${keyPhotoFiles.length + 1}...</p>`;
          const url = await uploadKeyExchangePhoto(packageId, stage, keyPhotoFiles[i], `key_${i + 1}`);
          if (url) keyPhotoUrls.push(url);
        }

        if (keyPhotoUrls.length === 0) throw new Error('Failed to upload key photos');

        statusDiv.innerHTML = '<p style="color:var(--accent-gold);">üìù Saving key exchange record...</p>';

        const { data: existingExchange } = await supabaseClient
          .from('key_exchanges')
          .select('id')
          .eq('package_id', packageId)
          .eq('stage', stage)
          .maybeSingle();

        let result;
        if (existingExchange) {
          result = await supabaseClient.from('key_exchanges').update({
            driver_id_photo_url: idPhotoUrl,
            key_photos: keyPhotoUrls,
            notes: notes || null,
            verified_at: new Date().toISOString()
          }).eq('id', existingExchange.id);
        } else {
          result = await supabaseClient.from('key_exchanges').insert({
            package_id: packageId,
            driver_user_id: currentUser.id,
            stage: stage,
            driver_id_photo_url: idPhotoUrl,
            key_photos: keyPhotoUrls,
            notes: notes || null,
            verified_at: new Date().toISOString()
          });
        }

        if (result.error) throw result.error;

        statusDiv.innerHTML = '<p style="color:var(--accent-green);">‚úÖ Key exchange verified successfully!</p>';
        showToast(`${stage === 'pickup' ? 'Pickup' : 'Return'} key exchange verified!`, 'success');
        
        setTimeout(() => {
          closeModal('key-exchange-modal');
          renderActiveJobs();
        }, 1500);
      } catch (err) {
        console.error('Key exchange submission error:', err);
        statusDiv.innerHTML = `<p style="color:var(--accent-red);">‚ùå Error: ${err.message || 'Failed to save key exchange'}</p>`;
        showToast('Failed to save key exchange', 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = 'üîë Verify Key Exchange';
      }
    }

    async function renderKeyExchangeSection(packageId) {
      const { data: keyExchanges, error } = await supabaseClient
        .from('key_exchanges')
        .select('*')
        .eq('package_id', packageId)
        .order('created_at', { ascending: true });

      const pickupExchange = keyExchanges?.find(e => e.stage === 'pickup');
      const returnExchange = keyExchanges?.find(e => e.stage === 'return');

      const renderExchangeCard = (exchange, stage, label, icon) => {
        if (exchange?.verified_at) {
          const photoGrid = exchange.key_photos?.length ? `
            <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:12px;">
              <div style="width:50px;height:50px;border-radius:6px;overflow:hidden;border:2px solid var(--accent-gold);position:relative;cursor:pointer;" onclick="window.open('${exchange.driver_id_photo_url}','_blank')">
                <img src="${exchange.driver_id_photo_url}" style="width:100%;height:100%;object-fit:cover;">
                <div style="position:absolute;top:2px;right:2px;background:var(--accent-gold);color:#000;padding:1px 3px;border-radius:3px;font-size:0.55rem;font-weight:600;">ID</div>
              </div>
              ${exchange.key_photos.slice(0, 3).map(url => `
                <div style="width:50px;height:50px;border-radius:6px;overflow:hidden;border:1px solid var(--border-subtle);cursor:pointer;" onclick="window.open('${url}','_blank')">
                  <img src="${url}" style="width:100%;height:100%;object-fit:cover;">
                </div>
              `).join('')}
            </div>
          ` : '';
          
          return `
            <div style="display:flex;gap:12px;padding:12px;background:var(--bg-input);border-radius:var(--radius-md);border-left:3px solid var(--accent-green);margin-bottom:12px;">
              <div style="font-size:20px;">${icon}</div>
              <div style="flex:1;">
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">
                  <span style="font-weight:600;font-size:0.9rem;">${label}</span>
                  <span style="background:var(--accent-green);color:#fff;padding:2px 8px;border-radius:12px;font-size:0.7rem;font-weight:600;">‚úì Verified</span>
                </div>
                <div style="font-size:0.75rem;color:var(--text-muted);">${new Date(exchange.verified_at).toLocaleString()}</div>
                ${exchange.notes ? `<div style="font-size:0.85rem;color:var(--text-secondary);margin-top:6px;">${exchange.notes}</div>` : ''}
                ${photoGrid}
              </div>
            </div>
          `;
        } else {
          return `
            <div style="display:flex;gap:12px;padding:12px;background:var(--bg-input);border-radius:var(--radius-md);border-left:3px solid var(--border-subtle);margin-bottom:12px;">
              <div style="font-size:20px;opacity:0.5;">${icon}</div>
              <div style="flex:1;">
                <div style="font-weight:600;font-size:0.9rem;margin-bottom:4px;color:var(--text-muted);">${label}</div>
                <button class="btn btn-secondary btn-sm" onclick="openKeyExchangeModal('${packageId}', '${stage}')">üîë Verify ${label}</button>
              </div>
            </div>
          `;
        }
      };

      return `
        <div class="logistics-section">
          <div class="logistics-section-header">
            <div class="logistics-section-title">üîë Key Exchange Verification</div>
          </div>
          <div class="logistics-section-content">
            <p style="color:var(--text-muted);margin-bottom:16px;font-size:0.9rem;">Document key handoffs to verify custody and protect both parties.</p>
            ${renderExchangeCard(pickupExchange, 'pickup', 'Pickup Key Exchange', 'üîµ')}
            ${renderExchangeCard(returnExchange, 'return', 'Return Key Exchange', 'üü£')}
          </div>
        </div>
      `;
    }

    // ========== UPSELL REQUESTS ==========
    let currentUpsellPackageId = null;
    let currentUpsellMemberId = null;

    function openUpsellModal(packageId, memberId) {
      currentUpsellPackageId = packageId;
      currentUpsellMemberId = memberId;
      document.getElementById('upsell-title').value = '';
      document.getElementById('upsell-description').value = '';
      document.getElementById('upsell-cost').value = '';
      document.getElementById('upsell-urgency').value = 'recommended';
      document.getElementById('upsell-modal').classList.add('active');
    }

    async function submitUpsellRequest() {
      const title = document.getElementById('upsell-title').value.trim();
      const description = document.getElementById('upsell-description').value.trim();
      const cost = parseFloat(document.getElementById('upsell-cost').value);
      const urgency = document.getElementById('upsell-urgency').value;

      if (!title || !cost) {
        return showToast('Please provide a title and estimated cost.', 'error');
      }

      // Create upsell request
      await supabaseClient.from('upsell_requests').insert({
        package_id: currentUpsellPackageId,
        provider_id: currentUser.id,
        member_id: currentUpsellMemberId,
        title: title,
        description: description,
        estimated_cost: cost,
        urgency: urgency,
        status: 'pending',
        expires_at: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString() // 24 hours
      });

      closeModal('upsell-modal');
      showToast('Additional work request sent to member. They have 24 hours to respond.', 'success');
    }

    async function viewPackageDetails(packageId) {
      const pkg = openPackages.find(p => p.id === packageId);
      if (!pkg) return;

      // Fetch photos for this package
      const { data: photos } = await supabaseClient
        .from('package_photos')
        .select('*')
        .eq('package_id', packageId);
      
      // Fetch destination service details if applicable
      let destService = pkg._destinationService;
      if (pkg.category === 'destination_service' && !destService) {
        const { data } = await fetchDestinationServiceDetails(packageId);
        destService = data;
      }
        
      const vehicle = pkg.vehicles;
      const vehicleName = vehicle ? (vehicle.nickname || `${vehicle.year || ''} ${vehicle.make} ${vehicle.model}`.trim()) : 'Vehicle';

      // Location display
      const locationDisplay = pkg.member_city && pkg.member_state 
        ? `${pkg.member_city}, ${pkg.member_state}` 
        : (pkg.member_zip || 'Location N/A');

      // Build destination service details HTML
      let destinationDetailsHtml = '';
      if (pkg.category === 'destination_service' && destService) {
        const dsIcon = getDestinationServiceIcon(destService.service_type);
        const dsLabel = getDestinationServiceLabel(destService.service_type);
        
        let serviceSpecificHtml = '';
        
        if (destService.service_type === 'airport') {
          serviceSpecificHtml = `
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
              ${destService.flight_datetime ? `<div><span style="color:var(--text-muted);font-size:0.85rem;">Flight Date/Time</span><div style="font-weight:500;">${formatDestinationDateTime(destService.flight_datetime)}</div></div>` : ''}
              ${destService.flight_number ? `<div><span style="color:var(--text-muted);font-size:0.85rem;">Flight Number</span><div style="font-weight:500;">${destService.flight_number}</div></div>` : ''}
              ${destService.airline ? `<div><span style="color:var(--text-muted);font-size:0.85rem;">Airline</span><div style="font-weight:500;">${destService.airline}</div></div>` : ''}
              ${destService.parking_preference ? `<div><span style="color:var(--text-muted);font-size:0.85rem;">Parking Preference</span><div style="font-weight:500;">${destService.parking_preference}</div></div>` : ''}
              ${destService.trip_type ? `<div><span style="color:var(--text-muted);font-size:0.85rem;">Trip Type</span><div style="font-weight:500;">${destService.trip_type}</div></div>` : ''}
              ${destService.return_datetime ? `<div><span style="color:var(--text-muted);font-size:0.85rem;">Return Date</span><div style="font-weight:500;">${formatDestinationDateTime(destService.return_datetime)}</div></div>` : ''}
            </div>
          `;
        } else if (destService.service_type === 'dealership') {
          serviceSpecificHtml = `
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
              ${destService.dealership_name ? `<div><span style="color:var(--text-muted);font-size:0.85rem;">Dealership</span><div style="font-weight:500;">${destService.dealership_name}</div></div>` : ''}
              ${destService.dealership_service_type ? `<div><span style="color:var(--text-muted);font-size:0.85rem;">Service Type</span><div style="font-weight:500;">${destService.dealership_service_type}</div></div>` : ''}
              ${destService.appointment_datetime ? `<div><span style="color:var(--text-muted);font-size:0.85rem;">Appointment</span><div style="font-weight:500;">${formatDestinationDateTime(destService.appointment_datetime)}</div></div>` : ''}
              ${destService.dealership_address ? `<div style="grid-column:span 2;"><span style="color:var(--text-muted);font-size:0.85rem;">Dealership Address</span><div style="font-weight:500;">${destService.dealership_address}</div></div>` : ''}
            </div>
          `;
        } else if (destService.service_type === 'detailing') {
          serviceSpecificHtml = `
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
              ${destService.detail_level || destService.detail_service_level ? `<div><span style="color:var(--text-muted);font-size:0.85rem;">Detail Level</span><div style="font-weight:500;">${destService.detail_level || destService.detail_service_level}</div></div>` : ''}
              ${destService.event_datetime ? `<div><span style="color:var(--text-muted);font-size:0.85rem;">Scheduled Time</span><div style="font-weight:500;">${formatDestinationDateTime(destService.event_datetime)}</div></div>` : ''}
            </div>
          `;
        } else if (destService.service_type === 'valet') {
          serviceSpecificHtml = `
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
              ${destService.event_name || destService.valet_event_name ? `<div><span style="color:var(--text-muted);font-size:0.85rem;">Event</span><div style="font-weight:500;">${destService.event_name || destService.valet_event_name}</div></div>` : ''}
              ${destService.event_venue || destService.valet_venue ? `<div><span style="color:var(--text-muted);font-size:0.85rem;">Venue</span><div style="font-weight:500;">${destService.event_venue || destService.valet_venue}</div></div>` : ''}
              ${destService.event_datetime ? `<div><span style="color:var(--text-muted);font-size:0.85rem;">Event Time</span><div style="font-weight:500;">${formatDestinationDateTime(destService.event_datetime)}</div></div>` : ''}
              ${destService.expected_duration ? `<div><span style="color:var(--text-muted);font-size:0.85rem;">Expected Duration</span><div style="font-weight:500;">${destService.expected_duration}</div></div>` : ''}
            </div>
          `;
        }
        
        destinationDetailsHtml = `
          <div style="margin-bottom:20px;padding:20px;background:var(--accent-blue-soft);border-radius:var(--radius-lg);border:1px solid rgba(74, 124, 255, 0.25);">
            <div style="display:flex;align-items:center;gap:10px;margin-bottom:16px;">
              <span style="font-size:1.5rem;">${dsIcon}</span>
              <strong style="font-size:1.1rem;color:var(--accent-blue);">${dsLabel}</strong>
            </div>
            
            <div style="margin-bottom:16px;padding:12px 16px;background:var(--bg-card);border-radius:var(--radius-md);">
              <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                <span style="color:var(--accent-green);">üìç</span>
                <span style="color:var(--text-muted);font-size:0.85rem;">Pickup Location</span>
              </div>
              <div style="font-weight:500;margin-bottom:12px;">${destService.pickup_location || 'To be confirmed'}</div>
              
              <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                <span style="color:var(--accent-gold);">üéØ</span>
                <span style="color:var(--text-muted);font-size:0.85rem;">Destination</span>
              </div>
              <div style="font-weight:500;">${destService.dropoff_location || 'To be confirmed'}</div>
            </div>
            
            ${serviceSpecificHtml}
            
            ${destService.special_instructions ? `
              <div style="margin-top:16px;padding:12px 16px;background:var(--bg-card);border-radius:var(--radius-md);border-left:3px solid var(--accent-gold);">
                <div style="color:var(--text-muted);font-size:0.85rem;margin-bottom:4px;">üìù Special Instructions</div>
                <div style="color:var(--text-secondary);line-height:1.5;">${destService.special_instructions}</div>
              </div>
            ` : ''}
          </div>
        `;
      }

      document.getElementById('package-details-title').textContent = pkg.title;
      document.getElementById('package-details-body').innerHTML = `
        <div style="margin-bottom:20px;">
          <div class="package-meta">
            <span>üöó ${vehicleName}</span>
            <span>üìç ${locationDisplay}</span>
            <span>üìÖ Posted ${new Date(pkg.created_at).toLocaleDateString()}</span>
          </div>
        </div>
        ${destinationDetailsHtml}
        <div style="margin-bottom:20px;">
          <strong>Service Details</strong>
          <div class="package-meta" style="margin-top:8px;">
            <span>Category: ${formatCategory(pkg.category) || 'General'}</span>
            <span>Type: ${pkg.service_type || 'Not specified'}</span>
          </div>
        </div>
        <div style="margin-bottom:20px;">
          <strong>Requirements</strong>
          <div class="package-meta" style="margin-top:8px;">
            <span>üîÑ ${formatFrequency(pkg.frequency)}</span>
            <span>üîß ${pkg.parts_preference || 'Standard'} parts</span>
            <span>üöó ${formatPickup(pkg.pickup_preference)}</span>
          </div>
          ${pkg.preferred_schedule ? `<p style="margin-top:8px;color:var(--text-secondary);">Preferred timing: ${pkg.preferred_schedule}</p>` : ''}
        </div>
        ${pkg.description ? `<div style="margin-bottom:20px;"><strong>Description</strong><p style="color:var(--text-secondary);margin-top:8px;line-height:1.6;">${pkg.description}</p></div>` : ''}
        ${pkg.insurance_claim ? `<div style="margin-bottom:20px;padding:12px;background:var(--accent-gold-soft);border-radius:var(--radius-md);"><strong>‚ö†Ô∏è Insurance Claim</strong><p style="color:var(--text-secondary);margin-top:4px;">Carrier: ${pkg.insurance_company || 'N/A'} ‚Ä¢ Claim #: ${pkg.claim_number || 'N/A'}</p></div>` : ''}
        ${photos?.length ? `
          <div style="margin-bottom:20px;">
            <strong>üì∑ Photos (${photos.length})</strong>
            <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:10px;margin-top:12px;">
              ${photos.map(p => `
                <div style="aspect-ratio:1;border-radius:var(--radius-md);overflow:hidden;border:1px solid var(--border-subtle);cursor:pointer;" onclick="window.open('${p.url}','_blank')">
                  <img src="${p.url}" style="width:100%;height:100%;object-fit:cover;">
                </div>
              `).join('')}
            </div>
          </div>
        ` : ''}
        <div style="display:flex;gap:12px;margin-top:24px;">
          ${!myBids.some(b => b.package_id === packageId) ? `<button class="btn btn-primary" onclick="closeModal('package-details-modal');openBidModal('${packageId}', '${pkg.title.replace(/'/g, "\\'")}')">Submit Bid</button>` : '<span style="color:var(--accent-green);">‚úì You\'ve already bid on this package</span>'}
        </div>
      `;
      document.getElementById('package-details-modal').classList.add('active');
    }

    let isUpdatingBid = false;
    
    function openBidModal(packageId, title, existingPrice = null) {
      currentBidPackageId = packageId;
      isUpdatingBid = existingPrice !== null && existingPrice > 0;
      
      document.getElementById('bid-package-title').textContent = isUpdatingBid ? `Update Bid: ${title}` : title;
      ['bid-price', 'bid-duration', 'bid-parts', 'bid-labor', 'bid-availability', 'bid-notes'].forEach(id => document.getElementById(id).value = '');
      document.getElementById('bid-price-custom').value = '';
      document.getElementById('bid-price-custom').style.display = 'none';
      
      // Pre-select existing price if updating
      if (existingPrice) {
        const priceSelect = document.getElementById('bid-price');
        const matchingOption = Array.from(priceSelect.options).find(o => o.value === String(existingPrice));
        if (matchingOption) {
          priceSelect.value = String(existingPrice);
        } else {
          priceSelect.value = 'custom';
          document.getElementById('bid-price-custom').value = existingPrice;
          document.getElementById('bid-price-custom').style.display = 'block';
        }
      }
      
      // Update submit button text
      const submitBtn = document.querySelector('#bid-modal .btn-primary');
      submitBtn.textContent = isUpdatingBid ? 'Update Bid (Free)' : 'Submit Bid';
      
      document.getElementById('bid-modal').classList.add('active');
      
      // Add listener for custom amount
      document.getElementById('bid-price').onchange = function() {
        const customInput = document.getElementById('bid-price-custom');
        if (this.value === 'custom') {
          customInput.style.display = 'block';
          customInput.focus();
        } else {
          customInput.style.display = 'none';
        }
      };
    }

    async function submitBid() {
      const priceSelect = document.getElementById('bid-price').value;
      const priceCustom = document.getElementById('bid-price-custom').value;
      const price = priceSelect === 'custom' ? priceCustom : priceSelect;
      
      if (!price || !currentBidPackageId) return showToast('Please select a price estimate', 'error');

      // Check if provider is suspended (for new bids only)
      if (!isUpdatingBid) {
        const suspensionCheck = await canProviderBid(currentUser.id);
        if (!suspensionCheck.canBid) {
          showToast('Your account is currently suspended due to low ratings. You cannot place new bids at this time.', 'error');
          closeModal('bid-modal');
          showSection('my-reviews');
          return;
        }
      }

      // Only check credits for new bids, not updates
      if (!isUpdatingBid) {
        const bidCredits = providerProfile?.bid_credits || 0;
        const freeBids = providerProfile?.free_trial_bids || 0;
        const totalCredits = bidCredits + freeBids;

        if (totalCredits <= 0) {
          showToast('No bid credits remaining. Purchase more to continue bidding.', 'error');
          showSection('subscription');
          closeModal('bid-modal');
          return;
        }
      }

      const bidData = {
        price: Number(price),
        parts_cost: document.getElementById('bid-parts').value ? Number(document.getElementById('bid-parts').value) : null,
        labor_cost: document.getElementById('bid-labor').value ? Number(document.getElementById('bid-labor').value) : null,
        estimated_duration: document.getElementById('bid-duration').value.trim() || null,
        available_dates: document.getElementById('bid-availability').value.trim() || null,
        notes: document.getElementById('bid-notes').value.trim() || null,
        updated_at: new Date().toISOString()
      };

      let error;
      
      if (isUpdatingBid) {
        // Update existing bid
        const result = await supabaseClient.from('bids')
          .update(bidData)
          .eq('package_id', currentBidPackageId)
          .eq('provider_id', currentUser.id);
        error = result.error;
      } else {
        // Insert new bid
        bidData.package_id = currentBidPackageId;
        bidData.provider_id = currentUser.id;
        bidData.status = 'pending';
        const result = await supabaseClient.from('bids').insert(bidData);
        error = result.error;
      }

      if (error) {
        console.error('Bid submission error:', error);
        return showToast('Failed to ' + (isUpdatingBid ? 'update' : 'submit') + ' bid: ' + (error.message || 'Unknown error'), 'error');
      }

      // Only deduct credit for new bids
      if (!isUpdatingBid) {
        const bidCredits = providerProfile?.bid_credits || 0;
        const freeBids = providerProfile?.free_trial_bids || 0;
        
        // Deduct bid credit (use free bids first, then paid credits)
        if (freeBids > 0) {
          await supabaseClient.from('profiles').update({
            free_trial_bids: freeBids - 1,
            total_bids_used: (providerProfile?.total_bids_used || 0) + 1
          }).eq('id', currentUser.id);
          providerProfile.free_trial_bids = freeBids - 1;
        } else {
          await supabaseClient.from('profiles').update({
            bid_credits: bidCredits - 1,
            total_bids_used: (providerProfile?.total_bids_used || 0) + 1
          }).eq('id', currentUser.id);
          providerProfile.bid_credits = bidCredits - 1;
        }
        providerProfile.total_bids_used = (providerProfile?.total_bids_used || 0) + 1;

        // Update sidebar badge
        updateCreditsBadge();
      }

      // Notify member of new/updated bid (in-app + email + SMS)
      const pkg = openPackages.find(p => p.id === currentBidPackageId);
      try {
        // In-app notification
        await supabaseClient.from('notifications').insert({
          user_id: pkg?.member_id,
          type: isUpdatingBid ? 'bid_updated' : 'bid_received',
          title: isUpdatingBid ? 'üîÑ Bid updated!' : 'üí∞ New bid received!',
          message: `A provider has ${isUpdatingBid ? 'updated their bid to' : 'submitted a bid of'} $${Number(price).toFixed(2)} for "${pkg?.title || 'your package'}".`,
          link_type: 'package',
          link_id: currentBidPackageId
        });

        // Get member profile for email/SMS notification (only for new bids)
        if (!isUpdatingBid) {
          const { data: memberProfile } = await supabaseClient.from('profiles').select('*').eq('id', pkg?.member_id).single();
          const { count: totalBids } = await supabaseClient.from('bids').select('id', { count: 'exact' }).eq('package_id', currentBidPackageId);
          
          if (typeof EmailService !== 'undefined') {
            // Email notification
            if (memberProfile?.email) {
              const vehicleName = pkg?.vehicles ? `${pkg.vehicles.year || ''} ${pkg.vehicles.make} ${pkg.vehicles.model}`.trim() : 'Your vehicle';
              await EmailService.sendBidReceivedEmail(
                memberProfile.email,
                memberProfile.full_name || 'Member',
                pkg?.title || 'Maintenance Package',
                vehicleName,
                Number(price),
                totalBids || 1
              );
            }
            
            // SMS notification (if enabled)
            if (memberProfile?.sms_notifications && memberProfile?.sms_bid_received && memberProfile?.phone) {
              await EmailService.sendBidReceivedSms(
                memberProfile.phone,
                pkg?.title || 'Maintenance Package',
                Number(price)
              );
            }
          }
        }
      } catch (e) {
        console.log('Notification error (non-critical):', e);
      }

      closeModal('bid-modal');
      showToast(isUpdatingBid ? 'Bid updated successfully!' : 'Bid submitted successfully!', 'success');
      isUpdatingBid = false;
      await loadMyBids();
      await loadOpenPackages();
      updateStats();
    }

    async function openMessageWithMember(packageId, memberId) {
      currentMessagePackageId = packageId;
      currentMessageMemberId = memberId;

      const { data: messages } = await supabaseClient.from('messages').select('*').eq('package_id', packageId).or(`sender_id.eq.${currentUser.id},recipient_id.eq.${currentUser.id}`).order('created_at', { ascending: true });

      const thread = document.getElementById('message-thread');
      if (!messages?.length) {
        thread.innerHTML = '<p style="color:var(--text-muted);text-align:center;">No messages yet. Start the conversation!</p>';
      } else {
        thread.innerHTML = messages.map(m => `
          <div class="message ${m.sender_id === currentUser.id ? 'sent' : 'received'}">
            <div class="message-bubble">${m.content}</div>
            <div class="message-time">${new Date(m.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</div>
          </div>
        `).join('');
        thread.scrollTop = thread.scrollHeight;
      }

      document.getElementById('message-modal-title').textContent = 'Message Member';
      document.getElementById('message-input').value = '';
      document.getElementById('message-modal').classList.add('active');
    }

    async function sendMessage() {
      const input = document.getElementById('message-input');
      const content = input.value.trim();
      if (!content || !currentMessageMemberId || !currentMessagePackageId) return;

      await supabaseClient.from('messages').insert({
        package_id: currentMessagePackageId,
        sender_id: currentUser.id,
        recipient_id: currentMessageMemberId,
        content
      });

      input.value = '';
      await openMessageWithMember(currentMessagePackageId, currentMessageMemberId);
    }

    function closeModal(id) { document.getElementById(id).classList.remove('active'); }

    function formatFrequency(freq) {
      const map = { one_time: 'One-time', weekly: 'Weekly', bi_weekly: 'Bi-weekly', monthly: 'Monthly', quarterly: 'Quarterly', annually: 'Annually' };
      return map[freq] || freq || 'One-time';
    }

    function formatPickup(pref) {
      const map = { provider_pickup: 'Provider pickup', member_dropoff: 'Drop-off', rideshare: 'Rideshare', either: 'Flexible' };
      return map[pref] || pref || 'Flexible';
    }

    function showToast(msg, type = 'success') {
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.innerHTML = `<span>${type === 'success' ? '‚úì' : '‚ö†'}</span><span>${msg}</span>`;
      document.getElementById('toast-container').appendChild(toast);
      setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 300); }, 3000);
    }

    // ========== PROVIDER PROFILE ==========
    async function loadProviderProfile() {
      const { data: profile, error } = await supabaseClient
        .from('profiles')
        .select('*')
        .eq('id', currentUser.id)
        .single();

      if (error) {
        console.error('Error loading profile:', error);
        return;
      }

      // Populate form fields
      document.getElementById('profile-business-name').value = profile.business_name || '';
      document.getElementById('profile-full-name').value = profile.full_name || '';
      document.getElementById('profile-phone').value = profile.business_phone || '';
      document.getElementById('profile-address').value = profile.business_address || '';
      document.getElementById('profile-years').value = profile.years_in_business || '';
      document.getElementById('profile-description').value = profile.description || '';
      
      // Service areas
      const zipCodes = profile.service_areas || [];
      document.getElementById('profile-zip-codes').value = zipCodes.join(', ');
      
      // Services offered
      const services = profile.services_offered || [];
      document.querySelectorAll('#services-grid input[type="checkbox"]').forEach(cb => {
        cb.checked = services.includes(cb.value);
      });
      
      // Certifications
      const certs = profile.certifications || [];
      const knownCerts = ['ASE Certified', 'ASE Master Technician', 'Manufacturer Certified', 'I-CAR Certified', 'EPA Certified', 'AAA Approved', 'BBB Accredited'];
      document.querySelectorAll('#certifications-grid input[type="checkbox"]').forEach(cb => {
        cb.checked = certs.includes(cb.value);
      });
      
      // Other certs (ones not in the checkbox list)
      const otherCerts = certs.filter(c => !knownCerts.includes(c));
      document.getElementById('profile-other-certs').value = otherCerts.join(', ');

      // Load business hours
      if (profile.business_hours) {
        setBusinessHours(profile.business_hours);
      }

      // Load blocked dates
      blockedDates = profile.blocked_dates || [];
      renderBlockedDates();

      updateProfileCompletion(profile);
      
      // Load verification status from provider_applications
      await loadVerificationStatus();
    }

    // ========== VERIFICATION STATUS ==========
    let providerApplication = null;

    async function loadVerificationStatus() {
      try {
        // Fetch provider application for this user
        const { data, error } = await supabaseClient
          .from('provider_applications')
          .select('*')
          .eq('user_id', currentUser.id)
          .single();

        if (error && error.code !== 'PGRST116') {
          console.log('Error loading provider application:', error);
        }

        providerApplication = data;
        updateVerificationUI();
      } catch (err) {
        console.log('loadVerificationStatus error:', err);
      }
    }

    function getDocExpirationBadge(uploadDate) {
      if (!uploadDate) return '';
      const status = getExpirationStatus(uploadDate);
      if (status.status === 'expired') {
        return `<span class="expiration-badge expired">‚ö†Ô∏è Expired - Re-upload Required</span>`;
      } else if (status.status === 'expiring_soon') {
        return `<span class="expiration-badge expiring-soon">‚è∞ ${status.label}</span>`;
      } else {
        return `<span class="expiration-badge valid">‚úì ${status.label}</span>`;
      }
    }

    function updateVerificationUI() {
      const app = providerApplication;
      let expiringDocs = [];
      let expiredDocs = [];
      
      // License verification
      const licenseItem = document.getElementById('verify-license');
      const licenseStatus = licenseItem.querySelector('.verify-status');
      const licenseBadge = licenseItem.querySelector('.verify-badge');
      const licenseViewBtn = document.getElementById('license-view-btn');
      const licenseUploadStatus = document.getElementById('license-upload-status');
      
      if (app?.license_verified) {
        licenseStatus.textContent = '‚úì';
        licenseBadge.textContent = 'Verified';
        licenseBadge.style.background = 'var(--accent-green-soft)';
        licenseBadge.style.color = 'var(--accent-green)';
        licenseItem.style.borderColor = 'var(--accent-green)';
        // Check expiration
        const expBadge = getDocExpirationBadge(app.license_uploaded_at);
        const expStatus = getExpirationStatus(app.license_uploaded_at);
        licenseUploadStatus.innerHTML = expBadge;
        if (expStatus.status === 'expired') expiredDocs.push('Business License');
        else if (expStatus.status === 'expiring_soon') expiringDocs.push('Business License');
      } else if (app?.business_license_url) {
        licenseStatus.textContent = 'üìÑ';
        licenseBadge.textContent = 'Under Review';
        licenseBadge.style.background = 'var(--accent-blue-soft)';
        licenseBadge.style.color = 'var(--accent-blue)';
        licenseViewBtn.href = app.business_license_url;
        licenseViewBtn.style.display = 'inline-flex';
        const expBadge = getDocExpirationBadge(app.license_uploaded_at);
        licenseUploadStatus.innerHTML = '<span style="color:var(--accent-blue);">‚úì Document uploaded - awaiting verification</span>' + expBadge;
      }

      // Insurance verification
      const insuranceItem = document.getElementById('verify-insurance');
      const insuranceStatus = insuranceItem.querySelector('.verify-status');
      const insuranceBadge = insuranceItem.querySelector('.verify-badge');
      const insuranceViewBtn = document.getElementById('insurance-view-btn');
      const insuranceUploadStatus = document.getElementById('insurance-upload-status');
      
      if (app?.insurance_verified) {
        insuranceStatus.textContent = '‚úì';
        insuranceBadge.textContent = 'Verified';
        insuranceBadge.style.background = 'var(--accent-green-soft)';
        insuranceBadge.style.color = 'var(--accent-green)';
        insuranceItem.style.borderColor = 'var(--accent-green)';
        // Check expiration
        const expBadge = getDocExpirationBadge(app.insurance_uploaded_at);
        const expStatus = getExpirationStatus(app.insurance_uploaded_at);
        insuranceUploadStatus.innerHTML = expBadge;
        if (expStatus.status === 'expired') expiredDocs.push('Insurance Certificate');
        else if (expStatus.status === 'expiring_soon') expiringDocs.push('Insurance Certificate');
      } else if (app?.insurance_document_url) {
        insuranceStatus.textContent = 'üìÑ';
        insuranceBadge.textContent = 'Under Review';
        insuranceBadge.style.background = 'var(--accent-blue-soft)';
        insuranceBadge.style.color = 'var(--accent-blue)';
        insuranceViewBtn.href = app.insurance_document_url;
        insuranceViewBtn.style.display = 'inline-flex';
        const expBadge = getDocExpirationBadge(app.insurance_uploaded_at);
        insuranceUploadStatus.innerHTML = '<span style="color:var(--accent-blue);">‚úì Document uploaded - awaiting verification</span>' + expBadge;
      }

      // Certifications verification
      const certsItem = document.getElementById('verify-certifications');
      const certsStatus = certsItem.querySelector('.verify-status');
      const certsBadge = certsItem.querySelector('.verify-badge');
      const certsViewBtn = document.getElementById('certifications-view-btn');
      const certsUploadStatus = document.getElementById('certifications-upload-status');
      
      if (app?.certifications_verified) {
        certsStatus.textContent = '‚úì';
        certsBadge.textContent = 'Verified';
        certsBadge.style.background = 'var(--accent-green-soft)';
        certsBadge.style.color = 'var(--accent-green)';
        certsItem.style.borderColor = 'var(--accent-green)';
        // Check expiration
        const expBadge = getDocExpirationBadge(app.certifications_uploaded_at);
        const expStatus = getExpirationStatus(app.certifications_uploaded_at);
        certsUploadStatus.innerHTML = expBadge;
        if (expStatus.status === 'expired') expiredDocs.push('Certifications');
        else if (expStatus.status === 'expiring_soon') expiringDocs.push('Certifications');
      } else if (app?.certifications_url) {
        certsStatus.textContent = 'üìÑ';
        certsBadge.textContent = 'Under Review';
        certsBadge.style.background = 'var(--accent-blue-soft)';
        certsBadge.style.color = 'var(--accent-blue)';
        certsViewBtn.href = app.certifications_url;
        certsViewBtn.style.display = 'inline-flex';
        const expBadge = getDocExpirationBadge(app.certifications_uploaded_at);
        certsUploadStatus.innerHTML = '<span style="color:var(--accent-blue);">‚úì Document uploaded - awaiting verification</span>' + expBadge;
      }

      // Show verified badge if all three are verified
      if (app?.license_verified && app?.insurance_verified && app?.certifications_verified) {
        document.getElementById('verified-badge-container').style.display = 'block';
      } else {
        document.getElementById('verified-badge-container').style.display = 'none';
      }

      // Show expiration warnings at top of profile section
      let warningHtml = '';
      if (expiredDocs.length > 0) {
        warningHtml += `<div class="expiration-warning">‚ö†Ô∏è <strong>Expired Documents:</strong> ${expiredDocs.join(', ')} - Please re-upload to maintain your verified status.</div>`;
      }
      if (expiringDocs.length > 0) {
        warningHtml += `<div class="expiration-warning warning">‚è∞ <strong>Expiring Soon:</strong> ${expiringDocs.join(', ')} - Please update these documents before they expire.</div>`;
      }
      
      let warningContainer = document.getElementById('doc-expiration-warnings');
      if (!warningContainer) {
        warningContainer = document.createElement('div');
        warningContainer.id = 'doc-expiration-warnings';
        const profileSection = document.getElementById('profile');
        if (profileSection) {
          profileSection.insertBefore(warningContainer, profileSection.firstChild);
        }
      }
      warningContainer.innerHTML = warningHtml;
    }

    async function uploadVerificationDoc(docType) {
      const fileInputId = `${docType}-file-input`;
      const statusId = `${docType}-upload-status`;
      const viewBtnId = `${docType}-view-btn`;
      
      const fileInput = document.getElementById(fileInputId);
      const statusEl = document.getElementById(statusId);
      const viewBtn = document.getElementById(viewBtnId);
      
      const file = fileInput.files[0];
      if (!file) return;

      // Validate file type
      const allowedTypes = ['application/pdf', 'image/jpeg', 'image/jpg', 'image/png'];
      if (!allowedTypes.includes(file.type)) {
        showToast('Please upload a PDF, JPG, or PNG file.', 'error');
        return;
      }

      // Validate file size (max 10MB)
      if (file.size > 10 * 1024 * 1024) {
        showToast('File size must be less than 10MB.', 'error');
        return;
      }

      statusEl.innerHTML = '<span style="color:var(--accent-gold);">‚è≥ Uploading...</span>';

      try {
        // Create unique filename
        const ext = file.name.split('.').pop();
        const fileName = `${currentUser.id}/${docType}_${Date.now()}.${ext}`;

        // Upload to Supabase Storage
        const { data: uploadData, error: uploadError } = await supabaseClient.storage
          .from('provider-docs')
          .upload(fileName, file, {
            cacheControl: '3600',
            upsert: true
          });

        if (uploadError) throw uploadError;

        // Get public URL
        const { data: urlData } = supabaseClient.storage
          .from('provider-docs')
          .getPublicUrl(fileName);

        const publicUrl = urlData.publicUrl;

        // Determine which field to update
        const fieldMap = {
          'license': 'business_license_url',
          'insurance': 'insurance_document_url',
          'certifications': 'certifications_url'
        };
        const fieldDateMap = {
          'license': 'license_uploaded_at',
          'insurance': 'insurance_uploaded_at',
          'certifications': 'certifications_uploaded_at'
        };
        const fieldName = fieldMap[docType];
        const fieldDateName = fieldDateMap[docType];

        // Check if provider_application exists, if not create one
        const uploadTimestamp = new Date().toISOString();
        if (!providerApplication) {
          const { data: newApp, error: createError } = await supabaseClient
            .from('provider_applications')
            .insert({
              user_id: currentUser.id,
              business_name: providerProfile?.business_name || 'Provider',
              contact_name: providerProfile?.full_name || '',
              email: currentUser.email,
              status: 'pending',
              [fieldName]: publicUrl,
              [fieldDateName]: uploadTimestamp
            })
            .select()
            .single();

          if (createError) throw createError;
          providerApplication = newApp;
        } else {
          // Update existing application
          const { error: updateError } = await supabaseClient
            .from('provider_applications')
            .update({ 
              [fieldName]: publicUrl,
              [fieldDateName]: uploadTimestamp,
              updated_at: new Date().toISOString()
            })
            .eq('id', providerApplication.id);

          if (updateError) throw updateError;
          providerApplication[fieldName] = publicUrl;
          providerApplication[fieldDateName] = uploadTimestamp;
        }

        // Update UI
        statusEl.innerHTML = '<span style="color:var(--accent-green);">‚úì Uploaded successfully - awaiting verification</span>';
        viewBtn.href = publicUrl;
        viewBtn.style.display = 'inline-flex';
        
        showToast('Document uploaded! Our team will review it within 1-2 business days.', 'success');
        
        // Refresh verification status
        await loadVerificationStatus();

      } catch (err) {
        console.error('Upload error:', err);
        statusEl.innerHTML = '<span style="color:var(--accent-red);">‚úó Upload failed - please try again</span>';
        showToast('Failed to upload document: ' + err.message, 'error');
      }

      // Clear file input
      fileInput.value = '';
    }

    function updateProfileCompletion(profile) {
      let score = 0;
      let total = 7;

      if (profile.business_name) score++;
      if (profile.full_name) score++;
      if (profile.business_phone) score++;
      if (profile.business_address) score++;
      if (profile.services_offered?.length > 0) score++;
      if (profile.certifications?.length > 0) score++;
      if (profile.description) score++;

      const pct = Math.round((score / total) * 100);
      document.getElementById('profile-completion-pct').textContent = pct + '%';
      document.getElementById('profile-completion-bar').style.width = pct + '%';

      // Update bar color based on completion
      const bar = document.getElementById('profile-completion-bar');
      if (pct < 50) {
        bar.style.background = 'var(--accent-red)';
      } else if (pct < 80) {
        bar.style.background = 'var(--accent-orange)';
      } else {
        bar.style.background = 'linear-gradient(90deg, var(--accent-gold), #c49a45)';
      }
    }

    async function saveProviderProfile() {
      // Gather services
      const services = [];
      document.querySelectorAll('#services-grid input[type="checkbox"]:checked').forEach(cb => {
        services.push(cb.value);
      });

      // Gather certifications
      const certs = [];
      document.querySelectorAll('#certifications-grid input[type="checkbox"]:checked').forEach(cb => {
        certs.push(cb.value);
      });
      
      // Add other certs
      const otherCerts = document.getElementById('profile-other-certs').value
        .split(',')
        .map(c => c.trim())
        .filter(c => c);
      certs.push(...otherCerts);

      // Gather ZIP codes
      const zipCodes = document.getElementById('profile-zip-codes').value
        .split(',')
        .map(z => z.trim())
        .filter(z => z);

      // Gather emergency services
      const emergencyServices = [];
      document.querySelectorAll('.emergency-service-check:checked').forEach(cb => {
        emergencyServices.push(cb.value);
      });

      const profileData = {
        business_name: document.getElementById('profile-business-name').value.trim() || null,
        full_name: document.getElementById('profile-full-name').value.trim() || null,
        business_phone: document.getElementById('profile-phone').value.trim() || null,
        business_address: document.getElementById('profile-address').value.trim() || null,
        years_in_business: document.getElementById('profile-years').value ? parseInt(document.getElementById('profile-years').value) : null,
        services_offered: services.length > 0 ? services : null,
        certifications: certs.length > 0 ? certs : null,
        service_areas: zipCodes.length > 0 ? zipCodes : null,
        description: document.getElementById('profile-description').value.trim() || null,
        business_hours: getBusinessHours(),
        emergency_enabled: document.getElementById('emergency-accept-calls')?.checked || false,
        emergency_services: emergencyServices.length > 0 ? emergencyServices : null,
        emergency_radius: parseInt(document.getElementById('emergency-radius')?.value) || 15,
        is_24_seven: document.getElementById('emergency-24-7')?.checked || false,
        can_tow: document.getElementById('emergency-can-tow')?.checked || false,
        updated_at: new Date().toISOString()
      };

      const { error } = await supabaseClient
        .from('profiles')
        .update(profileData)
        .eq('id', currentUser.id);

      if (error) {
        console.error('Error saving profile:', error);
        showToast('Failed to save profile: ' + error.message, 'error');
        return;
      }

      // Update sidebar display
      if (profileData.business_name || profileData.full_name) {
        document.getElementById('user-name').textContent = profileData.business_name || profileData.full_name;
        document.getElementById('user-avatar').textContent = (profileData.business_name || profileData.full_name)[0].toUpperCase();
      }

      showToast('Profile saved successfully!', 'success');
      
      // Recalculate completion
      const { data: updatedProfile } = await supabaseClient
        .from('profiles')
        .select('*')
        .eq('id', currentUser.id)
        .single();
      
      if (updatedProfile) {
        updateProfileCompletion(updatedProfile);
      }
    }

    // ========== AVAILABILITY MANAGEMENT ==========
    let blockedDates = [];

    function getBusinessHours() {
      const days = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'];
      const hours = {};
      
      days.forEach(day => {
        const isOpen = document.getElementById(`hours-${day}-open`)?.checked;
        hours[day] = {
          open: isOpen,
          start: document.getElementById(`hours-${day}-start`)?.value || '09:00',
          end: document.getElementById(`hours-${day}-end`)?.value || '17:00'
        };
      });
      
      return hours;
    }

    function setBusinessHours(hours) {
      if (!hours) return;
      
      const days = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'];
      days.forEach(day => {
        if (hours[day]) {
          const openCheckbox = document.getElementById(`hours-${day}-open`);
          const startInput = document.getElementById(`hours-${day}-start`);
          const endInput = document.getElementById(`hours-${day}-end`);
          
          if (openCheckbox) openCheckbox.checked = hours[day].open;
          if (startInput) startInput.value = hours[day].start || '09:00';
          if (endInput) endInput.value = hours[day].end || '17:00';
        }
      });
    }

    function addBlockedDate() {
      const startDate = document.getElementById('block-start').value;
      const endDate = document.getElementById('block-end').value || startDate;
      const reason = document.getElementById('block-reason').value.trim();

      if (!startDate) {
        showToast('Please select a start date', 'error');
        return;
      }

      if (new Date(endDate) < new Date(startDate)) {
        showToast('End date must be after start date', 'error');
        return;
      }

      blockedDates.push({
        start: startDate,
        end: endDate,
        reason: reason || null
      });

      // Clear inputs
      document.getElementById('block-start').value = '';
      document.getElementById('block-end').value = '';
      document.getElementById('block-reason').value = '';

      renderBlockedDates();
      showToast('Date blocked. Remember to save your profile!', 'success');
    }

    function removeBlockedDate(index) {
      blockedDates.splice(index, 1);
      renderBlockedDates();
    }

    function renderBlockedDates() {
      const container = document.getElementById('blocked-dates-list');
      
      if (!blockedDates.length) {
        container.innerHTML = '<p style="color:var(--text-muted);font-size:0.9rem;">No blocked dates.</p>';
        return;
      }

      container.innerHTML = blockedDates.map((block, i) => {
        const startFormatted = new Date(block.start + 'T00:00:00').toLocaleDateString();
        const endFormatted = new Date(block.end + 'T00:00:00').toLocaleDateString();
        const dateRange = block.start === block.end ? startFormatted : `${startFormatted} - ${endFormatted}`;
        
        return `
          <div style="display:flex;justify-content:space-between;align-items:center;padding:10px 14px;background:var(--bg-input);border-radius:var(--radius-sm);margin-bottom:8px;">
            <div>
              <span style="font-weight:500;">üö´ ${dateRange}</span>
              ${block.reason ? `<span style="color:var(--text-muted);margin-left:12px;">(${block.reason})</span>` : ''}
            </div>
            <button onclick="removeBlockedDate(${i})" style="background:none;border:none;color:var(--accent-red);cursor:pointer;font-size:1.1rem;">√ó</button>
          </div>
        `;
      }).join('');
    }

    // ========== BID CREDITS ==========
    let bidPacks = [];

    async function loadSubscription() {
      try {
        // Load available bid packs
        const { data: packs } = await supabaseClient
          .from('bid_packs')
          .select('*')
          .eq('is_active', true)
          .order('price', { ascending: true });
        
        bidPacks = packs || [];
        renderBidPacks();

        // Update balance display
        renderCreditBalance();

        // Load purchase history
        const { data: purchases } = await supabaseClient
          .from('bid_credit_purchases')
          .select('*, bid_packs(name)')
          .eq('provider_id', currentUser.id)
          .order('created_at', { ascending: false })
          .limit(10);

        renderPurchaseHistory(purchases || []);

        // Update sidebar badge
        updateCreditsBadge();

      } catch (err) {
        console.error('Error loading bid credits:', err);
      }
    }

    function renderCreditBalance() {
      const credits = providerProfile?.bid_credits || 0;
      const freeBids = providerProfile?.free_trial_bids || 0;
      const totalPurchased = providerProfile?.total_bids_purchased || 0;
      const totalUsed = providerProfile?.total_bids_used || 0;
      const totalAvailable = credits + freeBids;

      document.getElementById('credits-balance').textContent = totalAvailable;
      document.getElementById('browse-credits-count').textContent = totalAvailable;
      document.getElementById('free-bids-remaining').textContent = freeBids;
      document.getElementById('total-purchased').textContent = totalPurchased;
      document.getElementById('total-used').textContent = totalUsed;

      // Show warnings
      const lowWarning = document.getElementById('low-credits-warning');
      const noWarning = document.getElementById('no-credits-warning');
      
      lowWarning.style.display = 'none';
      noWarning.style.display = 'none';

      if (totalAvailable === 0) {
        noWarning.style.display = 'block';
      } else if (totalAvailable <= 3) {
        lowWarning.style.display = 'block';
      }
    }

    function renderBidPacks() {
      const container = document.getElementById('bid-packs-grid');
      
      if (!bidPacks.length) {
        container.innerHTML = '<p style="color:var(--text-muted);">No bid packs available.</p>';
        return;
      }

      container.innerHTML = bidPacks.map(pack => {
        const totalBids = pack.bid_count + (pack.bonus_bids || 0);
        const effectivePrice = (pack.price / totalBids).toFixed(2);
        
        return `
          <div style="background:var(--bg-elevated);border:2px solid ${pack.is_popular ? 'var(--accent-gold)' : 'var(--border-subtle)'};border-radius:var(--radius-lg);padding:20px;position:relative;text-align:center;">
            ${pack.is_popular ? '<div style="position:absolute;top:-10px;left:50%;transform:translateX(-50%);background:var(--accent-gold);color:#0a0a0f;font-size:0.7rem;font-weight:600;padding:3px 10px;border-radius:100px;">BEST VALUE</div>' : ''}
            
            <div style="font-size:2.5rem;margin-bottom:8px;">üéüÔ∏è</div>
            <h3 style="font-size:1.2rem;font-weight:600;margin-bottom:4px;">${pack.name}</h3>
            
            <div style="margin:16px 0;">
              <span style="font-size:2rem;font-weight:700;">${pack.bid_count}</span>
              <span style="color:var(--text-muted);"> bids</span>
              ${pack.bonus_bids > 0 ? `<div style="color:var(--accent-green);font-size:0.9rem;font-weight:500;">+${pack.bonus_bids} FREE bonus!</div>` : ''}
            </div>

            <div style="font-size:1.5rem;font-weight:600;color:var(--accent-gold);margin-bottom:4px;">$${pack.price.toFixed(2)}</div>
            <div style="font-size:0.8rem;color:var(--text-muted);margin-bottom:16px;">$${effectivePrice} per bid</div>

            <button class="btn ${pack.is_popular ? 'btn-primary' : 'btn-secondary'}" style="width:100%;" onclick="purchaseBidPack('${pack.id}')">
              Buy Now
            </button>
          </div>
        `;
      }).join('');
    }

    function renderPurchaseHistory(purchases) {
      const container = document.getElementById('purchase-history');
      
      if (!purchases.length) {
        container.innerHTML = '<p style="color:var(--text-muted);">No purchases yet.</p>';
        return;
      }

      container.innerHTML = `
        <table style="width:100%;border-collapse:collapse;">
          <thead>
            <tr style="border-bottom:1px solid var(--border-subtle);">
              <th style="text-align:left;padding:12px 8px;font-weight:500;color:var(--text-muted);font-size:0.85rem;">Date</th>
              <th style="text-align:left;padding:12px 8px;font-weight:500;color:var(--text-muted);font-size:0.85rem;">Pack</th>
              <th style="text-align:left;padding:12px 8px;font-weight:500;color:var(--text-muted);font-size:0.85rem;">Credits</th>
              <th style="text-align:right;padding:12px 8px;font-weight:500;color:var(--text-muted);font-size:0.85rem;">Amount</th>
            </tr>
          </thead>
          <tbody>
            ${purchases.map(p => `
              <tr style="border-bottom:1px solid var(--border-subtle);">
                <td style="padding:12px 8px;">${new Date(p.created_at).toLocaleDateString()}</td>
                <td style="padding:12px 8px;">${p.bid_packs?.name || 'Bid Pack'}</td>
                <td style="padding:12px 8px;">
                  ${p.bids_purchased}${p.bonus_bids > 0 ? ` <span style="color:var(--accent-green);">+${p.bonus_bids}</span>` : ''}
                </td>
                <td style="padding:12px 8px;text-align:right;">$${p.amount_paid.toFixed(2)}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    function updateCreditsBadge() {
      const badge = document.getElementById('sub-badge');
      const totalCredits = (providerProfile?.bid_credits || 0) + (providerProfile?.free_trial_bids || 0);
      
      if (totalCredits > 0) {
        badge.textContent = totalCredits;
        badge.style.display = 'inline';
        badge.style.background = 'var(--accent-gold)';
        badge.style.color = '#0a0a0f';
      } else {
        badge.textContent = '0';
        badge.style.display = 'inline';
        badge.style.background = 'var(--accent-red)';
        badge.style.color = 'white';
      }
    }

    // Stripe Checkout Endpoint (Server-side)
    const STRIPE_CHECKOUT_URL = '/api/create-bid-checkout';
    const USE_STRIPE = true; // Enable real Stripe checkout

    async function purchaseBidPack(packId) {
      const pack = bidPacks.find(p => p.id === packId);
      if (!pack) return;

      const totalBids = pack.bid_count + (pack.bonus_bids || 0);
      
      if (!confirm(`Purchase ${pack.name} pack?\n\n${pack.bid_count} bids${pack.bonus_bids > 0 ? ` + ${pack.bonus_bids} bonus` : ''} = ${totalBids} total bids\nPrice: $${pack.price.toFixed(2)}\n\nYou'll be redirected to complete payment.`)) {
        return;
      }

      // Production: Use Stripe Checkout
      if (USE_STRIPE) {
        try {
          showToast('Redirecting to checkout...', 'success');
          
          const session = await supabaseClient.auth.getSession();
          console.log('Session:', session.data.session ? 'exists' : 'missing');
          console.log('Pack ID:', pack.id);
          console.log('Provider ID:', currentUser.id);
          console.log('URL:', STRIPE_CHECKOUT_URL);
          
          const response = await fetch(STRIPE_CHECKOUT_URL, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${session.data.session?.access_token}`
            },
            body: JSON.stringify({
              packId: pack.id,
              providerId: currentUser.id
            })
          });
          
          console.log('Response status:', response.status);
          const data = await response.json();
          console.log('Response data:', data);
          
          if (data.error) throw new Error(data.error);
          if (!data.url) throw new Error('No checkout URL returned');
          
          // Redirect to Stripe Checkout
          window.location.href = data.url;
          
        } catch (err) {
          console.error('Checkout error:', err);
          showToast('Failed to start checkout: ' + err.message, 'error');
        }
        return;
      }

      // Demo mode: Add credits directly (for testing)
      try {
        // Record purchase
        const { error: purchaseError } = await supabaseClient.from('bid_credit_purchases').insert({
          provider_id: currentUser.id,
          pack_id: packId,
          bids_purchased: pack.bid_count,
          bonus_bids: pack.bonus_bids || 0,
          amount_paid: pack.price,
          status: 'completed'
        });

        if (purchaseError) throw purchaseError;

        // Add credits to profile
        const newCredits = (providerProfile?.bid_credits || 0) + totalBids;
        const newTotalPurchased = (providerProfile?.total_bids_purchased || 0) + totalBids;

        await supabaseClient.from('profiles').update({
          bid_credits: newCredits,
          total_bids_purchased: newTotalPurchased
        }).eq('id', currentUser.id);

        // Update local profile
        providerProfile.bid_credits = newCredits;
        providerProfile.total_bids_purchased = newTotalPurchased;

        showToast(`üéâ ${totalBids} bid credits added to your account! (Demo Mode)`, 'success');
        await loadSubscription();

      } catch (err) {
        console.error('Purchase error:', err);
        showToast('Failed to process purchase. Please try again.', 'error');
      }
    }

    // Handle return from Stripe Checkout
    function checkPurchaseStatus() {
      const params = new URLSearchParams(window.location.search);
      if (params.get('purchase') === 'success') {
        showToast('üéâ Purchase successful! Credits added to your account.', 'success');
        window.history.replaceState({}, '', 'providers.html');
        // Refresh to show updated credits
        setTimeout(() => loadSubscription(), 1000);
      } else if (params.get('purchase') === 'cancelled') {
        showToast('Purchase cancelled.', 'error');
        window.history.replaceState({}, '', 'providers.html');
      }
    }

    // ========== TEAM MEMBERS ==========
    let teamMembers = [];
    let pendingTeamPhoto = null;
    let editingTeamMemberId = null;

    async function loadTeamMembers() {
      try {
        const { data, error } = await supabaseClient
          .from('team_members')
          .select('*')
          .eq('provider_id', currentUser.id)
          .order('created_at', { ascending: false });

        if (error) {
          console.log('Team members table may not exist:', error);
          teamMembers = [];
          renderTeamMembers();
          return;
        }

        teamMembers = data || [];
        renderTeamMembers();
      } catch (err) {
        console.log('loadTeamMembers error:', err);
        teamMembers = [];
        renderTeamMembers();
      }
    }

    function renderTeamMembers() {
      const container = document.getElementById('team-members-grid');
      if (!container) return;

      if (!teamMembers.length) {
        container.innerHTML = `
          <div class="empty-state" style="grid-column:1/-1;">
            <div class="empty-state-icon">üë•</div>
            <p>No team members yet. Add your first team member to showcase your team!</p>
          </div>
        `;
        return;
      }

      const roleLabels = {
        'mechanic': 'Mechanic',
        'driver': 'Driver',
        'detailer': 'Detailer',
        'technician': 'Technician',
        'manager': 'Manager',
        'other': 'Team Member'
      };

      container.innerHTML = teamMembers.map(member => {
        const photoHtml = member.photo_url 
          ? `<img src="${member.photo_url}" alt="${member.name}">`
          : 'üë§';
        
        const certBadges = (member.certifications || []).slice(0, 3).map(cert => 
          `<span class="team-badge">${cert}</span>`
        ).join('');
        
        const hasMoreCerts = (member.certifications || []).length > 3;
        const moreCertsHtml = hasMoreCerts 
          ? `<span class="team-badge">+${member.certifications.length - 3}</span>` 
          : '';

        return `
          <div class="team-card">
            <div class="team-card-header">
              <div class="team-avatar">${photoHtml}</div>
              <div class="team-info">
                <div class="team-name">${member.name}</div>
                <span class="team-role">${roleLabels[member.role] || member.role}</span>
                ${member.years_experience ? `<div class="team-experience">üõ†Ô∏è ${member.years_experience} years experience</div>` : ''}
              </div>
            </div>
            ${member.bio ? `<div class="team-bio">${member.bio}</div>` : ''}
            ${(member.certifications?.length || member.specialties?.length) ? `
              <div class="team-badges">
                ${certBadges}
                ${moreCertsHtml}
              </div>
            ` : ''}
            <div style="margin-bottom:12px;">
              <span class="team-status-badge ${member.is_active ? 'active' : 'inactive'}">
                ${member.is_active ? '‚úì Active' : '‚óã Inactive'}
              </span>
            </div>
            <div class="team-actions">
              <button class="btn btn-secondary btn-sm" onclick="openTeamMemberModal('${member.id}')">‚úèÔ∏è Edit</button>
              <button class="btn btn-ghost btn-sm" onclick="deleteTeamMember('${member.id}')" style="color:var(--accent-red);">üóëÔ∏è Delete</button>
            </div>
          </div>
        `;
      }).join('');
    }

    function openTeamMemberModal(memberId = null) {
      editingTeamMemberId = memberId;
      pendingTeamPhoto = null;

      // Reset form
      document.getElementById('team-member-name').value = '';
      document.getElementById('team-member-role').value = '';
      document.getElementById('team-member-experience').value = '';
      document.getElementById('team-member-bio').value = '';
      document.getElementById('team-member-certifications').value = '';
      document.getElementById('team-member-specialties').value = '';
      document.getElementById('team-member-active').checked = true;
      document.getElementById('team-member-consent').checked = false;
      
      // Reset photo upload
      const photoUpload = document.getElementById('team-photo-upload');
      photoUpload.innerHTML = `
        <div class="team-photo-upload-icon">üì∑</div>
        <div class="team-photo-upload-text">Upload Photo</div>
      `;
      photoUpload.classList.remove('has-photo');
      document.getElementById('remove-team-photo-btn').style.display = 'none';

      if (memberId) {
        // Edit mode - populate form
        const member = teamMembers.find(m => m.id === memberId);
        if (member) {
          document.getElementById('team-modal-title').textContent = 'Edit Team Member';
          document.getElementById('team-member-name').value = member.name || '';
          document.getElementById('team-member-role').value = member.role || '';
          document.getElementById('team-member-experience').value = member.years_experience || '';
          document.getElementById('team-member-bio').value = member.bio || '';
          document.getElementById('team-member-certifications').value = (member.certifications || []).join(', ');
          document.getElementById('team-member-specialties').value = (member.specialties || []).join(', ');
          document.getElementById('team-member-active').checked = member.is_active !== false;

          if (member.photo_url) {
            photoUpload.innerHTML = `<img src="${member.photo_url}" alt="Team member photo">`;
            photoUpload.classList.add('has-photo');
            document.getElementById('remove-team-photo-btn').style.display = 'block';
          }
        }
      } else {
        document.getElementById('team-modal-title').textContent = 'Add Team Member';
      }

      document.getElementById('team-member-modal').classList.add('active');
    }

    function handleTeamPhotoSelect(event) {
      const file = event.target.files[0];
      if (!file) return;

      if (!file.type.startsWith('image/')) {
        showToast('Please select an image file', 'error');
        return;
      }

      if (file.size > 5 * 1024 * 1024) {
        showToast('Image must be less than 5MB', 'error');
        return;
      }

      pendingTeamPhoto = file;

      const reader = new FileReader();
      reader.onload = (e) => {
        const photoUpload = document.getElementById('team-photo-upload');
        photoUpload.innerHTML = `<img src="${e.target.result}" alt="Team member photo">`;
        photoUpload.classList.add('has-photo');
        document.getElementById('remove-team-photo-btn').style.display = 'block';
      };
      reader.readAsDataURL(file);
    }

    function removeTeamPhoto() {
      pendingTeamPhoto = null;
      const photoUpload = document.getElementById('team-photo-upload');
      photoUpload.innerHTML = `
        <div class="team-photo-upload-icon">üì∑</div>
        <div class="team-photo-upload-text">Upload Photo</div>
      `;
      photoUpload.classList.remove('has-photo');
      document.getElementById('remove-team-photo-btn').style.display = 'none';
      document.getElementById('team-photo-input').value = '';
    }

    async function uploadTeamPhoto(file) {
      const fileExt = file.name.split('.').pop();
      const fileName = `${currentUser.id}/${Date.now()}.${fileExt}`;
      
      const { data, error } = await supabaseClient.storage
        .from('team-photos')
        .upload(fileName, file, { upsert: true });

      if (error) {
        console.error('Photo upload error:', error);
        throw new Error('Failed to upload photo');
      }

      const { data: urlData } = supabaseClient.storage
        .from('team-photos')
        .getPublicUrl(fileName);

      return urlData.publicUrl;
    }

    async function saveTeamMember() {
      const name = document.getElementById('team-member-name').value.trim();
      const role = document.getElementById('team-member-role').value;
      const experience = document.getElementById('team-member-experience').value;
      const bio = document.getElementById('team-member-bio').value.trim();
      const certificationsStr = document.getElementById('team-member-certifications').value;
      const specialtiesStr = document.getElementById('team-member-specialties').value;
      const isActive = document.getElementById('team-member-active').checked;

      if (!name) {
        showToast('Please enter a name', 'error');
        return;
      }
      if (!role) {
        showToast('Please select a role', 'error');
        return;
      }

      // Require consent acknowledgment
      const hasConsent = document.getElementById('team-member-consent').checked;
      if (!hasConsent) {
        showToast('Please confirm you have permission to display this team member\'s information', 'error');
        return;
      }

      // Parse comma-separated values
      const certifications = certificationsStr ? certificationsStr.split(',').map(c => c.trim()).filter(c => c) : [];
      const specialties = specialtiesStr ? specialtiesStr.split(',').map(s => s.trim()).filter(s => s) : [];

      let photoUrl = null;

      // Handle photo upload
      if (pendingTeamPhoto) {
        try {
          photoUrl = await uploadTeamPhoto(pendingTeamPhoto);
        } catch (err) {
          console.error('Photo upload failed:', err);
          showToast('Photo upload failed. Saving without photo.', 'error');
        }
      } else if (editingTeamMemberId) {
        // Keep existing photo if editing and no new photo selected
        const existingMember = teamMembers.find(m => m.id === editingTeamMemberId);
        photoUrl = existingMember?.photo_url || null;
        
        // Check if photo was removed
        if (!document.getElementById('team-photo-upload').classList.contains('has-photo')) {
          photoUrl = null;
        }
      }

      const teamMemberData = {
        name,
        role,
        bio: bio || null,
        years_experience: experience ? parseInt(experience) : null,
        certifications,
        specialties,
        photo_url: photoUrl,
        is_active: isActive,
        updated_at: new Date().toISOString()
      };

      try {
        if (editingTeamMemberId) {
          // Update existing
          const { error } = await supabaseClient
            .from('team_members')
            .update(teamMemberData)
            .eq('id', editingTeamMemberId)
            .eq('provider_id', currentUser.id);

          if (error) throw error;
          showToast('Team member updated!', 'success');
        } else {
          // Insert new
          teamMemberData.provider_id = currentUser.id;
          const { error } = await supabaseClient
            .from('team_members')
            .insert(teamMemberData);

          if (error) throw error;
          showToast('Team member added!', 'success');
        }

        closeModal('team-member-modal');
        await loadTeamMembers();
      } catch (err) {
        console.error('Save team member error:', err);
        showToast('Failed to save team member: ' + (err.message || 'Unknown error'), 'error');
      }
    }

    async function deleteTeamMember(memberId) {
      const member = teamMembers.find(m => m.id === memberId);
      if (!member) return;

      if (!confirm(`Are you sure you want to delete ${member.name}?`)) {
        return;
      }

      try {
        const { error } = await supabaseClient
          .from('team_members')
          .delete()
          .eq('id', memberId)
          .eq('provider_id', currentUser.id);

        if (error) throw error;

        showToast('Team member deleted', 'success');
        await loadTeamMembers();
      } catch (err) {
        console.error('Delete team member error:', err);
        showToast('Failed to delete team member', 'error');
      }
    }

    // ========== NOTIFICATIONS ==========
    let notifications = [];

    async function loadNotifications() {
      try {
        const { data, error } = await supabaseClient
          .from('notifications')
          .select('*')
          .eq('user_id', currentUser.id)
          .order('created_at', { ascending: false })
          .limit(50);

        if (error) {
          console.log('Notifications table may not exist:', error);
          return;
        }

        notifications = data || [];
        renderNotifications();
        updateNotificationBadge();
      } catch (err) {
        console.log('loadNotifications error:', err);
      }
    }

    function updateNotificationBadge() {
      const unreadCount = notifications.filter(n => !n.read).length;
      const badge = document.getElementById('notif-count');
      if (badge) {
        if (unreadCount > 0) {
          badge.textContent = unreadCount > 9 ? '9+' : unreadCount;
          badge.style.display = 'inline';
        } else {
          badge.style.display = 'none';
        }
      }
    }

    function renderNotifications() {
      const container = document.getElementById('notifications-list');
      if (!container) return;
      
      if (!notifications.length) {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üîî</div><p>No notifications yet.</p></div>';
        return;
      }

      const notifIcons = {
        'bid_accepted': 'üéâ',
        'new_package': 'üì¶',
        'message_received': 'üí¨',
        'payment_received': 'üí∞',
        'review_received': '‚≠ê',
        'default': 'üì¢'
      };

      container.innerHTML = notifications.map(n => {
        const icon = notifIcons[n.type] || notifIcons['default'];
        const timeAgo = formatTimeAgo(n.created_at);
        
        return `
          <div class="notification-item" onclick="handleNotificationClick('${n.id}', '${n.link_type || ''}', '${n.link_id || ''}')" style="display:flex;gap:16px;padding:16px 20px;background:${n.read ? 'var(--bg-card)' : 'var(--accent-gold-soft)'};border:1px solid ${n.read ? 'var(--border-subtle)' : 'rgba(212,168,85,0.3)'};border-radius:var(--radius-md);margin-bottom:12px;cursor:pointer;transition:all 0.15s;">
            <div style="font-size:24px;">${icon}</div>
            <div style="flex:1;">
              <div style="font-weight:${n.read ? '400' : '600'};margin-bottom:4px;">${n.title}</div>
              ${n.message ? `<div style="font-size:0.9rem;color:var(--text-secondary);line-height:1.5;">${n.message}</div>` : ''}
              <div style="font-size:0.8rem;color:var(--text-muted);margin-top:8px;">${timeAgo}</div>
            </div>
            ${!n.read ? '<div style="width:10px;height:10px;background:var(--accent-gold);border-radius:50%;flex-shrink:0;margin-top:6px;"></div>' : ''}
          </div>
        `;
      }).join('');
    }

    function formatTimeAgo(timestamp) {
      const date = new Date(timestamp);
      const now = new Date();
      const diff = now - date;
      
      const minutes = Math.floor(diff / 60000);
      const hours = Math.floor(diff / 3600000);
      const days = Math.floor(diff / 86400000);
      
      if (minutes < 1) return 'Just now';
      if (minutes < 60) return `${minutes}m ago`;
      if (hours < 24) return `${hours}h ago`;
      if (days < 7) return `${days}d ago`;
      return date.toLocaleDateString();
    }

    async function handleNotificationClick(notifId, linkType, linkId) {
      await supabaseClient
        .from('notifications')
        .update({ read: true, read_at: new Date().toISOString() })
        .eq('id', notifId);

      if (linkType === 'package' && linkId) {
        showSection('jobs');
      } else if (linkType === 'message') {
        showSection('messages');
      }

      await loadNotifications();
    }

    async function markAllNotificationsRead() {
      const unreadIds = notifications.filter(n => !n.read).map(n => n.id);
      if (!unreadIds.length) {
        showToast('All notifications already read', 'success');
        return;
      }

      await supabaseClient
        .from('notifications')
        .update({ read: true, read_at: new Date().toISOString() })
        .in('id', unreadIds);

      showToast('All notifications marked as read', 'success');
      await loadNotifications();
    }

    // ========== EMERGENCY FUNCTIONS ==========
    function setupEmergencySettings() {
      const acceptCheckbox = document.getElementById('emergency-accept-calls');
      const detailsSection = document.getElementById('emergency-settings-details');
      
      if (acceptCheckbox) {
        acceptCheckbox.addEventListener('change', () => {
          detailsSection.style.display = acceptCheckbox.checked ? 'block' : 'none';
        });
        
        if (providerProfile?.emergency_enabled) {
          acceptCheckbox.checked = true;
          detailsSection.style.display = 'block';
        }
        
        if (providerProfile?.emergency_services) {
          providerProfile.emergency_services.forEach(svc => {
            const cb = document.querySelector(`.emergency-service-check[value="${svc}"]`);
            if (cb) cb.checked = true;
          });
        }
        
        if (providerProfile?.emergency_radius) {
          document.getElementById('emergency-radius').value = providerProfile.emergency_radius;
        }
        if (providerProfile?.is_24_seven) {
          document.getElementById('emergency-24-7').checked = true;
        }
        if (providerProfile?.can_tow) {
          document.getElementById('emergency-can-tow').checked = true;
        }
      }
    }

    function getProviderLocation() {
      return new Promise((resolve) => {
        if (!navigator.geolocation) {
          resolve(null);
          return;
        }
        navigator.geolocation.getCurrentPosition(
          (pos) => {
            providerLocation = { lat: pos.coords.latitude, lng: pos.coords.longitude };
            resolve(providerLocation);
          },
          () => resolve(null),
          { enableHighAccuracy: true, timeout: 10000 }
        );
      });
    }

    async function refreshEmergencies() {
      await loadNearbyEmergencies();
      await loadMyActiveEmergency();
    }

    async function loadNearbyEmergencies() {
      const noticeEl = document.getElementById('emergency-settings-notice');
      const queueEl = document.getElementById('emergency-queue');
      
      if (!providerProfile?.emergency_enabled) {
        noticeEl.style.display = 'block';
        queueEl.innerHTML = '<div class="empty-state" style="padding:24px;"><p style="color:var(--text-muted);">Enable emergency services in your profile to see requests.</p></div>';
        return;
      }
      
      noticeEl.style.display = 'none';
      
      const location = await getProviderLocation();
      if (!location) {
        queueEl.innerHTML = '<div class="empty-state" style="padding:24px;"><p style="color:var(--text-muted);">üìç Enable location to see nearby emergencies</p></div>';
        return;
      }

      try {
        const radius = providerProfile.emergency_radius || 15;
        const { data, error } = await getNearbyEmergencies(location.lat, location.lng, radius);
        
        if (error) throw error;
        
        nearbyEmergencies = data || [];
        renderEmergencyQueue();
        updateEmergencyBadge();
      } catch (err) {
        console.error('Error loading emergencies:', err);
        queueEl.innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚ö†Ô∏è</div><p>Failed to load emergencies</p></div>';
      }
    }

    async function loadMyActiveEmergency() {
      try {
        const { data } = await supabaseClient
          .from('emergency_requests')
          .select('*, member:member_id(full_name, phone), vehicles(year, make, model)')
          .eq('assigned_provider_id', currentUser.id)
          .in('status', ['accepted', 'en_route', 'arrived', 'in_progress'])
          .single();
        
        myActiveEmergency = data;
        renderMyActiveEmergency();
      } catch (err) {
        myActiveEmergency = null;
        renderMyActiveEmergency();
      }
    }

    function updateEmergencyBadge() {
      const badge = document.getElementById('emergency-count');
      const count = nearbyEmergencies.length;
      if (count > 0) {
        badge.textContent = count > 9 ? '9+' : count;
        badge.style.display = 'inline';
      } else {
        badge.style.display = 'none';
      }
    }

    let emergencyCountdownIntervals = {};

    function renderEmergencyQueue() {
      const container = document.getElementById('emergency-queue');
      
      // Clear existing countdown intervals
      Object.values(emergencyCountdownIntervals).forEach(clearInterval);
      emergencyCountdownIntervals = {};
      
      if (!nearbyEmergencies.length) {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚úÖ</div><p>No pending emergencies nearby</p></div>';
        return;
      }
      
      const typeLabels = {
        'flat_tire': 'üõû Flat Tire',
        'dead_battery': 'üîã Dead Battery',
        'lockout': 'üîê Locked Out',
        'tow_needed': 'üöõ Tow Needed',
        'fuel_delivery': '‚õΩ Out of Fuel',
        'accident': 'üí• Accident',
        'other': '‚ùì Other'
      };
      
      const totalCredits = (providerProfile?.bid_credits || 0) + (providerProfile?.free_trial_bids || 0);
      const hasCredits = totalCredits >= 1;
      
      container.innerHTML = nearbyEmergencies.map(e => {
        const timeAgo = formatTimeAgo(e.created_at);
        const distance = e.distance_miles ? `${e.distance_miles.toFixed(1)} mi away` : 'Nearby';
        const escrowAmount = e.escrow_amount ? `$${parseFloat(e.escrow_amount).toFixed(2)}` : 'Pending';
        
        // Calculate time remaining for claim
        let countdownHtml = '';
        let urgencyClass = '';
        if (e.claim_deadline) {
          const deadline = new Date(e.claim_deadline);
          const now = new Date();
          const diffMs = deadline - now;
          const diffSecs = Math.max(0, Math.floor(diffMs / 1000));
          const mins = Math.floor(diffSecs / 60);
          const secs = diffSecs % 60;
          
          if (diffSecs <= 120) urgencyClass = 'urgent';
          countdownHtml = `<span class="countdown-timer ${urgencyClass}" id="countdown-${e.id}" data-deadline="${e.claim_deadline}">‚è±Ô∏è Claim in ${mins}:${secs.toString().padStart(2, '0')}</span>`;
        }
        
        const claimCostHtml = hasCredits
          ? `<span style="font-size:0.85rem;color:var(--accent-gold);">üéüÔ∏è 1 bid credit to claim</span>`
          : `<span style="font-size:0.85rem;color:var(--accent-red);">‚ö†Ô∏è Need 1 bid credit to claim</span>`;
        
        return `
          <div class="emergency-card ${urgencyClass ? 'urgent-emergency' : ''}">
            <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px;">
              <div>
                <span class="emergency-type-badge">${typeLabels[e.emergency_type] || e.emergency_type}</span>
                <div style="margin-top:8px;">
                  <span class="emergency-distance">üìç ${distance}</span>
                  <span class="emergency-time" style="margin-left:12px;">‚è±Ô∏è ${timeAgo}</span>
                </div>
              </div>
              <div style="text-align:right;">
                ${countdownHtml}
                <div style="font-size:1.1rem;font-weight:600;color:var(--accent-green);margin-top:4px;">üí∞ ${escrowAmount}</div>
                <div style="font-size:0.75rem;color:var(--text-muted);">escrow authorized</div>
              </div>
            </div>
            ${e.address ? `<div style="font-size:0.9rem;color:var(--text-secondary);margin-bottom:8px;">${e.address}</div>` : ''}
            ${e.description ? `<div style="font-size:0.9rem;color:var(--text-muted);margin-bottom:12px;">"${e.description.substring(0, 100)}${e.description.length > 100 ? '...' : ''}"</div>` : ''}
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;padding:10px;background:var(--bg-input);border-radius:var(--radius-sm);">
              ${claimCostHtml}
            </div>
            <div class="emergency-actions">
              <button class="btn btn-emergency" onclick="openAcceptEmergency('${e.id}')" ${!hasCredits ? 'disabled style="opacity:0.5;cursor:not-allowed;"' : ''}>üöó Claim Emergency</button>
              <button class="btn btn-secondary" onclick="viewEmergencyDetails('${e.id}')">View Details</button>
            </div>
          </div>
        `;
      }).join('');
      
      // Start countdown timers
      nearbyEmergencies.forEach(e => {
        if (e.claim_deadline) {
          startEmergencyCountdown(e.id, e.claim_deadline);
        }
      });
    }

    function startEmergencyCountdown(emergencyId, deadlineStr) {
      const el = document.getElementById(`countdown-${emergencyId}`);
      if (!el) return;
      
      const deadline = new Date(deadlineStr);
      
      emergencyCountdownIntervals[emergencyId] = setInterval(() => {
        const now = new Date();
        const diffMs = deadline - now;
        const diffSecs = Math.max(0, Math.floor(diffMs / 1000));
        const mins = Math.floor(diffSecs / 60);
        const secs = diffSecs % 60;
        
        if (diffSecs <= 0) {
          clearInterval(emergencyCountdownIntervals[emergencyId]);
          el.textContent = '‚è±Ô∏è Expired';
          el.classList.add('expired');
          el.classList.remove('urgent');
          // Refresh the queue after a short delay
          setTimeout(() => refreshEmergencies(), 1000);
          return;
        }
        
        el.textContent = `‚è±Ô∏è Claim in ${mins}:${secs.toString().padStart(2, '0')}`;
        
        if (diffSecs <= 120 && !el.classList.contains('urgent')) {
          el.classList.add('urgent');
        }
      }, 1000);
    }

    function renderMyActiveEmergency() {
      const container = document.getElementById('my-active-emergency');
      
      if (!myActiveEmergency) {
        container.innerHTML = '<div class="empty-state" style="padding:24px;"><p style="color:var(--text-muted);">No active emergency job</p></div>';
        return;
      }
      
      const e = myActiveEmergency;
      const typeLabels = {
        'flat_tire': 'üõû Flat Tire',
        'dead_battery': 'üîã Dead Battery',
        'lockout': 'üîê Locked Out',
        'tow_needed': 'üöõ Tow Needed',
        'fuel_delivery': '‚õΩ Out of Fuel',
        'accident': 'üí• Accident',
        'other': '‚ùì Other'
      };
      
      const vehicleName = e.vehicles ? `${e.vehicles.year} ${e.vehicles.make} ${e.vehicles.model}` : 'Unknown vehicle';
      const memberName = e.member?.full_name || 'Member';
      const memberPhone = e.member?.phone;
      const etaMinutes = e.provider_eta_minutes || e.eta_minutes;
      const isTowing = ['tow_needed', 'accident'].includes(e.emergency_type);
      
      // Calculate ETA deadline from claimed_at/accepted_at
      let etaInfo = '';
      if (etaMinutes && (e.claimed_at || e.accepted_at)) {
        const startTime = new Date(e.claimed_at || e.accepted_at);
        const etaTime = new Date(startTime.getTime() + etaMinutes * 60 * 1000);
        const now = new Date();
        const diffMs = etaTime - now;
        const diffMins = Math.ceil(diffMs / 60000);
        
        if (diffMins > 0 && !e.provider_arrived_at) {
          etaInfo = `<div style="background:var(--accent-gold-soft);padding:12px;border-radius:var(--radius-sm);margin-bottom:16px;">
            <div style="font-size:0.85rem;color:var(--text-muted);">‚è±Ô∏è Your ETA Commitment</div>
            <div style="font-weight:600;color:var(--accent-gold);">Arrive in ${diffMins} minutes (${etaMinutes} min ETA)</div>
          </div>`;
        } else if (diffMins <= 0 && !e.provider_arrived_at) {
          etaInfo = `<div style="background:rgba(239,95,95,0.15);padding:12px;border-radius:var(--radius-sm);margin-bottom:16px;">
            <div style="font-size:0.85rem;color:var(--accent-red);">‚ö†Ô∏è ETA Overdue!</div>
            <div style="font-weight:600;color:var(--accent-red);">Please arrive ASAP or member may report no-show</div>
          </div>`;
        }
      }
      
      // Mark Arrived button for accepted/en_route status
      let markArrivedBtn = '';
      if (['accepted', 'en_route'].includes(e.status) && !e.provider_arrived_at) {
        markArrivedBtn = `<button class="btn btn-primary" onclick="markArrivedEmergency('${e.id}')">üìç Mark Arrived</button>`;
      }
      
      // Arrived confirmation
      let arrivedInfo = '';
      if (e.provider_arrived_at) {
        const arrivedTime = new Date(e.provider_arrived_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        arrivedInfo = `<div style="background:var(--accent-green-soft);padding:10px;border-radius:var(--radius-sm);margin-bottom:12px;font-size:0.9rem;">
          ‚úÖ Arrived at ${arrivedTime}
        </div>`;
      }
      
      let statusButtons = '';
      switch (e.status) {
        case 'accepted':
          statusButtons = `
            ${markArrivedBtn}
            <button class="btn btn-secondary" onclick="updateMyEmergencyStatus('${e.id}', 'en_route')">üöó I'm En Route</button>
          `;
          break;
        case 'en_route':
          statusButtons = markArrivedBtn || `<button class="btn btn-primary" onclick="updateMyEmergencyStatus('${e.id}', 'arrived')">üìç I've Arrived</button>`;
          break;
        case 'arrived':
          statusButtons = `<button class="btn btn-primary" onclick="updateMyEmergencyStatus('${e.id}', 'in_progress')">üîß Start Work</button>`;
          break;
        case 'in_progress':
          statusButtons = `<button class="btn btn-primary" onclick="openCompleteEmergency('${e.id}', ${isTowing})">‚úÖ Submit Invoice & Complete</button>`;
          break;
      }
      
      container.innerHTML = `
        <div class="emergency-card">
          <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:16px;">
            <div>
              <span class="emergency-type-badge">${typeLabels[e.emergency_type] || e.emergency_type}</span>
              <div style="font-size:0.9rem;color:var(--text-secondary);margin-top:8px;">${vehicleName}</div>
            </div>
            <span class="bid-status ${e.status}" style="text-transform:capitalize;">${e.status.replace('_', ' ')}</span>
          </div>
          
          ${etaInfo}
          ${arrivedInfo}
          
          <div style="background:var(--bg-elevated);padding:16px;border-radius:var(--radius-md);margin-bottom:16px;">
            <div style="font-weight:600;margin-bottom:8px;">üë§ ${memberName}</div>
            ${memberPhone ? `<a href="tel:${memberPhone}" class="btn btn-secondary btn-sm" style="margin-top:8px;">üìû Call Member</a>` : ''}
          </div>
          
          ${e.address ? `
            <div style="margin-bottom:16px;">
              <div style="font-size:0.85rem;color:var(--text-muted);margin-bottom:4px;">üìç Location</div>
              <div style="font-size:0.9rem;">${e.address}</div>
              <a href="https://www.google.com/maps/dir/?api=1&destination=${e.lat},${e.lng}" target="_blank" class="btn btn-secondary btn-sm" style="margin-top:8px;">üó∫Ô∏è Navigate</a>
            </div>
          ` : ''}
          
          ${e.escrow_amount ? `
            <div style="margin-bottom:16px;padding:12px;background:var(--bg-input);border-radius:var(--radius-sm);">
              <div style="font-size:0.85rem;color:var(--text-muted);">üí∞ Member Escrow Authorized</div>
              <div style="font-size:1.2rem;font-weight:600;color:var(--accent-green);">$${parseFloat(e.escrow_amount).toFixed(2)}</div>
            </div>
          ` : ''}
          
          ${e.description ? `<div style="font-size:0.9rem;color:var(--text-muted);margin-bottom:16px;">${e.description}</div>` : ''}
          
          <div style="display:flex;gap:12px;flex-wrap:wrap;">
            ${statusButtons}
          </div>
        </div>
      `;
    }

    async function markArrivedEmergency(emergencyId) {
      try {
        const { error } = await supabaseClient
          .from('emergency_requests')
          .update({
            provider_arrived_at: new Date().toISOString(),
            status: 'arrived',
            updated_at: new Date().toISOString()
          })
          .eq('id', emergencyId);
        
        if (error) throw error;
        
        showToast('üìç Marked as arrived!', 'success');
        await loadMyActiveEmergency();
      } catch (err) {
        console.error('Error marking arrived:', err);
        showToast('Failed to update: ' + err.message, 'error');
      }
    }

    function openAcceptEmergency(emergencyId) {
      document.getElementById('accept-emergency-id').value = emergencyId;
      document.getElementById('accept-eta').value = '';
      openModal('emergency-accept-modal');
    }

    async function confirmAcceptEmergency() {
      const emergencyId = document.getElementById('accept-emergency-id').value;
      const eta = parseInt(document.getElementById('accept-eta').value);
      
      if (!eta) {
        showToast('Please select your ETA', 'error');
        return;
      }
      
      // Check bid credits
      const bidCredits = providerProfile?.bid_credits || 0;
      const freeTrialBids = providerProfile?.free_trial_bids || 0;
      const totalCredits = bidCredits + freeTrialBids;
      
      if (totalCredits < 1) {
        showToast('You need at least 1 bid credit to claim an emergency', 'error');
        return;
      }
      
      try {
        // Deduct bid credit from provider profile
        let updateData = {};
        if (freeTrialBids > 0) {
          updateData.free_trial_bids = freeTrialBids - 1;
          providerProfile.free_trial_bids = freeTrialBids - 1;
        } else {
          updateData.bid_credits = bidCredits - 1;
          providerProfile.bid_credits = bidCredits - 1;
        }
        
        const { error: creditError } = await supabaseClient
          .from('profiles')
          .update(updateData)
          .eq('id', currentUser.id);
        
        if (creditError) throw new Error('Failed to deduct bid credit: ' + creditError.message);
        
        // Accept the emergency with bid_credits_spent=1
        const { error } = await respondToEmergency(emergencyId, currentUser.id, eta, 1);
        if (error) throw new Error(error);
        
        closeModal('emergency-accept-modal');
        showToast('üöó Emergency claimed! 1 bid credit deducted. Navigate to the member now.', 'success');
        await refreshEmergencies();
        await updateProviderStats();
        showSection('emergencies');
      } catch (err) {
        console.error('Error accepting emergency:', err);
        showToast('Failed to claim: ' + err.message, 'error');
      }
    }

    async function viewEmergencyDetails(emergencyId) {
      openModal('emergency-detail-modal');
      
      try {
        const emergency = nearbyEmergencies.find(e => e.id === emergencyId);
        if (!emergency) throw new Error('Emergency not found');
        
        const typeLabels = {
          'flat_tire': 'üõû Flat Tire',
          'dead_battery': 'üîã Dead Battery',
          'lockout': 'üîê Locked Out',
          'tow_needed': 'üöõ Tow Needed',
          'fuel_delivery': '‚õΩ Out of Fuel',
          'accident': 'üí• Accident',
          'other': '‚ùì Other'
        };
        
        const timeAgo = formatTimeAgo(emergency.created_at);
        
        document.getElementById('emergency-detail-content').innerHTML = `
          <div style="text-align:center;margin-bottom:20px;">
            <div style="font-size:48px;margin-bottom:8px;">${typeLabels[emergency.emergency_type]?.split(' ')[0] || 'üö®'}</div>
            <div style="font-size:1.2rem;font-weight:600;">${typeLabels[emergency.emergency_type] || emergency.emergency_type}</div>
            <div style="color:var(--text-muted);font-size:0.9rem;">Posted ${timeAgo}</div>
          </div>
          
          ${emergency.address ? `
            <div style="padding:16px;background:var(--bg-input);border-radius:var(--radius-md);margin-bottom:16px;">
              <div style="font-size:0.85rem;color:var(--text-muted);margin-bottom:4px;">üìç Location</div>
              <div>${emergency.address}</div>
              <a href="https://www.google.com/maps?q=${emergency.lat},${emergency.lng}" target="_blank" style="color:var(--accent-gold);font-size:0.9rem;">View on Map ‚Üí</a>
            </div>
          ` : ''}
          
          ${emergency.description ? `
            <div style="padding:16px;background:var(--bg-input);border-radius:var(--radius-md);margin-bottom:16px;">
              <div style="font-size:0.85rem;color:var(--text-muted);margin-bottom:4px;">Description</div>
              <div>${emergency.description}</div>
            </div>
          ` : ''}
          
          ${emergency.distance_miles ? `
            <div style="text-align:center;padding:16px;background:var(--accent-gold-soft);border-radius:var(--radius-md);">
              <div style="font-size:1.5rem;font-weight:600;color:var(--accent-gold);">${emergency.distance_miles.toFixed(1)} miles</div>
              <div style="color:var(--text-muted);font-size:0.9rem;">from your location</div>
            </div>
          ` : ''}
        `;
        
        document.getElementById('emergency-detail-footer').innerHTML = `
          <button class="btn btn-secondary" onclick="closeModal('emergency-detail-modal')">Close</button>
          <button class="btn btn-emergency" onclick="closeModal('emergency-detail-modal'); openAcceptEmergency('${emergencyId}')">üöó Accept Emergency</button>
        `;
      } catch (err) {
        document.getElementById('emergency-detail-content').innerHTML = `
          <div class="empty-state"><div class="empty-state-icon">‚ö†Ô∏è</div><p>Failed to load details</p></div>
        `;
      }
    }

    async function updateMyEmergencyStatus(emergencyId, newStatus) {
      try {
        const { error } = await updateEmergencyStatus(emergencyId, newStatus);
        if (error) throw new Error(error);
        
        showToast('Status updated!', 'success');
        await loadMyActiveEmergency();
      } catch (err) {
        console.error('Error updating status:', err);
        showToast('Failed to update status: ' + err.message, 'error');
      }
    }

    function openCompleteEmergency(emergencyId, isTowing = false) {
      document.getElementById('complete-emergency-id').value = emergencyId;
      document.getElementById('complete-is-towing').value = isTowing ? 'true' : 'false';
      document.getElementById('complete-notes').value = '';
      document.getElementById('complete-amount').value = '';
      document.getElementById('complete-actual-miles').value = '';
      
      // Show/hide miles field based on towing
      const milesGroup = document.getElementById('complete-miles-group');
      milesGroup.style.display = isTowing ? 'block' : 'none';
      
      // Show escrow amount
      const escrowDisplay = document.getElementById('complete-escrow-display');
      if (myActiveEmergency?.escrow_amount) {
        escrowDisplay.textContent = `$${parseFloat(myActiveEmergency.escrow_amount).toFixed(2)}`;
      } else {
        escrowDisplay.textContent = 'Not set';
      }
      
      openModal('emergency-complete-modal');
    }

    async function confirmCompleteEmergency() {
      const emergencyId = document.getElementById('complete-emergency-id').value;
      const notes = document.getElementById('complete-notes').value;
      const amount = parseFloat(document.getElementById('complete-amount').value) || 0;
      const isTowing = document.getElementById('complete-is-towing').value === 'true';
      const actualMiles = isTowing ? parseFloat(document.getElementById('complete-actual-miles').value) || null : null;
      
      if (amount <= 0) {
        showToast('Please enter a valid invoice amount', 'error');
        return;
      }
      
      if (isTowing && !actualMiles) {
        showToast('Please enter actual miles towed', 'error');
        return;
      }
      
      try {
        const { error } = await supabaseClient
          .from('emergency_requests')
          .update({
            status: 'completed',
            provider_invoice_amount: amount,
            provider_invoice_notes: notes,
            actual_miles: actualMiles,
            provider_invoice_submitted_at: new Date().toISOString(),
            completed_at: new Date().toISOString(),
            updated_at: new Date().toISOString()
          })
          .eq('id', emergencyId);
        
        if (error) throw error;
        
        // Create notification for member
        if (myActiveEmergency?.member_id) {
          await createNotification(
            myActiveEmergency.member_id,
            'emergency_completed',
            'Emergency Service Complete ‚úÖ',
            `Your emergency service has been completed. Invoice: $${amount.toFixed(2)}`,
            'emergency',
            emergencyId
          );
        }
        
        closeModal('emergency-complete-modal');
        showToast('üéâ Invoice submitted! Emergency completed successfully!', 'success');
        myActiveEmergency = null;
        renderMyActiveEmergency();
      } catch (err) {
        console.error('Error completing emergency:', err);
        showToast('Failed to complete: ' + err.message, 'error');
      }
    }

    function toggleSidebar() { 
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('sidebar-overlay');
      sidebar.classList.toggle('open'); 
      if (sidebar.classList.contains('open')) {
        overlay.style.display = 'block';
        document.querySelector('.mobile-close').style.display = 'flex';
        document.body.classList.add('sidebar-open');
      } else {
        overlay.style.display = 'none';
        document.body.classList.remove('sidebar-open');
      }
    }
    async function logout() { await supabaseClient.auth.signOut(); window.location.href = 'login.html'; }
    
    function switchToMember() {
      localStorage.setItem('mcc_portal', 'member');
      window.location.href = 'members.html';
    }

    document.querySelectorAll('.modal-backdrop').forEach(b => b.addEventListener('click', e => { if (e.target === b) b.classList.remove('active'); }));
    document.getElementById('message-input')?.addEventListener('keypress', e => { if (e.key === 'Enter') sendMessage(); });

    // ========== MULTI-POINT INSPECTION ==========
    let inspectionData = {};
    
    function toggleInspectionCategory(header) {
      const category = header.parentElement;
      category.classList.toggle('expanded');
    }
    
    function setInspectionStatus(btn, status) {
      const item = btn.closest('.inspection-item');
      const field = item.dataset.field;
      
      item.querySelectorAll('.inspection-status-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      inspectionData[field] = status;
      
      updateInspectionSummary();
    }
    
    function updateInspectionSummary() {
      let good = 0, fair = 0, attention = 0, urgent = 0;
      
      Object.values(inspectionData).forEach(status => {
        if (status === 'good') good++;
        else if (status === 'fair') fair++;
        else if (status === 'needs_attention') attention++;
        else if (status === 'urgent') urgent++;
      });
      
      document.getElementById('count-good').textContent = good;
      document.getElementById('count-fair').textContent = fair;
      document.getElementById('count-attention').textContent = attention;
      document.getElementById('count-urgent').textContent = urgent;
      
      const hasData = good + fair + attention + urgent > 0;
      document.getElementById('inspection-summary').style.display = hasData ? 'block' : 'none';
    }
    
    async function openInspectionModal(packageId, vehicleId) {
      document.getElementById('inspection-package-id').value = packageId;
      document.getElementById('inspection-vehicle-id').value = vehicleId;
      document.getElementById('inspection-report-id').value = '';
      inspectionData = {};
      
      document.querySelectorAll('.inspection-status-btn').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.inspection-measurement input').forEach(i => i.value = '');
      document.getElementById('inspection-notes').value = '';
      document.getElementById('inspection-recommendations').value = '';
      document.getElementById('inspection-type').value = 'standard';
      document.getElementById('inspection-photo-preview').innerHTML = '';
      document.getElementById('inspection-summary').style.display = 'none';
      
      try {
        const { data: existing } = await supabaseClient
          .from('inspection_reports')
          .select('*')
          .eq('package_id', packageId)
          .single();
        
        if (existing) {
          document.getElementById('inspection-report-id').value = existing.id;
          document.getElementById('inspection-type').value = existing.inspection_type || 'standard';
          document.getElementById('inspection-notes').value = existing.technician_notes || '';
          document.getElementById('inspection-recommendations').value = existing.recommendations || '';
          
          const fields = ['engine_oil', 'transmission_fluid', 'coolant_level', 'brake_fluid', 'power_steering_fluid',
            'brake_pads_front', 'brake_pads_rear', 'brake_rotors',
            'tire_front_left', 'tire_front_right', 'tire_rear_left', 'tire_rear_right', 'spare_tire',
            'battery', 'headlights', 'taillights', 'turn_signals',
            'serpentine_belt', 'hoses', 'wiper_blades', 'windshield',
            'shocks_struts', 'alignment', 'air_filter', 'cabin_filter'];
          
          fields.forEach(field => {
            if (existing[field]) {
              inspectionData[field] = existing[field];
              const item = document.querySelector(`.inspection-item[data-field="${field}"]`);
              if (item) {
                const btn = item.querySelector(`.inspection-status-btn.${existing[field]}`);
                if (btn) btn.classList.add('active');
              }
            }
          });
          
          if (existing.brake_pads_front_percent) document.getElementById('brake_pads_front_percent').value = existing.brake_pads_front_percent;
          if (existing.brake_pads_rear_percent) document.getElementById('brake_pads_rear_percent').value = existing.brake_pads_rear_percent;
          if (existing.tire_front_left_tread) document.getElementById('tire_front_left_tread').value = existing.tire_front_left_tread;
          if (existing.tire_front_right_tread) document.getElementById('tire_front_right_tread').value = existing.tire_front_right_tread;
          if (existing.tire_rear_left_tread) document.getElementById('tire_rear_left_tread').value = existing.tire_rear_left_tread;
          if (existing.tire_rear_right_tread) document.getElementById('tire_rear_right_tread').value = existing.tire_rear_right_tread;
          if (existing.battery_voltage) document.getElementById('battery_voltage').value = existing.battery_voltage;
          
          updateInspectionSummary();
        }
      } catch (e) {
        console.log('No existing inspection or error:', e);
      }
      
      openModal('inspection-modal');
    }
    
    function calculateOverallCondition() {
      let urgent = 0, attention = 0, fair = 0, good = 0;
      Object.values(inspectionData).forEach(status => {
        if (status === 'urgent') urgent++;
        else if (status === 'needs_attention') attention++;
        else if (status === 'fair') fair++;
        else if (status === 'good') good++;
      });
      
      if (urgent > 0) return 'needs_attention';
      if (attention > 2) return 'needs_attention';
      if (attention > 0 || fair > 3) return 'fair';
      if (fair > 0) return 'good';
      return 'excellent';
    }
    
    async function saveInspectionReport() {
      const packageId = document.getElementById('inspection-package-id').value;
      const vehicleId = document.getElementById('inspection-vehicle-id').value;
      const reportId = document.getElementById('inspection-report-id').value;
      
      let urgent = 0, attention = 0;
      Object.values(inspectionData).forEach(status => {
        if (status === 'urgent') urgent++;
        else if (status === 'needs_attention') attention++;
      });
      
      const reportData = {
        package_id: packageId,
        vehicle_id: vehicleId,
        provider_id: currentUser.id,
        inspection_type: document.getElementById('inspection-type').value,
        inspection_date: new Date().toISOString(),
        overall_condition: calculateOverallCondition(),
        urgent_items: urgent,
        attention_items: attention,
        technician_notes: document.getElementById('inspection-notes').value || null,
        recommendations: document.getElementById('inspection-recommendations').value || null,
        ...inspectionData,
        brake_pads_front_percent: parseInt(document.getElementById('brake_pads_front_percent').value) || null,
        brake_pads_rear_percent: parseInt(document.getElementById('brake_pads_rear_percent').value) || null,
        tire_front_left_tread: parseInt(document.getElementById('tire_front_left_tread').value) || null,
        tire_front_right_tread: parseInt(document.getElementById('tire_front_right_tread').value) || null,
        tire_rear_left_tread: parseInt(document.getElementById('tire_rear_left_tread').value) || null,
        tire_rear_right_tread: parseInt(document.getElementById('tire_rear_right_tread').value) || null,
        battery_voltage: parseFloat(document.getElementById('battery_voltage').value) || null,
        updated_at: new Date().toISOString()
      };
      
      try {
        let result;
        if (reportId) {
          result = await supabaseClient.from('inspection_reports').update(reportData).eq('id', reportId);
        } else {
          result = await supabaseClient.from('inspection_reports').insert(reportData);
        }
        
        if (result.error) throw result.error;
        
        closeModal('inspection-modal');
        showToast('üîç Inspection report saved successfully!', 'success');
        await loadActiveJobs();
      } catch (err) {
        console.error('Error saving inspection:', err);
        showToast('Failed to save inspection: ' + err.message, 'error');
      }
    }

    // ========== DESTINATION TASKS ==========
    let destinationTasks = [];
    let completedDestTasks = [];
    let currentDestFilter = 'all';
    let currentDestTask = null;

    const destServiceTypeLabels = {
      'airport_pickup': { icon: '‚úàÔ∏è', label: 'Airport Pickup', class: 'airport' },
      'airport_dropoff': { icon: '‚úàÔ∏è', label: 'Airport Drop-off', class: 'airport' },
      'parking': { icon: 'üÖøÔ∏è', label: 'Airport Parking', class: 'airport' },
      'dealership': { icon: 'üîß', label: 'Dealership', class: 'dealership' },
      'dealership_pickup': { icon: 'üîß', label: 'Dealership Pickup', class: 'dealership' },
      'dealership_dropoff': { icon: 'üîß', label: 'Dealership Drop-off', class: 'dealership' },
      'detailing': { icon: '‚ú®', label: 'Detailing', class: 'detail' },
      'detail': { icon: '‚ú®', label: 'Detail', class: 'detail' },
      'valet': { icon: 'üîë', label: 'Valet', class: 'valet' },
      'valet_event': { icon: 'üîë', label: 'Valet Event', class: 'valet' }
    };

    const destStatusLabels = {
      'pending': 'Pending',
      'assigned': 'Assigned',
      'accepted': 'Accepted',
      'en_route': 'En Route',
      'in_transit': 'In Transit',
      'picked_up': 'Picked Up',
      'in_progress': 'In Progress',
      'at_destination': 'At Destination',
      'parked': 'Parked',
      'returning': 'Returning',
      'completed': 'Completed',
      'cancelled': 'Cancelled'
    };

    const destStatusWorkflow = ['pending', 'assigned', 'en_route', 'picked_up', 'in_progress', 'at_destination', 'completed'];

    async function loadDestinationTasks() {
      if (!currentUser) return;
      
      try {
        const { data, error } = await getProviderDestinationServices(currentUser.id);
        if (error) throw error;
        
        destinationTasks = (data || []).filter(t => t.status !== 'completed' && t.status !== 'cancelled');
        completedDestTasks = (data || []).filter(t => t.status === 'completed');
        
        updateDestinationStats();
        renderDestinationTasks();
        updateDestinationBadge();
        renderCompletedTasksStats();
      } catch (err) {
        console.error('Error loading destination tasks:', err);
      }
    }

    let currentDestTypeFilter = 'all';
    let currentDestSort = 'time';

    function updateDestinationStats() {
      const today = new Date();
      const todayStr = today.toDateString();
      const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
      
      const todayTasks = destinationTasks.filter(t => {
        const taskDate = t.estimated_pickup_time ? new Date(t.estimated_pickup_time).toDateString() : null;
        return taskDate === todayStr;
      });
      
      const inProgress = destinationTasks.filter(t => ['en_route', 'in_transit', 'picked_up', 'in_progress'].includes(t.status)).length;
      
      const weekCompleted = completedDestTasks.filter(t => {
        const completedDate = t.completed_at ? new Date(t.completed_at) : null;
        return completedDate && completedDate >= weekAgo;
      });
      
      let avgTimeMinutes = 0;
      if (weekCompleted.length > 0) {
        const totalMinutes = weekCompleted.reduce((sum, t) => {
          if (t.created_at && t.completed_at) {
            const start = new Date(t.created_at);
            const end = new Date(t.completed_at);
            return sum + (end - start) / (1000 * 60);
          }
          return sum;
        }, 0);
        avgTimeMinutes = Math.round(totalMinutes / weekCompleted.length);
      }
      
      const avgTimeDisplay = avgTimeMinutes > 0 
        ? (avgTimeMinutes >= 60 ? `${Math.floor(avgTimeMinutes/60)}h ${avgTimeMinutes%60}m` : `${avgTimeMinutes}m`)
        : '--';
      
      document.getElementById('dest-today-count').textContent = todayTasks.length;
      document.getElementById('dest-week-completed').textContent = weekCompleted.length;
      document.getElementById('dest-avg-time').textContent = avgTimeDisplay;
      document.getElementById('dest-inprogress-count').textContent = inProgress;
    }

    function updateDestinationBadge() {
      const badge = document.getElementById('destination-count');
      const activeCount = destinationTasks.filter(t => t.status !== 'completed' && t.status !== 'cancelled').length;
      if (activeCount > 0) {
        badge.textContent = activeCount > 9 ? '9+' : activeCount;
        badge.style.display = 'inline';
      } else {
        badge.style.display = 'none';
      }
    }

    function filterDestinationTasks(filter) {
      currentDestFilter = filter;
      document.querySelectorAll('.dest-filter-tab').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.filter === filter);
      });
      renderDestinationTasks();
    }

    function filterDestTypeQuick(type) {
      currentDestTypeFilter = type;
      document.querySelectorAll('.dest-type-filter').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.type === type);
      });
      renderDestinationTasks();
    }

    function sortDestinationTasks(sortBy) {
      currentDestSort = sortBy;
      renderDestinationTasks();
    }

    function getFilteredDestTasks() {
      const today = new Date();
      const todayStr = today.toDateString();
      const tomorrow = new Date(today.getTime() + 24 * 60 * 60 * 1000);
      
      let tasks = [];
      
      if (currentDestFilter === 'all') {
        tasks = [...destinationTasks];
      } else if (currentDestFilter === 'today') {
        tasks = destinationTasks.filter(t => {
          const taskDate = t.estimated_pickup_time ? new Date(t.estimated_pickup_time).toDateString() : null;
          return taskDate === todayStr;
        });
      } else if (currentDestFilter === 'upcoming') {
        tasks = destinationTasks.filter(t => {
          if (!t.estimated_pickup_time) return true;
          const taskDate = new Date(t.estimated_pickup_time);
          return taskDate >= tomorrow;
        });
      } else if (currentDestFilter === 'completed') {
        tasks = [...completedDestTasks];
      }
      
      if (currentDestTypeFilter !== 'all') {
        tasks = tasks.filter(task => {
          const serviceType = task.service_type || '';
          if (currentDestTypeFilter === 'airport') {
            return serviceType.includes('airport') || serviceType === 'parking';
          }
          if (currentDestTypeFilter === 'dealership') {
            return serviceType.includes('dealership');
          }
          if (currentDestTypeFilter === 'detail') {
            return serviceType.includes('detail') || serviceType === 'detailing';
          }
          if (currentDestTypeFilter === 'valet') {
            return serviceType.includes('valet');
          }
          return true;
        });
      }
      
      tasks.sort((a, b) => {
        switch(currentDestSort) {
          case 'time':
            const timeA = a.estimated_pickup_time ? new Date(a.estimated_pickup_time) : new Date(0);
            const timeB = b.estimated_pickup_time ? new Date(b.estimated_pickup_time) : new Date(0);
            return timeA - timeB;
          case 'type':
            return (a.service_type || '').localeCompare(b.service_type || '');
          case 'status':
            const statusOrder = { pending: 1, assigned: 2, en_route: 3, picked_up: 4, in_progress: 5, at_destination: 6, returning: 7, completed: 8 };
            return (statusOrder[a.status] || 99) - (statusOrder[b.status] || 99);
          case 'priority':
            return getTaskPriority(b) - getTaskPriority(a);
          default:
            return 0;
        }
      });
      
      return tasks;
    }

    function getTaskPriority(task) {
      if (!task.estimated_pickup_time) return 0;
      const now = new Date();
      const pickupTime = new Date(task.estimated_pickup_time);
      const hoursUntil = (pickupTime - now) / (1000 * 60 * 60);
      
      if (hoursUntil < 0) return 3;
      if (hoursUntil < 2) return 2;
      if (hoursUntil < 24) return 1;
      return 0;
    }

    function getTaskPriorityBadge(task) {
      const priority = getTaskPriority(task);
      if (priority === 3) return '<span class="dest-task-priority high">‚ö†Ô∏è OVERDUE</span>';
      if (priority === 2) return '<span class="dest-task-priority high">‚ö° URGENT</span>';
      if (priority === 1) return '<span class="dest-task-priority normal">üìÖ TODAY</span>';
      return '';
    }

    function renderDestinationTasks() {
      const container = document.getElementById('destination-task-list');
      const tasks = getFilteredDestTasks();
      
      if (!tasks.length) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üöó</div>
            <p>${currentDestFilter === 'all' ? 'No destination tasks yet. Tasks will appear here when members request transport services.' : 'No ' + currentDestFilter + ' tasks found.'}</p>
          </div>
        `;
        return;
      }
      
      container.innerHTML = tasks.map(task => renderDestTaskCard(task)).join('');
    }

    function renderDestTaskCard(task) {
      const pkg = task.maintenance_packages || {};
      const vehicle = pkg.vehicles || {};
      const vehicleName = vehicle.year ? `${vehicle.year} ${vehicle.make} ${vehicle.model}` : 'Vehicle';
      
      const member = pkg.profiles || task.member || {};
      const memberName = member.full_name || member.name || 'Member';
      
      const typeInfo = destServiceTypeLabels[task.service_type] || { icon: 'üöó', label: task.service_type, class: '' };
      const statusLabel = destStatusLabels[task.status] || task.status;
      
      const pickupLocation = task.pickup_location || 'TBD';
      const dropoffLocation = task.dropoff_location || task.parking_location || 'TBD';
      
      const scheduledTime = task.estimated_pickup_time 
        ? new Date(task.estimated_pickup_time).toLocaleString('en-US', { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' })
        : 'Not scheduled';
      
      const priorityBadge = getTaskPriorityBadge(task);
      
      return `
        <div class="dest-task-card" onclick="openDestTaskDetail('${task.id}')">
          <div class="dest-task-header">
            <div>
              <span class="dest-task-type ${typeInfo.class}">${typeInfo.icon} ${typeInfo.label}</span>
              ${priorityBadge}
            </div>
            <span class="dest-task-status ${task.status}">${statusLabel}</span>
          </div>
          
          <div style="margin-bottom:12px;">
            <div style="font-weight:600;font-size:1rem;">${vehicleName}</div>
            <div style="font-size:0.88rem;color:var(--text-secondary);">üë§ ${memberName}</div>
          </div>
          
          <div style="font-size:0.85rem;color:var(--accent-gold);margin-bottom:12px;">
            üïê ${scheduledTime}
          </div>
          
          <div class="dest-task-route">
            <div style="flex:1;">
              <div style="font-size:0.75rem;color:var(--text-muted);margin-bottom:2px;">üìç From</div>
              <div>${pickupLocation.substring(0, 40)}${pickupLocation.length > 40 ? '...' : ''}</div>
            </div>
            <span class="dest-task-route-arrow">‚Üí</span>
            <div style="flex:1;">
              <div style="font-size:0.75rem;color:var(--text-muted);margin-bottom:2px;">üèÅ To</div>
              <div>${dropoffLocation.substring(0, 40)}${dropoffLocation.length > 40 ? '...' : ''}</div>
            </div>
          </div>
          
          <div class="dest-task-meta">
            ${task.flight_number ? `<span>‚úàÔ∏è ${task.flight_number}</span>` : ''}
            ${task.dealership_name ? `<span>üè¢ ${task.dealership_name}</span>` : ''}
            ${pkg.title ? `<span>üì¶ ${pkg.title}</span>` : ''}
          </div>
          
          <div class="dest-task-actions" onclick="event.stopPropagation();">
            ${getDestTaskActionButtons(task)}
          </div>
        </div>
      `;
    }

    function getDestTaskActionButtons(task) {
      const buttons = [];
      
      switch(task.status) {
        case 'pending':
          buttons.push(`<button class="btn btn-primary btn-sm" onclick="updateDestTaskStatus('${task.id}', 'assigned')">‚úì Accept Task</button>`);
          buttons.push(`<button class="btn btn-secondary btn-sm" onclick="openDriverAssignment('${task.id}')">üë§ Assign Driver</button>`);
          break;
        case 'assigned':
        case 'accepted':
          buttons.push(`<button class="btn btn-primary btn-sm" onclick="openDestStatusUpdate('${task.id}', 'en_route')">üöó Start Pickup</button>`);
          break;
        case 'en_route':
          buttons.push(`<button class="btn btn-primary btn-sm" onclick="openDestStatusUpdate('${task.id}', 'picked_up')">üì∏ Mark Picked Up</button>`);
          break;
        case 'picked_up':
        case 'in_transit':
          buttons.push(`<button class="btn btn-primary btn-sm" onclick="openDestStatusUpdate('${task.id}', 'at_destination')">üèÅ At Destination</button>`);
          break;
        case 'in_progress':
          buttons.push(`<button class="btn btn-primary btn-sm" onclick="openDestStatusUpdate('${task.id}', 'at_destination')">üèÅ At Destination</button>`);
          break;
        case 'at_destination':
          if (task.service_type?.includes('airport') || task.service_type === 'parking') {
            buttons.push(`<button class="btn btn-secondary btn-sm" onclick="openDestStatusUpdate('${task.id}', 'returning')">üöó Start Return</button>`);
          }
          buttons.push(`<button class="btn btn-primary btn-sm" onclick="openDestStatusUpdate('${task.id}', 'completed')">‚úÖ Complete</button>`);
          break;
        case 'returning':
          buttons.push(`<button class="btn btn-primary btn-sm" onclick="openDestStatusUpdate('${task.id}', 'completed')">‚úÖ Complete</button>`);
          break;
      }
      
      buttons.push(`<button class="btn btn-ghost btn-sm" onclick="openDestTaskDetail('${task.id}')">View Details</button>`);
      
      return buttons.join('');
    }

    async function openDestTaskDetail(serviceId) {
      openModal('destination-task-modal');
      
      const task = destinationTasks.find(t => t.id === serviceId) || completedDestTasks.find(t => t.id === serviceId);
      if (!task) {
        document.getElementById('dest-task-modal-body').innerHTML = '<div class="empty-state"><p>Task not found</p></div>';
        return;
      }
      
      currentDestTask = task;
      const pkg = task.maintenance_packages || {};
      const vehicle = pkg.vehicles || {};
      const vehicleName = vehicle.year ? `${vehicle.year} ${vehicle.make} ${vehicle.model}` : 'Vehicle';
      const typeInfo = destServiceTypeLabels[task.service_type] || { icon: 'üöó', label: task.service_type, class: '' };
      
      const member = pkg.profiles || task.member || {};
      const memberName = member.full_name || member.name || 'Member';
      const memberPhone = member.phone || member.phone_number || '';
      const memberEmail = member.email || '';
      
      const pickupAddr = task.pickup_location || '';
      const dropoffAddr = task.dropoff_location || task.parking_location || '';
      const mapsPickupUrl = pickupAddr ? `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(pickupAddr)}` : '';
      const mapsDropoffUrl = dropoffAddr ? `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(dropoffAddr)}` : '';
      
      document.getElementById('dest-task-modal-title').textContent = `${typeInfo.icon} ${typeInfo.label}`;
      
      let detailsHtml = `
        <div style="display:flex;gap:16px;align-items:flex-start;margin-bottom:20px;flex-wrap:wrap;">
          <div style="flex:1;min-width:200px;">
            <div style="font-size:1.2rem;font-weight:600;margin-bottom:4px;">${vehicleName}</div>
            <div style="font-size:0.9rem;color:var(--text-secondary);margin-bottom:8px;">${pkg.title || 'Transport Service'}</div>
            <span class="dest-task-status ${task.status}">${destStatusLabels[task.status] || task.status}</span>
          </div>
          ${vehicle.color || vehicle.license_plate ? `
            <div style="padding:12px 16px;background:var(--bg-input);border-radius:var(--radius-md);">
              ${vehicle.color ? `<div style="font-size:0.85rem;"><span style="color:var(--text-muted);">Color:</span> ${vehicle.color}</div>` : ''}
              ${vehicle.license_plate ? `<div style="font-size:0.85rem;"><span style="color:var(--text-muted);">Plate:</span> ${vehicle.license_plate}</div>` : ''}
            </div>
          ` : ''}
        </div>
        
        <!-- Member Contact Info -->
        <div style="background:var(--bg-elevated);border:1px solid var(--border-subtle);border-radius:var(--radius-md);padding:16px;margin-bottom:20px;">
          <div style="font-weight:600;margin-bottom:12px;">üë§ Member Contact</div>
          <div style="display:flex;flex-wrap:wrap;gap:16px;align-items:center;">
            <div style="font-size:1rem;font-weight:500;">${memberName}</div>
            ${memberPhone ? `<a href="tel:${memberPhone}" class="btn btn-sm btn-secondary" style="text-decoration:none;">üìû ${memberPhone}</a>` : ''}
            ${memberEmail ? `<a href="mailto:${memberEmail}" class="btn btn-sm btn-secondary" style="text-decoration:none;">‚úâÔ∏è Email</a>` : ''}
          </div>
        </div>
        
        <!-- Route Info with Maps Links -->
        <div style="background:var(--bg-elevated);border:1px solid var(--border-subtle);border-radius:var(--radius-md);padding:16px;margin-bottom:20px;">
          <div style="font-weight:600;margin-bottom:12px;">üìç Route Information</div>
          <div class="dest-task-route" style="margin:0;">
            <div style="flex:1;">
              <div style="font-size:0.75rem;color:var(--text-muted);margin-bottom:2px;">Pickup</div>
              <div>${pickupAddr || 'Not specified'}</div>
              ${mapsPickupUrl ? `<a href="${mapsPickupUrl}" target="_blank" style="color:var(--accent-gold);font-size:0.85rem;text-decoration:none;">üó∫Ô∏è Open in Maps</a>` : ''}
            </div>
            <span class="dest-task-route-arrow">‚Üí</span>
            <div style="flex:1;">
              <div style="font-size:0.75rem;color:var(--text-muted);margin-bottom:2px;">Destination</div>
              <div>${dropoffAddr || 'Not specified'}</div>
              ${mapsDropoffUrl ? `<a href="${mapsDropoffUrl}" target="_blank" style="color:var(--accent-gold);font-size:0.85rem;text-decoration:none;">üó∫Ô∏è Open in Maps</a>` : ''}
            </div>
          </div>
          ${task.estimated_pickup_time ? `
            <div style="margin-top:12px;padding-top:12px;border-top:1px solid var(--border-subtle);">
              <span style="color:var(--text-muted);">Scheduled:</span> 
              <span style="color:var(--accent-gold);font-weight:500;">${new Date(task.estimated_pickup_time).toLocaleString()}</span>
            </div>
          ` : ''}
        </div>
      `;
      
      // Service-specific details
      if (task.service_type?.includes('airport') || task.service_type === 'parking') {
        detailsHtml += `
          <div style="background:var(--accent-blue-soft);border:1px solid rgba(74,124,255,0.3);border-radius:var(--radius-md);padding:16px;margin-bottom:20px;">
            <div style="font-weight:600;margin-bottom:12px;">‚úàÔ∏è Flight Information</div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
              ${task.flight_number ? `<div><span style="color:var(--text-muted);">Flight:</span> ${task.flight_number}</div>` : ''}
              ${task.airline ? `<div><span style="color:var(--text-muted);">Airline:</span> ${task.airline}</div>` : ''}
              ${task.flight_datetime ? `<div><span style="color:var(--text-muted);">Flight Time:</span> ${new Date(task.flight_datetime).toLocaleString()}</div>` : ''}
              ${task.trip_type ? `<div><span style="color:var(--text-muted);">Trip Type:</span> ${task.trip_type}</div>` : ''}
            </div>
            ${task.parking_spot ? `<div style="margin-top:12px;padding:12px;background:var(--bg-input);border-radius:var(--radius-sm);"><strong>üÖøÔ∏è Parking Spot:</strong> ${task.parking_spot}</div>` : ''}
          </div>
        `;
      }
      
      if (task.service_type?.includes('dealership')) {
        detailsHtml += `
          <div style="background:rgba(249,115,22,0.1);border:1px solid rgba(249,115,22,0.3);border-radius:var(--radius-md);padding:16px;margin-bottom:20px;">
            <div style="font-weight:600;margin-bottom:12px;">üîß Dealership Information</div>
            ${task.dealership_name ? `<div style="margin-bottom:8px;"><span style="color:var(--text-muted);">Dealership:</span> ${task.dealership_name}</div>` : ''}
            ${task.dealership_service_type ? `<div><span style="color:var(--text-muted);">Service Type:</span> ${task.dealership_service_type}</div>` : ''}
          </div>
        `;
      }
      
      if (task.service_type?.includes('detail') || task.service_type === 'detailing') {
        detailsHtml += `
          <div style="background:rgba(168,85,247,0.1);border:1px solid rgba(168,85,247,0.3);border-radius:var(--radius-md);padding:16px;margin-bottom:20px;">
            <div style="font-weight:600;margin-bottom:12px;">‚ú® Detail Service</div>
            ${task.detail_service_level ? `<div><span style="color:var(--text-muted);">Service Level:</span> ${task.detail_service_level}</div>` : ''}
          </div>
        `;
      }
      
      if (task.service_type?.includes('valet')) {
        detailsHtml += `
          <div style="background:rgba(236,72,153,0.1);border:1px solid rgba(236,72,153,0.3);border-radius:var(--radius-md);padding:16px;margin-bottom:20px;">
            <div style="font-weight:600;margin-bottom:12px;">üîë Valet Event</div>
            ${task.valet_event_name ? `<div style="margin-bottom:8px;"><span style="color:var(--text-muted);">Event:</span> ${task.valet_event_name}</div>` : ''}
            ${task.valet_venue ? `<div><span style="color:var(--text-muted);">Venue:</span> ${task.valet_venue}</div>` : ''}
          </div>
        `;
      }
      
      // Special instructions
      if (task.special_instructions) {
        detailsHtml += `
          <div style="background:var(--accent-gold-soft);border:1px solid rgba(212,168,85,0.3);border-radius:var(--radius-md);padding:16px;margin-bottom:20px;">
            <div style="font-weight:600;margin-bottom:8px;">üìù Special Instructions</div>
            <div style="color:var(--text-secondary);">${task.special_instructions}</div>
          </div>
        `;
      }
      
      // Status Timeline
      detailsHtml += `
        <div style="background:var(--bg-elevated);border:1px solid var(--border-subtle);border-radius:var(--radius-md);padding:16px;margin-bottom:20px;">
          <div style="font-weight:600;margin-bottom:16px;">üìä Status Timeline</div>
          ${renderDestStatusTimeline(task)}
        </div>
      `;
      
      document.getElementById('dest-task-modal-body').innerHTML = detailsHtml;
      
      // Footer actions
      const footerHtml = `
        <button class="btn btn-secondary" onclick="closeModal('destination-task-modal')">Close</button>
        ${getDestTaskActionButtons(task)}
      `;
      document.getElementById('dest-task-modal-footer').innerHTML = footerHtml;
    }

    function renderDestStatusTimeline(task) {
      const currentStatusIndex = destStatusWorkflow.indexOf(task.status);
      
      return destStatusWorkflow.map((status, index) => {
        let stepClass = '';
        if (index < currentStatusIndex || task.status === 'completed') {
          stepClass = 'completed';
        } else if (index === currentStatusIndex) {
          stepClass = 'current';
        } else {
          stepClass = 'pending';
        }
        
        const icon = stepClass === 'completed' ? '‚úì' : (stepClass === 'current' ? '‚óè' : '‚óã');
        const label = destStatusLabels[status] || status;
        
        return `
          <div class="dest-timeline-item ${stepClass}">
            <div class="dest-timeline-dot">${icon}</div>
            <div style="flex:1;padding-top:4px;">
              <div style="font-weight:500;font-size:0.9rem;">${label}</div>
              ${stepClass === 'completed' || stepClass === 'current' ? '<div style="font-size:0.78rem;color:var(--text-muted);">Updated</div>' : ''}
            </div>
          </div>
        `;
      }).join('');
    }

    function openDestStatusUpdate(serviceId, newStatus) {
      const task = destinationTasks.find(t => t.id === serviceId);
      if (!task) return;
      
      document.getElementById('dest-status-service-id').value = serviceId;
      document.getElementById('dest-status-new-status').value = newStatus;
      document.getElementById('dest-status-notes').value = '';
      document.getElementById('dest-status-photo-preview').innerHTML = '';
      document.getElementById('dest-parking-spot').value = '';
      document.getElementById('dest-location-lat').value = '';
      document.getElementById('dest-location-lng').value = '';
      document.getElementById('dest-location-status').textContent = 'Click "Capture Location" to record GPS coordinates';
      
      // Reset new fields
      const odometerInput = document.getElementById('dest-odometer-reading');
      const fuelSelect = document.getElementById('dest-fuel-level');
      const finalOdometerInput = document.getElementById('dest-final-odometer');
      if (odometerInput) odometerInput.value = '';
      if (fuelSelect) fuelSelect.value = '';
      if (finalOdometerInput) finalOdometerInput.value = '';
      
      const statusInfo = {
        'assigned': '‚úì Accepting this task - you will be responsible for completing it.',
        'en_route': 'üöó Starting pickup - you are on your way to pick up the vehicle.',
        'picked_up': 'üì∏ Marking vehicle as picked up - please capture a photo, odometer reading, and fuel level.',
        'at_destination': 'üèÅ Arrived at destination - please capture a photo and record the location.',
        'returning': 'üöó Starting return trip - you are bringing the vehicle back.',
        'completed': '‚úÖ Completing delivery - please capture a return photo and final odometer reading.'
      };
      
      document.getElementById('dest-status-info').textContent = statusInfo[newStatus] || 'Updating task status...';
      document.getElementById('dest-status-modal-title').textContent = destStatusLabels[newStatus] || 'Update Status';
      
      // Show/hide parking spot field for airport services
      const isAirport = task.service_type?.includes('airport') || task.service_type === 'parking';
      document.getElementById('dest-parking-group').style.display = (isAirport && newStatus === 'at_destination') ? 'block' : 'none';
      
      // Show/hide odometer and fuel level for pickup
      const isPickup = newStatus === 'picked_up';
      document.getElementById('dest-odometer-group').style.display = isPickup ? 'block' : 'none';
      document.getElementById('dest-fuel-group').style.display = isPickup ? 'block' : 'none';
      
      // Show/hide final odometer for completion
      const isCompleted = newStatus === 'completed';
      document.getElementById('dest-final-odometer-group').style.display = isCompleted ? 'block' : 'none';
      
      // Update notes label based on status
      const notesLabel = document.getElementById('dest-notes-label');
      if (isCompleted) {
        notesLabel.textContent = 'Delivery Notes';
        document.getElementById('dest-status-notes').placeholder = 'Any notes about the delivery (condition, location, etc.)...';
      } else {
        notesLabel.textContent = 'Notes (optional)';
        document.getElementById('dest-status-notes').placeholder = 'Any notes about this status update...';
      }
      
      closeModal('destination-task-modal');
      openModal('dest-status-modal');
    }

    function previewDestStatusPhoto() {
      const input = document.getElementById('dest-status-photo');
      const preview = document.getElementById('dest-status-photo-preview');
      
      if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = (e) => {
          preview.innerHTML = `<img src="${e.target.result}" style="width:100px;height:75px;object-fit:cover;border-radius:var(--radius-sm);border:1px solid var(--border-subtle);">`;
        };
        reader.readAsDataURL(input.files[0]);
      }
    }

    function captureDestLocation() {
      const statusEl = document.getElementById('dest-location-status');
      statusEl.textContent = 'Capturing location...';
      
      if (!navigator.geolocation) {
        statusEl.textContent = '‚ùå Geolocation not supported';
        return;
      }
      
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          document.getElementById('dest-location-lat').value = pos.coords.latitude;
          document.getElementById('dest-location-lng').value = pos.coords.longitude;
          statusEl.innerHTML = `‚úÖ Location captured: <a href="https://www.google.com/maps?q=${pos.coords.latitude},${pos.coords.longitude}" target="_blank" style="color:var(--accent-gold);">View on Map</a>`;
        },
        (err) => {
          statusEl.textContent = '‚ùå Failed to get location: ' + err.message;
        },
        { enableHighAccuracy: true, timeout: 10000 }
      );
    }

    async function submitDestStatusUpdate() {
      const serviceId = document.getElementById('dest-status-service-id').value;
      const newStatus = document.getElementById('dest-status-new-status').value;
      const notes = document.getElementById('dest-status-notes').value;
      const parkingSpot = document.getElementById('dest-parking-spot').value;
      const lat = document.getElementById('dest-location-lat').value;
      const lng = document.getElementById('dest-location-lng').value;
      const odometerReading = document.getElementById('dest-odometer-reading')?.value;
      const fuelLevel = document.getElementById('dest-fuel-level')?.value;
      const finalOdometer = document.getElementById('dest-final-odometer')?.value;
      
      const btn = document.getElementById('dest-status-submit-btn');
      btn.disabled = true;
      btn.textContent = 'Updating...';
      
      try {
        const extraData = {};
        if (notes) extraData.notes = notes;
        if (parkingSpot) extraData.parking_spot = parkingSpot;
        if (lat && lng) {
          extraData.last_location_lat = parseFloat(lat);
          extraData.last_location_lng = parseFloat(lng);
        }
        
        // Capture odometer and fuel level for pickup
        if (newStatus === 'picked_up') {
          if (odometerReading) extraData.pickup_odometer = parseInt(odometerReading);
          if (fuelLevel) extraData.pickup_fuel_level = fuelLevel;
        }
        
        // Capture final odometer for completion
        if (newStatus === 'completed') {
          if (finalOdometer) extraData.dropoff_odometer = parseInt(finalOdometer);
          if (notes) extraData.delivery_notes = notes;
        }
        
        // Handle photo upload if present
        const photoInput = document.getElementById('dest-status-photo');
        if (photoInput.files && photoInput.files[0]) {
          const file = photoInput.files[0];
          const resized = await resizeImage(file, 1280, 0.8);
          const filename = `${serviceId}/${newStatus}_${Date.now()}.jpg`;
          const { error: uploadErr } = await supabaseClient.storage
            .from('package-photos')
            .upload(filename, resized, { contentType: 'image/jpeg' });
          
          if (!uploadErr) {
            const { data: urlData } = supabaseClient.storage.from('package-photos').getPublicUrl(filename);
            if (newStatus === 'picked_up') {
              extraData.pickup_photo_url = urlData.publicUrl;
            } else if (newStatus === 'at_destination' || newStatus === 'completed') {
              extraData.dropoff_photo_url = urlData.publicUrl;
            }
          }
        }
        
        const { error } = await updateDestinationServiceStatus(serviceId, newStatus, extraData);
        if (error) throw new Error(error);
        
        closeModal('dest-status-modal');
        showToast(`Status updated to ${destStatusLabels[newStatus]}!`, 'success');
        await loadDestinationTasks();
      } catch (err) {
        console.error('Error updating status:', err);
        showToast('Failed to update status: ' + err.message, 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Update Status';
      }
    }

    async function updateDestTaskStatus(serviceId, newStatus) {
      try {
        const { error } = await updateDestinationServiceStatus(serviceId, newStatus);
        if (error) throw new Error(error);
        
        showToast(`Status updated to ${destStatusLabels[newStatus]}!`, 'success');
        await loadDestinationTasks();
      } catch (err) {
        console.error('Error updating status:', err);
        showToast('Failed to update status: ' + err.message, 'error');
      }
    }

    async function openDriverAssignment(serviceId) {
      document.getElementById('dest-driver-service-id').value = serviceId;
      
      // Load team members
      try {
        const { data: teamMembers } = await supabaseClient
          .from('team_members')
          .select('*')
          .eq('provider_id', currentUser.id)
          .eq('is_active', true)
          .in('role', ['driver', 'mechanic', 'technician']);
        
        const select = document.getElementById('dest-driver-select');
        select.innerHTML = '<option value="">Select a team member...</option>';
        
        if (teamMembers && teamMembers.length > 0) {
          teamMembers.forEach(member => {
            select.innerHTML += `<option value="${member.id}">${member.name} (${member.role})</option>`;
          });
        } else {
          select.innerHTML += '<option value="" disabled>No drivers found. Add team members first.</option>';
        }
        
        openModal('dest-driver-modal');
      } catch (err) {
        console.error('Error loading team members:', err);
        showToast('Failed to load team members', 'error');
      }
    }

    async function assignDestDriver() {
      const serviceId = document.getElementById('dest-driver-service-id').value;
      const driverId = document.getElementById('dest-driver-select').value;
      
      if (!driverId) {
        showToast('Please select a driver', 'error');
        return;
      }
      
      try {
        // Create transport task with driver assigned
        const { error } = await createTransportTask({
          destination_service_id: serviceId,
          driver_id: driverId,
          task_type: 'pickup',
          scheduled_time: new Date().toISOString()
        });
        
        if (error) throw new Error(error);
        
        // Update service status to assigned
        await updateDestinationServiceStatus(serviceId, 'assigned');
        
        closeModal('dest-driver-modal');
        showToast('Driver assigned successfully!', 'success');
        await loadDestinationTasks();
      } catch (err) {
        console.error('Error assigning driver:', err);
        showToast('Failed to assign driver: ' + err.message, 'error');
      }
    }

    function renderCompletedTasksStats() {
      const total = completedDestTasks.length;
      document.getElementById('dest-total-completed').textContent = total;
      
      // Calculate on-time rate (placeholder - would need actual timing data)
      const onTimeRate = total > 0 ? '95%' : '--%';
      document.getElementById('dest-ontime-rate').textContent = onTimeRate;
      
      // Average rating (placeholder)
      document.getElementById('dest-avg-rating').textContent = total > 0 ? '4.8' : '--';
    }

    function toggleCompletedTasksHistory() {
      const container = document.getElementById('completed-tasks-list');
      const isHidden = container.style.display === 'none';
      container.style.display = isHidden ? 'block' : 'none';
      
      if (isHidden && completedDestTasks.length > 0) {
        container.innerHTML = completedDestTasks.slice(0, 10).map(task => {
          const pkg = task.maintenance_packages || {};
          const vehicle = pkg.vehicles || {};
          const vehicleName = vehicle.year ? `${vehicle.year} ${vehicle.make} ${vehicle.model}` : 'Vehicle';
          const typeInfo = destServiceTypeLabels[task.service_type] || { icon: 'üöó', label: task.service_type };
          const completedDate = task.completed_at ? new Date(task.completed_at).toLocaleDateString() : 'Unknown';
          
          return `
            <div style="padding:12px 0;border-bottom:1px solid var(--border-subtle);display:flex;justify-content:space-between;align-items:center;">
              <div>
                <div style="font-weight:500;">${typeInfo.icon} ${vehicleName}</div>
                <div style="font-size:0.85rem;color:var(--text-muted);">${typeInfo.label} ‚Ä¢ Completed ${completedDate}</div>
              </div>
              <span class="dest-task-status completed">Completed</span>
            </div>
          `;
        }).join('');
      } else if (isHidden && completedDestTasks.length === 0) {
        container.innerHTML = '<div class="empty-state" style="padding:24px;"><p style="color:var(--text-muted);">No completed tasks yet</p></div>';
      }
    }

    // =====================================================
    // FLEET SERVICES FUNCTIONS
    // =====================================================

    let fleetJobQueue = [];
    let fleetBatches = [];
    let fleetCompletedBatches = [];
    let currentFleetBatch = null;
    let currentFleetBidBatch = null;
    let selectedBatchItems = new Set();

    function switchFleetTab(tab) {
      document.querySelectorAll('.fleet-tab').forEach(t => t.classList.remove('active'));
      document.querySelector(`[data-fleet-tab="${tab}"]`).classList.add('active');
      document.querySelectorAll('.fleet-section').forEach(s => s.classList.remove('active'));
      document.getElementById(`fleet-${tab}-section`).classList.add('active');

      if (tab === 'queue') loadFleetJobQueue();
      else if (tab === 'batches') loadFleetBatches();
      else if (tab === 'completed') loadFleetCompletedBatches();
    }

    async function loadFleetJobQueue() {
      const container = document.getElementById('fleet-job-queue');
      container.innerHTML = '<div class="empty-state"><p>Loading fleet requests...</p></div>';

      try {
        const { data, error } = await supabaseClient
          .from('bulk_service_batches')
          .select(`
            *,
            fleet:fleet_id(id, name, company_name, verified),
            items:bulk_service_items(id, vehicle_id, status)
          `)
          .eq('status', 'pending')
          .order('created_at', { ascending: false });

        if (error) throw error;
        fleetJobQueue = data || [];

        const badge = document.getElementById('fleet-queue-badge');
        const navBadge = document.getElementById('fleet-count');
        if (fleetJobQueue.length > 0) {
          badge.textContent = fleetJobQueue.length;
          badge.style.display = 'inline';
          navBadge.textContent = fleetJobQueue.length;
          navBadge.style.display = 'inline';
        } else {
          badge.style.display = 'none';
          navBadge.style.display = 'none';
        }

        renderFleetJobQueue();
      } catch (err) {
        console.error('Error loading fleet job queue:', err);
        container.innerHTML = '<div class="empty-state"><p>Failed to load fleet requests.</p></div>';
      }
    }

    function renderFleetJobQueue() {
      const container = document.getElementById('fleet-job-queue');
      
      if (!fleetJobQueue.length) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üè¢</div>
            <p>No fleet job requests at the moment. Fleet requests from verified business accounts will appear here.</p>
          </div>
        `;
        return;
      }

      container.innerHTML = fleetJobQueue.map(batch => {
        const fleet = batch.fleet || {};
        const vehicleCount = batch.items?.length || batch.vehicle_count || 0;
        const estimatedValue = batch.estimated_total_value || (vehicleCount * 75);
        const timePosted = batch.created_at ? timeAgo(new Date(batch.created_at)) : 'Recently';

        return `
          <div class="fleet-request-card" style="background:var(--bg-elevated);border:1px solid var(--border-subtle);border-radius:var(--radius-lg);padding:20px;margin-bottom:16px;">
            <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px;flex-wrap:wrap;gap:12px;">
              <div>
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;">
                  <span style="font-weight:600;font-size:1.05rem;">${fleet.company_name || fleet.name || 'Fleet Account'}</span>
                  ${fleet.verified ? '<span style="background:linear-gradient(135deg, var(--accent-gold), #c49a45);color:#0a0a0f;padding:2px 8px;border-radius:100px;font-size:0.72rem;font-weight:600;">‚úì Verified Business</span>' : ''}
                  <span class="fleet-badge" style="background:var(--accent-gold-soft);color:var(--accent-gold);padding:2px 8px;border-radius:100px;font-size:0.72rem;font-weight:500;">üè¢ Fleet</span>
                </div>
                <div style="font-size:1rem;margin-bottom:4px;">${batch.name || batch.service_type || 'Bulk Service Request'}</div>
                <div style="font-size:0.85rem;color:var(--text-muted);">Posted ${timePosted}</div>
              </div>
              <div style="text-align:right;">
                <div style="font-size:0.82rem;color:var(--text-muted);">Estimated Value</div>
                <div style="font-size:1.4rem;font-weight:600;color:var(--accent-gold);">$${estimatedValue.toLocaleString()}</div>
              </div>
            </div>
            
            <div style="display:flex;gap:16px;flex-wrap:wrap;margin-bottom:16px;font-size:0.88rem;">
              <span style="color:var(--text-secondary);">üöó <strong>${vehicleCount}</strong> vehicles</span>
              ${batch.service_type ? `<span style="color:var(--text-secondary);">üîß ${batch.service_type}</span>` : ''}
              ${batch.date_range_start && batch.date_range_end ? `<span style="color:var(--text-secondary);">üìÖ ${new Date(batch.date_range_start).toLocaleDateString()} - ${new Date(batch.date_range_end).toLocaleDateString()}</span>` : ''}
            </div>

            <div style="display:flex;gap:8px;flex-wrap:wrap;">
              <button class="btn btn-primary btn-sm" onclick="openFleetBulkBidModal('${batch.id}')">üíº Submit Bid</button>
              <button class="btn btn-secondary btn-sm" onclick="openFleetRequestDetail('${batch.id}')">View Details</button>
            </div>
          </div>
        `;
      }).join('');
    }

    async function loadFleetBatches() {
      const container = document.getElementById('fleet-batches-list');
      container.innerHTML = '<div class="empty-state"><p>Loading batches...</p></div>';

      try {
        if (!currentUser) return;
        const { data, error } = await supabaseClient
          .from('bulk_service_batches')
          .select(`
            *,
            fleet:fleet_id(id, name, company_name),
            items:bulk_service_items(id, vehicle_id, status, scheduled_date, assigned_driver_id)
          `)
          .eq('assigned_provider_id', currentUser.id)
          .in('status', ['approved', 'in_progress'])
          .order('created_at', { ascending: false });

        if (error) throw error;
        fleetBatches = data || [];
        
        document.getElementById('fleet-active-batches').textContent = fleetBatches.length;
        renderFleetBatches();
      } catch (err) {
        console.error('Error loading fleet batches:', err);
        container.innerHTML = '<div class="empty-state"><p>Failed to load batches.</p></div>';
      }
    }

    function renderFleetBatches() {
      const container = document.getElementById('fleet-batches-list');
      
      if (!fleetBatches.length) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üì¶</div>
            <p>No active bulk service batches. Accept fleet jobs to see batches here.</p>
          </div>
        `;
        return;
      }

      container.innerHTML = fleetBatches.map(batch => {
        const fleet = batch.fleet || {};
        const items = batch.items || [];
        const completedCount = items.filter(i => i.status === 'completed').length;
        const totalCount = items.length;
        const progress = totalCount > 0 ? Math.round((completedCount / totalCount) * 100) : 0;
        
        let statusBadge = '';
        let statusClass = '';
        if (completedCount === 0) {
          statusBadge = 'Not Started';
          statusClass = 'pending';
        } else if (completedCount < totalCount) {
          statusBadge = `In Progress (${completedCount}/${totalCount})`;
          statusClass = 'in_progress';
        } else {
          statusBadge = 'Completed';
          statusClass = 'completed';
        }

        return `
          <div class="fleet-batch-card" style="background:var(--bg-elevated);border:1px solid var(--border-subtle);border-radius:var(--radius-lg);padding:20px;margin-bottom:16px;">
            <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px;flex-wrap:wrap;gap:12px;">
              <div>
                <div style="font-weight:600;font-size:1.05rem;margin-bottom:4px;">${batch.name || 'Bulk Service Batch'}</div>
                <div style="font-size:0.9rem;color:var(--text-secondary);">${fleet.company_name || fleet.name || 'Fleet'}</div>
              </div>
              <span class="fleet-item-status ${statusClass}">${statusBadge}</span>
            </div>

            <div style="display:flex;gap:16px;flex-wrap:wrap;margin-bottom:16px;font-size:0.88rem;">
              <span style="color:var(--text-secondary);">üöó <strong>${totalCount}</strong> vehicles</span>
              ${batch.date_range_start && batch.date_range_end ? `<span style="color:var(--text-secondary);">üìÖ ${new Date(batch.date_range_start).toLocaleDateString()} - ${new Date(batch.date_range_end).toLocaleDateString()}</span>` : ''}
            </div>

            <div style="margin-bottom:16px;">
              <div style="display:flex;justify-content:space-between;margin-bottom:6px;font-size:0.85rem;">
                <span>Progress</span>
                <span style="color:var(--accent-gold);font-weight:500;">${progress}%</span>
              </div>
              <div style="height:8px;background:var(--bg-input);border-radius:4px;overflow:hidden;">
                <div style="height:100%;width:${progress}%;background:linear-gradient(90deg,var(--accent-gold),#c49a45);transition:width 0.3s;"></div>
              </div>
            </div>

            <div style="display:flex;gap:8px;flex-wrap:wrap;">
              <button class="btn btn-primary btn-sm" onclick="openFleetBatchDetail('${batch.id}')">üìã View Vehicles</button>
            </div>
          </div>
        `;
      }).join('');
    }

    async function loadFleetCompletedBatches() {
      const container = document.getElementById('fleet-completed-list');
      container.innerHTML = '<div class="empty-state"><p>Loading completed jobs...</p></div>';

      try {
        if (!currentUser) return;
        const { data, error } = await supabaseClient
          .from('bulk_service_batches')
          .select(`
            *,
            fleet:fleet_id(id, name, company_name),
            items:bulk_service_items(id, vehicle_id, status)
          `)
          .eq('assigned_provider_id', currentUser.id)
          .eq('status', 'completed')
          .order('completed_at', { ascending: false })
          .limit(20);

        if (error) throw error;
        fleetCompletedBatches = data || [];

        document.getElementById('fleet-jobs-completed').textContent = fleetCompletedBatches.length;
        
        if (fleetCompletedBatches.length > 0) {
          const totalVehicles = fleetCompletedBatches.reduce((sum, b) => sum + (b.items?.length || 0), 0);
          const avgVehicles = Math.round(totalVehicles / fleetCompletedBatches.length);
          document.getElementById('fleet-avg-vehicles').textContent = avgVehicles;
        }

        renderFleetCompletedBatches();
      } catch (err) {
        console.error('Error loading completed fleet batches:', err);
        container.innerHTML = '<div class="empty-state"><p>Failed to load completed jobs.</p></div>';
      }
    }

    function renderFleetCompletedBatches() {
      const container = document.getElementById('fleet-completed-list');
      
      if (!fleetCompletedBatches.length) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">‚úÖ</div>
            <p>No completed fleet jobs yet.</p>
          </div>
        `;
        return;
      }

      container.innerHTML = fleetCompletedBatches.map(batch => {
        const fleet = batch.fleet || {};
        const completedDate = batch.completed_at ? new Date(batch.completed_at).toLocaleDateString() : 'Unknown';
        const vehicleCount = batch.items?.length || 0;

        return `
          <div style="padding:16px 0;border-bottom:1px solid var(--border-subtle);display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px;">
            <div>
              <div style="font-weight:500;">${batch.name || 'Bulk Service'}</div>
              <div style="font-size:0.85rem;color:var(--text-muted);">${fleet.company_name || fleet.name || 'Fleet'} ‚Ä¢ ${vehicleCount} vehicles ‚Ä¢ Completed ${completedDate}</div>
            </div>
            <span class="fleet-item-status completed">‚úÖ Completed</span>
          </div>
        `;
      }).join('');
    }

    async function openFleetBatchDetail(batchId) {
      openModal('fleet-batch-modal');
      document.getElementById('fleet-batch-modal-body').innerHTML = '<div class="empty-state"><p>Loading batch details...</p></div>';

      try {
        const { data, error } = await getBulkBatchDetails(batchId);
        if (error) throw new Error(error);

        currentFleetBatch = data;
        selectedBatchItems.clear();
        renderFleetBatchDetail();
      } catch (err) {
        console.error('Error loading batch details:', err);
        document.getElementById('fleet-batch-modal-body').innerHTML = '<div class="empty-state"><p>Failed to load batch details.</p></div>';
      }
    }

    function renderFleetBatchDetail() {
      if (!currentFleetBatch) return;

      const batch = currentFleetBatch;
      const items = batch.items || [];
      const fleet = batch.fleet || {};
      const completedCount = items.filter(i => i.status === 'completed').length;
      const progress = items.length > 0 ? Math.round((completedCount / items.length) * 100) : 0;

      document.getElementById('fleet-batch-modal-title').textContent = `üì¶ ${batch.name || 'Batch Details'}`;

      let html = `
        <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:20px;flex-wrap:wrap;gap:12px;">
          <div>
            <div style="font-size:0.9rem;color:var(--text-secondary);">${fleet.company_name || fleet.name || 'Fleet'}</div>
            <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap;">
              <span style="font-size:0.88rem;color:var(--text-secondary);">üöó ${items.length} vehicles</span>
              ${batch.date_range_start ? `<span style="font-size:0.88rem;color:var(--text-secondary);">üìÖ ${new Date(batch.date_range_start).toLocaleDateString()} - ${new Date(batch.date_range_end || batch.date_range_start).toLocaleDateString()}</span>` : ''}
            </div>
          </div>
          <div style="text-align:right;">
            <div style="font-size:0.82rem;color:var(--text-muted);">Progress</div>
            <div style="font-size:1.2rem;font-weight:600;color:var(--accent-gold);">${progress}%</div>
          </div>
        </div>

        <div style="margin-bottom:20px;">
          <div style="height:8px;background:var(--bg-input);border-radius:4px;overflow:hidden;">
            <div style="height:100%;width:${progress}%;background:linear-gradient(90deg,var(--accent-gold),#c49a45);transition:width 0.3s;"></div>
          </div>
        </div>

        <div class="fleet-bulk-actions">
          <button class="btn btn-secondary btn-sm" onclick="selectAllBatchItems()">‚òëÔ∏è Select All</button>
          <button class="btn btn-primary btn-sm" onclick="markSelectedComplete()" ${selectedBatchItems.size === 0 ? 'disabled' : ''}>‚úÖ Mark Selected Complete</button>
        </div>

        <div style="max-height:400px;overflow-y:auto;">
      `;

      items.forEach((item, index) => {
        const vehicle = item.vehicle || {};
        const vehicleName = vehicle.year ? `${vehicle.year} ${vehicle.make} ${vehicle.model}` : `Vehicle ${index + 1}`;
        const scheduledDate = item.scheduled_date ? new Date(item.scheduled_date).toLocaleDateString() : 'Not scheduled';
        const statusLabels = {
          pending: 'Pending',
          scheduled: 'Scheduled',
          in_progress: 'In Progress',
          completed: 'Completed',
          skipped: 'Skipped'
        };

        html += `
          <div class="fleet-vehicle-item" style="display:flex;align-items:center;gap:12px;padding:16px;background:var(--bg-input);border:1px solid var(--border-subtle);border-radius:var(--radius-md);margin-bottom:8px;">
            <input type="checkbox" style="width:20px;height:20px;cursor:pointer;" 
              ${selectedBatchItems.has(item.id) ? 'checked' : ''} 
              ${item.status === 'completed' || item.status === 'skipped' ? 'disabled' : ''}
              onchange="toggleBatchItem('${item.id}')">
            
            <div style="flex:1;min-width:150px;">
              <div style="font-weight:500;">${vehicleName}</div>
              ${item.assigned_driver ? `<div style="font-size:0.82rem;color:var(--text-muted);">üë§ ${item.assigned_driver.full_name || 'Driver'}</div>` : ''}
            </div>

            <div style="font-size:0.85rem;color:var(--text-secondary);">üìÖ ${scheduledDate}</div>

            <span class="fleet-item-status ${item.status}">${statusLabels[item.status] || item.status}</span>

            <div class="fleet-item-actions">
              ${item.status === 'pending' || item.status === 'scheduled' ? `
                <button class="btn btn-primary btn-sm" onclick="updateFleetItemStatus('${item.id}', 'in_progress')">‚ñ∂Ô∏è Start</button>
              ` : ''}
              ${item.status === 'in_progress' ? `
                <button class="btn btn-primary btn-sm" onclick="updateFleetItemStatus('${item.id}', 'completed')">‚úÖ Complete</button>
              ` : ''}
              ${item.status !== 'completed' && item.status !== 'skipped' ? `
                <button class="btn btn-ghost btn-sm" onclick="updateFleetItemStatus('${item.id}', 'skipped')">‚è≠Ô∏è Skip</button>
              ` : ''}
            </div>
          </div>
        `;
      });

      html += '</div>';
      document.getElementById('fleet-batch-modal-body').innerHTML = html;
    }

    function toggleBatchItem(itemId) {
      if (selectedBatchItems.has(itemId)) {
        selectedBatchItems.delete(itemId);
      } else {
        selectedBatchItems.add(itemId);
      }
      renderFleetBatchDetail();
    }

    function selectAllBatchItems() {
      if (!currentFleetBatch) return;
      const items = currentFleetBatch.items || [];
      items.forEach(item => {
        if (item.status !== 'completed' && item.status !== 'skipped') {
          selectedBatchItems.add(item.id);
        }
      });
      renderFleetBatchDetail();
    }

    async function markSelectedComplete() {
      if (selectedBatchItems.size === 0) return;

      try {
        for (const itemId of selectedBatchItems) {
          await updateBulkItemStatus(itemId, 'completed');
        }
        
        selectedBatchItems.clear();
        showToast(`Marked ${selectedBatchItems.size || 'items'} as complete!`, 'success');
        
        if (currentFleetBatch) {
          await openFleetBatchDetail(currentFleetBatch.id);
        }
        await loadFleetBatches();
      } catch (err) {
        console.error('Error marking items complete:', err);
        showToast('Failed to update items', 'error');
      }
    }

    async function updateFleetItemStatus(itemId, status) {
      try {
        const { error } = await updateBulkItemStatus(itemId, status);
        if (error) throw new Error(error);

        showToast(`Status updated to ${status}!`, 'success');
        
        if (currentFleetBatch) {
          await openFleetBatchDetail(currentFleetBatch.id);
        }
        await loadFleetBatches();
      } catch (err) {
        console.error('Error updating item status:', err);
        showToast('Failed to update status', 'error');
      }
    }

    function openFleetBulkBidModal(batchId) {
      const batch = fleetJobQueue.find(b => b.id === batchId);
      if (!batch) return;

      currentFleetBidBatch = batch;
      document.getElementById('fleet-bid-batch-id').value = batchId;
      
      const vehicleCount = batch.items?.length || batch.vehicle_count || 0;
      document.getElementById('fleet-bid-vehicle-count').textContent = vehicleCount;
      document.getElementById('fleet-bid-batch-summary').textContent = 
        `${batch.name || 'Bulk Service'} - ${vehicleCount} vehicles`;

      document.getElementById('fleet-bid-price').value = '';
      document.getElementById('fleet-bid-duration').value = '';
      document.getElementById('fleet-bid-notes').value = '';
      
      const today = new Date();
      document.getElementById('fleet-bid-start-date').value = today.toISOString().split('T')[0];
      today.setDate(today.getDate() + 7);
      document.getElementById('fleet-bid-end-date').value = today.toISOString().split('T')[0];

      updateFleetBidTotal();
      openModal('fleet-bulk-bid-modal');
    }

    function updateFleetBidTotal() {
      const pricingType = document.querySelector('input[name="fleet-pricing-type"]:checked')?.value || 'per_vehicle';
      const price = parseFloat(document.getElementById('fleet-bid-price').value) || 0;
      const vehicleCount = currentFleetBidBatch?.items?.length || currentFleetBidBatch?.vehicle_count || 0;

      const label = document.getElementById('fleet-bid-price-label');
      
      if (pricingType === 'per_vehicle') {
        label.textContent = 'Price Per Vehicle ($)';
        const total = price * vehicleCount;
        document.getElementById('fleet-bid-per-vehicle').textContent = `$${price.toFixed(2)}`;
        document.getElementById('fleet-bid-total').textContent = `$${total.toFixed(2)}`;
      } else {
        label.textContent = 'Total Flat Rate ($)';
        const perVehicle = vehicleCount > 0 ? price / vehicleCount : 0;
        document.getElementById('fleet-bid-per-vehicle').textContent = `$${perVehicle.toFixed(2)}`;
        document.getElementById('fleet-bid-total').textContent = `$${price.toFixed(2)}`;
      }
    }

    async function submitFleetBulkBid() {
      const batchId = document.getElementById('fleet-bid-batch-id').value;
      const price = parseFloat(document.getElementById('fleet-bid-price').value);
      const pricingType = document.querySelector('input[name="fleet-pricing-type"]:checked')?.value;
      const duration = document.getElementById('fleet-bid-duration').value;
      const notes = document.getElementById('fleet-bid-notes').value;
      const startDate = document.getElementById('fleet-bid-start-date').value;
      const endDate = document.getElementById('fleet-bid-end-date').value;

      if (!price || price <= 0) {
        showToast('Please enter a valid price', 'error');
        return;
      }

      try {
        const vehicleCount = currentFleetBidBatch?.items?.length || currentFleetBidBatch?.vehicle_count || 1;
        const totalPrice = pricingType === 'per_vehicle' ? price * vehicleCount : price;

        const { error } = await supabaseClient
          .from('bulk_service_bids')
          .insert({
            batch_id: batchId,
            provider_id: currentUser.id,
            pricing_type: pricingType,
            price_per_vehicle: pricingType === 'per_vehicle' ? price : null,
            total_price: totalPrice,
            estimated_duration: duration,
            proposed_start_date: startDate,
            proposed_end_date: endDate,
            notes: notes,
            status: 'pending'
          });

        if (error) throw error;

        closeModal('fleet-bulk-bid-modal');
        showToast('Bulk bid submitted successfully!', 'success');
        await loadFleetJobQueue();
      } catch (err) {
        console.error('Error submitting fleet bid:', err);
        showToast('Failed to submit bid: ' + err.message, 'error');
      }
    }

    async function openFleetRequestDetail(batchId) {
      openModal('fleet-request-modal');
      document.getElementById('fleet-request-modal-body').innerHTML = '<div class="empty-state"><p>Loading request details...</p></div>';

      try {
        const batch = fleetJobQueue.find(b => b.id === batchId);
        if (!batch) throw new Error('Batch not found');

        const fleet = batch.fleet || {};
        const items = batch.items || [];
        const vehicleCount = items.length || batch.vehicle_count || 0;

        document.getElementById('fleet-request-modal-title').textContent = `üìã ${batch.name || 'Fleet Service Request'}`;

        let html = `
          <div style="background:linear-gradient(135deg, var(--accent-gold-soft), rgba(212,168,85,0.05));border:1px solid rgba(212,168,85,0.3);border-radius:var(--radius-md);padding:20px;margin-bottom:20px;">
            <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;margin-bottom:12px;">
              <span style="font-size:1.2rem;font-weight:600;">${fleet.company_name || fleet.name || 'Fleet Account'}</span>
              ${fleet.verified ? '<span style="background:linear-gradient(135deg, var(--accent-gold), #c49a45);color:#0a0a0f;padding:4px 10px;border-radius:100px;font-size:0.75rem;font-weight:600;">‚úì Verified Business</span>' : ''}
            </div>
            <div style="display:flex;gap:16px;flex-wrap:wrap;font-size:0.9rem;">
              <span style="color:var(--accent-green);">‚úì Guaranteed Payment</span>
              <span style="color:var(--accent-blue);">üí∞ Volume Pricing</span>
              <span style="color:var(--text-secondary);">üîÑ Recurring Potential</span>
            </div>
          </div>

          <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(150px, 1fr));gap:16px;margin-bottom:20px;">
            <div style="background:var(--bg-elevated);border:1px solid var(--border-subtle);border-radius:var(--radius-md);padding:16px;text-align:center;">
              <div style="font-size:1.4rem;font-weight:600;color:var(--accent-gold);">${vehicleCount}</div>
              <div style="font-size:0.82rem;color:var(--text-muted);">Vehicles</div>
            </div>
            <div style="background:var(--bg-elevated);border:1px solid var(--border-subtle);border-radius:var(--radius-md);padding:16px;text-align:center;">
              <div style="font-size:1.4rem;font-weight:600;color:var(--accent-gold);">$${(batch.estimated_total_value || vehicleCount * 75).toLocaleString()}</div>
              <div style="font-size:0.82rem;color:var(--text-muted);">Est. Value</div>
            </div>
            ${batch.date_range_start ? `
            <div style="background:var(--bg-elevated);border:1px solid var(--border-subtle);border-radius:var(--radius-md);padding:16px;text-align:center;">
              <div style="font-size:0.95rem;font-weight:500;color:var(--text-primary);">${new Date(batch.date_range_start).toLocaleDateString()}</div>
              <div style="font-size:0.82rem;color:var(--text-muted);">Start Date</div>
            </div>
            ` : ''}
          </div>

          <div style="background:var(--bg-elevated);border:1px solid var(--border-subtle);border-radius:var(--radius-md);padding:16px;margin-bottom:20px;">
            <div style="font-weight:600;margin-bottom:12px;">üîß Service Details</div>
            <div style="color:var(--text-secondary);">
              ${batch.service_type ? `<div style="margin-bottom:8px;"><strong>Service Type:</strong> ${batch.service_type}</div>` : ''}
              ${batch.description ? `<div>${batch.description}</div>` : '<div>Standard fleet service request</div>'}
            </div>
          </div>

          ${items.length > 0 ? `
          <div style="background:var(--bg-elevated);border:1px solid var(--border-subtle);border-radius:var(--radius-md);padding:16px;">
            <div style="font-weight:600;margin-bottom:12px;">üöó Vehicles in Batch</div>
            <div style="max-height:200px;overflow-y:auto;">
              ${items.slice(0, 10).map((item, i) => {
                const v = item.vehicle || {};
                return `<div style="padding:8px 0;border-bottom:1px solid var(--border-subtle);font-size:0.9rem;">${v.year ? `${v.year} ${v.make} ${v.model}` : `Vehicle ${i+1}`}</div>`;
              }).join('')}
              ${items.length > 10 ? `<div style="padding:8px 0;color:var(--text-muted);font-size:0.85rem;">...and ${items.length - 10} more vehicles</div>` : ''}
            </div>
          </div>
          ` : ''}
        `;

        document.getElementById('fleet-request-modal-body').innerHTML = html;
        document.getElementById('fleet-request-modal-footer').innerHTML = `
          <button class="btn btn-secondary" onclick="closeModal('fleet-request-modal')">Close</button>
          <button class="btn btn-primary" onclick="closeModal('fleet-request-modal');openFleetBulkBidModal('${batchId}')">üíº Submit Bid</button>
        `;
      } catch (err) {
        console.error('Error loading request details:', err);
        document.getElementById('fleet-request-modal-body').innerHTML = '<div class="empty-state"><p>Failed to load request details.</p></div>';
      }
    }

    function timeAgo(date) {
      const seconds = Math.floor((new Date() - date) / 1000);
      if (seconds < 60) return 'just now';
      if (seconds < 3600) return Math.floor(seconds / 60) + 'm ago';
      if (seconds < 86400) return Math.floor(seconds / 3600) + 'h ago';
      return Math.floor(seconds / 86400) + 'd ago';
    }

    // Initialize time dropdown selects with AM/PM format
    function initTimeDropdowns() {
      const timeOptions = [];
      for (let h = 0; h < 24; h++) {
        for (let m = 0; m < 60; m += 30) {
          const hour24 = String(h).padStart(2, '0');
          const min = String(m).padStart(2, '0');
          const value = `${hour24}:${min}`;
          const hour12 = h === 0 ? 12 : (h > 12 ? h - 12 : h);
          const ampm = h < 12 ? 'AM' : 'PM';
          const label = `${hour12}:${min} ${ampm}`;
          timeOptions.push({ value, label });
        }
      }
      
      const defaults = {
        'hours-mon-start': '08:00', 'hours-mon-end': '17:00',
        'hours-tue-start': '08:00', 'hours-tue-end': '17:00',
        'hours-wed-start': '08:00', 'hours-wed-end': '17:00',
        'hours-thu-start': '08:00', 'hours-thu-end': '17:00',
        'hours-fri-start': '08:00', 'hours-fri-end': '17:00',
        'hours-sat-start': '09:00', 'hours-sat-end': '14:00',
        'hours-sun-start': '10:00', 'hours-sun-end': '14:00'
      };
      
      document.querySelectorAll('.time-select').forEach(select => {
        select.innerHTML = timeOptions.map(opt => 
          `<option value="${opt.value}">${opt.label}</option>`
        ).join('');
        const defaultVal = defaults[select.id];
        if (defaultVal) select.value = defaultVal;
      });
    }

    // Call on page load
    initTimeDropdowns();
  </script>
  <script src="/pwa-init.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      await I18n.init();
      I18n.createLanguageSwitcher('language-switcher');
    });
  </script>
</body>
</html>

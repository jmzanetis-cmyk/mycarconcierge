<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Fleet Dashboard ‚Äì My Car Concierge</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0a0a0f" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="My Car Concierge" />
  <link rel="manifest" href="/manifest.json" />
  <link rel="apple-touch-icon" href="/icons/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="192x192" href="/icons/icon-192.png" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Playfair+Display:wght@500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-deep: #0a0a0f;
      --bg-card: rgba(18, 18, 28, 0.95);
      --bg-elevated: rgba(24, 24, 38, 0.98);
      --bg-input: rgba(22, 22, 34, 0.9);
      --text-primary: #f4f4f6;
      --text-secondary: #9898a8;
      --text-muted: #6b6b7a;
      --accent-gold: #d4a855;
      --accent-gold-soft: rgba(212, 168, 85, 0.12);
      --accent-blue: #4a7cff;
      --accent-blue-soft: rgba(74, 124, 255, 0.12);
      --accent-green: #4ac88c;
      --accent-green-soft: rgba(74, 200, 140, 0.12);
      --accent-orange: #f59e0b;
      --accent-orange-soft: rgba(245, 158, 11, 0.12);
      --accent-red: #ef5f5f;
      --accent-red-soft: rgba(239, 95, 95, 0.12);
      --border-subtle: rgba(148, 148, 168, 0.12);
      --border-medium: rgba(148, 148, 168, 0.2);
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Outfit', -apple-system, sans-serif; background: var(--bg-deep); color: var(--text-primary); height: 100vh; display: flex; overflow: hidden;
      padding-top: env(safe-area-inset-top);
    }

    /* Layout */
    .sidebar { position: fixed; left: 0; top: 0; bottom: 0; width: 260px; background: var(--bg-card); border-right: 1px solid var(--border-subtle); display: flex; flex-direction: column; z-index: 100;
      padding-top: env(safe-area-inset-top);
    }
    .main { flex: 1; margin-left: 260px; padding: 32px 40px; height: 100%; overflow-y: auto; }

    /* Sidebar */
    .sidebar-brand { display: flex; align-items: center; gap: 12px; padding: 20px; text-decoration: none; border-bottom: 1px solid var(--border-subtle); }
    .brand-icon { height: 120px; width: auto; border-radius: var(--radius-sm); image-rendering: -webkit-optimize-contrast; image-rendering: crisp-edges; }
    .brand-text-sm { font-family: 'Playfair Display', serif; font-size: 1.1rem; color: var(--text-primary); }
    .brand-fleet { font-size: 0.75rem; color: var(--accent-gold); font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; }

    .nav-label { padding: 20px 20px 8px; font-size: 0.72rem; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.8px; }
    .nav-item { padding: 12px 20px; color: var(--text-secondary); cursor: pointer; font-size: 0.92rem; transition: all 0.15s; display: flex; align-items: center; justify-content: space-between; }
    .nav-item:hover { background: rgba(255,255,255,0.03); color: var(--text-primary); }
    .nav-item.active { background: var(--accent-blue-soft); color: var(--accent-blue); }
    .nav-badge { background: var(--accent-blue); color: white; font-size: 0.72rem; padding: 2px 8px; border-radius: 10px; }

    .sidebar-footer { margin-top: auto; padding: 16px; border-top: 1px solid var(--border-subtle); }
    .user-info { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
    .user-avatar { width: 36px; height: 36px; border-radius: 50%; background: linear-gradient(135deg, var(--accent-gold), var(--accent-blue)); display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 0.85rem; }
    .user-name { font-weight: 500; font-size: 0.88rem; }
    .user-email { font-size: 0.78rem; color: var(--text-muted); }

    /* Cards & Content */
    .page-header { margin-bottom: 32px;
      padding-top: env(safe-area-inset-top);
    }
    .page-title { font-family: 'Playfair Display', serif; font-size: 1.8rem; font-weight: 500; margin-bottom: 8px; }
    .page-subtitle { color: var(--text-secondary); font-size: 0.95rem; }

    .card { background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: var(--radius-lg); padding: 24px; margin-bottom: 24px; }
    .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;
      padding-top: env(safe-area-inset-top);
    }
    .card-title { font-size: 1.1rem; font-weight: 600; }

    /* Stats Grid */
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 32px; }
    .stat-card { background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: var(--radius-lg); padding: 24px; }
    .stat-icon { width: 44px; height: 44px; border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; font-size: 20px; margin-bottom: 16px; }
    .stat-icon.blue { background: var(--accent-blue-soft); }
    .stat-icon.gold { background: var(--accent-gold-soft); }
    .stat-icon.green { background: var(--accent-green-soft); }
    .stat-icon.orange { background: var(--accent-orange-soft); }
    .stat-icon.red { background: var(--accent-red-soft); }
    .stat-value { font-size: 1.8rem; font-weight: 600; margin-bottom: 4px; }
    .stat-label { font-size: 0.88rem; color: var(--text-secondary); }
    .stat-change { font-size: 0.82rem; margin-top: 8px; }
    .stat-change.up { color: var(--accent-green); }
    .stat-change.down { color: var(--accent-red); }

    /* Tables */
    .data-table { width: 100%; border-collapse: collapse; }
    .data-table th { text-align: left; font-size: 0.78rem; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; padding: 12px 16px; border-bottom: 1px solid var(--border-subtle); }
    .data-table td { padding: 16px; border-bottom: 1px solid var(--border-subtle); font-size: 0.92rem; }
    .data-table tbody tr:hover { background: rgba(255,255,255,0.02); }
    .data-table tbody tr:last-child td { border-bottom: none; }

    /* Status Badges */
    .status { display: inline-block; padding: 4px 12px; border-radius: 12px; font-size: 0.78rem; font-weight: 500; }
    .status.active { background: var(--accent-green-soft); color: var(--accent-green); }
    .status.maintenance { background: var(--accent-orange-soft); color: var(--accent-orange); }
    .status.pending { background: var(--accent-blue-soft); color: var(--accent-blue); }
    .status.out { background: var(--accent-red-soft); color: var(--accent-red); }

    /* Buttons */
    .btn { padding: 10px 20px; border-radius: var(--radius-md); font-size: 0.88rem; font-weight: 500; cursor: pointer; border: none; transition: all 0.15s; display: inline-flex; align-items: center; gap: 8px; }
    .btn-primary { background: var(--accent-blue); color: white; }
    .btn-primary:hover { background: #5d8aff; }
    .btn-secondary { background: var(--bg-input); color: var(--text-primary); border: 1px solid var(--border-medium); }
    .btn-secondary:hover { background: rgba(255,255,255,0.08); }
    .btn-success { background: var(--accent-green); color: white; }
    .btn-sm { padding: 6px 12px; font-size: 0.82rem; }
    .btn-ghost { background: transparent; color: var(--text-secondary); }
    .btn-ghost:hover { color: var(--text-primary); }

    /* Forms */
    .form-group { margin-bottom: 20px; }
    .form-label { display: block; font-size: 0.88rem; color: var(--text-secondary); margin-bottom: 8px; font-weight: 500; }
    .form-input, .form-select, .form-textarea { width: 100%; padding: 12px 16px; background: var(--bg-input); border: 1px solid var(--border-subtle); border-radius: var(--radius-md); color: var(--text-primary); font-size: 0.92rem; font-family: inherit; transition: border-color 0.15s; }
    .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--accent-blue); }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }

    /* Modals */
    .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: none; align-items: center; justify-content: center; z-index: 200; padding: 24px; }
    .modal-backdrop.active { display: flex; }
    .modal { background: var(--bg-elevated); border: 1px solid var(--border-subtle); border-radius: var(--radius-lg); width: 100%; max-width: 600px; max-height: 90vh; overflow-y: auto; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 20px 24px; border-bottom: 1px solid var(--border-subtle);
      padding-top: env(safe-area-inset-top);
    }
    .modal-title { font-size: 1.1rem; font-weight: 600; }
    .modal-close { background: none; border: none; color: var(--text-muted); font-size: 24px; cursor: pointer; }
    .modal-body { padding: 24px; }
    .modal-footer { padding: 16px 24px; border-top: 1px solid var(--border-subtle); display: flex; justify-content: flex-end; gap: 12px; }

    /* Charts placeholder */
    .chart-placeholder { background: var(--bg-input); border-radius: var(--radius-md); height: 200px; display: flex; align-items: center; justify-content: center; color: var(--text-muted); }

    /* Sections */
    .section { display: none; }
    .section.active { display: block; }

    /* Spending by Category */
    .spending-bar { height: 8px; background: var(--bg-input); border-radius: 4px; margin-bottom: 16px; overflow: hidden; display: flex; }
    .spending-segment { height: 100%; transition: width 0.3s; }

    /* Alert Banners */
    .alert-banner { padding: 16px 20px; border-radius: var(--radius-md); margin-bottom: 24px; display: flex; align-items: center; gap: 12px; }
    .alert-banner.warning { background: var(--accent-orange-soft); border: 1px solid rgba(245,158,11,0.3); color: var(--accent-orange); }
    .alert-banner.info { background: var(--accent-blue-soft); border: 1px solid rgba(74,124,255,0.3); color: var(--accent-blue); }

    /* Toast */
    .toast-container { position: fixed; bottom: 24px; right: 24px; z-index: 300; }
    .toast { background: var(--bg-elevated); border: 1px solid var(--border-medium); border-radius: var(--radius-md); padding: 16px 20px; margin-bottom: 12px; animation: toastIn 0.3s ease; }
    @keyframes toastIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    .toast.success { border-color: var(--accent-green); }
    .toast.error { border-color: var(--accent-red); }

    /* Empty State */
    .empty-state { text-align: center; padding: 48px 24px; color: var(--text-muted); }
    .empty-state-icon { font-size: 48px; margin-bottom: 16px; opacity: 0.5; }

    /* Mobile */
    @media (max-width: 900px) {
      .sidebar { transform: translateX(-100%); transition: transform 0.3s;
      padding-top: env(safe-area-inset-top);
    }
      .sidebar.open { transform: translateX(0); }
      .main { margin-left: 0; padding: 24px 20px; }
      .mobile-header { display: flex; align-items: center; gap: 16px; margin-bottom: 24px;
      padding-top: env(safe-area-inset-top);
    }
      .mobile-menu-btn { display: flex; width: 40px; height: 40px; align-items: center; justify-content: center; background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: var(--radius-md); color: var(--text-primary); cursor: pointer; }
      .form-row { grid-template-columns: 1fr; }
    }
    @media (min-width: 901px) { .mobile-header { display: none;
      padding-top: env(safe-area-inset-top);
    } }
  </style>
  <script src="/i18n.js"></script>
</head>
<body>
  <aside class="sidebar" id="sidebar">
    <a href="index.html" class="sidebar-brand">
      <img src="logo.png" alt="My Car Concierge" class="brand-icon">
    </a>
    <div id="language-switcher" style="padding:0 20px 16px;"></div>

    <div class="nav-label">Dashboard</div>
    <div class="nav-item active" data-section="overview">üìä Overview</div>
    <div class="nav-item" data-section="vehicles">üöó Fleet Vehicles <span class="nav-badge" id="vehicle-count">0</span></div>
    <div class="nav-item" data-section="drivers">üë• Drivers</div>
    
    <div class="nav-label">Services</div>
    <div class="nav-item" data-section="services">üîß Active Services <span class="nav-badge" id="active-service-count" style="display:none;">0</span></div>
    <div class="nav-item" data-section="approvals">‚úì Pending Approvals <span class="nav-badge" id="approval-count" style="background:var(--accent-orange);display:none;">0</span></div>
    <div class="nav-item" data-section="history">üìú Service History</div>
    
    <div class="nav-label">Reports</div>
    <div class="nav-item" data-section="spending">üí∞ Spending</div>
    <div class="nav-item" data-section="maintenance">üìÖ Maintenance Schedule</div>

    <div class="sidebar-footer">
      <div class="user-info">
        <div class="user-avatar" id="user-avatar">FM</div>
        <div>
          <div class="user-name" id="user-name">Fleet Manager</div>
          <div class="user-email" id="fleet-name">Company Fleet</div>
        </div>
      </div>
      <div class="nav-item" onclick="logout()">üö™ Log Out</div>
    </div>
  </aside>

  <main class="main">
    <div class="mobile-header">
      <button class="mobile-menu-btn" onclick="toggleSidebar()">‚ò∞</button>
      <span style="font-weight:600;">Fleet Dashboard</span>
    </div>

    <!-- Overview Section -->
    <section id="overview" class="section active">
      <div class="page-header">
        <h1 class="page-title">Fleet Overview</h1>
        <p class="page-subtitle" id="overview-subtitle">Manage your company vehicles in one place.</p>
      </div>

      <div id="budget-alert" class="alert-banner warning" style="display:none;">
        ‚ö†Ô∏è <span id="budget-alert-text">You've used 80% of your monthly maintenance budget.</span>
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon blue">üöó</div>
          <div class="stat-value" id="stat-total-vehicles">0</div>
          <div class="stat-label">Total Vehicles</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon green">‚úì</div>
          <div class="stat-value" id="stat-active-vehicles">0</div>
          <div class="stat-label">Active</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon orange">üîß</div>
          <div class="stat-value" id="stat-in-maintenance">0</div>
          <div class="stat-label">In Maintenance</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon gold">üí∞</div>
          <div class="stat-value" id="stat-monthly-spend">$0</div>
          <div class="stat-label">This Month</div>
          <div class="stat-change up" id="stat-spend-change">‚Üë 12% vs last month</div>
        </div>
      </div>

      <div style="display:grid;grid-template-columns:2fr 1fr;gap:24px;">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">Upcoming Maintenance</h2>
            <button class="btn btn-ghost" onclick="showSection('maintenance')">View All ‚Üí</button>
          </div>
          <div id="upcoming-maintenance">
            <div class="empty-state">
              <div class="empty-state-icon">üìÖ</div>
              <p>No upcoming maintenance scheduled.</p>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h2 class="card-title">Spending by Category</h2>
          </div>
          <div class="spending-bar" id="spending-bar">
            <div class="spending-segment" style="background:var(--accent-blue);width:45%;"></div>
            <div class="spending-segment" style="background:var(--accent-green);width:30%;"></div>
            <div class="spending-segment" style="background:var(--accent-orange);width:15%;"></div>
            <div class="spending-segment" style="background:var(--accent-gold);width:10%;"></div>
          </div>
          <div style="font-size:0.88rem;">
            <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
              <span><span style="color:var(--accent-blue);">‚óè</span> Maintenance</span>
              <span id="cat-maintenance">$0</span>
            </div>
            <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
              <span><span style="color:var(--accent-green);">‚óè</span> Repairs</span>
              <span id="cat-repairs">$0</span>
            </div>
            <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
              <span><span style="color:var(--accent-orange);">‚óè</span> Detailing</span>
              <span id="cat-detailing">$0</span>
            </div>
            <div style="display:flex;justify-content:space-between;">
              <span><span style="color:var(--accent-gold);">‚óè</span> Other</span>
              <span id="cat-other">$0</span>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h2 class="card-title">Pending Approvals</h2>
          <button class="btn btn-ghost" onclick="showSection('approvals')">View All ‚Üí</button>
        </div>
        <div id="pending-approvals-preview">
          <div class="empty-state">
            <div class="empty-state-icon">‚úì</div>
            <p>No pending approvals.</p>
          </div>
        </div>
      </div>
    </section>

    <!-- Vehicles Section -->
    <section id="vehicles" class="section">
      <div class="page-header">
        <h1 class="page-title">Fleet Vehicles</h1>
        <p class="page-subtitle">Manage all vehicles in your fleet.</p>
      </div>

      <div style="display:flex;gap:12px;margin-bottom:24px;">
        <button class="btn btn-primary" onclick="openAddVehicleModal()">+ Add Vehicle</button>
        <button class="btn btn-secondary">üì• Import CSV</button>
      </div>

      <div class="card">
        <table class="data-table">
          <thead>
            <tr>
              <th>Vehicle</th>
              <th>Fleet #</th>
              <th>Driver</th>
              <th>Status</th>
              <th>Next Service</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="vehicles-table">
            <tr>
              <td colspan="6" style="text-align:center;color:var(--text-muted);padding:40px;">No vehicles in fleet yet.</td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- Drivers Section -->
    <section id="drivers" class="section">
      <div class="page-header">
        <h1 class="page-title">Drivers</h1>
        <p class="page-subtitle">Manage drivers and vehicle assignments.</p>
      </div>

      <div style="margin-bottom:24px;">
        <button class="btn btn-primary" onclick="openAddDriverModal()">+ Add Driver</button>
      </div>

      <div class="card">
        <table class="data-table">
          <thead>
            <tr>
              <th>Name</th>
              <th>Email</th>
              <th>Assigned Vehicle</th>
              <th>Department</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="drivers-table">
            <tr>
              <td colspan="5" style="text-align:center;color:var(--text-muted);padding:40px;">No drivers added yet.</td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- Active Services Section -->
    <section id="services" class="section">
      <div class="page-header">
        <h1 class="page-title">Active Services</h1>
        <p class="page-subtitle">Track ongoing maintenance and repairs.</p>
      </div>

      <div class="card">
        <div id="active-services-list">
          <div class="empty-state">
            <div class="empty-state-icon">üîß</div>
            <p>No active services.</p>
          </div>
        </div>
      </div>
    </section>

    <!-- Pending Approvals Section -->
    <section id="approvals" class="section">
      <div class="page-header">
        <h1 class="page-title">Pending Approvals</h1>
        <p class="page-subtitle">Review and approve service requests from drivers.</p>
      </div>

      <div class="alert-banner info">
        üí° Services under <strong>$<span id="auto-approve-amount">100</span></strong> are automatically approved based on your settings.
      </div>

      <div class="card">
        <div id="approval-list">
          <div class="empty-state">
            <div class="empty-state-icon">‚úì</div>
            <p>No pending approvals. All caught up!</p>
          </div>
        </div>
      </div>
    </section>

    <!-- Service History Section -->
    <section id="history" class="section">
      <div class="page-header">
        <h1 class="page-title">Service History</h1>
        <p class="page-subtitle">Complete record of all fleet services.</p>
      </div>

      <div style="display:flex;gap:16px;margin-bottom:24px;">
        <div class="form-group" style="margin-bottom:0;min-width:200px;">
          <select class="form-select" id="history-vehicle-filter">
            <option value="">All Vehicles</option>
          </select>
        </div>
        <div class="form-group" style="margin-bottom:0;min-width:150px;">
          <select class="form-select" id="history-period-filter">
            <option value="30">Last 30 Days</option>
            <option value="90">Last 90 Days</option>
            <option value="365">Last Year</option>
            <option value="all">All Time</option>
          </select>
        </div>
        <button class="btn btn-secondary">üì§ Export CSV</button>
      </div>

      <div class="card">
        <table class="data-table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Vehicle</th>
              <th>Service</th>
              <th>Provider</th>
              <th>Cost</th>
              <th>Receipt</th>
            </tr>
          </thead>
          <tbody id="history-table">
            <tr>
              <td colspan="6" style="text-align:center;color:var(--text-muted);padding:40px;">No service history yet.</td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- Spending Section -->
    <section id="spending" class="section">
      <div class="page-header">
        <h1 class="page-title">Spending Reports</h1>
        <p class="page-subtitle">Track and analyze your fleet maintenance costs.</p>
      </div>

      <div style="display:flex;gap:16px;margin-bottom:24px;">
        <div class="form-group" style="margin-bottom:0;min-width:150px;">
          <select class="form-select" id="spending-period">
            <option value="month">This Month</option>
            <option value="quarter">This Quarter</option>
            <option value="year">This Year</option>
          </select>
        </div>
        <button class="btn btn-secondary">üì§ Export Report</button>
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon gold">üí∞</div>
          <div class="stat-value" id="spend-total">$0</div>
          <div class="stat-label">Total Spending</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon blue">üìä</div>
          <div class="stat-value" id="spend-per-vehicle">$0</div>
          <div class="stat-label">Avg per Vehicle</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon green">üîß</div>
          <div class="stat-value" id="spend-services">0</div>
          <div class="stat-label">Services Completed</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon orange">üíµ</div>
          <div class="stat-value" id="spend-savings">$0</div>
          <div class="stat-label">Est. Savings via MCC</div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h2 class="card-title">Spending Trend</h2>
        </div>
        <div class="chart-placeholder">
          üìà Chart coming soon - spending over time
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h2 class="card-title">Top Spending Vehicles</h2>
        </div>
        <table class="data-table">
          <thead>
            <tr>
              <th>Vehicle</th>
              <th>Services</th>
              <th>Total Spent</th>
              <th>% of Fleet</th>
            </tr>
          </thead>
          <tbody id="top-spending-table">
            <tr>
              <td colspan="4" style="text-align:center;color:var(--text-muted);padding:40px;">No spending data yet.</td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- Maintenance Schedule Section -->
    <section id="maintenance" class="section">
      <div class="page-header">
        <h1 class="page-title">Maintenance Schedule</h1>
        <p class="page-subtitle">Track upcoming and overdue maintenance for your fleet.</p>
      </div>

      <div class="stats-grid" style="grid-template-columns:repeat(3,1fr);">
        <div class="stat-card">
          <div class="stat-icon red">‚ö†Ô∏è</div>
          <div class="stat-value" id="maint-overdue">0</div>
          <div class="stat-label">Overdue</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon orange">üîî</div>
          <div class="stat-value" id="maint-due-soon">0</div>
          <div class="stat-label">Due This Week</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon green">‚úì</div>
          <div class="stat-value" id="maint-upcoming">0</div>
          <div class="stat-label">Upcoming (30 days)</div>
        </div>
      </div>

      <div class="card">
        <table class="data-table">
          <thead>
            <tr>
              <th>Vehicle</th>
              <th>Service Type</th>
              <th>Due Date / Mileage</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="maintenance-schedule-table">
            <tr>
              <td colspan="5" style="text-align:center;color:var(--text-muted);padding:40px;">No scheduled maintenance.</td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>
    
    <div style="text-align:center;padding:40px 20px 20px;font-size:0.8rem;color:var(--text-muted);">
      ¬© 2025 My Car Concierge. All rights reserved. - IMOR
    </div>
  </main>

  <!-- Add Vehicle Modal -->
  <div class="modal-backdrop" id="add-vehicle-modal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Add Fleet Vehicle</h3>
        <button class="modal-close" onclick="closeModal('add-vehicle-modal')">√ó</button>
      </div>
      <div class="modal-body">
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Year</label>
            <input type="number" class="form-input" id="av-year" placeholder="2024">
          </div>
          <div class="form-group">
            <label class="form-label">Make *</label>
            <input type="text" class="form-input" id="av-make" placeholder="Toyota">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Model *</label>
            <input type="text" class="form-input" id="av-model" placeholder="Camry">
          </div>
          <div class="form-group">
            <label class="form-label">Fleet Number</label>
            <input type="text" class="form-input" id="av-fleet-num" placeholder="V-001">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">VIN</label>
            <input type="text" class="form-input" id="av-vin" placeholder="1HGBH41JXMN109186">
          </div>
          <div class="form-group">
            <label class="form-label">License Plate</label>
            <input type="text" class="form-input" id="av-plate" placeholder="ABC-1234">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Current Mileage</label>
            <input type="number" class="form-input" id="av-mileage" placeholder="45000">
          </div>
          <div class="form-group">
            <label class="form-label">Assign to Driver</label>
            <select class="form-select" id="av-driver">
              <option value="">Unassigned</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Department / Cost Center</label>
            <input type="text" class="form-input" id="av-department" placeholder="Sales">
          </div>
          <div class="form-group">
            <label class="form-label">Maintenance Schedule</label>
            <select class="form-select" id="av-schedule">
              <option value="standard">Standard</option>
              <option value="heavy_use">Heavy Use</option>
              <option value="light_use">Light Use</option>
            </select>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('add-vehicle-modal')">Cancel</button>
        <button class="btn btn-primary" onclick="addFleetVehicle()">Add Vehicle</button>
      </div>
    </div>
  </div>

  <!-- Add Driver Modal -->
  <div class="modal-backdrop" id="add-driver-modal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Add Driver</h3>
        <button class="modal-close" onclick="closeModal('add-driver-modal')">√ó</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Full Name *</label>
          <input type="text" class="form-input" id="ad-name" placeholder="John Smith">
        </div>
        <div class="form-group">
          <label class="form-label">Email *</label>
          <input type="email" class="form-input" id="ad-email" placeholder="john@company.com">
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Phone</label>
            <input type="tel" class="form-input" id="ad-phone" placeholder="(555) 123-4567">
          </div>
          <div class="form-group">
            <label class="form-label">Department</label>
            <input type="text" class="form-input" id="ad-department" placeholder="Sales">
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Assign Vehicle</label>
          <select class="form-select" id="ad-vehicle">
            <option value="">No vehicle assigned</option>
          </select>
        </div>
        <div class="alert-banner info" style="margin-top:16px;margin-bottom:0;">
          The driver will receive an email invitation to create their MCC account.
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('add-driver-modal')">Cancel</button>
        <button class="btn btn-primary" onclick="addDriver()">Add Driver</button>
      </div>
    </div>
  </div>

  <!-- Approve Service Modal -->
  <div class="modal-backdrop" id="approve-modal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Review Service Request</h3>
        <button class="modal-close" onclick="closeModal('approve-modal')">√ó</button>
      </div>
      <div class="modal-body" id="approve-modal-content">
        <!-- Dynamic content -->
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="rejectApproval()">Reject</button>
        <button class="btn btn-success" onclick="confirmApproval()">Approve</button>
      </div>
    </div>
  </div>

  <div class="toast-container" id="toast-container"></div>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="supabaseclient.js"></script>
  <script>
    let currentUser = null;
    let fleet = null;
    let fleetVehicles = [];
    let drivers = [];
    let approvals = [];
    let serviceHistory = [];
    let currentApprovalId = null;

    // ========== INITIALIZATION ==========
    window.addEventListener('load', async () => {
      const user = await getCurrentUser();
      if (!user) return window.location.href = 'login.html';
      currentUser = user;
      
      // Check if user has fleet access
      const { data: profile } = await supabaseClient.from('profiles').select('*, fleets(*)').eq('id', user.id).single();
      
      if (!profile?.fleet_id && profile?.account_type !== 'fleet') {
        // No fleet access - redirect to member dashboard
        return window.location.href = 'members.html';
      }

      fleet = profile.fleets || { company_name: profile.business_name || 'My Fleet', auto_approve_under: 100 };
      
      await loadFleetData();
      setupEventListeners();
      updateUI();
    });

    async function loadFleetData() {
      if (!fleet?.id) return;
      
      // Load fleet vehicles
      const { data: vehicles } = await supabaseClient.from('fleet_vehicles')
        .select('*, vehicles(*), profiles(full_name)')
        .eq('fleet_id', fleet.id);
      fleetVehicles = vehicles || [];

      // Load drivers
      const { data: driverData } = await supabaseClient.from('profiles')
        .select('*')
        .eq('fleet_id', fleet.id)
        .eq('fleet_role', 'driver');
      drivers = driverData || [];

      // Load pending approvals
      const { data: approvalData } = await supabaseClient.from('fleet_approvals')
        .select('*, maintenance_packages(*, vehicles(*))')
        .eq('fleet_id', fleet.id)
        .eq('status', 'pending');
      approvals = approvalData || [];

      // Load service history
      const vehicleIds = fleetVehicles.map(fv => fv.vehicle_id);
      if (vehicleIds.length) {
        const { data: history } = await supabaseClient.from('service_history')
          .select('*, vehicles(*)')
          .in('vehicle_id', vehicleIds)
          .order('service_date', { ascending: false })
          .limit(100);
        serviceHistory = history || [];
      }

      renderAll();
    }

    function updateUI() {
      // Update header
      document.getElementById('user-name').textContent = currentUser.email?.split('@')[0] || 'Fleet Manager';
      document.getElementById('fleet-name').textContent = fleet?.company_name || 'My Fleet';
      document.getElementById('overview-subtitle').textContent = `Managing ${fleet?.company_name || 'your fleet'}'s vehicles.`;
      document.getElementById('auto-approve-amount').textContent = fleet?.auto_approve_under || 100;
      document.getElementById('vehicle-count').textContent = fleetVehicles.length;

      // Stats
      document.getElementById('stat-total-vehicles').textContent = fleetVehicles.length;
      document.getElementById('stat-active-vehicles').textContent = fleetVehicles.filter(v => v.status === 'active').length;
      document.getElementById('stat-in-maintenance').textContent = fleetVehicles.filter(v => v.status === 'maintenance').length;

      // Approvals badge
      if (approvals.length > 0) {
        document.getElementById('approval-count').textContent = approvals.length;
        document.getElementById('approval-count').style.display = 'inline';
      }
    }

    function renderAll() {
      renderVehiclesTable();
      renderDriversTable();
      renderApprovalsPreview();
      renderApprovalsList();
      renderHistoryTable();
      renderUpcomingMaintenance();
    }

    function renderVehiclesTable() {
      const tbody = document.getElementById('vehicles-table');
      if (!fleetVehicles.length) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:var(--text-muted);padding:40px;">No vehicles in fleet yet.</td></tr>';
        return;
      }

      tbody.innerHTML = fleetVehicles.map(fv => {
        const v = fv.vehicles;
        const statusClass = fv.status === 'active' ? 'active' : fv.status === 'maintenance' ? 'maintenance' : 'out';
        return `
          <tr>
            <td>
              <strong>${v?.year || ''} ${v?.make || ''} ${v?.model || ''}</strong>
              <div style="font-size:0.82rem;color:var(--text-muted);">${v?.license_plate || 'No plate'}</div>
            </td>
            <td>${fv.fleet_number || '-'}</td>
            <td>${fv.profiles?.full_name || 'Unassigned'}</td>
            <td><span class="status ${statusClass}">${fv.status || 'Active'}</span></td>
            <td>${fv.next_service_due ? new Date(fv.next_service_due).toLocaleDateString() : '-'}</td>
            <td>
              <button class="btn btn-sm btn-secondary" onclick="viewVehicle('${fv.id}')">View</button>
              <button class="btn btn-sm btn-ghost" onclick="createServicePackage('${v?.id}')">+ Service</button>
            </td>
          </tr>
        `;
      }).join('');
    }

    function renderDriversTable() {
      const tbody = document.getElementById('drivers-table');
      if (!drivers.length) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:var(--text-muted);padding:40px;">No drivers added yet.</td></tr>';
        return;
      }

      tbody.innerHTML = drivers.map(d => {
        const assignedVehicle = fleetVehicles.find(fv => fv.assigned_driver_id === d.id);
        const v = assignedVehicle?.vehicles;
        return `
          <tr>
            <td><strong>${d.full_name || 'Unknown'}</strong></td>
            <td>${d.email || '-'}</td>
            <td>${v ? `${v.year} ${v.make} ${v.model}` : 'None'}</td>
            <td>${assignedVehicle?.department || '-'}</td>
            <td>
              <button class="btn btn-sm btn-secondary">Edit</button>
            </td>
          </tr>
        `;
      }).join('');
    }

    function renderApprovalsPreview() {
      const container = document.getElementById('pending-approvals-preview');
      if (!approvals.length) {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚úì</div><p>No pending approvals.</p></div>';
        return;
      }

      container.innerHTML = approvals.slice(0, 3).map(a => {
        const pkg = a.maintenance_packages;
        const v = pkg?.vehicles;
        return `
          <div style="display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid var(--border-subtle);">
            <div>
              <strong>${pkg?.title || 'Service'}</strong>
              <div style="font-size:0.85rem;color:var(--text-muted);">${v ? `${v.year} ${v.make} ${v.model}` : 'Vehicle'}</div>
            </div>
            <div style="text-align:right;">
              <div style="font-weight:600;">$${(a.amount || 0).toFixed(2)}</div>
              <button class="btn btn-sm btn-success" onclick="openApprovalModal('${a.id}')">Review</button>
            </div>
          </div>
        `;
      }).join('');
    }

    function renderApprovalsList() {
      const container = document.getElementById('approval-list');
      if (!approvals.length) {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚úì</div><p>No pending approvals. All caught up!</p></div>';
        return;
      }

      container.innerHTML = approvals.map(a => {
        const pkg = a.maintenance_packages;
        const v = pkg?.vehicles;
        return `
          <div class="card" style="margin-bottom:16px;">
            <div style="display:flex;justify-content:space-between;align-items:flex-start;">
              <div>
                <h3 style="margin-bottom:4px;">${pkg?.title || 'Service Request'}</h3>
                <div style="color:var(--text-muted);font-size:0.88rem;">${v ? `${v.year} ${v.make} ${v.model}` : 'Vehicle'}</div>
                <p style="margin-top:12px;color:var(--text-secondary);">${pkg?.description || 'No description provided.'}</p>
              </div>
              <div style="text-align:right;">
                <div style="font-size:1.3rem;font-weight:600;">$${(a.amount || 0).toFixed(2)}</div>
                <div style="font-size:0.82rem;color:var(--text-muted);">Requested ${new Date(a.requested_at).toLocaleDateString()}</div>
              </div>
            </div>
            <div style="margin-top:16px;display:flex;gap:12px;">
              <button class="btn btn-success" onclick="approveRequest('${a.id}')">‚úì Approve</button>
              <button class="btn btn-secondary" onclick="rejectRequest('${a.id}')">‚úó Reject</button>
              <button class="btn btn-ghost" onclick="viewPackageDetails('${pkg?.id}')">View Details</button>
            </div>
          </div>
        `;
      }).join('');
    }

    function renderHistoryTable() {
      const tbody = document.getElementById('history-table');
      if (!serviceHistory.length) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:var(--text-muted);padding:40px;">No service history yet.</td></tr>';
        return;
      }

      tbody.innerHTML = serviceHistory.map(h => {
        const v = h.vehicles;
        return `
          <tr>
            <td>${new Date(h.service_date).toLocaleDateString()}</td>
            <td>${v ? `${v.year} ${v.make} ${v.model}` : '-'}</td>
            <td>${h.description || h.service_type || '-'}</td>
            <td>${h.provider_business || h.provider_name || '-'}</td>
            <td>$${(h.total_cost || 0).toFixed(2)}</td>
            <td>${h.receipt_url ? '<button class="btn btn-sm btn-ghost">üìÑ</button>' : '-'}</td>
          </tr>
        `;
      }).join('');
    }

    function renderUpcomingMaintenance() {
      const container = document.getElementById('upcoming-maintenance');
      const upcoming = fleetVehicles.filter(fv => fv.next_service_due).slice(0, 5);
      
      if (!upcoming.length) {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìÖ</div><p>No upcoming maintenance scheduled.</p></div>';
        return;
      }

      container.innerHTML = upcoming.map(fv => {
        const v = fv.vehicles;
        const dueDate = new Date(fv.next_service_due);
        const isOverdue = dueDate < new Date();
        return `
          <div style="display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid var(--border-subtle);">
            <div>
              <strong>${v?.year || ''} ${v?.make || ''} ${v?.model || ''}</strong>
              <div style="font-size:0.85rem;color:var(--text-muted);">Fleet #${fv.fleet_number || '-'}</div>
            </div>
            <div style="text-align:right;">
              <div style="color:${isOverdue ? 'var(--accent-red)' : 'var(--text-secondary)'};">${isOverdue ? 'Overdue' : dueDate.toLocaleDateString()}</div>
              <button class="btn btn-sm btn-primary" onclick="createServicePackage('${v?.id}')">Schedule</button>
            </div>
          </div>
        `;
      }).join('');
    }

    // ========== ACTIONS ==========
    async function addFleetVehicle() {
      const make = document.getElementById('av-make').value.trim();
      const model = document.getElementById('av-model').value.trim();
      if (!make || !model) return showToast('Please enter make and model.', 'error');

      // Create vehicle
      const { data: vehicle } = await supabaseClient.from('vehicles').insert({
        owner_id: currentUser.id,
        year: parseInt(document.getElementById('av-year').value) || null,
        make,
        model,
        vin: document.getElementById('av-vin').value.trim() || null,
        license_plate: document.getElementById('av-plate').value.trim() || null,
        mileage: parseInt(document.getElementById('av-mileage').value) || null
      }).select().single();

      if (!vehicle) return showToast('Failed to create vehicle.', 'error');

      // Create fleet vehicle record
      await supabaseClient.from('fleet_vehicles').insert({
        fleet_id: fleet.id,
        vehicle_id: vehicle.id,
        fleet_number: document.getElementById('av-fleet-num').value.trim() || null,
        assigned_driver_id: document.getElementById('av-driver').value || null,
        department: document.getElementById('av-department').value.trim() || null,
        maintenance_schedule: document.getElementById('av-schedule').value,
        status: 'active'
      });

      closeModal('add-vehicle-modal');
      showToast('Vehicle added to fleet!', 'success');
      await loadFleetData();
      updateUI();
    }

    async function addDriver() {
      const name = document.getElementById('ad-name').value.trim();
      const email = document.getElementById('ad-email').value.trim();
      if (!name || !email) return showToast('Please enter name and email.', 'error');

      // In production, this would send an invite email
      // For now, create a placeholder profile
      showToast(`Invite sent to ${email}. They can now create their MCC account.`, 'success');
      closeModal('add-driver-modal');
    }

    async function approveRequest(approvalId) {
      if (!confirm('Approve this service request?')) return;

      await supabaseClient.from('fleet_approvals').update({
        status: 'approved',
        approved_by: currentUser.id,
        approved_at: new Date().toISOString()
      }).eq('id', approvalId);

      showToast('Service request approved!', 'success');
      await loadFleetData();
      updateUI();
    }

    async function rejectRequest(approvalId) {
      const reason = prompt('Please provide a reason for rejection:');
      if (reason === null) return;

      await supabaseClient.from('fleet_approvals').update({
        status: 'rejected',
        approved_by: currentUser.id,
        approved_at: new Date().toISOString(),
        rejection_reason: reason
      }).eq('id', approvalId);

      showToast('Service request rejected.', 'success');
      await loadFleetData();
      updateUI();
    }

    function createServicePackage(vehicleId) {
      // Redirect to members page with vehicle pre-selected
      window.location.href = `members.html?create_package=${vehicleId}`;
    }

    // ========== MODALS ==========
    function openAddVehicleModal() {
      document.getElementById('add-vehicle-modal').classList.add('active');
      // Populate driver dropdown
      const select = document.getElementById('av-driver');
      select.innerHTML = '<option value="">Unassigned</option>' + 
        drivers.map(d => `<option value="${d.id}">${d.full_name}</option>`).join('');
    }

    function openAddDriverModal() {
      document.getElementById('add-driver-modal').classList.add('active');
      // Populate vehicle dropdown
      const select = document.getElementById('ad-vehicle');
      const unassigned = fleetVehicles.filter(fv => !fv.assigned_driver_id);
      select.innerHTML = '<option value="">No vehicle assigned</option>' + 
        unassigned.map(fv => {
          const v = fv.vehicles;
          return `<option value="${fv.id}">${v?.year} ${v?.make} ${v?.model} (${fv.fleet_number || 'No #'})</option>`;
        }).join('');
    }

    function closeModal(id) {
      document.getElementById(id).classList.remove('active');
    }

    // ========== NAVIGATION ==========
    function setupEventListeners() {
      document.querySelectorAll('.nav-item[data-section]').forEach(item => {
        item.addEventListener('click', () => showSection(item.dataset.section));
      });

      document.querySelectorAll('.modal-backdrop').forEach(modal => {
        modal.addEventListener('click', e => { if (e.target === modal) modal.classList.remove('active'); });
      });
    }

    function showSection(sectionId) {
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      document.getElementById(sectionId).classList.add('active');
      document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
      document.querySelector(`.nav-item[data-section="${sectionId}"]`)?.classList.add('active');
      document.getElementById('sidebar').classList.remove('open');
    }

    function toggleSidebar() {
      document.getElementById('sidebar').classList.toggle('open');
    }

    // ========== UTILITIES ==========
    function showToast(message, type = 'info') {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      container.appendChild(toast);
      setTimeout(() => toast.remove(), 5000);
    }

    async function logout() {
      await signOut();
      window.location.href = 'login.html';
    }
  </script>
  <script src="/pwa-init.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      await I18n.init();
      I18n.createLanguageSwitcher('language-switcher');
    });
  </script>
</body>
</html>

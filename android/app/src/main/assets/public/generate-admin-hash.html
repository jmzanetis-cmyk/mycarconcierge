<!DOCTYPE html>
<html>
<head>
  <title>Setup Admin Password - My Car Concierge</title>
  <style>
    body { font-family: system-ui; max-width: 700px; margin: 50px auto; padding: 20px; background: #1a1a2e; color: #eee; }
    h1 { font-size: 1.5rem; margin-bottom: 10px; }
    h2 { font-size: 1.2rem; margin: 30px 0 15px; color: #d4a855; }
    input, button { padding: 12px 16px; border-radius: 8px; border: 1px solid #333; font-size: 1rem; width: 100%; margin-bottom: 12px; }
    input { background: #16213e; color: #fff; }
    button { background: #4a7cff; color: white; cursor: pointer; border: none; }
    button:hover { background: #3a6cef; }
    .result { background: #16213e; padding: 16px; border-radius: 8px; word-break: break-all; font-family: monospace; margin-top: 20px; }
    .instructions { background: #16213e; padding: 16px; border-radius: 8px; margin-top: 20px; font-size: 0.9rem; line-height: 1.6; }
    code { background: #0d1321; padding: 2px 6px; border-radius: 4px; }
    pre { background: #0d1321; padding: 12px; border-radius: 8px; overflow-x: auto; font-size: 0.8rem; white-space: pre-wrap; }
    .step { background: #16213e; padding: 20px; border-radius: 8px; margin-bottom: 16px; }
    .step-num { display: inline-block; width: 28px; height: 28px; background: #d4a855; color: #0a0a0f; border-radius: 50%; text-align: center; line-height: 28px; font-weight: bold; margin-right: 10px; }
    .copy-btn { background: #333; padding: 6px 12px; font-size: 0.8rem; width: auto; margin-left: 10px; }
    .warning { background: #3d2020; border: 1px solid #ef5f5f; padding: 12px; border-radius: 8px; margin-bottom: 20px; }
  </style>
</head>
<body>
  <h1>üîê Admin Password Setup</h1>
  <p style="color:#999;margin-bottom:20px;">Secure setup for My Car Concierge admin portal password protection.</p>
  
  <div class="warning">
    <strong>‚ö†Ô∏è Security Note:</strong> This uses a Supabase database function for secure server-side password verification. The hash is never exposed to the client.
  </div>

  <h2>Step 1: Generate Your Password Hash</h2>
  <div class="step">
    <input type="password" id="password" placeholder="Enter your admin password">
    <button onclick="generateHash()">Generate SHA-256 Hash</button>
    <div id="result" class="result" style="display:none;"></div>
  </div>

  <h2>Step 2: Run SQL in Supabase</h2>
  <div class="step">
    <p style="margin-bottom:15px;">Go to your <strong>Supabase Dashboard ‚Üí SQL Editor</strong> and run the following SQL. Replace <code>YOUR_HASH_HERE</code> with the hash generated above.</p>
    
    <pre id="sql-code">-- Enable pgcrypto extension (if not already enabled)
CREATE EXTENSION IF NOT EXISTS pgcrypto;

-- Create app_settings table to store configuration
CREATE TABLE IF NOT EXISTS app_settings (
  key TEXT PRIMARY KEY,
  value TEXT NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Enable RLS (no read policy - hash is only accessed by function)
ALTER TABLE app_settings ENABLE ROW LEVEL SECURITY;

-- Insert your admin password hash (replace YOUR_HASH_HERE)
INSERT INTO app_settings (key, value) 
VALUES ('admin_password_hash', 'YOUR_HASH_HERE')
ON CONFLICT (key) DO UPDATE SET value = EXCLUDED.value, updated_at = NOW();

-- Create secure password verification function
CREATE OR REPLACE FUNCTION verify_admin_password(input_password TEXT)
RETURNS BOOLEAN
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public
AS $$
DECLARE
  stored_hash TEXT;
  input_hash TEXT;
BEGIN
  -- Get stored hash (only accessible within this function due to SECURITY DEFINER)
  SELECT value INTO stored_hash FROM public.app_settings WHERE key = 'admin_password_hash';
  
  IF stored_hash IS NULL THEN
    RETURN FALSE;
  END IF;
  
  -- Hash the input password using SHA-256
  input_hash := encode(digest(input_password, 'sha256'), 'hex');
  
  -- Compare hashes securely
  RETURN stored_hash = input_hash;
END;
$$;

-- Grant execute permission to authenticated users
GRANT EXECUTE ON FUNCTION verify_admin_password(TEXT) TO authenticated;</pre>
    <button class="copy-btn" onclick="copySQL()">üìã Copy SQL</button>
  </div>

  <h2>Step 3: Test It</h2>
  <div class="step">
    <p>After running the SQL, go to your admin portal and enter your password. The verification will happen securely on the server side.</p>
    <p style="margin-top:10px;color:#999;">Your admin portal URL: <code>/admin.html</code></p>
  </div>

  <h2>Changing the Password Later</h2>
  <div class="step">
    <p>To change the admin password, generate a new hash and run:</p>
    <pre>UPDATE app_settings SET value = 'NEW_HASH_HERE', updated_at = NOW() WHERE key = 'admin_password_hash';</pre>
  </div>

  <script>
    async function generateHash() {
      const password = document.getElementById('password').value;
      if (!password) { alert('Please enter a password'); return; }
      
      const msgBuffer = new TextEncoder().encode(password);
      const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
      
      document.getElementById('result').style.display = 'block';
      document.getElementById('result').innerHTML = '<strong>Your SHA-256 Hash:</strong><br><br><span id="hash-value">' + hashHex + '</span><br><br><button class="copy-btn" onclick="copyHash()">üìã Copy Hash</button>';
      
      // Update SQL code with the hash
      const sqlCode = document.getElementById('sql-code').innerHTML;
      document.getElementById('sql-code').innerHTML = sqlCode.replace('YOUR_HASH_HERE', hashHex);
    }
    
    function copyHash() {
      const hash = document.getElementById('hash-value').textContent;
      navigator.clipboard.writeText(hash);
      alert('Hash copied to clipboard!');
    }
    
    function copySQL() {
      const sql = document.getElementById('sql-code').textContent;
      navigator.clipboard.writeText(sql);
      alert('SQL copied to clipboard!');
    }
  </script>
</body>
</html>
